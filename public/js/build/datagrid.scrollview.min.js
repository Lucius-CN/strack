var scrollview=$.extend({},$.fn.datagrid.defaults.view,{render:function(r,t,a){$(r).datagrid("loaded");$.data(r,"datagrid");for(var e=this.groups,d=[],o=0;o<e.length;o++)d.push(this.renderGroup.call(this,r,o,e[o],a));$(t).html(d.join(""))},renderGroup:function(r,t,a,e){var d=$.data(r,"datagrid"),o=d.options,s=$(r).datagrid("getColumnFields",e),i=[];if(o.groupActive){i.push('<div class="datagrid-group" group-index='+t+">"),i.push('<table cellspacing="0" cellpadding="0" border="0" style="height:100%"><tbody>'),i.push("<tr>"),(e&&(o.rownumbers||o.frozenColumns.length)||!e&&!o.rownumbers&&!o.frozenColumns.length)&&i.push('<td style="border:0;text-align:center;width:25px"><span class="datagrid-row-expander datagrid-row-collapse icon-uniF077" style="display:inline-block;margin-left: 8px;cursor:pointer">&nbsp;</span></td>'),i.push('<td style="border:0;">');var n=o.columns.length-1,l="";"string"==typeof a.value?l=a.value:a.value&&a.value.hasOwnProperty("rows")&&a.value.rows.forEach(function(r){l+=r.name}),e?(i.push('<span class="datagrid-group-title frozen_gtitle text-ellipsis">'),2<=o.frozenColumns[n].length&&i.push(o.groupFormatter.call(r,l,a.rows))):(i.push('<span class="datagrid-group-title unfrozen_gtitle text-ellipsis">'),o.frozenColumns[n].length<2&&i.push(o.groupFormatter.call(r,l,a.rows))),i.push("</span>"),i.push("</td>"),i.push("</tr>"),i.push("</tbody></table>"),i.push("</div>")}i.push('<table class="datagrid-btable" cellspacing="0" cellpadding="0" border="0"><tbody>');for(var g=a.startIndex,p=0;p<a.rows.length;p++){var u=o.rowStyler?o.rowStyler.call(r,g,a.rows[p]):"",h="",c="";"string"==typeof u?c=u:u&&(h=u.class||"",c=u.style||"");var f=[];c&&f.push(c);var v='class="datagrid-row '+(g%2&&o.striped?"datagrid-row-alt ":" ")+h+'"',w=0<f.length?'style="'+f.join(";")+'"':"",b=d.rowIdPrefix+"-"+(e?1:2)+"-"+g;i.push('<tr id="'+b+'" datagrid-row-index="'+g+'" '+v+" "+w+">"),i.push(this.renderRow.call(this,r,s,e,g,a.rows[p])),i.push("</tr>"),g++}return i.push("</tbody></table>"),i.join("")},bindEvents:function(e){var r=$.data(e,"datagrid").dc,t=r.body1.add(r.body2),d=($.data(t[0],"events")||$._data(t[0],"events")).click[0].handler;t.unbind("click").bind("click",function(r){var t=$(r.target).closest("span.datagrid-row-expander");if(t.length){var a=t.closest("div.datagrid-group").attr("group-index");t.hasClass("datagrid-row-collapse")?$(e).datagrid("collapseGroup",a):$(e).datagrid("expandGroup",a)}else d(r);r.stopPropagation()}),$(".datagrid-view2 .datagrid-body").scroll(function(r){$(".datagrid-group").css("width","calc(100% + "+this.scrollLeft+"px)")})},onBeforeRender:function(r,t){var a=$.data(r,"datagrid"),e=a.options;$("#datagrid-group-style").length||$("head").append('<style id="datagrid-group-style">.datagrid-group{height:25px;overflow:hidden;font-weight:bold;border-bottom:1px solid #ccc;background-color: #E6E6E6}</style>');for(var d=[],o=0;o<t.length;o++){var s=t[o];(l=p(s[e.groupField]))?l.rows.push(s):(l={value:s[e.groupField],rows:[s]},d.push(l))}var i=0,n=[];for(o=0;o<d.length;o++){var l;(l=d[o]).startIndex=i,i+=l.rows.length,n=n.concat(l.rows)}a.data.rows=n,this.groups=d;var g=this;function p(r){for(var t=0;t<d.length;t++){var a=d[t];if(u(a.value)==u(r))return a}return null}function u(r){return r&&r.hasOwnProperty("rows")?r.rows[0].name:r}setTimeout(function(){g.bindEvents(r)},0)}});$.extend($.fn.datagrid.methods,{expandGroup:function(r,a){return r.each(function(){var r=$.data(this,"datagrid").dc.view.find(null!=a?'div.datagrid-group[group-index="'+a+'"]':"div.datagrid-group"),t=r.find("span.datagrid-row-expander");t.hasClass("datagrid-row-expand")&&(t.removeClass("datagrid-row-expand").removeClass(" icon-uniF078").addClass("datagrid-row-collapse").addClass(" icon-uniF077"),r.next("table").show()),$(this).datagrid("fixRowHeight")})},collapseGroup:function(r,a){return r.each(function(){var r=$.data(this,"datagrid").dc.view.find(null!=a?'div.datagrid-group[group-index="'+a+'"]':"div.datagrid-group"),t=r.find("span.datagrid-row-expander");t.hasClass("datagrid-row-collapse")&&(t.removeClass("datagrid-row-collapse").removeClass(" icon-uniF077").addClass("datagrid-row-expand").addClass(" icon-uniF078"),r.next("table").hide()),$(this).datagrid("fixRowHeight")})}}),$.extend(scrollview,{refreshGroupTitle:function(r,t){var a=$.data(r,"datagrid"),e=a.options,d=a.dc,o=this.groups[t];d.body2.children("div.datagrid-group[group-index="+t+"]").find("span.datagrid-group-title").html(e.groupFormatter.call(r,o.value,o.rows))},insertRow:function(d,r,t){for(var a,e=$.data(d,"datagrid"),o=e.options,s=e.dc,i=null,n=0;n<this.groups.length;n++)if(this.groups[n].value==t[o.groupField]){i=this.groups[n],a=n;break}function l(r,t){var a=t?1:2,e=o.finder.getTr(d,r-1,"body",a);o.finder.getTr(d,r,"body",a).insertAfter(e)}i?(null!=r&&null!=r||(r=e.data.rows.length),r<i.startIndex?r=i.startIndex:r>i.startIndex+i.rows.length&&(r=i.startIndex+i.rows.length),$.fn.datagrid.defaults.view.insertRow.call(this,d,r,t),r>=i.startIndex+i.rows.length&&(l(r,!0),l(r,!1)),i.rows.splice(r-i.startIndex,0,t)):(i={value:t[o.groupField],rows:[t],startIndex:e.data.rows.length},a=this.groups.length,s.body1.append(this.renderGroup.call(this,d,a,i,!0)),s.body2.append(this.renderGroup.call(this,d,a,i,!1)),this.groups.push(i),e.data.rows.push(t)),this.refreshGroupTitle(d,a)},updateRow:function(r,t,a){var e=$.data(r,"datagrid").options;$.fn.datagrid.defaults.view.updateRow.call(this,r,t,a);var d=e.finder.getTr(r,t,"body",2).closest("table.datagrid-btable"),o=parseInt(d.prev().attr("group-index"));e.groupFormatter&&this.refreshGroupTitle(r,o)},deleteRow:function(r,t){var a=$.data(r,"datagrid"),e=a.options,d=a.dc,o=d.body1.add(d.body2),s=e.finder.getTr(r,t,"body",2).closest("table.datagrid-btable"),i=parseInt(s.prev().attr("group-index"));if($.fn.datagrid.defaults.view.deleteRow.call(this,r,t),1<(l=this.groups[i]).rows.length)l.rows.splice(t-l.startIndex,1),this.refreshGroupTitle(r,i);else{o.children("div.datagrid-group[group-index="+i+"]").remove();for(var n=i+1;n<this.groups.length;n++)o.children("div.datagrid-group[group-index="+n+"]").attr("group-index",n-1);this.groups.splice(i,1)}for(t=0,n=0;n<this.groups.length;n++){var l;(l=this.groups[n]).startIndex=t,t+=l.rows.length}}});