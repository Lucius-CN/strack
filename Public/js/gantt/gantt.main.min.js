Ext.define("Sch.column.Day",{extend:Ext.grid.column.Column,alias:"widget.weekview-day",align:"center",start:null,end:null,draggable:!1,groupable:!1,hideable:!1,sortable:!1,menuDisabled:!0,enableLocking:!1,flex:1,resizable:!1,tdCls:"sch-timetd",initComponent:function(){var e=new Date;this.addCls("sch-daycolumn-header"),this.isWeekend()&&(this.addCls("sch-daycolumn-header-weekend"),this.tdCls=(this.tdCls||"")+" sch-daycolumn-weekend"),this.start.getDate()===e.getDate()&&this.start.getMonth()===e.getMonth()&&this.start.getYear()===e.getYear()&&(this.addCls("sch-daycolumn-header-today"),this.tdCls=(this.tdCls||"")+" sch-daycolumn-today"),this.callParent(arguments)},isWeekend:function(){var e=this.start.getDay();return 6===e||0===e}}),Ext.define("Sch.column.Resource",{extend:Ext.grid.Column,alias:"widget.resourcecolumn",align:"center",menuDisabled:!0,hideable:!1,sortable:!1,locked:!1,lockable:!1,draggable:!1,enableLocking:!1,model:null,initComponent:function(){this.tdCls=(this.tdCls||"")+" sch-timetd",this.cls=(this.cls||"")+" sch-resourcecolumn-header",this.callParent(arguments)}}),Ext.define("Sch.view.HorizontalTimeAxis",{extend:Ext.util.Observable,trackHeaderOver:!0,compactCellWidthThreshold:15,baseCls:"sch-column-header",tableCls:"sch-header-row",headerHtmlRowTpl:'<table border="0" cellspacing="0" cellpadding="0" style="width: {totalWidth}px; {tstyle}" class="{{tableCls}} sch-header-row-{position} {cls}"><thead><tr><tpl for="cells"><td class="{{baseCls}} {headerCls}" style="position : static; text-align: {align}; width: {width}px; {style}" tabIndex="0"headerPosition="{parent.position}" headerIndex="{[xindex-1]}"><div class="sch-simple-timeheader">{header}</div></td></tpl></tr></thead></table>',model:null,hoverCls:"",containerEl:null,height:null,constructor:function(e){var t=this,i=!!Ext.versions.touch;Ext.apply(this,e),t.callParent(arguments),t.model.on("update",t.onModelUpdate,this,{priority:5}),t.containerEl=Ext.get(t.containerEl),t.headerHtmlRowTpl instanceof Ext.Template||(t.headerHtmlRowTpl=t.headerHtmlRowTpl.replace("{{baseCls}}",this.baseCls).replace("{{tableCls}}",this.tableCls),t.headerHtmlRowTpl=new Ext.XTemplate(t.headerHtmlRowTpl)),t.trackHeaderOver&&t.hoverCls&&(t.containerEl.on({mousemove:t.highlightCell,delegate:".sch-column-header",scope:t}),t.containerEl.on({mouseleave:t.clearHighlight,scope:t}));var n={scope:this,delegate:".sch-column-header"};i?(n.tap=this.onElClick("tap"),n.doubletap=this.onElClick("doubletap")):(n.click=this.onElClick("click"),n.dblclick=this.onElClick("dblclick"),n.contextmenu=this.onElClick("contextmenu")),t._listenerCfg=n,t.containerEl&&t.containerEl.on(n)},destroy:function(){var e=this;e.containerEl&&(e.containerEl.un(e._listenerCfg),e.containerEl.un({mousemove:e.highlightCell,delegate:".sch-simple-timeheader",scope:e}),e.containerEl.un({mouseleave:e.clearHighlight,scope:e})),e.model.un({update:e.onModelUpdate,scope:e})},onModelUpdate:function(){this.render()},getHTML:function(e,t,i){var n=this.model.getColumnConfig(),r=this.model.getTotalWidth(),a=Ext.Object.getKeys(n).length,s=this.height?this.height/a:0,o="";return n.top&&(this.embedCellWidths(n.top),o+=this.headerHtmlRowTpl.apply({totalWidth:r,cells:n.top,position:"top",tstyle:"border-top : 0;"+(s?"height:"+s+"px":"")})),n.middle&&(this.embedCellWidths(n.middle),o+=this.headerHtmlRowTpl.apply({totalWidth:r,cells:n.middle,position:"middle",tstyle:(n.top?"":"border-top : 0;")+(s?"height:"+s+"px":""),cls:!n.bottom&&this.model.getTickWidth()<=this.compactCellWidthThreshold?"sch-header-row-compact":""})),n.bottom&&(this.embedCellWidths(n.bottom),o+=this.headerHtmlRowTpl.apply({totalWidth:r,cells:n.bottom,position:"bottom",tstyle:s?"height:"+s+"px":"",cls:this.model.getTickWidth()<=this.compactCellWidthThreshold?"sch-header-row-compact":""})),o+'<div class="sch-header-secondary-canvas"></div>'},render:function(){if(this.containerEl){var e=this.containerEl,t=e.dom,i=t.style.display,n=this.model.getColumnConfig(),r=t.parentNode;t.style.display="none",r.removeChild(t);var a=this.getHTML();t.innerHTML=a,n.top||n.middle?this.containerEl.removeCls("sch-header-single-row"):this.containerEl.addCls("sch-header-single-row"),r&&r.appendChild(t),t.style.display=i,this.fireEvent("refresh",this)}},embedCellWidths:function(e){for(var t=Ext.isIE7||Ext.isSafari&&!Ext.supports.Touch?1:0,i=0;i<e.length;i++){var n=e[i],r=this.model.getDistanceBetweenDates(n.start,n.end);r?n.width=r-(i?t:0):(n.width=0,n.style="display: none")}},onElClick:function(e){return function(t,i){i=t.delegatedTarget||i;var n=Ext.fly(i).getAttribute("headerPosition"),r=Ext.fly(i).getAttribute("headerIndex"),a=this.model.getColumnConfig()[n][r];this.fireEvent("timeheader"+e,this,a.start,a.end,t)}},highlightCell:function(e,t){var i=this;t!==i.highlightedCell&&(i.clearHighlight(),i.highlightedCell=t,Ext.fly(t).addCls(i.hoverCls))},clearHighlight:function(){var e=this,t=e.highlightedCell;t&&(Ext.fly(t).removeCls(e.hoverCls),delete e.highlightedCell)}}),Ext.define("Sch.column.timeAxis.Horizontal",{extend:Ext.grid.column.Column,alias:"widget.timeaxiscolumn",draggable:!1,groupable:!1,hideable:!1,sortable:!1,fixed:!0,menuDisabled:!0,cls:"sch-simple-timeaxis",tdCls:"sch-timetd",enableLocking:!1,timeAxisViewModel:null,headerView:null,hoverCls:"",ownHoverCls:"sch-column-header-over",trackHeaderOver:!0,compactCellWidthThreshold:20,afterRender:function(){var e=this,t=e.titleEl.createChild({cls:"sch-horizontaltimeaxis-ct"});e.headerView=new Sch.view.HorizontalTimeAxis({model:e.timeAxisViewModel,containerEl:t,hoverCls:e.ownHoverCls,trackHeaderOver:e.trackHeaderOver,compactCellWidthThreshold:e.compactCellWidthThreshold}),e.headerView.on("refresh",e.onTimeAxisViewRefresh,e),e.ownerCt.on("afterlayout",function(){e.ownerCt&&(e.mon(e.ownerCt,"resize",e.onHeaderContainerResize,e),this.getWidth()>0&&(e.getAvailableWidthForSchedule()===e.timeAxisViewModel.getAvailableWidth()?e.headerView.render():e.timeAxisViewModel.update(e.getAvailableWidthForSchedule()),e.setWidth(e.timeAxisViewModel.getTotalWidth())))},null,{single:!0}),this.enableBubble("timeheaderclick","timeheaderdblclick","timeheadercontextmenu"),e.relayEvents(e.headerView,["timeheaderclick","timeheaderdblclick","timeheadercontextmenu"]),e.callParent(arguments),e.focusable=!1},initRenderData:function(){var e=this;return e.renderData.headerCls=e.renderData.headerCls||e.headerCls,e.callParent(arguments)},destroy:function(){this.headerView&&this.headerView.destroy(),this.callParent(arguments)},onTimeAxisViewRefresh:function(){this.headerView.un("refresh",this.onTimeAxisViewRefresh,this),this.setWidth(this.timeAxisViewModel.getTotalWidth()),this.headerView.on("refresh",this.onTimeAxisViewRefresh,this)},getAvailableWidthForSchedule:function(){for(var e,t=this.ownerCt.isVisible(!0)?this.ownerCt.getWidth():this.ownerCt.lastBox&&this.ownerCt.lastBox.width||0,i=this.ownerCt.items,n=1;n<i.length;n++)e=i.get(n),e.hidden||(t-=e.isVisible(!0)?e.getWidth():e.lastBox&&e.lastBox.width||0);return t-Ext.getScrollbarSize().width-1},onResize:function(){this.callParent(arguments),this.timeAxisViewModel.setAvailableWidth(this.getAvailableWidthForSchedule())},onHeaderContainerResize:function(){this.timeAxisViewModel.setAvailableWidth(this.getAvailableWidthForSchedule()),this.headerView.render()},refresh:function(){this.timeAxisViewModel.update(null,!0),this.headerView.render()}}),Ext.define("Sch.column.timeAxis.Vertical",{extend:Ext.grid.column.Column,alias:"widget.verticaltimeaxis",align:"right",draggable:!1,groupable:!1,hideable:!1,sortable:!1,menuDisabled:!0,timeAxis:null,timeAxisViewModel:null,cellTopBorderWidth:null,cellBottomBorderWidth:null,totalBorderWidth:null,enableLocking:!1,locked:!0,initComponent:function(){this.callParent(arguments),this.tdCls=(this.tdCls||"")+" sch-verticaltimeaxis-cell",this.scope=this,this.totalBorderWidth=this.cellTopBorderWidth+this.cellBottomBorderWidth},afterRender:function(){this.callParent(arguments),this.up("panel").getView().on("resize",this.onContainerResize,this)},onContainerResize:function(e,t,i){this.timeAxisViewModel.update(i-21)},renderer:function(e,t,i,n){var r=this.timeAxisViewModel.getBottomHeader();return t.style="height:"+(this.timeAxisViewModel.getTickWidth()-this.totalBorderWidth)+"px",r.renderer?r.renderer.call(r.scope||this,i.data.start,i.data.end,t,n):Ext.Date.format(i.data.start,r.dateFormat)}}),Ext.define("Sch.crud.AbstractManager",{require:["Ext.data.StoreManager"],mixins:{observable:Ext.util.Observable},revision:null,stores:null,storeIdProperty:"storeId",filterParam:"filter",storesIndex:null,activeRequests:null,delayedSyncs:null,transport:null,trackResponseType:!1,phantomIdField:"$PhantomId",autoLoad:!1,autoSyncTimeout:100,autoSync:!1,resetIdsBeforeSync:!0,syncApplySequence:null,writeAllFields:!1,ignoreUpdates:0,createMissingRecords:!1,autoSyncTimerId:null,constructor:function(e){e=e||{},this.mixins.observable.constructor.call(this,e),this.activeRequests={},this.delayedSyncs=[],this.transport=e.transport||this.transport||{};var t=e.stores||this.stores;this.stores=[],this.addStore(t);var i=e.syncApplySequence||this.syncApplySequence;i&&(this.syncApplySequence=null,this.addStoreToApplySequence(i)),this.autoLoad&&this.load()},updateStoreIndex:function(){for(var e={},t=0,i=this.stores.length;t<i;t++){var n=this.stores[t];n.storeId&&(e[n.storeId]=this.stores[t])}this.storesIndex=e},getStoreDescriptor:function(e){if(e){if(!(e instanceof Ext.data.AbstractStore))return"object"==typeof e?this.storesIndex[e.storeId]:this.storesIndex[e]||this.getStoreDescriptor(Ext.data.StoreManager.get(e));for(var t=0,i=this.stores.length;t<i;t++)if(this.stores[t].store===e)return this.stores[t]}},getStore:function(e){var t=this.getStoreDescriptor(e);return t&&t.store},forEachStore:function(e,t){if(e)for(var i=this.stores,n=0,r=i.length;n<r&&!1!==e.call(t||this,i[n].store,i[n].storeId,i[n]);n++);},addStore:function(e,t,i){if(e){Ext.isArray(e)||(e=[e]);for(var n=[],r=0,a=e.length;r<a;r++){var s=e[r];if(s instanceof Ext.data.AbstractStore)s={store:s};else if("object"==typeof s){if(s.stores){Ext.isArray(s.stores)||(s.stores=[s.stores]);for(var o=0,l=s.stores.length;o<l;o++){var d=s.stores[o],c=d;"string"==typeof d&&(c={storeId:d}),c.masterStoreInfo=s,s.stores[o]=c}}}else s={store:Ext.data.StoreManager.get(s)};n.push(this.fillStoreDescriptor(s)),s.store.crudManager=this,this.mon(s.store,{add:this.onStoreChange,append:this.onStoreChange,insert:this.onStoreChange,update:this.onStoreUpdate,remove:this.onStoreChange,clear:this.onStoreChange,scope:this})}if(void 0===t)this.stores.push.apply(this.stores,n);else{var h=t;i&&((i instanceof Ext.data.AbstractStore||"object"!=typeof i)&&(i=this.getStoreDescriptor(i)),h+=Ext.Array.indexOf(this.stores,i)),this.stores.splice.apply(this.stores,[].concat([h,0],n))}this.updateStoreIndex()}},fillStoreDescriptor:function(e){var t=e.store,i=t.storeIdProperty||this.storeIdProperty,n=t.getModel&&t.getModel()||t.model;return n=n&&n.prototype,Ext.applyIf(e,{storeId:t[i],phantomIdField:n&&n.phantomIdField,idProperty:n&&n.idProperty,writeAllFields:t.writeAllFields}),e},removeStore:function(e){for(var t=0,i=this.stores.length;t<i;t++){var n=this.stores[t];if(n===e||n.store===e||n.storeId===e){this.mun(n.store,{add:this.onStoreChange,append:this.onStoreChange,insert:this.onStoreChange,update:this.onStoreUpdate,remove:this.onStoreChange,clear:this.onStoreChange,scope:this}),delete this.storesIndex[n.storeId],this.stores.splice(t,1),this.syncApplySequence&&this.removeStoreFromApplySequence(e);break}}},addStoreToApplySequence:function(e,t,i){if(e){Ext.isArray(e)||(e=[e]);for(var n=[],r=0,a=e.length;r<a;r++){var s=this.getStoreDescriptor(e[r]);s&&n.push(s)}if(this.syncApplySequence||(this.syncApplySequence=[]),void 0===t)this.syncApplySequence.push.apply(this.syncApplySequence,n);else{var o=t;i&&((i instanceof Ext.data.AbstractStore||"object"!=typeof i)&&(i=this.getStoreDescriptor(i)),o+=Ext.Array.indexOf(this.syncApplySequence,i)),this.syncApplySequence.splice.apply(this.syncApplySequence,[].concat([o,0],n))}}},removeStoreFromApplySequence:function(e){for(var t=0,i=this.syncApplySequence.length;t<i;t++){var n=this.syncApplySequence[t];if(n===e||n.store===e||n.storeId===e){this.syncApplySequence.splice(t,1);break}}},onStoreUpdate:function(e,t){e.isTreeStore&&t===e.getRoot()||this.onStoreChange()},onStoreChange:function(){if(!this.ignoreUpdates){var e=this;this.fireEvent(this.hasChanges()?"haschanges":"nochanges",this),this.autoSync&&(this.autoSyncTimerId||(this.autoSyncTimerId=setTimeout(function(){e.autoSyncTimerId=null,e.sync()},this.autoSyncTimeout)))}},hasChanges:function(e){var t;if(e){if(!(t=this.getStore(e)))return;return Boolean(t.getModifiedRecords().length||t.getRemovedRecords().length)}for(var i=0,n=this.stores.length;i<n;i++)if(t=this.stores[i].store,t.getModifiedRecords().length||t.getRemovedRecords().length)return!0;return!1},getLoadPackage:function(e){for(var t={type:"load",requestId:this.getRequestId(),stores:[]},i=this.stores,n=t.stores,r=0,a=i.length;r<a;r++){var s=i[r],o=s.filterParam||s.store.filterParam||this.filterParam,l=e&&e[s.storeId],d=s.pageSize||s.store.pageSize;if(s.store.remoteFilter&&o){l=l||{};var c=[];s.store.getFilters().each(function(e){c.push(e.serialize())}),l[o]=c}if(l||d){var h=Ext.apply({storeId:s.storeId,page:1,pageSize:d},l);i[r].currentPage=h.page,n.push(h)}else n.push(s.storeId)}return t},prepareAdded:function(e,t,i){for(var n=[],r=0,a=e.length;r<a;r++){var s=e[r],o={},l=s.getFields();o.hasOwnProperty(t)||(o[t]=s.getId());for(var d=0,c=l.length;d<c;d++){var h=l[d];h&&h.persist&&(s.data.hasOwnProperty(h.name)||h.critical)&&(h.serialize?o[h.name]=h.serialize(s.data[h.name],s):o[h.name]=s.data[h.name])}this.resetIdsBeforeSync&&delete o[s.idProperty],i&&this.processSubStores(s,o,i),n.push(o)}return n},prepareUpdated:function(e,t,i){for(var n,r,a=[],s=i.writeAllFields||!1!==i.writeAllFields&&this.writeAllFields,o=0,l=e.length;o<l;o++){var d,c=e[o];if(s){n=c.getData(),n[c.idProperty]=c.getId();for(d in n)r=c.getField(d),r&&(r.persist||r.critical)?r.serialize?n[d]=r.serialize(n[d],c):n[d]=c.get(d):delete n[d]}else{n=c.getChanges(),n[c.idProperty]=c.getId();for(d in n)r=c.getField(d),r&&r.persist?r.serialize?n[d]=r.serialize(n[d],c):n[d]=c.get(d):delete n[d];for(var h=c.getCriticalFields(),u=0;u<h.length;u++)r=h[u],r.serialize?n[r.getName()]=r.serialize(c.get(r.getName()),c):n[r.getName()]=c.get(r.getName())}t&&this.processSubStores(c,n,t),a.push(n)}return a},prepareRemoved:function(e){for(var t,i=[],n=0,r=e.length;n<r;n++)t={},t[e[n].idProperty]=e[n].getId(),i.push(t);return i},processSubStores:function(e,t,i){for(var n=0,r=i.length;n<r;n++){var a=i[n].storeId,s=e.get(a);if(s){var o=this.getStoreChanges(Ext.apply({store:s},i[n]));o?t[a]=Ext.apply(o,{$store:!0}):delete t[a]}else delete t[a]}},getStoreChanges:function(e,t){t=t||e.phantomIdField||this.phantomIdField;var i,n=e.store,r=n.getNewRecords(),a=n.getUpdatedRecords(),s=n.getRemovedRecords(),o=e.stores;return r.length&&(r=this.prepareAdded(r,t,o)),a.length&&(a=this.prepareUpdated(a,o,e)),s.length&&(s=this.prepareRemoved(s)),(r.length||a.length||s.length)&&(i={},r.length&&(i.added=r),a.length&&(i.updated=a),s.length&&(i.removed=s)),i},getChangeSetPackage:function(){for(var e={type:"sync",requestId:this.getRequestId(),revision:this.revision},t=this.stores,i=0,n=0,r=t.length;n<r;n++){var a=t[n],s=a.phantomIdField||this.phantomIdField,o=a.storeId,l=this.getStoreChanges(a,s);l&&(i++,e[o]=l)}return i?e:null},getSubStoresData:function(e,t,i,n){if(e){var r=[],a=function(e,t){for(var n=0,a=t.length;n<a;n++){var s=t[n].storeId;e[s]&&(r.push({id:e[i],storeDesc:t[n],data:e[s]}),delete e[s])}},s=0,o=e.length;if(n)for(;s<o;s++){a(e[s],t);var l=this.getSubStoresData(e[s].children,t,i,!0);l&&(r=r.concat(l))}else for(;s<o;s++)a(e[s],t);return r}},loadDataToStore:function(e,t,i){var n,r=e.store,a=r.getModel(),s=e.stores,o=e.idProperty||a&&a.prototype&&a.prototype.idProperty||"id",l=r instanceof Ext.data.TreeStore,d=t&&t.rows;if(r.metaData=t&&t.metaData,d){if(s&&(n=this.getSubStoresData(d,s,o,l)),r.__loading=!0,l)r.proxy.data=d,r.load();else{r.totalCount=t.total,r.currentPage=e.currentPage;var c=Ext.Array.map(d,function(e){return new a(e)});r.loadData(c,i&&i.append||t.append),r.fireEvent("load",r,c,!0)}if(n)for(var h=0,u=n.length;h<u;h++){var g=n[h];this.loadDataToStore(Ext.apply({store:r[l?"getNodeById":"getById"](g.id).get(g.storeDesc.storeId)},g.storeDesc),g.data)}r.__loading=!1}},loadData:function(e,t){t=t||{};for(var i=0,n=this.stores.length;i<n;i++){var r=this.stores[i],a=r.storeId,s=e[a];s&&this.loadDataToStore(r,s,t[a])}},applyChangesToRecord:function(e,t,i,n){var r,a=e.data,s={},o=!1;if(i)for(var l=0,d=i.length;l<d;l++)if(r=i[l].storeId,t.hasOwnProperty(r)){s[r]=!0;var c=e.get(r);c?this.applyChangesToStore(Ext.apply({store:c},i[l]),t[r]):Ext.log("Can't find store for the response sub-package")}for(r in t)if(t.hasOwnProperty(r)&&!s[r]){var h=t[r];if(!e.isEqual(a[r],h))if(o||(o=!0,e.beginEdit()),r===e.idProperty)e.setId(h);else if("parentId"==r&&n.isTreeStore){var u=h&&n.getNodeById(h)||n.getRoot();u.appendChild(e)}else e.set(r,h)}this.ignoreUpdates++,o&&e.endEdit(),this.ignoreUpdates--,e.commit()},applyRemovals:function(e,t,i){for(var n=i.idProperty,r=e instanceof Ext.data.TreeStore?e.removedNodes:e.removed,a=i.findByIdFn,s=i.removeRecordFn,o=0,l=0,d=t.length;l<d;l++){for(var c=!1,h=t[l][n],u=0,g=r.length;u<g;u++)if(r[u].getId()==h){r.splice(u,1),c=!0,o++;break}if(!c){var f=a(h);f?(this.ignoreUpdates++,s(f),Ext.Array.remove(r,f),o++,this.ignoreUpdates--):Ext.log("Can't find record to remove from the response package")}}return o},applyChangesToStore:function(e,t){var i,n,r,a=e.phantomIdField||this.phantomIdField,s=e.idProperty,o=e.store;if(!s){var l=o.getModel&&o.getModel()||o.model;l=l&&l.prototype,s=l&&l.idProperty||"id"}var d,c,h,u,g=function(e){return o.data.getByKey(e)},f=function(e){return o.getById(e)},p=function(e){return o.getNodeById(e)};o instanceof Ext.data.TreeStore?(h=u=p,d=function(e){return(e.parentId&&o.getNodeById(e.parentId)||o.getRootNode()).appendChild(e)},c=function(e){return e.parentNode.removeChild(e)}):(h=g,u=f,d=function(e){return o.add(e)[0]},c=function(e){return o.remove(e)});var m,v=t.rows,S=t.removed;if(v){var y,E,x=e.stores;for(i=0,n=v.length;i<n;i++)y=v[i],E=y[a],r=y[s],m=null,null!=E?m=h(E):s&&(m=u(r)),m?this.applyChangesToRecord(m,y,x,o):(this.ignoreUpdates++,m=d(y),this.ignoreUpdates--,m.commit())}S&&this.applyRemovals(o,S,{idProperty:s,findByIdFn:u,removeRecordFn:c})&&o.fireEvent("datachanged",o)},applySyncResponse:function(e){for(var t=this.syncApplySequence||this.stores,i=0,n=t.length;i<n;i++){var r=e[t[i].storeId];r&&this.applyChangesToStore(t[i],r)}},applyLoadResponse:function(e,t){this.loadData(e,t)},applyResponse:function(e,t,i){switch(this.trackResponseType&&(e=t.type||e),e){case"load":this.applyLoadResponse(t,i);break;case"sync":this.applySyncResponse(t)}},getRequestId:function(){return Ext.Date.now()},onResponse:function(e,t,i,n){this.activeRequests[e]=null;var r=this.decode(t);return r&&r.success?(!1!==this.fireEvent("beforeresponseapply",this,e,r)&&!1!==this.fireEvent("before"+e+"apply",this,r,n)&&(this.revision=r.revision,this.applyResponse(e,r,n),this.fireEvent("requestdone",this,e,r,i),this.fireEvent(e,this,r,i,n),this.hasChanges()||this.fireEvent("nochanges",this)),r):(this.fireEvent("requestfail",this,e,r,i),this.fireEvent(e+"fail",this,r,i,n),this.warn("CrudManager: "+e+" failed, please inspect the server response",t),r)},onLoad:function(e,t,i){return this.onResponse("load",e,t,i)},onSync:function(e,t,i){return this.onResponse("sync",e,t,i)},load:function(e,t,i){var n;"object"==typeof e&&(n=e,e=t,t=i,i=arguments[3]);var r=this.getLoadPackage(n);!1!==this.fireEvent("beforeload",this,r)?(i=i||this,this.activeRequests.load&&(this.cancelRequest(this.activeRequests.load.desc),this.fireEvent("loadcanceled",this,r)),this.activeRequests.load={id:r.requestId},this.activeRequests.load.desc=this.sendRequest({data:this.encode(r),type:"load",success:function(r,a){var s=this.onLoad(r,a,n);!t||s&&s.success?e&&e.call(i,s,r,n):t.call(i,s,r,n)},failure:function(e,n){this.onLoad(e,n),t&&t.apply(i,arguments)},scope:this})):this.fireEvent("loadcanceled",this,r)},sync:function(e,t,i){if(this.activeRequests.sync)return this.delayedSyncs.push(arguments),void this.fireEvent("syncdelayed",this,arguments);var n=this.getChangeSetPackage();return i=i||this,n?!1===this.fireEvent("beforesync",this,n)?void this.fireEvent("synccanceled",this,n):(this.activeRequests.sync={id:n.requestId},void(this.activeRequests.sync.desc=this.sendRequest({data:this.encode(n),type:"sync",success:function(n,r){var a=this.activeRequests.sync,s=this.onSync(n,r);!t||s&&s.success?e&&e.call(i,s,n,a):t.call(i,s,n,a),this.runDelayedSync()},failure:function(e,n){this.onSync(e,n),t&&t.apply(i,arguments),this.runDelayedSync()},scope:this}))):void(e&&e.call(i,null,null))},runDelayedSync:function(){var e=this.delayedSyncs.shift();e&&this.sync.apply(this,e)},commit:function(){for(var e=0,t=this.stores.length;e<t;e++)this.stores[e].store.commitChanges()},reject:function(){for(var e=0,t=this.stores.length;e<t;e++)this.stores[e].store.rejectChanges()},warn:function(){if("console"in window){var e=console;e.log&&e.log.apply&&e.log.apply(e,arguments)}},isLoading:function(){return!!this.activeRequests.load}}),Ext.define("Sch.crud.encoder.Json",{format:"json",encode:function(e){return Ext.JSON.encode(e)},decode:function(e){return"object"==typeof e?e:Ext.JSON.decode(e,!0)}}),Ext.define("Sch.crud.encoder.Xml",{format:"xml",stringReplaces:[[/&/g,"&amp;"],[/</g,"&lt;"],[/>/g,"&gt;"],[/"/g,"&quot;"]],encodeString:function(e){if(!e)return e;for(var t=e.toString(),i=this.stringReplaces,n=0,r=i.length;n<r;n++)t=t.replace(i[n][0],i[n][1]);return t},encodeRecords:function(e){for(var t="",i=0,n=e.length;i<n;i++)t+=this.encodeRecord(e[i]);return t},encodeRecord:function(e){var t="<record>";for(var i in e){var n=e[i];t+='<field id="'+this.encodeString(i)+'">'+(n&&n.$store?this.encodeStoreChanges({storeId:i},n):this.encodeString(n))+"</field>"}return t+="</record>"},encodeStoreChanges:function(e,t){var i='<store id="'+this.encodeString(e.storeId)+'">';return t.added&&(i+="<added>"+this.encodeRecords(t.added)+"</added>"),t.updated&&(i+="<updated>"+this.encodeRecords(t.updated)+"</updated>"),t.removed&&(i+="<removed>"+this.encodeRecords(t.removed)+"</removed>"),i+="</store>"},encode:function(e){var t,i,n,r;switch(e.type){case"load":for(t='<load requestId="'+this.encodeString(e.requestId)+'">',i=0,n=e.stores.length;i<n;i++)r=e.stores[i],t+="string"==typeof r?'<store id="'+this.encodeString(r)+'"/>':'<store id="'+this.encodeString(r.storeId)+'" page="'+this.encodeString(r.page)+'" pageSize="'+this.encodeString(r.pageSize)+'"/>';return t+="</load>";case"sync":t='<sync requestId="'+this.encodeString(e.requestId)+'" revision="'+this.encodeString(e.revision)+'">';for(i in e)e.hasOwnProperty(i)&&(r=this.getStore(i))&&(t+=this.encodeStoreChanges(r,e[i]));t+="</sync>"}return t},stringToXML:function(e){if(e){var t;return window.DOMParser?t=(new DOMParser).parseFromString(e,"text/xml"):window.ActiveXObject&&(t=new ActiveXObject("Microsoft.XMLDOM"),t.async=!1,t.loadXML(e)),t}},decodeRecords:function(e){for(var t=[],i=0,n=e.length;i<n;i++)t.push(this.decodeRecord(e[i]));return t},decodeRecord:function(e){for(var t,i=e.childNodes,n={},r=0,a=i.length;r<a;r++){var s=i[r];if("field"==s.nodeName){if(t="",s.firstChild){var o=this.getElementByTagName(s,"store");t=o?this.decodeStore(o):s.firstChild.nodeValue}n[s.getAttribute("id")]=t}}return n},getElementsByTagName:function(e,t){for(var i=e.childNodes,n=[],r=0,a=i.length;r<a;r++)i[r].nodeName==t&&n.push(i[r]);return n},getElementByTagName:function(e,t){for(var i=e.childNodes,n=0,r=i.length;n<r;n++)if(i[n].nodeName==t)return i[n]},decodeStore:function(e){var t={},i=this.getElementsByTagName(e,"rows");if(i.length){t.rows=this.decodeRecords(this.getElementsByTagName(i[0],"record"));var n=parseInt(i[0].getAttribute("total"),10);(isNaN(n)||n<t.rows.length)&&(n=t.rows.length),t.total=n}var r=this.getElementByTagName(e,"removed");return r&&(t.removed=this.decodeRecords(this.getElementsByTagName(r,"record"))),t},decode:function(e){var t="string"==typeof e?this.stringToXML(e):e;if(t){var i,n,r={},a=t.documentElement,s=a.getElementsByTagName("store");if(r.requestId=a.getAttribute("requestId"),r.revision=a.getAttribute("revision"),r.success=a.getAttribute("success")||"false",r.success="true"==r.success.toLowerCase(),!r.success){r.code=a.getAttribute("code");var o=a.getElementsByTagName("message")[0];r.message=o&&o.firstChild&&o.firstChild.nodeValue}for(var l=0,d=s.length;l<d;l++)i=s[l],n=i.getAttribute("id"),this.getStore(n)&&(r[n]=this.decodeStore(i));return r}}}),Ext.define("Sch.crud.transport.Ajax",{defaultMethod:{load:"GET",sync:"POST"},cancelRequest:function(e){Ext.Ajax.abort(e)},sendRequest:function(e){var t=e.data,i=this.transport[e.type],n=i.paramName,r=Ext.apply({},i&&i.params),a=i.method||this.defaultMethod[e.type],s=Ext.apply({url:i.url,method:a,params:r,failure:e.failure,success:function(t,i){e.success&&e.success.call(e.scope||this,t.responseXml||t.responseText)},scope:e.scope},i.requestConfig);return n?(s.params=s.params||{},s.params[n]=t):"xml"===this.format?Ext.apply(s,{xmlData:t}):Ext.apply(s,{jsonData:t}),this.fireEvent("beforesend",this,r,e.type,s),Ext.Ajax.request(s)}}),Ext.define("Sch.data.mixin.UniversalModelGetter",{getModelById:function(e){var t=this;return t.getNodeById?t.getNodeById(e):t.getById(e)},getModelByInternalId:function(e){var t=this;return t.byInternalIdMap?t.byInternalIdMap[e]:t.getByInternalId(e)}}),Ext.define("Sch.data.mixin.CacheHintHelper",{extend:Ext.Mixin,mixinConfig:{before:{loadRecords:"loadRecords"}},loadRecords:function(){var e=this;e.fireEvent("cacheresethint",e)}}),Ext.define("Sch.model.Customizable",{extend:Ext.data.Model,customizableFields:null,previous:null,__editing:null,__editCounter:0,constructor:function(){return this.callParent(arguments)},onClassExtended:function(e,t,i){var n=i.onBeforeCreated;i.onBeforeCreated=function(e,t){n.apply(this,arguments);var i=e.prototype;if(i.customizableFields){i.customizableFields=(e.superclass.customizableFields||[]).concat(i.customizableFields);var r=i.customizableFields,a={},s=this,o=Ext.Array.findBy(e.fields,function(e){return e.name===i.idProperty});s.idField=i.idField=o,e.fieldsMap[i.idProperty]||(e.fieldsMap[i.idProperty]=o),Ext.Array.forEach(r,function(e){"string"==typeof e&&(e={name:e}),a[e.name]=e});var l=i.fields,d=[],c=[];Ext.Array.forEach(l,function(e){e.isCustomizableField&&c.push(e.getName())}),"id"!==i.idProperty&&i.getField("id")&&(i.getField("id").hasOwnProperty("name")||c.push("id")),"Id"!==i.idProperty&&i.getField("Id")&&(i.getField("Id").hasOwnProperty("name")||c.push("Id")),e.removeFields(c),Ext.Object.each(a,function(e,t){t.isCustomizableField=!0;var n,a=t.name||t.getName(),s="Id"===a?"idProperty":a.charAt(0).toLowerCase()+a.substr(1)+"Field",o=i[s],l=o||a;i.getField(l)?(n=Ext.applyIf({name:a,isCustomizableField:!0},i.getField(l)),i.getField(l).isCustomizableField=!0,n=Ext.create("data.field."+(n.type||"auto"),n),r.push(n)):(n=Ext.applyIf({name:l,isCustomizableField:!0},t),n=Ext.create("data.field."+(n.type||"auto"),n),d.push(n));var c=Ext.String.capitalize(a);if("Id"!=c){var h="get"+c,u="set"+c;(!i[h]||i[h].__getterFor__&&i[h].__getterFor__!=l)&&(i[h]=function(){return this.get(l)},i[h].__getterFor__=l),(!i[u]||i[u].__setterFor__&&i[u].__setterFor__!=l)&&(i[u]=function(e){return this.set(l,e)},i[u].__setterFor__=l)}}),e.addFields(d)}}},set:function(e,t){var i,n;if(this.previous=this.previous||{},"string"==typeof e){if(i=this.get(e),i instanceof Date&&!(t instanceof Date)&&(t=this.getField(e).convert(t,this)),!(i instanceof Date&&i-t)&&(i instanceof Date||i===t))return[];this.previous[e]=i}else for(var r in e){i=this.get(r);var a=e[r];i instanceof Date&&!(a instanceof Date)&&(a=this.getField(r).convert(a,this)),(i instanceof Date&&i-a||!(i instanceof Date)&&i!==a)&&(this.previous[r]=i)}return n=this.callParent(arguments),this.__editing||delete this.previous,n},reject:function(){var e,t=this,i=t.modified||{};t.__editing=!0,t.previous=t.previous||{};for(e in i)i.hasOwnProperty(e)&&"function"!=typeof i[e]&&(t.previous[e]=t.get(e));t.callParent(arguments),delete t.previous,t.__editing=!1},beginEdit:function(){this.__editCounter++,this.__editing=!0,this.callParent(arguments)},cancelEdit:function(){this.__editCounter=0,this.__editing=!1,this.callParent(arguments),delete this.previous},endEdit:function(e,t){if(0==--this.__editCounter){if(!e&&this.getModifiedFieldNames){var i=this.editMemento;t||(t=this.getModifiedFieldNames(i.data)),t&&0===t.length&&(e=!0)}this.callParent([e].concat(Array.prototype.slice.call(arguments,1))),this.__editing=!1,delete this.previous}}}),Ext.define("Sch.model.Assignment",{extend:Sch.model.Customizable,idProperty:"Id",customizableFields:[{name:"ResourceId"},{name:"EventId"}],resourceIdField:"ResourceId",eventIdField:"EventId",getInternalId:function(){return this.internalId},getAssignmentStore:function(){return this.joined&&this.joined[0]},getEventStore:function(){var e=this.getAssignmentStore();return e&&e.getEventStore()},getResourceStore:function(){var e=this.getEventStore();return e&&e.getResourceStore()},getEvent:function(e){var t=this;return(e=e||t.getEventStore())&&e.getModelById(t.getEventId())},getResource:function(e){var t=this;return(e=e||t.getResourceStore())&&e.getModelById(t.getResourceId())},getEventName:function(e){var t=this.getEvent(e);return t&&t.getName()||""},getResourceName:function(e){var t=this.getResource(e);return t&&t.getName()||""},isPersistable:function(){var e=this,t=e.getEvent(),i=e.getResource();return t&&!t.phantom&&i&&!i.phantom},fullCopy:function(){return this.copy.apply(this,arguments)}}),Ext.define("Sch.locale.Locale",{l10n:null,l10nOverrides:{},legacyMode:!0,localeName:null,namespaceId:null,constructor:function(){Sch.locale.Active||(Sch.locale.Active={},this.bindRequire());var e=this.self.getName().split("."),t=this.localeName=e.pop();this.namespaceId=e.join(".");var i=Sch.locale.Active[this.namespaceId];"En"==t&&i&&"En"!=i.localeName||this.apply()},bindRequire:function(){var e=Ext.ClassManager.triggerCreated;Ext.ClassManager.triggerCreated=function(t){if(e.apply(this,arguments),t){var i=Ext.ClassManager.get(t);for(var n in Sch.locale.Active)Sch.locale.Active[n].apply(i)}}},applyToClass:function(e,t){var i=this,n=i.self.getName();if((t=t||Ext.ClassManager.get(e))&&t.activeLocaleId!==n){var r=i.l10n[e];if("function"==typeof r?r(e):t.singleton?t.l10n=Ext.apply({},r,t.prototype&&t.prototype.l10n):Ext.override(t,{l10n:r}),i.legacyMode){var a;if(t.prototype?a=t.prototype:t.singleton&&(a=t),a&&a.legacyMode){a.legacyHolderProp&&(a[a.legacyHolderProp]||(a[a.legacyHolderProp]={}),a=a[a.legacyHolderProp]);for(var s in r)"function"!=typeof a[s]&&(a[s]=r[s])}}t.activeLocaleId=n,t.onLocalized&&t.onLocalized()}},apply:function(e){if(this.l10n){var t=this;if(e){Ext.isArray(e)||(e=[e]);for(var i,n,r=0,a=e.length;r<a;r++)Ext.isObject(e[r])?e[r].singleton?(n=e[r],i=Ext.getClassName(Ext.getClass(n))):(n=Ext.getClass(e[r]),i=Ext.getClassName(n)):(n=null,i="string"==typeof e[r]?e[r]:Ext.getClassName(e[r])),i&&i in this.l10n&&t.applyToClass(i,n)}else{Sch.locale.Active[this.namespaceId]=this;for(var s in this.l10n)t.applyToClass(s)}}}}),Ext.define("Sch.locale.En",{extend:Sch.locale.Locale,singleton:!0,constructor:function(e){Ext.apply(this,{l10n:{"Sch.util.Date":{unitNames:{YEAR:{single:"year",plural:"years",abbrev:"yr"},QUARTER:{single:"quarter",plural:"quarters",abbrev:"q"},MONTH:{single:"month",plural:"months",abbrev:"mon"},WEEK:{single:"week",plural:"weeks",abbrev:"w"},DAY:{single:"day",plural:"days",abbrev:"d"},HOUR:{single:"hour",plural:"hours",abbrev:"h"},MINUTE:{single:"minute",plural:"minutes",abbrev:"min"},SECOND:{single:"second",plural:"seconds",abbrev:"s"},
MILLI:{single:"ms",plural:"ms",abbrev:"ms"}}},"Sch.panel.TimelineGridPanel":{weekStartDay:1,loadingText:"Loading, please wait...",savingText:"Saving changes, please wait..."},"Sch.panel.TimelineTreePanel":{weekStartDay:1,loadingText:"Loading, please wait...",savingText:"Saving changes, please wait..."},"Sch.mixin.SchedulerView":{loadingText:"Loading events..."},"Sch.plugin.CurrentTimeLine":{tooltipText:"Current time"},"Sch.plugin.EventEditor":{saveText:"Save",deleteText:"Delete",cancelText:"Cancel"},"Sch.plugin.SimpleEditor":{newEventText:"New booking..."},"Sch.widget.ExportDialog":{generalError:"An error occured, try again.",title:"Export Settings",formatFieldLabel:"Paper format",orientationFieldLabel:"Orientation",rangeFieldLabel:"Export range",showHeaderLabel:"Add page number",showFooterLabel:"Add footer",orientationPortraitText:"Portrait",orientationLandscapeText:"Landscape",completeViewText:"Complete schedule",currentViewText:"Current view",Date_RangeText:"Date range",Date_RangeFromText:"Export from",pickerText:"Resize column/rows to desired value",Date_RangeToText:"Export to",exportButtonText:"Export",cancelButtonText:"Cancel",progressBarText:"Exporting...",exportersFieldLabel:"Export mode",adjustCols:"Adjust column width",adjustColsAndRows:"Adjust column width and row height",specifyDate_Range:"Specify date range",columnPickerLabel:"Select columns",dpiFieldLabel:"DPI (dots per inch)"},"Sch.plugin.Export":{fetchingRows:"Fetching row {0} of {1}",builtPage:"Built page {0} of {1}",requestingPrintServer:"Please wait..."},"Sch.plugin.Printable":{dialogTitle:"Print settings",rangeFieldLabel:"Print range",exportersFieldLabel:"Control pagination",exportButtonText:"Print"},"Sch.plugin.exporter.AbstractExporter":{name:"Exporter"},"Sch.plugin.exporter.SinglePage":{name:"Single page"},"Sch.plugin.exporter.MultiPageVertical":{name:"Multiple pages (vertically)"},"Sch.plugin.exporter.MultiPage":{name:"Multiple pages"},"Sch.preset.Manager":{hourAndDay:{displayDateFormat:"G:i",middleDateFormat:"G:i",topDateFormat:"D d/m"},secondAndMinute:{displayDateFormat:"g:i:s",topDateFormat:"D, d g:iA"},dayAndWeek:{displayDateFormat:"m/d h:i A",middleDateFormat:"D d M"},weekAndDay:{displayDateFormat:"m/d",bottomDateFormat:"d M",middleDateFormat:"Y F d"},weekAndMonth:{displayDateFormat:"m/d/Y",middleDateFormat:"m/d",topDateFormat:"m/d/Y"},weekAndDayLetter:{displayDateFormat:"m/d/Y",middleDateFormat:"D d M Y"},weekDateAndMonth:{displayDateFormat:"m/d/Y",middleDateFormat:"d",topDateFormat:"Y F"},monthAndYear:{displayDateFormat:"m/d/Y",middleDateFormat:"M Y",topDateFormat:"Y"},year:{displayDateFormat:"m/d/Y",middleDateFormat:"Y"},manyYears:{displayDateFormat:"m/d/Y",middleDateFormat:"Y"}}}}),this.callParent(arguments)}}),Ext.define("Sch.mixin.Localizable",{legacyMode:!1,activeLocaleId:"",l10n:null,isLocaleApplied:function(){var e=this.singleton&&this.activeLocaleId||this.self.activeLocaleId;if(!e)return!1;for(var t in Sch.locale.Active)if(e===Sch.locale.Active[t].self.getName())return!0;return!1},applyLocale:function(){for(var e in Sch.locale.Active)Sch.locale.Active[e].apply(this.singleton?this:this.self.getName())},L:function(){return this.localize.apply(this,arguments)},localize:function(e,t,i){if(this.isLocaleApplied()||i||this.applyLocale(),this.hasOwnProperty("l10n")&&this.l10n.hasOwnProperty(e)&&"function"!=typeof this.l10n[e])return this.l10n[e];var n=this.self&&this.self.prototype;if(this.legacyMode){var r=t||this.legacyHolderProp,a=r?this[r]:this;if(a&&a.hasOwnProperty(e)&&"function"!=typeof a[e])return a[e];if(n){var s=r?n[r]:n;if(s&&s.hasOwnProperty(e)&&"function"!=typeof s[e])return s[e]}}var o=n.l10n&&n.l10n[e];if(null===o||void 0===o){var l=n&&n.superclass;if(l&&l.localize&&(o=l.localize(e,t,i)),null===o||void 0===o)throw"Cannot find locale: "+e+" ["+this.self.getName()+"]"}return o}}),Ext.define("Sch.util.Date",{mixins:[Sch.mixin.Localizable],singleton:!0,stripEscapeRe:/(\\.)/g,hourInfoRe:/([gGhHisucUOPZ]|MS)/,unitHash:null,unitsByName:{},constructor:function(){var e=Ext.Date,t=this.unitHash={MILLI:e.MILLI,SECOND:e.SECOND,MINUTE:e.MINUTE,HOUR:e.HOUR,DAY:e.DAY,WEEK:"w",MONTH:e.MONTH,QUARTER:"q",YEAR:e.YEAR};Ext.apply(this,t);var i=this;this.units=[i.MILLI,i.SECOND,i.MINUTE,i.HOUR,i.DAY,i.WEEK,i.MONTH,i.QUARTER,i.YEAR]},onLocalized:function(){this.setUnitNames(this.L("unitNames"))},setUnitNames:function(e){var t=this.unitsByName={};this.l10n.unitNames=e,this._unitNames=Ext.apply({},e);var i=this.unitHash;for(var n in i)if(i.hasOwnProperty(n)){var r=i[n];this._unitNames[r]=this._unitNames[n],t[n]=r,t[r]=r}},betweenLesser:function(e,t,i){var n=e.getTime();return t.getTime()<=n&&n<i.getTime()},constrain:function(e,t,i){return this.min(this.max(e,t),i)},compareUnits:function(e,t){var i=Ext.Array.indexOf(this.units,e),n=Ext.Array.indexOf(this.units,t);return i>n?1:i<n?-1:0},isUnitGreater:function(e,t){return this.compareUnits(e,t)>0},copyTimeValues:function(e,t){e.setHours(t.getHours()),e.setMinutes(t.getMinutes()),e.setSeconds(t.getSeconds()),e.setMilliseconds(t.getMilliseconds())},add:function(e,t,i){var n=Ext.Date.clone(e);if(!t||0===i)return n;switch(t.toLowerCase()){case this.MILLI:n=new Date(e.getTime()+i);break;case this.SECOND:n=new Date(e.getTime()+1e3*i);break;case this.MINUTE:n=new Date(e.getTime()+6e4*i);break;case this.HOUR:n=new Date(e.getTime()+36e5*i);break;case this.DAY:n.setDate(e.getDate()+i),23===n.getHours()&&0===e.getHours()&&(n=Ext.Date.add(n,Ext.Date.HOUR,1));break;case this.WEEK:n.setDate(e.getDate()+7*i);break;case this.MONTH:var r=e.getDate();r>28&&(r=Math.min(r,Ext.Date.getLastDateOfMonth(this.add(Ext.Date.getFirstDateOfMonth(e),this.MONTH,i)).getDate())),n.setDate(r),n.setMonth(n.getMonth()+i);break;case this.QUARTER:n=this.add(e,this.MONTH,3*i);break;case this.YEAR:n.setFullYear(e.getFullYear()+i)}return n},getUnitDurationInMs:function(e){return this.add(new Date(1,0,1),e,1)-new Date(1,0,1)},getMeasuringUnit:function(e){return e===this.WEEK?this.DAY:e},getDurationInUnit:function(e,t,i,n){var r;switch(i){case this.YEAR:r=this.getDurationInYears(e,t);break;case this.QUARTER:r=this.getDurationInMonths(e,t)/3;break;case this.MONTH:r=this.getDurationInMonths(e,t);break;case this.WEEK:r=this.getDurationInDays(e,t)/7;break;case this.DAY:r=this.getDurationInDays(e,t);break;case this.HOUR:r=this.getDurationInHours(e,t);break;case this.MINUTE:r=this.getDurationInMinutes(e,t);break;case this.SECOND:r=this.getDurationInSeconds(e,t);break;case this.MILLI:r=this.getDurationInMilliseconds(e,t)}return n?r:Math.round(r)},getUnitToBaseUnitRatio:function(e,t){if(e===t)return 1;switch(e){case this.YEAR:switch(t){case this.QUARTER:return.25;case this.MONTH:return 1/12}break;case this.QUARTER:switch(t){case this.YEAR:return 4;case this.MONTH:return 1/3}break;case this.MONTH:switch(t){case this.YEAR:return 12;case this.QUARTER:return 3}break;case this.WEEK:switch(t){case this.DAY:return 1/7;case this.HOUR:return 1/168}break;case this.DAY:switch(t){case this.WEEK:return 7;case this.HOUR:return 1/24;case this.MINUTE:return 1/1440}break;case this.HOUR:switch(t){case this.DAY:return 24;case this.MINUTE:return 1/60}break;case this.MINUTE:switch(t){case this.HOUR:return 60;case this.SECOND:return 1/60;case this.MILLI:return 1/6e4}break;case this.SECOND:switch(t){case this.MILLI:return.001}break;case this.MILLI:switch(t){case this.SECOND:return 1e3}}return-1},getDurationInMilliseconds:function(e,t){return t-e},getDurationInSeconds:function(e,t){return(t-e)/1e3},getDurationInMinutes:function(e,t){return(t-e)/6e4},getDurationInHours:function(e,t){return(t-e)/36e5},getDurationInDays:function(e,t){return(t-e+60*(e.getTimezoneOffset()-t.getTimezoneOffset())*1e3)/864e5},getDurationInMonths:function(e,t){return 12*(t.getFullYear()-e.getFullYear())+(t.getMonth()-e.getMonth())},getDurationInYears:function(e,t){return this.getDurationInMonths(e,t)/12},min:function(e,t){return e<t?e:t},max:function(e,t){return e>t?e:t},intersectSpans:function(e,t,i,n){return this.betweenLesser(e,i,n)||this.betweenLesser(i,e,t)},getNameOfUnit:function(e){switch(e=this.getUnitByName(e),e.toLowerCase()){case this.YEAR:return"YEAR";case this.QUARTER:return"QUARTER";case this.MONTH:return"MONTH";case this.WEEK:return"WEEK";case this.DAY:return"DAY";case this.HOUR:return"HOUR";case this.MINUTE:return"MINUTE";case this.SECOND:return"SECOND";case this.MILLI:return"MILLI"}throw"Incorrect UnitName"},getReadableNameOfUnit:function(e,t){return this.isLocaleApplied()||this.applyLocale(),this._unitNames[e][t?"plural":"single"]},getShortNameOfUnit:function(e){return this.isLocaleApplied()||this.applyLocale(),this._unitNames[e].abbrev},getUnitByName:function(e){return this.isLocaleApplied()||this.applyLocale(),this.unitsByName[e]||Ext.Error.raise("Unknown unit name: "+e),this.unitsByName[e]},getNext:function(e,t,i,n){var r=Ext.Date.clone(e);switch(n=arguments.length<4?1:n,i=null==i?1:i,t){case this.MILLI:r=this.add(e,t,i);break;case this.SECOND:r=this.add(e,t,i),r.getMilliseconds()>0&&r.setMilliseconds(0);break;case this.MINUTE:r=this.add(e,t,i),r.getSeconds()>0&&r.setSeconds(0),r.getMilliseconds()>0&&r.setMilliseconds(0);break;case this.HOUR:r=this.add(e,t,i),r.getMinutes()>0&&r.setMinutes(0),r.getSeconds()>0&&r.setSeconds(0),r.getMilliseconds()>0&&r.setMilliseconds(0);break;case this.DAY:if(23===e.getHours()&&1===this.add(r,this.HOUR,1).getHours())return r=this.add(r,this.DAY,2),this.clearTime(r),r;this.clearTime(r),r=this.add(r,this.DAY,i),1===r.getHours()&&this.clearTime(r);break;case this.WEEK:this.clearTime(r);var a=r.getDay();r=this.add(r,this.DAY,n-a+7*(i-(n<=a?0:1))),r.getDay()!==n?r=this.add(r,this.HOUR,1):this.clearTime(r);break;case this.MONTH:r=this.add(r,this.MONTH,i),r.setDate(1),this.clearTime(r);break;case this.QUARTER:r=this.add(r,this.MONTH,3*(i-1)+(3-r.getMonth()%3)),this.clearTime(r),r.setDate(1);break;case this.YEAR:r=new Date(r.getFullYear()+i,0,1);break;default:throw"Invalid date unit"}return r},getNumberOfMsFromTheStartOfDay:function(e){return e-this.clearTime(e,!0)||864e5},getNumberOfMsTillTheEndOfDay:function(e){return this.getStartOfNextDay(e,!0)-e},getStartOfNextDay:function(e,t,i){var n=this.add(i?e:this.clearTime(e,t),this.DAY,1);if(n.getDate()==e.getDate()){var r=this.add(this.clearTime(e,t),this.DAY,2).getTimezoneOffset(),a=e.getTimezoneOffset();n=this.add(n,this.MINUTE,a-r)}return n},getEndOfPreviousDay:function(e,t){var i=t?e:this.clearTime(e,!0);return i-e?i:this.add(i,this.DAY,-1)},timeSpanContains:function(e,t,i,n){return i-e>=0&&t-n>=0},compareWithPrecision:function(e,t,i){var n,r=Sch.util.Date,a=Ext.Date;switch(i){case r.DAY:e=Number(a.format(e,"Ymd")),t=Number(a.format(t,"Ymd"));break;case r.WEEK:e=Number(a.format(e,"YmW")),t=Number(a.format(t,"YmW"));break;case r.MONTH:e=Number(a.format(e,"Ym")),t=Number(a.format(t,"Ym"));break;case r.QUARTER:e=4*e.getFullYear()+Math.floor(e.getMonth()/3),t=4*t.getFullYear()+Math.floor(t.getMonth()/3);break;case r.YEAR:e=e.getFullYear(),t=t.getFullYear();break;default:case r.MILLI:case r.SECOND:case r.MINUTE:case r.HOUR:i=i&&this.getUnitDurationInMs(i)||1,e=Math.floor(e.valueOf()/i),t=Math.floor(t.valueOf()/i)}return e<t&&(n=-1)||e>t&&(n=1)||(n=0),n},getValueInUnits:function(e,t){switch(t){case this.MONTH:return e.getMonth();case this.DAY:return e.getDate();case this.HOUR:return e.getHours();case this.MINUTE:return e.getMinutes();case this.SECOND:return e.getSeconds()}},setValueInUnits:function(e,t,i){var n,r=Ext.Date.clone(e);switch(t){case this.YEAR:n="setFullYear";break;case this.MONTH:n="setMonth";break;case this.DAY:n="setDate";break;case this.HOUR:n="setHours";break;case this.MINUTE:n="setMinutes";break;case this.SECOND:n="setSeconds";break;case this.MILLI:n="setMilliseconds"}return r[n](i),r},getSubUnit:function(e){switch(e){case this.YEAR:return this.MONTH;case this.MONTH:return this.DAY;case this.DAY:return this.HOUR;case this.HOUR:return this.MINUTE;case this.MINUTE:return this.SECOND;case this.SECOND:return this.MILLI}},setValueInSubUnits:function(e,t,i){return t=this.getSubUnit(t),this.setValueInUnits(e,t,i)},mergeDates:function(e,t,i){var n=Ext.Date.clone(e);switch(i){case this.YEAR:n.setFullYear(t.getFullYear());case this.MONTH:n.setMonth(t.getMonth());case this.WEEK:case this.DAY:i===this.WEEK?n=this.add(n,this.DAY,t.getDay()-n.getDay()):n.setDate(t.getDate());case this.HOUR:n.setHours(t.getHours());case this.MINUTE:n.setMinutes(t.getMinutes());case this.SECOND:n.setSeconds(t.getSeconds());case this.MILLI:n.setMilliseconds(t.getMilliseconds())}return n},splitToSubUnits:function(e,t,i,n){switch(i=i||1,n=arguments.length<4?1:n,t){case this.MONTH:return this.splitMonth(e,i,n);case this.WEEK:case this.DAY:return this.splitDay(e,i)}},splitYear:function(e,t){var i=this.clearTime(e,!0);i.setMonth(0),i.setDate(1);for(var n=[],r=0;r<=12;r+=t)n.push(this.add(i,this.MONTH,r));return n},splitMonth:function(e,t,i){var n=this.clearTime(e,!0);n.setDate(1),n=this.add(n,this.DAY,i-n.getDay());for(var r=Ext.Date.clone(n),a=this.add(n,this.MONTH,1),s=[],o=0;r.getTime()<a.getTime();o+=t)r=this.add(n,this.WEEK,o),s.push(r);return s},splitWeek:function(e,t,i){var n=this.add(e,this.DAY,i-e.getDay());n=this.clearTime(n);for(var r=[],a=0;a<=7;a+=t)r.push(this.add(n,this.DAY,a));return r},splitDay:function(e,t){for(var i=this.clearTime(e,!0),n=[],r=0;r<=24;r+=t)n.push(this.add(i,this.HOUR,r));return n},splitHour:function(e,t){var i=new Date(e.getTime());i.setMinutes(0),i.setSeconds(0),i.setMilliseconds(0);for(var n=[],r=0;r<=60;r+=t)n.push(this.add(i,this.MINUTE,r));return n},splitMinute:function(e,t){var i=Ext.Date.clone(e);i.setSeconds(0),i.setMilliseconds(0);for(var n=[],r=0;r<=60;r+=t)n.push(this.add(i,this.SECOND,r));return n},clearTime:function(e,t){return e.getHours()>0||e.getMinutes()>0||e.getSeconds()>0?Ext.Date.clearTime(e,t):t?Ext.Date.clone(e):e}}),Ext.define("Sch.model.Range",{extend:Sch.model.Customizable,idProperty:"Id",config:Ext.versions.touch?{idProperty:"Id"}:null,startDateField:"StartDate",endDateField:"EndDate",nameField:"Name",clsField:"Cls",customizableFields:[{name:"StartDate",type:"date",dateFormat:"c"},{name:"EndDate",type:"date",dateFormat:"c"},{name:"Cls",type:"string"},{name:"Name",type:"string"}],setStartDate:function(e,t){var i=this.getEndDate(),n=this.getStartDate();this.set(this.startDateField,e),!0===t&&i&&n&&this.setEndDate(Sch.util.Date.add(e,Sch.util.Date.MILLI,i-n))},setEndDate:function(e,t){var i=this.getStartDate(),n=this.getEndDate();this.set(this.endDateField,e),!0===t&&i&&n&&this.setStartDate(Sch.util.Date.add(e,Sch.util.Date.MILLI,-(n-i)))},setStartEndDate:function(e,t){this.beginEdit(),this.set(this.startDateField,e),this.set(this.endDateField,t),this.endEdit()},getDates:function(){for(var e=[],t=this.getEndDate(),i=Ext.Date.clearTime(this.getStartDate(),!0);i<t;i=Sch.util.Date.add(i,Sch.util.Date.DAY,1))e.push(i);return e},forEachDate:function(e,t){return Ext.each(this.getDates(),e,t)},isValid:function(){var e=this.callParent(arguments);if(e){var t=this.getStartDate(),i=this.getEndDate();e=!t||!i||i-t>=0}return e},shift:function(e,t){this.setStartEndDate(Sch.util.Date.add(this.getStartDate(),e,t),Sch.util.Date.add(this.getEndDate(),e,t))},fullCopy:function(){return this.copy.apply(this,arguments)}}),Ext.define("Sch.model.Resource",{extend:Sch.model.Customizable,idProperty:"Id",config:Ext.versions.touch?{idProperty:"Id"}:null,nameField:"Name",customizableFields:[{name:"Name",type:"string"}],getInternalId:function(){return this.internalId},getResourceStore:function(){return this.joined&&this.joined[0]},getEventStore:function(){var e=this.getResourceStore();return e&&e.getEventStore()||this.parentNode&&this.parentNode.getEventStore()},getAssignmentStore:function(){var e=this.getEventStore();return e&&e.getAssignmentStore()},getEvents:function(e){var t=this;return(e=e||t.getEventStore())&&e.getEventsForResource(t)||[]},getAssignments:function(){var e=this,t=e.getEventStore();return t&&t.getAssignmentsForResource(e)},isPersistable:function(){var e=this.parentNode;return!e||!e.phantom||e.isRoot&&e.isRoot()}}),Ext.define("Sch.util.Cache",{cache:null,constructor:function(){this.cache={}},key:function(e){return e instanceof Ext.data.Model?e.getId().toString():void 0===e||null===e?"[ undefined / null ]":e.toString()},get:function(e,t){var i,n=this;return e=n.key(e),i=n.cache.hasOwnProperty(e)&&n.cache[e],!i&&t?i=t():i||(i=[]),n.cache[e]=i,i},add:function(e,t){var i=this,n=i.key(e);return i.cache.hasOwnProperty(n)||(i.cache[n]=i.get(e)),Ext.Array.include(i.cache[n],t),i},remove:function(e,t){var i=this;return e=i.key(e),i.cache.hasOwnProperty(e)&&Ext.Array.remove(i.cache[e],t),i},move:function(e,t,i){var n=this;e=n.key(e),t=n.key(t),e!=t&&arguments.length>=3?(n.remove(e,i),n.add(t,i)):e!=t&&n.cache.hasOwnProperty(e)&&n.cache.hasOwnProperty(t)?(n.cache[t]=Ext.Array.union(n.cache[t],n.cache[e]),n.cache[e]=[]):e!=t&&n.cache.hasOwnProperty(e)&&(n.cache[t]=n.cache[e],n.cache[e]=[])},clear:function(e){var t=this;return arguments.length?(e=t.key(e),t.cache.hasOwnProperty(e)&&delete t.cache[e]):t.cache={},t},uncache:function(e){var t,i=this;for(t in i.cache)i.cache.hasOwnProperty(t)&&(i.cache[t]=Ext.Array.remove(i.cache[t],e));return i}}),Ext.define("Sch.data.util.EventAssignmentsCache",{extend:Sch.util.Cache,assignmentStore:null,assignmentStoreDetacher:null,eventStoreDetacher:null,constructor:function(e){function t(e,t){Ext.Array.forEach(t,function(e){c.add(e.getEventId(),e)})}function i(e,t){Ext.Array.forEach(t,function(e){c.remove(e.getEventId(),e)})}function n(e,t,i){var n=t.eventIdField,r=t.previous&&n in t.previous,a=r&&t.previous[n];i!=Ext.data.Model.COMMIT&&r&&c.move(a,t.getEventId(),t)}function r(e){c.clear()}function a(e,t){c.clear(),d(t)}function s(e,t,i,n){c.move(i,n)}function o(e,t){Ext.Array.forEach(t,function(e){c.clear(e)})}function l(){c.clear()}function d(e){Ext.destroy(c.eventStoreDetacher),c.eventStoreDetacher=e&&e.on({idchanged:s,remove:o,cacheresethint:l,clear:l,rootchange:l,priority:100,destroyable:!0})}var c=this,h=e.getEventStore();c.callParent(),c.assignmentStoreDetacher=e.on({add:t,remove:i,update:n,cacheresethint:r,clear:r,eventstorechange:a,priority:100,destroyable:!0}),c.assignmentStoreFiltersDetacher=e.getFilters().on("endupdate",r,c,{priority:1002,destroyable:!0}),d(h),c.assignmentStore=e},destroy:function(){var e=this;Ext.destroyMembers(e,"assignmentStoreDetacher","eventStoreDetacher"),e.assignmentStore=null},get:function(e,t){var i=this;return e=i.key(e),t=t||function(){return Ext.Array.filter(i.assignmentStore.getRange(),function(t){return t.getEventId()==e})},i.callParent([e,t])}}),Ext.define("Sch.data.util.ResourceAssignmentsCache",{extend:Sch.util.Cache,assignmentStore:null,assignmentStoreDetacher:null,eventStoreDetacher:null,resourceStoreDetacher:null,constructor:function(e){function t(e,t){Ext.Array.forEach(t,function(e){u.add(e.getResourceId(),e)})}function i(e,t){Ext.Array.forEach(t,function(e){u.remove(e.getResourceId(),e)})}function n(e,t,i){var n=t.resourceIdField,r=t.previous&&n in t.previous,a=r&&t.previous[n];i!=Ext.data.Model.COMMIT&&r&&u.move(a,t.getResourceId(),t)}function r(e){u.clear()}function a(e,t){c(t),h(t&&t.getResourceStore())}function s(e,t){u.clear(),h(t)}function o(e,t,i,n){u.move(i,n)}function l(e,t){Ext.Array.forEach(t,function(e){u.clear(e)})}function d(){u.clear()}function c(e){Ext.destroy(u.eventStoreDetacher),u.eventStoreDetacher=e&&e.on({resourcestorechange:s,priority:100,destroyable:!0})}function h(e){Ext.destroy(u.resourceStoreDetacher),u.resourceStoreDetacher=e&&e.on({idchanged:o,remove:l,clear:d,cacheresethint:d,rootchange:d,priority:100,destroyable:!0})}var u=this,g=e.getEventStore(),f=g&&g.getResourceStore();u.callParent(),u.assignmentStoreDetacher=e.on({add:t,remove:i,update:n,clear:r,cacheresethint:r,eventstorechange:a,priority:100,destroyable:!0}),u.assignmentStoreFiltersDetacher=e.getFilters().on("endupdate",r,u,{priority:1002,destroyable:!0}),c(g),h(f),u.assignmentStore=e},destroy:function(){var e=this;Ext.destroyMembers(e,"assignmentStoreDetacher","assignmentStoreFiltersDetacher","eventStoreDetacher","resourceStoreDetacher"),e.assignmentStore=null},get:function(e,t){var i=this;return e=i.key(e),t=t||function(){return Ext.Array.filter(i.assignmentStore.getRange(),function(t){return t.getResourceId()==e})},i.callParent([e,t])}}),Ext.define("Sch.data.util.AssignmentStoreEventResourcesCache",{extend:Sch.util.Cache,assignmentStore:null,assignmentStoreDetacher:null,eventStoreDetacher:null,resourceStoreDetacher:null,constructor:function(e){function t(e,t){var i=a.assignmentStore.getEventStore(),n=i&&i.getResourceStore();Ext.Array.forEach(t,function(e){var t=n&&n.getModelById(e.getResourceId());t?a.add(e.getEventId(),t):a.clear(e.getEventId())})}function i(e,t){var i=a.assignmentStore.getEventStore(),n=i&&i.getResourceStore();Ext.Array.forEach(t,function(e){var t=n.getModelById(e.getResourceId());t?a.remove(e.getEventId(),t):a.clear(e.getEventId())})}function n(e,t,i){var n,r=t.resourceIdField,s=t.previous&&r in t.previous,o=s&&t.previous[r],l=t.eventIdField,d=t.previous&&l in t.previous,c=d&&t.previous[l],h=a.assignmentStore.getEventStore(),u=h&&h.getResourceStore();i!=Ext.data.Model.COMMIT&&(s||d)&&(o=s?o:t.getResourceId(),c=d?c:t.getEventId(),n=u.getModelById(o),n?a.remove(c,n):a.clear(c),n=u.getModelById(t.getResourceId()),n?a.add(t.getEventId(),n):a.clear(t.getEventId()))}function r(e){a.clear()}var a=this,s=e.getEventStore();s&&s.getResourceStore();a.callParent(),a.assignmentStoreDetacher=e.on({add:t,remove:i,update:n,clear:r,cacheresethint:r,priority:100,destroyable:!0}),a.assignmentStore=e},destroy:function(){var e=this;Ext.destroyMembers(e,"assignmentStoreDetacher","eventStoreDetacher","resourceStoreDetacher"),e.assignmentStore=null},get:function(e,t){var i=this;return t=t||function(){return i.assignmentStore.mapAssignmentsForEvent(e,function(e){return e.getResource()},function(e){return!!e})},i.callParent([e,t])}}),Ext.define("Sch.data.util.AssignmentStoreResourceEventsCache",{extend:Sch.util.Cache,assignmentStore:null,assignmentStoreDetacher:null,eventStoreDetacher:null,resourceStoreDetacher:null,constructor:function(e){function t(e,t){var i=f.assignmentStore.getEventStore();Ext.Array.forEach(t,function(e){var t=i&&i.getModelById(e.getEventId());t?f.add(e.getResourceId(),t):f.clear(e.getResourceId())})}function i(e,t){var i=f.assignmentStore.getEventStore();Ext.Array.forEach(t,function(e){var t=i&&i.getModelById(e.getEventId());t?f.remove(e.getResourceId(),t):f.clear(e.getResourceId())})}function n(e,t,i){var n,r=t.resourceIdField,a=t.previous&&r in t.previous,s=a&&t.previous[r],o=t.eventIdField,l=t.previous&&o in t.previous,d=l&&t.previous[o],c=f.assignmentStore.getEventStore();i!=Ext.data.Model.COMMIT&&(a||l)&&(s=a?s:t.getResourceId(),d=l?d:t.getEventId(),n=c&&c.getModelById(d),n?f.remove(s,n):f.clear(s),n=c&&c.getModelById(t.getEventId()),n?f.add(t.getResourceId(),n):f.clear(t.getResourceId()))}function r(e){f.clear()}function a(e,t){f.clear(),u(t),g(t&&t.getResourceStore())}function s(e,t){Ext.Array.forEach(t,function(e){f.uncache(e)})}function o(){f.clear()}function l(e,t){f.clear(),g(t)}function d(e,t,i,n){f.move(i,n)}function c(e,t){Ext.Array.forEach(t,function(e){f.clear(e)})}function h(){f.clear()}function u(e){Ext.destroy(f.eventStoreDetacher),f.eventStoreDetacher=e&&e.on({remove:s,cacheresethint:o,clear:o,rootchange:o,resourcestorechange:l,priority:100,destroyable:!0})}function g(e){Ext.destroy(f.resourceStoreDetacher),f.resourceStoreDetacher=e&&e.on({idchanged:d,remove:c,cacheresethint:h,clear:h,rootchange:h,priority:100,destroyable:!0})}var f=this,p=e.getEventStore(),m=p&&p.getResourceStore();f.callParent(),f.assignmentStoreDetacher=e.on({add:t,remove:i,update:n,cacheresethint:r,clear:r,eventstorechange:a,priority:100,destroyable:!0}),u(p),g(m),f.assignmentStore=e},destroy:function(){var e=this;Ext.destroyMembers(e,"assignmentStoreDetacher","eventStoreDetacher","resourceStoreDetacher"),e.assignmentStore=null},get:function(e,t){var i=this;return t=t||function(){return i.assignmentStore.mapAssignmentsForResource(e,function(e){return e.getEvent()},function(e){return!!e})},i.callParent([e,t])}}),Ext.define("Sch.data.AssignmentStore",{extend:Ext.data.Store,mixins:[Sch.data.mixin.UniversalModelGetter,Sch.data.mixin.CacheHintHelper],model:"Sch.model.Assignment",alias:"store.assignmentstore",storeId:"assignments",proxy:"memory",eventResourceCache:null,resourceEventsCache:null,eventStoreDetacher:null,resourceStoreDetacher:null,eventStore:null,constructor:function(e){var t=this;t.callParent([e]),t.eventAssignmentsCache=t.eventAssignmentsCache||new Sch.data.util.EventAssignmentsCache(t),t.resourceAssignmentsCache=t.resourceAssignmentsCache||new Sch.data.util.ResourceAssignmentsCache(t)},destroy:function(){var e=this;Ext.destroyMembers(e,"eventResourceCache","resourceEventsCache","eventAssignmentsCache","resourceEventsCache","eventStoreDetacher","resourceStoreDetacher"),e.callParent()},getEventStore:function(){return this.eventStore},setEventStore:function(e){var t=this,i=t.eventStore;t.eventStore,t.eventStore=e&&Ext.StoreMgr.lookup(e)||null,t.eventStore,t.attachToEventStore(t.eventStore),(i||e)&&i!==e&&t.fireEvent("eventstorechange",t,e,i)},attachToEventStore:function(e){var t=this;Ext.destroy(t.eventStoreDetacher),e&&e instanceof Ext.data.TreeStore?t.eventStoreDetacher=e.on({noderemove:t.onEventNodeRemove,resourcestorechange:t.onEventStoreResourceStoreChange,scope:t,destroyable:!0,priority:200}):e&&(t.eventStoreDetacher=e.on({remove:t.onEventRemove,resourcestorechange:t.onEventStoreResourceStoreChange,scope:t,destroyable:!0,priority:200})),t.attachToResourceStore(e&&e.getResourceStore())},attachToResourceStore:function(e){var t=this;Ext.destroy(t.resourceStoreDetacher),e&&e instanceof Ext.data.TreeStore?t.resourceStoreDetacher=e.on({noderemove:t.onResourceNodeRemove,scope:t,destroyable:!0,priority:200}):e&&(t.resourceStoreDetacher=e.on({remove:t.onResourceRemove,scope:t,destroyable:!0,priority:200}))},onEventStoreResourceStoreChange:function(e,t,i){this.attachToResourceStore(t)},onEventRemove:function(e,t,i,n){var r,a=this;n||(r=[],Ext.Array.forEach(t,function(e){r=r.concat(a.getAssignmentsForEvent(e))}),r.length&&a.remove(r))},onEventNodeRemove:function(e,t,i){var n,r=this;i||(n=[],t.cascadeBy(function(e){n=n.concat(r.getAssignmentsForEvent(e))}),n.length&&r.remove(n))},onResourceRemove:function(e,t,i,n){var r,a=this;n||(r=[],Ext.Array.forEach(t,function(e){r=r.concat(a.getAssignmentsForResource(e))}),r.length&&a.remove(r))},onResourceNodeRemove:function(e,t,i){var n,r=this;i||(n=[],t.cascadeBy(function(e){n=n.concat(r.getAssignmentsForResource(e))}),n.length&&r.remove(n))},mapAssignmentsForEvent:function(e,t,i){var n=this,r=[];return t=t||Ext.identityFn,i=i||Ext.returnTrue,t!==Ext.identityFn||i!==Ext.returnTrue?Ext.Array.forEach(n.eventAssignmentsCache.get(e),function(e){var n=t(e);i(n)&&r.push(n)}):r=[].concat(n.eventAssignmentsCache.get(e)),r},mapAssignmentsForResource:function(e,t,i){var n=this,r=[];return t=t||Ext.identityFn,i=i||Ext.returnTrue,t!==Ext.identityFn||i!==Ext.returnTrue?Ext.Array.forEach(n.resourceAssignmentsCache.get(e),function(e){var n=t(e);i(n)&&r.push(n)}):r=[].concat(n.resourceAssignmentsCache.get(e)),r},getAssignmentsForEvent:function(e){return this.mapAssignmentsForEvent(e)},removeAssignmentsForEvent:function(e){var t=this;t.remove(t.getAssignmentsForEvent(e))},getAssignmentsForResource:function(e){return this.mapAssignmentsForResource(e)},removeAssignmentsForResource:function(e){var t=this;t.remove(t.getAssignmentsForResource(e))},getResourcesForEvent:function(e){var t=this;return t.eventResourceCache?t.eventResourceCache.get(e):t.mapAssignmentsForEvent(e,function(e){return e.getResource()},function(e){return!!e})},getEventsForResource:function(e){var t=this;return t.resourceEventsCache?t.resourceEventsCache.get(e):t.mapAssignmentsForResource(e,function(e){return e.getEvent()},function(e){return!!e})},assignEventToResource:function(e,t,i){var n=this,r=[];i=i||Ext.identityFn;var a=Ext.isArray(t)?t:[t];return Ext.Array.forEach(a,function(t){if(!n.isEventAssignedToResource(e,t)){var a=new n.model;a.setEventId(e instanceof Ext.data.Model&&e.getId()||e),a.setResourceId(t instanceof Ext.data.Model&&t.getId()||t),a=i(a),r.push(a)}}),n.add(r),r},unassignEventFromResource:function(e,t){var i,n=this;return t?n.isEventAssignedToResource(e,t)&&(i=n.getAssignmentForEventAndResource(e,t),n.remove(i)):this.removeAssignmentsForEvent(e),i},isEventAssignedToResource:function(e,t){var i,n,r=this,a=r.getResourcesForEvent(e),s=!1;for(t=t instanceof Ext.data.Model&&t.getId()||t,i=0,n=a.length;!s&&i<n;i++)s=a[i],s=s.getId()==t;return s},getAssignmentForEventAndResource:function(e,t){var i,n,r=this,a=r.getAssignmentsForEvent(e),s=null;for(t=t instanceof Ext.data.Model&&t.getId()||t,i=0,n=a.length;!s&&i<n;i++)s=a[i],s=s.getResourceId()==t&&s||null;return s}}),Ext.define("Sch.data.util.IdConsistencyManager",{config:{eventStore:null,resourceStore:null,assignmentStore:null},eventStoreDetacher:null,resourceStoreDetacher:null,constructor:function(e){this.initConfig(e)},updateEventStore:function(e,t){var i=this;Ext.destroyMembers(i,"eventStoreDetacher"),e&&(i.eventStoreDetacher=e.on({idchanged:i.onEventIdChanged,scope:i,destroyable:!0,priority:200}))},updateResourceStore:function(e,t){var i=this;Ext.destroyMembers(i,"resourceStoreDetacher"),e&&(i.resourceStoreDetacher=e.on({idchanged:i.onResourceIdChanged,scope:i,destroyable:!0,priority:200}))},onEventIdChanged:function(e,t,i,n){var r,a=this,s=a.getAssignmentStore();s&&(r=a.getUpdateAssignmentEventIdFieldFn(s,i,n),e.on("update",r,null,{single:!0,priority:200}))},onResourceIdChanged:function(e,t,i,n){var r,a,s=this,o=s.getEventStore(),l=s.getAssignmentStore();o&&!l&&(r=s.getUpdateEventResourceIdFieldFn(o,i,n)),l&&(a=s.getUpdateAssignmentResourceIdFieldFn(l,i,n)),(r||l)&&e.on("update",function(){r&&r(),a&&a()},null,{single:!0,priority:200})},getUpdateEventResourceIdFieldFn:function(e,t,i){var n=e.getRange();return function(){Ext.Array.forEach(n,function(e){e.getResourceId()==t&&e.setResourceId(i)})}},getUpdateAssignmentEventIdFieldFn:function(e,t,i){var n=e.getAssignmentsForEvent(t);return function(){Ext.Array.forEach(n,function(e){e.getEventId()==t&&e.setEventId(i)})}},getUpdateAssignmentResourceIdFieldFn:function(e,t,i){var n=e.getAssignmentsForResource(t);return function(){Ext.Array.forEach(n,function(e){e.getResourceId()==t&&e.setResourceId(i)})}}}),Ext.define("Sch.data.util.ModelPersistencyManager",{config:{eventStore:null,resourceStore:null,assignmentStore:null},eventStoreDetacher:null,resourceStoreDetacher:null,assignmentStoreDetacher:null,constructor:function(e){this.initConfig(e)},updateEventStore:function(e,t){var i=this;Ext.destroyMembers(i,"eventStoreDetacher"),e&&e.autoSync&&(i.eventStoreDetacher=e.on({beforesync:i.onEventStoreBeforeSync,scope:i,destroyable:!0,priority:100}))},updateResourceStore:function(e,t){var i=this;Ext.destroyMembers(i,"resourceStoreDetacher"),e&&e.autoSync&&(i.resourceStoreDetacher=e.on({beforesync:i.onResourceStoreBeforeSync,scope:i,destroyable:!0,priority:100}))},updateAssignmentStore:function(e,t){var i=this;Ext.destroyMembers(i,"assignmentStoreDetacher"),e&&e.autoSync&&(i.assignmentStoreDetacher=e.on({beforesync:i.onAssignmentStoreBeforeSync,scope:i,destroyable:!0,priority:100}))},onEventStoreBeforeSync:function(e){var t=this;return t.removeNonPersistableRecordsToCreate(e),t.shallContinueSync(e)},onResourceStoreBeforeSync:function(e){var t=this;return t.removeNonPersistableRecordsToCreate(e),t.shallContinueSync(e)},onAssignmentStoreBeforeSync:function(e){var t=this;return t.removeNonPersistableRecordsToCreate(e),t.shallContinueSync(e)},removeNonPersistableRecordsToCreate:function(e){var t,i,n=e.create||[];for(i=n.length-1;i>=0;--i)t=n[i],t.isPersistable()||Ext.Array.remove(n,t);0===n.length&&delete e.create},shallContinueSync:function(e){
return Boolean(e.create&&e.create.length>0||e.update&&e.update.length>0||e.destroy&&e.destroy.length>0)}}),Ext.define("Sch.data.util.ResourceEventsCache",{extend:Sch.util.Cache,eventStore:null,eventStoreDetacher:null,resourceStoreDetacher:null,constructor:function(e){function t(e,t){Ext.Array.forEach(t,function(e){c.add(e.getResourceId(),e)})}function i(e,t){Ext.Array.forEach(t,function(e){c.remove(e.getResourceId(),e)})}function n(e,t,i,n){var r=t.resourceIdField,a=t.previous&&r in t.previous,s=a&&t.previous[r];i!=Ext.data.Model.COMMIT&&a&&c.move(s,t.getResourceId(),t)}function r(){c.clear()}function a(e,t,i){c.clear(),d(t)}function s(e,t,i,n){c.move(i,n)}function o(e,t){Ext.Array.forEach(t,function(e){c.clear(e)})}function l(){c.clear()}function d(e){Ext.destroy(c.resourceStoreDetacher),c.resourceStoreDetacher=e&&e.on({idchanged:s,remove:o,clear:l,cacheresethint:l,rootchange:l,priority:100,destroyable:!0})}var c=this,h=e.getResourceStore();c.callParent(),c.eventStoreDetacher=e.on({add:t,remove:i,update:n,clear:r,cacheresethint:r,rootchange:r,resourcestorechange:a,priority:100,destroyable:!0}),c.eventStoreFiltersDetacher=e.getFilters().on("endupdate",r,this,{priority:1002,destroyable:!0}),d(h),c.eventStore=e},destroy:function(){var e=this;Ext.destroyMembers(e,"eventStoreDetacher","eventStoreFiltersDetacher","resourceStoreDetacher"),e.eventStore=null},get:function(e,t){var i=this;return e=i.key(e),t=t||function(){return Ext.Array.filter(i.eventStore.getRange(),function(t){return t.getResourceId()==e})},i.callParent([e,t])}}),Ext.define("Sch.data.mixin.EventStore",{extend:Ext.Mixin,isEventStore:!0,resourceStore:null,resourceStoreDetacher:null,assignmentStore:null,resourceEventsCache:null,idConsistencyManager:null,modelPersistencyManager:null,mixinConfig:{after:{constructor:"constructor",destroy:"destroy"}},constructor:function(){var e=this;e.resourceEventsCache=e.createResourceEventsCache(),e.idConsistencyManager=e.createIdConsistencyManager(),e.modelPersistencyManager=e.createModelPersistencyManager()},destroy:function(){var e=this;Ext.destroyMembers(e,"resourceEventsCache","idConsistencyManager","modelPersistencyManager")},createResourceEventsCache:function(){return new Sch.data.util.ResourceEventsCache(this)},createIdConsistencyManager:function(){var e=this;return new Sch.data.util.IdConsistencyManager({eventStore:e,resourceStore:e.getResourceStore(),assignmentStore:e.getAssignmentStore()})},createModelPersistencyManager:function(){var e=this;return new Sch.data.util.ModelPersistencyManager({eventStore:e,resourceStore:e.getResourceStore(),assignmentStore:e.getAssignmentStore()})},getResourceStore:function(){return this.resourceStore},setResourceStore:function(e){var t=this,i=t.resourceStore;t.resourceStore&&(t.resourceStore.setEventStore(null),t.idConsistencyManager&&t.idConsistencyManager.setResourceStore(null),t.modelPersistencyManager&&t.modelPersistencyManager.setResourceStore(null)),t.resourceStore=e&&Ext.StoreMgr.lookup(e)||null,t.resourceStore&&(t.modelPersistencyManager&&t.modelPersistencyManager.setResourceStore(t.resourceStore),t.idConsistencyManager&&t.idConsistencyManager.setResourceStore(t.resourceStore),e.setEventStore(t)),(i||e)&&i!==e&&t.fireEvent("resourcestorechange",t,e,i)},getAssignmentStore:function(){return this.assignmentStore},setAssignmentStore:function(e){var t=this,i=t.assignmentStore;t.assignmentStore&&(t.assignmentStore.setEventStore(null),t.idConsistencyManager&&t.idConsistencyManager.setAssignmentStore(null),t.modelPersistencyManager&&t.modelPersistencyManager.setAssignmentStore(null)),t.assignmentStore=e&&Ext.StoreMgr.lookup(e)||null,t.assignmentStore?(t.modelPersistencyManager&&t.modelPersistencyManager.setAssignmentStore(t.assignmentStore),t.idConsistencyManager&&t.idConsistencyManager.setAssignmentStore(t.assignmentStore),t.assignmentStore.setEventStore(t),Ext.destroy(t.resourceEventsCache)):t.resourceEventsCache=t.createResourceEventsCache(),(i||e)&&i!==e&&t.fireEvent("assignmentstorechange",t,e,i)},isDate_RangeAvailable:function(e,t,i,n){var r=Sch.util.Date,a=this.getEventsForResource(n),s=!0;return Ext.each(a,function(n){return s=i===n||!r.intersectSpans(e,t,n.getStartDate(),n.getEndDate())}),s},getEventsInTimeSpan:function(e,t,i){var n=new Ext.util.MixedCollection,r=[];if(!1!==i){var a=Sch.util.Date;this.forEachScheduledEvent(function(i,n,s){a.intersectSpans(n,s,e,t)&&r.push(i)})}else this.forEachScheduledEvent(function(i,n,a){n-e>=0&&t-a>=0&&r.push(i)});return n.addAll(r),n},forEachScheduledEvent:function(e,t){this.each(function(i){var n=i.getStartDate(),r=i.getEndDate();if(n&&r)return e.call(t||this,i,n,r)},this)},getTotalTimeSpan:function(){var e=new Date(9999,0,1),t=new Date(0),i=Sch.util.Date;return this.each(function(n){n.getStartDate()&&(e=i.min(n.getStartDate(),e)),n.getEndDate()&&(t=i.max(n.getEndDate(),t))}),e=e<new Date(9999,0,1)?e:null,t=t>new Date(0)?t:null,this.lastTotalTimeSpan={start:e||null,end:t||e||null},this.lastTotalTimeSpan},filterEventsForResource:function(e,t,i){var n=e.getEvents(this);return Ext.Array.filter(n,t,i||this)},append:function(e){throw"Must be implemented by consuming class"},getResourcesForEvent:function(e){var t,i=this,n=i.getAssignmentStore(),r=i.getResourceStore();return n?t=n.getResourcesForEvent(e):r?(e=e instanceof Sch.model.Event&&e||i.getModelById(e),t=e&&r.getModelById(e.getResourceId()),t=t&&[t]||[]):t=[],t},getEventsForResource:function(e){var t=this,i=t.getAssignmentStore();return i?i.getEventsForResource(e):t.resourceEventsCache?t.resourceEventsCache.get(e):[]},getAssignmentsForEvent:function(e){var t=this,i=t.getAssignmentStore();return i&&i.getAssignmentsForEvent(e)||[]},getAssignmentsForResource:function(e){var t=this,i=t.getAssignmentStore();return i&&i.getAssignmentsForResource(e)||[]},assignEventToResource:function(e,t){var i=this,n=i.getAssignmentStore();n?n.assignEventToResource(e,t):(e=e instanceof Sch.model.Event&&e||i.getModelById(e),t=t instanceof Sch.model.Resource?t.getId():t,e&&e.setResourceId(t))},unassignEventFromResource:function(e,t){var i=this,n=i.getAssignmentStore();n?n.unassignEventFromResource(e,t):(e=e instanceof Sch.model.Event&&e||i.getModelById(e),t=t instanceof Sch.model.Resource?t.getId():t,e&&e.getResourceId()==t&&e.setResourceId(null))},reassignEventFromResourceToResource:function(e,t,i){var n=this,r=n.getAssignmentStore();r?(r.unassignEventFromResource(e,t),r.assignEventToResource(e,i)):(e=e instanceof Sch.model.Event&&e||n.getModelById(e),t=t instanceof Sch.model.Resource?t.getId():t,i=i instanceof Sch.model.Resource?i.getId():i,e.getResourceId()==t&&e.setResourceId(i))},isEventAssignedToResource:function(e,t){var i,n=this,r=n.getAssignmentStore();return r?i=r.isEventAssignedToResource(e,t):(e=e instanceof Sch.model.Event&&e||n.getModelById(e),t=t instanceof Sch.model.Resource?t.getId():t,i=e&&e.getResourceId()==t||!1),i},removeAssignmentsForEvent:function(e){var t=this,i=t.getAssignmentStore();i?i.removeAssignmentsForEvent(e):(e=e instanceof Sch.model.Event&&e||t.getModelById(e))&&e.setResourceId(null)},removeAssignmentsForResource:function(e){var t=this,i=t.getAssignmentStore(),n=t.getResourceStore();i?i.removeAssignmentsForResource(e):n?(e=e instanceof Sch.model.Resource&&e||n.getModelById(e))&&Ext.Array.forEach(t.resourceEventsCache.get(e),function(e){e.setResourceId(null)}):(e=e instanceof Sch.model.Resource?e.getId():e,Ext.Array.forEach(t.getRange(),function(t){t.getResourceId()==e&&t.setResourceId(null)}))},isEventPersistable:function(e){var t,i,n,r=this,a=r.getAssignmentStore(),s=!0;if(!a)for(t=e.getResources(),i=0,n=t.length;s&&i<n;++i)s=!0!==t[i].phantom;return s}}),Ext.define("Sch.model.Event",{extend:Sch.model.Range,idProperty:"Id",customizableFields:[{name:"ResourceId"},{name:"Draggable",type:"boolean",persist:!1,defaultValue:!0},{name:"Resizable",persist:!1,defaultValue:!0}],resourceIdField:"ResourceId",draggableField:"Draggable",resizableField:"Resizable",getInternalId:function(){return this.internalId},getEventStore:function(){var e=this,t=e.joined&&e.joined[0];return t&&!t.isEventStore&&(Ext.Array.sort(e.joined,function(e,t){return(e.isEventStore||!1)>(t.isEventStore||!1)&&-1||1}),t=e.joined[0]),t},getResourceStore:function(){var e=this.getEventStore();return e&&e.getResourceStore()},getAssignmentStore:function(){var e=this.getEventStore();return e&&e.getAssignmentStore()},getResources:function(){var e=this,t=e.getEventStore();return t&&t.getResourcesForEvent(e)||[]},forEachResource:function(e,t){for(var i=this.getResources(),n=0;n<i.length;n++)if(!1===e.call(t||this,i[n]))return},getResource:function(e,t){var i,n=this,r=null;return t=t||n.getEventStore(),i=t&&t.getResourceStore(),e=null==e?n.getResourceId():e,!t||null!==e&&void 0!==e?i&&(r=i.getModelById(e)):(r=t.getResourcesForEvent(n),1==r.length?r=r[0]:r.length>1?Ext.Error.raise("Event::getResource() is not applicable for events with multiple assignments, please use Event::getResources() instead."):r=null),r},setResource:function(e){var t=this,i=t.getEventStore();i&&i.removeAssignmentsForEvent(t),t.assign(e)},assign:function(e){var t=this,i=t.getEventStore();e=e instanceof Sch.model.Resource?e.getId():e,i?i.assignEventToResource(t,e):t.setResourceId(e)},unassign:function(e){var t=this,i=t.getEventStore();e=e instanceof Sch.model.Resource?e.getId():e,i?i.unassignEventFromResource(t,e):t.getResourceId()==e&&t.setResourceId(null)},reassign:function(e,t){var i=this,n=i.getEventStore();e=e instanceof Sch.model.Resource?e.getId():e,t=t instanceof Sch.model.Resource?t.getId():t,n?n.reassignEventFromResourceToResource(i,e,t):i.setResourceId(t)},isAssignedTo:function(e){var t=this,i=t.getEventStore();return e=e instanceof Sch.model.Resource&&e.getId()||e,i?i.isEventAssignedToResource(t,e):t.getResourceId()==e},getAssignments:function(){var e=this,t=e.getEventStore();return t&&t.getAssignmentsForEvent(e)},isDraggable:function(){return this.getDraggable()},isResizable:function(){return this.getResizable()},isPersistable:function(){var e=this,t=e.getEventStore();return t&&t.isEventPersistable(e)}}),Ext.define("Sch.data.EventStore",{extend:Ext.data.Store,alias:"store.eventstore",mixins:[Sch.data.mixin.UniversalModelGetter,Sch.data.mixin.CacheHintHelper,Sch.data.mixin.EventStore],storeId:"events",model:"Sch.model.Event",config:{model:"Sch.model.Event"},proxy:"memory",constructor:function(e){var t=this;if(t.callParent([e]),t.resourceStore&&t.setResourceStore(t.resourceStore),t.assignmentStore&&t.setAssignmentStore(t.assignmentStore),t.getModel()!==Sch.model.Event&&!(t.getModel().prototype instanceof Sch.model.Event))throw"The model for the EventStore must subclass Sch.model.Event"},append:function(e){this.add(e)}}),Ext.define("Sch.util.Patch",{target:null,minVersion:null,maxVersion:null,reportUrl:null,description:null,applyFn:null,ieOnly:!1,macOnly:!1,overrides:null,onClassExtended:function(e,t){Sch.disableOverrides||t.ieOnly&&!Ext.isIE||t.macOnly&&!Ext.isMac||t.minVersion&&!Ext.versions.extjs.equals(t.minVersion)&&!Ext.versions.extjs.isGreaterThan(t.minVersion)||t.maxVersion&&!Ext.versions.extjs.equals(t.maxVersion)&&!Ext.versions.extjs.isLessThan(t.maxVersion)||(t.applyFn?t.applyFn():Ext.ClassManager.get(t.target).override(t.overrides))}}),Ext.define("Sch.patches.OperationDestroy",{extend:Sch.util.Patch,target:"Ext.data.operation.Destroy",minVersion:"5.1.1",maxVersion:"5.1.2",overrides:{doProcess:function(){var e,t=Ext.Array.slice(this.getRecords()),i=t.length;for(e=0;e<i;++e)t[e].setErased()}}}),Ext.define("Sch.data.mixin.ResourceStore",{eventStore:null,getEventStore:function(){return this.eventStore},setEventStore:function(e){var t,i=this;i.eventStore!==e&&(t=i.eventStore,i.eventStore=e&&Ext.StoreMgr.lookup(e)||null,i.fireEvent("eventstorechange",i,e,t))}}),Ext.define("Sch.data.ResourceStore",{extend:Ext.data.Store,model:"Sch.model.Resource",config:{model:"Sch.model.Resource"},alias:"store.resourcestore",mixins:[Sch.data.mixin.UniversalModelGetter,Sch.data.mixin.CacheHintHelper,Sch.data.mixin.ResourceStore],storeId:"resources",proxy:"memory",constructor:function(){if(this.callParent(arguments),this.getModel()!==Sch.model.Resource&&!(this.getModel().prototype instanceof Sch.model.Resource))throw"The model for the ResourceStore must subclass Sch.model.Resource"}}),Ext.define("Sch.patches.TreeStore",{extend:Sch.util.Patch,target:"Ext.data.TreeStore",minVersion:"5.1.0",overrides:{getRejectRecords:function(){return this.getModifiedRecords()},rejectChanges:function(){this.removed=this.removedNodes,this.callParent(arguments)},remove:function(e){if(e.isModel)e.remove();else if(e instanceof Array&&e[0].isModel)for(var t=0;t<e.length;t++)e[t].remove();else this.callParent(arguments)}}}),Ext.define("Sch.patches.TreeStoreInternalIdMap",{extend:Sch.util.Patch,target:"Ext.data.TreeStore",minVersion:"5.1.1",overrides:{registerNode:function(e,t){var i=this;i.byInternalIdMap||(i.byInternalIdMap={}),i.byInternalIdMap[e.internalId]=e,i.callParent(arguments)},unregisterNode:function(e,t){var i=this;i.byInternalIdMap&&delete i.byInternalIdMap[e.internalId],i.callParent(arguments)},updateRoot:function(){this.byInternalIdMap={},this.callParent(arguments)}}}),Ext.define("Sch.patches.NodeStore",{extend:Sch.util.Patch,target:"Ext.data.NodeStore",ieOnly:!0,maxVersion:"5.1.1",overrides:{afterEdit:function(e,t){if(this.getNode()&&t){if(-1!==Ext.Array.indexOf(t,"loaded"))return this.add(this.retrieveChildNodes(e));if(-1!==Ext.Array.indexOf(t,"expanded"))return this.filter();if(-1!==Ext.Array.indexOf(t,"sorted"))return this.sort()}Ext.data.Store.prototype.afterEdit.apply(this,arguments)}}}),Ext.define("Sch.data.mixin.FilterableTreeStore",{isFilteredFlag:!1,isHiddenFlag:!1,lastTreeFilter:null,lastTreeHiding:null,allowExpandCollapseWhileFiltered:!0,reApplyFilterOnDataChange:!0,suspendIncrementalFilterRefresh:0,filterGeneration:0,currentFilterGeneration:null,dataChangeListeners:null,monitoringDataChange:!1,filterUpdateSuspended:!1,onClassMixedIn:function(e){e.override(Sch.data.mixin.FilterableTreeStore.prototype.inheritables()||{})},initTreeFiltering:function(){this.treeFilter=new Ext.util.Filter({filterFn:this.isNodeFilteredIn,scope:this}),this.dataChangeListeners={nodeappend:this.onNeedToUpdateFilter,nodeinsert:this.onNeedToUpdateFilter,scope:this},Ext.getVersion().isGreaterThan("5.1.0.107")&&Ext.apply(this.dataChangeListeners,{beforeload:this.onStoreBeforeLoad,load:this.onStoreLoad})},onStoreBeforeLoad:function(){this.filterUpdateSuspended=!0},onStoreLoad:function(){this.filterUpdateSuspended=!1,this.onNeedToUpdateFilter()},startDataChangeMonitoring:function(){this.monitoringDataChange||(this.monitoringDataChange=!0,this.on(this.dataChangeListeners))},stopDataChangeMonitoring:function(){this.monitoringDataChange&&(this.monitoringDataChange=!1,this.un(this.dataChangeListeners))},onNeedToUpdateFilter:function(){!this.reApplyFilterOnDataChange||this.filterUpdateSuspended||this.suspendIncrementalFilterRefresh||this.reApplyFilter()},clearTreeFilter:function(){this.isTreeFiltered()&&(this.currentFilterGeneration=null,this.isFilteredFlag=!1,this.lastTreeFilter=null,this.isTreeFiltered(!0)||this.stopDataChangeMonitoring(),this.refreshNodeStoreContent(),this.fireEvent("filter-clear",this))},reApplyFilter:function(){this.isHiddenFlag&&this.hideNodesBy.apply(this,this.lastTreeHiding.concat(this.isFilteredFlag)),this.isFilteredFlag&&this.filterTreeBy(this.lastTreeFilter)},refreshNodeStoreContent:function(){var e=this;e.getFilters().indexOf(e.treeFilter)<0?e.addFilter(e.treeFilter):this.getFilters().fireEvent("endupdate",this.getFilters())},getIndexInTotalDataset:function(e){var t=this.getRootNode(),i=-1,n=this.rootVisible;if(!n&&e==t)return-1;var r=this.isTreeFiltered(),a=this.currentFilterGeneration,s=function(o){if((r&&o.__filterGen!=a||o.hidden)&&o==e)return!1;if((n||o!=t)&&i++,o==e)return!1;if(!o.isLeaf()&&o.isExpanded())for(var l=o.childNodes,d=l.length,c=0;c<d;c++)if(!1===s(l[c]))return!1};return s(t),i},isTreeFiltered:function(e){return this.isFilteredFlag||e&&this.isHiddenFlag},markFilteredNodes:function(e,t){var i=this,n=this.currentFilterGeneration,r={},a=this.getRootNode(),s=this.rootVisible,o=function(e){for(var t=e.parentNode;t&&!r[t.internalId];)r[t.internalId]=!0,t=t.parentNode},l=t.filter,d=t.scope||this,c=t.shallow,h=t.checkParents||c,u=t.fullMatchingParents,g=t.onlyParents||u;if(g&&h)throw new Error("Can't combine `onlyParents` and `checkParents` options");s&&(r[a.internalId]=!0);var f=function(e){if(!e.hidden){var t,i,n,p;if(e.isLeaf())l.call(d,e,r)&&(r[e.internalId]=!0,o(e));else if(g){if(t=l.call(d,e),i=e.childNodes,n=i.length,t&&(r[e.internalId]=!0,o(e),u))return void e.cascadeBy(function(e){r[e.internalId]=!0});for(p=0;p<n;p++)t&&i[p].isLeaf()?r[i[p].internalId]=!0:i[p].isLeaf()||f(i[p])}else if(h&&(t=l.call(d,e,r))&&(r[e.internalId]=!0,o(e)),!h||!c||c&&(t||e==a&&!s))for(i=e.childNodes,n=i.length,p=0;p<n;p++)f(i[p])}};f(e),a.cascadeBy(function(e){r[e.internalId]&&(e.__filterGen=n,i.allowExpandCollapseWhileFiltered&&!e.isLeaf()&&e.expand())})},filterTreeBy:function(e,t){this.currentFilterGeneration=this.filterGeneration++;var i;1==arguments.length&&Ext.isObject(arguments[0])?(t=e.scope,i=e.filter):(i=e,e={filter:i,scope:t}),this.fireEvent("nodestore-datachange-start",this),e=e||{},this.markFilteredNodes(this.getRootNode(),e),this.startDataChangeMonitoring(),this.isFilteredFlag=!0,this.lastTreeFilter=e,this.fireEvent("nodestore-datachange-end",this),this.fireEvent("filter-set",this),this.refreshNodeStoreContent()},isNodeFilteredIn:function(e){var t=this.isTreeFiltered(),i=this.currentFilterGeneration;return this.loading||!Boolean(t&&e.__filterGen!=i||e.hidden)},hasNativeFilters:function(){var e=this,t=e.getFilters(),i=t.getCount();return i&&i>1||t.indexOf(e.treeFilter)<0},hideNodesBy:function(e,t,i){var n=this;if(n.isFiltered()&&n.hasNativeFilters())throw new Error("Can't hide nodes of the filtered tree store");t=t||n,n.getRootNode().cascadeBy(function(i){i.hidden=Boolean(e.call(t,i,n))}),n.startDataChangeMonitoring(),n.isHiddenFlag=!0,n.lastTreeHiding=[e,t],i||n.refreshNodeStoreContent()},showAllNodes:function(e){this.getRootNode().cascadeBy(function(e){e.hidden=!1}),this.isHiddenFlag=!1,this.lastTreeHiding=null,this.isTreeFiltered(!0)||this.stopDataChangeMonitoring(),e||this.refreshNodeStoreContent()},inheritables:function(){return{onNodeExpand:function(e,t,i){if(!this.isTreeFiltered(!0)||e!=this.getRoot())return this.callParent(arguments);this.callParent(arguments),this.reApplyFilter()},onNodeCollapse:function(e,t,i,n,r){var a=this,s=a.data,o=s.contains,l=a.isTreeFiltered(),d=a.currentFilterGeneration;s.contains=function(){for(var i,n,r,s=a.indexOf(e)+1,c=!1,h=0;h<t.length;h++)if(!(t[h].hidden||l&&t[h].__filterGen!=d)&&o.call(this,t[h])){for(i=e;i.parentNode;){n=i;do{n=n.nextSibling}while(n&&(n.hidden||l&&n.__filterGen!=d));if(n){c=!0,r=a.indexOf(n);break}i=i.parentNode}c||(r=a.getCount()),a.removeAt(s,r-s);break}return!1},this.callParent(arguments),s.contains=o},handleNodeExpand:function(e,t,i){for(var n=this,r=[],a=n.isTreeFiltered(),s=n.currentFilterGeneration,o=0;o<t.length;o++){var l=t[o];a&&l.__filterGen!=s||l.hidden||(r[r.length]=l)}return this.callParent([e,r,i])},onNodeInsert:function(e,t,i){var n,r,a,s,o,l,d,c,h,u=this,g=t.raw||t.data;if(u.filterFn&&(c=u.filterFn(t),t.set("visible",c),c&&e.set("visible",u.filterFn(e))),u.registerNode(t,!0),u.beginUpdate(),u.isVisible(t)){if(0!==i&&t.previousSibling){for(r=t.previousSibling;r&&!r.get("visible");r=r.previousSibling);if(r){for(;r.isExpanded()&&r.lastChild;)r=r.lastChild;n=r}else n=e}else n=e;u.insert(u.indexOf(n)+1,t),!t.isLeaf()&&t.isExpanded()&&(t.isLoaded()?u.onNodeExpand(t,t.childNodes):u.fillCount||(t.set("expanded",!1),t.expand()))}else u.needsSync=u.needsSync||t.phantom||t.dirty;t.isLeaf()||t.isLoaded()||u.lazyFill||(a=u.getProxy().getReader(),s=t.getProxy(),o=s?s.getReader():null,l=o&&o.initialConfig.rootProperty?o:a,(d=l.getRoot(g))&&(h=t.childType,u.fillNode(t,l.extractData(d,h?{model:h}:void 0)))),u.endUpdate()},isFiltered:function(){return this.callParent(arguments)||this.isTreeFiltered()}}}}),Ext.define("Sch.data.ResourceTreeStore",{extend:Ext.data.TreeStore,mixins:[Sch.patches.NodeStore,Sch.data.mixin.UniversalModelGetter,Sch.data.mixin.CacheHintHelper,Sch.data.mixin.ResourceStore,Sch.data.mixin.FilterableTreeStore],alias:"store.resourcetreestore",model:"Sch.model.Resource",storeId:"resources",proxy:"memory",constructor:function(){if(this.callParent(arguments),this.initTreeFiltering(),this.getModel()!==Sch.model.Resource&&!(this.getModel().prototype instanceof Sch.model.Resource))throw"The model for the ResourceTreeStore must subclass Sch.model.Resource"},setRootNode:function(){this.isSettingRoot=!0;var e=this.callParent(arguments);return this.isSettingRoot=!1,e}}),Ext.define("Sch.model.TimeAxisTick",{extend:Sch.model.Range,startDateField:"start",endDateField:"end"}),Ext.define("Sch.data.TimeAxis",{extend:Ext.data.JsonStore,model:"Sch.model.TimeAxisTick",continuous:!0,originalContinuous:null,autoAdjust:!0,unit:null,increment:null,resolutionUnit:null,resolutionIncrement:null,weekStartDay:null,mainUnit:null,shiftUnit:null,shiftIncrement:1,defaultSpan:1,isConfigured:!1,adjustedStart:null,adjustedEnd:null,visibleTickStart:null,visibleTickEnd:null,presetName:null,mode:"plain",startTime:0,endTime:24,constructor:function(e){var t=this;if(e=e||{},t.setModel&&t.setModel(t.model),t.setMode(e.mode||t.mode),t.originalContinuous=t.continuous,t.callParent(arguments),t.on(Ext.versions.touch?"refresh":"datachanged",function(e){t.fireEvent("reconfigure",t,!1)}),t.on("endreconfigure",function(e,t){e.fireEvent("reconfigure",e,t)}),e.viewPreset){var i=Sch.preset.Manager.getPreset(e.viewPreset);i&&t.consumeViewPreset(i)}(e.start||t.start)&&t.reconfigure(e)},reconfigure:function(e,t){this.isConfigured=!0,Ext.apply(this,e);var i=this.getAdjustedDates(e.start,e.end,!0),n=this.getAdjustedDates(e.start,e.end),r=n.start,a=n.end;if(!1!==this.fireEvent("beforereconfigure",this,r,a)){this.fireEvent("beginreconfigure",this);var s=this.unit,o=this.increment||1,l=this.generateTicks(r,a,s,o,this.mainUnit);this.removeAll(!0),this.suspendEvents(),this.add(l),0===this.getCount()&&Ext.Error.raise("Invalid time axis configuration or filter, please check your input data."),this.resumeEvents();var d=Sch.util.Date,c=l.length;this.isContinuous()?(this.adjustedStart=i.start,this.adjustedEnd=this.getNext(c>1?l[c-1].start:i.start,s,o)):(this.adjustedStart=this.getStart(),this.adjustedEnd=this.getEnd());do{this.visibleTickStart=(this.getStart()-this.adjustedStart)/(d.getUnitDurationInMs(s)*o),this.visibleTickStart>=1&&(this.adjustedStart=d.getNext(this.adjustedStart,s,o))}while(this.visibleTickStart>=1);do{this.visibleTickEnd=c-(this.adjustedEnd-this.getEnd())/(d.getUnitDurationInMs(s)*o),c-this.visibleTickEnd>=1&&(this.adjustedEnd=d.getNext(this.adjustedEnd,s,-1))}while(c-this.visibleTickEnd>=1);this.fireEvent("endreconfigure",this,t)}},setMode:function(e){this.mode=e,this.generateTicksValidatorFn="calendar"===e?function(e){return!(this.startTime>0||this.endTime<24)||e.getHours()>=this.startTime&&e.getHours()<this.endTime}:function(){return!0}},setTimeSpan:function(e,t){var i=this.getAdjustedDates(e,t);e=i.start,t=i.end,this.getStart()-e==0&&this.getEnd()-t==0||this.reconfigure({start:e,end:t})},filterBy:function(e,t){this.continuous=!1,t=t||this,this.clearFilter(!0),this.suspendEvents(!0),this.filter([{filterFn:function(i,n){return e.call(t,i.data,n)}}]),0===this.getCount()&&(this.clearFilter(),this.resumeEvents(),Ext.Error.raise("Invalid time axis filter - no ticks passed through the filter. Please check your filter method.")),this.resumeEvents()},isContinuous:function(){return this.continuous&&!this.isFiltered()},clearFilter:function(){this.continuous=this.originalContinuous,this.callParent(arguments)},generateTicks:function(e,t,i,n){var r,a=[],s=Sch.util.Date,o=0;i=i||this.unit,n=n||this.increment;var l=this.getAdjustedDates(e,t);for(e=l.start,t=l.end;e<t;){if(r=this.getNext(e,i,n),!this.autoAdjust&&r>t&&(r=t),i===s.HOUR&&n>1&&a.length>0&&0===o){var d=a[a.length-1];o=(d.start.getHours()+n)%24-d.end.getHours(),0!==o&&(r=s.add(r,s.HOUR,o))}this.generateTicksValidatorFn(e)&&a.push({start:e,end:r}),e=r}return a},getVisibleTickTimeSpan:function(){return this.isContinuous()?this.visibleTickEnd-this.visibleTickStart:this.getCount()},getAdjustedDates:function(e,t,i){var n=Sch.util.Date;if(e=e||this.getStart(),t=t||n.add(e,this.mainUnit,this.defaultSpan),"calendar"===this.mode){if(this.shiftUnit===n.MONTH){var r=n.add(e,n.WEEK,1),a=n.add(t,n.WEEK,-1);if(t||(t=this.getNext(e,this.shiftUnit,1),t=this.ceilDate(t,!1,this.shiftUnit,1),t=this.ceilDate(t,!1,this.mainUnit,1)),r.getMonth()!==e.getMonth()&&a.getMonth()!==t.getMonth())return{start:e,end:t}}var s=this.floorDate(e,!1,this.shiftUnit,1);s=this.floorDate(s,!1,this.mainUnit,1);var o=this.getNext(e,this.shiftUnit,1),l=this.ceilDate(o,!1,this.shiftUnit,1);return l=this.ceilDate(l,!1,this.mainUnit,1),{start:s,end:l}}return this.autoAdjust||i?{start:this.floorDate(e,!1,this.autoAdjust?this.mainUnit:this.unit,1),end:this.ceilDate(t,!1,this.autoAdjust?this.mainUnit:this.unit,1)}:{start:e,end:t}},getTickFromDate:function(e){var t=this.data.items,i=t.length-1;if(e<t[0].data.start||e>t[i].data.end)return-1;var n,r,a;if(this.isContinuous()){if(e-t[0].data.start==0)return this.visibleTickStart;if(e-t[i].data.end==0)return this.visibleTickEnd;var s=this.adjustedStart,o=this.adjustedEnd,l=Math.floor(t.length*(e-s)/(o-s));return l>i&&(l=i),r=0===l?s:t[l].data.start,a=l==i?o:t[l].data.end,n=l+(e-r)/(a-r),n<this.visibleTickStart||n>this.visibleTickEnd?-1:n}for(var d=0;d<=i;d++)if(a=t[d].data.end,e<=a)return r=t[d].data.start,n=d+(e>r?(e-r)/(a-r):0);return-1},getDateFromTick:function(e,t){if(e===this.visibleTickEnd)return this.getEnd();var i=Math.floor(e),n=e-i,r=this.getAt(i);if(!r)return null;var a=r.data,s=0===i?this.adjustedStart:a.start,o=i==this.getCount()-1&&this.isContinuous()?this.adjustedEnd:a.end,l=Sch.util.Date.add(s,Sch.util.Date.MILLI,n*(o-s));return t&&(l=this[t+"Date"](l)),l},getTicks:function(){var e=[];return this.each(function(t){e.push(t.data)}),e},getStart:function(){var e=this.first();return e?new Date(e.data.start):null},getEnd:function(){var e=this.last();return e?new Date(e.data.end):null},floorDate:function(e,t,i,n){t=!1!==t;var r,a=Ext.Date.clone(e),s=t?this.getStart():null,o=n||this.resolutionIncrement;r=i||(t?this.resolutionUnit:this.mainUnit);var l=Sch.util.Date,d=function(e,t){return Math.floor(e/t)*t};switch(r){case l.MILLI:t&&(a=l.add(s,l.MILLI,d(l.getDurationInMilliseconds(s,a),o)));break;case l.SECOND:t?a=l.add(s,l.MILLI,1e3*d(l.getDurationInSeconds(s,a),o)):(a.setMilliseconds(0),a.setSeconds(d(a.getSeconds(),o)));break;case l.MINUTE:t?a=l.add(s,l.SECOND,60*d(l.getDurationInMinutes(s,a),o)):(a.setMinutes(d(a.getMinutes(),o)),a.setSeconds(0),a.setMilliseconds(0));break;case l.HOUR:t?a=l.add(s,l.MINUTE,60*d(l.getDurationInHours(this.getStart(),a),o)):(a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0),a.setHours(d(a.getHours(),o)));break;case l.DAY:t?a=l.add(s,l.DAY,d(l.getDurationInDays(s,a),o)):(Sch.util.Date.clearTime(a),a.setDate(d(a.getDate()-1,o)+1));break;case l.WEEK:var c=a.getDay()||7,h=this.weekStartDay||7;Sch.util.Date.clearTime(a),a=l.add(a,l.DAY,c>=h?h-c:-(7-h+c)),a.getDay()!==h&&23===a.getHours()&&(a=l.add(a,l.HOUR,1));break;case l.MONTH:t?a=l.add(s,l.MONTH,d(l.getDurationInMonths(s,a),o)):(Sch.util.Date.clearTime(a),a.setDate(1),a.setMonth(d(a.getMonth(),o)));break;case l.QUARTER:Sch.util.Date.clearTime(a),a.setDate(1),a=l.add(a,l.MONTH,-a.getMonth()%3);break;case l.YEAR:a=t?l.add(s,l.YEAR,d(l.getDurationInYears(s,a),o)):new Date(d(e.getFullYear()-1,o)+1,0,1)}return a},roundDate:function(e,t){var i=Ext.Date.clone(e),n=this.resolutionIncrement;switch(t=t||this.getStart(),this.resolutionUnit){case Sch.util.Date.MILLI:var r=Sch.util.Date.getDurationInMilliseconds(t,i),a=Math.round(r/n)*n;i=Sch.util.Date.add(t,Sch.util.Date.MILLI,a);break;case Sch.util.Date.SECOND:var s=Sch.util.Date.getDurationInSeconds(t,i),o=Math.round(s/n)*n;i=Sch.util.Date.add(t,Sch.util.Date.MILLI,1e3*o);break;case Sch.util.Date.MINUTE:var l=Sch.util.Date.getDurationInMinutes(t,i),d=Math.round(l/n)*n;i=Sch.util.Date.add(t,Sch.util.Date.SECOND,60*d);break;case Sch.util.Date.HOUR:var c=Sch.util.Date.getDurationInHours(t,i),h=Math.round(c/n)*n;i=Sch.util.Date.add(t,Sch.util.Date.MINUTE,60*h);break;case Sch.util.Date.DAY:var u=Sch.util.Date.getDurationInDays(t,i),g=Math.round(u/n)*n;i=Sch.util.Date.add(t,Sch.util.Date.DAY,g);break;case Sch.util.Date.WEEK:Sch.util.Date.clearTime(i);var f,p=i.getDay()-this.weekStartDay;p<0&&(p=7+p),f=1===Math.round(p/7)?7-p:-p,i=Sch.util.Date.add(i,Sch.util.Date.DAY,f);break;case Sch.util.Date.MONTH:var m=Sch.util.Date.getDurationInMonths(t,i)+i.getDate()/Ext.Date.getDaysInMonth(i),v=Math.round(m/n)*n;i=Sch.util.Date.add(t,Sch.util.Date.MONTH,v);break;case Sch.util.Date.QUARTER:Sch.util.Date.clearTime(i),i.setDate(1),i=Sch.util.Date.add(i,Sch.util.Date.MONTH,3-i.getMonth()%3);break;case Sch.util.Date.YEAR:var S=Sch.util.Date.getDurationInYears(t,i),y=Math.round(S/n)*n;i=Sch.util.Date.add(t,Sch.util.Date.YEAR,y)}return i},ceilDate:function(e,t,i){var n=Ext.Date.clone(e);t=!1!==t;var r,a=t?this.resolutionIncrement:1,s=!1;switch(r=i||(t?this.resolutionUnit:this.mainUnit)){case Sch.util.Date.HOUR:(n.getMinutes()>0||n.getSeconds()>0||n.getMilliseconds()>0)&&(s=!0);break;case Sch.util.Date.DAY:(n.getHours()>0||n.getMinutes()>0||n.getSeconds()>0||n.getMilliseconds()>0)&&(s=!0);break;case Sch.util.Date.WEEK:Sch.util.Date.clearTime(n),(n.getDay()!==this.weekStartDay||e.getTime()-n.getTime()>0)&&(s=!0);break;case Sch.util.Date.MONTH:Sch.util.Date.clearTime(n),(1!==n.getDate()||e.getTime()-n.getTime()>0)&&(s=!0);break;case Sch.util.Date.QUARTER:Sch.util.Date.clearTime(n),(n.getMonth()%3!=0||1!==n.getDate()||e.getTime()-n.getTime()>0)&&(s=!0);break;case Sch.util.Date.YEAR:Sch.util.Date.clearTime(n),(0!==n.getMonth()||1!==n.getDate()||e.getTime()-n.getTime()>0)&&(s=!0)}return s?this.getNext(n,r,a):n},getNext:function(e,t,i){return Sch.util.Date.getNext(e,t,i,this.weekStartDay)},getResolution:function(){return{unit:this.resolutionUnit,increment:this.resolutionIncrement}},setResolution:function(e,t){this.resolutionUnit=e,this.resolutionIncrement=t||1},shift:function(e,t){this.setTimeSpan(Sch.util.Date.add(this.getStart(),t,e),Sch.util.Date.add(this.getEnd(),t,e))},shiftNext:function(e){e=e||this.getShiftIncrement();var t=this.getShiftUnit();this.setTimeSpan(Sch.util.Date.add(this.getStart(),t,e),Sch.util.Date.add(this.getEnd(),t,e))},shiftPrevious:function(e){e=-(e||this.getShiftIncrement());var t=this.getShiftUnit();this.setTimeSpan(Sch.util.Date.add(this.getStart(),t,e),Sch.util.Date.add(this.getEnd(),t,e))},getShiftUnit:function(){return this.shiftUnit||this.mainUnit},getShiftIncrement:function(){return this.shiftIncrement||1},getUnit:function(){return this.unit},getIncrement:function(){return this.increment},getRowTicks:function(){if("plain"!==this.mode){var e=this.getStart(),t=Sch.util.Date.add(e,this.headerConfig.middle.splitUnit,1),i=this.findBy(function(e){return e.getStartDate().getTime()>=t.getTime()});return-1===i?this.getRange():this.getRange(0,i-1)}},dateInAxis:function(e){return Sch.util.Date.betweenLesser(e,this.getStart(),this.getEnd())},timeSpanInAxis:function(e,t){return this.isContinuous()?Sch.util.Date.intersectSpans(e,t,this.getStart(),this.getEnd()):e<this.getStart()&&t>this.getEnd()||this.getTickFromDate(e)!==this.getTickFromDate(t)},isRangeInAxis:function(e){var t=e.getStartDate(),i=e.getEndDate();return!(!t||!i)&&this.timeSpanInAxis(t,i)},forEachAuxInterval:function(e,t,i,n){n=n||this;var r,a=this.getEnd(),s=this.getStart(),o=0;if(s>a)throw"Invalid time axis configuration";for(;s<a;)r=Sch.util.Date.min(this.getNext(s,e,t||1),a),i.call(n,s,r,o),s=r,o++},consumeViewPreset:function(e){Ext.apply(this,{
unit:e.getBottomHeader().unit,increment:e.getBottomHeader().increment||1,resolutionUnit:e.timeResolution.unit,resolutionIncrement:e.timeResolution.increment,mainUnit:e.getMainHeader().unit,shiftUnit:e.shiftUnit,shiftIncrement:e.shiftIncrement||1,defaultSpan:e.defaultSpan||1,presetName:e.name,headerConfig:e.headerConfig})}}),Ext.define("Sch.eventlayout.Horizontal",{nbrOfBandsByResource:null,bandIndexToPxConvertFn:null,bandIndexToPxConvertScope:null,constructor:function(e){Ext.apply(this,e),this.nbrOfBandsByResource={}},clearCache:function(e){e?delete this.nbrOfBandsByResource[e.internalId]:this.nbrOfBandsByResource={}},getNumberOfBands:function(e,t){var i=this.nbrOfBandsByResource;if(i.hasOwnProperty(e.internalId))return i[e.internalId];var n=Ext.isFunction(t)?t():t,r=Ext.Array.map(n,function(e){return{start:e.getStartDate(),end:e.getEndDate(),event:e}});return this.applyLayout(r,e)},applyLayout:function(e,t){var i=e.slice(),n=this;return i.sort(function(e,t){return n.sortEvents(e.event,t.event)}),this.nbrOfBandsByResource[t.internalId]=this.layoutEventsInBands(i)},sortEvents:function(e,t){var i=e.getStartDate(),n=t.getStartDate();return i-n==0?e.getEndDate()>t.getEndDate()?-1:1:i<n?-1:1},layoutEventsInBands:function(e){var t=0;do{for(var i=e[0];i;)i.top=this.bandIndexToPxConvertFn.call(this.bandIndexToPxConvertScope||this,t,i.event),Ext.Array.remove(e,i),i=this.findClosestSuccessor(i,e);t++}while(e.length>0);return t},findClosestSuccessor:function(e,t){for(var i,n,r=1/0,a=e.end,s=e.end-e.start==0,o=0,l=t.length;o<l;o++)(n=t[o].start-a)>=0&&n<r&&(n>0||t[o].end-t[o].start>0||!s)&&(i=t[o],r=n);return i}}),Ext.define("Sch.eventlayout.Vertical",{view:null,constructor:function(e){Ext.apply(this,e)},applyLayout:function(e,t){if(0!==e.length){var i=this;e.sort(function(e,t){return i.sortEvents(e.event,t.event)});for(var n,r,a,s=this.view,o=(Sch.util.Date,t-2*s.barMargin),l=0,d=e.length;l<d;l++){r=e[l],r.start,r.end,n=this.findStartSlot(e,r);var c=this.getCluster(e,l);if(c.length>1){for(r.left=n.start,r.width=n.end-n.start,a=1;a<c.length-1&&c[a+1].start-r.start==0;)a++;var h=this.findStartSlot(e,c[a]);h&&h.start<.8&&(c=c.slice(0,a))}var u=c.length,g=(n.end-n.start)/u;for(a=0;a<u;a++)c[a].width=g,c[a].left=n.start+a*g;l+=u-1}for(l=0,d=e.length;l<d;l++)e[l].width=e[l].width*o,e[l].left=s.barMargin+e[l].left*o}},findStartSlot:function(e,t){var i,n=this.getPriorOverlappingEvents(e,t);if(0===n.length)return{start:0,end:1};for(i=0;i<n.length;i++){if(0===i&&n[0].left>0)return{start:0,end:n[0].left};if(n[i].left+n[i].width<(i<n.length-1?n[i+1].left:1))return{start:n[i].left+n[i].width,end:i<n.length-1?n[i+1].left:1}}return!1},getPriorOverlappingEvents:function(e,t){for(var i=Sch.util.Date,n=t.start,r=t.end,a=[],s=0,o=Ext.Array.indexOf(e,t);s<o;s++)i.intersectSpans(n,r,e[s].start,e[s].end)&&a.push(e[s]);return a.sort(this.sortOverlappers),a},sortOverlappers:function(e,t){return e.left<t.left?-1:1},getCluster:function(e,t){if(t>=e.length-1)return[e[t]];for(var i=[e[t]],n=e[t].start,r=e[t].end,a=e.length,s=Sch.util.Date,o=t+1;o<a&&s.intersectSpans(n,r,e[o].start,e[o].end);)i.push(e[o]),n=s.max(n,e[o].start),r=s.min(e[o].end,r),o++;return i},sortEvents:function(e,t){var i=e.getStartDate(),n=e.getEndDate(),r=t.getStartDate(),a=t.getEndDate();return i-r==0?n>a?-1:1:i<r?-1:1}}),Ext.define("Sch.feature.AbstractTimeSpan",{extend:Ext.AbstractPlugin,mixins:{observable:Ext.util.Observable},lockableScope:"top",schedulerView:null,timeAxis:null,containerEl:null,expandToFitView:!1,disabled:!1,cls:null,clsField:"Cls",template:null,store:null,renderElementsBuffered:!1,renderDelay:15,refreshSizeOnItemUpdate:!0,_resizeTimer:null,_renderTimer:null,showHeaderElements:!1,headerTemplate:null,innerHeaderTpl:null,headerContainerCls:"sch-header-secondary-canvas",headerContainerEl:null,renderingDoneEvent:null,constructor:function(e){this.uniqueCls=this.uniqueCls||"sch-timespangroup-"+Ext.id(),Ext.apply(this,e),this.mixins.observable.constructor.call(this),this.callParent(arguments)},setDisabled:function(e){e&&this.removeElements(),this.disabled=e},removeElements:function(){this.removeBodyElements(),this.showHeaderElements&&this.removeHeaderElements()},getBodyElements:function(){return this.containerEl?this.containerEl.select("."+this.uniqueCls):null},getHeaderContainerEl:function(){var e,t=this.headerContainerEl,i=Ext.baseCSSPrefix;return t&&t.dom||(e=this.schedulerView.isHorizontal()?this.panel.getHorizontalTimeAxisColumn().headerView.containerEl:this.panel.el.down("."+i+"grid-inner-locked ."+i+"panel-body ."+i+"grid-view"))&&(t=e.down("."+this.headerContainerCls),t||(t=e.appendChild({cls:this.headerContainerCls})),this.headerContainerEl=t),t},getHeaderElements:function(){var e=this.getHeaderContainerEl();return e?e.select("."+this.uniqueCls):null},removeBodyElements:function(){var e=this.getBodyElements();e&&e.each(function(e){e.destroy()})},removeHeaderElements:function(){var e=this.getHeaderElements();e&&e.each(function(e){e.destroy()})},getElementId:function(e){return this.uniqueCls+"-"+e.internalId},getHeaderElementId:function(e){return this.uniqueCls+"-header-"+e.internalId},getTemplateData:function(e){return this.prepareTemplateData?this.prepareTemplateData(e):e.data},getElementCls:function(e,t){var i=e.clsField||this.clsField;return t||(t=this.getTemplateData(e)),this.cls+" "+this.uniqueCls+" "+(t[i]||"")},getHeaderElementCls:function(e,t){var i=e.clsField||this.clsField;return t||(t=this.getTemplateData(e)),"sch-header-indicator "+this.uniqueCls+" "+(t[i]||"")},init:function(e){if(Ext.versions.touch&&!e.isReady())return void e.on("viewready",function(){this.init(e)},this);Ext.isString(this.innerHeaderTpl)&&(this.innerHeaderTpl=new Ext.XTemplate(this.innerHeaderTpl));var t=this.innerHeaderTpl;this.headerTemplate||(this.headerTemplate=new Ext.XTemplate('<tpl for=".">','<div id="{id}" class="{cls}" style="{side}:{position}px;">'+(t?"{[this.renderInner(values)]}":"")+"</div>","</tpl>",{renderInner:function(e){return t.apply(e)}})),this.schedulerView=e.getSchedulingView(),this.panel=e,this.timeAxis=e.getTimeAxis(),this.store=Ext.StoreManager.lookup(this.store),this.store||Ext.Error.raise("Error: You must define a store for this plugin"),this.schedulerView.getEl()?this.onAfterRender():this.schedulerView.on({afterrender:this.onAfterRender,scope:this})},onAfterRender:function(e){var t=this.schedulerView;this.containerEl=t.getSecondaryCanvasEl(),this.storeListeners={load:this.renderElements,datachanged:this.renderElements,clear:this.renderElements,add:this.renderElements,remove:this.renderElements,update:this.refreshSingle,addrecords:this.renderElements,removerecords:this.renderElements,updaterecord:this.refreshSingle,expand:this.renderElements,collapse:this.renderElements,scope:this},this.store.on(this.storeListeners),t.on({bufferedrefresh:this.renderElements,refresh:this.renderElements,itemadd:this.refreshSizeOnItemUpdate?this.refreshSizes:this.renderElements,itemremove:this.refreshSizeOnItemUpdate?this.refreshSizes:this.renderElements,itemupdate:this.refreshSizeOnItemUpdate?this.refreshSizes:this.renderElements,groupexpand:this.renderElements,groupcollapse:this.renderElements,columnwidthchange:this.renderElements,resize:this.renderElements,scope:this}),t.headerCt&&t.headerCt.on({add:this.renderElements,remove:this.renderElements,scope:this}),this.panel.on({viewchange:this.renderElements,show:this.refreshSizes,modechange:this.forceNewRenderingTimeout,scope:this});var i=t.getRowContainerEl();i&&i.down(".sch-timetd")&&this.renderElements()},forceNewRenderingTimeout:function(){this.renderElementsBuffered=!1,clearTimeout(this._renderTimer),clearTimeout(this._resizeTimer),this.renderElements()},refreshSizesInternal:function(){if(!this.schedulerView.isDestroyed&&this.schedulerView.isHorizontal()){var e=this.schedulerView.getTimeSpanRegion(new Date,null,this.expandToFitView);this.getBodyElements().setHeight(e.bottom-e.top)}},refreshSizes:function(){clearTimeout(this._resizeTimer),this._resizeTimer=Ext.Function.defer(this.refreshSizesInternal,this.renderDelay,this)},renderElements:function(){this.renderElementsBuffered||this.disabled||(this.renderElementsBuffered=!0,clearTimeout(this._renderTimer),this._renderTimer=Ext.Function.defer(this.renderElementsInternal,this.renderDelay,this))},setElementX:function(e,t){this.panel.rtl?e.setRight(t):e.setLeft(t)},getHeaderElementPosition:function(e){var t=this.schedulerView.getTimeAxisViewModel();return Math.round(t.getPositionFromDate(e))},renderBodyElementsInternal:function(e){Ext.DomHelper.append(this.containerEl,this.generateMarkup(!1,e))},getHeaderElementData:function(e,t){throw"Abstract method call"},renderHeaderElementsInternal:function(e){var t=this.getHeaderContainerEl();t&&Ext.DomHelper.append(t,this.generateHeaderMarkup(!1,e))},renderElementsInternal:function(){this.renderElementsBuffered=!1,this.disabled||this.schedulerView.isDestroyed||Ext.versions.extjs&&!this.schedulerView.el.down("."+Ext.baseCSSPrefix+"grid-item-container")||(this.removeElements(),this.renderBodyElementsInternal(),this.showHeaderElements&&(this.headerContainerEl=null,this.renderHeaderElementsInternal()),this.renderingDoneEvent&&this.fireEvent(this.renderingDoneEvent,this))},generateMarkup:function(e,t){var i=this.timeAxis.getStart(),n=this.timeAxis.getEnd(),r=this.getElementData(i,n,t,e);return this.template.apply(r)},generateHeaderMarkup:function(e,t){var i=this.getHeaderElementData(t,e);return this.headerTemplate.apply(i)},getElementData:function(e,t,i,n){throw"Abstract method call"},updateBodyElement:function(e){var t=Ext.get(this.getElementId(e));if(t){var i=this.timeAxis.getStart(),n=this.timeAxis.getEnd(),r=this.getElementData(i,n,[e])[0];r?(t.dom.className=r.$cls,t.setTop(r.top),this.setElementX(t,r.left),t.setSize(r.width,r.height)):Ext.destroy(t)}else this.renderBodyElementsInternal([e])},updateHeaderElement:function(e){var t=Ext.get(this.getHeaderElementId(e));if(t){var i=this.getHeaderElementData([e])[0];i?(t.dom.className=i.cls,this.schedulerView.isHorizontal()?(this.setElementX(t,i.position),t.setWidth(i.size)):(t.setTop(i.position),t.setHeight(i.size))):Ext.destroy(t)}else this.renderHeaderElementsInternal([e])},destroy:function(){clearTimeout(this._renderTimer),clearTimeout(this._resizeTimer),this.store.autoDestroy&&this.store.destroy(),this.store.un(this.storeListeners)},refreshSingle:function(e,t){t=t instanceof Array?t:[t],Ext.Array.forEach(t,function(e){this.updateBodyElement(e),this.showHeaderElements&&this.updateHeaderElement(e)},this)}}),Ext.define("Sch.plugin.Lines",{extend:Sch.feature.AbstractTimeSpan,alias:"plugin.scheduler_lines",cls:"sch-timeline",showTip:!0,innerTpl:null,prepareTemplateData:null,side:null,init:function(e){Ext.isString(this.innerTpl)&&(this.innerTpl=new Ext.XTemplate(this.innerTpl)),this.side=e.rtl?"right":"left";var t=this.innerTpl;this.template||(this.template=new Ext.XTemplate('<tpl for=".">','<div id="{id}" '+(this.showTip?'title="{[this.getTipText(values)]}" ':"")+'class="{$cls}" style="'+this.side+':{left}px;top:{top}px;height:{height}px;width:{width}px">'+(t?"{[this.renderInner(values)]}":"")+"</div>","</tpl>",{getTipText:function(t){return e.getSchedulingView().getFormattedDate(t.Date)+" "+(t.Text||"")},renderInner:function(e){return t.apply(e)}})),this.callParent(arguments)},generateMarkup:function(e,t){return"calendar"===this.schedulerView.getMode()?"":this.callParent(arguments)},generateHeaderMarkup:function(e,t){return"calendar"===this.schedulerView.getMode()?"":this.callParent(arguments)},getElementData:function(e,t,i){var n,r,a,s,o,l=this.store,d=this.schedulerView,c=d.isHorizontal(),h=i||l.getRange(),u=[],g=d.getTimeSpanRegion(e,null,this.expandToFitView);n=Ext.versions.touch?"100%":c?g.bottom-g.top:1,r=c?1:g.right-g.left;for(var f=0,p=h.length;f<p;f++)if(a=h[f],(s=a.get("Date"))&&Sch.util.Date.betweenLesser(s,e,t)){var m=d.getCoordinateFromDate(s);o=Ext.apply({},this.getTemplateData(a)),o.id=this.getElementId(a),o.$cls=this.getElementCls(a,o),o.width=r,o.height=n,c?o.left=m:o.top=m,u.push(o)}return u},getHeaderElementData:function(e){var t,i,n,r,a=this.timeAxis.getStart(),s=this.timeAxis.getEnd(),o=this.schedulerView.isHorizontal(),l=[];e=e||this.store.getRange();for(var d=0,c=e.length;d<c;d++)t=e[d],(i=t.get("Date"))&&Sch.util.Date.betweenLesser(i,a,s)&&(n=this.getHeaderElementPosition(i),r=this.getTemplateData(t),r=Ext.apply({side:o?this.side:"top",cls:this.getHeaderElementCls(t,r),position:n},r),r.id=this.getHeaderElementId(t),l.push(r));return l}}),Ext.define("Sch.feature.ColumnLines",{extend:Sch.plugin.Lines,cls:"sch-column-line",showTip:!1,timeAxisViewModel:null,renderingDoneEvent:"columnlinessynced",useLowestHeader:null,init:function(e){this.timeAxis=e.getTimeAxis(),this.timeAxisViewModel=e.timeAxisViewModel,this.panel=e,this.store=new Ext.data.JsonStore({fields:["Date"]}),this.callParent(arguments),e.on({modechange:this.populate,destroy:this.onHostDestroy,scope:this}),this.timeAxisViewModel.on("update",this.populate,this),this.populate()},onHostDestroy:function(){this.timeAxisViewModel.un("update",this.populate,this)},populate:function(){this.store.setData(this.getData())},getElementData:function(){var e=this.schedulerView;return e.isHorizontal()&&e.store.getCount()>0?this.callParent(arguments):[]},getData:function(){var e=this.panel,t=[];if(e.isHorizontal()){var i=this.timeAxisViewModel,n=this.useLowestHeader?i.getLowestHeader():i.columnLinesFor;if(!(!i.headerConfig||!i.headerConfig[n].cellGenerator))for(var r=i.getColumnConfig()[n],a=1,s=r.length;a<s;a++)t.push({Date:r[a].start});else{var o,l,d,c=i.getColumnConfig();if("bottom"===n?o="middle":"middle"===n&&(o="top"),l=c[o]){var h=i.headerConfig;h[o].increment===h[n].increment&&h[o].unit===h[n].unit||(d={},Ext.Array.forEach(l,function(e){d[e.start.getTime()]=1}))}i.forEachInterval(n,function(e,i,n){n>0&&t.push({Date:e,Cls:d&&d[e.getTime()]?"sch-column-line-solid":""})})}}return t}}),Ext.define("Sch.util.ScrollManager",{singleton:!0,vthresh:25,hthresh:25,increment:100,frequency:500,animate:!0,animDuration:200,activeCmp:null,activeEl:null,targetScroller:null,scrollElRegion:null,scrollProcess:{},pt:null,scrollWidth:null,scrollHeight:null,direction:"both",constructor:function(){this.doScroll=Ext.Function.bind(this.doScroll,this)},triggerRefresh:function(){this.activeEl&&(this.refreshElRegion(),this.clearScrollInterval(),this.onMouseMove())},doScroll:function(){var e=this.scrollProcess,t=e.cmp,i=t.rtl,n=e.dir[0],r=this.increment,a=this.activeCmp.getScrollX(),s=this.activeCmp.getScrollY();"r"===n?r=Math.min(r,i?a:this.scrollWidth-a-this.activeEl.dom.clientWidth):"d"===n&&(r=Math.min(r,this.scrollHeight-s-this.activeEl.dom.clientHeight)),r=Math.max(r,0);var o=0,l=0;"r"===n&&(o=r),"l"===n&&(o=-r),"u"===n&&(l=-r),"d"===n&&(l=r),i&&(o=-o),t.scrollBy(o,l,{duration:this.animDuration,callback:this.triggerRefresh,scope:this})},clearScrollInterval:function(){var e=this.scrollProcess;e.id&&clearTimeout(e.id),e.id=0,e.cmp=null,e.dir=""},isScrollAllowed:function(e){switch(this.direction){case"both":return!0;case"horizontal":return"right"===e||"left"===e;case"vertical":return"up"===e||"down"===e;default:throw"Invalid direction: "+this.direction}},startScrollInterval:function(e,t){this.isScrollAllowed(t)&&(this.clearScrollInterval(),this.scrollProcess.cmp=e,this.scrollProcess.dir=t,this.scrollProcess.id=setTimeout(this.doScroll,this.frequency))},onMouseMove:function(e){var t=e?e.getPoint():this.pt,i=t.x,n=t.y,r=this.scrollProcess,a=this.activeCmp,s=a.getScrollX(),o=a.getScrollY(),l=a.rtl,d=this.activeEl,c=this.scrollElRegion,h=d.dom,u=this;if(this.pt=t,c&&c.contains(t)&&d.isScrollable()){if(c.bottom-n<=u.vthresh&&this.scrollHeight-o-h.clientHeight>0)return void(r.cmp!=a&&this.startScrollInterval(a,"down"));if(c.right-i<=u.hthresh&&(l?s>0:this.scrollWidth-s-h.clientWidth>0))return void(r.cmp!=a&&this.startScrollInterval(a,"right"));if(n-c.top<=u.vthresh&&o>0)return void(r.cmp!=a&&this.startScrollInterval(a,"up"));if(i-c.left<=u.hthresh&&(l?h.clientWidth+s<this.scrollWidth:s>0))return void(r.cmp!=a&&this.startScrollInterval(a,"left"))}this.clearScrollInterval()},refreshElRegion:function(){this.scrollElRegion=this.activeEl.getRegion()},activate:function(e,t){this.direction=t||"both",this.activeCmp=e,this.activeEl=e.getEl(),e.scrollManager?(this.targetScroller=e.scrollManager.scroller,this.scrollWidth=this.targetScroller.getMaxPosition().x,this.scrollHeight=this.targetScroller.getMaxPosition().y):(this.scrollWidth=this.activeEl.dom.scrollWidth,this.scrollHeight=this.activeEl.dom.scrollHeight),this.refreshElRegion(),this.activeEl.on("mousemove",this.onMouseMove,this)},deactivate:function(){this.clearScrollInterval(),this.activeEl.un("mousemove",this.onMouseMove,this),this.targetScroller=this.activeEl=this.activeCmp=this.scrollElRegion=this.scrollWidth=this.scrollHeight=null,this.direction="both"}}),Ext.define("Sch.util.DragTracker",{extend:Ext.dd.DragTracker,xStep:1,yStep:1,deferredActivation:0,constructor:function(){this.callParent(arguments),this.on("dragstart",function(){var e=this.el,t={scroll:this.onMouseMove,pinchstart:this.onMouseUp,scope:this};e.on(t),this.on("dragend",function(){e.un(t)},this,{single:!0})}),this.moveListener={pinchstart:this.abortWait,touchend:this.abortWait,mouseup:this.abortWait,mousemove:this.onMoveWhileWaiting,scope:this,capture:!0}},setXStep:function(e){this.xStep=e},startScroll:null,deferTimer:null,deferTolerance:10,moveListener:null,setYStep:function(e){this.yStep=e},onMoveWhileWaiting:function(e,t){var i=e.getXY(),n=this.startXY;Math.max(Math.abs(n[0]-i[0]),Math.abs(n[1]-i[1]))>this.deferTolerance&&(this.abortWait(),this.onMouseUp(e))},abortWait:function(){clearTimeout(this.deferTimer),this.deferTimer=null,Ext.getDoc().un(this.moveListener)},getRegion:function(){var e=this.startXY,t=this.el.getScroll();Ext.isIE&&this.rtl&&(t.left=this.el.dom.scrollWidth-this.el.getWidth()-t.left);var i=this.getXY(),n=i[0],r=i[1],a=t.left-this.startScroll.left,s=t.top-this.startScroll.top,o=e[0]-a,l=e[1]-s,d=Math.min(o,n),c=Math.min(l,r),h=Math.abs(o-n),u=Math.abs(l-r);return new Ext.util.Region(c,d+h,c+u,d)},onMouseDown:function(e,t){if(!(e.event.touches&&e.event.touches.length>1)){if(e.stopPropagation=Ext.emptyFn,this.startXY=e.getXY(),this.deferredActivation){var i=this;return Ext.getDoc().on(this.moveListener),void(this.deferTimer=setTimeout(function(){var n=i.deferredActivation;Ext.getDoc().un(i.moveListener),i.deferredActivation=!1,i.onMouseDown(e,t),i.deferredActivation=n},this.deferredActivation))}this.callParent([e,t]),this.lastXY=this.startXY,this.startScroll=this.el.getScroll(),Ext.isIE&&this.rtl&&(this.startScroll.left=this.el.dom.scrollWidth-this.el.getWidth()-this.startScroll.left)}},onMouseMove:function(e,t){if(this.active&&"mousemove"===e.type&&Ext.isIE9m&&!e.browserEvent.button)return e.preventDefault(),void this.onMouseUp(e);e.preventDefault();var i="scroll"===e.type?this.lastXY:e.getXY(),n=this.startXY;if(!this.active){if(!(Math.max(Math.abs(n[0]-i[0]),Math.abs(n[1]-i[1]))>this.tolerance))return;this.triggerStart(e)}var r=i[0],a=i[1];this.xStep>1&&(r-=this.startXY[0],r=Math.round(r/this.xStep)*this.xStep,r+=this.startXY[0]),this.yStep>1&&(a-=this.startXY[1],a=Math.round(a/this.yStep)*this.yStep,a+=this.startXY[1]),(this.xStep>1||this.yStep>1)&&r===i[0]&&a===i[1]||(this.lastXY=[r,a],!1===this.fireEvent("mousemove",this,e)?this.onMouseUp(e):(this.onDrag(e),this.fireEvent("drag",this,e)))}}),Ext.define("Sch.tooltip.ClockTemplate",{extend:Ext.XTemplate,minuteHeight:8,minuteTop:2,hourHeight:8,hourTop:2,handLeft:10,getRotateStyle:function(e){return"transform:rotate(Ddeg);-ms-transform:rotate(Ddeg);-moz-transform: rotate(Ddeg);-webkit-transform: rotate(Ddeg);-o-transform:rotate(Ddeg);".replace(/D/g,e)},getRotateStyleIE:function(){var e=Math.PI/180,t=Math.cos,i=Math.sin;return function(n,r,a){var s=this,o=n*e,l=t(o),d=i(o),c=a*i((90-n)*e),h=a*t((90-n)*e),u=Math.min(a,a-c),g=n>180?h:0,f="progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11 = "+l+", M12 = "+-d+", M21 = "+d+", M22 = "+l+")";return Ext.String.format("filter:{0};-ms-filter:{0};top:{1}px;left:{2}px;",f,u+r,g+s.handLeft)}}(),constructor:function(){var e=Ext.isIE&&Ext.isIE8m;this.callParent(['<div class="sch-clockwrap '+(e?"":"sch-supports-border-radius")+' {cls}"><div class="sch-clock"><div class="sch-hourIndicator" style="{[this.getHourStyle((values.date.getHours() % 12) * 30,'+this.hourTop+", + "+this.hourHeight+')]}">{[Ext.Date.monthNames[values.date.getMonth()].substr(0,3)]}</div><div class="sch-minuteIndicator" style="{[this.getMinuteStyle(values.date.getMinutes() * 6,'+this.minuteTop+", + "+this.minuteHeight+')]}">{[values.date.getDate()]}</div>'+(e?"":'<div class="sch-clock-dot"></div>')+'</div><span class="sch-clock-text">{text}</span></div>',{disableFormats:!0,getMinuteStyle:e?this.getRotateStyleIE:this.getRotateStyle,getHourStyle:e?this.getRotateStyleIE:this.getRotateStyle}])}}),Ext.define("Sch.tooltip.Tooltip",{extend:Ext.tip.ToolTip,autoHide:!1,anchor:"b",padding:"0 3 0 0",showDelay:0,hideDelay:0,quickShowInterval:0,dismissDelay:0,trackMouse:!1,anchorOffset:5,shadow:!1,frame:!1,schedulerView:null,message:null,startDate:null,endDate:null,template:null,valid:!0,mode:null,offsetAdjust:[18,5],constructor:function(e){var t=new Sch.tooltip.ClockTemplate;this.startDate=this.endDate=new Date,this.template||(this.template=Ext.create("Ext.XTemplate",'<div class="sch-tip-{[values.valid ? "ok" : "notok"]}">{[this.renderClock(values.startDate, values.startText, "sch-tooltip-startdate")]}{[this.renderClock(values.endDate, values.endText, "sch-tooltip-enddate")]}<div class="sch-tip-message">{message}</div></div>',{disableFormats:!0,renderClock:function(e,i,n){return t.apply({date:e,text:i,cls:n})}})),this.callParent(arguments)},update:function(e,t,i,n){if(this.startDate-e!=0||this.endDate-t!=0||this.valid!==i||this.message!==n){var r=this.message&&!n||!this.message&&n;this.startDate=e,this.endDate=t,this.valid=i,this.message=n;var a=this.schedulerView.getFormattedDate(e),s=this.schedulerView.getFormattedEndDate(t,e);"calendar"!==this.mode||0!==t.getHours()||0!==t.getMinutes()||t.getYear()===e.getYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()||(t=Sch.util.Date.add(t,Sch.util.Date.DAY,-1)),this.callParent([this.template.apply({valid:i,startDate:e,endDate:t,startText:a,endText:s,message:n})]),r&&this.realign()}},show:function(e,t){e&&!Ext.isArray(e)&&(!0===this.rendered&&this.setPosition(0,0),Sch.util.Date.compareUnits(this.schedulerView.getTimeResolution().unit,Sch.util.Date.DAY)>=0?(this.mode="calendar",this.addCls("sch-day-resolution"),this.removeCls("sch-hour-resolution")):(this.mode="clock",this.removeCls("sch-day-resolution"),this.addCls("sch-hour-resolution")),t=arguments.length>1?t:this.offsetAdjust[0],this.mouseOffsets=[t-this.offsetAdjust[0],-this.offsetAdjust[1]],this.setTarget(e),this.callParent(),this.realign())},realign:function(){this.el.alignTo(this.target,"bl-tl",this.mouseOffsets)},afterRender:function(){this.callParent(arguments),this.el.on("mouseenter",this.realign,this)}}),Ext.define("Sch.tooltip.HoverTip",{extend:Ext.tip.ToolTip,alias:"widget.scheduler_hovertip",trackMouse:!0,bodyCls:"sch-hovertip",messageTpl:'<div class="sch-hovertip-msg">{message}</div>',autoHide:!1,dismissDelay:1e3,showDelay:300,schedulerView:null,clockTpl:null,lastTime:null,lastResource:null,initComponent:function(){var e=this,t=e.schedulerView;e.clockTpl=new Sch.tooltip.ClockTemplate,e.messageTpl=new Ext.XTemplate(e.messageTpl),e.lastTime=null,e.lastResource=null,e.callParent(arguments),e.on("beforeshow",e.tipOnBeforeShow,e),t.mon(t.el,{mouseleave:function(){e.hide()},mousemove:e.handleMouseMove,scope:e})},handleMouseMove:function(e){var t=this,i=t.schedulerView;if(!t.disabled)if(e.getTarget("."+i.timeCellCls,5)&&!e.getTarget(i.eventSelector)){var n=i.getDateFromDomEvent(e,"floor");if(n){var r=i.resolveResource(e.getTarget());n-t.lastTime==0&&r===t.lastResource||(t.lastResource=r,t.updateHoverTip(n,e),t.hidden&&(Sch.util.Date.compareUnits(this.schedulerView.getTimeResolution().unit,Sch.util.Date.DAY)>=0?(t.addCls("sch-day-resolution"),t.removeCls("sch-hour-resolution")):(t.removeCls("sch-day-resolution"),t.addCls("sch-hour-resolution")),t.show()))}else t.hide(),t.lastTime=null,t.lastResource=null}else t.hide(),t.lastTime=null,t.lastResource=null},getText:function(){},updateHoverTip:function(e,t){if(e){var i=this.clockTpl.apply({date:e,text:this.schedulerView.getFormattedDate(e)}),n=this.messageTpl.apply({message:this.getText(e,t)});this.update(i+n),this.lastTime=e}},tipOnBeforeShow:function(e){return!this.disabled&&null!==this.lastTime}}),Ext.define("Sch.feature.DragCreator",{disabled:!1,showHoverTip:!0,showDragTip:!0,dragTip:null,dragTolerance:2,hoverTip:null,validatorFn:Ext.emptyFn,validatorFnScope:null,trackerConfig:null,schedulerView:null,template:'<div class="sch-dragcreator-proxy"><div class="sch-event-inner">&#160;</div></div>',constructor:function(e){Ext.apply(this,e||{}),this.lastTime=new Date,this.template instanceof Ext.Template||(this.template=new Ext.Template(this.template)),this.schedulerView.on("destroy",this.onSchedulerDestroy,this),Ext.supports.Touch?this.schedulerView.on("boxready",this.initDragTracker,this):this.schedulerView.el.on("mousemove",this.initDragTracker,this,{single:!0}),this.callParent([e])},setDisabled:function(e){this.disabled=e,this.hoverTip&&this.hoverTip.setDisabled(e),this.dragTip&&this.dragTip.setDisabled(e)},getProxy:function(){if(!this.proxy){this.proxy=this.template.append(this.schedulerView.getSecondaryCanvasEl(),{},!0);var e=this.schedulerView.rtl;this.proxy.hide=function(){e?this.setStyle({right:"-10000px",top:"-10000px"}):this.setStyle({left:"-10000px",top:"-10000px"})}}return this.proxy},onBeforeDragStart:function(e,t){var i=this.schedulerView,n=t.getTarget("."+i.timeCellCls,5);if(n&&this.isCreateAllowed(t)&&(!t.event.touches||1===t.event.touches.length)){var r=i.resolveResource(n),a=i.getDateFromDomEvent(t);if(!this.disabled&&n&&!1!==i.fireEvent("beforedragcreate",i,r,a,t))return this.resourceRecord=r,this.originalStart=a,this.resourceRegion=i.getScheduleRegion(this.resourceRecord,this.originalStart),this.dateConstraints=i.getDateConstraints(this.resourceRecord,this.originalStart),!0}return!1},isCreateAllowed:function(e){return!e.getTarget(this.schedulerView.eventSelector)},onDragStart:function(){var e=this,t=e.schedulerView,i=e.tracker.getRegion(),n=e.getProxy();this.dragging=!0,this.hoverTip&&this.hoverTip.disable(),e.start=e.originalStart,e.end=e.start,e.originalScroll=t.getScroll(),"horizontal"===t.getMode()?e.rowBoundaries={top:e.resourceRegion.top,bottom:e.resourceRegion.bottom}:e.rowBoundaries={left:e.resourceRegion.left,right:e.resourceRegion.right},Ext.apply(i,e.rowBoundaries),t.rtl&&n.setStyle({right:"auto"}),n.setBox(i),n.show(),t.fireEvent("dragcreatestart",t,n),e.showDragTip&&(e.dragTip.enable(),e.dragTip.update(e.start,e.end,!0),e.dragTip.show(n),e.dragTip.setStyle("visibility","visible")),Sch.util.ScrollManager.activate(t,"horizontal"===t.getMode()?"horizontal":"vertical")},onDrag:function(e,t){var i=this,n=i.schedulerView,r=i.tracker.getRegion(),a=n.getStartEndDatesFromRegion(r,"round"),s="";if(a){i.start=a.start||i.start,i.end=a.end||i.end;var o=i.dateConstraints;o&&(i.end=Sch.util.Date.constrain(i.end,o.start,o.end),i.start=Sch.util.Date.constrain(i.start,o.start,o.end)),i.valid=this.validatorFn.call(i.validatorFnScope||i,i.resourceRecord,i.start,i.end),i.valid&&"boolean"!=typeof i.valid&&(s=i.valid.message,i.valid=i.valid.valid),i.valid=!1!==i.valid,i.showDragTip&&i.dragTip.update(i.start,i.end,i.valid,s),Ext.apply(r,i.rowBoundaries);var l=n.getScroll(),d=this.getProxy();d.setBox(r),n.isHorizontal()&&d.setY(i.resourceRegion.top+i.originalScroll.top-l.top)}},eventSwallower:function(e){e.stopPropagation(),e.preventDefault()},onDragEnd:function(e,t){var i=this,n=i.schedulerView,r=!0,a=t.getTarget(),s=Ext.get(a);s.on("click",this.eventSwallower),setTimeout(function(){s.un("click",i.eventSwallower)},100),i.dragging=!1,i.showDragTip&&i.dragTip.disable(),(!i.start||!i.end||i.end-i.start<=0)&&(i.valid=!1),i.createContext={start:i.start,end:i.end,resourceRecord:i.resourceRecord,e:t,finalize:function(){i.finalize.apply(i,arguments)}},i.valid&&(r=!1!==n.fireEvent("beforedragcreatefinalize",i,i.createContext,t,this.getProxy())),r&&i.finalize(i.valid),Sch.util.ScrollManager.deactivate()},finalize:function(e){var t=this.createContext,i=this.schedulerView;if(e){var n=Ext.create(i.eventStore.model);n.setCalendar&&n.setCalendar(i.eventStore.getCalendar()),n.setStartEndDate(t.start,t.end),n.setCalendar&&n.setCalendar(null),i.fireEvent("dragcreateend",i,n,t.resourceRecord,t.e,this.getProxy())}else this.proxy.hide();this.schedulerView.fireEvent("afterdragcreate",i,this.getProxy()),this.hoverTip&&this.hoverTip.enable()},dragging:!1,initDragTracker:function(){var e=this,t=Ext.supports.Touch,i=e.schedulerView,n=Ext.apply({el:i.el,rtl:i.rtl,deferredActivation:!!t&&1e3,tolerance:e.dragTolerance,listeners:{mousedown:e.verifyLeftButtonPressed,beforedragstart:e.onBeforeDragStart,dragstart:e.onDragStart,drag:e.onDrag,dragend:e.onDragEnd,scope:e}},this.trackerConfig);t?(this.showDragTip=!1,this.showHoverTip=!1,this.dragTip=null,this.hoverTip=null):this.setupTooltips(),e.tracker=new Sch.util.DragTracker(n)},setupTooltips:function(){var e=this,t=e.schedulerView;if(this.showDragTip){var i=this.dragTip;i instanceof Ext.tip.ToolTip?(Ext.applyIf(i,{schedulerView:t}),i.on("beforeshow",function(){return e.dragging})):this.dragTip=new Sch.tooltip.Tooltip(Ext.apply({cls:"sch-dragcreate-tip",schedulerView:t,listeners:{beforeshow:function(){return e.dragging}}},i))}if(e.showHoverTip){var n=e.hoverTip;n instanceof Ext.tip.ToolTip?Ext.applyIf(n,{schedulerView:t}):e.hoverTip=Ext.ComponentManager.create(Ext.applyIf({renderTo:Ext.getBody(),target:t.el,schedulerView:t},n),"scheduler_hovertip")}},verifyLeftButtonPressed:function(e,t){return 0===t.button},onSchedulerDestroy:function(){this.hoverTip&&this.hoverTip.destroy(),this.dragTip&&this.dragTip.destroy(),this.tracker&&this.tracker.destroy(),this.proxy&&(Ext.destroy(this.proxy),this.proxy=null)}}),Ext.define("Sch.feature.SchedulerDragZone",{extend:Ext.dd.DragZone,repairHighlight:!1,repairHighlightColor:"transparent",containerScroll:!1,showTooltip:!0,tip:null,tipIsProcessed:!1,deltaSetXY:null,schedulerView:null,lastXY:null,showExactDropPosition:!1,enableCopy:!1,enableCopyKey:"SHIFT",validatorFn:function(e,t,i,n,r){return!0},validatorFnScope:null,copyKeyPressed:!1,constructor:function(e,t){Ext.isIE8m&&window.top!==window&&(Ext.dd.DragDropManager.notifyOccluded=!0);var i=this.proxy=this.proxy||new Ext.dd.StatusProxy({shadow:!1,dropAllowed:this.dropAllowed,dropNotAllowed:this.dropNotAllowed,ensureAttachedToBody:Ext.emptyFn});this.callParent(arguments),this.isTarget=!0,this.scroll=!1,this.ignoreSelf=!1;var n=this.schedulerView;n.touchScroll&&(this.showTooltip=!1),n.el.appendChild(i.el),i.addCls("sch-dragproxy"),n.on({eventdragstart:function(){Sch.util.ScrollManager.activate(n,n.constrainDragToResource&&n.getMode())},aftereventdrop:function(){Sch.util.ScrollManager.deactivate()},scope:this})},destroy:function(){this.callParent(arguments),Ext.destroyMembers(this,"tip")},autoOffset:function(e,t){this.setDelta(0,0)},setupConstraints:function(e,t,i,n,r,a,s){this.clearTicks();var o=r&&!this.showExactDropPosition&&a>1?a:0,l=!r&&!this.showExactDropPosition&&a>1?a:0;this.resetConstraints(),this.initPageX=e.left+i,this.initPageY=e.top+n;var d=t.right-t.left,c=t.bottom-t.top;r?(s?this.setXConstraint(e.left+i,e.right-d+i,o):this.setXConstraint(e.left,e.right,o),this.setYConstraint(e.top+n,e.bottom-c+n,l)):(this.setXConstraint(e.left+i,e.right-d+i,o),s?this.setYConstraint(e.top+n,e.bottom-c+n,l):this.setYConstraint(e.top,e.bottom,l))},setXConstraint:function(e,t,i){this.leftConstraint=e,this.rightConstraint=t,this.minX=e,this.maxX=t,
i&&this.setXTicks(this.initPageX,i),this.constrainX=!0},setYConstraint:function(e,t,i){this.topConstraint=e,this.bottomConstraint=t,this.minY=e,this.maxY=t,i&&this.setYTicks(this.initPageY,i),this.constrainY=!0},onDragEnter:Ext.emptyFn,onDragOut:Ext.emptyFn,setVisibilityForSourceEvents:function(e){Ext.each(this.dragData.getEventBarElements(),function(t){t[e?"show":"hide"]()})},onDragOver:function(e){if(e.event.touches&&e.event.touches.length>1)return void Ext.dd.DragDropManager.handleMouseUp(e);var t="scroll"===e.type?this.lastXY:e.getXY();this.checkShiftChange();var i=this.dragData;i.originalHidden||(this.setVisibilityForSourceEvents(!1),i.originalHidden=!0);var n=i.startDate,r=i.newResource,a=this.schedulerView;if(this.updateDragContext(e),this.showExactDropPosition){var s=a.isHorizontal(),o=a.getDateFromCoordinate(s?t[0]:t[1])-i.sourceDate,l=new Date(i.origStart-0+o),d=a.timeAxisViewModel.getDistanceBetweenDates(l,i.startDate);if(i.startDate>a.timeAxis.getStart()){var c=this.proxy.el;d&&(a.isHorizontal()?c.setX(t[0]+(this.schedulerView.rtl?-d:d)):c.setY(t[1]+d))}}i.startDate-n==0&&r===i.newResource||this.schedulerView.fireEvent("eventdrag",this.schedulerView,i.draggedRecords,i.startDate,i.newResource,i),this.showTooltip&&(this.tip.realign(),this.tip.update(i.startDate,i.endDate,i.valid,i.message)),"scroll"!==e.type&&(this.lastXY=e.getXY())},getCoordinate:function(e){switch(this.schedulerView.getMode()){case"horizontal":return e[0];case"vertical":return e[1];case"calendar":return e}},getDragData:function(e){var t=this.schedulerView,i=e.getTarget(t.eventSelector);if(i&&!(e.event.touches&&e.event.touches.length>1)){var n=t.resolveEventRecord(i),r=t.resolveResource(i),a=t.resolveAssignmentRecord(i);if(!n||!1===n.isDraggable()||!1===t.fireEvent("beforeeventdrag",t,n,e))return null;var s=e.getXY(),o=Ext.get(i),l=o.getXY(),d=[s[0]-l[0],s[1]-l[1]],c=o.getRegion(),h="horizontal"==t.getMode();t.constrainDragToResource&&!r&&Ext.Error.raise("Resource could not be resolved for event: "+n.getId());var u=t.getDateConstraints(t.constrainDragToResource?r:null,n);this.setupConstraints(t.getScheduleRegion(t.constrainDragToResource?r:null,n),c,d[0],d[1],h,t.getSnapPixelAmount(),Boolean(u));var g=n.getStartDate(),f=n.getEndDate(),p=t.timeAxis,m=this.getRelatedRecords(a||n)||[],v=t.getElementsFromEventRecord(n,"calendar"===t.getMode()?null:r);Ext.Array.forEach(m,function(e){v=e instanceof Sch.model.Assignment?v.concat(t.getElementsFromEventRecord(e.getEvent(),e.getResource())):v.concat(t.getElementsFromEventRecord(e))}),v=Ext.Array.unique(v);var S={offsets:d,repairXY:l,prevScroll:t.getScroll(),dateConstraints:u,eventBarEls:v,getEventBarElements:function(){return S.eventBarEls=Ext.Array.map(S.eventBarEls,function(e){return e.dom&&e||Ext.get(e.id)})},draggedRecords:[a||n].concat(m),resourceRecord:r,sourceDate:t.getDateFromCoordinate(this.getCoordinate(s)),origStart:g,origEnd:f,startDate:g,endDate:f,timeDiff:0,startsOutsideView:g<p.getStart(),endsOutsideView:f>p.getEnd(),duration:f-g,bodyScroll:Ext.getBody().getScroll(),eventObj:e};return S.ddel=this.getDragElement(o,S),S}},onStartDrag:function(e,t){var i=this.schedulerView,n=this.dragData;Ext.Array.forEach(n.getEventBarElements(),function(e){e.removeCls("sch-event-hover")}),i.fireEvent("eventdragstart",i,n.draggedRecords),i.el.on("scroll",this.onViewElScroll,this)},alignElWithMouse:function(e,t,i){this.callParent(arguments);var n=this.getTargetCoord(t,i),r=e.dom?e:Ext.fly(e,"_dd");this.setLocalXY(r,n.x+this.deltaSetXY[0],n.y+this.deltaSetXY[1])},onViewElScroll:function(e,t){var i=this.proxy,n=this.schedulerView,r=this.dragData;this.setVisibilityForSourceEvents(!1);var a,s=i.getXY(),o=n.getScroll();a=n.rtl?[s[0]-o.left+r.prevScroll.left,s[1]+o.top-r.prevScroll.top]:[s[0]+o.left-r.prevScroll.left,s[1]+o.top-r.prevScroll.top];var l=this.deltaSetXY;n.rtl?this.deltaSetXY=[l[0]-o.left+r.prevScroll.left,l[1]+o.top-r.prevScroll.top]:this.deltaSetXY=[l[0]+o.left-r.prevScroll.left,l[1]+o.top-r.prevScroll.top],r.prevScroll=o,i.setXY(a),this.onDragOver(e)},getCopyKeyPressed:function(){return Boolean(this.enableCopy&&this.dragData.eventObj[this.enableCopyKey.toLowerCase()+"Key"])},checkShiftChange:function(){var e=this.getCopyKeyPressed(),t=this.dragData;e!==this.copyKeyPressed&&(this.copyKeyPressed=e,e?(t.refElements.addCls("sch-event-copy"),this.setVisibilityForSourceEvents(!0)):(t.refElements.removeCls("sch-event-copy"),this.setVisibilityForSourceEvents(!1)))},onKey:function(e){e.getKey()===e[this.enableCopyKey]&&this.checkShiftChange()},startDrag:function(){this.enableCopy&&Ext.getDoc().on({keydown:this.onKey,keyup:this.onKey,scope:this});var e=this.callParent(arguments),t=this.dragData;if(t.refElement=this.proxy.el.down(".sch-dd-ref"),t.refElements=this.proxy.el.select(".sch-event"),t.refElement.removeCls("sch-event-hover"),this.showTooltip){var i=this.schedulerView,n=i.up("[lockable=true]").el;if(!this.tipIsProcessed){this.tipIsProcessed=!0;var r=this.tip;r instanceof Ext.tip.ToolTip?Ext.applyIf(r,{schedulerView:i}):this.tip=new Sch.tooltip.Tooltip(Ext.apply({schedulerView:i,cls:"sch-dragdrop-tip",constrainTo:n},r))}this.tip.update(t.origStart,t.origEnd,!0),this.tip.setStyle("visibility"),this.tip.show(t.refElement,t.offsets[0])}return this.copyKeyPressed=this.getCopyKeyPressed(),this.copyKeyPressed&&(t.refElements.addCls("sch-event-copy"),t.originalHidden=!0),e},endDrag:function(){this.schedulerView.el.un("scroll",this.onViewElScroll,this),this.enableCopy&&Ext.getDoc().un({keydown:this.onKey,keyup:this.onKey,scope:this}),this.callParent(arguments)},onMouseUp:function(){this.dragging||this.afterDragFinalized()},afterDragFinalized:function(){this.proxy.el.setStyle({left:0,top:0})},updateRecords:function(e){var t=this,i=t.schedulerView,n=i.eventStore,r=i.resourceStore,a=n.getAssignmentStore(),s=e.newResource,o=e.draggedRecords[0],l=e.draggedRecords.slice(1),d=e.resourceRecord,c=t.getCopyKeyPressed(),h=e.startDate,u=e.timeDiff,g=i.getMode();a&&n instanceof Sch.data.EventStore?t.updateRecordsMultipleAssignmentMode(h,u,o,l,d,s,n,r,a,c,g):a?t.updateRecordsSingleAssignmentMode(h,u,o.getEvent(),Ext.Array.map(l,function(e){return e.getEvent()}),d,s,n,r,c,g):t.updateRecordsSingleAssignmentMode(h,u,o,l,d,s,n,r,c,g),i.fireEvent("eventdrop",i,e.draggedRecords,c)},updateRecordsSingleAssignmentMode:function(e,t,i,n,r,a,s,o,l,d){var c=this,h=[];if(l&&(i=i.fullCopy(null),h.push(i)),i.beginEdit(),!l&&a!==r&&r instanceof Sch.model.Resource&&a instanceof Sch.model.Resource?i.reassign(r,a):a!==r&&r instanceof Sch.model.Resource&&a instanceof Sch.model.Resource&&i.assign(a),i.setStartDate(e,!0,s.skipWeekendsDuringDragDrop),i.endEdit(),"calendar"!==d){var u=o.indexOf(r)-o.indexOf(a);Ext.Array.forEach(n,function(e){var i=e.getResources();l&&(e=e.fullCopy(null),h.push(e)),e.beginEdit(),e.setStartDate(c.adjustStartDate(e.getStartDate(),t),!0,s.skipWeekendsDuringDragDrop),0!==u&&i.length&&Ext.Array.forEach(i,function(t){var i,n=o.indexOf(t)-u;n<0?n=0:n>=o.getCount()&&(n=o.getCount()-1),i=o.getAt(n),e.reassign(t,i)}),e.endEdit()})}h.length&&s.append(h)},updateRecordsMultipleAssignmentMode:function(e,t,i,n,r,a,s,o,l,d,c){var h=this;Ext.Array.forEach([].concat(i,n),function(e){var i=e.getEvent();i.setStartDate(h.adjustStartDate(i.getStartDate(),t),!0,s.skipWeekendsDuringDragDrop),"calendar"!=c&&r!==a&&(d?i.assign(a):i.isAssignedTo(a)?i.unassign(e.getResource()):i.reassign(e.getResource(),a))})},isValidDrop:function(e,t,i){return e===t||(i instanceof Sch.model.Assignment?!i.getEvent().isAssignedTo(t):!i.isAssignedTo(t))},resolveResource:function(e,t){var i=this.proxy.el.dom,n=this.dragData.bodyScroll;i.style.display="none";var r=document.elementFromPoint(e[0]-n.left,e[1]-n.top);if(Ext.isIE8&&t&&t.browserEvent.synthetic&&(r=document.elementFromPoint(e[0]-n.left,e[1]-n.top)),i.style.display="block",!r)return null;var a=this.schedulerView;if(r.className.match(Ext.baseCSSPrefix+"grid-item"))return this.resolveResource([e[0],e[1]+3],t);if(!r.className.match(a.timeCellCls)){var s=Ext.fly(r).up("."+a.timeCellCls);if(!s)return null;r=s.dom}return a.resolveResource(r)},adjustStartDate:function(e,t){var i=this.schedulerView;return i.timeAxis.roundDate(new Date(e-0+t),!!i.snapRelativeToEventStartDate&&e)},updateDragContext:function(e){var t=this.dragData,i="scroll"===e.type?this.lastXY:e.getXY();if(t.refElement){var n=this.schedulerView,r=t.refElement.getRegion();if(n.timeAxis.isContinuous()){if(n.isHorizontal()&&this.minX<i[0]&&i[0]<this.maxX||n.isVertical()&&this.minY<i[1]&&i[1]<this.maxY){var a=n.getDateFromCoordinate(this.getCoordinate(i));t.timeDiff=a-t.sourceDate,t.startDate=this.adjustStartDate(t.origStart,t.timeDiff),t.endDate=new Date(t.startDate-0+t.duration)}}else{var s=this.resolveStartEndDates(r);t.startDate=s.startDate,t.endDate=s.endDate,t.timeDiff=t.startDate-t.origStart}if(t.newResource=n.constrainDragToResource?t.resourceRecord:this.resolveResource([r.left+t.offsets[0],r.top+t.offsets[1]],e),t.newResource){var o=this.validatorFn.call(this.validatorFnScope||this,t.draggedRecords,t.newResource,t.startDate,t.duration,e);o&&"boolean"!=typeof o?(t.valid=!1!==o.valid,t.message=o.message):(t.valid=!1!==o,t.message="")}else t.valid=!1}},getRelatedRecords:function(e){var t=this.schedulerView,i=t.getEventSelectionModel(),n=i.getDraggableSelections();return Ext.Array.filter(n,function(t){return e!==t})},getDragElement:function(e,t){var i,n,r=t.getEventBarElements(),a=t.offsets[0],s=t.offsets[1];if(r.length>1){var o=Ext.core.DomHelper.createDom({tag:"div",cls:"sch-dd-wrap",style:{overflow:"visible"}});Ext.Array.forEach(r,function(t){i=t.dom.cloneNode(!0),i.id=Ext.id(),t.dom===e.dom&&(i.className+=" sch-dd-ref",Ext.isIE8&&Ext.fly(i).addCls("sch-dd-ref")),o.appendChild(i);var n=t.getOffsetsTo(e);Ext.fly(i).setStyle({left:n[0]-a+"px",top:n[1]-s+"px"})}),n=o}else i=e.dom.cloneNode(!0),i.id=Ext.id(),i.style.left=-a+"px",i.style.top=-s+"px",i.className+=" sch-dd-ref",Ext.isIE8&&Ext.fly(i).addCls("sch-dd-ref"),n=i;return e.dom.style.height||Ext.fly(n).setHeight(e.getHeight()),n},onDragDrop:function(e,t){this.updateDragContext(e);var i=this,n=i.schedulerView,r=i.cachedTarget||Ext.dd.DragDropMgr.getDDById(t),a=i.dragData,s=!1,o=!0;a.ddCallbackArgs=[r,e,t],a.valid&&a.startDate&&a.endDate&&(a.finalize=function(){i.finalize.apply(i,arguments)},(o=!1!==n.fireEvent("beforeeventdropfinalize",i,a,e))&&i.isValidDrop(a.resourceRecord,a.newResource,a.draggedRecords[0])&&(s=a.startDate-a.origStart!=0||a.newResource!==a.resourceRecord)),o?i.finalize(a.valid&&s):i.proxy.el.addCls("sch-before-drag-finalized")},finalize:function(e){var t=this,i=t.schedulerView,n=i.eventStore,r=t.dragData;if(t.proxy.el.removeCls("sch-before-drag-finalized"),t.tip&&t.tip.hide(),e){var a,s=function(){a=!0};n.on("update",s,null,{single:!0}),t.updateRecords(r),n.un("update",s,null,{single:!0}),a?(Ext.isIE9?(t.proxy.el.setStyle("visibility","hidden"),Ext.Function.defer(t.onValidDrop,10,t,r.ddCallbackArgs)):t.onValidDrop.apply(t,r.ddCallbackArgs),i.fireEvent("aftereventdrop",i,r.draggedRecords)):t.onInvalidDrop.apply(t,r.ddCallbackArgs),t.afterDragFinalized()}else t.onInvalidDrop.apply(t,r.ddCallbackArgs)},onInvalidDrop:function(e,t,i){Ext.isIE&&!t&&(t=e,e=e.getTarget()||document.body),this.tip&&this.tip.hide(),this.setVisibilityForSourceEvents(!0);var n=this.schedulerView,r=this.callParent([e,t,i]);return n.fireEvent("aftereventdrop",n,this.dragData.draggedRecords),this.afterDragFinalized(),r},resolveStartEndDates:function(e){var t,i=this.dragData,n=i.origStart,r=i.origEnd,a=Sch.util.Date;return i.startsOutsideView?i.endsOutsideView||(t=this.schedulerView.getStartEndDatesFromRegion(e,"round"))&&(r=t.end||i.endDate,n=a.add(r,a.MILLI,-i.duration)):(t=this.schedulerView.getStartEndDatesFromRegion(e,"round"))&&(n=t.start||i.startDate,r=a.add(n,a.MILLI,i.duration)),{startDate:n,endDate:r}}}),Ext.define("Sch.feature.DragDrop",{validatorFn:function(e,t,i,n,r){return!0},validatorFnScope:null,dragConfig:null,constructor:function(e,t){Ext.apply(this,t),this.schedulerView=e,e.eventDragZone=new Sch.feature.SchedulerDragZone(e.ownerCt.el,Ext.apply({ddGroup:e.id,schedulerView:e,validatorFn:this.validatorFn,validatorFnScope:this.validatorFnScope},this.dragConfig)),this.schedulerView.on("destroy",this.cleanUp,this),this.callParent([t])},cleanUp:function(){var e=this.schedulerView;e.eventDragZone&&e.eventDragZone.destroy()}}),Ext.define("Sch.feature.ResizeZone",{extend:Ext.util.Observable,showTooltip:!0,showExactResizePosition:!1,validatorFn:Ext.emptyFn,validatorFnScope:null,schedulerView:null,origEl:null,handlePos:null,eventRec:null,tip:null,tipInstance:null,startScroll:null,constructor:function(e){Ext.apply(this,e);var t=this.schedulerView;t.on({destroy:this.cleanUp,scope:this}),t.mon(t.el,{mousedown:this.onMouseDown,mouseup:this.onMouseUp,scope:this,delegate:".sch-resizable-handle"}),this.callParent(arguments)},onMouseDown:function(e,t){var i=this.schedulerView,n=this.eventRec=i.resolveEventRecord(t),r=n.isResizable();0!==e.button||!1===r||"string"==typeof r&&!t.className.match(r)||(this.eventRec=n,this.handlePos=this.getHandlePosition(t),this.origEl=Ext.get(e.getTarget(".sch-event")),i.el.on({mousemove:this.onMouseMove,scope:this,single:!0}))},onMouseUp:function(e,t){this.schedulerView.el.un({mousemove:this.onMouseMove,scope:this,single:!0})},getTipInstance:function(){if(this.tipInstance)return this.tipInstance;var e=this.schedulerView,t=this.tip,i=e.up("[lockable=true]").el;return t instanceof Ext.tip.ToolTip?Ext.applyIf(t,{schedulerView:e}):t=new Sch.tooltip.Tooltip(Ext.apply({rtl:this.rtl,schedulerView:e,constrainTo:i,cls:"sch-resize-tip"},t)),this.tipInstance=t},onMouseMove:function(e,t){var i=this.schedulerView,n=this.eventRec,r=this.handlePos;if(n&&!1!==i.fireEvent("beforeeventresize",i,n,e)){delete this.eventRec,e.stopEvent(),this.origEl.addCls("sch-event-resizing"),this.resizer=this.createResizer(this.origEl,n,r);var a=this.resizer.resizeTracker;if(this.showTooltip){var s=this.getTipInstance();s.setTarget(this.origEl),s.update(n.getStartDate(),n.getEndDate(),!0),s.show(this.origEl,e.getX()-this.origEl.getX())}a.onMouseDown(e,this.resizer[r].dom),a.onMouseMove(e,this.resizer[r].dom),i.fireEvent("eventresizestart",i,n),i.el.on("scroll",this.onViewElScroll,this)}},getHandlePosition:function(e){var t=e.className.match("start");return"horizontal"===this.schedulerView.getMode()?this.schedulerView.rtl?t?"east":"west":t?"west":"east":t?"north":"south"},createResizer:function(e,t,i){var n=this.schedulerView,r=this,a=n.resolveResource(e),s=n.getSnapPixelAmount(),o=n.getScheduleRegion(a,t),l=n.getDateConstraints(a,t),d=e.getHeight(),c=n.rtl&&"e"===i[0]||!n.rtl&&"w"===i[0]||"n"===i[0],h="horizontal"!==n.getMode(),u={otherEdgeX:c?e.getRight():e.getLeft(),otherEdgeY:c?e.getBottom():e.getTop(),target:e,isStart:c,startYOffset:e.getY()-e.parent().getY(),startXOffset:e.getX()-e.parent().getX(),dateConstraints:l,resourceRecord:a,eventRecord:t,handles:i[0],minHeight:d,constrainTo:o,listeners:{resizedrag:this.partialResize,resize:this.afterResize,scope:this}},g=e.id,f="_"+g;if(e.id=e.dom.id=f,Ext.cache[f]=Ext.cache[g],h){if(s>0){var p=e.getWidth();Ext.apply(u,{minHeight:s,minWidth:p,maxWidth:p,heightIncrement:s})}}else s>0&&Ext.apply(u,{minWidth:s,maxHeight:d,widthIncrement:s});var m=new Ext.resizer.Resizer(u);if(m.prevId=g,m.resizeTracker){m.resizeTracker.tolerance=-1;var v=m.resizeTracker.updateDimensions;m.resizeTracker.updateDimensions=function(e){if(!Ext.isWebKit||e.getTarget(".sch-timelineview")){var t;h?(t=n.el.getScroll().top-r.startScroll.top,m.resizeTracker.minHeight=u.minHeight-Math.abs(t)):(t=n.el.getScroll().left-r.startScroll.left,m.resizeTracker.minWidth=u.minWidth-Math.abs(t)),v.apply(this,arguments)}},m.resizeTracker.resize=function(e){var t;h?(t=n.el.getScroll().top-r.startScroll.top,"s"===i[0]&&(e.y-=t),e.height+=Math.abs(t)):(t=n.el.getScroll().left-r.startScroll.left,"e"===i[0]&&(e.x-=t),e.width+=Math.abs(t)),Ext.resizer.ResizeTracker.prototype.resize.apply(this,arguments)}}return e.setStyle("z-index",parseInt(e.getStyle("z-index"),10)+1),Sch.util.ScrollManager.activate(n,"horizontal"===n.getMode()?"horizontal":"vertical"),this.startScroll=n.el.getScroll(),m},getStartEndDates:function(){var e,t,i,n=this.resizer,r=n.el,a=this.schedulerView,s=n.isStart;return s?(i="horizontal"===a.getMode()?[a.rtl?r.getRight():r.getLeft()+1,r.getTop()]:[(r.getRight()+r.getLeft())/2,r.getTop()],t=n.eventRecord.getEndDate(),a.snapRelativeToEventStartDate?(e=a.getDateFromXY(i),e=a.timeAxis.roundDate(e,n.eventRecord.getStartDate())):e=a.getDateFromXY(i,"round")):(i="horizontal"===a.getMode()?[a.rtl?r.getLeft():r.getRight(),r.getBottom()]:[(r.getRight()+r.getLeft())/2,r.getBottom()],e=n.eventRecord.getStartDate(),a.snapRelativeToEventStartDate?(t=a.getDateFromXY(i),t=a.timeAxis.roundDate(t,n.eventRecord.getEndDate())):t=a.getDateFromXY(i,"round")),e=e||n.start,t=t||n.end,n.dateConstraints&&(e=Sch.util.Date.constrain(e,n.dateConstraints.start,n.dateConstraints.end),t=Sch.util.Date.constrain(t,n.dateConstraints.start,n.dateConstraints.end)),{start:e,end:t}},partialResize:function(e,t,i,n){var r=this.schedulerView,a="scroll"===n.type?this.resizer.resizeTracker.lastXY:n.getXY(),s=this.getStartEndDates(a),o=s.start,l=s.end,d=e.eventRecord,c=(r.getMode(),r.isHorizontal());if(c?e.target.el.setY(e.target.parent().getY()+e.startYOffset):e.target.el.setX(e.target.parent().getX()+e.startXOffset),this.showTooltip){var h=this.validatorFn.call(this.validatorFnScope||this,e.resourceRecord,d,o,l),u="";h&&"boolean"!=typeof h&&(u=h.message,h=h.valid),this.getTipInstance().update(o,l,!1!==h,u)}if(this.showExactResizePosition){var g,f,p,m=e.target.el;if(e.isStart){if("calendar"===r.getMode()){var v=r.calendar.getEventColumns(d)[0];g=r.timeAxisViewModel.getDistanceBetweenDates(o,v.end)}else g=r.timeAxisViewModel.getDistanceBetweenDates(o,d.getEndDate());c?(f=r.getDateFromCoordinate(e.otherEdgeX-Math.min(t,e.maxWidth))||o,p=r.timeAxisViewModel.getDistanceBetweenDates(f,o),m.setWidth(g),m.setX(m.getX()+p)):(f=r.getDateFromCoordinate(e.otherEdgeY-Math.min(t,e.maxHeight))||o,p=r.timeAxisViewModel.getDistanceBetweenDates(f,o),m.setHeight(g),m.setY(m.getY()+p))}else g=r.timeAxisViewModel.getDistanceBetweenDates(d.getStartDate(),l),c?m.setWidth(g):m.setHeight(g)}else if(!o||!l||e.start-o==0&&e.end-l==0)return;e.end=l,e.start=o,r.fireEvent("eventpartialresize",r,d,o,l,e.el)},onViewElScroll:function(e,t){this.resizer.resizeTracker.onDrag.apply(this.resizer.resizeTracker,arguments),this.partialResize(this.resizer,0,0,e)},afterResize:function(e,t,i,n){var r=this,a=e.resourceRecord,s=e.eventRecord,o=s.getStartDate(),l=s.getEndDate(),d=e.start||o,c=e.end||l,h=r.schedulerView,u=!1,g=!0,f=r.validatorFn.call(r.validatorFnScope||r,a,s,d,c,n);Sch.util.ScrollManager.deactivate(),h.el.un("scroll",this.onViewElScroll,this),this.showTooltip&&this.getTipInstance().hide(),h.el.select("[id^=calendar-resizer-placeholder]").remove(),delete Ext.cache[e.el.id],e.el.id=e.el.dom.id=e.el.id.substr(1),r.resizeContext={resourceRecord:e.resourceRecord,eventRecord:s,start:d,end:c,finalize:function(){r.finalize.apply(r,arguments)}},f&&"boolean"!=typeof f&&(f=f.valid),d&&c&&c-d>0&&(d-o!=0||c-l!=0)&&!1!==f?(g=!1!==h.fireEvent("beforeeventresizefinalize",r,r.resizeContext,n),u=!0):h.repaintEventsForResource(a),g&&r.finalize(u)},finalize:function(e){var t=this.schedulerView,i=this.resizeContext,n=!1,r=function(){n=!0};t.eventStore.on("update",r),this.resizer.target.destroy(),e?(this.resizer.isStart?i.eventRecord.setStartDate(i.start,!1,t.eventStore.skipWeekendsDuringDragDrop):i.eventRecord.setEndDate(i.end,!1,t.eventStore.skipWeekendsDuringDragDrop),n||t.repaintEventsForResource(i.resourceRecord)):t.repaintEventsForResource(i.resourceRecord),this.resizer.destroy(),t.eventStore.un("update",r),t.fireEvent("eventresizeend",t,i.eventRecord),this.resizeContext=null},cleanUp:function(){this.tipInstance&&this.tipInstance.destroy()}}),Ext.define("Sch.plugin.Zones",{extend:Sch.feature.AbstractTimeSpan,alias:"plugin.scheduler_zones",innerTpl:null,cls:"sch-zone",side:null,init:function(e){Ext.isString(this.innerTpl)&&(this.innerTpl=new Ext.XTemplate(this.innerTpl)),this.side=e.rtl?"right":"left";var t=this.innerTpl;this.template||(this.template=new Ext.XTemplate('<tpl for="."><div id="{id}" class="{$cls}" style="'+this.side+':{left}px;top:{top}px;height:{height}px;width:{width}px;{style}">'+(t?"{[this.renderInner(values)]}":"")+"</div></tpl>",{renderInner:function(e){return t.apply(e)}})),Ext.isString(this.innerHeaderTpl)&&(this.innerHeaderTpl=new Ext.XTemplate(this.innerHeaderTpl)),this.callParent(arguments)},getElementData:function(e,t,i,n){var r,a,s,o,l,d=this.schedulerView,c=[],h=d.getTimeSpanRegion(e,t,this.expandToFitView);i=i||this.store.getRange();for(var u=0,g=i.length;u<g;u++)if(r=i[u],a=r.getStartDate(),s=r.getEndDate(),l=this.getTemplateData(r),a&&s&&Sch.util.Date.intersectSpans(a,s,e,t)){o=Ext.apply({},l),o.id=this.getElementId(r),o.$cls=this.getElementCls(r,l);var f=d.getMode();if("calendar"===f){var p=d.getTimeSpanRegion(a,s);o.left=p.left,o.top=p.top,o.height=p.bottom-p.top,o.width=p.right-p.left}else{var m=d.getCoordinateFromDate(Sch.util.Date.max(a,e)),v=d.getCoordinateFromDate(Sch.util.Date.min(s,t));"horizontal"===f?(o.left=m,o.top=h.top,o.width=n?0:v-m,o.height=h.bottom-h.top,o.style=n?"border-left-width:"+(v-m)+"px":""):(o.left=h.left,o.top=m,o.height=n?0:v-m,o.width=h.right-h.left,o.style=n?"border-top-width:"+(v-m)+"px":"")}c.push(o)}return c},getHeaderElementId:function(e,t){return this.callParent([e])+(t?"-start":"-end")},getHeaderElementCls:function(e,t,i){var n=e.clsField||this.clsField;return t||(t=this.getTemplateData(e)),"sch-header-indicator sch-header-indicator-"+(i?"start ":"end ")+this.uniqueCls+" "+(t[n]||"")},getZoneHeaderElementData:function(e,t,i,n){var r,a,s,o=n?i.getStartDate():i.getEndDate(),l=null;return o&&Sch.util.Date.betweenLesser(o,e,t)&&(r=this.getHeaderElementPosition(o),a=this.schedulerView.isHorizontal(),s=this.getTemplateData(i),l=Ext.apply({id:this.getHeaderElementId(i,n),cls:this.getHeaderElementCls(i,s,n),isStart:n,side:a?this.side:"top",position:r},s)),l},getHeaderElementData:function(e){var t,i,n,r=this.timeAxis.getStart(),a=this.timeAxis.getEnd(),s=[];e=e||this.store.getRange();for(var o=0,l=e.length;o<l;o++)t=e[o],i=this.getZoneHeaderElementData(r,a,t,!0),i&&s.push(i),(n=this.getZoneHeaderElementData(r,a,t,!1))&&s.push(n);return s},updateZoneHeaderElement:function(e,t){e.dom.className=t.cls,this.schedulerView.isHorizontal()?this.setElementX(e,t.position):e.setTop(t.position)},updateHeaderElement:function(e){var t=this.timeAxis.getStart(),i=this.timeAxis.getEnd(),n=Ext.get(this.getHeaderElementId(e,!0)),r=Ext.get(this.getHeaderElementId(e,!1)),a=this.getZoneHeaderElementData(t,i,e,!0),s=this.getZoneHeaderElementData(t,i,e,!1);n&&s&&r&&s?(n&&(a?this.updateZoneHeaderElement(n,a):Ext.destroy(n)),r&&(s?this.updateZoneHeaderElement(r,s):Ext.destroy(r))):(Ext.destroy(n,r),this.renderHeaderElementsInternal([e]))}}),Ext.define("Sch.plugin.ResourceZones",{extend:Sch.plugin.Zones,alias:"plugin.scheduler_resourcezones",innerTpl:null,store:null,cls:"sch-resourcezone",init:function(e){this.uniqueCls=this.uniqueCls||"sch-timespangroup-"+Ext.id(),this.scheduler=e,e.registerRenderer(this.renderer,this),Ext.isString(this.innerTpl)&&(this.innerTpl=new Ext.XTemplate(this.innerTpl));var t=this.innerTpl;this.template||(this.template=new Ext.XTemplate('<tpl for="."><div id="'+this.uniqueCls+'-{id}" class="'+this.cls+" "+this.uniqueCls+' {Cls}" style="'+(e.rtl?"right":"left")+':{start}px;width:{width}px;top:{start}px;height:{width}px;{style}">'+(t?"{[this.renderInner(values)]}":"")+"</div></tpl>",{renderInner:function(e){return t.apply(e)}})),this.storeListeners={load:this.fullRefresh,datachanged:this.fullRefresh,clear:this.fullRefresh,add:this.fullRefresh,remove:this.fullRefresh,update:this.refreshSingle,addrecords:this.fullRefresh,removerecords:this.fullRefresh,updaterecord:this.refreshSingle,scope:this},this.store=Ext.StoreManager.lookup(this.store),this.store.on(this.storeListeners)},destroy:function(){this.store.un(this.storeListeners),this.callParent(arguments)},fullRefresh:function(){this.scheduler.getSchedulingView().refresh()},renderer:function(e,t,i,n){return"horizontal"===this.scheduler.getOrientation()||0===n?this.renderZones(i):""},renderZones:function(e){for(var t,i,n=this.store,r=this.scheduler,a=r.timeAxis.getStart(),s=r.timeAxis.getEnd(),o=[],l=e.getEvents(n),d=0,c=l.length;d<c;d++){var h=l[d];if(t=h.getStartDate(),i=h.getEndDate(),t&&i&&Sch.util.Date.intersectSpans(t,i,a,s)){var u,g,f=r.getSchedulingView()[r.getOrientation()].getEventRenderData(h);"horizontal"===r.getMode()?(u=r.rtl?f.right:f.left,g=f.width):(u=f.top,g=f.height),o[o.length]=Ext.apply({id:h.internalId,start:u,width:g,Cls:h.getCls()},h.data)}}return this.template.apply(o)},refreshSingle:function(e,t){var i=Ext.get(this.uniqueCls+"-"+t.internalId);if(i){var n=this.scheduler,r=n.timeAxis.getStart(),a=n.timeAxis.getEnd(),s=Sch.util.Date.max(r,t.getStartDate()),o=Sch.util.Date.min(a,t.getEndDate()),l=t.getCls(),d=n.getSchedulingView().getCoordinateFromDate(s),c=n.getSchedulingView().getCoordinateFromDate(o)-d;i.dom.className=this.cls+" "+this.uniqueCls+" "+(l||""),i.setStyle({left:d+"px",top:d+"px",height:c+"px",width:c+"px"})}}}),Ext.define("Sch.mixin.AbstractSchedulerPanel",{eventBarIconClsField:"",enableEventDragDrop:!0,resourceColumnClass:"Sch.column.Resource",resourceColumnWidth:null,calendarColumnWidth:null,allowOverlap:!0,startParamName:"startDate",endParamName:"endDate",passStartEndParameters:!1,variableRowHeight:!0,eventRenderer:null,eventRendererScope:null,eventStore:null,resourceStore:null,onEventCreated:function(e){},resourceZones:null,resourceZonesConfig:null,initStores:function(){var e=this.resourceStore||this.store;e||(this.crudManager&&(e=this.resourceStore=this.crudManager.getResourceStore()),e=e||new Sch.data.ResourceStore),this.eventStore||(this.crudManager&&(this.eventStore=this.crudManager.getEventStore()),this.eventStore=this.eventStore||new Sch.data.EventStore,this.eventStore||Ext.Error.raise("You must specify an eventStore config")),this.store=Ext.StoreManager.lookup(e),this.resourceStore=this.store,this.eventStore=Ext.StoreManager.lookup(this.eventStore),this.eventStore.isEventStore||Ext.Error.raise("Your eventStore should be a subclass of Sch.data.EventStore (or consume the EventStore mixin)"),this.resourceStore.eventStore=this.eventStore,this.passStartEndParameters&&this.eventStore.on("beforeload",this.applyStartEndParameters,this)},_initializeSchedulerPanel:function(){this.initStores(),this.eventBodyTemplate&&Ext.isString(this.eventBodyTemplate)&&(this.eventBodyTemplate=new Ext.XTemplate(this.eventBodyTemplate))},getResourceStore:function(){return this.resourceStore},getEventStore:function(){return this.eventStore},applyStartEndParameters:function(e,t){var i=e.getProxy();i.setExtraParam(this.startParamName,this.getStart()),i.setExtraParam(this.endParamName,this.getEnd())},createResourceColumns:function(e){return Ext.Array.map(this.resourceStore.getRange(),function(t){return{xclass:this.resourceColumnClass,renderer:this.mainRenderer,scope:this,width:e||100,text:t.getName(),model:t}},this)}}),Ext.define("Sch.template.Event",{extend:Ext.XTemplate,eventPrefix:null,resizeHandles:null,resizeTpl:'<div class="sch-resizable-handle sch-resizable-handle-{0}"></div>',constructor:function(e){Ext.apply(this,e);var t="start"===this.resizeHandles||"both"===this.resizeHandles?'<div class="sch-resizable-handle sch-resizable-handle-start"></div>':"",i="end"===this.resizeHandles||"both"===this.resizeHandles?'<div class="sch-resizable-handle sch-resizable-handle-end"></div>':"";this.callParent(['<tpl for="."><div unselectable="on" tabindex="-1" id="'+this.eventPrefix+'{id}" style="right:{right}px;left:{left}px;top:{top}px;height:{height}px;width:{width}px;{style}" class="sch-event '+Ext.baseCSSPrefix+'unselectable {internalCls} {cls}">'+t+'<div unselectable="on" class="sch-event-inner {iconCls}">{body}</div>'+i+"</div></tpl>"])}}),Ext.define("Sch.view.Vertical",{view:null,constructor:function(e){Ext.apply(this,e)},translateToScheduleCoordinate:function(e){var t=this.view;return e-t.getEl().getY()+t.getScroll().top},translateToPageCoordinate:function(e){var t=this.view,i=t.getEl(),n=i.getScroll();return e+i.getY()-n.top},getDateFromXY:function(e,t,i){var n=e[1];return i||(n=this.translateToScheduleCoordinate(n)),this.view.timeAxisViewModel.getDateFromPosition(n,t)},getEventRenderData:function(e,t,i){var n,r=e.getStartDate(),a=e.getEndDate(),s=this.view,o=s.timeAxis.getStart(),l=s.timeAxis.getEnd(),d=Math,c=d.floor(s.getCoordinateFromDate(Sch.util.Date.max(r,o))),h=d.floor(s.getCoordinateFromDate(Sch.util.Date.min(a,l))),u=this.getResourceColumnWidth(t);return n={top:d.max(0,d.min(c,h)-s.eventBorderWidth),height:d.max(1,d.abs(c-h))},s.managedEventSizing&&(n.left=s.barMargin,n.width=u-2*s.barMargin-s.eventBorderWidth),n.start=r,n.end=a,n.startsOutsideView=r<o,n.endsOutsideView=a>l,n},getScheduleRegion:function(e,t){var i=this.view,n=e?Ext.fly(i.getScheduleCell(0,i.resourceStore.indexOf(e))).getRegion():i.getTableRegion(),r=i.timeAxis.getStart(),a=i.timeAxis.getEnd(),s=i.getDateConstraints(e,t)||{start:r,end:a},o=this.translateToPageCoordinate(i.getCoordinateFromDate(Sch.util.Date.max(r,s.start))),l=this.translateToPageCoordinate(i.getCoordinateFromDate(Sch.util.Date.min(a,s.end))),d=n.left+i.barMargin,c=(e?n.left+this.getResourceColumnWidth(e):n.right)-i.barMargin;return new Ext.util.Region(Math.min(o,l),c,Math.max(o,l),d)},getResourceColumnWidth:function(e){return this.view.timeAxisViewModel.resourceColumnWidth},getResourceRegion:function(e,t,i){var n=this.view,r=n.resourceStore.indexOf(e)*this.getResourceColumnWidth(e),a=n.timeAxis.getStart(),s=n.timeAxis.getEnd(),o=t?Sch.util.Date.max(a,t):a,l=i?Sch.util.Date.min(s,i):s,d=Math.max(0,n.getCoordinateFromDate(o)-n.cellTopBorderWidth),c=n.getCoordinateFromDate(l)-n.cellTopBorderWidth,h=r+n.cellBorderWidth,u=r+this.getResourceColumnWidth(e)-n.cellBorderWidth;return new Ext.util.Region(Math.min(d,c),u,Math.max(d,c),h)},columnRenderer:function(e,t,i,n,r){var a=this.view,s="";if(0===n){var o,l,d,c,h=(Sch.util.Date,a.timeAxis);for(o=[],l=a.eventStore.getEventsForResource(i),d=0,c=l.length;d<c;d++){var u=l[d],g=u.getStartDate(),f=u.getEndDate();g&&f&&h.timeSpanInAxis(g,f)&&o.push(a.generateTplData(u,i,r))}a.eventLayout.vertical.applyLayout(o,this.getResourceColumnWidth(i)),s="&#160;"+a.eventTpl.apply(o)}return r%2==1&&(t.tdCls=(t.tdCls||"")+" "+a.altColCls,t.cellCls=(t.cellCls||"")+" "+a.altColCls),s},resolveResource:function(e){var t,i,n,r=this,a=r.view;if(t=Ext.fly(e).is(a.eventSelector)&&e||Ext.fly(e).up(a.eventSelector,null,!0))n=a.getResourceRecordFromDomId(t.id);else{if(e=Ext.fly(e).is(a.timeCellSelector)?e:Ext.fly(e).up(a.timeCellSelector,null,!0),i=-1,e&&Ext.isIE8m)for(e=e.previousSibling;e;)1===e.nodeType&&i++,e=e.previousSibling;else e&&(i=Ext.Array.indexOf(Array.prototype.slice.call(e.parentNode.children),e));n=i>=0&&a.resourceStore.getAt(i)||null}return n},onEventUpdate:function(e,t){var i,n=this,r=t.previous||{},a=n.view,s=a.timeAxis,o=t.getStartDate(),l=t.getEndDate(),d=r.StartDate||o,c=r.EndDate||l,h=d&&c&&s.timeSpanInAxis(d,c);t.resourceIdField in r&&h&&(i=e.getResourceStore().getById(r[t.resourceIdField]))&&n.relayoutRenderedEvents(i),(o&&l&&s.timeSpanInAxis(o,l)||h)&&(n.renderSingle(t),Ext.Array.forEach(t.getResources(),function(e){n.relayoutRenderedEvents(e),a.getEventSelectionModel().isSelected(t)&&a.onEventBarSelect(t,!0)}))},onEventAdd:function(e,t){var i,n,r,a=this,s=a.view;1===t.length?(i=t[0],n=i.getStartDate(),r=i.getEndDate(),n&&r&&s.timeAxis.timeSpanInAxis(n,r)&&(a.renderSingle(i),Ext.Array.forEach(e.getResourcesForEvent(i),function(e){a.relayoutRenderedEvents(e)}))):s.repaintAllEvents()},onEventRemove:function(e,t){var i,n,r,a,s,o,l=this,d=l.view
;for(o=!1,a=0,s=t.length;!o&&a<s;a++)i=t[a],n=i.getStartDate(),r=i.getEndDate(),(o=n&&r&&d.timeAxis.timeSpanInAxis(n,r))&&d.repaintAllEvents()},relayoutRenderedEvents:function(e){var t=[],i=this.view;i.eventStore.getEventsForResource(e);Ext.Array.forEach(i.eventStore.getEventsForResource(e),function(n){var r=i.getElementsFromEventRecord(n,e);r.length&&t.push({start:n.getStartDate(),end:n.getEndDate(),event:n,node:r[0]})}),i.eventLayout.vertical.applyLayout(t,this.getResourceColumnWidth(e)),Ext.Array.forEach(t,function(e){e.node.setStyle({left:e.left+"px",width:e.width+"px"}),i.fireEvent("eventrepaint",i,e.event,e.node)})},renderSingle:function(e){var t=this,i=t.view,n=e.getStartDate(),r=e.getEndDate();Ext.Array.forEach(i.getElementsFromEventRecord(e),function(e){e.destroy()}),n&&r&&i.timeAxis.timeSpanInAxis(n,r)&&Ext.Array.forEach(e.getResources(),function(t){var n,r=i.resourceStore.indexOf(t),a=Ext.fly(i.getScheduleCell(0,r));a&&(n=i.generateTplData(e,t,r),i.eventTpl.append(a.first(),[n]))})},getTimeSpanRegion:function(e,t){var i=this.view,n=i.getCoordinateFromDate(e),r=t?i.getCoordinateFromDate(t):n,a=i.getTableRegion(),s=a?a.right-a.left:i.getEl().dom.clientWidth;return new Ext.util.Region(Math.min(n,r),s,Math.max(n,r),0)},getStartEndDatesFromRegion:function(e,t,i){var n=this.view.getDateFromCoordinate(e.top,t),r=this.view.getDateFromCoordinate(e.bottom,t);return n&&r?{start:Sch.util.Date.min(n,r),end:Sch.util.Date.max(n,r)}:null},setColumnWidth:function(e,t){var i=this.view;i.resourceColumnWidth=e,i.getTimeAxisViewModel().setViewColumnWidth(e,t)},getVisibleDate_Range:function(){var e=this.view;if(!e.rendered)return null;var t=e.getScroll(),i=e.getHeight(),n=e.getTableRegion(),r=e.timeAxis.getEnd();if(n.bottom-n.top<i){return{startDate:e.timeAxis.getStart(),endDate:r}}return{startDate:e.getDateFromCoordinate(t.top,null,!0),endDate:e.getDateFromCoordinate(t.top+i,null,!0)||r}}}),Ext.define("Sch.mixin.AbstractSchedulerView",{_cmpCls:"sch-schedulerview",scheduledEventName:"event",eventTemplateClass:"Sch.template.Event",eventTpl:null,barMargin:0,constrainDragToResource:!1,allowOverlap:null,readOnly:null,altColCls:"sch-col-alt",dynamicRowHeight:!0,managedEventSizing:!0,eventAnimations:!0,horizontalLayoutCls:"Sch.eventlayout.Horizontal",horizontalEventSorterFn:null,verticalLayoutCls:"Sch.eventlayout.Vertical",verticalEventSorterFn:null,eventCls:"sch-event",verticalViewClass:"Sch.view.Vertical",eventStore:null,resourceStore:null,eventLayout:null,_initializeSchedulerView:function(){var e=Ext.ClassManager.get(this.horizontalLayoutCls),t=Ext.ClassManager.get(this.verticalLayoutCls);this.eventSelector="."+this.eventCls,this.eventLayout={},e&&(this.eventLayout.horizontal=new e(Ext.apply({timeAxisViewModel:this.timeAxisViewModel},{bandIndexToPxConvertFn:this.horizontal.layoutEventVertically,bandIndexToPxConvertScope:this.horizontal},this.horizontalEventSorterFn?{sortEvents:this.horizontalEventSorterFn}:{}))),t&&(this.eventLayout.vertical=new t(Ext.apply({},{view:this},this.verticalEventSorterFn?{sortEvents:this.verticalEventSorterFn}:{}))),this.store=this.store||this.resourceStore,this.resourceStore=this.resourceStore||this.store},generateTplData:function(e,t,i){var n=this[this.mode].getEventRenderData(e,t,i),r=e.getStartDate(),a=e.getEndDate(),s=e.getCls()||"";if(s+=" sch-event-resizable-"+e.getResizable(),e.dirty&&(s+=" sch-dirty "),n.endsOutsideView&&(s+=" sch-event-endsoutside "),n.startsOutsideView&&(s+=" sch-event-startsoutside "),this.eventBarIconClsField&&(s+=" sch-event-withicon "),!1===e.isDraggable()&&(s+=" sch-event-fixed "),a-r==0&&(s+=" sch-event-milestone "),this.getEventSelectionModel().isSelected(e)&&(s+=" "+this.selectedEventCls+" "),n.id=e.internalId+"-"+t.internalId+("calendar"===this.getMode()?"-"+i:"-x"),n.internalCls=s,n.start=r,n.end=a,n.iconCls=e.data[this.eventBarIconClsField]||"",n.event=e,this.eventRenderer){var o=this.eventRenderer.call(this.eventRendererScope||this,e,t,n,i);this.eventBodyTemplate?n.body=this.eventBodyTemplate.apply(o):n.body=o}else this.eventBodyTemplate?n.body=this.eventBodyTemplate.apply(e.data):this.eventBarTextField&&(n.body=e.data[this.eventBarTextField]||"");return n},resolveResource:function(e){var t=this;return t[t.mode].resolveResource(e)},getResourceRegion:function(e,t,i){return this[this.mode].getResourceRegion(e,t,i)},resolveEventRecord:function(e){return e=e.dom?e.dom:e,Ext.fly(e).is(this.eventSelector)||(e=Ext.fly(e).up(this.eventSelector)),e&&this.getEventRecordFromDomId(e.id)},resolveEventRecordFromResourceRow:function(e){var t,i=this,n=i.getEventSelectionModel();return e=e.dom?e.dom:e,t=i.getRecord(e),n.getFirstSelectedEventForResource(t)},resolveAssignmentRecord:function(e){var t,i,n=this,r=n.eventStore.getAssignmentStore(),a=null;return r&&(e=e.dom&&e.dom||e,t=n.getEventRecordFromDomId(e.id),i=n.getResourceRecordFromDomId(e.id),t&&i&&(a=r.getAssignmentForEventAndResource(t,i))),a},getEventRecordFromDomId:function(e){return e=this.getEventIdFromDomNodeId(e),this.eventStore.getModelByInternalId(e)},getResourceRecordFromDomId:function(e){return e=this.getResourceIdFromDomNodeId(e),this.eventStore.getResourceStore().getByInternalId(e)},isDate_RangeAvailable:function(e,t,i,n){return this.eventStore.isDate_RangeAvailable(e,t,i,n)},getEventsInView:function(){var e=this.timeAxis.getStart(),t=this.timeAxis.getEnd();return this.eventStore.getEventsInTimeSpan(e,t)},getEventNodes:function(){return this.getEl().select(this.eventSelector)},onEventCreated:function(e){},getEventStore:function(){return this.eventStore},registerEventEditor:function(e){this.eventEditor=e},getEventEditor:function(){return this.eventEditor},onEventUpdate:function(e,t,i){this[this.mode].onEventUpdate(e,t,i)},onEventAdd:function(e,t){Ext.isArray(t)||(t=[t]),this[this.mode].onEventAdd(e,t)},onAssignmentAdd:function(e,t){var i=this;Ext.Array.forEach(t,function(e){var t=e.getResource();t&&i.repaintEventsForResource(t)})},onAssignmentUpdate:function(e,t){var i,n,r=this,a=t.previous&&t.previous[t.resourceIdField],s=t.getResourceId();a&&(i=r.resourceStore.getModelById(a),r.repaintEventsForResource(i)),s&&(n=r.resourceStore.getModelById(s),r.repaintEventsForResource(n))},onAssignmentRemove:function(e,t){var i=this;Ext.Array.forEach(t,function(e){var t=e.getResourceId(),n=t&&i.resourceStore.getModelById(t);n&&i.repaintEventsForResource(n)})},onEventRemove:function(e,t){this[this.mode].onEventRemove(e,t)},bindEventStore:function(e,t){var i=this,n={scope:i,refresh:i.onEventDataRefresh,addrecords:i.onEventAdd,updaterecord:i.onEventUpdate,removerecords:i.onEventRemove,add:i.onEventAdd,update:i.onEventUpdate,remove:i.onEventRemove,nodeinsert:i.onEventAdd,nodeappend:i.onEventAdd},r={scope:i,refresh:i.onEventDataRefresh,load:i.onEventDataRefresh,update:i.onAssignmentUpdate,add:i.onAssignmentAdd,remove:i.onAssignmentRemove};if(Ext.versions.touch||(n.clear=i.onEventDataRefresh),!t&&i.eventStore){if(i.eventStore.setResourceStore(null),e!==i.eventStore&&i.eventStore.autoDestroy)i.eventStore.destroy();else if(i.mun){i.mun(i.eventStore,n);var a=i.eventStore.getAssignmentStore&&i.eventStore.getAssignmentStore();a&&i.mun(a,r)}else i.eventStore.un(n);e||(i.eventStore=null)}if(e){e=Ext.data.StoreManager.lookup(e),i.mon?i.mon(e,n):e.on(n),i.eventStore=e,e.setResourceStore(i.resourceStore);var s=e.getAssignmentStore&&e.getAssignmentStore();s&&i.mon(s,r)}e&&!t&&i.refresh()},onEventDataRefresh:function(){this.refreshKeepingScroll()},onEventBarSelect:function(e){var t,i,n=this;e instanceof Sch.model.Assignment?(t=e.getEvent(),i=e.getResource()):(t=e,i=null),Ext.Array.forEach(n.getElementsFromEventRecord(t,i),function(e){e.addCls(n.selectedEventCls)})},onEventBarDeselect:function(e){var t,i,n=this;e instanceof Sch.model.Assignment?(t=e.getEvent(),i=e.getResource()):(t=e,i=null),t&&Ext.Array.forEach(n.getElementsFromEventRecord(t,i),function(e){e.removeCls(n.selectedEventCls)})},refresh:function(){throw"Abstract method call"},repaintEventsForResource:function(e){throw"Abstract method call"},repaintAllEvents:function(){this.refreshKeepingScroll()},scrollEventIntoView:function(e,t,i,n,r){var a=this,s=e.getResources();s.length&&a.scrollResourceEventIntoView(s[0],e,null,t,i,n,r)}}),Ext.define("Sch.preset.ViewPreset",{name:null,rowHeight:null,timeColumnWidth:50,timeRowHeight:null,timeAxisColumnWidth:null,displayDateFormat:"G:i",shiftUnit:"HOUR",shiftIncrement:1,defaultSpan:12,timeResolution:null,headerConfig:null,columnLinesFor:"middle",headers:null,mainHeader:0,constructor:function(e){Ext.apply(this,e)},getHeaders:function(){if(this.headers)return this.headers;var e=this.headerConfig;return this.mainHeader=e.top?1:0,this.headers=[].concat(e.top||[],e.middle||[],e.bottom||[])},getMainHeader:function(){return this.getHeaders()[this.mainHeader]},getBottomHeader:function(){var e=this.getHeaders();return e[e.length-1]},clone:function(){var e={},t=this;return Ext.each(["rowHeight","timeColumnWidth","timeRowHeight","timeAxisColumnWidth","displayDateFormat","shiftUnit","shiftIncrement","defaultSpan","timeResolution","headerConfig"],function(i){e[i]=t[i]}),new this.self(Ext.clone(e))}}),Ext.define("Sch.preset.Manager",{extend:Ext.util.MixedCollection,mixins:[Sch.mixin.Localizable],singleton:!0,defaultPresets:{secondAndMinute:{timeColumnWidth:30,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"G:i:s",shiftIncrement:10,shiftUnit:"MINUTE",defaultSpan:24,timeResolution:{unit:"SECOND",increment:5},headerConfig:{middle:{unit:"SECOND",increment:10,align:"center",dateFormat:"s"},top:{unit:"MINUTE",align:"center",dateFormat:"D, d g:iA"}}},minuteAndHour:{timeColumnWidth:100,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"G:i",shiftIncrement:1,shiftUnit:"HOUR",defaultSpan:24,timeResolution:{unit:"MINUTE",increment:30},headerConfig:{middle:{unit:"MINUTE",increment:"30",align:"center",dateFormat:"i"},top:{unit:"HOUR",align:"center",dateFormat:"D, gA/d"}}},hourAndDay:{timeColumnWidth:60,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"G:i",shiftIncrement:1,shiftUnit:"DAY",defaultSpan:24,timeResolution:{unit:"MINUTE",increment:30},headerConfig:{middle:{unit:"HOUR",align:"center",dateFormat:"G:i"},top:{unit:"DAY",align:"center",dateFormat:"D d/m"}}},dayAndWeek:{timeColumnWidth:100,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d G:i",shiftUnit:"DAY",shiftIncrement:1,defaultSpan:5,timeResolution:{unit:"HOUR",increment:1},headerConfig:{middle:{unit:"DAY",align:"center",dateFormat:"D d M"},top:{unit:"WEEK",align:"center",renderer:function(e,t,i){return Sch.util.Date.getShortNameOfUnit("WEEK")+"."+Ext.Date.format(e,"W M Y")}}}},weekAndDay:{timeColumnWidth:100,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftUnit:"WEEK",shiftIncrement:1,defaultSpan:1,timeResolution:{unit:"DAY",increment:1},headerConfig:{bottom:{unit:"DAY",align:"center",increment:1,dateFormat:"d/m"},middle:{unit:"WEEK",dateFormat:"D d M"}}},weekAndMonth:{timeColumnWidth:100,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftUnit:"WEEK",shiftIncrement:5,defaultSpan:6,timeResolution:{unit:"DAY",increment:1},headerConfig:{middle:{unit:"WEEK",renderer:function(e,t,i){return Ext.Date.format(e,"d M")}},top:{unit:"MONTH",align:"center",dateFormat:"M Y"}}},monthAndYear:{timeColumnWidth:110,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftIncrement:3,shiftUnit:"MONTH",defaultSpan:12,timeResolution:{unit:"DAY",increment:1},headerConfig:{middle:{unit:"MONTH",align:"center",dateFormat:"M Y"},top:{unit:"YEAR",align:"center",dateFormat:"Y"}}},year:{timeColumnWidth:100,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftUnit:"YEAR",shiftIncrement:1,defaultSpan:1,timeResolution:{unit:"MONTH",increment:1},headerConfig:{middle:{unit:"QUARTER",align:"center",renderer:function(e,t,i){return Ext.String.format(Sch.util.Date.getShortNameOfUnit("QUARTER").toUpperCase()+"{0}",Math.floor(e.getMonth()/3)+1)}},top:{unit:"YEAR",align:"center",dateFormat:"Y"}}},manyYears:{timeColumnWidth:50,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftUnit:"YEAR",shiftIncrement:1,defaultSpan:1,timeResolution:{unit:"YEAR",increment:1},headerConfig:{middle:{unit:"YEAR",align:"center",dateFormat:"Y",increment:5},bottom:{unit:"YEAR",align:"center",dateFormat:"y",increment:1}}},weekAndDayLetter:{timeColumnWidth:20,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftUnit:"WEEK",shiftIncrement:1,defaultSpan:10,timeResolution:{unit:"DAY",increment:1},headerConfig:{bottom:{unit:"DAY",align:"center",renderer:function(e){return Ext.Date.dayNames[e.getDay()].substring(0,1)}},middle:{unit:"WEEK",dateFormat:"D d M Y"}}},weekDateAndMonth:{timeColumnWidth:30,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftUnit:"WEEK",shiftIncrement:1,defaultSpan:10,timeResolution:{unit:"DAY",increment:1},headerConfig:{middle:{unit:"WEEK",align:"center",dateFormat:"d"},top:{unit:"MONTH",dateFormat:"Y F"}}},day:{timeRowHeight:40,calendarColumnWidth:200,displayDateFormat:"G:i",shiftIncrement:1,shiftUnit:"DAY",defaultSpan:24,timeResolution:{unit:"MINUTE",increment:30},headerConfig:{bottom:{unit:"HOUR",align:"center",renderer:function(e){return Ext.String.format('<div class="sch-calendarcolumn-ct"><span class="sch-calendarcolumn-hours">{0}</span><span class="sch-calendarcolumn-minutes">{1}</span></div>',Ext.Date.format(e,"H"),Ext.Date.format(e,"i"))}},middle:{unit:"DAY",align:"center",dateFormat:"D d/m",splitUnit:"DAY"}}},week:{timeRowHeight:40,calendarColumnWidth:164,displayDateFormat:"G:i",shiftIncrement:1,shiftUnit:"WEEK",defaultSpan:24,timeResolution:{unit:"MINUTE",increment:30},headerConfig:{bottom:{unit:"HOUR",align:"center",dateFormat:"H:i",renderer:function(e){return Ext.String.format('<div class="sch-calendarcolumn-ct"><span class="sch-calendarcolumn-hours">{0}</span><span class="sch-calendarcolumn-minutes">{1}</span></div>',Ext.Date.format(e,"H"),Ext.Date.format(e,"i"))}},middle:{unit:"WEEK",align:"center",dateFormat:"D d",splitUnit:"DAY"}}},month:{timeColumnWidth:60,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"G:i",shiftIncrement:1,shiftUnit:"MONTH",defaultSpan:4,timeResolution:{unit:"HOUR",increment:12},headerConfig:{bottom:{unit:"DAY",align:"center",dateFormat:"D",splitUnit:"WEEK"},middle:{unit:"WEEK",align:"center",dateFormat:"D d/m"},top:{unit:"MONTH",align:"center",renderer:function(e,t,i){return Ext.Date.format(e,"d/m")+" - "+Ext.Date.format(t,"d/m, Y")},splitUnit:"WEEK"}}}},constructor:function(){this.callParent(arguments),this.registerDefaults()},onLocalized:function(){var e=this;this.eachKey(function(t,i){if(e.l10n[t]){var n=e.L(t);n.displayDateFormat&&(i.displayDateFormat=n.displayDateFormat),n.middleDateFormat&&(i.headerConfig.middle.dateFormat=n.middleDateFormat),n.topDateFormat&&(i.headerConfig.top.dateFormat=n.topDateFormat),n.bottomDateFormat&&(i.headerConfig.bottom.dateFormat=n.bottomDateFormat)}})},registerPreset:function(e,t){if(t){var i=t.headerConfig,n=Sch.util.Date;for(var r in i)i.hasOwnProperty(r)&&(n[i[r].unit]&&(i[r].unit=n[i[r].unit.toUpperCase()]),n[i[r].splitUnit]&&(i[r].splitUnit=n[i[r].splitUnit.toUpperCase()]));t.timeColumnWidth||(t.timeColumnWidth=50),t.rowHeight||(t.rowHeight=24);var a=t.timeResolution;a&&n[a.unit]&&(a.unit=n[a.unit.toUpperCase()]);var s=t.shiftUnit;s&&n[s]&&(t.shiftUnit=n[s.toUpperCase()])}if(!this.isValidPreset(t))throw"Invalid preset, please check your configuration";this.containsKey(e)&&this.removeAtKey(e),t.name=e,this.add(e,new Sch.preset.ViewPreset(t))},isValidPreset:function(e){var t=(Sch.util.Date,!0),i=Sch.util.Date.units,n={};for(var r in e.headerConfig)e.headerConfig.hasOwnProperty(r)&&(n[r]=!0,t=t&&Ext.Array.indexOf(i,e.headerConfig[r].unit)>=0);return e.columnLinesFor in n||(e.columnLinesFor="middle"),e.timeResolution&&(t=t&&Ext.Array.indexOf(i,e.timeResolution.unit)>=0),e.shiftUnit&&(t=t&&Ext.Array.indexOf(i,e.shiftUnit)>=0),t},getPreset:function(e){return this.get(e)},deletePreset:function(e){this.removeAtKey(e)},registerDefaults:function(){var e=this,t=this.defaultPresets;for(var i in t)e.registerPreset(i,t[i])}}),Ext.define("Sch.view.model.TimeAxis",{extend:Ext.util.Observable,timeAxis:null,availableWidth:0,tickWidth:100,snapToIncrement:!1,forceFit:!1,headerConfig:null,headers:null,mainHeader:0,timeAxisColumnWidth:null,resourceColumnWidth:null,calendarColumnWidth:null,timeColumnWidth:null,rowHeightHorizontal:null,rowHeightVertical:null,mode:"horizontal",suppressFit:!1,refCount:0,columnConfig:{},viewPreset:null,columnLinesFor:"middle",eventStore:null,originalTickWidth:null,constructor:function(e){var t=this;if(Ext.apply(this,e),this.viewPreset)if(this.viewPreset instanceof Sch.preset.ViewPreset)this.consumeViewPreset(this.viewPreset);else{var i=Sch.preset.Manager.getPreset(this.viewPreset);i&&this.consumeViewPreset(i)}t.timeAxis.on("reconfigure",t.onTimeAxisReconfigure,t),this.callParent(arguments)},destroy:function(){this.timeAxis.un("reconfigure",this.onTimeAxisReconfigure,this)},onTimeAxisReconfigure:function(e,t){t||this.update()},reconfigure:function(e){switch(this.headers=null,Ext.apply(this,e),this.mode){case"horizontal":this.setTickWidth(this.timeColumnWidth);break;case"vertical":case"calendar":this.setTickWidth(this.rowHeightVertical)}this.fireEvent("reconfigure",this)},getColumnConfig:function(){return this.columnConfig},update:function(e,t){var i=this.timeAxis,n=this.headerConfig;if(this.availableWidth=Math.max(e||this.availableWidth,0),!Ext.isNumber(this.availableWidth))throw"Invalid available width provided to Sch.view.model.TimeAxis";if(!(this.forceFit&&this.availableWidth<=0)){this.columnConfig={};for(var r in n)n[r].cellGenerator?this.columnConfig[r]=n[r].cellGenerator.call(this,i.getStart(),i.getEnd()):this.columnConfig[r]=this.createHeaderRow(r,n[r]);var a=this.calculateTickWidth(this.originalTickWidth);if(!Ext.isNumber(a)||a<=0)throw"Invalid column width calculated in Sch.view.model.TimeAxis";this.updateTickWidth(a),t||this.fireEvent("update",this)}},createHeaderRow:function(e,t){var i=[],n=this,r=t.align,a=Ext.Date.clearTime(new Date);return n.forEachInterval(e,function(e,s,o){var l={align:r,start:e,end:s,headerCls:""};t.renderer?l.header=t.renderer.call(t.scope||n,e,s,l,o,n.eventStore):l.header=Ext.Date.format(e,t.dateFormat),t.unit!==Sch.util.Date.DAY||t.increment&&1!==t.increment||(l.headerCls+=" sch-dayheadercell-"+e.getDay(),Ext.Date.clearTime(e,!0)-a==0&&(l.headerCls+=" sch-dayheadercell-today")),i.push(l)}),i},getDistanceBetweenDates:function(e,t){return Math.round(this.getPositionFromDate(t,!0)-this.getPositionFromDate(e))},getPositionFromDate:function(e,t){if("calendar"===this.mode){var i=this.rowHeightCalendar||this.rowHeightVertical,n=this.getHeaders(),r=this.timeAxis.getStart(),a=Sch.util.Date,s=a.mergeDates(r,e,n[1].unit),o=a.getDurationInUnit(r,s,n[1].unit,!0)*i,l=Math.round(o);return 0===l&&t?this.calendarRowsAmount*i:l}var d=-1,c=this.timeAxis.getTickFromDate(e);return c>=0&&(d=Math.round(this.tickWidth*(c-this.timeAxis.visibleTickStart))),d},getDateFromPosition:function(e,t){if("calendar"===this.mode){var i=this.rowHeightCalendar||this.rowHeightVertical,n=Sch.util.Date,r=this.timeAxis.getStart(),a=this.getHeaders(),s=n.add(r,a[0].splitUnit,Math.floor(e[0]/this.calendarColumnWidth)),o=this.timeAxis.first(),l=(o.get("end")-o.get("start"))/i,d=n.add(s,n.MILLI,Math.round(e[1]*l));return t&&(d=this.timeAxis[t+"Date"](d)),d}var c=e/this.getTickWidth()+this.timeAxis.visibleTickStart,h=this.timeAxis.getCount();return c<0||c>h?null:this.timeAxis.getDateFromTick(c,t)},getSingleUnitInPixels:function(e){return Sch.util.Date.getUnitToBaseUnitRatio(this.timeAxis.getUnit(),e)*this.tickWidth/this.timeAxis.increment},getSnapPixelAmount:function(){if(this.snapToIncrement){var e=this.timeAxis.getResolution();return(e.increment||1)*this.getSingleUnitInPixels(e.unit)}return 1},getTickWidth:function(){return this.tickWidth},setTickWidth:function(e,t){this.originalTickWidth=e,this.updateTickWidth(e),this.update(null,t)},updateTickWidth:function(e){switch(this.tickWidth=e,this.mode){case"horizontal":this.timeColumnWidth=e;break;case"vertical":case"calendar":this.rowHeightVertical=e}},getTotalWidth:function(){return Math.round(this.tickWidth*this.timeAxis.getVisibleTickTimeSpan())},calculateTickWidth:function(e){var t=this.forceFit,i=this.timeAxis,n=0,r=i.getUnit(),a=Number.MAX_VALUE,s=Sch.util.Date;if(this.snapToIncrement){var o=i.getResolution();a=s.getUnitToBaseUnitRatio(r,o.unit)*o.increment}else{var l=s.getMeasuringUnit(r);a=Math.min(a,s.getUnitToBaseUnitRatio(r,l))}if(this.suppressFit)n=e;else{var d=Math[t?"floor":"round"](this.getAvailableWidth()/i.getVisibleTickTimeSpan());if(n=t||e<d?d:e,a>0&&(!t||a<1)){var c=Ext.versions.touch&&t?"ceil":t?"floor":"round";n=Math.round(Math.max(1,Math[c](a*n))/a)}}return n},getAvailableWidth:function(){return this.availableWidth},setAvailableWidth:function(e){this.availableWidth=Math.max(0,e),this.calculateTickWidth(this.originalTickWidth)!==this.tickWidth&&this.update()},fitToAvailableWidth:function(e){var t=Math.floor(this.availableWidth/this.timeAxis.getVisibleTickTimeSpan());this.setTickWidth(t,e)},setForceFit:function(e){e!==this.forceFit&&(this.forceFit=e,this.update())},setSnapToIncrement:function(e){e!==this.snapToIncrement&&(this.snapToIncrement=e,this.update())},getViewRowHeight:function(){var e="horizontal"==this.mode?this.rowHeightHorizontal:this.rowHeightVertical;if(!e)throw"rowHeight info not available";return e},setViewRowHeight:function(e,t){var i="horizontal"===this.mode,n="rowHeight"+Ext.String.capitalize(this.mode);this[n]!=e&&(this[n]=e,i?t||this.fireEvent("update",this):this.setTickWidth(e,t))},setViewColumnWidth:function(e,t){switch(this.mode){case"horizontal":this.setTickWidth(e,t);break;case"vertical":this.resourceColumnWidth=e;break;case"calendar":this.calendarColumnWidth=e}t||this.fireEvent("columnwidthchange",this,e)},getHeaders:function(){if(this.headers)return this.headers;var e=this.headerConfig;return this.mainHeader=e.top?1:0,this.headers=[].concat(e.top||[],e.middle||[],e.bottom||[])},getMainHeader:function(){return this.getHeaders()[this.mainHeader]},getBottomHeader:function(){var e=this.getHeaders();return e[e.length-1]},forEachInterval:function(e,t,i){i=i||this;var n=this.headerConfig;if(n)if("top"===e||"middle"===e&&n.bottom){var r=n[e];this.timeAxis.forEachAuxInterval(r.unit,r.increment,t,i)}else this.timeAxis.each(function(e,n){return t.call(i,e.data.start,e.data.end,n)})},forEachMainInterval:function(e,t){this.forEachInterval("middle",e,t)},getLowestHeader:function(){return"bottom"in this.headerConfig?"bottom":"middle"},consumeViewPreset:function(e){this.headers=null;var t="horizontal"==this.mode;Ext.apply(this,{headerConfig:e.headerConfig,columnLinesFor:e.columnLinesFor||"middle",rowHeightHorizontal:e.rowHeight,tickWidth:t?e.timeColumnWidth:e.timeRowHeight||e.timeColumnWidth||60,timeColumnWidth:e.timeColumnWidth,rowHeightVertical:e.timeRowHeight||e.timeColumnWidth||60,timeAxisColumnWidth:e.timeAxisColumnWidth,resourceColumnWidth:e.resourceColumnWidth||100}),this.originalTickWidth=this.tickWidth}}),Ext.define("Sch.mixin.Zoomable",{zoomLevels:[{width:40,increment:1,resolution:1,preset:"manyYears",resolutionUnit:"YEAR"},{width:80,increment:1,resolution:1,preset:"manyYears",resolutionUnit:"YEAR"},{width:30,increment:1,resolution:1,preset:"year",resolutionUnit:"MONTH"},{width:50,increment:1,resolution:1,preset:"year",resolutionUnit:"MONTH"},{width:100,increment:1,resolution:1,preset:"year",resolutionUnit:"MONTH"},{width:200,increment:1,resolution:1,preset:"year",resolutionUnit:"MONTH"},{width:100,increment:1,resolution:7,preset:"monthAndYear",resolutionUnit:"DAY"},{width:30,increment:1,resolution:1,preset:"weekDateAndMonth",resolutionUnit:"DAY"},{width:35,increment:1,resolution:1,preset:"weekAndMonth",resolutionUnit:"DAY"},{width:50,increment:1,resolution:1,preset:"weekAndMonth",resolutionUnit:"DAY"},{width:20,increment:1,resolution:1,preset:"weekAndDayLetter"},{width:50,increment:1,resolution:1,preset:"weekAndDay",resolutionUnit:"HOUR"},{width:100,increment:1,resolution:1,preset:"weekAndDay",resolutionUnit:"HOUR"},{width:50,increment:6,resolution:30,preset:"hourAndDay",resolutionUnit:"MINUTE"},{width:100,increment:6,resolution:30,preset:"hourAndDay",resolutionUnit:"MINUTE"},{width:60,increment:2,resolution:30,preset:"hourAndDay",resolutionUnit:"MINUTE"},{width:60,increment:1,resolution:30,preset:"hourAndDay",resolutionUnit:"MINUTE"},{width:30,increment:15,resolution:5,preset:"minuteAndHour"},{width:60,increment:15,resolution:5,preset:"minuteAndHour"},{width:130,increment:15,resolution:5,preset:"minuteAndHour"},{width:60,increment:5,resolution:5,preset:"minuteAndHour"},{width:100,increment:5,resolution:5,preset:"minuteAndHour"},{width:50,increment:2,resolution:1,preset:"minuteAndHour"},{width:30,increment:10,resolution:5,preset:"secondAndMinute"},{width:60,increment:10,resolution:5,preset:"secondAndMinute"},{width:130,increment:5,resolution:5,preset:"secondAndMinute"}],minZoomLevel:null,maxZoomLevel:null,visibleZoomFactor:5,zoomKeepsOriginalTimespan:!1,cachedCenterDate:null,isFirstZoom:!0,isZooming:!1,initializeZooming:function(){this.zoomLevels=this.zoomLevels.slice(),this.setMinZoomLevel(this.minZoomLevel||0),this.setMaxZoomLevel(null!==this.maxZoomLevel?this.maxZoomLevel:this.zoomLevels.length-1),this.on("viewchange",this.clearCenterDateCache,this)},getZoomLevelUnit:function(e){return Sch.preset.Manager.getPreset(e.preset).getBottomHeader().unit},getMilliSecondsPerPixelForZoomLevel:function(e,t){var i=Sch.util.Date;return Math.round((i.add(new Date(1,0,1),this.getZoomLevelUnit(e),e.increment)-new Date(1,0,1))/(t?e.width:e.actualWidth||e.width))},presetToZoomLevel:function(e){var t=Sch.preset.Manager.getPreset(e);return{preset:e,increment:t.getBottomHeader().increment||1,resolution:t.timeResolution.increment,resolutionUnit:t.timeResolution.unit,width:t.timeColumnWidth}},zoomLevelToPreset:function(e){var t=Sch.preset.Manager.getPreset(e.preset).clone(),i=t.getBottomHeader();return i.increment=e.increment,t.timeColumnWidth=e.width,(e.resolutionUnit||e.resolution)&&(t.timeResolution={unit:e.resolutionUnit||t.timeResolution.unit||i.unit,increment:e.resolution||t.timeResolution.increment||1}),t},calculateCurrentZoomLevel:function(){var e=this.presetToZoomLevel(this.viewPreset),t=Number.MAX_VALUE,i=this.timeAxisViewModel,n=i.timeColumnWidth;e.width=n,e.increment=i.getBottomHeader().increment||1;for(var r=0,a=this.zoomLevels.length;r<a;r++){var s=this.zoomLevels[r];if(s.preset===e.preset){var o=Math.abs(s.width-n);o<t&&(t=o,e.actualWidth=s.actualWidth,e.width=s.width)}}return e},getCurrentZoomLevelIndex:function(){for(var e=this.calculateCurrentZoomLevel(),t=this.getMilliSecondsPerPixelForZoomLevel(e),i=this.zoomLevels,n=0;n<i.length;n++){var r=this.getMilliSecondsPerPixelForZoomLevel(i[n]);if(r==t)return n;if(0===n&&t>r)return-.5;if(n==i.length-1&&t<r)return i.length-1+.5;var a=this.getMilliSecondsPerPixelForZoomLevel(i[n+1]);if(r>t&&t>a)return n+.5}throw"Can't find current zoom level index"},setMaxZoomLevel:function(e){if(e<0||e>=this.zoomLevels.length)throw new Error("Invalid range for `setMinZoomLevel`");this.maxZoomLevel=e},setMinZoomLevel:function(e){if(e<0||e>=this.zoomLevels.length)throw new Error("Invalid range for `setMinZoomLevel`");this.minZoomLevel=e},getViewportCenterDateCached:function(){return this.cachedCenterDate?this.cachedCenterDate:this.cachedCenterDate=this.getViewportCenterDate()},clearCenterDateCache:function(){this.cachedCenterDate=null},zoomToLevel:function(e,t,i){e=Ext.Number.constrain(e,this.minZoomLevel,this.maxZoomLevel),i=i||{};var n=this.calculateCurrentZoomLevel(),r=this.getMilliSecondsPerPixelForZoomLevel(n),a=this.zoomLevels[e];if(r==this.getMilliSecondsPerPixelForZoomLevel(a)&&!t)return null;var s=this;s.fireEvent("beforezoomchange",s,e);var o=this.getSchedulingView(),l=o.getOuterEl(),d="vertical"==this.mode,c=t?new Date((t.start.getTime()+t.end.getTime())/2):this.getViewportCenterDateCached(),h=d?l.getHeight():l.getWidth(),u=Sch.preset.Manager.getPreset(a.preset).clone(),g=u.getBottomHeader(),f=Boolean(t);t=this.calculateOptimalDate_Range(c,h,a,t),u[d?"timeRowHeight":"timeColumnWidth"]=i.customWidth||a.width,g.increment=a.increment,this.isZooming=!0,this.viewPreset=a.preset;var p=this.timeAxis;u.increment=a.increment,u.timeResolution.unit=Sch.util.Date.getUnitByName(a.resolutionUnit||u.timeResolution.unit||g.unit),u.timeResolution.increment=a.resolution,this.setViewPreset(u,t.start||this.getStart(),t.end||this.getEnd(),!1,!0),a.actualWidth=this.timeAxisViewModel.getTickWidth(),f&&(c=i.centerDate||new Date((p.getStart().getTime()+p.getEnd().getTime())/2));var m=null,v=null;return d?(v=o.getYFromDate(c,!0)-h/2,s.cachedCenterDate=c,o.getScrollable().scrollTo(null,v),o.headerCt.getScrollable().scrollTo(null,v)):(m=o.getXFromDate(c,!0)-h/2,s.cachedCenterDate=c,o.getScrollable().scrollTo(m),o.headerCt.getScrollable().scrollTo(m)),s.isZooming=!1,s.fireEvent("zoomchange",s,e,m,v),e},setZoomLevel:function(){this.zoomToLevel.apply(this,arguments)},zoomToSpan:function(e,t){if(t=t||{},(t.leftMargin||t.rightMargin)&&(t.adjustStart=0,t.adjustEnd=0),Ext.applyIf(t,{leftMargin:0,rightMargin:0}),e.start&&e.end){var i=e.start,n=e.end,r=t.adjustStart>=0&&t.adjustEnd>=0;if(r&&(i=Sch.util.Date.add(i,this.timeAxis.mainUnit,-t.adjustStart),n=Sch.util.Date.add(n,this.timeAxis.mainUnit,t.adjustEnd)),i<=n){var a=this.getSchedulingView().getTimeAxisViewModel().getAvailableWidth(),s=Math.floor(this.getCurrentZoomLevelIndex());-1==s&&(s=0);for(var o,l=this.zoomLevels,d=n-i||1,c=this.getMilliSecondsPerPixelForZoomLevel(l[s],!0),h=d/c+t.leftMargin+t.rightMargin>a?-1:1,u=s+h,g=null;u>=0&&u<=l.length-1;){o=l[u],c=this.getMilliSecondsPerPixelForZoomLevel(o,!0);var f=d/c+t.leftMargin+t.rightMargin;if(-1==h){if(f<=a){g=u;break}}else{if(!(f<=a))break;s!==u-h&&(g=u)}u+=h}g=null!==g?g:u-h,o=l[g];var p=Sch.preset.Manager.getPreset(o.preset).getBottomHeader().unit;(t.leftMargin||t.rightMargin)&&(i=new Date(i.getTime()-c*t.leftMargin),n=new Date(n.getTime()+c*t.rightMargin));var m=Sch.util.Date.getDurationInUnit(i,n,p,!0)/o.increment;if(0===m)return;var v,S=Math.floor(a/m),y=new Date((i.getTime()+n.getTime())/2);return v=r?{start:i,end:n}:this.calculateOptimalDate_Range(y,a,o),this.zoomToLevel(g,v,{customWidth:S,centerDate:y})}}return null},zoomIn:function(e){e=e||1;var t=this.getCurrentZoomLevelIndex();return t>=this.zoomLevels.length-1?null:this.zoomToLevel(Math.floor(t)+e)},zoomOut:function(e){e=e||1;var t=this.getCurrentZoomLevelIndex();return t<=0?null:this.zoomToLevel(Math.ceil(t)-e)},zoomInFull:function(){return this.zoomToLevel(this.maxZoomLevel)},zoomOutFull:function(){return this.zoomToLevel(this.minZoomLevel)},calculateOptimalDate_Range:function(e,t,i,n){if(n)return n;var r=this.timeAxis;if(this.zoomKeepsOriginalTimespan)return{start:r.getStart(),end:r.getEnd()};var a=Sch.util.Date,s=this.getZoomLevelUnit(i),o=Math.ceil(t/i.width*i.increment*this.visibleZoomFactor/2),l=a.add(e,s,-o),d=a.add(e,s,o);return{start:r.floorDate(l,!1,s,i.increment),end:r.ceilDate(d,!1,s,i.increment)}}}),Ext.define("Sch.mixin.AbstractTimelinePanel",{mixins:[Sch.mixin.Zoomable],orientation:"horizontal",snapToIncrement:!1,readOnly:!1,forceFit:!1,eventResizeHandles:"both",timeAxis:null,autoAdjustTimeAxis:!0,timeAxisViewModel:null,crudManager:null,viewPreset:"weekAndDay",calendarViewPreset:"week",trackHeaderOver:!0,startDate:null,endDate:null,startTime:0,endTime:24,columnLines:!0,getDateConstraints:Ext.emptyFn,snapRelativeToEventStartDate:!1,trackMouseOver:!1,readRowHeightFromPreset:!0,eventBorderWidth:1,getOrientation:function(){return this.getMode.apply(this,arguments)},getMode:function(){return this.mode},isHorizontal:function(){return"horizontal"===this.getMode()},isVertical:function(){return!this.isHorizontal()},cellBorderWidth:1,cellTopBorderWidth:1,cellBottomBorderWidth:1,renderers:null,_initializeTimelinePanel:function(){
if(this.mode=this.mode||this.orientation||"horizontal","calendar"===this.mode&&(this.oldViewPreset=this.viewPreset,this.viewPreset=this.calendarViewPreset),!(this.viewPreset&&Sch.preset.Manager.getPreset(this.viewPreset)))throw"You must define a valid view preset object. See Sch.preset.Manager class for reference";if(this.initializeZooming(),this.renderers=[],this.readRowHeightFromPreset&&(this.readRowHeightFromPreset=!this.rowHeight),this.timeAxis||(this.timeAxis=new Sch.data.TimeAxis({autoAdjust:this.autoAdjustTimeAxis,mode:"calendar"===this.mode?"calendar":"plain"})),!(this.timeAxisViewModel&&this.timeAxisViewModel instanceof Sch.view.model.TimeAxis)){var e=Ext.apply({mode:this.mode,snapToIncrement:this.snapToIncrement,forceFit:this.forceFit,timeAxis:this.timeAxis,eventStore:this.getEventStore(),viewPreset:this.viewPreset},this.timeAxisViewModel||{});this.timeAxisViewModel=new Sch.view.model.TimeAxis(e)}this.timeAxisViewModel.on("update",this.onTimeAxisViewModelUpdate,this),this.timeAxisViewModel.refCount++,this.on("destroy",this.onPanelDestroyed,this);var t;switch(this.mode){case"horizontal":t=["sch-horizontal"];break;case"vertical":t=["sch-vertical","sch-vertical-resource"];break;case"calendar":t=["sch-vertical","sch-calendar"]}this.addCls([].concat.apply(["sch-timelinepanel"],t))},onTimeAxisViewModelUpdate:function(){var e=this.getSchedulingView();e&&e.viewReady&&(e.refreshKeepingScroll(),this.fireEvent("viewchange",this))},onPanelDestroyed:function(){var e=this.timeAxisViewModel;e.un("update",this.onTimeAxisViewModelUpdate,this),--e.refCount<=0&&e.destroy()},getSchedulingView:function(){throw"Abstract method call"},setReadOnly:function(e){this.getSchedulingView().setReadOnly(e)},isReadOnly:function(){return this.getSchedulingView().isReadOnly()},switchViewPreset:function(){this.setViewPreset.apply(this,arguments)},setViewPreset:function(e,t,i,n,r){var a=this.timeAxis;if(!1!==this.fireEvent("beforeviewchange",this,e,t,i)){var s="horizontal"===this.getMode();if(Ext.isString(e)&&(this.viewPreset=e,e=Sch.preset.Manager.getPreset(e)),!e)throw"View preset not found";if(!n||!a.isConfigured){var o={weekStartDay:void 0!==this.weekStartDay?this.weekStartDay:this.L?this.L("weekStartDay"):1,startTime:this.startTime,endTime:this.endTime};n?(0===a.getCount()||t)&&(o.start=t||new Date):o.start=t||a.getStart(),o.end=i,a.consumeViewPreset(e),a.reconfigure(o,!0),this.timeAxisViewModel.reconfigure({headerConfig:e.headerConfig,columnLinesFor:e.columnLinesFor||"middle",rowHeightHorizontal:this.readRowHeightFromPreset?e.rowHeight:this.rowHeight||this.timeAxisViewModel.getViewRowHeight(),tickWidth:s?e.timeColumnWidth:e.timeRowHeight||e.timeColumnWidth||60,timeColumnWidth:e.timeColumnWidth,rowHeightVertical:e.timeRowHeight||e.timeColumnWidth||60,timeAxisColumnWidth:e.timeAxisColumnWidth,resourceColumnWidth:this.resourceColumnWidth||e.resourceColumnWidth||100})}var l=this.getSchedulingView();l.setDisplayDateFormat(e.displayDateFormat),"vertical"===this.getMode()&&l.setColumnWidth(this.resourceColumnWidth||e.resourceColumnWidth||100,!0),r||(s?l.scrollHorizontallyTo(0):l.scrollVerticallyTo(0))}},getViewPreset:function(){return this.viewPreset},getStart:function(){return this.getStartDate()},getStartDate:function(){return this.timeAxis.getStart()},getEnd:function(){return this.getEndDate()},getEndDate:function(){return this.timeAxis.getEnd()},setTimeColumnWidth:function(e,t){this.timeAxisViewModel.setTickWidth(e,t)},getTimeColumnWidth:function(){return this.timeAxisViewModel.getTickWidth()},getRowHeight:function(){return this.timeAxisViewModel.getViewRowHeight()},shiftNext:function(e){this.suspendLayouts&&this.suspendLayouts(),this.timeAxis.shiftNext(e),this.suspendLayouts&&this.resumeLayouts(!0)},shiftPrevious:function(e){this.suspendLayouts&&this.suspendLayouts(),this.timeAxis.shiftPrevious(e),this.suspendLayouts&&this.resumeLayouts(!0)},goToNow:function(){this.setTimeSpan(new Date)},setTimeSpan:function(e,t){this.timeAxis&&this.timeAxis.setTimeSpan(e,t)},setStart:function(e){this.setTimeSpan(e)},setEnd:function(e){this.setTimeSpan(null,e)},getTimeAxis:function(){return this.timeAxis},scrollToDate:function(e,t){var i=this.getSchedulingView(),n=i.getCoordinateFromDate(e,!0);this.scrollToCoordinate(n,e,t,!1)},scrollToDateCentered:function(e,t){var i=this.getSchedulingView(),n=0;n="horizontal"===this.mode?i.getBox().width/2:i.getBox().height/2;var r=Math.round(i.getCoordinateFromDate(e,!0)-n);this.scrollToCoordinate(r,e,t,!0)},scrollToCoordinate:function(e,t,i,n){var r=this.getSchedulingView(),a=this;if(e<0)if(this.infiniteScroll)r.shiftToDate(t,n);else{var s=(this.timeAxis.getEnd()-this.timeAxis.getStart())/2;this.setTimeSpan(new Date(t.getTime()-s),new Date(t.getTime()+s)),n?a.scrollToDateCentered(t,i):a.scrollToDate(t,i)}else"horizontal"===this.mode?r.scrollHorizontallyTo(e,i):r.scrollVerticallyTo(e,i),r.fireEvent("scroll",this,e)},getViewportCenterDate:function(){return this.getSchedulingView().getViewportCenterDate()},addCls:function(){throw"Abstract method call"},removeCls:function(){throw"Abstract method call"},registerRenderer:function(e,t){this.renderers.push({fn:e,scope:t})},deregisterRenderer:function(e,t){Ext.each(this.renderers,function(t,i){if(e===t)return Ext.Array.removeAt(this.renderers,i),!1})}}),Ext.define("Sch.view.Horizontal",{view:null,constructor:function(e){Ext.apply(this,e)},translateToScheduleCoordinate:function(e){var t=this.view;return t.rtl?t.getHorizontalTimeAxisColumn().getEl().getRight()-e:e-t.getEl().getX()+t.getScroll().left},translateToPageCoordinate:function(e){var t=this.view;return e+t.getEl().getX()-t.getScroll().left},getDateFromXY:function(e,t,i){var n=e[0];return i||(n=this.translateToScheduleCoordinate(n)),this.view.timeAxisViewModel.getDateFromPosition(n,t)},getEventRenderData:function(e){var t=e.getStartDate(),i=e.getEndDate()||t,n=this.view,r=n.timeAxis.getStart(),a=n.timeAxis.getEnd(),s=Math,o=n.getXFromDate(Sch.util.Date.max(t,r)),l=n.getXFromDate(Sch.util.Date.min(i,a)),d={};return this.view.rtl?d.right=s.min(o,l):d.left=s.min(o,l),d.width=s.max(1,s.abs(l-o))-n.eventBorderWidth,n.managedEventSizing&&(d.top=s.max(0,n.barMargin-(Ext.isIE&&!Ext.isStrict?0:n.eventBorderWidth-n.cellTopBorderWidth)),d.height=n.timeAxisViewModel.rowHeightHorizontal-2*n.barMargin-n.eventBorderWidth),d.start=t,d.end=i,d.startsOutsideView=t<r,d.endsOutsideView=i>a,d},getScheduleRegion:function(e,t){var i=Ext.Element.prototype.getRegion?"getRegion":"getPageBox",n=this.view,r=e?Ext.fly(n.getRowNode(e))[i]():n.getTableRegion(),a=n.timeAxis.getStart(),s=n.timeAxis.getEnd(),o=n.getDateConstraints(e,t)||{start:a,end:s},l=this.translateToPageCoordinate(n.getXFromDate(Sch.util.Date.max(a,o.start))),d=this.translateToPageCoordinate(n.getXFromDate(Sch.util.Date.min(s,o.end))),c=r.top+n.barMargin,h=r.bottom-n.barMargin-n.eventBorderWidth;return new Ext.util.Region(c,Math.max(l,d),h,Math.min(l,d))},getResourceRegion:function(e,t,i){var n=this.view,r=n.getRowNode(e),a=Ext.fly(r).getOffsetsTo(n.getEl()),s=n.timeAxis.getStart(),o=n.timeAxis.getEnd(),l=t?Sch.util.Date.max(s,t):s,d=i?Sch.util.Date.min(o,i):o,c=n.getXFromDate(l),h=n.getXFromDate(d),u=a[1]+n.cellTopBorderWidth,g=a[1]+Ext.fly(r).getHeight()-n.cellBottomBorderWidth;if(!Ext.versions.touch){var f=n.getScroll();u+=f.top,g+=f.top}return new Ext.util.Region(u,Math.max(c,h),g,Math.min(c,h))},columnRenderer:function(e,t,i,n,r){var a=this.view,s=a.eventStore.filterEventsForResource(i,function(e){return a.timeAxis.isRangeInAxis(e)});if(0!==s.length){var o=Ext.Array.map(s,function(e){return a.generateTplData(e,i,n)});if(a.dynamicRowHeight){var l=a.eventLayout.horizontal,d=l.applyLayout(o,i,this.layoutEventVertically,this),c=d*a.timeAxisViewModel.rowHeightHorizontal-(d-1)*a.barMargin;t.rowHeight=c}return a.eventTpl.apply(o)}},layoutEventVertically:function(e,t){var i=this.view,n=0===e?i.barMargin:e*i.timeAxisViewModel.rowHeightHorizontal-(e-1)*i.barMargin;return n>=i.cellBottomBorderWidth&&(n-=i.cellBottomBorderWidth),n},resolveResource:function(e){var t,i,n=this,r=n.view;return t=Ext.fly(e).is(r.eventSelector)&&e||Ext.fly(e).up(r.eventSelector,null,!0),t?i=r.getResourceRecordFromDomId(t.id):(e=r.findRowByChild(e),i=e&&r.getRecordForRowNode(e)||null),i},getTimeSpanRegion:function(e,t,i){var n,r,a=this.view,s=a.getXFromDate(e),o=t?a.getXFromDate(t):s;return r=a.getTableRegion(),n=i?Math.max(r?r.bottom-r.top:0,a.getEl().dom.clientHeight):r?r.bottom-r.top:0,new Ext.util.Region(0,Math.max(s,o),n,Math.min(s,o))},getStartEndDatesFromRegion:function(e,t,i){var n=this.view,r=n.rtl,a=n.getDateFromCoordinate(r?e.right:e.left,t),s=n.getDateFromCoordinate(r?e.left:e.right,t);return a&&s||i&&(a||s)?{start:a,end:s}:null},onEventAdd:function(e,t){var i,n,r,a,s,o,l,d,c,h=this.view,u={};for(o=0,l=t.length;o<l;o++)if(i=t[o],n=i.getStartDate(),r=i.getEndDate(),n&&r&&h.timeAxis.timeSpanInAxis(n,r))for(a=t[o].getResources(h.eventStore),d=0,c=a.length;d<c;d++)s=a[d],u[s.getId()]=s;Ext.Object.each(u,function(e,t){h.repaintEventsForResource(t)})},onEventRemove:function(e,t){function i(e){s.store.indexOf(e)>=0&&s.repaintEventsForResource(e)}var n,r,a=this,s=a.view,o=(a.resourceStore,s.eventStore);n=Ext.Array.unique(Ext.Array.flatten(Ext.Array.map(t,function(e){return o.getResourcesForEvent(e)}))),n.length>1?Ext.Array.forEach(n,i):1==n.length&&(r=Ext.Array.flatten(Ext.Array.map(t,function(e){return s.getElementsFromEventRecord(e,null,null,!0)})),r=new Ext.CompositeElementLite(r),r.fadeOut({callback:function(){i(n[0])}}))},onEventUpdate:function(e,t){var i,n=t.previous||{},r=this.view,a=r.timeAxis,s=t.getStartDate(),o=t.getEndDate(),l=n.StartDate||s,d=n.EndDate||o,c=l&&d&&a.timeSpanInAxis(l,d);t.resourceIdField in n&&c&&(i=e.getResourceStore().getById(n[t.resourceIdField]))&&r.repaintEventsForResource(i,!0),(s&&o&&a.timeSpanInAxis(s,o)||c)&&Ext.Array.forEach(t.getResources(),function(e){r.repaintEventsForResource(e,!0)})},setColumnWidth:function(e,t){this.view.getTimeAxisViewModel().setViewColumnWidth(e,t)},getVisibleDate_Range:function(){var e=this.view;if(!e.getEl())return null;var t=e.getTableRegion(),i=e.timeAxis.getStart(),n=e.timeAxis.getEnd(),r=e.getWidth();if(t.right-t.left<r)return{startDate:i,endDate:n};var a=e.getScroll();return{startDate:e.getDateFromCoordinate(a.left,null,!0),endDate:e.getDateFromCoordinate(a.left+r,null,!0)}}}),Ext.define("Sch.mixin.AbstractTimelineView",{selectedEventCls:"sch-event-selected",readOnly:!1,horizontalViewClass:"Sch.view.Horizontal",timeCellCls:"sch-timetd",timeCellSelector:".sch-timetd",eventBorderWidth:1,timeAxis:null,timeAxisViewModel:null,eventPrefix:null,rowHeight:null,orientation:"horizontal",mode:"horizontal",horizontal:null,vertical:null,secondaryCanvasEl:null,panel:null,displayDateFormat:null,el:null,constructor:function(e){e&&e.orientation&&(e.mode=this.mode=e.orientation),this.callParent([e])},_initializeTimelineView:function(){this.horizontalViewClass&&(this.horizontal=Ext.create(this.horizontalViewClass,{view:this})),this.verticalViewClass&&(this.vertical=Ext.create(this.verticalViewClass,{view:this})),this.calendarViewClass&&(this.calendar=Ext.create(this.calendarViewClass,{view:this})),this.eventPrefix=(this.eventPrefix||this.getId())+"-"},getTimeAxisViewModel:function(){return this.timeAxisViewModel},getFormattedDate:function(e){return Ext.Date.format(e,this.getDisplayDateFormat())},getFormattedEndDate:function(e,t){var i=this.getDisplayDateFormat();return 0!==e.getHours()||0!==e.getMinutes()||e.getYear()===t.getYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()||Sch.util.Date.hourInfoRe.test(i.replace(Sch.util.Date.stripEscapeRe,""))||(e=Sch.util.Date.add(e,Sch.util.Date.DAY,-1)),Ext.Date.format(e,i)},getDisplayDateFormat:function(){return this.displayDateFormat},setDisplayDateFormat:function(e){this.displayDateFormat=e},fitColumns:function(e){if("horizontal"===this.mode)this.getTimeAxisViewModel().fitToAvailableWidth(e);else{var t=Math.floor((this.panel.getWidth()-Ext.getScrollbarSize().width-1)/this.headerCt.getColumnCount());this.setColumnWidth(t,e)}},getElementFromEventRecord:function(e,t){var i,n=this;return i=n.getElementsFromEventRecord(e,t),0===i.length?i=null:1==i.length?i=i[0]:"calendar"==n.mode?i=i[0]:Ext.Error.raise("The method getElementFromEventRecord() is deprecated, it can't handle the situation when several DOM elements correspond to a single event record, please use getElementsFromEventRecord() method instead!"),i},getElementsFromEventRecord:function(e,t,i,n){var r,a=this;return n=n||!1,r=t&&null!==i&&void 0!==i?"[id^="+a.eventPrefix+e.internalId+"-"+t.internalId+"-"+i+"]":t?"[id^="+a.eventPrefix+e.internalId+"-"+t.internalId+"-]":"[id^="+a.eventPrefix+e.internalId+"-]",a.getEl().query(r,n)},getStartEndDatesFromRegion:function(e,t,i){return this[this.mode].getStartEndDatesFromRegion(e,t,i)},getTimeResolution:function(){return this.timeAxis.getResolution()},setTimeResolution:function(e,t){this.timeAxis.setResolution(e,t),this.getTimeAxisViewModel().snapToIncrement&&this.refreshKeepingScroll()},getEventIdFromDomNodeId:function(e){return e.substring(this.eventPrefix.length).split("-")[0]},getResourceIdFromDomNodeId:function(e){return e.substring(this.eventPrefix.length).split("-")[1]},getDateFromDomEvent:function(e,t){return this.getDateFromXY(e.getXY(),t)},getSnapPixelAmount:function(){return this.getTimeAxisViewModel().getSnapPixelAmount()},setSnapEnabled:function(e){this.getTimeAxisViewModel().setSnapToIncrement(e)},setReadOnly:function(e){this.readOnly=e,this[e?"addCls":"removeCls"](this._cmpCls+"-readonly")},isReadOnly:function(){return this.readOnly},setOrientation:function(){this.setMode.apply(this,arguments)},setMode:function(e){this.mode=e,this.timeAxisViewModel.mode=e},getOrientation:function(){return this.getMode.apply(this,arguments)},getMode:function(){return this.mode},isHorizontal:function(){return"horizontal"===this.getMode()},isVertical:function(){return!this.isHorizontal()},getDateFromXY:function(e,t,i){return this[this.mode].getDateFromXY(e,t,i)},getDateFromCoordinate:function(e,t,i){return i||(e=this[this.mode].translateToScheduleCoordinate(e)),this.timeAxisViewModel.getDateFromPosition(e,t)},getDateFromX:function(e,t){return this.getDateFromCoordinate(e,t)},getDateFromY:function(e,t){return this.getDateFromCoordinate(e,t)},getCoordinateFromDate:function(e,t){var i=this.timeAxisViewModel.getPositionFromDate(e);return!1===t&&(i=this[this.mode].translateToPageCoordinate(i)),Math.round(i)},getXFromDate:function(e,t){return this.getCoordinateFromDate(e,t)},getYFromDate:function(e,t){return this.getCoordinateFromDate(e,t)},getTimeSpanDistance:function(e,t){return this.timeAxisViewModel.getDistanceBetweenDates(e,t)},getTimeSpanRegion:function(e,t){return this[this.mode].getTimeSpanRegion(e,t)},getScheduleRegion:function(e,t){return this[this.mode].getScheduleRegion(e,t)},getTableRegion:function(){throw"Abstract method call"},getRowNode:function(e){throw"Abstract method call"},getRecordForRowNode:function(e){throw"Abstract method call"},getVisibleDate_Range:function(){return this[this.mode].getVisibleDate_Range()},setColumnWidth:function(e,t){this[this.mode].setColumnWidth(e,t)},findRowByChild:function(e){throw"Abstract method call"},setBarMargin:function(e,t){this.barMargin=e,t||this.refreshKeepingScroll()},getRowHeight:function(){return this.timeAxisViewModel.getViewRowHeight()},setRowHeight:function(e,t){this.timeAxisViewModel.setViewRowHeight(e,t)},refreshKeepingScroll:function(){throw"Abstract method call"},scrollVerticallyTo:function(e,t){throw"Abstract method call"},scrollHorizontallyTo:function(e,t){throw"Abstract method call"},getVerticalScroll:function(){throw"Abstract method call"},getHorizontalScroll:function(){throw"Abstract method call"},getEl:Ext.emptyFn,getSecondaryCanvasEl:function(){if(!this.rendered)throw"Calling this method too early";return this.secondaryCanvasEl||(this.secondaryCanvasEl=(this.scrollerEl||this.getEl()).createChild({cls:"sch-secondary-canvas"})),this.secondaryCanvasEl},getScroll:function(){throw"Abstract method call"},getOuterEl:function(){return this.getEl()},getRowContainerEl:function(){return this.getEl()},getScheduleCell:function(e,t){return this.getCellByPosition({row:e,column:t})},getScrollEventSource:function(){return this.getEl()},getViewportHeight:function(){return this.getEl().getHeight()},getViewportWidth:function(){return this.getEl().getWidth()},getViewportCenterDate:function(){var e,t=this.getScroll();return e="vertical"===this.getMode()?[0,t.top+this.getViewportHeight()/2]:[t.left+this.getViewportWidth()/2,0],this.getDateFromXY(e,null,!0)},getDateConstraints:Ext.emptyFn}),Ext.apply(Sch,{}),Ext.define("Sch.mixin.FilterableTreeView",{prevBlockRefresh:null,initTreeFiltering:function(){var e=function(){var e=this.store;this.mon(e,"nodestore-datachange-start",this.onFilterChangeStart,this),this.mon(e,"nodestore-datachange-end",this.onFilterChangeEnd,this),e.allowExpandCollapseWhileFiltered||(this.mon(e,"filter-clear",this.onFilterCleared,this),this.mon(e,"filter-set",this.onFilterSet,this))};this.rendered?e.call(this):this.on("beforerender",e,this,{single:!0})},onFilterChangeStart:function(){this.prevBlockRefresh=this.blockRefresh,this.blockRefresh=!0,Ext.suspendLayouts()},onFilterChangeEnd:function(){Ext.resumeLayouts(!0),this.blockRefresh=this.prevBlockRefresh},onFilterCleared:function(){delete this.toggle;var e=this.getEl();e&&e.removeCls("sch-tree-filtered")},onFilterSet:function(){this.toggle=function(){};var e=this.getEl();e&&e.addCls("sch-tree-filtered")}}),Ext.define("Sch.patches.TouchScroll",{extend:Sch.util.Patch,target:"Ext.scroll.TouchScroller",minVersion:"5.1.0",overrides:{privates:{onEvent:function(e){var t=this;if(t[t.listenerMap[e.type]])return this.callParent(arguments)}}}}),Ext.define("Sch.patches.PartnerScroll",{extend:Sch.util.Patch,minVersion:"5.1.0",maxVersion:"5.1.1",applyFn:function(){(Ext.isMac||Ext.isGecko)&&Ext.ClassManager.get("Ext.scroll.Scroller").override({constructor:function(e){this.callParent([e]),this.doNotCall={}},privates:{onPartnerScrollEnd:function(){this.doNotCall={}},invokePartners:function(e,t,i){var n,r,a=this._partners;if(!this.suspendSync)for(r in a)n=a[r],n.suspendSync||this.doNotCall[n.scroller.id]?n.scroller.component.isTableView||delete this.doNotCall[n.scroller.id]:n.scroller[e](this,t,i)},onPartnerScroll:function(e,t,i){var n=e._partners[this.getId()].axis;n&&("x"===n?i=null:"y"===n&&(t=null)),this.doNotCall[e.id]=!0,this.doScrollTo(t,i,null,!1)}}})}}),Ext.define("Sch.patches.View",{extend:Sch.util.Patch,target:"Ext.view.View",minVersion:"5.1.0",overrides:{handleEvent:function(e){var t=this,i=t.keyEventRe.test(e.type),n=t.getNavigationModel();if(e.view=t,i&&(e.item=e.getTarget(t.itemSelector),e.record=n.getRecord(e.item)),!e.item){var r=t.editingPlugin&&t.editingPlugin.getActiveEditor();r&&r.getEl().contains(e.getTarget())||(e.item=e.getTarget(t.itemSelector))}e.item&&!e.record&&(e.record=t.getRecord(e.item)),!1!==t.processUIEvent(e)&&t.processSpecialEvent(e),i&&!Ext.fly(e.target).isInputField()&&(e.getKey()===e.SPACE||e.isNavKeyPress(!0))&&e.preventDefault()}}}),Ext.define("Sch.patches.Collection",{extend:Sch.util.Patch,target:"Ext.util.Collection",minVersion:"5.1.0",overrides:{updateKey:function(e,t){var i,n=this,r=n.map,a=n.indices,s=n.getSource();s&&!s.updating?s.updateKey(e,t):r[t]&&(i=n.getKey(e))!==t&&(t in r||r[i]!==e)&&(t in r&&(r[t]!==e&&Ext.Error.raise('Incorrect oldKey "'+t+'" for item with newKey "'+i+'"'),delete r[t]),n.updating++,n.generation++,r[i]=e,a&&(a[i]=a[t],delete a[t]),n.notify("updatekey",[{item:e,newKey:i,oldKey:t}]),n.updating--)}}}),Ext.define("Sch.patches.ToolTip",{extend:Sch.util.Patch,target:"Ext.tip.ToolTip",minVersion:"5.1.0",overrides:{setTarget:function(e){var t,i=this,n=Ext.get(e);i.target&&(t=Ext.get(i.target),i.mun(t,{mouseover:i.onTargetOver,tap:i.onTargetOver,mouseout:i.onTargetOut,mousemove:i.onMouseMove,scope:i})),i.target=n,n&&i.mon(n,{mouseover:i.onTargetOver,tap:i.onTargetOver,mouseout:i.onTargetOut,mousemove:i.onMouseMove,scope:i}),i.anchor&&(i.anchorTarget=i.target)}}}),Ext.define("Sch.mixin.TimelineView",{extend:Sch.mixin.AbstractTimelineView,tip:null,overScheduledEventClass:"sch-event-hover",ScheduleBarEvents:["mousedown","mouseup","click","dblclick","contextmenu"],ResourceRowEvents:["keydown","keyup"],preventOverCls:!1,_initializeTimelineView:function(){this.callParent(arguments),this.on("destroy",this._onDestroy,this),this.on("afterrender",this._onAfterRender,this),this.panel.on("viewready",this._onViewReady,this),this.setMode(this.mode),this.enableBubble("columnwidthchange"),this.addCls("sch-timelineview"),this.readOnly&&this.addCls(this._cmpCls+"-readonly"),this.addCls(this._cmpCls),this.eventAnimations&&this.addCls("sch-animations-enabled")},handleScheduleBarEvent:function(e,t){this.fireEvent(this.scheduledEventName+e.type,this,this.resolveEventRecord(t),e)},handleResourceRowEvent:function(e,t){this.fireEvent(this.scheduledEventName+e.type,this,this.resolveEventRecordFromResourceRow(t),e)},_onDestroy:function(){this.tip&&this.tip.destroy()},_onViewReady:function(){this.touchScroll&&this.getSecondaryCanvasEl().insertBefore(this.getNodeContainer())},_onAfterRender:function(){this.overScheduledEventClass&&this.setMouseOverEnabled(!0),this.tooltipTpl&&("string"==typeof this.tooltipTpl&&(this.tooltipTpl=new Ext.XTemplate(this.tooltipTpl)),this.el.on("mousemove",this.setupTooltip,this,{single:!0}));var e=this.bufferedRenderer;(e&&(this.patchBufferedRenderingPlugin(e),this.patchBufferedRenderingPlugin(this.lockingPartner.bufferedRenderer)),this.on("bufferedrefresh",this.onBufferedRefresh,this,{buffer:10}),this.setupTimeCellEvents(),"absolute"!==this.getSecondaryCanvasEl().getStyle("position").toLowerCase())&&(Ext.Msg||window).alert("ERROR: The CSS file for the Bryntum component has not been loaded.");var t={delegate:this.eventSelector,scope:this},i={delegate:this.rowSelector,scope:this};Ext.Array.forEach(this.ScheduleBarEvents,function(e){t[e]=this.handleScheduleBarEvent},this),Ext.Array.forEach(this.ResourceRowEvents,function(e){i[e]=this.handleResourceRowEvent},this),this.el.on(t),this.el.on(i)},patchBufferedRenderingPlugin:function(e){var t=this,i=e.setBodyTop;e.setBodyTop=function(e,n){var r=i.apply(this,arguments);return t.fireEvent("bufferedrefresh",this),r}},onBufferedRefresh:function(){var e=this.body.dom;if(e){var t=e.style;if(Ext.isIE9m)this.getSecondaryCanvasEl().dom.style.top=this.body.dom.style.top;else{var i,n=t.transform||t.msTransform||t.webkitTransform;n&&(i=/\(-?\d+px,\s*(-?\d+px),\s*(-?\d+)px\)/.exec(n)),i&&(this.getSecondaryCanvasEl().dom.style.top=n?i[1]:e.style.top)}}},setMouseOverEnabled:function(e){this[e?"mon":"mun"](this.el,{mouseover:this.onEventMouseOver,mouseout:this.onEventMouseOut,delegate:this.eventSelector,scope:this})},onEventMouseOver:function(e,t){if(t!==this.lastItem&&!this.preventOverCls){this.lastItem=t,Ext.fly(t).addCls(this.overScheduledEventClass);var i=this.resolveEventRecord(t);i&&this.fireEvent("eventmouseenter",this,i,e)}},onEventMouseOut:function(e,t){this.lastItem&&(e.within(this.lastItem,!0,!0)||(Ext.fly(this.lastItem).removeCls(this.overScheduledEventClass),this.fireEvent("eventmouseleave",this,this.resolveEventRecord(this.lastItem),e),delete this.lastItem))},highlightItem:function(e){if(e){var t=this;t.clearHighlight(),t.highlightedItem=e,Ext.fly(e).addCls(t.overItemCls)}},setupTooltip:function(){var e=this,t=Ext.apply({delegate:e.eventSelector,target:e.el,anchor:"b",rtl:e.rtl,show:function(){if(Ext.ToolTip.prototype.show.apply(this,arguments),this.triggerElement&&"horizontal"===e.getMode()){this.setX(this.targetXY[0]-10);var t=Ext.fly(this.triggerElement).getBox(),i=t.top-this.getHeight()-10;this.setY(i<0?t.bottom+10:i)}}},e.tipCfg);e.tip=new Ext.ToolTip(t),e.tip.on({beforeshow:function(e){if(!e.triggerElement||!e.triggerElement.id)return!1;var t=this.resolveEventRecord(e.triggerElement);if(!t||!1===this.fireEvent("beforetooltipshow",this,t))return!1;var i,n=this.getDataForTooltipTpl(t,e.triggerElement);return!!n&&(!!(i=this.tooltipTpl.apply(n))&&void e.update(i))},scope:this}),Ext.supports.Touch&&e.el.un({touchmove:e.setupTooltip,mousemove:e.setupTooltip,scope:e})},getHorizontalTimeAxisColumn:function(){return this.timeAxisColumn||(this.timeAxisColumn=this.headerCt.down("timeaxiscolumn"),this.timeAxisColumn&&this.timeAxisColumn.on("destroy",function(){this.timeAxisColumn=null},this)),this.timeAxisColumn},getDataForTooltipTpl:function(e,t){return Ext.apply({_record:e},e.data)},refreshKeepingScroll:function(){Ext.suspendLayouts(),this.saveScrollState(),this.refresh(),Ext.resumeLayouts(!0),(0!==this.scrollState.left||0!==this.scrollState.top||this.infiniteScroll)&&this.restoreScrollState()},setupTimeCellEvents:function(){this.mon(this.el,{click:this.handleScheduleEvent,dblclick:this.handleScheduleEvent,contextmenu:this.handleScheduleEvent,pinch:this.handleScheduleEvent,pinchstart:this.handleScheduleEvent,pinchend:this.handleScheduleEvent,scope:this})},getTableRegion:function(){return(this.el.down("."+Ext.baseCSSPrefix+"grid-item-container")||this.el).getRegion()},getRowNode:function(e){return this.getNodeByRecord(e)},findRowByChild:function(e){return this.findItemByChild(e)},getRecordForRowNode:function(e){return this.getRecord(e)},refreshKeepingResourceScroll:function(){var e=this.getScroll();this.refresh(),"horizontal"===this.getMode()?this.scrollVerticallyTo(e.top):this.scrollHorizontallyTo(e.left)},scrollHorizontallyTo:function(e,t){var i=this.getEl();i&&Ext.supports.Touch?this.setScrollX(e):i&&i.scrollTo("left",Math.max(0,e),t)},scrollVerticallyTo:function(e,t){var i=this.getEl();i&&Ext.supports.Touch?this.setScrollY(e):i&&i.scrollTo("top",Math.max(0,e),t)},getVerticalScroll:function(){return this.getEl().getScroll().top},getHorizontalScroll:function(){return this.getEl().getScroll().left},getScroll:function(){var e=this;return{top:e.getScrollY(),left:e.getScrollX()}},handleScheduleEvent:function(){},scrollElementIntoView:function(e,t,i,n,r,a,s){var o,l,d=this,c=e.dom,h=Ext.getDom(d.getEl()),u=e.getOffsetsTo(h),g=d.getScroll(),f=u[0]+g.left,p=u[1]+g.top,m=p+c.offsetHeight,v=f+c.offsetWidth,S=h.clientHeight,y=parseInt(g.top,10),E=parseInt(g.left,10),x=y+S,D=E+h.clientWidth;r=null===r||void 0===r?20:r,c.offsetHeight>S||p<y?l=p-r:m>x&&(l=m-S+r),!1!==t&&c.offsetWidth>h.clientWidth||f<E?o=f-r:!1!==t&&v>D&&(o=v-h.clientWidth+r),i=!0===i&&{}||i,n=!0===n&&{}||n,s=s||d,i&&n?i.listeners=Ext.apply(i.listeners||{},{afteranimate:function(){n.listeners=Ext.apply(n.listeners||{},{afteranimate:function(){a&&a.call(s),a=null}}),Ext.fly(c).highlight(null,n)}}):i?i.listeners=Ext.apply(i.listeners,{afteranimate:function(){a&&a.call(s),a=null}}):n&&(n.listeners=Ext.apply(n.listeners||{},{afteranimate:function(){a&&a.call(s),a=null}})),void 0!==l&&d.setScrollY(l,i),void 0!==o&&d.setScrollX(o,i),!i&&n&&Ext.fly(c).highlight(null,n),!i&&!n&&a&&a.call(s)},disableViewScroller:function(e){var t=this.getScrollable();t&&t.setDisabled(e)}}),Ext.define("Sch.view.TimelineGridView",{extend:Ext.grid.View,mixins:[Sch.mixin.TimelineView],infiniteScroll:!1,bufferCoef:5,bufferThreshold:.2,cachedScrollLeftDate:null,boxIsReady:!1,ignoreNextHorizontalScroll:!1,constructor:function(e){this.callParent(arguments),this.infiniteScroll&&this.on("boxready",this.setupInfiniteScroll,this),this.timeAxisViewModel&&this.relayEvents(this.timeAxisViewModel,["columnwidthchange"])},setupInfiniteScroll:function(){var e=this.panel.ownerCt;if(this.cachedScrollLeftDate=e.startDate||this.timeAxis.getStart(),Ext.supports.Touch&&Ext.os.is.Windows){var t=this.panel.headerCt.scrollable,i=this.scrollable;try{Ext.GlobalEvents.un("idle",t.onIdle,t),Ext.GlobalEvents.un("idle",i.onIdle,i)}catch(e){Ext.log("Cannot unsubscribe required listener, zooming may be broken")}}var n=this;e.calculateOptimalDate_Range=function(e,t,i,r){if(r)return r;var a=Sch.preset.Manager.getPreset(i.preset);return n.calculateInfiniteScrollingDate_Range(e,a.getBottomHeader().unit,i.increment,i.width)},this.bindInfiniteScrollListeners()},bindInfiniteScrollListeners:function(){this.scrollManager?this.scrollManager.scroller.on("scroll",this.onHorizontalScroll,this):this.el.on("scroll",this.onHorizontalScroll,this),this.on("resize",this.onSelfResize,this)},unbindInfiniteScrollListeners:function(){this.scrollManager?this.scrollManager.scroller.un("scroll",this.onHorizontalScroll,this):this.el.un("scroll",this.onHorizontalScroll,this),this.un("resize",this.onSelfResize,this)},onHorizontalScroll:function(){if(this.ignoreNextHorizontalScroll||this.cachedScrollLeftDate)return void(this.ignoreNextHorizontalScroll=!1);var e=this.el.dom,t=this.getWidth(),i=this.getScroll().left,n=this.scrollManager?this.scrollManager.scroller.getMaxPosition().x:e.scrollWidth,r=t*this.bufferThreshold*this.bufferCoef;(n-i-t<r||i<r)&&(this.shiftToDate(this.getDateFromCoordinate(i,null,!0)),this.el.stopAnimation())},refresh:function(){this.callParent(arguments),this.infiniteScroll&&!this.scrollStateSaved&&this.boxIsReady&&this.restoreScrollLeftDate()},onSelfResize:function(e,t,i,n,r){this.boxIsReady=!0,t!==n&&this.shiftToDate(this.cachedScrollLeftDate||this.getVisibleDate_Range().startDate,this.cachedScrollCentered)},restoreScrollLeftDate:function(){this.cachedScrollLeftDate&&this.boxIsReady&&(this.ignoreNextHorizontalScroll=!0,this.scrollToDate(this.cachedScrollLeftDate),this.cachedScrollLeftDate=null)},scrollToDate:function(e){this.cachedScrollLeftDate=e,this.cachedScrollCentered?this.panel.ownerCt.scrollToDateCentered(e):this.panel.ownerCt.scrollToDate(e);var t=this.getScroll().left;this.panel.scrollLeftPos=t,this.headerCt.el.dom.scrollLeft=t},saveScrollState:function(){this.scrollStateSaved=this.boxIsReady,this.callParent(arguments)},restoreScrollState:function(){if(this.scrollStateSaved=!1,this.infiniteScroll&&this.cachedScrollLeftDate)return this.restoreScrollLeftDate(),void(this.el.dom.scrollTop=this.scrollState.top);this.callParent(arguments)},calculateInfiniteScrollingDate_Range:function(e,t,i,n){var r=this.timeAxis,a=this.getWidth();n=n||this.timeAxisViewModel.getTickWidth(),i=i||r.increment||1,t=t||r.unit;var s=Sch.util.Date,o=Math.ceil(a*this.bufferCoef/n);return{start:r.floorDate(s.add(e,t,-o*i),!1,t,i),end:r.ceilDate(s.add(e,t,Math.ceil((a/n+o)*i)),!1,t,i)}},shiftToDate:function(e,t){var i=this.calculateInfiniteScrollingDate_Range(e);this.cachedScrollLeftDate=e,this.cachedScrollCentered=t,this.timeAxis.setTimeSpan(i.start,i.end)},destroy:function(){this.infiniteScroll&&this.rendered&&this.unbindInfiniteScrollListeners(),this.callParent(arguments)}}),Ext.define("Sch.view.Calendar",{view:null,constructor:function(e){Ext.apply(this,e)},getColumnBy:function(e,t){for(var i=this.view.panel.headerCt.getGridColumns(),n=[],r=0;r<i.length;r++)e.call(this,i[r])&&(!0!==t?n.push(i[r]):n.push({column:i[r],index:r}));return n},getEventColumns:function(e,t){return this.getColumnBy(function(t){return!(e.getEndDate()<=t.start||e.getStartDate()>=t.end)},t)},getColumnEvents:function(e){var t=[];return this.view.eventStore.each(function(i){i.getEndDate()<=e.start||i.getStartDate()>=e.end||t.push(i)}),t},getColumnByResource:function(e,t){return this.getColumnBy(function(t){return t.start==e.start},t)[0]},translateToScheduleCoordinate:function(e){var t=this.view;return Ext.isArray(e)?[e[0]-t.getEl().getX()+t.getScroll().left,e[1]-t.getEl().getY()+t.getScroll().top]:e-t.getEl().getY()+t.getScroll().top},translateToPageCoordinate:function(e){var t=this.view,i=t.getEl(),n=i.getScroll();return Ext.isArray(e)?[e[0]+i.getX()-n.left,e[1]+i.getY()-n.top]:e+i.getY()-n.top},getDateFromXY:function(e,t,i){var n=e;return i||(n=this.translateToScheduleCoordinate(n)),this.view.timeAxisViewModel.getDateFromPosition(n,t)},getEventRenderData:function(e,t,i){
var n,r=e.getStartDate(),a=e.getEndDate(),s=this.view,o=s.panel.headerCt.getGridColumns(),l=o[i].start,d=o[i].end,c=Math,h=Math.floor(s.getCoordinateFromDate(Sch.util.Date.max(r,l))),u=Math.floor(s.timeAxisViewModel.getPositionFromDate(Sch.util.Date.min(a,d),!0)),g=this.getCalendarColumnWidth();return 0===u&&(u=s.getStore().getCount()*s.getRowHeight()),n={top:c.max(0,c.min(h,u)-s.eventBorderWidth),height:c.max(1,c.abs(h-u))},s.managedEventSizing&&(n.left=s.barMargin,n.width=g-2*s.barMargin-s.eventBorderWidth),n.start=r,n.end=a,n.startsOutsideView=r<l,n.endsOutsideView=a>d,n},getScheduleRegion:function(e,t){var i=this.view,n=e?this.getColumnByResource(e).getRegion():i.getTableRegion(),r=this.translateToPageCoordinate(0),a=this.translateToPageCoordinate(i.getStore().getCount()*i.getRowHeight()),s=n.left+i.barMargin,o=n.right-i.barMargin;return new Ext.util.Region(Math.min(r,a),o,Math.max(r,a),s)},getCalendarColumnWidth:function(e){return this.view.timeAxisViewModel.calendarColumnWidth},getResourceRegion:function(e,t,i){var n=this.view,r=n.resourceStore.indexOf(e)*this.getCalendarColumnWidth(),a=n.timeAxis.getStart(),s=n.timeAxis.getEnd(),o=t?Sch.util.Date.max(a,t):a,l=i?Sch.util.Date.min(s,i):s,d=Math.max(0,n.getCoordinateFromDate(o)-n.cellTopBorderWidth),c=n.getCoordinateFromDate(l)-n.cellTopBorderWidth,h=r+n.cellBorderWidth,u=r+this.getCalendarColumnWidth()-n.cellBorderWidth;return new Ext.util.Region(Math.min(d,c),u,Math.max(d,c),h)},columnRenderer:function(e,t,i,n,r){var a=this.view,s="";if(0===n){var o,l,d,c;for(o=[],l=this.getColumnEvents(t.column),d=0,c=l.length;d<c;d++){var h=l[d];o.push(a.generateTplData(h,h.getResources()[0]||i,r))}t.column.rendered&&this.getCalendarColumnWidth()!==t.column.getWidth()&&this.setColumnWidth(t.column.getWidth(),!0),a.eventLayout.vertical.applyLayout(o,this.getCalendarColumnWidth()),s="&#160;"+a.eventTpl.apply(o)}return r%2==1&&(t.tdCls=(t.tdCls||"")+" "+a.altColCls,t.cellCls=(t.cellCls||"")+" "+a.altColCls),s},resolveResource:function(e){var t=this.view;if(e=Ext.fly(e).is(t.timeCellSelector)?e:Ext.fly(e).up(t.timeCellSelector)){var i=e.dom?e.dom:e,n=0;if(Ext.isIE8m)for(i=i.previousSibling;i;)1===i.nodeType&&n++,i=i.previousSibling;else n=Ext.Array.indexOf(Array.prototype.slice.call(i.parentNode.children),i);if(n>=0){var r=t.panel.headerCt.getGridColumns()[n];return{start:r.start,end:r.end}}}},onEventUpdate:function(e,t){this.renderSingle(t);var i=this.view;i.getEventSelectionModel().forEachEventRelatedSelection(t,function(e){i.onEventBarSelect(e)})},onEventAdd:function(e,t){var i=this.view;1===t.length?this.renderSingle(t[0]):i.repaintAllEvents()},onEventRemove:function(e,t){var i=this.view;1===t.length?(Ext.each(i.getElementsFromEventRecord(t[0]),function(e){Ext.fly(e).destroy()}),this.relayoutRenderedEvents(t[0])):i.repaintAllEvents()},relayoutRenderedEvents:function(e){var t=this,i=t.getEventColumns(e,!0);Ext.each(i,function(e){t.repaintEventsForColumn(e.column,e.index)})},renderSingle:function(e){var t=this.view;Ext.each(t.getElementsFromEventRecord(e),function(e){Ext.fly(e).destroy()});var i=e.getResources()[0]||t.resourceStore.first(),n=e.previous||{},r=Sch.util.Date,a=new Sch.model.Event({StartDate:r.min(n.StartDate||e.getStartDate(),e.getStartDate()),EndDate:r.max(n.EndDate||e.getEndDate(),e.getEndDate())}),s=this.getEventColumns(a);Ext.each(s,function(n){var r=n.getIndex(),a=this.getColumnEvents(n),s=Ext.Array.map(a,function(a){return a===e?t.generateTplData(e,i,r):{start:a.getStartDate()<n.start?n.start:a.getStartDate(),end:a.getEndDate()>n.end?n.end:a.getEndDate(),event:a}});t.eventLayout.vertical.applyLayout(s,n.getWidth()),Ext.Array.forEach(s,function(i){if(i.event===e){var n=Ext.get(t.getScheduleCell(0,r));n&&(Ext.versions.touch||(n=n.first()),t.eventTpl.append(n,[i]))}else{t.getElementsFromEventRecord(i.event,i.event.getResource(),r)[0].setStyle({left:i.left+"px",width:Math.max(i.width,0)+"px"})}})},this)},repaintEventsForColumn:function(e,t){var i,n,r,a,s,o,l=this,d=l.getColumnEvents(e),c=l.view,h=[];for(i=0,n=d.length;i<n;i++){if(r=d[i],!(a=c.getElementsFromEventRecord(r)[0]))return;var u=a.id.split("-");u.pop(),s=r.getStartDate(),o=r.getEndDate(),h.push({start:s<e.start?e.start:s,end:o>e.end?e.end:o,event:r,id:u.join("-")})}c.eventLayout.vertical.applyLayout(h,e.getWidth());var g=Ext.get(Ext.DomQuery.selectNode("tr:nth-child(1)",c.el.dom));for(i=0;i<h.length;i++){r=h[i];var f=Ext.get(Ext.DomQuery.selectNode("td:nth-child("+(t+1)+") [id^="+r.id+"-]",g.dom));f&&f.setStyle({left:r.left+"px",width:Math.max(r.width,0)+"px"})}},getTimeSpanRegion:function(e,t){var i=this.view,n=i.getCoordinateFromDate(e),r=t?i.getCoordinateFromDate(t,!0,!0):n,a=this.getColumnBy(function(t){return t.start<=e&&t.end>e})[0],s=this.getColumnBy(function(e){return e.start<t&&e.end>=t})[0],o=this.translateToScheduleCoordinate([a.getX(),0]),l=this.translateToScheduleCoordinate([s?s.getRegion().right:a.getWidth()+o[0],0]);return new Ext.util.Region(Math.min(n,r),l[0],Math.max(n,r),o[0])},getStartEndDatesFromRegion:function(e,t,i){var n=this.view.getDateFromCoordinate([e.left,e.top],t),r=this.view.getDateFromCoordinate([e.left,e.bottom],t);return n&&r?{start:Sch.util.Date.min(n,r),end:Sch.util.Date.max(n,r)}:null},setColumnWidth:function(e,t){var i=this.view;i.calendarColumnWidth=e,i.getTimeAxisViewModel().setViewColumnWidth(e,t)},getVisibleDate_Range:function(){var e=this.view;if(!e.rendered)return null;var t=e.getScroll(),i=e.getHeight(),n=e.getTableRegion(),r=e.timeAxis.getEnd();if(n.bottom-n.top<i){return{startDate:e.timeAxis.getStart(),endDate:r}}return{startDate:e.getDateFromCoordinate(t.top,null,!0),endDate:e.getDateFromCoordinate(t.top+i,null,!0)||r}}}),Ext.define("Sch.mixin.SchedulerView",{extend:Sch.mixin.AbstractSchedulerView,mixins:[Sch.mixin.Localizable],eventResizeHandles:"end",dndValidatorFn:Ext.emptyFn,resizeValidatorFn:Ext.emptyFn,createValidatorFn:Ext.emptyFn,calendarViewClass:"Sch.view.Calendar",_initializeSchedulerView:function(){this.callParent(arguments),this.on({destroy:this._destroy,afterrender:this._afterRender,itemupdate:this.onRowUpdated,scope:this}),Ext.getVersion().isGreaterThan("5.1.1")&&this.on("itemadd",function(e){var t=this.all.item(this.all.endIndex-e.length);t&&(t.dom.style.height="")});var e=this;if(!this.eventPrefix)throw"eventPrefix missing";e.eventTpl=e.eventTpl||Ext.create(this.eventTemplateClass,{eventPrefix:this.eventPrefix,resizeHandles:this.eventResizeHandles})},inheritables:function(){return{loadingText:this.L("loadingText"),overItemCls:"",trackOver:!1,selectedItemCls:"",setReadOnly:function(e){this.dragCreator&&this.dragCreator.setDisabled(e),this.callParent(arguments)},repaintEventsForResource:function(e,t){var i=this,n=i.getMode(),r="horizontal"===n,a=r?i.indexOf(e):0;if(r&&i.eventLayout.horizontal.clearCache(e),a>=0&&(Ext.suspendLayouts(),r?(i.refreshNode(e),i.lockingPartner.refreshNode(e)):(i.refreshNode(a),i.lockingPartner.refreshNode(a)),Ext.resumeLayouts(),t)){var s=i.getEventSelectionModel(),o=i.eventStore.getEventsForResource(e);Ext.Array.forEach(o,function(e){s.forEachEventRelatedSelection(e,function(e){i.onEventBarSelect(e,!0)})})}},repaintAllEvents:function(){"horizontal"===this.mode?this.refresh():this.refreshNode(0)},handleScheduleEvent:function(e){var t=e.getTarget("."+this.eventCls,3),i=!t&&e.getTarget("."+this.timeCellCls,3);if(i){var n,r=this.getDateFromDomEvent(e,"floor"),a=this.findRowByChild(i),s=this.indexOf(a);if("horizontal"==this.mode)n=this.getRecordForRowNode(a);else{var o=e.getTarget(this.timeCellSelector,5);if(o){var l="number"==typeof o.cellIndex?o.cellIndex:o.getAttribute("data-cellIndex"),d=this.headerCt.getGridColumns()[l];n=d&&d.model}}e.type.indexOf("pinch")>=0?this.fireEvent("schedule"+e.type,this,e):this.fireEvent("schedule"+e.type,this,r,s,n,e)}},onEventDataRefresh:function(){this.clearRowHeightCache(),this.callParent(arguments)},onUnbindStore:function(e){e.un({refresh:this.clearRowHeightCache,clear:this.clearRowHeightCache,load:this.clearRowHeightCache,scope:this}),this.callParent(arguments)},bindStore:function(e){e&&e.on({refresh:this.clearRowHeightCache,clear:this.clearRowHeightCache,load:this.clearRowHeightCache,scope:this}),this.callParent(arguments)},refreshKeepingScroll:function(){this.lockingPartner.saveScrollState(),this.lockingPartner.refresh(),this.lockingPartner.restoreScrollState(),this.callParent(arguments)}}},getEventSelectionModel:function(){var e,t=this,i=t.eventSelModel,n=t.eventSelModelType;return i&&i.events?i:(i||(i={}),!n&&t.eventStore.getAssignmentStore()?n="assignmentmodel":n||(n="eventmodel"),e="SINGLE",t.simpleSelect?e="SIMPLE":t.multiSelect&&(e="MULTI"),Ext.applyIf(i,{allowDeselect:t.allowDeselect,mode:e}),i.events||(i=t.eventSelModel=Ext.create("selection."+n,i)),t.disableSelection&&(i.locked=!0),i)},_afterRender:function(){this.bindEventStore(this.eventStore,!0),this.getEventSelectionModel().bindToView(this),this.setupEventListeners(),this.configureFunctionality();var e=this.headerCt.resizer;e&&(e.doResize=Ext.Function.createSequence(e.doResize,this.afterHeaderResized,this)),this.on("itemupdate",function(){delete this.lastItem})},_destroy:function(){this.bindEventStore(null)},clearRowHeightCache:function(){"horizontal"===this.mode&&this.eventLayout.horizontal.clearCache()},configureFunctionality:function(){var e=this.validatorFnScope||this;"none"!==this.eventResizeHandles&&Sch.feature.ResizeZone&&(this.resizePlug=new Sch.feature.ResizeZone(Ext.applyIf({schedulerView:this,validatorFn:function(t,i,n,r){return(this.allowOverlap||this.isDate_RangeAvailable(n,r,i,t))&&this.resizeValidatorFn.apply(e,arguments)},validatorFnScope:this},this.resizeConfig||{}))),!1!==this.enableEventDragDrop&&Sch.feature.DragDrop&&(this.dragdropPlug=new Sch.feature.DragDrop(this,{validatorFn:function(t,i,n,r){return(this.allowOverlap||this.isDate_RangeAvailable(n,Sch.util.Date.add(n,Sch.util.Date.MILLI,r),t[0],i))&&this.dndValidatorFn.apply(e,arguments)},validatorFnScope:this,dragConfig:this.dragConfig||{}})),!1!==this.enableDragCreation&&Sch.feature.DragCreator&&(this.dragCreator=new Sch.feature.DragCreator(Ext.applyIf({schedulerView:this,disabled:this.readOnly,validatorFn:function(t,i,n){return(this.allowOverlap||this.isDate_RangeAvailable(i,n,null,t))&&this.createValidatorFn.apply(e,arguments)},validatorFnScope:this},this.createConfig||{})))},onBeforeDragDrop:function(e,t,i){return!this.readOnly&&!i.getTarget().className.match("sch-resizable-handle")},onDragDropStart:function(){this.dragCreator&&this.dragCreator.setDisabled(!0),this.tip&&(this.tip.hide(),this.tip.disable()),this.overScheduledEventClass&&this.setMouseOverEnabled(!1)},onDragDropEnd:function(){this.dragCreator&&this.dragCreator.setDisabled(!1),this.tip&&this.tip.enable(),this.overScheduledEventClass&&this.setMouseOverEnabled(!0)},onBeforeDragCreate:function(e,t,i,n){return!this.readOnly&&!n.ctrlKey},onDragCreateStart:function(){this.overScheduledEventClass&&this.setMouseOverEnabled(!1),this.tip&&(this.tip.hide(),this.tip.disable()),this.disableViewScroller(!0)},onDragCreateEnd:function(e,t,i){if(!this.getEventEditor()){var n=i?[i]:[];!1!==this.fireEvent("beforeeventadd",this,t,n)&&(this.onEventCreated(t),this.eventStore.append(t),t.assign(i)),this.dragCreator.getProxy().hide()}this.overScheduledEventClass&&this.setMouseOverEnabled(!0)},onEventCreated:function(e){},onAfterDragCreate:function(){this.overScheduledEventClass&&this.setMouseOverEnabled(!0),this.tip&&this.tip.enable(),this.disableViewScroller(!1)},onBeforeResize:function(){return!this.readOnly},onResizeStart:function(){this.tip&&(this.tip.hide(),this.tip.disable()),this.dragCreator&&this.dragCreator.setDisabled(!0),this.disableViewScroller(!0)},onResizeEnd:function(){this.tip&&this.tip.enable(),this.dragCreator&&this.dragCreator.setDisabled(!1),this.disableViewScroller(!1)},setupEventListeners:function(){this.on({beforeeventdrag:this.onBeforeDragDrop,eventdragstart:this.onDragDropStart,aftereventdrop:this.onDragDropEnd,beforedragcreate:this.onBeforeDragCreate,dragcreatestart:this.onDragCreateStart,dragcreateend:this.onDragCreateEnd,afterdragcreate:this.onAfterDragCreate,beforeeventresize:this.onBeforeResize,eventresizestart:this.onResizeStart,eventresizeend:this.onResizeEnd,scope:this})},afterHeaderResized:function(){var e=this.headerCt.resizer;if(e&&"horizontal"!==this.getMode())if(this.panel.forceFit)this.setColumnWidth(e.origWidth);else{var t=e.dragHd.getWidth();this.setColumnWidth(t)}},columnRenderer:function(e,t,i,n,r){return this[this.mode].columnRenderer(e,t,i,n,r)},onRowUpdated:function(e){var t,i=this;"horizontal"===i.getMode()&&i.hasListener("eventrepaint")&&Ext.Array.forEach(e.getEvents(),function(n){t=i.getElementsFromEventRecord(n,e,null,!0),Ext.Array.forEach(t,function(e){i.fireEvent("eventrepaint",i,n,e)})})},scrollResourceEventIntoView:function(e,t,i,n,r,a,s){var o,l,d=this,c=t.getStartDate(),h=t.getEndDate(),u=function(){l=d.getElementsFromEventRecord(t,e,i),l=l.length&&l[0]||null,d.scrollElementIntoView(l,!0,r,n,null,a,s)};Ext.data.TreeStore&&d.resourceStore instanceof Ext.data.TreeStore&&e.bubble(function(e){e.expand()}),d.timeAxis.dateInAxis(c)&&d.timeAxis.dateInAxis(h)||(o=d.timeAxis.getEnd()-d.timeAxis.getStart(),d.timeAxis.setTimeSpan(new Date(c.valueOf()-o/2),new Date(h.getTime()+o/2)),d.up("panel").scrollTask.cancel()),"horizontal"===this.getOrientation()?d.up("timelinegrid,timelinetree").ensureVisible(e,{callback:function(){!1===this.isLocked&&u()}}):u()}}),Ext.define("Sch.view.SchedulerGridView",{extend:Sch.view.TimelineGridView,mixins:[Sch.mixin.SchedulerView,Sch.mixin.Localizable],alias:"widget.schedulergridview"},function(){this.override(Sch.mixin.SchedulerView.prototype.inheritables()||{})}),Ext.define("Sch.selection.EventModel",{extend:Ext.selection.Model,alias:"selection.eventmodel",deselectOnContainerClick:!0,selectedOnMouseDown:!1,bindToView:function(e){var t=this;t.view=e;var i=e.eventStore,n=e.resourceStore;t.bindStore(i),e.mon(n,"beforeload",t.clearSelectionOnRefresh,t),e.mon(i,"beforeload",t.clearSelectionOnRefresh,t),e.on({eventclick:t.onEventClick,eventmousedown:t.onEventMouseDown,itemmousedown:t.onItemMouseDown,refresh:function(){t.refresh()},destroy:function(){t.bindStore(null)},scope:t})},clearSelectionOnRefresh:function(){this.clearSelections()},onEventMouseDown:function(e,t,i){this.selectedOnMouseDown=null,this.isSelected(t)||(this.selectedOnMouseDown=t,this.selectWithEvent(t,i))},onEventClick:function(e,t,i){this.selectedOnMouseDown||this.selectWithEvent(t,i)},onItemMouseDown:function(e,t,i,n,r){this.deselectOnContainerClick&&!r.getTarget(this.view.eventSelector)&&this.deselectAll()},onSelectChange:function(e,t,i,n){var r=this,a=r.view,s=(r.store,t?"select":"deselect");!1!==(i||r.fireEvent("before"+s,r,e))&&!1!==n()&&(t?a.onEventBarSelect(e,i):a.onEventBarDeselect(e,i),i||r.fireEvent(s,r,e))},selectRange:Ext.emptyFn,selectNode:function(e,t,i){var n=this.view.resolveEventRecord(e);n&&this.select(n,t,i)},deselectNode:function(e,t,i){var n=this.view.resolveEventRecord(e);n&&this.deselect(n,i)},getFirstSelectedEventForResource:function(e){var t,i,n,r=this.getSelection(),a=null;for(t=0,i=r.length;!a&&t<i;++t)n=r[t],n.isAssignedTo(e)&&(a=n);return a},getDraggableSelections:function(){return Ext.Array.filter(this.getSelection(),function(e){return e.isDraggable()})},forEachEventRelatedSelection:function(e,t){this.isSelected(e)&&t(e)}}),Ext.define("Sch.selection.AssignmentModel",{extend:Sch.selection.EventModel,alias:"selection.assignmentmodel",assignmentStoreDetacher:null,destroy:function(){var e=this;Ext.destroyMembers(e,"assignmentStoreDetacher"),e.callParent()},bindToView:function(e){var t,i,n=this;n.callParent([e]),t=n.view.eventStore,(i=t.getAssignmentStore())&&(n.assignmentStoreDetacher=i.on({remove:n.onAssignmentStoreRemove,clear:n.onAssignmentStoreClear,refresh:n.onAssignmentStoreRefresh,scope:n,destroyable:!0}))},selectWithEvent:function(e,t){var i,n,r=this,a=r.view,s=a.resolveResource(t.getTarget());s&&(i=a.eventStore.getAssignmentStore(),(n=i.getAssignmentForEventAndResource(e,s))&&r.callParent([n,t]))},getFirstSelectedEventForResource:function(e){var t,i,n,r=this.getSelection(),a=null;for(t=0,i=r.length;!a&&t<i;++t)n=r[t],n.getEvent().isAssignedTo(e)&&(a=n);return a},getDraggableSelections:function(){return Ext.Array.filter(this.getSelection(),function(e){return e.getEvent().isDraggable()})},forEachEventRelatedSelection:function(e,t){Ext.Array.forEach(this.getSelection(),function(i){i.getEvent()===e&&t(i)})},onAssignmentStoreRemove:function(e,t){this.deselect(t,!0)},onAssignmentStoreClear:function(e){this.clearSelections()},onAssignmentStoreRefresh:function(e){this.clearSelections()}}),Ext.define("Sch.mixin.SchedulerPanel",{extend:Sch.mixin.AbstractSchedulerPanel,eventSelModelType:null,eventSelModel:null,enableEventDragDrop:!0,enableDragCreation:!0,dragConfig:null,componentCls:"sch-schedulerpanel",lockedGridDependsOnSchedule:!0,verticalListeners:null,horizontalLockedWidth:null,inheritables:function(){return{variableRowHeight:!0,initComponent:function(){var e=this.normalViewConfig=this.normalViewConfig||{};this._initializeSchedulerPanel(),this.verticalListeners={clear:this.refreshResourceColumns,datachanged:this.refreshResourceColumns,update:this.refreshResourceColumns,load:this.refreshResourceColumns,scope:this},this.calendarListeners={reconfigure:this.refreshCalendarColumns,priority:1,scope:this},this.normalGridListeners={resize:this.onScheduleResize,scope:this},Ext.apply(e,{eventStore:this.eventStore,resourceStore:this.resourceStore,eventBarTextField:this.eventBarTextField||this.eventStore.model.prototype.nameField}),Ext.Array.forEach(["barMargin","eventBodyTemplate","eventTpl","allowOverlap","dragConfig","eventBarIconClsField","onEventCreated","constrainDragToResource","snapRelativeToEventStartDate","eventSelModelType","simpleSelect","multiSelect","allowDeselect"],function(t){t in this&&(e[t]=this[t])},this),this.callParent(arguments),"vertical"===this.mode&&this.mon(this.resourceStore,this.verticalListeners);var t=this.lockedGrid.getView(),i=this.getSchedulingView();if(this.registerRenderer(i.columnRenderer,i),this.resourceZones){var n=Ext.StoreManager.lookup(this.resourceZones);n.setResourceStore(this.resourceStore),this.resourceZonesPlug=new Sch.plugin.ResourceZones(Ext.apply({store:n},this.resourceZonesConfig)),this.resourceZonesPlug.init(this)}i.on("columnwidthchange",this.onColWidthChange,this),this.relayEvents(i,["eventclick","eventmousedown","eventmouseup","eventdblclick","eventcontextmenu","eventmouseenter","eventmouseleave","eventkeydown","eventkeyup","beforeeventresize","eventresizestart","eventpartialresize","beforeeventresizefinalize","eventresizeend","beforeeventdrag","eventdragstart","eventdrag","beforeeventdropfinalize","eventdrop","aftereventdrop","beforedragcreate","dragcreatestart","beforedragcreatefinalize","dragcreateend","afterdragcreate","beforeeventadd"]),this.syncRowHeight||this.enableRowHeightInjection(t,i)},applyViewSettings:function(e,t){this.callParent(arguments);var i,n=this.getSchedulingView();t=t||!this.rendered,"vertical"===this.orientation&&(i=e.timeColumnWidth||60,n.setColumnWidth(e.resourceColumnWidth||100,!0),n.setRowHeight(i,!0))},afterRender:function(){this.callParent(arguments),"calendar"===this.mode&&(this.mon(this.timeAxis,this.calendarListeners),this.normalGrid.on(this.normalGridListeners)),this.getSchedulingView().on({eventdragstart:this.doSuspendLayouts,aftereventdrop:this.doResumeLayouts,eventresizestart:this.doSuspendLayouts,eventresizeend:this.doResumeLayouts,scope:this}),this.lockedGridDependsOnSchedule&&this.normalGrid.getView().on("itemupdate",this.onNormalViewItemUpdate,this),this.relayEvents(this.getEventSelectionModel(),["selectionchange","deselect","select"],"event")},getTimeSpanDefiningStore:function(){return this.eventStore}}},doSuspendLayouts:function(){var e=this.getSchedulingView();e.infiniteScroll&&e.timeAxis.on({beginreconfigure:this.onBeginReconfigure,endreconfigure:this.onEndReconfigure,scope:this}),this.lockedGrid.suspendLayouts(),this.normalGrid.suspendLayouts()},doResumeLayouts:function(){var e=this.getSchedulingView();e.infiniteScroll&&e.timeAxis.un({beginreconfigure:this.onBeginReconfigure,endreconfigure:this.onEndReconfigure,scope:this}),this.lockedGrid.resumeLayouts(),this.normalGrid.resumeLayouts()},onBeginReconfigure:function(){this.normalGrid.resumeLayouts()},onEndReconfigure:function(){this.normalGrid.suspendLayouts()},onColWidthChange:function(e,t){switch(this.getMode()){case"vertical":this.resourceColumnWidth=t,this.refreshResourceColumns();break;case"calendar":this.calendarColumnWidth=t,this.refreshCalendarColumns()}},enableRowHeightInjection:function(e,t){var i=this,n=new Ext.XTemplate("{%","this.processCellValues(values);","this.nextTpl.applyOut(values, out, parent);","%}",{priority:1,processCellValues:function(e){if("horizontal"===t.mode){var n=1;if(t.dynamicRowHeight){var r=e.record;n=t.eventLayout.horizontal.getNumberOfBands(r,function(){return t.eventStore.filterEventsForResource(r,t.timeAxis.isRangeInAxis,t.timeAxis)})}var a=n*i.getRowHeight()-(n-1)*t.barMargin-t.cellTopBorderWidth-t.cellBottomBorderWidth;e.style=(e.style||"")+";height:"+a+"px;"}}});e.addCellTpl(n),Ext.Array.forEach(e.getColumnManager().getColumns(),function(e){e.hasCustomRenderer=!0}),e.store.un("refresh",e.onDataRefresh,e),e.mon(e.store,"refresh",e.onDataRefresh,e)},getEventSelectionModel:function(){return this.getSchedulingView().getEventSelectionModel()},refreshResourceColumns:function(){var e=this.resourceColumnWidth||this.timeAxisViewModel.resourceColumnWidth;this.normalGrid.reconfigure(null,this.createResourceColumns(e))},onScheduleResize:function(){var e=this.normalGrid.down("gridcolumn").getWidth();this.timeAxisViewModel.setViewColumnWidth(e,!0),this.getSchedulingView().refresh()},refreshCalendarColumns:function(){var e=this.createCalendarRows(),t=this.createCalendarColumns();this.reconfigure(e,this.calendarColumns.concat(t))},setOrientation:function(){this.setMode.apply(this,arguments)},setMode:function(e,t){if(!this.normalGrid)return void this.on("afterrender",function(){this.setMode(e,!0)});if(e!==this.mode||t){switch(e){case"horizontal":this.addCls("sch-horizontal"),this.removeCls(["sch-vertical","sch-calendar","sch-vertical-resource"]);break;case"vertical":this.addCls(["sch-vertical-resource","sch-vertical"]),this.removeCls(["sch-calendar","sch-horizontal"]);break;case"calendar":this.addCls(["sch-calendar","sch-vertical"]),this.removeCls(["sch-vertical-resource","sch-horizontal"])}this.mode=e;var i=this,n=function(){return!1},r=i.normalGrid,a=i.lockedGrid.getView(),s=i.getSchedulingView(),o=r.headerCt;if(a.on("beforerefresh",n),s.on("beforerefresh",n),s.blockRefresh=a.blockRefresh=!0,s.setMode(e),Ext.suspendLayouts(),o.removeAll(!0),Ext.resumeLayouts(),"calendar"!==e?(i.timeAxis.setMode("plain"),i.mun(i.timeAxis,i.calendarListeners),i._oldViewPreset&&(i.setViewPreset.apply(i,i._oldViewPreset),delete i._oldViewPreset)):(i._oldViewPreset=[i.viewPreset,i.timeAxis.getStart(),i.timeAxis.getEnd()],i.timeAxis.setMode("calendar"),i.setViewPreset(i.calendarViewPreset),i.mon(i.timeAxis,i.calendarListeners)),"horizontal"===e)i.mun(i.resourceStore,i.verticalListeners),i.normalGrid.un(i.normalGridListeners),s.setRowHeight(i.rowHeight||i.timeAxisViewModel.rowHeightHorizontal,!0),i.reconfigure(i.resourceStore,i.horizontalColumns),null!==this.horizontalLockedWidth&&this.lockedGrid.setWidth(this.horizontalLockedWidth);else if("calendar"===e)i.mun(i.resourceStore,i.verticalListeners),i.normalGrid.on(i.normalGridListeners),i.refreshCalendarColumns(),s.setRowHeight(i.rowHeight||i.timeAxisViewModel.rowHeightVertical,!0),s.setColumnWidth(i.timeAxisViewModel.calendarColumnWidth||100,!0);else{i.normalGrid.un(i.normalGridListeners);var l=0;this.horizontalLockedWidth=this.lockedGrid.getWidth(),i.mon(i.resourceStore,i.verticalListeners),i.reconfigure(i.timeAxis,i.verticalColumns.concat(i.createResourceColumns(i.resourceColumnWidth||i.timeAxisViewModel.resourceColumnWidth))),Ext.Array.forEach(i.lockedGrid.query("gridcolumn"),function(e){l+=e.rendered?e.getWidth():e.width||100}),s.setColumnWidth(i.timeAxisViewModel.resourceColumnWidth||100,!0),i.lockedGrid.setWidth(l)}a.un("beforerefresh",n),s.un("beforerefresh",n),s.blockRefresh=a.blockRefresh=!1,i.getView().refresh(),this.fireEvent("modechange",this,e),this.fireEvent("orientationchange",this,e)}},createCalendarRows:function(){var e=this,t=e.timeAxis.getRowTicks();return e.timeAxisViewModel.calendarRowsAmount=t.length,new Ext.data.Store({model:"Sch.model.TimeAxisTick",data:t})},createCalendarColumns:function(){var e=this,t=e.timeAxis.headerConfig.middle,i=[];return e.timeAxis.forEachAuxInterval(t.splitUnit,null,function(n,r,a){n.setHours(this.startTime),r=new Date(n),r.setHours(this.endTime);var s={xtype:"weekview-day",renderer:e.mainRenderer,scope:e,start:n,end:r};t.renderer?s.text=t.renderer.call(t.scope||e,n,r,s,a,e.eventStore):s.text=Ext.Date.format(n,t.dateFormat),i.push(s)}),i},setRowHeight:function(e,t){t=t||!this.lockedGrid,this.timeAxisViewModel.setViewRowHeight(e,t)},onNormalViewItemUpdate:function(e,t,i){if(this.lockedGridDependsOnSchedule){var n=this.lockedGrid.getView();n.suspendEvents(),n.refreshNode(n.indexOf(e)),n.resumeEvents()}}}),Ext.define("Sch.patches.NodeCache",{extend:Sch.util.Patch,target:"Ext.view.NodeCache",minVersion:"5.1.0",overrides:{scroll:function(e,t,i){return 0===e.length?[]:this.callParent(arguments)}}}),Ext.define("Sch.patches.BufferedRenderer",{extend:Sch.util.Patch,target:"Ext.grid.plugin.BufferedRenderer",overrides:{onRangeFetched:function(){return this.tableTopBorderWidth=this.tableTopBorderWidth||0,this.callParent(arguments)},refreshSize:function(e,t){this.view.body.dom&&this.callParent(arguments)}}}),Ext.define("Sch.patches.RowSynchronizer",{extend:Sch.util.Patch,target:"Ext.grid.locking.RowSynchronizer",minVersion:"5.1.0",overrides:Ext.versions.extjs.isGreaterThan("5.1.0")?{finish:function(e){if(e)return this.callParent(arguments)}}:{}}),Ext.define("Sch.patches.Chrome",{extend:Sch.util.Patch,minVersion:"5.1.0",applyFn:function(){Ext.isChrome&&Ext.browser.version.isGreaterThanOrEqual("43")&&Ext.util.CSS.createStyleSheet(".sch-timelinepanel ."+Ext.baseCSSPrefix+"form-text { display: inherit; }")}}),Ext.define("Sch.patches.Explorer",{extend:Sch.util.Patch,minVersion:"6.0.0",applyFn:function(){Ext.isIE9m&&Ext.util.CSS.createStyleSheet("."+Ext.baseCSSPrefix+"column-header-trigger { z-index: 10; }")}}),Ext.define("Sch.mixin.TimelinePanel",{extend:Sch.mixin.AbstractTimelinePanel,mixins:[Sch.mixin.Zoomable],bufferCoef:5,bufferThreshold:.2,infiniteScroll:!1,showCrudManagerMask:!0,waitingForAutoTimeSpan:!1,columnLinesFeature:null,renderWaitListener:null,schedulePinchThreshold:30,pinchStartDistanceX:null,pinchStartDistanceY:null,pinchDistanceX:null,pinchDistanceY:null,horizontalColumns:null,verticalColumns:null,calendarColumns:null,forceDefineTimeSpanByStore:!1,split:!0,tipCfg:{cls:"sch-tip",showDelay:1e3,hideDelay:0,autoHide:!0,anchor:"b"},inheritables:function(){return{columnLines:!0,enableLocking:!0,lockable:!0,stateEvents:["viewchange"],syncRowHeight:!1,cellTopBorderWidth:0,initComponent:function(){this.partnerTimelinePanel&&("string"==typeof this.partnerTimelinePanel&&(this.partnerTimelinePanel=Ext.getCmp(this.partnerTimelinePanel)),this.timeAxisViewModel=this.partnerTimelinePanel.timeAxisViewModel,this.timeAxis=this.partnerTimelinePanel.getTimeAxis(),this.startDate=this.timeAxis.getStart(),this.endDate=this.timeAxis.getEnd()),this._initializeTimelinePanel(),this.configureChildGrids(),this.forceFit=!1,this.configureColumns();var e=this.normalViewConfig=this.normalViewConfig||{},t=this.getId();if(Ext.apply(this.normalViewConfig,{id:t+"-timelineview",eventPrefix:this.autoGenId?null:t,timeAxisViewModel:this.timeAxisViewModel,eventBorderWidth:this.eventBorderWidth,timeAxis:this.timeAxis,readOnly:this.readOnly,mode:this.mode,rtl:this.rtl,cellBorderWidth:this.cellBorderWidth,cellTopBorderWidth:this.cellTopBorderWidth,cellBottomBorderWidth:this.cellBottomBorderWidth,infiniteScroll:this.infiniteScroll,bufferCoef:this.bufferCoef,bufferThreshold:this.bufferThreshold}),Ext.Array.forEach(["eventRendererScope","eventRenderer","dndValidatorFn","resizeValidatorFn","createValidatorFn","tooltipTpl","validatorFnScope","eventResizeHandles","enableEventDragDrop","enableDragCreation","resizeConfig","createConfig","tipCfg","getDateConstraints"],function(t){t in this&&(e[t]=this[t])},this),this.callParent(arguments),this.rtl?(this.lockedGrid.view.addCls("sch-locked-column-fixer"),this.addCls("sch-rtl")):this.addCls("sch-ltr"),this.patchNavigationModel(this),this.setViewPreset(this.viewPreset,this.startDate||this.timeAxis.getStart(),this.endDate||this.timeAxis.getEnd(),!0),!this.startDate){var i=this.getTimeSpanDefiningStore();(Ext.data.TreeStore&&i instanceof Ext.data.TreeStore?i.getRootNode().childNodes.length:i.getCount())?this.applyStartEndDatesFromStore():(i.isLoading()||this.forceDefineTimeSpanByStore)&&this.bindAutoTimeSpanListeners()}var n=this.columnLines;n&&(this.columnLinesFeature=new Sch.feature.ColumnLines(Ext.isObject(n)?n:void 0),this.columnLinesFeature.init(this),this.columnLines=!0),this.relayEvents(this.getSchedulingView(),["beforetooltipshow","scheduleclick","scheduledblclick","schedulecontextmenu","schedulepinch","schedulepinchstart","schedulepinchend"]),this.on("boxready",this.__onBoxReady,this),this.on("zoomchange",function(){this.normalGrid.scrollTask.cancel()}),this.crudManager&&!this.crudManager.autoSync&&this.showCrudManagerMask&&(this.mon(this.crudManager,{beforesend:this.beforeCrudOperationStart,synccanceled:this.onCrudOperationComplete,loadcanceled:this.onCrudOperationComplete,load:this.onCrudOperationComplete,sync:this.onCrudOperationComplete,loadfail:this.onCrudOperationComplete,syncfail:this.onCrudOperationComplete,scope:this}),this.crudManager.isLoading()&&this.beforeCrudOperationStart(this.crudManager,null,"load")),this.afterInitComponent()},getState:function(){var e=this,t=e.callParent(arguments);return Ext.apply(t,{viewPreset:e.viewPreset,startDate:e.getStart(),endDate:e.getEnd(),zoomMinLevel:e.zoomMinLevel,zoomMaxLevel:e.zoomMaxLevel,currentZoomLevel:e.currentZoomLevel}),t},applyState:function(e){var t=this;t.callParent(arguments),e&&e.viewPreset&&t.setViewPreset(e.viewPreset,e.startDate,e.endDate),e&&e.currentZoomLevel&&t.zoomToLevel(e.currentZoomLevel)},setTimeSpan:function(){this.callParent(arguments),this.waitingForAutoTimeSpan&&(this.unbindAutoTimeSpanListeners(),this.getView().refresh()),this.normalGrid.getView().viewReady||this.getView().refresh()}}},bindAutoTimeSpanListeners:function(){var e=this.getTimeSpanDefiningStore();this.waitingForAutoTimeSpan=!0,this.normalGrid.getView().on("beforerefresh",this.refreshStopper,this),this.lockedGrid.getView().on("beforerefresh",this.refreshStopper,this),this.mon(e,"load",this.applyStartEndDatesFromStore,this),Ext.data.TreeStore&&e instanceof Ext.data.TreeStore?(this.mon(e,"rootchange",this.applyStartEndDatesFromStore,this),this.mon(e,"nodeappend",this.applyStartEndDatesAfterTreeAppend,this)):this.mon(e,"add",this.applyStartEndDatesFromStore,this)},refreshStopper:function(e){return!1},getTimeSpanDefiningStore:function(){throw"Abstract method called"},unbindAutoTimeSpanListeners:function(){this.waitingForAutoTimeSpan=!1;var e=this.getTimeSpanDefiningStore();this.normalGrid.getView().un("beforerefresh",this.refreshStopper,this),this.lockedGrid.getView().un("beforerefresh",this.refreshStopper,this),e.un("load",this.applyStartEndDatesFromStore,this),Ext.data.TreeStore&&e instanceof Ext.data.TreeStore?(e.un("rootchange",this.applyStartEndDatesFromStore,this),e.un("nodeappend",this.applyStartEndDatesAfterTreeAppend,this)):e.un("add",this.applyStartEndDatesFromStore,this)},applyStartEndDatesAfterTreeAppend:function(){var e=this.getTimeSpanDefiningStore();e.isSettingRoot||e.__loading||this.applyStartEndDatesFromStore()},
applyStartEndDatesFromStore:function(){var e=this.getTimeSpanDefiningStore(),t=e.getTotalTimeSpan();t.end&&t.start&&t.end-t.start==0&&(t.start=Sch.util.Date.add(t.start,this.timeAxis.mainUnit,-1),t.end=Sch.util.Date.add(t.end,this.timeAxis.mainUnit,1)),this.setTimeSpan(t.start||new Date,t.end)},onLockedGridItemDblClick:function(e,t,i,n,r){"vertical"===this.mode&&t&&this.fireEvent("timeheaderdblclick",this,t.get("start"),t.get("end"),n,r)},getSchedulingView:function(){return this.normalGrid.getView()},getHorizontalTimeAxisColumn:function(){return this.getSchedulingView().getHorizontalTimeAxisColumn()},configureColumns:function(){var e=this.columns||[];e=e.items?e.items:this.columns=e.slice();var t=[],i=[];Ext.Array.forEach(e,function(e){"right"===e.position?(Ext.isNumber(e.width)||Ext.Error.raise('"Right" columns must have a fixed width'),e.locked=!1,i.push(e)):(e.locked=!0,t.push(e)),e.lockable=!1}),Ext.Array.erase(e,0,e.length),Ext.Array.insert(e,0,t.concat({xtype:"timeaxiscolumn",timeAxisViewModel:this.timeAxisViewModel,trackHeaderOver:this.trackHeaderOver,renderer:this.mainRenderer,scope:this}).concat(i)),this.horizontalColumns=Ext.Array.clone(e),this.verticalColumns=[Ext.apply({xtype:"verticaltimeaxis",width:100,timeAxis:this.timeAxis,timeAxisViewModel:this.timeAxisViewModel,cellTopBorderWidth:this.cellTopBorderWidth,cellBottomBorderWidth:this.cellBottomBorderWidth},this.timeAxisColumnCfg||{})],this.calendarColumns=[Ext.apply({xtype:"verticaltimeaxis",width:60,timeAxis:this.timeAxis,timeAxisViewModel:this.timeAxisViewModel,cellTopBorderWidth:this.cellTopBorderWidth,cellBottomBorderWidth:this.cellBottomBorderWidth},this.calendarTimeAxisCfg||{})],"vertical"===this.mode?(this.columns=this.verticalColumns.concat(this.createResourceColumns(this.resourceColumnWidth||this.timeAxisViewModel.resourceColumnWidth)),this.store=this.timeAxis):"calendar"===this.mode&&(this.columns=[],this.store=null,this.on("afterrender",this.refreshCalendarColumns,this))},mainRenderer:function(e,t,i,n,r){var a=this.renderers,s="horizontal"===this.mode||"calendar"===this.mode?i:this.resourceStore.getAt(r),o="&nbsp;";t.rowHeight=null;for(var l=0;l<a.length;l++)o+=a[l].fn.call(a[l].scope||this,e,t,s,n,r)||"";if(this.variableRowHeight){var d=this.getSchedulingView(),c=this.getRowHeight();t.style="height:"+((t.rowHeight||c)-d.cellTopBorderWidth-d.cellBottomBorderWidth)+"px"}return o},__onBoxReady:function(){var e=this;e.normalGrid.on({collapse:e.onNormalGridCollapse,expand:e.onNormalGridExpand,scope:e}),e.lockedGrid.on({collapse:e.onLockedGridCollapse,itemdblclick:e.onLockedGridItemDblClick,scope:e}),this.partnerTimelinePanel&&(this.partnerTimelinePanel.rendered?this.setupPartnerTimelinePanel():this.partnerTimelinePanel.on("boxready",this.setupPartnerTimelinePanel,this)),Ext.supports.Touch&&this.getSchedulingView().on({schedulepinchstart:this.onSchedulePinchStart,schedulepinch:this.onSchedulePinch,schedulepinchend:this.onSchedulePinchEnd,scope:this})},onLockedGridCollapse:function(){this.normalGrid.collapsed&&this.normalGrid.expand()},onNormalGridCollapse:function(){var e=this;e.normalGrid.reExpander||(e.normalGrid.reExpander=e.normalGrid.placeholder),e.lockedGrid.rendered?(e.lockedGrid.flex=1,e.lockedGrid.updateLayout(),e.lockedGrid.collapsed&&e.lockedGrid.expand(),e.addCls("sch-normalgrid-collapsed")):e.lockedGrid.on("render",e.onNormalGridCollapse,e,{delay:1})},onNormalGridExpand:function(){this.removeCls("sch-normalgrid-collapsed"),delete this.lockedGrid.flex,this.lockedGrid.updateLayout()},onPartnerCollapseExpand:function(e){e.getCollapsed()?this.lockedGrid.collapse():this.lockedGrid.expand()},setupPartnerTimelinePanel:function(){var e=this.partnerTimelinePanel,t=e.down("splitter"),i=this.down("splitter");t&&t.on("dragend",function(){this.lockedGrid.setWidth(e.lockedGrid.getWidth())},this),i&&i.on("dragend",function(){e.lockedGrid.setWidth(this.lockedGrid.getWidth())},this);var n=e.isVisible()?e.lockedGrid.getWidth():e.lockedGrid.width;e.lockedGrid.getCollapsed()?e.lockedGrid.on("viewready",function(e){this.lockedGrid.setWidth(e.getWidth())},this):this.lockedGrid.setWidth(n),this.on("afterlayout",function(){e.lockedGrid.getCollapsed()?this.lockedGrid.collapse():(this.lockedGrid.expand(),this.lockedGrid.setWidth(n))},this,{single:!0}),e.lockedGrid.on({collapse:this.onPartnerCollapseExpand,expand:this.onPartnerCollapseExpand,scope:this}),this.lockedGrid.on({collapse:this.onPartnerCollapseExpand,expand:this.onPartnerCollapseExpand,scope:e});var r,a=e.getSchedulingView(),s=a.scrollManager?a.scrollManager.scroller:a.getEl(),o=this.getSchedulingView(),l=o.scrollManager?o.scrollManager.scroller:o.getEl(),d=Ext.Function.createBuffered(function(){r=null},300),c=function(e,t){var i=t.id===o.id?o:a,n=t.id===o.id?a:o;r||(r=i),d(),n!==r&&n.setScrollX(i.getScroll().left)};a.mon(l,"scroll",c),o.mon(s,"scroll",c),e.on("beforezoomchange",function(){var e=o.getScrollable(),t=e.suspendPartnerSync;e.suspendPartnerSync=Ext.emptyFn,e.on("scrollend",function(){e.suspendPartnerSync=t},o,{single:!0})}),this.on("beforezoomchange",function(){var e=a.getScrollable(),t=e.suspendPartnerSync;e.suspendPartnerSync=Ext.emptyFn,e.on("scrollend",function(){e.suspendPartnerSync=t},a,{single:!0})}),this.on("viewchange",function(){e.viewPreset=this.viewPreset},this),e.on("viewchange",function(){this.viewPreset=e.viewPreset},this)},beforeCrudOperationStart:function(e,t,i){this.rendered?this.setLoading({msg:"load"===i?this.L("loadingText"):this.L("savingText")}):(Ext.destroy(this.renderWaitListener),this.renderWaitListener=this.on("render",Ext.Function.bind(this.beforeCrudOperationStart,this,Array.prototype.slice.apply(arguments)),this,{delay:1,destroyable:!0}))},onCrudOperationComplete:function(){Ext.destroy(this.renderWaitListener),this.setLoading(!1)},onSchedulePinchStart:function(e,t){this.pinchStartDistanceX=Math.abs(t.touches[0].pageX-t.touches[1].pageX),this.pinchStartDistanceY=Math.abs(t.touches[0].pageY-t.touches[1].pageY)},onSchedulePinch:function(e,t){this.pinchDistanceX=Math.abs(t.touches[0].pageX-t.touches[1].pageX),this.pinchDistanceY=Math.abs(t.touches[0].pageY-t.touches[1].pageY)},onSchedulePinchEnd:function(e,t){var i=this.pinchDistanceX,n=this.pinchDistanceY,r="h"===this.getMode()[0];if(Math.abs(i-this.pinchStartDistanceX)>this.schedulePinchThreshold){var a=Math.abs(i/this.pinchStartDistanceX);r?a>1?this.zoomIn():this.zoomOut():this.timeAxisViewModel.setViewColumnWidth(a*this.timeAxisViewModel.resourceColumnWidth)}if(Math.abs(n-this.pinchStartDistanceY)>this.schedulePinchThreshold){var s=Math.abs(n/this.pinchStartDistanceY);e.setRowHeight(e.getRowHeight()*s)}this.pinchStartDistanceX=this.pinchStartDistanceY=this.pinchDistanceX=this.pinchDistanceY=null},patchNavigationModel:function(e){e.getView().getNavigationModel().focusItem=function(t){t.addCls(this.focusCls),(Ext.isIE&&!t.hasCls("sch-timetd")||!Ext.isIE&&"horizontal"===e.getOrientation())&&t.focus()};var t=e.lockedGrid.getView(),i=e.normalGrid.getView();t.on("rowclick",function(e,t,n,r){i.lastFocused?(i.lastFocused.rowIdx=r,i.lastFocused.record=t):Ext.isIE&&(i.lastFocused=this.lastFocused)}),i.on("rowclick",function(e,i,n,r){t.lastFocused?(t.lastFocused.rowIdx=r,t.lastFocused.record=i):Ext.isIE&&(t.lastFocused=this.lastFocused)})},configureChildGrids:function(){var e=this;e.lockedGridConfig=Ext.apply({},e.lockedGridConfig||{}),e.normalGridConfig=Ext.apply({},e.schedulerConfig||e.normalGridConfig||{});var t=e.lockedGridConfig,i=e.normalGridConfig;e.lockedXType&&(t.xtype=e.lockedXType),e.normalXType&&(i.xtype=e.normalXType),Ext.applyIf(t,{useArrows:!0,animCollapse:!1,collapseDirection:"left",trackMouseOver:!1,region:"west"}),Ext.applyIf(i,{viewType:e.viewType,layout:"fit",enableColumnMove:!1,enableColumnResize:!1,enableColumnHide:!1,trackMouseOver:!1,collapseDirection:"right",collapseMode:"placeholder",animCollapse:!1,region:"center"}),"vertical"===e.mode&&(t.store=i.store=e.timeAxis),t.width&&(e.syncLockedWidth=Ext.emptyFn,t.scroll=Ext.supports.Touch?"both":"horizontal",t.scrollerOwner=!0)},afterInitComponent:function(){var e=this,t=e.lockedGrid.getView(),i=e.normalGrid.getView(),n=Ext.data.TreeStore&&e.store instanceof Ext.data.TreeStore;e.normalGrid.collapsed&&(e.normalGrid.collapsed=!1,i.on("boxready",function(){e.normalGrid.collapse()},e,{delay:10})),e.lockedGrid.collapsed&&(e.lockedGrid.collapsed=!1,t.on("boxready",function(){e.lockedGrid.collapse()},e,{delay:10}),t.bufferedRenderer&&(t.bufferedRenderer.disabled=!0)),0===Ext.getScrollbarSize().width&&t.addCls("sch-ganttpanel-force-locked-scroll"),n&&this.setupLockableFilterableTree(),this.on("afterrender",function(){var t=this.lockedGrid.headerCt.showMenuBy;this.lockedGrid.headerCt.showMenuBy=function(){t.apply(this,arguments),e.showMenuBy.apply(this,arguments)}});var r=this.child("splitter");r&&r.addCls("sch-timelinepanel-splitter")},setupLockableFilterableTree:function(){var e=this,t=e.lockedGrid.getView(),i=Sch.mixin.FilterableTreeView.prototype;t.initTreeFiltering=i.initTreeFiltering,t.onFilterChangeStart=i.onFilterChangeStart,t.onFilterChangeEnd=i.onFilterChangeEnd,t.onFilterCleared=i.onFilterCleared,t.onFilterSet=i.onFilterSet,t.initTreeFiltering()},showMenuBy:function(e,t){var i=this.getMenu(),n=i.down("#unlockItem"),r=i.down("#lockItem");n.prev().hide(),n.hide(),r.hide()},zoomToFit:function(e){e=Ext.apply({adjustStart:1,adjustEnd:1},e);var t=this.getEventStore(),i=t.getTotalTimeSpan();null===this.zoomToSpan(i,e)&&this.getSchedulingView().fitColumns()}},function(){var e="6.0.0";if(Ext.apply(Sch,{}),Ext.versions.extjs.isLessThan(e)){var t=console;t&&t.log("The Ext JS version you are using needs to be updated to at least "+e)}}),Ext.define("Sch.panel.TimelineGridPanel",{extend:Ext.grid.Panel,mixins:[Sch.mixin.Localizable,Sch.mixin.TimelinePanel],alias:["widget.timelinegrid"],subGridXType:"gridpanel",isTimelineGridPanel:!0,initComponent:function(){this.callParent(arguments),this.getSchedulingView()._initializeTimelineView()}},function(){this.override(Sch.mixin.TimelinePanel.prototype.inheritables()||{})}),Ext.define("Sch.panel.SchedulerGrid",{extend:Sch.panel.TimelineGridPanel,mixins:[Sch.mixin.SchedulerPanel],alias:["widget.schedulergrid","widget.schedulerpanel"],alternateClassName:"Sch.SchedulerPanel",viewType:"schedulergridview",initComponent:function(){this.callParent(arguments),this.getSchedulingView()._initializeSchedulerView()}},function(){this.override(Sch.mixin.SchedulerPanel.prototype.inheritables()||{})}),Ext.define("Sch.patches.ColumnResizeTree",{override:"Sch.panel.TimelineTreePanel",afterRender:function(){this.callParent(arguments);var e=this.lockedGrid.headerCt.findPlugin("gridheaderresizer");e&&(e.getConstrainRegion=function(){var e,t=this,i=t.dragHd.el;return t.headerCt.forceFit&&(e=t.dragHd.nextNode("gridcolumn:not([hidden]):not([isGroupHeader])"),t.headerInSameGrid(e)||(e=null)),t.adjustConstrainRegion(Ext.util.Region.getRegion(i),0,t.headerCt.forceFit?e?e.getWidth()-t.minColWidth:0:t.maxColWidth-i.getWidth(),0,t.minColWidth)})}}),Ext.define("Sch.patches.TreeNavigationModel",{extend:Sch.util.Patch,target:"Ext.tree.NavigationModel",overrides:{onAsterisk:function(){if(!this.view.ownerCt.expandAll)return void this.view.lockingPartner.ownerCt.expandAll();this.callParent(arguments)}}}),Ext.define("Sch.panel.TimelineTreePanel",{extend:Ext.tree.Panel,mixins:[Sch.mixin.Localizable,Sch.mixin.TimelinePanel],alias:["widget.timelinetree"],useArrows:!0,rootVisible:!1,lockedXType:"treepanel",isTimelineTreePanel:!0,initComponent:function(){this.callParent(arguments),this.getSchedulingView()._initializeTimelineView()}},function(){this.override(Sch.mixin.TimelinePanel.prototype.inheritables()||{})}),Ext.define("Sch.panel.SchedulerTree",{extend:Sch.panel.TimelineTreePanel,mixins:[Sch.mixin.SchedulerPanel],alias:["widget.schedulertree"],viewType:"schedulergridview",setOrientation:function(){return this.setMode.apply(this,arguments)},setMode:function(e){"horizontal"!==e&&Ext.Error.raise("Sch.panel.SchedulerTree only support horizontal mode")},initComponent:function(){this.callParent(arguments),this.getSchedulingView()._initializeSchedulerView()}},function(){this.override(Sch.mixin.SchedulerPanel.prototype.inheritables()||{})}),Ext.define("Sch.plugin.CurrentTimeLine",{extend:Sch.plugin.Lines,alias:"plugin.scheduler_currenttimeline",mixins:[Sch.mixin.Localizable],updateInterval:6e4,showHeaderElements:!0,autoUpdate:!0,expandToFitView:!0,timer:null,init:function(e){Ext.getVersion("touch")&&(this.showHeaderElements=!1);var t=new Ext.data.JsonStore({fields:["Date","Cls","Text"],data:[{Date:new Date,Cls:"sch-todayLine",Text:this.L("tooltipText")}]}),i=t.first();this.autoUpdate&&(this.timer=setInterval(function(){i.set("Date",new Date)},this.updateInterval)),this.store=t,this.callParent(arguments)},destroy:function(){this.timer&&(clearInterval(this.timer),this.timer=null),this.store.autoDestroy&&this.store.destroy(),this.callParent(arguments)}}),Ext.define("Sch.plugin.exporter.AbstractExporter",{extend:Ext.util.Observable,mixins:[Sch.mixin.Localizable],pageHeaderHeight:41,pageFooterHeight:0,bufferedHeightMargin:25,paperWidth:0,paperHeight:0,printHeight:0,lockedRowsHeight:0,normalRowsHeight:0,iterateTimeout:10,tableSelector:void 0,currentPage:void 0,headerTplDataFn:null,footerTplDataFn:null,headerTplDataFnScope:null,footerTplDataFnScope:null,config:{exporterId:"abstractexporter",name:"",translateURLsToAbsolute:!0,expandAllBeforeExport:!1,headerTpl:'<div class="sch-export-header" style="height:{height}px; width:{width}px"><h2>{pageNo}/{totalPages}</h2></div>',tpl:'<!DOCTYPE html><html class="'+Ext.baseCSSPrefix+'border-box {htmlClasses}"><head><meta content="text/html; charset=UTF-8" http-equiv="Content-Type" /><title>{title}</title>{styles}</head><body class="'+Ext.baseCSSPrefix+'webkit sch-export {bodyClasses}">{header}<div class="{componentClasses}" style="height:{bodyHeight}px; width:{totalWidth}px; position: relative !important">{HTML}</div>{footer}</body></html>',footerTpl:""},callbacks:void 0,error:void 0,extractedPages:void 0,numberOfPages:0,constructor:function(e){var t=this;e=e||{},t.callParent(arguments),delete e.getUserHeaderTplData,delete e.getUserFooterTplData,t.initConfig(e),e.tableSelector||(t.tableSelector="."+Ext.baseCSSPrefix+"grid-item-container"),e.name||t.setName(t.L("name"))},setHeaderTpl:function(e){this.headerTpl=this.getTplInstance(e)},getHeaderTpl:function(){return this.headerTpl},setTpl:function(e){this.tpl=this.getTplInstance(e)},getTpl:function(){return this.tpl},setFooterTpl:function(e){this.footerTpl=this.getTplInstance(e)},getFooterTpl:function(){return this.footerTpl},getTplInstance:function(e){return e&&!e.isTemplate?new Ext.XTemplate(e,{disableFormats:!0}):e},getBodyClasses:function(){var e=new RegExp(Ext.baseCSSPrefix+"ie\\d?|"+Ext.baseCSSPrefix+"gecko","g"),t=Ext.getBody().dom.className.replace(e,"");return Ext.isIE&&(t+=" sch-ie-export"),t},getComponentClasses:function(){return this.getComponent().el.dom.className},setComponent:function(e){var t=this;t.component=e,t.view=e.getSchedulingView(),t.normalGrid=e.normalGrid,t.lockedGrid=e.lockedGrid,t.normalView=e.normalGrid.view,t.lockedView=e.lockedGrid.view,t.lockedBodySelector="#"+t.lockedView.getId(),t.normalBodySelector="#"+t.normalView.getId(),t.lockedHeader=t.lockedGrid.headerCt,t.normalHeader=t.normalGrid.headerCt,t.headerHeight=t.normalHeader.getHeight(),t.printHeight=Math.floor(t.paperHeight)-t.headerHeight-(t.exportConfig.showHeader?t.pageHeaderHeight:0)-(t.exportConfig.showFooter?t.pageFooterHeight:0),t.saveComponentState(e)},getComponent:function(){return this.component},setPaperSize:function(e,t){var i=this;"landscape"===t?(i.paperWidth=e.height,i.paperHeight=e.width):(i.paperWidth=e.width,i.paperHeight=e.height)},getPaperFormat:function(){return this.exportConfig.format},isBuffered:function(){return!!this.getBufferedRenderer()},getBufferedRenderer:function(){return this.view.bufferedRenderer},setComponentRange:function(e){var t,i,n=this,r=n.getComponent(),a=n.view;if("complete"!==e.range){switch(e.range){case"date":t=new Date(e.dateFrom),i=new Date(e.dateTo),Sch.util.Date.getDurationInDays(t,i)<1&&(i=Sch.util.Date.add(i,Sch.util.Date.DAY,1)),t=Sch.util.Date.constrain(t,r.getStart(),r.getEnd()),i=Sch.util.Date.constrain(i,r.getStart(),r.getEnd());break;case"current":var s=a.getVisibleDate_Range();if(t=s.startDate,i=s.endDate||a.timeAxis.getEnd(),e.cellSize){var o=e.cellSize;n.timeColumnWidth=o[0],n.timeColumnWidth&&r.setTimeColumnWidth(n.timeColumnWidth),o.length>1&&n.view.setRowHeight(o[1])}}r.setTimeSpan(t,i)}n.ticks=r.timeAxis.getTicks()},getStylesheets:function(){var e=this.translateURLsToAbsolute,t=Ext.getDoc().select('link[rel="stylesheet"]'),i=Ext.get(Ext.core.DomHelper.createDom({tag:"div"}));return t.each(function(t){var n=t.dom.cloneNode(!0);e&&n.setAttribute("href",t.dom.href),i.appendChild(n)}),i.dom.innerHTML+""},forEachTimeSpanPlugin:function(e,t,i){if(Sch.feature&&Sch.feature.AbstractTimeSpan)for(var n=this,r=(e.plugins||[]).concat(e.normalGrid.plugins||[]).concat(e.columnLinesFeature||[]),a=0,s=r.length;a<s;a++){var o=r[a];o instanceof Sch.feature.AbstractTimeSpan&&t.call(i||n,o)}},prepareComponent:function(e,t){var i=this;i.view;e=e||i.getComponent(),i.suspendInfiniteScroll(e),i.forEachTimeSpanPlugin(e,function(e){e._renderDelay=e.renderDelay,e.renderDelay=0}),e.getSchedulingView().timeAxisViewModel.suppressFit=!0,e.timeAxis.autoAdjust=!1,e.normalGrid.expand(),e.lockedGrid.expand(),i.setComponentRange(t),t.beforeExport&&t.beforeExport(e,i.ticks),i.prepareColumns(t.columns),i.expandAllBeforeExport&&e.expandAll&&e.expandAll(),i.fitComponentIntoPage(),i.view.timeAxisViewModel.setTickWidth(i.view.timeAxisViewModel.getTickWidth()),i.view.timeAxisViewModel.setTickWidth(i.view.timeAxisViewModel.getTickWidth()),i.isBuffered()&&Ext.isIE8&&(i.normalView.bufferedRenderer.variableRowHeight=!1,i.lockedView.bufferedRenderer.variableRowHeight=!1)},prepareColumns:function(e){var t=this;e&&t.lockedGrid.headerCt.items.each(function(t){Ext.Array.contains(e,t)?t.show():t.hide()})},restoreComponent:function(e){var t=this;e=e||t.getComponent(),t.forEachTimeSpanPlugin(e,function(e){e.renderDelay=e._renderDelay,delete e._renderDelay}),t.restoreComponentState(e),t.restoreInfiniteScroll(e),t.exportConfig.afterExport&&t.exportConfig.afterExport(e)},saveComponentState:function(e){e=e||this.getComponent();var t=this,i=e.getSchedulingView(),n=e.normalGrid,r=e.lockedGrid,a=[];r.headerCt.items.each(function(e){a.push({column:e,visible:!e.isHidden()})}),t.restoreSettings={width:e.getWidth(),height:e.getHeight(),rowHeight:i.timeAxisViewModel.getViewRowHeight(),columnWidth:i.timeAxisViewModel.getTickWidth(),startDate:e.getStart(),endDate:e.getEnd(),normalWidth:n.getWidth(),normalLeft:n.getEl().getStyle("left"),lockedWidth:r.getWidth(),lockedCollapse:r.collapsed,normalCollapse:n.collapsed,columns:a,autoAdjust:e.timeAxis.autoAdjust,suppressFit:i.timeAxisViewModel.suppressFit,startIndex:i.all?i.all.startIndex:0}},restoreComponentState:function(e){var t=this;e=e||t.getComponent();var i=t.restoreSettings,n=e.getSchedulingView();e.timeAxis.autoAdjust=i.autoAdjust,e.normalGrid.show(),e.setWidth(i.width),e.setHeight(i.height),e.setTimeSpan(i.startDate,i.endDate),e.setTimeColumnWidth(i.columnWidth,!0),n.setRowHeight(i.rowHeight),e.lockedGrid.show(),Ext.Array.each(i.columns,function(e){e.column.setVisible(e.visible)}),e.normalGrid.setWidth(i.normalWidth),e.normalGrid.getEl().setStyle("left",i.normalLeft),e.lockedGrid.setWidth(i.lockedWidth),n.timeAxisViewModel.suppressFit=i.suppressFit,n.timeAxisViewModel.setTickWidth(i.columnWidth),i.lockedCollapse&&e.lockedGrid.collapse(),i.normalCollapse&&e.normalGrid.collapse(),t.getBufferedRenderer()&&(t.scrollTo(i.startIndex),Ext.isIE8&&(t.normalView.bufferedRenderer.variableRowHeight=!0,t.lockedView.bufferedRenderer.variableRowHeight=!0))},extractPages:function(e,t,i,n){var r=this;r.exportConfig=t,r.normalRows=[],r.lockedRows=[],r.extractedPages=[],r.numberOfPages=0,r.lockedRowsHeight=0,r.normalRowsHeight=0,r.setPaperSize(t.pageSize,t.orientation),r.setComponent(e,t),r.prepareComponent(e,t),r.callbacks={success:i||Ext.emptyFn,scope:n||r},setTimeout(function(){r.collectRows(r.onRowsCollected,r)},1)},onPagesExtracted:function(e){var t=this;t.restoreComponent(),t.submitPages(e)},submitPages:function(e){var t=this,i=t.callbacks;i.success.call(i.scope,t.renderPages(e))},getCurrentPage:function(){return this.currentPage},setCurrentPage:function(e){this.currentPage=e},getExpectedNumberOfPages:Ext.emptyFn,commitPage:function(e){var t=this;t.numberOfPages++;var i=t.preparePageToCommit(e);t.fireEvent("beforecommitpage",t,i,t.numberOfPages,t.getExpectedNumberOfPages());var n=Ext.apply({html:i.dom.innerHTML,number:t.numberOfPages},e);t.extractedPages.push(n),t.fireEvent("commitpage",t,n,t.numberOfPages,t.getExpectedNumberOfPages())},collectLockedRow:function(e,t){var i=Ext.fly(e).getHeight();this.lockedRowsHeight+=i;var n={height:i,row:e.cloneNode(!0),record:this.lockedView.getRecord(t)};return this.lockedRows.push(n),n},collectNormalRow:function(e,t){var i=Ext.fly(e).getHeight();this.normalRowsHeight+=i;var n={height:Ext.fly(e).getHeight(),row:e.cloneNode(!0),record:this.normalView.getRecord(t)};return this.normalRows.push(n),n},onRowsCollected:function(){throw"Sch.plugin.exporter.AbstractExporter: [onRowsCollected] Abstract method called."},iterateAsync:function(e,t){var i=this;t=t||i;var n=function(){var r=arguments,a=setInterval(function(){clearInterval(a),e.apply(t,[].concat.apply([n],r))},i.iterateTimeout)};n.apply(i,Ext.Array.slice(arguments,2))},callAsync:function(e,t){t=t||this;var i=setInterval(function(){clearInterval(i),e.apply(t,Ext.Array.slice(arguments,2))},this.iterateTimeout)},collectRows:function(e,t){var i=this;i.isBuffered()?setTimeout(function(){i.scrollTo(0,function(){i.iterateAsync(i.collectRowsStep,i,0,e,t)})},1):setTimeout(function(){i.collectRowsStep(null,0,e,t)},1)},collectRowsStep:function(e,t,i,n){for(var r=this,a=r.normalView.all.endIndex,s=r.component.store.getCount(),o=r.normalView.all.slice(t),l=r.lockedView.all.slice(t),d=0;d<l.length;d++)r.collectLockedRow(l[d],t+d);for(d=0;d<o.length;d++)r.collectNormalRow(o[d],t+d);r.fireEvent("collectrows",r,t,a,s),r.isBuffered()?a+1<s?r.callAsync(function(){r.scrollTo(a+1,function(){e(a+1,i,n)})}):r.callAsync(function(){r.scrollTo(0,function(){i.call(n||r,r.lockedRows,r.normalRows)})}):i.call(n||r,r.lockedRows,r.normalRows)},renderPages:function(e){var t=this;e=e||t.extractedPages;for(var i=0,n=e.length;i<n;i++){var r=e[i];r.html=t.applyPageTpl(r)}return e},applyPageTpl:function(e){var t=this;return t.getTpl().apply(t.getPageTplData(e))},applyHeaderTpl:function(e){var t=this,i=t.getHeaderTpl();if(t.exportConfig.showHeader&&i){var n=t.headerTplDataFn,r=n&&n.call(t.headerTplDataFnScope||t,e);return i.apply(Ext.apply(t.getHeaderTplData(e),r))}return""},applyFooterTpl:function(e){var t=this,i=t.getFooterTpl();if(t.exportConfig.showFooter&&i){var n=t.footerTplDataFn,r=n&&n.call(t.footerTplDataFnScope||t,e);return i.apply(Ext.apply(t.getFooterTplData(e),r))}return""},getHeaderTplData:function(e){var t=this;return{width:t.paperWidth,height:t.pageHeaderHeight,totalPages:t.numberOfPages,pageNo:e.number}},getFooterTplData:function(e){var t=this;return{width:t.paperWidth,height:t.pageFooterHeight,totalPages:t.numberOfPages,pageNo:e.number}},getPageTplData:function(e){var t=this;return{bodyClasses:t.getBodyClasses(),bodyHeight:t.printHeight+t.headerHeight,componentClasses:t.getComponentClasses(),styles:t.getStylesheets(),showHeader:t.exportConfig.showHeader,showFooter:t.exportConfig.showFooter,header:t.applyHeaderTpl(e),HTML:e.html,footer:t.applyFooterTpl(e),totalWidth:t.paperWidth,title:e.number+" of "+t.numberOfPages}},fitComponentIntoPage:Ext.emptyFn,getLockedGridBody:function(e){return e=e||this.getCurrentPage(),e.select(this.lockedBodySelector+" > "+this.tableSelector).first()},getNormalGridBody:function(e){return e=e||this.getCurrentPage(),e.select(this.normalBodySelector+" > "+this.tableSelector).first()},emptyLockedGrid:function(e){this.getLockedGridBody(e).select(this.lockedView.getItemSelector()).remove()},fillGrids:function(e,t,i,n){var r=this;r.fillLockedGrid(e,i,n),r.fillNormalGrid(t,i,n)},fillLockedGrid:function(e,t,i){var n=this;i||n.emptyLockedGrid(),n.appendRows(n.getLockedGridBody(),e||n.lockedRows,t)},fillNormalGrid:function(e,t,i){var n=this;i||n.emptyNormalGrid(),n.appendRows(n.getNormalGridBody(),e||n.normalRows,t)},appendRows:function(e,t,i){for(var n=e.dom,r=0,a=t.length;r<a;r++)n.appendChild(i?t[r].row.cloneNode(!0):t[r].row)},emptyNormalGrid:function(e){this.getNormalGridBody(e).select(this.normalView.getItemSelector()).remove()},getRowHeight:function(){return this.view.timeAxisViewModel.getViewRowHeight()},getTotalSize:function(){return{width:this.getTotalWidth(),height:this.getTotalHeight()}},getTotalHeight:function(){var e,t=this;return e=t.isBuffered()?t.bufferedHeightMargin+t.normalRowsHeight:t.lockedView.getEl().down(t.tableSelector).getHeight(),t.headerHeight+e},getTotalWidth:function(){return this.getLockedGridWidth()+this.normalGrid.body.down(this.tableSelector).getWidth()},getLockedGridWidth:function(){return this.lockedHeader.getEl().first().getWidth()},getNormalGridWidth:function(){return this.normalHeader.getEl().first().getWidth()},preparePageToCommit:function(){var e=this.getCurrentPage(),t=this.component,i=t.lockedGrid,n=t.normalGrid;e.el.select(".sch-remove").remove();var r=function(t){var i=e.select("#"+t).first();return i&&i.dom},a=function(e){e&&(e.style.width="100%")},s=function(e){e&&(e.style.height="100%")};e.select(this.normalBodySelector).first().dom.style.top="0px",e.select(this.lockedBodySelector).first().dom.style.top="0px";var o=[r(t.id+"-targetEl"),r(t.id+"-innerCt"),r(i.id),r(i.body.id),r(i.view.el.id)];if(Ext.Array.forEach(o,s),a(o[0]),a(o[1]),Ext.isIE){var l=r(n.headerCt.id);l&&(l.style.width="")}else a(r(n.headerCt.id));return Ext.Array.forEach([r(n.id),r(n.body.id),r(n.getView().id)],function(e){e&&(e.style.height=e.style.width="100%")}),e},cloneElement:function(e){return new Ext.dom.Element(Ext.core.DomHelper.createDom({tag:"div",html:e.dom.innerHTML}))},startPage:function(e){var t=this,i=t.cloneElement(e||t.getComponent().body);t.setCurrentPage(i)},scrollTo:function(e,t){var i=this;if(i.component.ensureVisible){var n=i.component.store.getAt(e);i.component.ensureVisible(n,{callback:function(){t&&!1===this.isLocked&&t.apply(i)},select:!1,focus:!1,animate:!1})}else i.lockedView.bufferedRenderer.scrollTo(e,!1,function(){i.normalView.bufferedRenderer.scrollTo(e,!1,t)})},removeNode:function(e){if(e&&e.parentNode)e.parentNode.removeChild(e);else if(e.elements)for(var t=0;t<e.elements.length;t++){var i=e.elements[t];i.parentNode.removeChild(i)}},restoreInfiniteScroll:function(e){var t=e.getSchedulingView();e.infiniteScroll&&t.rendered&&(e.timeAxis.setTimeSpan(this._oldStart,this._oldEnd),t.setScrollX(this._oldScrollX),t.bindInfiniteScrollListeners())},suspendInfiniteScroll:function(e){var t=e.getSchedulingView();if(e.infiniteScroll&&t.rendered){t.unbindInfiniteScrollListeners(),this._oldStart=e.timeAxis.getStart(),this._oldEnd=e.timeAxis.getEnd(),this._oldScrollX=t.getScrollX();var i=e.getEventStore().getTotalTimeSpan();e.setTimeSpan(i.start,i.end)}}}),Ext.define("Sch.plugin.exporter.SinglePage",{extend:Sch.plugin.exporter.AbstractExporter,config:{exporterId:"singlepage",headerTpl:'<div class="sch-export-header" style="height:{height}px; width:{width}px"></div>'},getExpectedNumberOfPages:function(){return 1},getPaperFormat:function(){var e=this,t=e.getTotalSize(),i=e.exportConfig.DPI;return Ext.Number.toFixed(t.width/i,1)+"in*"+Ext.Number.toFixed(t.height/i,1)+"in"},onRowsCollected:function(){var e=this;e.startPage(),e.fillGrids(),e.commitPage(),e.onPagesExtracted()},getPageTplData:function(){var e=this,t=e.getTotalSize();return Ext.apply(e.callParent(arguments),{bodyHeight:t.height,showHeader:!1,totalWidth:t.width})},getHeaderTplData:function(e){var t=this;return{width:t.getTotalWidth(),height:t.pageHeaderHeight}},fitComponentIntoPage:function(){var e=this,t=e.lockedGrid;t.setWidth(t.headerCt.getEl().first().getWidth())},preparePageToCommit:function(){var e=this,t=e.callParent(arguments),i=t.select(".sch-secondary-canvas").first(),n=i.select(".sch-zone"),r=i.select(".sch-column-line"),a=e.getTotalHeight();return i.setTop(0),n.setHeight(a),r.setHeight(a),t}}),Ext.define("Sch.plugin.exporter.MultiPage",{extend:Sch.plugin.exporter.AbstractExporter,config:{exporterId:"multipage"},rowPageIndex:0,columnPageIndex:0,pagesPerColumn:0,extractPages:function(){return this.enableGarbageCollector=Ext.enableGarbageCollector,Ext.enableGarbageCollector=!1,Ext.dom.GarbageCollector.pause(),this.callParent(arguments)},onRowsCollected:function(e,t){var i=this;i.rowPageIndex=0,i.columnPageIndex=0,i.pagesPerColumn=0,i.buildPageFrames(function(){i.buildPages(function(){i.onPagesExtracted.apply(i,arguments),Ext.enableGarbageCollector=i.enableGarbageCollector,Ext.dom.GarbageCollector.resume()},i,e,t)})},buildPages:function(e,t,i,n){var r=this,a=r.pageFrames[0];r.startPage(a,!0),this.iterateAsync(r.rowIteratorStep,r,{rowIndex:0,pageFrame:a,rowsHeight:0,leftHeight:this.printHeight,lockeds:[],normals:[],lockedRows:i,normalRows:n,callback:e,scope:t||r})},rowIteratorStep:function(e,t){var i=this,n=t.rowIndex,r=t.lockedRows,a=t.normalRows,s=t.leftHeight,o=t.lockeds,l=t.normals,d=!0;if(n<r.length){var c=r[n],h=a[n];c.height<=s?(o.push(c),l.push(h),t.leftHeight-=c.height,t.rowsHeight+=c.height,d=!1):(i.fillGrids(o,l,t.pageFrame),i.commitPage({rowsHeight:t.rowsHeight}),i.startPage(t.pageFrame),t.lockeds=[c],t.normals=[h],t.leftHeight=i.printHeight-c.height,t.rowsHeight=c.height),t.rowIndex++}else{if(!(i.columnPageIndex<i.pageFrames.length))return i.fillGrids(o,l,t.pageFrame),i.commitPage({rowsHeight:t.rowsHeight}),void t.callback.call(t.scope);i.fillGrids(o,l,t.pageFrame),i.commitPage({rowsHeight:t.rowsHeight}),t.pageFrame=i.pageFrames[i.columnPageIndex],i.startPage(t.pageFrame,!0),t.leftHeight=i.printHeight,t.rowsHeight=0,t.lockeds=[],t.normals=[],t.rowIndex=0}d?e(t):i.rowIteratorStep(e,t)},fillGrids:function(e,t,i){var n=this,r=n.lockedColumnPages[n.columnPageIndex-1],a=!r||r&&r.leftWidth;r&&(n.fillLockedGrid(e,!0),n.removeHiddenLockedColumns(r)),a&&(n.fillNormalGrid(t,!0),n.removeInvisibleEvents(-i.normalGridOffset,-i.normalGridOffset+i.normalGridWidth))},buildPageFrame:function(e,t){var i=this,n=i.lockedColumnPages[e];n?(i.lockedGrid.setWidth(i.showLockedColumns(n.start,n.end)+(n.startOffset||0)),n.leftWidth?i.normalGrid.show():i.normalGrid.hide()):(i.lockedGrid.setWidth(0),i.lockedGrid.hide(),i.normalGrid.show());var r=i.cloneElement(i.getComponent().body);if(r.normalGridOffset=t,r.lockedGridOffset=n&&n.startOffset||0,r.normalGridWidth=i.normalGrid.getWidth(),r.lockedGridWidth=i.lockedGrid.getWidth(),r.select(i.lockedBodySelector).first().dom.style.position="",r.select("#"+i.lockedView.id).first().dom.style.overflow="visible",!i.normalGrid.hidden){var a=r.select(i.normalBodySelector).first();a.dom.style.position="",a.dom.style.top="0px";var s=i.getNormalGridBody(r),o=r.select("#"+i.normalView.headerCt.id).first(),l=r.select(".sch-secondary-canvas").first(),d=r.select("#"+i.normalView.id).first();s.dom.style.left=t+"px",o.dom.style.left=t+"px",o.dom.style.overflow="visible",l.dom.style.left=t+"px",d.dom.style.overflow="visible"}return r},buildPageFrames:function(e,t){var i=this;t=t||i,i.lockedColumnPages=i.calculateLockedColumnPages();var n=Math.ceil(i.getTotalWidth()/i.paperWidth),r=i.pageFrames=[];i.iterateAsync(function(a,s,o){if(s>=n)return void e.call(t,r);r.push(i.buildPageFrame(s,o));var l=i.lockedColumnPages[s];o-=l?l.leftWidth||0:i.paperWidth,a(s+1,o)},i,0,0)},startPage:function(e,t){var i=this;t&&(1==i.columnPageIndex&&(i.pagesPerColumn=i.extractedPages.length),i.rowPageIndex=0,i.columnPageIndex++),i.rowPageIndex++,
i.callParent(arguments),i.emptyNormalGrid(),i.emptyLockedGrid()},commitPage:function(e){var t=this;t.callParent([Ext.apply({row:t.rowPageIndex,column:t.columnPageIndex},e)])},getExpectedPagesPerColumn:function(){return this.pagesPerColumn||Math.ceil((this.lockedRowsHeight||this.component.store.count()*this.component.getRowHeight())/this.printHeight)},getExpectedColumnsNumber:function(){return this.pageFrames?this.pageFrames.length:Math.ceil((this.lockedGrid.getWidth()+this.ticks.length*this.view.timeAxisViewModel.getTickWidth())/this.paperWidth)},getExpectedNumberOfPages:function(){return this.getExpectedColumnsNumber()*this.getExpectedPagesPerColumn()},calculateLockedColumnPages:function(){for(var e,t=this,i=[],n=t.lockedColumns,r=t.paperWidth,a=0,s=n.length;a<s;a++){var o=n[a],l=o.width;e=e||{start:a,end:a},r-=l,r<0?(i.push(e),r&&(e={start:a,end:a}),r=t.paperWidth-l+r):e.end=a}return e&&(e.leftWidth=r,i.push(e)),i},getPageTplData:function(e){return Ext.apply(this.callParent(arguments),{title:e.number+" of "+this.numberOfPages+" (column: "+e.column+", row: "+e.row+")"})},showLockedColumns:function(e,t){var i=this,n=i.lockedColumns,r=0;e=e||0,t=t||n.length-1;for(var a=0;a<n.length;a++){var s=n[a];a>=e&&a<=t?(s.column.show(),r+=s.width):s.column.hide()}return r},removeInvisibleEvents:function(e,t){for(var i=this,n=i.getNormalGridBody(),r=i.normalView.eventCls,a=n.select("."+r).elements,s=0;s<a.length;s++){var o=parseInt(a[s].style.left,10);(o+parseInt(a[s].style.width,10)<e||o>t)&&i.removeNode(a[s])}},removeHiddenLockedColumns:function(e){for(var t=this,i=t.getCurrentPage(),n=t.getLockedGridBody(),r=0;r<t.lockedColumns.length;r++){var a=t.lockedColumns[r].column;if(r<e.start||r>e.end){var s="#"+a.getId(),o=i.select(s);t.removeNode(o);var l=a.getCellSelector(),d=n.select(l);t.removeNode(d)}}},fitComponentIntoPage:function(){var e=this;e.getComponent().setWidth(e.paperWidth)},prepareComponent:function(e,t){var i=this,n=i.lockedColumns=[];i.callParent(arguments),i.lockedGrid.headerCt.items.each(function(e){e.hidden||n.push({column:e,width:e.getWidth()})})},restoreComponentState:function(){this.callParent(arguments),this.showLockedColumns()},preparePageToCommit:function(){var e=this,t=e.callParent(arguments),i=t.select("."+Ext.baseCSSPrefix+"splitter").first(),n=e.pageFrames[e.columnPageIndex-1];return i&&(n.lockedHidden?(i.hide(),t.select("."+Ext.baseCSSPrefix+"grid-inner-normal").first().setStyle("left",0)):i.setHeight("100%")),t}}),Ext.define("Sch.plugin.exporter.MultiPageVertical",{extend:Sch.plugin.exporter.AbstractExporter,config:{exporterId:"multipagevertical"},minRowHeight:20,visibleColumns:null,visibleColumnsWidth:0,onRowsCollected:function(e,t){var i=this;i.iterateAsync(function(n,r){if(r===e.length)return void i.onPagesExtracted();var a,s=r,o=i.printHeight,l=0,d=[],c=[],h=!1;for(i.startPage();!h&&s<e.length;)a=t[s],o-=a.height,o>0?(l+=a.height,d.push(e[s]),c.push(a),s++):h=!0;i.fillGrids(d,c),i.commitPage({rowIndex:s,rowsHeight:l}),n(s)},i,0)},startPage:function(){var e=this;e.callParent(arguments),e.getCurrentPage().select("#"+e.lockedView.id).first().dom.style.overflow="visible"},getExpectedNumberOfPages:function(){return Math.ceil(this.lockedRowsHeight/this.printHeight)},prepareComponent:function(e,t){var i=this,n=i.visibleColumns=[];i.visibleColumnsWidth=0,i.lockedGrid.headerCt.items.each(function(e){e.hidden||(n.push({column:e,width:e.getWidth()}),i.visibleColumnsWidth+=e.getWidth())}),i.callParent(arguments)},fitComponentIntoPage:function(){var e=this,t=e.getComponent(),i=t.normalGrid,n=t.lockedGrid,r=e.getTotalWidth(),a=e.ticks,s=e.timeColumnWidth||e.restoreSettings.columnWidth,o=Math.floor(e.visibleColumnsWidth/r*e.paperWidth),l=Math.floor(a.length*s/r*e.paperWidth),d=Math.floor(l/a.length),c=d/s*e.getRowHeight();e.view.setRowHeight(c<e.minRowHeight?e.minRowHeight:c),t.setWidth(e.paperWidth),i.setWidth(l),n.setWidth(o),e.fitLockedColumnWidth(o),t.setTimeColumnWidth(d)},fitLockedColumnWidth:function(e){var t=this.visibleColumns;if(t.length){for(var i=e/t.length,n=0;n<t.length;n++)t[n].column.setWidth(i);this._restoreColumnWidth=!0}},restoreComponentState:function(){if(this.callParent(arguments),this._restoreColumnWidth)for(var e=this.visibleColumns,t=0;t<e.length;t++){var i=e[t];i.column.setWidth(i.width)}}}),Ext.define("Sch.widget.ResizePicker",{extend:Ext.Panel,alias:"widget.dualrangepicker",width:200,height:200,border:!0,collapsible:!1,bodyStyle:"position:absolute; margin:5px",verticalCfg:{height:120,value:24,increment:2,minValue:20,maxValue:80,reverse:!0,disabled:!0},horizontalCfg:{width:120,value:100,minValue:25,increment:5,maxValue:200,disable:!0},initComponent:function(){var e=this;e.horizontalCfg.value=e.dialogConfig.columnWidth,e.verticalCfg.value=e.dialogConfig.rowHeight,e.verticalCfg.disabled=e.dialogConfig.scrollerDisabled||!1,e.dockedItems=[e.vertical=new Ext.slider.Single(Ext.apply({dock:"left",style:"margin-top:10px",vertical:!0,listeners:{change:e.onSliderChange,changecomplete:e.onSliderChangeComplete,scope:e}},e.verticalCfg)),e.horizontal=new Ext.slider.Single(Ext.apply({dock:"top",style:"margin-left:28px",listeners:{change:e.onSliderChange,changecomplete:e.onSliderChangeComplete,scope:e}},e.horizontalCfg))],e.callParent(arguments)},afterRender:function(){var e=this;e.addCls("sch-ux-range-picker"),e.valueHandle=this.body.createChild({cls:"sch-ux-range-value",cn:{tag:"span"}}),e.valueSpan=this.valueHandle.down("span");var t=new Ext.dd.DD(this.valueHandle);Ext.apply(t,{startDrag:function(){e.dragging=!0,this.constrainTo(e.body)},onDrag:function(){e.onHandleDrag.apply(e,arguments)},endDrag:function(){e.onHandleEndDrag.apply(e,arguments),e.dragging=!1},scope:this}),this.setValues(this.getValues()),this.callParent(arguments),this.body.on("click",this.onBodyClick,this)},onBodyClick:function(e,t){var i=[e.getXY()[0]-8-this.body.getX(),e.getXY()[1]-8-this.body.getY()];this.valueHandle.setLeft(Ext.Number.constrain(i[0],0,this.getAvailableWidth())),this.valueHandle.setTop(Ext.Number.constrain(i[1],0,this.getAvailableHeight())),this.setValues(this.getValuesFromXY([this.valueHandle.getLeft(!0),this.valueHandle.getTop(!0)])),this.onSliderChangeComplete()},getAvailableWidth:function(){return this.body.getWidth()-18},getAvailableHeight:function(){return this.body.getHeight()-18},onHandleDrag:function(){this.setValues(this.getValuesFromXY([this.valueHandle.getLeft(!0),this.valueHandle.getTop(!0)]))},onHandleEndDrag:function(){this.setValues(this.getValuesFromXY([this.valueHandle.getLeft(!0),this.valueHandle.getTop(!0)]))},getValuesFromXY:function(e){var t=e[0]/this.getAvailableWidth(),i=e[1]/this.getAvailableHeight(),n=Math.round((this.horizontalCfg.maxValue-this.horizontalCfg.minValue)*t),r=Math.round((this.verticalCfg.maxValue-this.verticalCfg.minValue)*i)+this.verticalCfg.minValue;return[n+this.horizontalCfg.minValue,r]},getXYFromValues:function(e){var t=this.horizontalCfg.maxValue-this.horizontalCfg.minValue,i=this.verticalCfg.maxValue-this.verticalCfg.minValue,n=Math.round((e[0]-this.horizontalCfg.minValue)*this.getAvailableWidth()/t),r=e[1]-this.verticalCfg.minValue;return[n,Math.round(r*this.getAvailableHeight()/i)]},updatePosition:function(){var e=this.getValues(),t=this.getXYFromValues(e);this.valueHandle.setLeft(Ext.Number.constrain(t[0],0,this.getAvailableWidth())),this.verticalCfg.disabled?this.valueHandle.setTop(this.dialogConfig.rowHeight):this.valueHandle.setTop(Ext.Number.constrain(t[1],0,this.getAvailableHeight())),this.positionValueText(),this.setValueText(e)},positionValueText:function(){var e=this.valueHandle.getTop(!0),t=this.valueHandle.getLeft(!0);this.valueSpan.setLeft(t>30?-30:10),this.valueSpan.setTop(e>10?-20:20)},setValueText:function(e){this.verticalCfg.disabled&&(e[1]=this.dialogConfig.rowHeight),this.valueSpan.update("["+e.toString()+"]")},setValues:function(e){this.horizontal.setValue(e[0]),this.verticalCfg.reverse?this.verticalCfg.disabled||this.vertical.setValue(this.verticalCfg.maxValue+this.verticalCfg.minValue-e[1]):this.verticalCfg.disabled||this.vertical.setValue(e[1]),this.dragging||this.updatePosition(),this.positionValueText(),this.setValueText(e)},getValues:function(){if(!this.verticalCfg.disabled){var e=this.vertical.getValue();return this.verticalCfg.reverse&&(e=this.verticalCfg.maxValue-e+this.verticalCfg.minValue),[this.horizontal.getValue(),e]}return[this.horizontal.getValue()]},onSliderChange:function(){this.fireEvent("change",this,this.getValues()),this.dragging||this.updatePosition()},onSliderChangeComplete:function(){this.fireEvent("changecomplete",this,this.getValues())},afterLayout:function(){this.callParent(arguments),this.updatePosition()}}),Ext.define("Sch.widget.ColumnPicker",{extend:Ext.form.field.ComboBox,multiSelect:!0,valueField:"id",displayField:"name",forceSelection:!0,editable:!1,listConfig:{cls:"sch-columnpicker-list"},columns:null,store:{proxy:"memory",fields:["id","name","column"]},initComponent:function(){var e=this;Ext.applyIf(e.store,{data:this.processColumns(this.columns)}),this.callParent(arguments)},processColumns:function(e){var t=[],i=[];return Ext.Array.forEach(e,function(e){t.push({id:e.id,name:e.text,column:e}),e.isHidden()||i.push(e.id)}),this.value=this.value||i,t},getSelectedColumns:function(){var e=this,t=e.getValue();return t=Ext.isArray(t)?t:[t],Ext.Array.map(t,function(t){return e.store.getById(t).get("column")})}}),Ext.define("Sch.widget.ExportDialogForm",{extend:Ext.form.Panel,border:!1,bodyPadding:"10 10 0 10",autoHeight:!0,initComponent:function(){var e=this;e.fieldDefaults=Ext.applyIf(e.fieldDefaults||{},{labelAlign:"left",labelWidth:120,anchor:"99%"}),e.items=e.createFields(),e.items.push(e.progressBar||e.createProgressBar()),e.callParent(arguments),e.onRangeChange(null,e.dialogConfig.exportConfig.range),e.onExporterChange(e.exportersField,e.exportersField.getValue()),e.on({hideprogressbar:e.hideProgressBar,showprogressbar:e.showProgressBar,updateprogressbar:e.updateProgressBar,scope:e})},isValid:function(){var e=this;return"date"!==e.rangeField.getValue()||e.dateFromField.isValid()&&e.dateToField.isValid()},getValues:function(e,t,i,n){var r=this.callParent(arguments);r.showHeader=!!r.showHeader,r.showFooter=!!r.showFooter;var a=this.resizePicker.getValues();return e?r+="&cellSize[0]="+a[0]+"&cellSize[1]="+a[1]:r.cellSize=a,this.dialogConfig.showColumnPicker&&(r.columns=this.columnPicker.getSelectedColumns()),r},createFields:function(){var e=this,t=e.dialogConfig,i='<table class="sch-fieldcontainer-label-wrap"><td width="1" class="sch-fieldcontainer-label">',n='<td><div class="sch-fieldcontainer-separator"></div></table>',r=[];e.rangeField=new Ext.form.field.ComboBox({value:t.exportConfig.range,triggerAction:"all",cls:"sch-export-dialog-range",forceSelection:!0,editable:!1,fieldLabel:t.rangeFieldLabel,name:"range",queryMode:"local",displayField:"name",valueField:"value",store:new Ext.data.Store({fields:["name","value"],data:[{name:t.completeViewText,value:"complete"},{name:t.Date_RangeText,value:"date"},{name:t.currentViewText,value:"current"}]}),listeners:{change:e.onRangeChange,scope:e}}),e.resizePicker=new Sch.widget.ResizePicker({dialogConfig:t,margin:"10 20"}),e.resizerHolder=new Ext.form.FieldContainer({fieldLabel:t.scrollerDisabled?t.adjustCols:t.adjustColsAndRows,labelAlign:"top",hidden:!0,labelSeparator:"",beforeLabelTextTpl:i,afterLabelTextTpl:n,layout:"vbox",defaults:{flex:1,allowBlank:!1},items:[e.resizePicker]}),e.dateFromField=new Ext.form.field.Date({fieldLabel:t.Date_RangeFromText,baseBodyCls:"sch-exportdialogform-date",name:"dateFrom",format:t.Date_RangeFormat||Ext.Date.defaultFormat,allowBlank:!1,maxValue:t.endDate,minValue:t.startDate,value:t.startDate}),e.dateToField=new Ext.form.field.Date({fieldLabel:t.Date_RangeToText,name:"dateTo",format:t.Date_RangeFormat||Ext.Date.defaultFormat,baseBodyCls:"sch-exportdialogform-date",allowBlank:!1,maxValue:t.endDate,minValue:t.startDate,value:t.endDate}),e.datesHolder=new Ext.form.FieldContainer({fieldLabel:t.specifyDate_Range,labelAlign:"top",hidden:!0,labelSeparator:"",beforeLabelTextTpl:i,afterLabelTextTpl:n,layout:"vbox",defaults:{flex:1,allowBlank:!1},items:[e.dateFromField,e.dateToField]}),t.showColumnPicker&&(e.columnPicker=new Sch.widget.ColumnPicker(Ext.apply({fieldLabel:t.columnPickerLabel,cls:"sch-export-dialog-columns",columns:t.scheduler.lockedGrid.query("gridcolumn")},t.columnPickerConfig))),t.showDPIField&&(e.dpiField=new Ext.form.field.Number(Ext.apply({fieldLabel:t.dpiFieldLabel,cls:"sch-export-dialog-dpi",minValue:65,name:"DPI",value:t.exportConfig.DPI,maxValue:200},t.dpiFieldConfig))),t.showHeaderField&&(e.showHeaderField=new Ext.form.field.Checkbox({fieldLabel:e.dialogConfig.showHeaderLabel,cls:"sch-export-dialog-header",name:"showHeader",checked:!!t.exportConfig.showHeader,checkedValue:!0,uncheckedValue:!1})),t.showFooterField&&(e.showFooterField=new Ext.form.field.Checkbox({fieldLabel:e.dialogConfig.showFooterLabel,cls:"sch-export-dialog-footer",name:"showFooter",checked:!!t.exportConfig.showFooter,checkedValue:!0,uncheckedValue:!1})),e.exportersField=new Ext.form.field.ComboBox({value:t.defaultExporter,triggerAction:"all",cls:"sch-export-dialog-exporter",forceSelection:!0,editable:!1,fieldLabel:t.exportersFieldLabel,name:"exporterId",queryMode:"local",displayField:"name",valueField:"value",store:{fields:["name","value"],data:Ext.Array.map(t.exporters,function(e){return{name:e.getName(),value:e.getExporterId()}})},listeners:{change:e.onExporterChange,scope:e}}),e.formatField=new Ext.form.field.ComboBox({value:t.exportConfig.format,triggerAction:"all",forceSelection:!0,editable:!1,fieldLabel:t.formatFieldLabel,name:"format",queryMode:"local",store:t.pageFormats||["A5","A4","A3","Letter","Legal"]});var a="portrait"===t.exportConfig.orientation?'class="sch-none"':"",s="landscape"===t.exportConfig.orientation?'class="sch-none"':"";return e.orientationField=new Ext.form.field.ComboBox({value:t.exportConfig.orientation,triggerAction:"all",componentCls:"sch-exportdialogform-orientation",forceSelection:!0,editable:!1,fieldLabel:e.dialogConfig.orientationFieldLabel,afterSubTpl:new Ext.XTemplate('<span id="sch-exportdialog-imagePortrait" '+s+'></span><span id="sch-exportdialog-imageLandscape" '+a+"></span>"),name:"orientation",displayField:"name",valueField:"value",queryMode:"local",store:new Ext.data.Store({fields:["name","value"],data:[{name:t.orientationPortraitText,value:"portrait"},{name:t.orientationLandscapeText,value:"landscape"}]}),listeners:{change:function(e,t){switch(t){case"landscape":case"portrait":Ext.fly("sch-exportdialog-imagePortrait").toggleCls("sch-none"),Ext.fly("sch-exportdialog-imageLandscape").toggleCls("sch-none")}}}}),r.push(e.rangeField),r.push(e.resizerHolder),r.push(e.datesHolder),r.push(e.exportersField),r.push(e.formatField),r.push(e.orientationField),t.showColumnPicker&&r.push(e.columnPicker),t.showDPIField&&r.push(e.dpiField),t.showHeaderField&&r.push(e.showHeaderField),t.showFooterField&&r.push(e.showFooterField),r},createProgressBar:function(){return this.progressBar=new Ext.ProgressBar({text:this.config.progressBarText,animate:!0,hidden:!0,margin:"4px 0 10px 0"})},onRangeChange:function(e,t){switch(t){case"complete":this.datesHolder.hide(),this.resizerHolder.hide();break;case"date":this.datesHolder.show(),this.resizerHolder.hide();break;case"current":this.datesHolder.hide(),this.resizerHolder.show(),this.resizePicker.expand(!0)}},onExporterChange:function(e,t){switch(t){case"singlepage":this.disableFields(!0);break;default:this.disableFields(!1)}},disableFields:function(e){var t=this;t.showHeaderField&&t.showHeaderField.setDisabled(e),t.formatField.setDisabled(e),t.orientationField.setDisabled(e)},showProgressBar:function(){this.progressBar&&this.progressBar.show()},hideProgressBar:function(){this.progressBar&&this.progressBar.hide()},updateProgressBar:function(e,t){this.progressBar&&(this.progressBar.updateProgress(e),t&&this.progressBar.updateText(t))}}),Ext.define("Sch.widget.ExportDialog",{alternateClassName:"Sch.widget.PdfExportDialog",extend:Ext.window.Window,mixins:[Sch.mixin.Localizable],alias:"widget.exportdialog",modal:!1,width:350,cls:"sch-exportdialog",frame:!1,layout:"fit",draggable:!0,padding:0,myConfig:null,plugin:null,buttonsPanel:null,buttonsPanelScope:null,progressBar:null,Date_RangeFormat:"",showHeaderField:!0,showFooterField:!1,showColumnPicker:!1,columnPickerConfig:null,showDPIField:!1,dpiFieldConfig:null,constructor:function(e){Ext.apply(this,e.exportDialogConfig),this.plugin=e.plugin,this.title=this.title||this.L("title"),this.myConfig=Ext.apply({progressBarText:this.L("progressBarText"),Date_RangeToText:this.L("Date_RangeToText"),pickerText:this.L("pickerText"),Date_RangeFromText:this.L("Date_RangeFromText"),Date_RangeText:this.L("Date_RangeText"),currentViewText:this.L("currentViewText"),formatFieldLabel:this.L("formatFieldLabel"),orientationFieldLabel:this.L("orientationFieldLabel"),rangeFieldLabel:this.L("rangeFieldLabel"),showHeaderLabel:this.L("showHeaderLabel"),showFooterLabel:this.L("showFooterLabel"),exportersFieldLabel:this.L("exportersFieldLabel"),orientationPortraitText:this.L("orientationPortraitText"),orientationLandscapeText:this.L("orientationLandscapeText"),completeViewText:this.L("completeViewText"),adjustCols:this.L("adjustCols"),adjustColsAndRows:this.L("adjustColsAndRows"),specifyDate_Range:this.L("specifyDate_Range"),columnPickerLabel:this.L("columnPickerLabel"),dpiFieldLabel:this.L("dpiFieldLabel"),Date_RangeFormat:this.Date_RangeFormat,exportConfig:this.exportConfig,showColumnPicker:this.showColumnPicker,columnPickerConfig:this.columnPickerConfig,showHeaderField:this.showHeaderField,showFooterField:this.showFooterField,pageFormats:this.getPageFormats(),scheduler:this.plugin&&this.plugin.scheduler},e.exportDialogConfig),this.callParent(arguments)},getPageFormats:function(){var e=this.plugin.pageSizes,t=[];return Ext.Object.each(e,function(e,i){t.push({width:i.width,height:i.height,name:e})}),Ext.Array.map(t.sort(function(e,t){return e.width-t.width}),function(e){return e.name})},initComponent:function(){var e=this,t={hidedialogwindow:e.destroy,showdialogerror:e.showError,updateprogressbar:function(t,i){2==arguments.length?e.fireEvent("updateprogressbar",t,void 0):e.fireEvent("updateprogressbar",t,i)},scope:this};e.form=e.buildForm(e.myConfig),Ext.apply(this,{items:e.form,fbar:e.buildButtons(e.buttonsPanelScope||e)}),e.callParent(arguments),e.plugin.on(t)},afterRender:function(){var e=this;e.relayEvents(e.form.resizePicker,["change","changecomplete","select"]),e.form.relayEvents(e,["updateprogressbar","hideprogressbar","showprogressbar"]),e.callParent(arguments)},buildButtons:function(e){return[{xtype:"button",scale:"medium",text:this.L("exportButtonText"),handler:function(){if(this.form.isValid()){this.fireEvent("showprogressbar");var e=this.form.getValues();e.exporterId=e.exporterId;var t=this.Date_RangeFormat||Ext.Date.defaultFormat;e.dateFrom&&!Ext.isDate(e.dateFrom)&&(e.dateFrom=Ext.Date.parse(e.dateFrom,t)),e.dateTo&&!Ext.isDate(e.dateTo)&&(e.dateTo=Ext.Date.parse(e.dateTo,t)),this.plugin.doExport(e)}},scope:e},{xtype:"button",scale:"medium",text:this.L("cancelButtonText"),handler:function(){this.destroy()},scope:e}]},buildForm:function(e){return new Sch.widget.ExportDialogForm({progressBar:this.progressBar,dialogConfig:e})},showError:function(e,t){var i=e,n=t||i.L("generalError");i.fireEvent("hideprogressbar"),Ext.Msg.alert("",n)}}),Ext.define("Sch.plugin.Export",{extend:Ext.util.Observable,alternateClassName:"Sch.plugin.PdfExport",alias:"plugin.scheduler_export",mixins:[Ext.AbstractPlugin,Sch.mixin.Localizable],lockableScope:"top",pageSizes:{A5:{width:5.8,height:8.3},A4:{width:8.3,height:11.7},A3:{width:11.7,height:16.5},Letter:{width:8.5,height:11},Legal:{width:8.5,height:14}},DPI:72,printServer:void 0,timeout:6e4,headerTpl:null,headerTplDataFn:null,headerTplDataFnScope:null,tpl:null,footerTpl:null,footerTplDataFn:null,footerTplDataFnScope:null,exportDialogClassName:"Sch.widget.ExportDialog",exportDialogConfig:{},exporterConfig:null,exportConfig:{format:"A4",orientation:"portrait",range:"complete",showHeader:!0,showFooter:!1},expandAllBeforeExport:!1,translateURLsToAbsolute:!0,openAfterExport:!0,beforeExport:Ext.emptyFn,afterExport:Ext.emptyFn,fileFormat:"pdf",defaultExporter:"multipage",exporters:void 0,callbacks:void 0,constructor:function(e){var t=this;e=e||{},t.exportersIndex={},e.exportDialogConfig&&Ext.Object.each(this.exportConfig,function(t,i,n){var r=e.exportDialogConfig[t];r&&(n[t]=r)}),t.callParent([e]),t.setFileFormat(t.fileFormat),t.exporters||(t.exporters=t.buildExporters()),t.initExporters(),t.bindExporters()},init:function(e){var t=this;e.showExportDialog=Ext.Function.bind(t.showExportDialog,t),e.doExport=Ext.Function.bind(t.doExport,t),t.scheduler=e},initExporters:function(){for(var e=this,t=e.exporters,i=0;i<t.length;i++)t[i]instanceof Sch.plugin.exporter.AbstractExporter||(t[i]=e.createExporter(t[i]))},bindExporters:function(){for(var e=this.exporters,t=0;t<e.length;t++)this.bindExporter(e[t])},bindExporter:function(e){var t=this;t.mon(e,{commitpage:t.onPageCommit,collectrows:t.onRowCollected,scope:t})},unbindExporter:function(e){var t=this;t.mun(e,{commitpage:t.onPageCommit,collectrows:t.onRowCollected,scope:t})},buildExporters:function(){return["Sch.plugin.exporter.SinglePage","Sch.plugin.exporter.MultiPage","Sch.plugin.exporter.MultiPageVertical"]},getExporterConfig:function(e,t){var i=this,n=Ext.apply({translateURLsToAbsolute:i.translateURLsToAbsolute,expandAllBeforeExport:i.expandAllBeforeExport,DPI:i.DPI},i.exporterConfig);return i.headerTpl&&(n.headerTpl=i.headerTpl),i.headerTplDataFn&&(n.headerTplDataFn=i.headerTplDataFn,n.headerTplDataFnScope=i.headerTplDataFnScope),i.tpl&&(n.tpl=i.tpl),i.footerTpl&&(n.footerTpl=i.footerTpl),i.footerTplDataFn&&(n.footerTplDataFn=i.footerTplDataFn,n.footerTplDataFnScope=i.footerTplDataFnScope),n},createExporter:function(e,t){var i=this,n=i.getExporterConfig(e,t);return Ext.isObject(e)?Ext.create(Ext.apply(n,e)):Ext.create(e,Ext.apply(n,t))},registerExporter:function(e,t){e instanceof Sch.plugin.exporter.AbstractExporter||(e=this.createExporter.apply(this,arguments)),this.exporters.push(e),this.bindExporter(e)},getExporter:function(e){if(e){var t=this.exportersIndex[e];return t||(t=this.exportersIndex[e]=Ext.Array.findBy(this.exporters,function(t){return t.getExporterId()==e}))}},getExporters:function(){return this.exporters},setFileFormat:function(e){"string"!=typeof e?this.fileFormat="pdf":(e=e.toLowerCase(),this.fileFormat="png"===e?e:"pdf")},showExportDialog:function(){var e=this,t=e.scheduler.getSchedulingView();e.win&&(e.win.destroy(),e.win=null),e.win=Ext.create(e.exportDialogClassName,{plugin:e,exportDialogConfig:Ext.apply({startDate:e.scheduler.getStart(),endDate:e.scheduler.getEnd(),rowHeight:t.timeAxisViewModel.getViewRowHeight(),columnWidth:t.timeAxisViewModel.getTickWidth(),defaultExporter:e.defaultExporter,exporters:e.exporters,exportConfig:Ext.apply(e.exportConfig,{DPI:e.DPI})},e.exportDialogConfig)}),e.win.show()},getExportConfig:function(e){var t=this,i=Ext.apply({fileFormat:t.fileFormat,exporterId:t.defaultExporter,beforeExport:Ext.Function.bind(t.beforeExport,t),afterExport:Ext.Function.bind(t.afterExport,t)},e,t.exportConfig);return i.DPI=i.DPI||t.DPI,i.pageSize=Ext.apply({},t.pageSizes[i.format]),i.pageSize.width*=i.DPI,i.pageSize.height*=i.DPI,i},doExport:function(e,t,i,n){var r=this,a=r.scheduler,s=r.getExportConfig(e);r.callbacks={success:t||Ext.emptyFn,failure:i||Ext.emptyFn,scope:n||r};var o=r.exporter=r.getExporter(s.exporterId);o&&!1!==r.fireEvent("beforeexport",a,o,s)&&(r.mask(),r.exporter.extractPages(a,s,function(e){r.fireEvent("pagesextracted",e,a,o,s),r.onPagesExtracted(e,a,o,s)},r))},onPagesExtracted:function(e,t,i,n){this.fireEvent("updateprogressbar",.8,this.L("requestingPrintServer")),this.doRequest(e,n)},onRowCollected:function(e,t,i,n){this.fireEvent("updateprogressbar",.2*(i+1)/n,Ext.String.format(this.L("fetchingRows"),i+1,n))},onPageCommit:function(e,t,i,n){n=Math.max(i,n),this.fireEvent("updateprogressbar",.2+.6*i/n,Ext.String.format(this.L("builtPage"),i,n))},onExportSuccess:function(e){var t=this,i=t.getWin(),n=t.callbacks,r=n&&n.success,a=n&&n.scope||t;t.fireEvent("updateprogressbar",1),t.unmask(),r&&r.apply(a,arguments),setTimeout(function(){t.fireEvent("hidedialogwindow",e),t.openAfterExport&&window.open(e.url,"ExportedPanel")},i?i.hideTime:3e3)},onExportFailure:function(e,t){var i=this,n=this.getWin(),r=i.callbacks,a=r&&r.failure,s=r&&r.scope||i;a&&a.call(s,e),i.fireEvent("showdialogerror",n,e,t),i.unmask()},doRequest:function(e,t){var i=this,n=i.scheduler;if(i.test||i.debug){if(i.debug)for(var r=e||[],a=0,s=r.length;a<s;a++){var o=window.open();o.document.write(r[a].html),o.document.close()}i.onExportSuccess(i.testResponse||{success:!0,url:"foo",htmlArray:e})}else if(i.printServer){var l={method:"POST",url:i.printServer,timeout:i.timeout,params:Ext.apply({html:{array:Ext.JSON.encode(e)},startDate:n.getStartDate(),endDate:n.getEndDate(),format:i.exporter.getPaperFormat(),orientation:t.orientation,range:t.range,fileFormat:i.fileFormat},this.getParameters()),success:i.onRequestSuccess,failure:i.onRequestFailure,scope:i};Ext.apply(l,this.getAjaxConfig(l)),Ext.Ajax.request(l)}else i.onExportFailure("Print server URL is not defined, please specify printServer config")},onRequestSuccess:function(e){var t,i=this;try{t=Ext.JSON.decode(e.responseText)}catch(e){return void i.onExportFailure("Wrong server response received")}t.success?i.onExportSuccess(t):i.onExportFailure(t.msg,t)},onRequestFailure:function(e){var t=this,i=200===e.status?e.responseText:e.statusText;t.onExportFailure(i,e)},getParameters:function(){return{}},getAjaxConfig:function(e){return{}},getWin:function(){return this.win||null},mask:function(){Ext.getBody().mask().addCls("sch-export-mask")},unmask:function(){Ext.getBody().unmask()},destroy:function(){this.callParent(arguments),this.win&&this.win.destroy()}}),Ext.define("Sch.plugin.Pan",{extend:Ext.AbstractPlugin,alias:"plugin.scheduler_pan",lockableScope:"top",enableVerticalPan:!0,statics:{KEY_SHIFT:1,KEY_CTRL:2,KEY_ALT:4,KEY_ALL:7},disableOnKey:0,constructor:function(e){Ext.apply(this,e)},init:function(e){Ext.supports.Touch||(this.view=e.getSchedulingView(),this.view.on("afterrender",this.onRender,this))},onRender:function(e){this.view.el.on("mousedown",this.onMouseDown,this)},onMouseDown:function(e,t){var i=this.self,n=this.disableOnKey;e.shiftKey&&n&i.KEY_SHIFT||e.ctrlKey&&n&i.KEY_CTRL||e.altKey&&n&i.KEY_ALT||e.getTarget("."+this.view.timeCellCls,10)&&!e.getTarget(this.view.eventSelector)&&(this.mouseX=e.getX(),this.mouseY=e.getY(),Ext.getBody().on("mousemove",this.onMouseMove,this),Ext.getDoc().on("mouseup",this.onMouseUp,this),(Ext.isIE||Ext.isGecko)&&Ext.getBody().on("mouseenter",this.onMouseUp,this),e.stopEvent())},onMouseMove:function(e){if(!this.disabled){e.stopEvent();var t=e.getX(),i=e.getY(),n=0,r=this.mouseX-t;this.enableVerticalPan&&(n=this.mouseY-i),this.mouseX=t,this.mouseY=i,this.view.scrollBy(r,n,!1)}},onMouseUp:function(e){Ext.getBody().un("mousemove",this.onMouseMove,this),Ext.getDoc().un("mouseup",this.onMouseUp,this),(Ext.isIE||Ext.isGecko)&&Ext.getBody().un("mouseenter",this.onMouseUp,this)}}),Ext.define("Sch.plugin.Printable",{extend:Sch.plugin.Export,alias:"plugin.scheduler_printable",docType:"<!DOCTYPE HTML>",beforePrint:Ext.emptyFn,afterPrint:Ext.emptyFn,exportDialogConfig:{showDPIField:!0},removeSecondaryCanvas:!1,wrapHeaders:!1,autoPrintAndClose:!0,mainTpl:null,pageTpl:'{header}<div class="{componentClasses}" style="height:{bodyHeight}px; width:{totalWidth}px; position: relative !important">{HTML}</div>{footer}<div style="page-break-after:always;"></div>',openAfterExport:!1,DPI:72,fakeBackgroundColor:!1,constructor:function(e){Ext.apply(this,e),this.exportDialogConfig=Ext.apply({title:this.L("dialogTitle")},this.exportDialogConfig),this.exportDialogConfig.l10n=Ext.apply({rangeFieldLabel:this.L("rangeFieldLabel"),exportersFieldLabel:this.L("exportersFieldLabel"),exportButtonText:this.L("exportButtonText")},this.exportDialogConfig.l10n),this.mainTpl||(this.mainTpl=new Ext.XTemplate('{docType}<html class="'+Ext.baseCSSPrefix+'border-box {htmlClasses}"><head><meta content="text/html; charset=UTF-8" http-equiv="Content-Type" /><title>{title}</title>{styles}</head><body class="sch-print-body {bodyClasses}"><div class="sch-print-ct" style="width:{totalWidth}px"><tpl for="pages">{html}</tpl></div><script type="text/javascript">{setupScript}<\/script></body></html>')),this.callParent(arguments)},init:function(e){this.callParent(arguments),e.print=Ext.Function.bind(this.print,this)},getExporterConfig:function(e,t){var i=this,n=i.callParent(arguments);return Ext.apply(n,{tpl:i.pageTpl})},getExportConfig:function(e){var t=this,i=t.callParent(arguments);return Ext.apply(i,{beforeExport:Ext.Function.bind(t.beforePrint,t),afterExport:Ext.Function.bind(t.afterPrint,t)})},buildExporters:function(){return["Sch.plugin.exporter.MultiPage","Sch.plugin.exporter.MultiPageVertical"]},doRequest:Ext.emptyFn,onPagesExtracted:function(e,t,i,n){this.fireEvent("updateprogressbar",.8,this.L("requestingPrintServer")),this.printPages(e,t,i,n)},print:function(){this.showExportDialog()},onBeforePageCommit:function(e,t,i,n){var r=this.scheduler,a=r.lockedGrid,s=r.normalGrid,o=function(e){return t.select("#"+e).first()},l=t.select(e.normalBodySelector).first(),d=o(s.headerCt.id),c=t.select(e.lockedBodySelector).first(),h=o(a.headerCt.id);if(l.addCls(["sch-print-normal-rows-ct",this.fakeBackgroundColor?" sch-print-fake-background":""]),c.addCls("sch-print-locked-rows-ct"),this.removeSecondaryCanvas&&t.select(".sch-secondary-canvas").remove(),this.fakeBackgroundColor){l.select(".sch-event").each(function(e){e.setStyle("border-right-width",e.dom.style.width)})}d.addCls("sch-print-normalheader"),h.addCls("sch-print-lockedheader"),this.wrapHeaders&&(d.wrap('<div class="sch-print-header-wrap"></div>'),h.wrap('<div class="sch-print-header-wrap"></div>'))},printPages:function(e,t,i,n){this.mainTpl&&this.mainTpl.isTemplate||(this.mainTpl=new Ext.XTemplate(this.mainTpl,{compiled:!0,disableFormats:!0}));var r=i.getStylesheets(),a=Ext.getBody(),s=this.mainTpl.apply({docType:this.docType,htmlClasses:a.parent().dom.className,bodyClasses:a.dom.className,title:t.title||"",styles:r,totalWidth:i.paperWidth,setupScript:"window.onload = function(){ ("+this.setupScript.toString()+")("+[!!this.autoPrintAndClose,!!Ext.isChrome]+"); };",pages:e}),o=window.open("","printgrid");if(!o||!o.document)return!1;this.printWindow=o,o.document.write(s),o.document.close(),this.onExportSuccess({success:!0,url:"foo",htmlArray:[s]})},bindExporter:function(e){var t=this;t.callParent(arguments),t.mon(e,{beforecommitpage:t.onBeforePageCommit,scope:t})},unbindExporter:function(e){var t=this;t.callParent(arguments),t.mun(e,{beforecommitpage:t.onBeforePageCommit,scope:t})},setupScript:function(e,t){document._loaded=!0,e&&(window.print(),t||window.close())}}),Ext.define("Sch.plugin.TreeCellEditing",{extend:Ext.grid.plugin.CellEditing,alias:"plugin.scheduler_treecellediting",lockableScope:"locked",editorsStarted:0,init:function(){this.on("beforeedit",this.onMyBeforeEdit,this),this.callParent(arguments)},activateCell:function(e){var t=this.callParent(arguments);if(t){var i=this.getEditor(e.record,e.column);i&&!i._cancelEdit&&(i._cancelEdit=i.cancelEdit,i.cancelEdit=this.myCancelEdit)}return t},checkReadOnly:function(){var e=this.getCmp();if(e)return e.isTimelineTreePanel||e.isTimelineGridPanel||(e=e.up("tablepanel")),!e.isReadOnly()},onEditComplete:function(e,t,i){var n=this;return e.field.applyChanges?(e.field.applyChanges(e.field.task||n.context.record),n.callParent([e,t,t])):n.callParent([e,t,i])},myCancelEdit:function(){var e=this,t=e.field;if(t&&t.applyChanges){var i=t.instantUpdate;t.instantUpdate=!0;var n=e._cancelEdit.apply(this,arguments)
;return t.instantUpdate=i,n}return e._cancelEdit.apply(this,arguments)},onMyBeforeEdit:function(e,t){var i=t.column.getEditor();return i&&i.setTask&&(i.setTask(t.record),t.value=t.originalValue=i.getValue()),this.checkReadOnly()}}),Ext.define("Gnt.locale.En",{extend:Sch.locale.Locale,singleton:!0,l10n:{"Gnt.util.DurationParser":{unitsRegex:{MILLI:/^ms$|^mil/i,SECOND:/^s$|^sec/i,MINUTE:/^m$|^min/i,HOUR:/^h$|^hr$|^hour/i,DAY:/^d$|^day/i,WEEK:/^w$|^wk|^week/i,MONTH:/^mo|^mnt/i,QUARTER:/^q$|^quar|^qrt/i,YEAR:/^y$|^yr|^year/i}},"Gnt.util.DependencyParser":{typeText:{SS:"SS",SF:"SF",FS:"FS",FF:"FF"}},"Gnt.panel.Timeline":{start:"Start",end:"End"},"Gnt.field.ShowInTimeline":{yes:"Yes",no:"No"},"Gnt.column.ShowInTimeline":{text:"Show in timeline"},"Gnt.field.ConstraintType":{none:"None"},"Gnt.field.Duration":{invalidText:"Invalid value"},"Gnt.field.Effort":{invalidText:"Invalid value"},"Gnt.field.Percent":{invalidText:"Invalid value"},"Gnt.field.SchedulingMode":{Normal:"Normal",FixedDuration:"Fixed duration",EffortDriven:"Effort driven",DynamicAssignment:"Dynamic assignment"},"Gnt.feature.DependencyDragDrop":{fromText:"From",toText:"To",startText:"Start",endText:"End"},"Gnt.Tooltip":{startText:"Starts: ",endText:"Ends: ",durationText:"Duration: "},"Gnt.plugin.TaskContextMenu":{taskInformation:"Task information...",projectInformation:"Project information...",newTaskText:"New task",deleteTask:"Delete task(s)",editLeftLabel:"Edit left label",editRightLabel:"Edit right label",add:"Add...",deleteDependency:"Delete dependency...",addTaskAbove:"Task above",addTaskBelow:"Task below",addMilestone:"Milestone",addSubtask:"Sub-task",addSuccessor:"Successor",addPredecessor:"Predecessor",convertToMilestone:"Convert to milestone",convertToRegular:"Convert to regular task",splitTask:"Split task"},"Gnt.plugin.DependencyEditor":{fromText:"From",toText:"To",typeText:"Type",lagText:"Lag",endToStartText:"Finish-To-Start",startToStartText:"Start-To-Start",endToEndText:"Finish-To-Finish",startToEndText:"Start-To-Finish"},"Gnt.widget.calendar.Calendar":{dayOverrideNameHeaderText:"Name",overrideName:"Name",startDate:"Start Date",endDate:"End Date",error:"Error",dateText:"Date",addText:"Add",editText:"Edit",removeText:"Remove",workingDayText:"Working day",weekendsText:"Weekends",overriddenDayText:"Overridden day",overriddenWeekText:"Overridden week",workingTimeText:"Working time",nonworkingTimeText:"Non-working time",dayOverridesText:"Day overrides",weekOverridesText:"Week overrides",okText:"OK",cancelText:"Cancel",parentCalendarText:"Parent calendar",noParentText:"No parent",selectParentText:"Select parent",newDayName:"[Without name]",calendarNameText:"Calendar name",tplTexts:{tplWorkingHours:"Working hours for",tplIsNonWorking:"is non-working",tplOverride:"override",tplInCalendar:"in calendar",tplDayInCalendar:"standard day in calendar",tplBasedOn:"Based on"},overrideErrorText:"There is already an override for this day",overrideDateError:"There is already a week override on this date: {0}",startAfterEndError:"Start date should be less than end date",weeksIntersectError:"Week overrides should not intersect"},"Gnt.widget.calendar.AvailabilityGrid":{startText:"Start",endText:"End",addText:"Add",removeText:"Remove",error:"Error"},"Gnt.widget.calendar.DayEditor":{workingTimeText:"Working time",nonworkingTimeText:"Non-working time"},"Gnt.widget.calendar.WeekEditor":{defaultTimeText:"Default time",workingTimeText:"Working time",nonworkingTimeText:"Non-working time",error:"Error",noOverrideError:"Week override contains only 'default' days - can't save it"},"Gnt.widget.calendar.ResourceCalendarGrid":{name:"Name",calendar:"Calendar"},"Gnt.widget.calendar.CalendarWindow":{ok:"Ok",cancel:"Cancel"},"Gnt.widget.calendar.CalendarManager":{addText:"Add",removeText:"Remove",add_child:"Add child",add_node:"Add calendar",add_sibling:"Add sibling",remove:"Remove",calendarName:"Calendar",confirm_action:"Confirm action",confirm_message:"Calendar has unsaved changes. Would you like to save your changes?"},"Gnt.widget.calendar.CalendarManagerWindow":{title:"Calendar manager",ok:"Apply changes",cancel:"Close",confirm_action:"Confirm action",confirm_message:"Calendar has unsaved changes. Would you like to save your changes?"},"Gnt.field.Assignment":{cancelText:"Cancel",closeText:"Save and Close"},"Gnt.column.AssignmentUnits":{text:"Units"},"Gnt.column.Duration":{text:"Duration"},"Gnt.column.Effort":{text:"Effort"},"Gnt.column.EndDate":{text:"Finish"},"Gnt.column.PercentDone":{text:"% Done"},"Gnt.column.ResourceAssignment":{text:"Assigned Resources"},"Gnt.column.ResourceName":{text:"Resource Name"},"Gnt.column.Rollup":{text:"Rollup task",no:"No",yes:"Yes"},"Gnt.field.ManuallyScheduled":{yes:"Yes",no:"No"},"Gnt.field.ReadOnly":{yes:"Yes",no:"No"},"Gnt.column.ManuallyScheduled":{text:"Manual mode"},"Gnt.column.SchedulingMode":{text:"Mode"},"Gnt.column.Predecessor":{text:"Predecessors"},"Gnt.column.Successor":{text:"Successors"},"Gnt.column.StartDate":{text:"Start"},"Gnt.column.WBS":{text:"WBS"},"Gnt.column.Sequence":{text:"#"},"Gnt.column.Calendar":{text:"Calendar"},"Gnt.widget.taskeditor.ProjectForm":{projectText:"Project",nameText:"Name",datesText:"Dates",startText:"Start",finishText:"Finish",calendarText:"Calendar",readOnlyText:"Readonly",allowDependenciesText:"Allow cross-pms dependencies"},"Gnt.widget.taskeditor.TaskForm":{taskNameText:"Name",durationText:"Duration",datesText:"Dates",baselineText:"Baseline",startText:"Start",finishText:"Finish",percentDoneText:"Percent Complete",baselineStartText:"Start",baselineFinishText:"Finish",baselinePercentDoneText:"Percent Complete",effortText:"Effort",invalidEffortText:"Invalid effort value",calendarText:"Calendar",manuallyScheduledText:"Manually Scheduled",schedulingModeText:"Scheduling Mode",rollupText:"Rollup",wbsCodeText:"WBS code","Constraint Type":"Constraint Type","Constraint Date":"Constraint Date"},"Gnt.widget.DependencyGrid":{idText:"ID",snText:"SN",taskText:"Task Name",blankTaskText:"Please select task",invalidDependencyText:"Invalid dependency",parentChildDependencyText:"Dependency between child and parent found",duplicatingDependencyText:"Duplicate dependency found",transitiveDependencyText:"Transitive dependency",cyclicDependencyText:"Cyclic dependency",typeText:"Type",lagText:"Lag",clsText:"CSS class",endToStartText:"Finish-To-Start",startToStartText:"Start-To-Start",endToEndText:"Finish-To-Finish",startToEndText:"Start-To-Finish"},"Gnt.widget.AssignmentEditGrid":{confirmAddResourceTitle:"Confirm",confirmAddResourceText:"Resource &quot;{0}&quot; not found in list. Would you like to add it?",noValueText:"Please select resource to assign",noResourceText:"No resource &quot;{0}&quot; found in the list"},"Gnt.widget.taskeditor.ProjectEditor":{generalText:"General",descriptionText:"Description"},"Gnt.widget.taskeditor.TaskEditor":{generalText:"General",resourcesText:"Resources",dependencyText:"Predecessors",addDependencyText:"Add new",dropDependencyText:"Remove",notesText:"Notes",advancedText:"Advanced",addAssignmentText:"Add new",dropAssignmentText:"Remove"},"Gnt.plugin.taskeditor.BaseEditor":{title:"Task Information",alertCaption:"Information",alertText:"Please correct marked errors to save changes",okText:"Ok",cancelText:"Cancel"},"Gnt.plugin.taskeditor.ProjectEditor":{title:"Project Information"},"Gnt.field.EndDate":{endBeforeStartText:"End date is before start date"},"Gnt.column.Note":{text:"Note"},"Gnt.column.AddNew":{text:"Add new column..."},"Gnt.column.EarlyStartDate":{text:"Early Start"},"Gnt.column.EarlyEndDate":{text:"Early Finish"},"Gnt.column.LateStartDate":{text:"Late Start"},"Gnt.column.LateEndDate":{text:"Late Finish"},"Gnt.field.Calendar":{calendarNotApplicable:"Task calendar has no overlapping with assigned resources calendars"},"Gnt.column.Slack":{text:"Slack"},"Gnt.column.Name":{text:"Task Name"},"Gnt.column.BaselineStartDate":{text:"Baseline Start Date"},"Gnt.column.BaselineEndDate":{text:"Baseline End Date"},"Gnt.column.Milestone":{text:"Milestone"},"Gnt.field.Milestone":{yes:"Yes",no:"No"},"Gnt.field.Dependency":{invalidFormatText:"Invalid dependency format",invalidDependencyText:"Invalid dependency found, please make sure you have no cyclic paths between your tasks",invalidDependencyType:"Invalid dependency type {0}. Allowed values are: {1}."},"Gnt.constraint.Base":{name:"A constraint","Remove the constraint":"Remove the constraint","Cancel the change and do nothing":"Cancel the change and do nothing"},"Gnt.constraint.FinishNoEarlierThan":{name:"Finish no earlier than","Move the task to finish on {0}":"Move the task to finish on {0}"},"Gnt.constraint.FinishNoLaterThan":{name:"Finish no later than","Move the task to finish on {0}":"Move the task to finish on {0}"},"Gnt.constraint.MustFinishOn":{name:"Must finish on","Move the task to finish on {0}":"Move the task to finish on {0}"},"Gnt.constraint.MustStartOn":{name:"Must start on","Move the task to start at {0}":"Move the task to start at {0}"},"Gnt.constraint.StartNoEarlierThan":{name:"Start no earlier than","Move the task to start at {0}":"Move the task to start at {0}"},"Gnt.constraint.StartNoLaterThan":{name:"Start no later than","Move the task to start at {0}":"Move the task to start at {0}"},"Gnt.column.ConstraintDate":{text:"Constraint date"},"Gnt.column.ConstraintType":{text:"Constraint"},"Gnt.widget.ConstraintResolutionForm":{dateFormat:"m/d/Y",OK:"OK",Cancel:"Cancel","Resolution options":"Resolution options","Don't ask again":"Don't ask again","Task {0} violates constraint {1}":'Task "{0}" violates constraint {1}',"Task {0} violates constraint {1} {2}":'Task "{0}" violates constraint {1} {2}'},"Gnt.widget.ConstraintResolutionWindow":{"Constraint violation":"Constraint violation"},"Gnt.panel.ResourceHistogram":{resourceText:"Resource"}},apply:function(e){Sch.locale.En.apply(e),this.callParent(arguments)}}),Ext.define("Gnt.mixin.Localizable",{extend:Sch.mixin.Localizable}),Ext.define("Gnt.Tooltip",{extend:Ext.ToolTip,alias:"widget.gantt_task_tooltip",mixins:[Gnt.mixin.Localizable],mode:"startend",autoHide:!1,anchor:"b-tl",maskOnDisable:!1,template:null,initComponent:function(){this.rtl=this.gantt.rtl,"startend"!==this.mode||this.template||(this.template=new Ext.Template('<div class="sch-timetipwrap {cls}"><table cellpadding="0" cellspacing="0"><tr><td class="sch-gantt-tip-desc">'+this.L("startText")+'</td><td class="sch-gantt-tip-value">{startText}</td></tr><tr><td class="sch-gantt-tip-desc">'+this.L("endText")+'</td><td class="sch-gantt-tip-value">{endText}</td></tr></table></div>').compile()),"duration"!==this.mode||this.template||(this.template=new Ext.Template('<div class="sch-timetipwrap {cls}">','<table cellpadding="0" cellspacing="0"><tr><td class="sch-gantt-tip-desc">'+this.L("startText")+'</td><td class="sch-gantt-tip-value"> {startText}</td></tr>','<tr><td class="sch-gantt-tip-desc">'+this.L("durationText")+'</td><td class="sch-gantt-tip-value"> {duration} {unit}</td></tr>',"</table></div>").compile()),this.callParent(arguments),this.update(this.template.apply({})),this.addCls("gnt-tooltip")},updateContent:function(e,t,i,n){var r;r="duration"===this.mode?this.getDurationContent(e,t,i,n):this.getStartEndContent(e,t,i,n),this.update(r)},getStartEndContent:function(e,t,i,n){var r=this.gantt,a=r.getFormattedDate(e),s=a;t-e>0&&(s=r.getFormattedEndDate(t,e));var o={cls:i?"sch-tip-ok":"sch-tip-notok",startText:a,endText:s,task:n};return this.template.apply(o)},getDurationContent:function(e,t,i,n){var r=n.getDurationUnit()||Sch.util.Date.DAY,a=n.calculateDuration(e,t,r);return this.template.apply({cls:i?"sch-tip-ok":"sch-tip-notok",startText:this.gantt.getFormattedDate(e),duration:parseFloat(Ext.Number.toFixed(a,1)),unit:Sch.util.Date.getReadableNameOfUnit(r,a>1),task:n})},show:function(e,t){e&&(e.dom||e.className)&&this.setTarget(e),this.callParent([]),void 0!==t&&this.setX(t)}}),Ext.define("Gnt.column.AddNew",{extend:Ext.grid.column.Column,alias:["widget.addnewcolumn","widget.ganttcolumn.addnew"],mixins:[Gnt.mixin.Localizable],text:"",width:100,resizable:!1,sortable:!1,draggable:!1,colEditor:null,colEditorStore:null,columnList:null,initComponent:function(){this.text||(this.text=this.L("text")),this.addCls("gnt-addnewcolumn"),this.on({headerclick:this.myOnHeaderClick,headertriggerclick:this.myOnHeaderClick,scope:this}),this.callParent(arguments)},getGantt:function(){return this.gantt||(this.gantt=this.up("ganttpanel")),this.gantt},getColEditor:function(){var e,t=this;return t.colEditor||(e=t.colEditor=new Ext.Editor({shadow:!1,updateEl:!1,itemId:"addNewEditor",renderTo:t.el,offsets:[20,0],field:new Ext.form.field.ComboBox({displayField:"text",valueField:"clsName",hideTrigger:!0,queryMode:"local",forceSelection:!0,multiSelect:!1,listConfig:{itemId:"addNewEditorComboList",minWidth:150},store:t.getColEditorStore(),listeners:{render:function(){this.on("blur",function(){e.cancelEdit()})},select:t.onSelect,scope:t}})})),t.colEditor},getColEditorStore:function(){var e=this;return e.colEditorStore||(e.columnList=e.columnList||Gnt.column.AddNew.buildDefaultColumnList(),e.colEditorStore=new Ext.data.Store({fields:["text","clsName","config"],data:e.columnList,sorters:[{property:"text",direction:"ASC"}]})),e.colEditorStore},myOnHeaderClick:function(){var e,t,i=this;return t=i.el.down("."+Ext.baseCSSPrefix+"column-header-text"),e=i.getColEditor(),e.startEdit(t,""),e.field.reset(),e.field.setWidth(this.getWidth()-20),e.field.expand(),!1},onSelect:function(e,t){var i=this;i.colEditor.cancelEdit(),i.addColumn(Ext.isArray(t)?t[0]:t)},addColumn:function(e){var t=this,i=e,n=t.ownerCt,r=i.get("text"),a=i.get("config")||{},s=i.get("clsName")||a.xclass||"Ext.grid.column.Column";Ext.require(s,function(){var e=Ext.ClassManager.get(s),i=Ext.create(Ext.applyIf(a,{xclass:s,dataIndex:t.getGantt().taskStore.model.prototype[e.prototype.fieldProperty],text:r}));n.insert(n.items.indexOf(t),i)})},statics:{buildDefaultColumnList:function(){var e=[];return Ext.Array.each(Ext.ClassManager.getNamesByExpression("widget.ganttcolumn.*"),function(t){var i=Ext.ClassManager.get(t);i&&i!==Gnt.column.AddNew&&!Gnt.column.AddNew.prototype.isPrototypeOf(i.prototype)&&e.push({clsName:t,text:i.prototype.localize?i.prototype.localize("text"):i.prototype.text})}),Ext.Array.sort(e,function(e,t){return e.text>t.text?1:-1})}}}),Ext.define("Gnt.column.AssignmentUnits",{extend:Ext.grid.column.Number,mixins:[Gnt.mixin.Localizable],alias:"widget.assignmentunitscolumn",dataIndex:"Units",format:"0 %",align:"left",constructor:function(e){e=e||{},this.text=e.text||this.L("text"),this.scope=this,this.callParent(arguments)},renderer:function(e,t,i){if(e)return Ext.util.Format.number(e,this.format)}}),Ext.define("Gnt.field.mixin.TaskField",{extend:Ext.Mixin,taskField:"",fieldProperty:"",getTaskValueMethod:"",setTaskValueMethod:"",isTaskField:!0,task:null,taskStore:null,suppressTaskUpdate:0,highlightTaskUpdates:!0,highlightColor:"#009900",lastHighlight:0,instantUpdate:!0,mixinConfig:{before:{constructor:"beforeConstructed",destroy:"beforeDestroyed"},after:{constructor:"afterConstructed"}},beforeConstructed:function(){this.setSuppressTaskUpdate(!0)},afterConstructed:function(){this.taskField=this.taskField||this.fieldProperty,this.task&&this.setTask(this.task),this.setSuppressTaskUpdate(!1)},beforeDestroyed:function(){this.destroyTaskListener()},setTask:function(e){if(e){if(this.destroyTaskListener(),this.updateReadOnly(e),this.task=e,e.on("taskupdated",this.onTaskUpdateProcess,this),!e.getCalendar(!0)&&!e.getTaskStore(!0)){if(e.taskStore=e.getTaskStore(!0)||this.taskStore,!e.taskStore)throw"Configuration issue: Gnt.data.taskStore instance should be provided.";if(!e.getCalendar(!0)&&!e.taskStore.getCalendar())throw"Configuration issue: Gnt.data.Calendar instance should be provided."}this.setSuppressTaskUpdate(!0),this.onSetTask(e),this.setSuppressTaskUpdate(!1)}},onSetTask:function(e){e=e||this.task,this.setValue(this.getTaskValue(e))},setSuppressTaskUpdate:function(e){e?this.suppressTaskUpdate++:this.suppressTaskUpdate--},getSuppressTaskUpdate:function(){return this.suppressTaskUpdate},updateReadOnly:function(e){this.disabled||this.forceReadOnly||(!1===this.editable?e.isEditable(e[this.taskField])?this.inputEl&&(this.setReadOnly(!1),this.inputEl.dom.readOnly=!0):this.setReadOnly(!0):this.setReadOnly(!e.isEditable(e[this.taskField])))},onTaskUpdateProcess:function(e,t){if(t!==this){var i=this.getValue();if(this.updateReadOnly(e),this.setSuppressTaskUpdate(!0),this.onTaskUpdate?this.onTaskUpdate(e,t):this.onSetTask(e),this.setSuppressTaskUpdate(!1),this.highlightTaskUpdates){var n=this.getValue(),r=Ext.isDate(i);(r&&i-n!=0||!r&&String(i)!==String(n))&&this.highlightField()}}},highlightField:function(e,t){this.rendered&&new Date-this.lastHighlight>1e3&&(this.lastHighlight=new Date,this.inputEl.highlight(e||this.highlightColor,t||{attr:"color"}))},destroyTaskListener:function(){this.task&&this.task.un("taskupdated",this.onTaskUpdateProcess,this)},callTaskMethod:function(e,t,i){return(e=e||this.task)&&e[t].apply(e,i)},getTaskValue:function(e){return this.callTaskMethod(e,this.getTaskValueMethod,Ext.Array.slice(arguments,1))},setTaskValue:function(e){return this.callTaskMethod(e,this.setTaskValueMethod,Ext.Array.slice(arguments,1))},applyChanges:function(e){e=e||this.task,this.setTaskValue(e,this.getValue()),e.fireEvent("taskupdated",e,this)}}),Ext.define("Gnt.field.Date",{extend:Ext.form.field.Date,mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],adjustMilestones:!0,keepDuration:!1,reAssertValue:!0,keepTime:!0,onExpand:function(){var e=this.valueToVisible(this.getValue());this._expanding=!1,this.isValid()||(e=this.getRawValue())&&(e=Ext.Date.parse(e,this.format)),this.picker.setValue(Ext.isDate(e)?e:new Date)},applyKeptTimeToValue:function(e){return this.keepTime&&!Ext.Date.formatContainsHourInfo(this.format)&&this.applyTimeToValue(e,this.getTaskValue()),e},applyTimeToValue:function(e,t){return t=t||this.getTaskValue(),Ext.isDate(e)&&t&&(e.setHours(t.getHours()),e.setMinutes(t.getMinutes())),e},onSelect:function(e,t){var i=this;Ext.Date.formatContainsHourInfo(this.format)&&i.applyTimeToValue(t,this.getTaskValue());var n=i.getValue(),r=this.visibleToValue(t),a=Ext.Date.format(t,this.format);i.inputEl.focus(),n!=r&&(this.getErrors(a).length>0?(i.setRawValue(a),i.collapse(),i.validate()):(i.setValue(r,!0),i.fireEvent("select",i,r),i.collapse()))},setValue:function(e,t){if(!this._expanding){this.callParent([e]);var i=this.task;if((t||this.instantUpdate)&&!this.getSuppressTaskUpdate()&&i&&i.taskStore&&e){if(this.applyChanges(),this.reAssertValue){var n=this.getTaskValue();n-this.getValue()!=0&&this.callParent([n])}i.fireEvent("taskupdated",i,this)}}},rawToValue:function(e){if(!e)return null;var t=this.applyKeptTimeToValue(this.parseDate(e));return this.visibleToValue(t)},valueToRaw:function(e){return e?Ext.Date.format(this.valueToVisible(e),this.format):e},getValue:function(){return Ext.isEmpty(this.value)?null:this.value},visibleToValue:function(){throw"Abstract visibleToValue method called"},valueToVisible:function(){throw"Abstract valueToVisible method called"},checkChange:function(){if(!this.suspendCheckChange){var e=this,t=e.rawToValue(e.inputEl?e.inputEl.getValue():Ext.valueFrom(e.rawValue,"")),i=e.lastValue;e.isEqual(t,i)||e.isDestroyed||(e.lastValue=t,e.fireEvent("change",e,t,i),e.onChange(t,i))}},assertValue:function(){var e=this,t=e.rawValue,i=e.getRawValue(),n=e.getValue(),r=e.rawToValue(i),a=e.focusTask;a&&a.cancel(),t==i&&r-n==0||e.validateOnBlur&&!e.isValid()||e.setValue(r,!0)},applyChanges:function(e){e=e||this.task;var t=e.getTaskStore(!0)||this.taskStore;this.value?this.setTaskValue(e,this.value,this.keepDuration,t.skipWeekendsDuringDragDrop):this.setTaskValue(e,null)},expand:function(){this._expanding=!0,this.callParent(arguments)},beforeBlur:function(){this.assertValue()}}),Ext.define("Gnt.field.EndDate",{extend:Gnt.field.Date,alias:"widget.enddatefield",taskField:"endDateField",getTaskValueMethod:"getEndDate",setTaskValueMethod:"setEndDate",validateStartDate:!0,valueToVisible:function(e,t){return t=t||this.task,t.getDisplayEndDate(this.format,this.adjustMilestones,e,!0)},visibleToValue:function(e){return e&&this.task?Ext.Date.formatContainsHourInfo(this.format)||e-Ext.Date.clearTime(e,!0)!=0||(e=this.task.getCalendar().getCalendarDay(e).getAvailabilityEndFor(e)||Sch.util.Date.add(e,Sch.util.Date.DAY,1)):e=null,e},getErrors:function(e){var t=this.callParent(arguments);return t&&t.length?t:this.validateStartDate&&(e=this.rawToValue(e),this.task&&e&&e<this.task.getStartDate())?[this.L("endBeforeStartText")]:[]}}),Ext.define("Gnt.patches.TreeColumn",{extend:Sch.util.Patch,target:"Ext.tree.Column",minVersion:"5.1.1",overrides:{initComponent:function(){var e=this;e._rendererScope=e.scope||e,e.callParent(arguments),e.rendererScope=e._rendererScope}}}),Ext.define("Gnt.column.mixin.TaskFieldColumn",{extend:Ext.Mixin,mixins:[Gnt.mixin.Localizable],instantUpdate:!1,field:null,fieldProperty:"",fieldConfigs:"instantUpdate,fieldProperty",defaultEditor:"textfield",mixinConfig:{after:{initComponent:"afterInitComponent"},afterIf:{applyColumnCls:"applyColumnCls"}},initTaskFieldColumn:function(e){this.text=this.config.text||this.L("text"),this.initColumnEditor(e),this.scope=this.scope||this,this.renderer=this.renderer||this.taskFieldRenderer,this.mon(this,"render",this.onColumnRender,this)},applyColumnCls:function(e,t,i){i.isEditable(this.dataIndex)||(t.tdCls=(t.tdCls||"")+" sch-column-readonly")},afterInitComponent:function(){this.hasCustomRenderer=!0},initColumnEditor:function(e){var t=this.editor;if(t){if("string"==typeof t&&(t={xtype:t}),!t.isInstance){t.xtype||t.xclass||(t.xtype=this.defaultEditor);var i=Ext.copyTo(Ext.apply({},e),this,this.fieldConfigs,!0);this.editor=Ext.ComponentManager.create(Ext.apply(i,t))}this.field=this.editor}},onColumnRender:function(){var e=this.up("treepanel"),t=e.store;if(this.dataIndex||(this.dataIndex=t.model.prototype[this.fieldProperty]),this.onReadOnlySet){var i=this.up("ganttpanel");i.mon(i,"setreadonly",this.onReadOnlySet,this)}},getValueToRender:function(e,t,i){var n=this.field;return n&&n.valueToVisible&&n.valueToVisible(e,i)||e},taskFieldRenderer:function(e,t,i){var n=Ext.util.Format.htmlEncode(this.getValueToRender.apply(this,arguments));return this.applyColumnCls(e,t,i),n},afterClassMixedIn:function(e){var t=this.prototype,i=t.mixinConfig,n=i&&i.beforeIf,r=i&&i.afterIf;n&&Ext.Object.each(n,function(i,n){i in e.prototype?e.addMember(i,function(){if(!1!==t[n].apply(this,arguments))return this.callParent(arguments)}):e.addMember(i,function(){t[n].apply(this,arguments)})}),r&&Ext.Object.each(r,function(i,n){i in e.prototype?e.addMember(i,function(){this.callParent(arguments),t[n].apply(this,arguments)}):e.addMember(i,function(){t[n].apply(this,arguments)})})}}),Ext.define("Gnt.column.EndDate",{extend:Ext.grid.column.Date,alias:["widget.enddatecolumn","widget.ganttcolumn.enddate"],mixins:[Gnt.column.mixin.TaskFieldColumn],width:100,align:"left",editorFormat:null,adjustMilestones:!0,validateStartDate:!0,keepDuration:!1,fieldProperty:"endDateField",fieldConfigs:["instantUpdate","adjustMilestones","keepDuration","validateStartDate","fieldProperty"],editor:"enddatefield",initComponent:function(){this.initTaskFieldColumn({format:this.editorFormat||this.format||Ext.Date.defaultFormat}),this.callParent(arguments)},getValueToRender:function(e,t,i){return e&&Ext.Date.format(this.field.valueToVisible(e,i),this.format)||""}}),Ext.define("Gnt.field.BaselineEndDate",{extend:Gnt.field.EndDate,alias:"widget.baselineenddatefield",taskField:"baselineEndDateField",getTaskValueMethod:"getBaselineEndDate",setTaskValueMethod:"setBaselineEndDate",applyChanges:function(e,t){e=e||this.task,this.setTaskValue(e,this.value||null),t||e.fireEvent("taskupdated",e,this)}}),Ext.define("Gnt.column.BaselineEndDate",{extend:Gnt.column.EndDate,alias:["widget.baselineenddatecolumn","widget.ganttcolumn.baselineenddate"],width:100,fieldProperty:"baselineEndDateField",fieldConfigs:["instantUpdate","adjustMilestones","keepDuration","validateStartDate","fieldProperty"],editor:"baselineenddatefield"}),Ext.define("Gnt.field.StartDate",{extend:Gnt.field.Date,alias:"widget.startdatefield",keepDuration:!0,taskField:"startDateField",getTaskValueMethod:"getStartDate",setTaskValueMethod:"setStartDate",isBaseline:!1,valueToVisible:function(e,t){return t=t||this.task,t.getDisplayStartDate(this.format,this.adjustMilestones,e,!0,this.isBaseline)},visibleToValue:function(e){var t=this.task;if(t&&e){var i=!this.lastValue||this.lastValue-Ext.Date.clearTime(this.lastValue,!0)==0;this.adjustMilestones&&t.isMilestone(this.isBaseline)&&e-Ext.Date.clearTime(e,!0)==0&&i&&(e=t.getCalendar().getCalendarDay(e).getAvailabilityEndFor(e)||e)}return e}}),Ext.define("Gnt.column.StartDate",{extend:Ext.grid.column.Date,alias:["widget.startdatecolumn","widget.ganttcolumn.startdate"],mixins:[Gnt.column.mixin.TaskFieldColumn],width:100,align:"left",editorFormat:null,adjustMilestones:!0,keepDuration:!0,fieldProperty:"startDateField",fieldConfigs:["instantUpdate","adjustMilestones","keepDuration","fieldProperty"],editor:"startdatefield",initComponent:function(){this.initTaskFieldColumn({format:this.editorFormat||this.format||Ext.Date.defaultFormat}),this.callParent(arguments)},getValueToRender:function(e,t,i){return e&&Ext.Date.format(this.field.valueToVisible(e,i),this.format)||""}}),Ext.define("Gnt.field.BaselineStartDate",{extend:Gnt.field.StartDate,alias:"widget.baselinestartdatefield",taskField:"baselineStartDateField",getTaskValueMethod:"getBaselineStartDate",setTaskValueMethod:"setBaselineStartDate",isBaseline:!0,applyChanges:function(e,t){e=e||this.task,this.setTaskValue(e,this.value),t||e.fireEvent("taskupdated",e,this)}}),Ext.define("Gnt.column.BaselineStartDate",{extend:Gnt.column.StartDate,alias:["widget.baselinestartdatecolumn","widget.ganttcolumn.baselinestartdate"],width:100,fieldProperty:"baselineStartDateField",fieldConfigs:["instantUpdate","adjustMilestones","fieldProperty"],editor:"baselinestartdatefield"}),Ext.define("Gnt.model.Calendar",{extend:Sch.model.Customizable,idProperty:"Id",calendar:null,nameField:"Name",daysPerMonthField:"DaysPerMonth",daysPerWeekField:"DaysPerWeek",hoursPerDayField:"HoursPerDay",weekendsAreWorkdaysField:"WeekendsAreWorkdays",weekendFirstDayField:"WeekendFirstDay",weekendSecondDayField:"WeekendSecondDay",defaultAvailabilityField:"DefaultAvailability",daysField:"Days",calendarClassField:"CalendarClass",phantomIdField:"PhantomId",phantomParentIdField:"PhantomParentId",customizableFields:[{name:"Name"},{name:"DaysPerMonth",type:"integer"},{name:"DaysPerWeek",type:"integer"},{name:"HoursPerDay",type:"integer"},{name:"WeekendsAreWorkdays",type:"boolean"},{name:"WeekendFirstDay",type:"integer"},{name:"WeekendSecondDay",type:"integer"},{name:"DefaultAvailability"},{name:"Days"},{name:"CalendarClass",defaultValue:"Gnt.data.Calendar"},{name:"PhantomId"},{name:"PhantomParentId"}],constructor:function(e,t,i){var n=e||i||{},r=n.calendar||n.Days;e&&delete e.calendar,i&&delete i.calendar,this.callParent(arguments),this.setDays(r),this.data[this.phantomIdField]=this.getId()},get:function(e){return"Days"===e?this.getCalendar()||this.data[this.daysField]:this.callParent(arguments)},set:function(e,t){if("Days"!==e)return this.callParent(arguments);t instanceof Gnt.data.Calendar?this.setCalendar(t):this.data[this.daysField]=t},getCalendar:function(){return this.calendar},setCalendar:function(e){this.calendar=e},getCalendarConfig:function(){return{calendarId:this.getId(),daysPerMonth:this.getDaysPerMonth(),daysPerWeek:this.getDaysPerWeek(),defaultAvailability:this.getDefaultAvailability(),hoursPerDay:this.getHoursPerDay(),name:this.getName(),parent:this.parentNode&&this.parentNode.getCalendar(),weekendFirstDay:this.getWeekendFirstDay(),weekendSecondDay:this.getWeekendSecondDay(),weekendsAreWorkdays:this.getWeekendsAreWorkdays()}},getModelConfig:function(e,t){var i={};return t||(i.parentId=e.parent&&e.parent.calendarId,i.calendar=e),i[this.daysPerMonthField]=e.daysPerMonth,i[this.daysPerWeekField]=e.daysPerWeek,i[this.defaultAvailabilityField]=e.defaultAvailability,i[this.hoursPerDayField]=e.hoursPerDay,i[this.nameField]=e.name,i[this.weekendFirstDayField]=e.weekendFirstDay,i[this.weekendSecondDayField]=e.weekendSecondDay,i[this.weekendsAreWorkdaysField]=e.weekendsAreWorkdays,i[this.calendarClassField]=Ext.getClassName(e),i},setCalendarManager:function(e){this.calendarManager=e},getCalendarManager:function(){return this.calendarManager},getParentCalendarClass:function(){for(var e,t=this.parentNode;t&&!e;)e=t.getCalendarClass(),t=t.parentNode;return e},fillNodeFromPrototype:function(e){var t=e[this.calendarClassField]||this.treeStore&&this.treeStore.getCalendarClass()||this.getCalendarClass()||this.getParentCalendarClass()||this.getField(this.calendarClassField).getDefaultValue();if(t){Ext.applyIf(e,this.getModelConfig(Ext.ClassManager.get(t).prototype,!0));var i=e.children;if(i&&i.length)for(var n=0;n<i.length;n++)this.fillNodeFromPrototype(i[n])}},prepareCalendarNode:function(e){return e instanceof Gnt.data.Calendar?e=this.getModelConfig(e):Ext.isObject(e)&&this.fillNodeFromPrototype(e),e=this.createNode(e),this.phantom&&this.getId()!==e.data[this.phantomParentIdField]&&(e.modified=e.modified||{},e.modified[this.phantomParentIdField]=e.data[this.phantomParentIdField],e.data[this.phantomParentIdField]=this.getId()),e}},function(){Ext.data.NodeInterface.decorate(this),this.override({insertBefore:function(e){return e=this.prepareCalendarNode(e),this.callParent(arguments)},appendChild:function(e){if(e instanceof Array)for(var t=0;t<e.length;t++)e[t]=this.prepareCalendarNode(e[t]);else e=this.prepareCalendarNode(e);return this.callParent(arguments)}})}),Ext.define("Gnt.model.CalendarDay",{extend:Sch.model.Customizable,idProperty:"Id",customizableFields:[{name:"Date",type:"date",dateFormat:"c",persist:!0,convert:function(e,t){if(e){var i=Ext.data.Types.DATE.convert.call(this,e);return i&&Ext.Date.clearTime(i),i}}},{name:"Weekday",type:"int"},{name:"OverrideStartDate",type:"date",dateFormat:"c"},{name:"OverrideEndDate",type:"date",dateFormat:"c"},{name:"Type",defaultValue:"DAY"},{name:"IsWorkingDay",type:"boolean",defaultValue:!1},{name:"Cls",defaultValue:"gnt-holiday"},"Name",{name:"Availability",persist:!0,convert:function(e,t){return e?"string"===Ext.typeOf(e)?[e]:e:[]}}],availabilityCache:null,weekDayField:"Weekday",overrideStartDateField:"OverrideStartDate",overrideEndDateField:"OverrideEndDate",typeField:"Type",dateField:"Date",isWorkingDayField:"IsWorkingDay",clsField:"Cls",nameField:"Name",availabilityField:"Availability",setDate:function(e){e&&(e=Ext.Date.clearTime(e,!0)),this.set(this.dateField,e)},clearDate:function(){this.set(this.dateField,null)},getAvailability:function(e){var t=this;if(e)return this.get(this.availabilityField);if(this.availabilityCache)return this.availabilityCache;var i=[];return Ext.Array.each(this.get(this.availabilityField),function(e){i.push("string"===Ext.typeOf(e)?t.parseInterval(e):e)}),this.verifyAvailability(i),this.availabilityCache=i},setAvailability:function(e){this.availabilityCache=null,this.set(this.availabilityField,this.stringifyIntervals(e)),this.getAvailability()},verifyAvailability:function(e){e.sort(function(e,t){return e.startTime-t.startTime}),Ext.Array.each(e,function(e){if(e.startTime>e.endTime)throw new Error("Start time "+Ext.Date.format(e.startTime,"H:i")+" is greater than end time "+Ext.Date.format(e.endTime,"H:i"))});for(var t=1;t<e.length;t++){var i=e[t-1],n=e[t];if(i.endTime>n.startTime)throw new Error("Availability intervals should not intersect: ["+this.stringifyInterval(i)+"] and ["+this.stringifyInterval(n)+"]")}},prependZero:function(e){return e<10?"0"+e:e},stringifyInterval:function(e){var t=e.startTime,i=e.endTime
;return this.prependZero(t.getHours())+":"+this.prependZero(t.getMinutes())+"-"+(1==i.getDate()?24:this.prependZero(i.getHours()))+":"+this.prependZero(i.getMinutes())},stringifyIntervals:function(e){var t=this,i=[];return Ext.Array.each(e,function(e){"string"===Ext.typeOf(e)?i.push(e):i.push(t.stringifyInterval(e))}),i},parseInterval:function(e){var t=/(\d\d):(\d\d)-(\d\d):(\d\d)/.exec(e);if(!t)throw"Invalid format for availability string: "+e+". It should have exact format: hh:mm-hh:mm";return{startTime:new Date(0,0,0,t[1],t[2]),endTime:new Date(0,0,0,t[3],t[4])}},getTotalHours:function(){return this.getTotalMS()/1e3/60/60},getTotalMS:function(){var e=0;return Ext.Array.each(this.getAvailability(),function(t){e+=t.endTime-t.startTime}),e},addAvailabilityInterval:function(e,t){var i;i=e instanceof Date?{startTime:e,endTime:t}:this.parseInterval(e+(t?"-"+t:""));var n=this.getAvailability().concat(i);this.verifyAvailability(n),this.setAvailability(n)},removeAvailbilityInterval:function(e){var t=this.getAvailability();t.splice(e,1),this.setAvailability(t)},getAvailabilityIntervalsFor:function(e){e="number"==typeof e?new Date(e):e;var t=e.getFullYear(),i=e.getMonth(),n=e.getDate(),r=[];return Ext.Array.each(this.getAvailability(),function(e){var a=e.endTime.getDate();r.push({startDate:new Date(t,i,n,e.startTime.getHours(),e.startTime.getMinutes()),endDate:new Date(t,i,n+(1==a?1:0),e.endTime.getHours(),e.endTime.getMinutes())})}),r},getAvailabilityStartFor:function(e){var t=this.getAvailabilityIntervalsFor(e);return t.length?t[0].startDate:null},getAvailabilityEndFor:function(e){var t=this.getAvailabilityIntervalsFor(e);return t.length?t[t.length-1].endDate:null}}),Ext.define("Gnt.data.Calendar",{extend:Ext.data.Store,mixins:[Sch.data.mixin.UniversalModelGetter],model:"Gnt.model.CalendarDay",proxy:"memory",daysPerMonth:30,daysPerWeek:7,hoursPerDay:24,unitsInMs:null,defaultNonWorkingTimeCssCls:"gnt-holiday",weekendsAreWorkdays:!1,weekendFirstDay:6,weekendSecondDay:0,holidaysCache:null,availabilityIntervalsCache:null,daysIndex:null,weekAvailability:null,defaultWeekAvailability:null,nonStandardWeeksByStartDate:null,nonStandardWeeksStartDates:null,calendarId:null,parent:null,defaultAvailability:["00:00-24:00"],name:null,suspendCacheUpdate:0,availabilitySearchLimit:1825,statics:{getCalendar:function(e){return e instanceof Gnt.data.Calendar?e:Ext.data.StoreManager.lookup("GNT_CALENDAR:"+e)},getAllCalendars:function(){var e=[];return Ext.data.StoreManager.each(function(t){t instanceof Gnt.data.Calendar&&e.push(t)}),e},removeAll:function(){var e=Ext.data.StoreManager;e.each(function(t){t instanceof Gnt.data.Calendar&&(e.unregister(t),Ext.destroy(t))})}},constructor:function(e){e=e||{};var t=e.parent;delete e.parent;var i=e.calendarId;delete e.calendarId,this.callParent(arguments),this.setParent(t),this.setCalendarId(i),this.unitsInMs={MILLI:1,SECOND:1e3,MINUTE:6e4,HOUR:36e5,DAY:60*this.hoursPerDay*60*1e3,WEEK:this.daysPerWeek*this.hoursPerDay*60*60*1e3,MONTH:this.daysPerMonth*this.hoursPerDay*60*60*1e3,QUARTER:3*this.daysPerMonth*24*60*60*1e3,YEAR:12*this.daysPerMonth*24*60*60*1e3},this.defaultWeekAvailability=this.getDefaultWeekAvailability(),this.on({update:this.clearCache,datachanged:this.clearCache,clear:this.clearCache,load:this.clearCache,scope:this}),this.clearCache()},getCalendarId:function(){return this.calendarId},setCalendarId:function(e){null!=this.calendarId&&Ext.data.StoreManager.unregister(this),this.calendarId=e,null!=e?(this.storeId="GNT_CALENDAR:"+e,Ext.data.StoreManager.register(this)):this.storeId=null;var t=this.proxy;t&&t.extraParams&&(t.extraParams.calendarId=e)},getDefaultWeekAvailability:function(){for(var e=this.defaultAvailability,t=this.weekendFirstDay,i=this.weekendSecondDay,n=[],r=0;r<7;r++)n.push(this.weekendsAreWorkdays||r!=t&&r!=i?new this.model({Type:"WEEKDAY",Weekday:r,Availability:e&&Ext.Array.clone(e)||[],IsWorkingDay:!0}):new this.model({Type:"WEEKDAY",Weekday:r,Availability:[]}));return n},clearCache:function(){if(!(this.suspendCacheUpdate>0)){this.holidaysCache={},this.availabilityIntervalsCache={};var e=this.daysIndex={},t=this.weekAvailability=[],i=this.nonStandardWeeksStartDates=[],n=this.nonStandardWeeksByStartDate={};this.each(function(r){var a=r.getId(),s=/^(\d)-(\d\d\d\d\/\d\d\/\d\d)-(\d\d\d\d\/\d\d\/\d\d)$/.exec(a),o=/^WEEKDAY:(\d+)$/.exec(a),l=r.getType(),d=r.getWeekday();if("WEEKDAYOVERRIDE"==l||s){var c,h;if("WEEKDAYOVERRIDE"==l&&(c=r.getOverrideStartDate(),h=r.getOverrideEndDate()),s&&(c=Ext.Date.parse(s[2],"Y/m/d"),h=Ext.Date.parse(s[3],"Y/m/d"),d=s[1]),c&&h&&null!=d){var u=c-0;n[u]||(n[u]={startDate:new Date(c),endDate:new Date(h),name:r.getName(),weekAvailability:[],mainDay:null},i.push(u)),d>=0?n[u].weekAvailability[d]=r:n[u].mainDay=r}}else if("WEEKDAY"==l||o){if(o&&(d=o[1]),null!=d){if(d<0||d>6)throw new Error("Incorrect week day index");t[d]=r}}else{var g=r.getDate();g&&(e[g-0]=r)}}),i.sort(function(e,t){return e-t}),this.fireEvent("calendarchange",this)}},intersectsWithCurrentWeeks:function(e,t){var i=!1;return this.forEachNonStandardWeek(function(n){var r=n.startDate,a=n.endDate;if(r<=e&&e<a||r<t&&t<=a)return i=!0,!1}),i},addNonStandardWeek:function(e,t,i,n){if(e=Ext.Date.clearTime(new Date(e)),t=Ext.Date.clearTime(new Date(t)),this.intersectsWithCurrentWeeks(e,t))throw new Error("Can not add intersecting week");var r=this.model,a=[];Ext.Array.each(i,function(i,s){if(i instanceof Gnt.model.CalendarDay)i.setType("WEEKDAYOVERRIDE"),i.setOverrideStartDate(e),i.setOverrideEndDate(t),i.setWeekday(s),i.setName(n||"Week override"),a.push(i);else if(Ext.isArray(i)){var o=new r;o.setType("WEEKDAYOVERRIDE"),o.setOverrideStartDate(e),o.setOverrideEndDate(t),o.setWeekday(s),o.setName(n||"Week override"),o.setAvailability(i),a.push(o)}});var s=new r;s.setType("WEEKDAYOVERRIDE"),s.setOverrideStartDate(e),s.setOverrideEndDate(t),s.setWeekday(-1),s.setName(n||"Week override"),a.push(s),this.add(a)},getNonStandardWeekByStartDate:function(e){return this.nonStandardWeeksByStartDate[Ext.Date.clearTime(new Date(e))-0]||null},getNonStandardWeekByDate:function(e){e=Ext.Date.clearTime(new Date(e))-0;for(var t=this.nonStandardWeeksStartDates,i=this.nonStandardWeeksByStartDate,n=0;n<t.length;n++){var r=i[t[n]];if(r.startDate>e)break;if(r.startDate<=e&&e<=r.endDate)return r}return null},removeNonStandardWeek:function(e){e=Ext.Date.clearTime(new Date(e))-0;var t=this.getNonStandardWeekByStartDate(e);t&&this.remove(Ext.Array.clean(t.weekAvailability).concat(t.mainDay))},forEachNonStandardWeek:function(e,t){for(var i=this,n=this.nonStandardWeeksStartDates,r=this.nonStandardWeeksByStartDate,a=0;a<n.length;a++)if(!1===e.call(t||i,r[n[a]]))return!1},setWeekendsAreWorkDays:function(e){e!==this.weekendsAreWorkdays&&(this.weekendsAreWorkdays=e,this.defaultWeekAvailability=this.getDefaultWeekAvailability(),this.clearCache())},areWeekendsWorkDays:function(){return this.weekendsAreWorkdays},getCalendarDay:function(e){return e="number"==typeof e?new Date(e):e,this.getOverrideDay(e)||this.getWeekDay(e.getDay(),e)||this.getDefaultCalendarDay(e.getDay())},getOverrideDay:function(e){return this.getOwnCalendarDay(e)||this.parent&&this.parent.getOverrideDay(e)||null},getOwnCalendarDay:function(e){return e="number"==typeof e?new Date(e):e,this.daysIndex[Ext.Date.clearTime(e,!0)-0]},getWeekDay:function(e,t){if(t){var i=this.getNonStandardWeekByDate(t);if(i&&i.weekAvailability[e])return i.weekAvailability[e]}return this.weekAvailability[e]||this.parent&&this.parent.getWeekDay(e,t)||null},getDefaultCalendarDay:function(e){return this.hasOwnProperty("defaultAvailability")||this.hasOwnProperty("weekendsAreWorkdays")||!this.parent?this.defaultWeekAvailability[e]:this.parent.getDefaultCalendarDay(e)},isHoliday:function(e){var t=e-0,i=this.holidaysCache;if(null!=i[t])return i[t];e="number"==typeof e?new Date(e):e;var n=this.getCalendarDay(e);if(!n)throw"Can't find day for "+e;return i[t]=!n.getIsWorkingDay()},isWeekend:function(e){var t=e.getDay();return t===this.weekendFirstDay||t===this.weekendSecondDay},isWorkingDay:function(e){return!this.isHoliday(e)},convertMSDurationToUnit:function(e,t){return e/this.unitsInMs[Sch.util.Date.getNameOfUnit(t)]},convertDurationToMs:function(e,t){return e*this.unitsInMs[Sch.util.Date.getNameOfUnit(t)]},getHolidaysRanges:function(e,t,i){e>t&&Ext.Error.raise("startDate can't be bigger than endDate"),e=Ext.Date.clearTime(e,!0),t=Ext.Date.clearTime(t,!0);var n,r,a=[];for(r=e;r<t;r=Sch.util.Date.getNext(r,Sch.util.Date.DAY,1))if(this.isHoliday(r)||this.weekendsAreWorkdays&&i&&this.isWeekend(r)){var s=this.getCalendarDay(r),o=s&&s.getCls()||this.defaultNonWorkingTimeCssCls,l=Sch.util.Date.getNext(r,Sch.util.Date.DAY,1);n?n.getCls()==o?n.setEndDate(l):(a.push(n),n=new Sch.model.Range({StartDate:r,EndDate:l,Cls:o})):n=new Sch.model.Range({StartDate:r,EndDate:l,Cls:o})}else n&&(a.push(n),n=null);return n&&a.push(n),a},forEachAvailabilityInterval:function(e,t,i){i=i||this;var n=e.startDate,r=e.endDate,a=!1!==e.isForward;if(a?!n:!r)throw new Error("At least `startDate` or `endDate` is required, depending from the `isForward` option");var s=new Date(a?n:r),o=Sch.util.Date;a?r||(r=o.add(n,"d",e.availabilitySearchLimit||this.availabilitySearchLimit||1825)):n||(n=o.add(r,"d",-(e.availabilitySearchLimit||this.availabilitySearchLimit||1825)));for(var l=!1;a?s<r:s>n;){for(var d=this.getAvailabilityIntervalsFor(s-(a?0:1),!!a&&l),c=a?0:d.length-1;a?c<d.length:c>=0;a?c++:c--){var h=d[c],u=h.startDate,g=h.endDate;if(!(u>=r||g<=n)){var f=u<n?n:u,p=g>r?r:g;if(!1===t.call(i,f,p))return!1}}s=a?o.getStartOfNextDay(s,!1,l):o.getEndOfPreviousDay(s,l),l=!0}},calculateDuration:function(e,t,i){var n=0;return this.forEachAvailabilityInterval({startDate:e,endDate:t},function(e,t){var i=e.getTimezoneOffset()-t.getTimezoneOffset();n+=t-e+60*i*1e3}),this.convertMSDurationToUnit(n,i)},calculateEndDate:function(e,t,i){if(!t)return new Date(e);var n,r=Sch.util.Date;t=this.convertDurationToMs(t,i);var a=0===t&&Ext.Date.clearTime(e,!0)-e==0?r.add(e,Sch.util.Date.DAY,-1):e;return this.forEachAvailabilityInterval({startDate:a},function(e,i){var r=i-e,a=e.getTimezoneOffset()-i.getTimezoneOffset();if(r>=t)return n=new Date(e-0+t),!1;t-=r+60*a*1e3}),n},calculateStartDate:function(e,t,i){if(!t)return new Date(e);var n;return t=this.convertDurationToMs(t,i),this.forEachAvailabilityInterval({endDate:e,isForward:!1},function(e,i){var r=i-e;if(r>=t)return n=new Date(i-t),!1;t-=r}),n},skipNonWorkingTime:function(e,t){var i=!1;if(this.forEachAvailabilityInterval(t?{startDate:e}:{endDate:e,isForward:!1},function(n,r){return e=t?n:r,i=!0,!1}),!i)throw"skipNonWorkingTime: Cannot skip non-working time, please ensure that this calendar has any working period of time specified";return new Date(e)},skipWorkingTime:function(e,t,i){return t>=0?this.calculateEndDate(e,t,i):this.calculateStartDate(e,-t,i)},getAvailabilityIntervalsFor:function(e,t){return e=t?e.valueOf():e instanceof Date?new Date(e.getFullYear(),e.getMonth(),e.getDate()).valueOf():Ext.Date.clearTime(new Date(e)).valueOf(),this.availabilityIntervalsCache[e]=this.availabilityIntervalsCache[e]||this.getCalendarDay(e).getAvailabilityIntervalsFor(e)},getByInternalId:function(e){return this.data.map[e]},isChildOf:function(e){for(var t=e===this&&this,i=!1;t&&!i;)i=t===e,t=t.parent;return i},getParentableCalendars:function(){var e=this,t=[],i=Gnt.data.Calendar.getAllCalendars();return Ext.Array.each(i,function(i){i===e||i.isChildOf(e)||t.push({Id:i.calendarId,Name:i.name||i.calendarId})}),t},setParent:function(e){var t=Gnt.data.Calendar.getCalendar(e);if(e&&!t)throw new Error("Invalid parent specified for the calendar");if(this.parent!=t){var i=this.proxy,n={calendarchange:this.clearCache,destroy:this.onParentDestroy,scope:this},r=this.parent;r&&r.un(n),this.parent=t,t&&t.on(n),i&&i.extraParams&&(i.extraParams.parentId=t?t.calendarId:null),this.clearCache(),this.fireEvent("parentchange",this,t,r)}},onParentDestroy:function(){this.setParent(null)},isAvailabilityIntersected:function(e,t,i){for(var n,r,a,s,o=0;o<7;o++)if(n=this.getWeekDay(o)||this.getDefaultCalendarDay(o),a=e.getWeekDay(o)||e.getDefaultCalendarDay(o),n&&a){r=n.getAvailability(),s=a.getAvailability();for(var l=0,d=r.length;l<d;l++)for(var c=0,h=s.length;c<h;c++)if(s[c].startTime<r[l].endTime&&s[c].endTime>r[l].startTime)return!0}var u=!1;return this.forEachNonStandardWeek(function(e){return!(e.startDate>=i)&&(t<e.endDate?(u=!0,!1):void 0)}),u}}),Ext.define("Gnt.field.Calendar",{extend:Ext.form.field.ComboBox,mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],alias:"widget.calendarfield",alternateClassName:"Gnt.widget.CalendarField",taskField:"calendarIdField",getTaskValueMethod:"getCalendarId",setTaskValueMethod:"setCalendarId",pickerAlign:"tl-bl?",matchFieldWidth:!0,editable:!0,triggerAction:"all",valueField:"Id",displayField:"Name",queryMode:"local",forceSelection:!0,allowBlank:!0,initComponent:function(){var e=this;e.getInitialConfig().store&&!e.store.isEmptyStore||(e.store={xclass:"Ext.data.Store",model:"Gnt.model.Calendar"}),e.store instanceof Ext.data.Store||(e.store=Ext.create(e.store)),e.callParent(arguments),e.updateCalendarsStore(),e.mon(Ext.data.StoreManager,{add:function(e,t,i){t instanceof Gnt.data.Calendar&&this.updateCalendarsStore()},remove:function(e,t,i){t instanceof Gnt.data.Calendar&&this.updateCalendarsStore()},scope:e}),e.on({show:e.setReadOnlyIfEmpty,scope:e}),e.on("change",e.onFieldChange,e)},updateCalendarsStore:function(){this.store.loadData(this.getCalendarData())},setReadOnlyIfEmpty:function(){this.store.count()||this.setReadOnly(!0)},getCalendarData:function(){return Ext.Array.map(Gnt.data.Calendar.getAllCalendars(),function(e){return{Id:e.calendarId,Name:e.name||e.calendarId}})},onSetTask:function(){this.setReadOnlyIfEmpty(),this.setValue(this.getTaskValue())},valueToVisible:function(e,t){var i=this,n=[],r=this.findRecordByValue(e);return r?n.push(r.data):Ext.isDefined(i.valueNotFoundText)&&"string"==typeof i.valueNotFoundText&&n.push(i.valueNotFoundText),i.displayTpl.apply(n)},getValue:function(){return this.value||""},getErrors:function(e){if(e){var t=this.findRecordByDisplay(e);if(t&&this.task&&!this.task.isCalendarApplicable(t.getId()))return[this.L("calendarNotApplicable")]}return this.callParent(arguments)},onFieldChange:function(e,t){this.setValue(t)},setValue:function(e){this.callParent([e]),void 0!==e&&null!==e&&""!==e||(this.value=""),this.instantUpdate&&!this.getSuppressTaskUpdate()&&this.task&&this.getTaskValue()!=this.value&&this.applyChanges()},assertValue:function(){!this.getRawValue()&&this.value?this.setValue(""):this.callParent(arguments)}}),Ext.define("Gnt.column.Calendar",{extend:Ext.grid.column.Column,alias:["widget.calendarcolumn","widget.ganttcolumn.calendar"],mixins:[Gnt.column.mixin.TaskFieldColumn],width:100,align:"left",instantUpdate:!0,store:null,fieldProperty:"calendarIdField",fieldConfigs:["instantUpdate","store","fieldProperty"],editor:"calendarfield",initComponent:function(){this.initTaskFieldColumn({format:this.editorFormat||this.format||Ext.Date.defaultFormat}),this.callParent(arguments)},applyColumnCls:function(e,t,i,n,r,a){e||(t.tdCls=(t.tdCls||"")+" gnt-default")},getValueToRender:function(e,t,i,n,r,a){return e=e||(a.calendar?a.calendar.calendarId:""),this.field.valueToVisible(e,i)||e}}),Ext.define("Gnt.field.ConstraintDate",{extend:Gnt.field.Date,alias:"widget.constraintdatefield",taskField:"constraintDateField",getTaskValueMethod:"getConstraintDate",setTaskValueMethod:"setConstraintDate",reAssertValue:!1,valueToVisible:function(e,t){t=t||this.task;var i=this,n=t&&t.getConstraintClass(),r=i.format||Ext.Date.defaultFormat;return n?n.getDisplayableConstraintDateForFormat(e,r,t):e},visibleToValue:function(e){var t=this,i=t.format||Ext.Date.defaultFormat,n=t.task,r=n&&n.getConstraintClass();return r&&!Ext.isEmpty(e)&&(e=r.adjustConstraintDateFromDisplayableWithFormat(e,i,n)),e}}),Ext.define("Gnt.column.ConstraintDate",{extend:Ext.grid.column.Date,alias:["widget.constraintdatecolumn","widget.ganttcolumn.constraintdate"],mixins:[Gnt.column.mixin.TaskFieldColumn],width:100,align:"left",fieldProperty:"constraintDateField",editor:"constraintdatefield",initComponent:function(){this.initTaskFieldColumn({format:this.editorFormat||this.format||Ext.Date.defaultFormat,taskField:this.fieldProperty}),this.callParent(arguments)},getValueToRender:function(e,t,i){return e&&Ext.Date.format(this.field.valueToVisible(e,i),this.format)||""}}),Ext.define("Gnt.field.ConstraintType",{extend:Ext.form.field.ComboBox,mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],alias:"widget.constrainttypefield",alternateClassName:"Gnt.widget.ConstraintType.Field",taskField:"constraintTypeField",getTaskValueMethod:"getConstraintType",setTaskValueMethod:"setConstraint",pickerAlign:"tl-bl?",matchFieldWidth:!1,editable:!1,forceSelection:!0,triggerAction:"all",initComponent:function(){var e=this;e.store=e.store||Gnt.field.ConstraintType.buildDefaultConstraintTypeList(e.L("none")),e.callParent(arguments),this.on("change",this.onFieldChange,this)},valueToVisible:function(e,t){var i=this,n=[],r=this.findRecordByValue(Ext.isEmpty(e)?null:e);return r?n.push(r.data):Ext.isDefined(i.valueNotFoundText)&&n.push(i.valueNotFoundText),i.displayTpl.apply(n)},applyChanges:function(e){var t,i=this,n=i.getValue();e=e||i.task,t=Gnt.constraint.Base.getConstraintClass(n),i.setTaskValue(e,n,t&&t.getInitialConstraintDate(e)||null),e.fireEvent("taskupdated",e,i)},onFieldChange:function(e){var t=this;!t.getSuppressTaskUpdate()&&t.task&&e&&t.applyChanges()},statics:{buildDefaultConstraintTypeList:function(e){var t=[];return Ext.Array.each(Ext.ClassManager.getNamesByExpression("gntconstraint.*"),function(e){var i=Ext.ClassManager.get(e),n=i.alias[0],r=n.split(".").pop();i&&t.push([r,i.L("name")])}),t=Ext.Array.sort(t,function(e,t){return e[1]>t[1]?1:-1}),e&&t.unshift([null,e]),t}}}),Ext.define("Gnt.column.ConstraintType",{extend:Ext.grid.column.Column,mixins:[Gnt.column.mixin.TaskFieldColumn],alias:["widget.constrainttypecolumn","widget.ganttcolumn.constrainttype"],width:100,align:"left",data:null,fieldProperty:"constraintTypeField",editor:"constrainttypefield",initComponent:function(){this.initTaskFieldColumn({store:this.data,taskField:this.fieldProperty}),this.callParent(arguments)}}),Ext.define("Gnt.util.DurationParser",{mixins:[Gnt.mixin.Localizable],parseNumberFn:null,durationRegex:null,allowDecimals:!0,constructor:function(e){Ext.apply(this,e),this.unitsRegex&&Ext.apply(this.l10n.unitsRegex,this.unitsRegex),this.durationRegex||(this.durationRegex=this.allowDecimals?/^\s*([\-+]?\d+(?:[.,]\d+)?)\s*(\w+)?/i:/^\s*([\-+]?\d+)(?![.,])\s*(\w+)?/i)},parse:function(e){var t=this.durationRegex.exec(e);if(null==e||!t)return null;var i,n=this.parseNumberFn(t[1]),r=t[2];return r&&(Ext.iterate(this.L("unitsRegex"),function(e,t){if(t.test(r))return i=Sch.util.Date.getUnitByName(e),!1}),!i)?null:{value:n,unit:i}}}),Ext.define("Gnt.util.DependencyParser",{mixins:[Gnt.mixin.Localizable],separator:/\s*;\s*/,parseNumberFn:null,dependencyRegex:null,types:null,constructor:function(e){Ext.apply(this,e),this.initTypes();for(var t=this.L("typeText"),i=0;i<this.types.length;i++)this.types[i]=t[this.types[i]]||this.types[i];var n="(-?\\d+)("+this.types.join("|")+")?([\\+\\-].*)?";this.dependencyRegex=this.dependencyRegex||new RegExp(n,"i"),this.durationParser=new Gnt.util.DurationParser({parseNumberFn:this.parseNumberFn})},initTypes:function(){this.types=this.types||["SS","SF","FS","FF"]},parse:function(e){if(!e)return[];for(var t=e.split(this.separator),i=[],n=this.dependencyRegex,r=0;r<t.length;r++){var a=t[r];if(a||r!=t.length-1){var s=n.exec(a),o={};if(!s)return null;o.taskId=parseInt(s[1],10),o.type=Ext.Array.indexOf(this.types,(s[2]||this.types[2]).toUpperCase());var l=s[3];if(l){var d=this.durationParser.parse(l);if(!d)return null;o.lag=d.value,o.lagUnit=d.unit||"d"}i.push(o)}}return i}}),Ext.define("Gnt.field.Dependency",{extend:Ext.form.field.Text,alternateClassName:"Gnt.widget.DependencyField",alias:"widget.dependencyfield",mixins:[Gnt.mixin.Localizable],type:"predecessors",separator:";",task:null,dependencyParser:null,dependencyParserConfig:null,useSequenceNumber:!1,constructor:function(e){var t=this;Ext.apply(this,e),this.dependencyParser=new Gnt.util.DependencyParser(Ext.apply({parseNumberFn:function(){return Gnt.widget.DurationField.prototype.parseValue.apply(t,arguments)}},this.dependencyParserConfig)),this.callParent(arguments),this.addCls("gnt-field-dependency")},isPredecessor:function(){return"predecessors"===this.type},setTask:function(e){this.task=e,this.setRawValue(this.getFieldDisplayValue(e))},getDependencies:function(){return this.dependencyParser.parse(this.getRawValue())},getTaskIdFromDependency:function(e){var t,i=this.task.getTaskStore(),n=e.taskId;return this.useSequenceNumber&&(t=i.getBySequenceNumber(n),n=t&&t.getId()),n},getErrors:function(e){if(!e)return[];var t=this.dependencyParser.parse(e);if(!t)return[this.L("invalidFormatText")];for(var i,n=this.getDependencies(),r=this.isPredecessor(),a=this.task,s=a.getTaskStore().dependencyStore,o=a[r?"predecessors":"successors"],l=this.dependencyParser.types,d=s.allowedDependencyTypes,c=s.model.Type,h=[],u=0;u<n.length;u++){var g=n[u];if(!(i=this.getTaskIdFromDependency(g)))return[this.L("invalidDependencyText")];if(s.allowedDependencyTypes&&!s.isValidDependencyType(g.type)){for(var f="",p=0,m=d.length;p<m;p++)f+=l[c[d[p]]]+",";return[Ext.String.format(this.L("invalidDependencyType"),l[g.type],f.substring(0,f.length-1))]}var v=new s.model;v.setSourceId(r?i:a.getId()),v.setTargetId(r?a.getId():i),v.setType(g.type),v.setLag(g.lag),v.setLagUnit(g.lagUnit),h.push(v)}for(u=0;u<h.length;u++)if(!s.isValidDependency(h[u],h,o))return[this.invalidDependencyText];return this.callParent([t.value])},getFieldDisplayValue:function(e){for(var t,i=this.isPredecessor(),n=(e.getTaskStore().getDependencyStore(),i?e.getIncomingDependencies(!0):e.getOutgoingDependencies(!0)),r=this.dependencyParser.types,a=Gnt.model.Dependency.Type.EndToStart,s=[],o=0;o<n.length;o++){var l=n[o];if((t=i?l.getSourceTask():l.getTargetTask())&&l.isValid(!1)){var d=l.getType(),c=l.getLag(),h=l.getLagUnit();s.push(Ext.String.format("{0}{1}{2}{3}{4}",this.useSequenceNumber?t.getSequenceNumber():t.getId(),c||d!==a?r[d]:"",c>0?"+":"",c||"",c&&"d"!==h?h:""))}}return s.join(this.separator)},isDirty:function(e){if(!(e=e||this.task))return!1;for(var t=this.isPredecessor(),i=e.getTaskStore().dependencyStore,n=t?e.getIncomingDependencies():e.getOutgoingDependencies(),r=e.getId(),a=0,s=n.length;a<s;a++)if(n[a].dirty||n[a].phantom)return!0;if(i){var o=t?"getTargetId":"getSourceId";for(n=i.getRemovedRecords(),a=0,s=n.length;a<s;a++)if(n[a][o]()==r)return!0}return!1},applyChanges:function(e){e=e||this.task;var t,i=e.getTaskStore().dependencyStore,n=this.getDependencies(),r=this.isPredecessor(),a=r?e.getIncomingDependencies(!0):e.getOutgoingDependencies(!0),s=[],o=Ext.Array.map(n,function(e){return this.getTaskIdFromDependency(e)},this);for(t=0;t<a.length;t++)Ext.Array.contains(o,a[t][r?"getSourceId":"getTargetId"]())||s.push(a[t]);s.length>0&&i.remove(s);var l=[];for(t=0;t<n.length;t++){var d=n[t],c=this.getTaskIdFromDependency(d),h=i.getByTaskIds(c,e.getId());h?(h.beginEdit(),h.setType(d.type),h.setLag(d.lag),h.setLagUnit(d.lagUnit),h.endEdit()):(h=new i.model,h.setSourceId(r?c:e.getId()),h.setTargetId(r?e.getId():c),h.setType(d.type),h.setLag(d.lag),h.setLagUnit(d.lagUnit),l.push(h))}l.length>0&&i.add(l),(l.length||s.length)&&e.triggerUIUpdate()}}),Ext.define("Gnt.column.Dependency",{extend:Ext.grid.column.Column,separator:";",type:"predecessors",field:null,useSequenceNumber:!1,constructor:function(e){e=e||{};var t=e.editor;delete e.editor,Ext.apply(this,e),e.editor=t||Ext.create("Gnt.field.Dependency",{type:this.type,separator:this.separator,useSequenceNumber:this.useSequenceNumber}),e.editor instanceof Gnt.widget.DependencyField||(e.editor=Ext.ComponentManager.create(e.editor,"dependencyfield")),e.field=e.editor,this.scope=this,this.callParent([e])},afterRender:function(){this.up("ganttpanel").registerLockedDependencyListeners(),this.callParent(arguments)},getContainingPanel:function(){return this.panel||(this.panel=this.up("tablepanel")),this.panel},setDirtyClass:function(e,t){var i=this.getContainingPanel().getView();i.markDirty&&this.field.isDirty(t)&&(e.tdCls=i.dirtyCls)},isEditable:function(e){var t=this.gantt||this.up("ganttpanel");return!e.isProject&&(!e.isProject&&(t&&t.allowParentTaskDependencies||e.isLeaf()))},renderer:function(e,t,i){return i.isEditable(this.dataIndex)&&this.isEditable(i)?this.setDirtyClass(t,i):t.tdCls=(t.tdCls||"")+" sch-column-readonly",this.field.getFieldDisplayValue(i)}}),Ext.define("Gnt.field.Duration",{extend:Ext.form.field.Number,mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],alias:"widget.durationfield",alternateClassName:"Gnt.widget.DurationField",disableKeyFilter:!0,allowExponential:!1,minValue:0,durationUnit:"h",useAbbreviation:!1,getDurationUnitMethod:"getDurationUnit",setTaskValueMethod:"setDuration",getTaskValueMethod:"getDuration",taskField:"durationField",durationParser:null,durationParserConfig:null,constructor:function(e){var t=this;Ext.apply(this,e),this.durationParser=new Gnt.util.DurationParser(Ext.apply({parseNumberFn:function(){return t.parseValue.apply(t,arguments)},allowDecimals:this.decimalPrecision>0},this.durationParserConfig)),this.callParent(arguments),this.invalidText=this.L("invalidText")},onSetTask:function(){this.durationUnit=this.task[this.getDurationUnitMethod]();var e=this.getTaskValueMethod?this.getTaskValue():this.task.get(this.task[this.taskField]);this.setValue(e),this.setSpinUpEnabled(null==e||e<this.maxValue,!0),this.setSpinDownEnabled(e>this.minValue,!0)},rawToValue:function(e){var t=this.parseDuration(e);return t?(this.durationUnit=t.unit,null!=t.value?t.value:null):null},valueToVisible:function(e,t){if(Ext.isNumber(e)){var i=parseInt(e,10),n=Ext.Number.toFixed(e,this.decimalPrecision);return String(i==n?i:n).replace(".",this.decimalSeparator)+" "+Sch.util.Date[this.useAbbreviation?"getShortNameOfUnit":"getReadableNameOfUnit"](t||this.durationUnit,1!==e)}return""},valueToRaw:function(e){return this.valueToVisible(e,this.durationUnit,this.decimalPrecision,this.useAbbreviation)},parseDuration:function(e){if(null==e)return null;var t=this.durationParser.parse(e);return t?(t.unit=t.unit||this.durationUnit,t):null},getDurationValue:function(){return this.parseDuration(this.getRawValue())},getErrors:function(e){var t;if(e){if(!(t=this.parseDuration(e)))return[this.L("invalidText")];e=t.value}return this.callParent(arguments)},checkChange:function(){if(!this.suspendCheckChange){var e=this,t=e.getDurationValue(),i=e.lastValue;(t&&!i||!t&&i||t&&i&&(t.value!=i.value||t.unit!=i.unit))&&!e.isDestroyed&&(e.lastValue=t,e.fireEvent("change",e,t,i),e.onChange(t,i))}},getValue:function(){return this.value},applyChanges:function(e){e=e||this.task,this.setTaskValue(e,this.getValue(),this.durationUnit),e.fireEvent("taskupdated",e,this)},setValue:function(e,t){var i=e;Ext.isObject(e)&&(this.durationUnit=e.unit,i=e.value),this.callParent([i]),(t||this.instantUpdate)&&!this.getSuppressTaskUpdate()&&this.task&&this.applyChanges()},assertValue:function(){var e=this,t=e.getValue(),i=e.durationUnit,n=e.getDurationValue();if(this.isValid()){(!n&&t||n&&(n.value!=t||n.unit!=i))&&e.setValue(n,!0)}},beforeBlur:function(){this.assertValue()},onSpinUp:function(){var e=this;if(!e.readOnly){var t=e.getValue()||0;e.setSpinValue(Ext.Number.constrain(t+e.step,e.minValue,e.maxValue))}},onSpinDown:function(){var e=this;if(!e.readOnly){var t=e.getValue()||0;e.setSpinValue(Ext.Number.constrain(t-e.step,e.minValue,e.maxValue))}}}),Ext.define("Gnt.column.Duration",{extend:Ext.grid.column.Column,alias:["widget.durationcolumn","widget.ganttcolumn.duration"],mixins:[Gnt.column.mixin.TaskFieldColumn],width:80,align:"left",decimalPrecision:2,useAbbreviation:!1,instantUpdate:!0,fieldProperty:"durationField",fieldConfigs:["instantUpdate","useAbbreviation","decimalPrecision","fieldProperty"],editor:"durationfield",initComponent:function(){this.initTaskFieldColumn(),this.callParent(arguments)},getValueToRender:function(e,t,i){return Ext.isNumber(e)?this.field.valueToVisible(e,i.getDurationUnit()):""}}),Ext.define("Gnt.column.EarlyEndDate",{extend:Ext.grid.column.Date,mixins:[Gnt.mixin.Localizable],alias:["widget.earlyenddatecolumn","widget.ganttcolumn.earlyenddate"],width:100,align:"left",adjustMilestones:!0,constructor:function(e){e=e||{},this.text=e.text||this.L("text"),this.callParent(arguments),this.renderer=e.renderer||this.rendererFunc,this.scope=e.scope||this,this.hasCustomRenderer=!0},afterRender:function(){this.up("ganttpanel").registerLockedDependencyListeners(),this.callParent(arguments)},rendererFunc:function(e,t,i){return t.tdCls=(t.tdCls||"")+" sch-column-readonly",i.getDisplayEndDate(this.format,this.adjustMilestones,i.getEarlyEndDate())}}),Ext.define("Gnt.column.EarlyStartDate",{extend:Ext.grid.column.Date,mixins:[Gnt.mixin.Localizable],alias:["widget.earlystartdatecolumn","widget.ganttcolumn.earlystartdate"],width:100,align:"left",adjustMilestones:!0,constructor:function(e){e=e||{},this.text=e.text||this.L("text"),this.callParent(arguments),this.renderer=e.renderer||this.rendererFunc,this.scope=e.scope||this,this.hasCustomRenderer=!0},afterRender:function(){this.up("ganttpanel").registerLockedDependencyListeners(),this.callParent(arguments)},rendererFunc:function(e,t,i){return t.tdCls=(t.tdCls||"")+" sch-column-readonly",i.getDisplayStartDate(this.format,this.adjustMilestones,i.getEarlyStartDate())}}),Ext.define("Gnt.field.Effort",{extend:Gnt.field.Duration,alias:"widget.effortfield",alternateClassName:"Gnt.widget.EffortField",mixins:[Gnt.mixin.Localizable],taskField:"effortField",getDurationUnitMethod:"getEffortUnit",setTaskValueMethod:"setEffort",getTaskValueMethod:"getEffort",applyChanges:function(e){e=e||this.task,this.setTaskValue(e,this.getValue()||null,this.durationUnit),e.fireEvent("taskupdated",e,this)}}),Ext.define("Gnt.column.Effort",{extend:Gnt.column.Duration,alias:["widget.effortcolumn","widget.ganttcolumn.effort"],fieldProperty:"effortField",editor:"effortfield",getValueToRender:function(e,t,i){return Ext.isNumber(e)?this.field.valueToVisible(e,i.getEffortUnit()):""}}),Ext.define("Gnt.column.LateEndDate",{extend:Ext.grid.column.Date,mixins:[Gnt.mixin.Localizable],alias:["widget.lateenddatecolumn","widget.ganttcolumn.lateenddate"],width:100,align:"left",adjustMilestones:!0,constructor:function(e){e=e||{},this.text=e.text||this.L("text"),this.callParent(arguments),this.renderer=e.renderer||this.rendererFunc,this.scope=e.scope||this,this.hasCustomRenderer=!0},afterRender:function(){this.up("ganttpanel").registerLockedDependencyListeners(),this.callParent(arguments)},rendererFunc:function(e,t,i){return t.tdCls=(t.tdCls||"")+" sch-column-readonly",i.getDisplayEndDate(this.format,this.adjustMilestones,i.getLateEndDate())}}),Ext.define("Gnt.column.LateStartDate",{extend:Ext.grid.column.Date,mixins:[Gnt.mixin.Localizable],alias:["widget.latestartdatecolumn","widget.ganttcolumn.latestartdate"],width:100,align:"left",adjustMilestones:!0,constructor:function(e){e=e||{},this.text=e.text||this.L("text"),this.callParent(arguments),this.renderer=e.renderer||this.rendererFunc,this.scope=e.scope||this,this.hasCustomRenderer=!0},afterRender:function(){this.up("ganttpanel").registerLockedDependencyListeners(),this.callParent(arguments)},rendererFunc:function(e,t,i){return t.tdCls=(t.tdCls||"")+" sch-column-readonly",i.getDisplayStartDate(this.format,this.adjustMilestones,i.getLateStartDate())}}),Ext.define("Gnt.field.ManuallyScheduled",{extend:Ext.form.field.Checkbox,mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],alias:"widget.manuallyscheduledfield",alternateClassName:["Gnt.widget.ManuallyScheduledField"],
taskField:"manuallyScheduledField",setTaskValueMethod:"setManuallyScheduled",getTaskValueMethod:"isManuallyScheduled",valueToVisible:function(e){return e?this.L("yes"):this.L("no")},getValue:function(){return this.value},setValue:function(e){this.callParent([e]),this.instantUpdate&&!this.getSuppressTaskUpdate()&&this.task&&this.applyChanges()}}),Ext.define("Gnt.column.ManuallyScheduled",{extend:Ext.grid.Column,alias:["widget.manuallyscheduledcolumn","widget.ganttcolumn.manuallyscheduledcolumn"],mixins:[Gnt.column.mixin.TaskFieldColumn],width:50,align:"center",instantUpdate:!1,editor:"manuallyscheduledfield",initComponent:function(){this.initTaskFieldColumn(),this.callParent(arguments)},getValueToRender:function(e,t,i){return this.field.valueToVisible(i.isManuallyScheduled())}}),Ext.define("Gnt.field.Milestone",{extend:Ext.form.field.ComboBox,mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],alias:"widget.milestonefield",instantUpdate:!1,allowBlank:!1,forceSelection:!0,displayField:"text",valueField:"value",queryMode:"local",constructor:function(e){Ext.apply(this,e),this.store=new Ext.data.JsonStore({fields:["value","text"],data:[{value:0,text:this.L("no")},{value:1,text:this.L("yes")}]}),this.callParent(arguments),this.on("change",this.onFieldChange,this)},onSetTask:function(){this.setValue(this.task.isMilestone()?1:0)},valueToVisible:function(e){return e?this.L("yes"):this.L("no")},onFieldChange:function(e){this.instantUpdate&&!this.getSuppressTaskUpdate()&&this.task&&this.task.isMilestone()!=Boolean(this.value)&&this.applyChanges()},getValue:function(){return this.value},applyChanges:function(e){e=e||this.task,this.getValue()?e.convertToMilestone():e.convertToRegular(),e.fireEvent("taskupdated",e,this)}}),Ext.define("Gnt.column.Milestone",{extend:Ext.grid.column.Column,alias:["widget.milestonecolumn","widget.ganttcolumn.milestone"],mixins:[Gnt.column.mixin.TaskFieldColumn],width:50,align:"center",editor:"milestonefield",initComponent:function(){this.initTaskFieldColumn(),this.callParent(arguments)},getValueToRender:function(e,t,i){return this.field.valueToVisible(i.isMilestone())}}),Ext.define("Gnt.column.Name",{extend:Ext.tree.Column,alias:["widget.namecolumn","widget.ganttcolumn.name"],mixins:[Gnt.column.mixin.TaskFieldColumn],draggable:!0,fieldProperty:"nameField",editor:"textfield",initComponent:function(){this.initTaskFieldColumn({allowBlank:!1}),this.callParent(arguments)},applyColumnCls:function(e,t,i){t.tdCls=t.tdCls||"",i.isProject&&(t.tdCls+=" sch-gantt-pms-name"),i.isLeaf()||(t.tdCls+=" sch-gantt-parent-cell")}}),Ext.define("Gnt.field.Note",{extend:Ext.form.field.Picker,alias:["widget.notefield","widget.noteeditor"],alternateClassName:"Gnt.widget.NoteField",mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],matchFieldWidth:!1,editable:!1,pickerConfig:null,previewFn:null,previewFnScope:null,taskField:"noteField",getTaskValueMethod:"getNote",setTaskValueMethod:"setNote",afterRender:function(){this.callParent(arguments),this.on("collapse",this.onPickerCollapse,this)},valueToVisible:function(e){return this.previewFn?this.previewFn.call(this.previewFnScope||this,e):Ext.util.Format.stripTags(e)},createPicker:function(){return new Ext.form.field.HtmlEditor(Ext.apply({frame:!0,shadow:!1,floating:!0,height:200,width:300,listeners:{change:this.onPickerChange,initialize:this.onPickerInit,scope:this}},this.pickerConfig||{}))},onPickerInit:function(e){e.win.focus=Ext.emptyFn},onPickerChange:function(e,t){this.setRawValue(this.valueToVisible(t))},getValue:function(){return this.getPicker().getValue()},setValue:function(e){this.callParent([this.valueToVisible(e)]),this.getPicker().setValue(e),this.instantUpdate&&!this.getSuppressTaskUpdate()&&this.task&&this.applyChanges()},onPickerCollapse:function(){this.setValue(this.getPicker().getValue())},onTriggerClick:function(){var e=this;e.readOnly||e.disabled||(e.isExpanded?e.collapse():e.expand())}}),Ext.define("Gnt.column.Note",{extend:Ext.grid.column.Column,mixins:[Gnt.column.mixin.TaskFieldColumn],alias:["widget.notecolumn","widget.ganttcolumn.note"],editor:"notefield",fieldProperty:"noteField",previewFn:null,previewFnScope:null,fieldConfigs:["instantUpdate","previewFn","previewFnScope","fieldProperty"],initComponent:function(){this.initTaskFieldColumn(),this.callParent(arguments)}}),Ext.define("Gnt.field.Percent",{extend:Ext.form.field.Number,alias:"widget.percentfield",mixins:[Gnt.mixin.Localizable],alternateClassName:"Gnt.widget.PercentField",disableKeyFilter:!1,minValue:0,maxValue:100,allowExponential:!1,baseChars:"0123456789%",constructor:function(){this.callParent(arguments),this.invalidText=this.L("invalidText")},valueToRaw:function(e){return Ext.isNumber(e)?parseFloat(Ext.Number.toFixed(e,this.decimalPrecision))+"%":""},getErrors:function(e){var t=this.parseValue(e);if(null===t){if(null!==e&&""!==e)return[this.invalidText];t=""}return this.callParent([t])}}),Ext.define("Gnt.column.PercentDone",{extend:Ext.grid.column.Number,alias:["widget.percentdonecolumn","widget.ganttcolumn.percentdone"],mixins:[Gnt.column.mixin.TaskFieldColumn],width:50,format:"0",align:"center",editor:{xtype:"percentfield",decimalPrecision:0,minValue:0,maxValue:100},fieldProperty:"percentDoneField",initComponent:function(){this.initTaskFieldColumn(),this.callParent(arguments)},getValueToRender:function(e,t,i){return this.defaultRenderer(e,t,i)}}),Ext.define("Gnt.column.Predecessor",{extend:Gnt.column.Dependency,mixins:[Gnt.mixin.Localizable],alias:["widget.predecessorcolumn","widget.ganttcolumn.predecessor"],type:"predecessors",constructor:function(e){e=e||{},this.text=e.text||this.L("text"),this.callParent(arguments)}}),Ext.define("Gnt.model.Assignment",{extend:Sch.model.Assignment,customizableFields:[{name:"TaskId"},{name:"Units",type:"float",defaultValue:100}],taskIdField:"TaskId",eventIdField:"TaskId",constructor:function(e,t){var i=this;i.eventIdField=i.taskIdField,i.callParent([e,t])},getEventId:function(){var e=this;return e.get(e.taskIdField)},setEventId:function(e){var t=this;return t.set(t.taskIdField,e)},unitsField:"Units",getTaskStore:function(){return this.store&&this.store.getTaskStore()||null},getEventStore:function(){return this.getTaskStore()},getUnits:function(){var e=this;return Math.max(0,e.get(e.unitsField))},setUnits:function(e){var t=this;e<0&&Ext.Error.raise("`Units` value for an assignment can't be less than 0"),t.set(t.unitsField,e)},getTask:function(e){return this.getEvent(e)},getTaskName:function(e){var t=this.getTask(e);return t&&t.getName()||""},getEffort:function(e){var t=this,i=t.getTask(),n=0;return i.forEachAvailabilityIntervalWithResources({startDate:i.getStartDate(),endDate:i.getEndDate(),resources:[t.getResource()]},function(e,t,i){var r,a;for(r in i)a=i[r].units;n+=(t-e)*a/100}),i.getProjectCalendar().convertMSDurationToUnit(n,e||i.getEffortUnit())},getEffortAtDate:function(e,t){var i=Sch.util.Date,n=this,r=n.getTask(),a=r&&r.getStartDate(),s=r&&r.getEndDate(),o=n.getResource(),l=0;return r&&o&&a&&s&&(e=i.constrain(e,a,s),r.forEachAvailabilityIntervalWithResources({startDate:a,endDate:e,resources:[o]},function(e,t,i){var n=0;for(var r in i)n=i[r].units;l+=(t-e)*n/100}),l=r.getCalendar().convertMSDurationToUnit(l,t||r.getEffortUnit())),l},getUtilizationInfo:function(e,t){var i=this,n=i.getId(),r=i.getResource();r.getUtilizationInfo(e,t);return r.assignmentInfo[n]||{isUtilized:!1,allocationMs:0,allocationDeltaMs:0,isOverallocated:!1,isUnderallocated:!1}}}),Ext.define("Gnt.model.AssignmentEditing",{extend:Gnt.model.Assignment,fields:["ResourceName"]}),Ext.define("Gnt.column.ResourceName",{extend:Ext.grid.column.Column,alias:"widget.resourcenamecolumn",mixins:[Gnt.mixin.Localizable],dataIndex:"ResourceName",flex:1,align:"left",constructor:function(e){e=e||{},this.text=e.text||this.L("text"),Ext.apply(this,e),this.callParent(arguments)}}),Ext.define("Gnt.widget.AssignmentGrid",{extend:Ext.grid.Panel,alias:"widget.assignmentgrid",assignmentStore:null,resourceStore:null,readOnly:!1,cls:"gnt-assignmentgrid",defaultAssignedUnits:100,taskId:null,cellEditing:null,assignmentUnitsEditor:null,bufferedRenderer:!1,sorter:{sorterFn:function(e,t){var i=e.getUnits(),n=t.getUnits();return!i&&!n||i&&n?e.get("ResourceName")<t.get("ResourceName")?-1:1:i?-1:1}},constructor:function(e){this.store=Ext.create("Ext.data.JsonStore",{model:"Gnt.model.AssignmentEditing"}),this.columns=this.buildColumns(),this.readOnly||(this.plugins=this.buildPlugins()),Ext.applyIf(this,{selModel:{selType:"checkboxmodel",mode:"MULTI",checkOnly:!0}}),this.callParent(arguments)},initComponent:function(){this.loadResources(),this.mon(this.resourceStore,{datachanged:this.loadResources,scope:this}),this.callParent(arguments),this.getSelectionModel().on({select:this.onSelect,deselect:this.onDeselect,scope:this})},onSelect:function(e,t){this.cellEditing&&this.cellEditing.getActiveEditor()||t.getUnits()||t.setUnits(this.defaultAssignedUnits)},onDeselect:function(e,t){t.setUnits(0)},loadResources:function(){for(var e=[],t=this.resourceStore,i=0,n=t.getCount();i<n;i++){var r=t.getAt(i);e.push({ResourceId:r.getId(),ResourceName:r.getName(),Units:""})}this.store.loadData(e)},buildPlugins:function(){var e=this.cellEditing=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1});return e.on("edit",this.onEditingDone,this),[e]},hide:function(){this.cellEditing.cancelEdit(),this.callParent(arguments)},onEditingDone:function(e,t){t.value?this.getSelectionModel().select(t.record,!0):(this.getSelectionModel().deselect(t.record),t.record.reject())},buildColumns:function(){return[{xtype:"resourcenamecolumn"},{xtype:"assignmentunitscolumn",assignmentStore:this.assignmentStore,editor:{xtype:"numberfield",minValue:0,step:10,selectOnFocus:!Ext.isIE}}]},setEditableFields:function(e){this.assignmentUnitsEditor||(this.assignmentUnitsEditor=this.down("assignmentunitscolumn").getEditor());var t=this.assignmentStore&&this.assignmentStore.getTaskStore(),i=t&&t.getModelById(e);if(i)switch(i.getSchedulingMode()){case"DynamicAssignment":this.assignmentUnitsEditor.setReadOnly(!0);break;default:this.assignmentUnitsEditor.setReadOnly(!1)}},loadTaskAssignments:function(e){var t=this.store,i=this.getSelectionModel();this.taskId=e,i.deselectAll(!0);for(var n=0,r=t.getCount();n<r;n++){var a=t.getAt(n);a.data.Units=0,a.data.Id=null,delete a.__id__}this.assignmentStore.queryBy(function(t){return t.getTaskId()==e}).each(function(e){var n=t.findRecord("ResourceId",e.getResourceId(),0,!1,!0,!0);n&&(n.setUnits(e.getUnits()),n.__id__=e.getId(),i.select(n,!0,!0))}),Ext.isSafari&&this.focus(),t.sort(this.sorter),t.getSorters().removeAll(),this.setEditableFields(e)},saveTaskAssignments:function(){var e=this.assignmentStore,t=this.taskId,i={},n=[];this.getSelectionModel().selected.each(function(r){var a=r.getUnits();if(a>0){var s=r.__id__;if(s)i[s]=!0,e.getModelById(s).setUnits(a);else{var o=Ext.create(e.model);o.setTaskId(t),o.setResourceId(r.getResourceId()),o.setUnits(a),i[o.internalId]=!0,n.push(o)}}});var r=[];e.each(function(e){e.getTaskId()!=t||i[e.getId()||e.internalId]||r.push(e)}),e.fireEvent("beforetaskassignmentschange",e,t,n),e.suspendAutoSync(),e.remove(r),e.add(n),e.resumeAutoSync(),e.fireEvent("taskassignmentschanged",e,t,n),e.autoSync&&e.sync()},isDataChanged:function(){var e=this;return e.store&&e.store.getUpdatedRecords().length>0||e.store.getNewRecords().length>0||e.store.getRemovedRecords().length>0},isDataValid:function(){var e=!0;return this.store.each(function(t){if(!t.isValid())return e=!1,!1}),e}}),Ext.define("Gnt.field.Assignment",{extend:Ext.form.field.Picker,alias:["widget.assignmentfield","widget.assignmenteditor"],alternateClassName:"Gnt.widget.AssignmentField",mixins:[Gnt.mixin.Localizable],matchFieldWidth:!1,editable:!1,task:null,assignmentStore:null,resourceStore:null,gridConfig:null,formatString:"{0} [{1}%]",expandPickerOnFocus:!1,afterRender:function(){this.callParent(arguments),this.on("expand",this.onPickerExpand,this),this.expandPickerOnFocus&&this.on("focus",function(){this.expand()},this,{delay:1})},createPicker:function(){return new Gnt.widget.AssignmentGrid(Ext.apply({frame:!0,floating:!0,height:200,width:300,resourceStore:this.task.getResourceStore(),assignmentStore:this.task.getAssignmentStore(),fbar:this.buildButtons()},this.gridConfig||{}))},buildButtons:function(){return["->",{text:this.L("closeText"),handler:function(){Ext.Function.defer(this.onSaveClick,Ext.isIE&&!Ext.isIE9?60:30,this)},scope:this},{text:this.L("cancelText"),handler:function(){this.collapse()},scope:this}]},setTask:function(e){this.task=e,this.setRawValue(this.getFieldDisplayValue(e))},onPickerExpand:function(){this.picker.loadTaskAssignments(this.task.getId())},onSaveClick:function(){var e=this.picker.getSelectionModel(),t=e.selected;this.collapse(),this.fireEvent("select",this,t),this.picker.saveTaskAssignments()},isDirty:function(e){if(!(e=e||this.task))return!1;for(var t=this.picker&&this.picker.assignmentStore||e.getAssignmentStore(),i=e.getAssignments(),n=0,r=i.length;n<r;n++)if(i[n].dirty||i[n].phantom)return!0;if(t)for(i=t.getRemovedRecords(),n=0,r=i.length;n<r;n++)if(i[n].getTaskId()==e.getId())return!0;return!1},getFieldDisplayValue:function(e){e=e||this.task;for(var t=[],i=e.getAssignments(),n=0,r=i.length;n<r;n++){var a=i[n];a.getUnits()>0&&t.push(Ext.String.format(this.formatString,a.getResourceName(),a.getUnits()))}return t.join(", ")}}),Ext.define("Gnt.column.ResourceAssignment",{extend:Ext.grid.column.Column,alias:["widget.resourceassignmentcolumn","widget.ganttcolumn.resourceassignment"],mixins:[Gnt.mixin.Localizable],tdCls:"sch-assignment-cell",showUnits:!0,field:null,dirtyCls:null,constructor:function(e){e=e||{},this.text=e.text||this.L("text");var t=e.editor,i=e.showUnits||this.showUnits;delete e.editor,e.editor=t||{},e.editor instanceof Ext.form.Field||(e.editor=Ext.ComponentManager.create(Ext.applyIf(e.editor,{expandPickerOnFocus:!0,formatString:"{0}"+(i?" [{1}%]":"")}),"assignmentfield")),e.field=e.editor,this.callParent([e]),this.scope=this,this.field&&this.field.on("collapse",function(){Ext.isGecko?this.up("ganttpanel").lockedGrid.setActionableMode(!1):this.up("ganttpanel").ganttEditingPlugin.completeEdit()},this)},afterRender:function(){var e=this.up("treepanel").getView();e.markDirty&&(this.dirtyCls=e.dirtyCls),this.callParent(arguments)},renderer:function(e,t,i){return this.dirtyCls&&this.field.isDirty(i)&&(t.tdCls=this.dirtyCls),this.field.getFieldDisplayValue(i)}}),Ext.define("Gnt.column.Rollup",{extend:Ext.grid.Column,alias:["widget.rollupcolumn","widget.ganttcolumn.rollup"],mixins:[Gnt.column.mixin.TaskFieldColumn],fieldProperty:"rollupField",editor:"combobox",initComponent:function(){this.initTaskFieldColumn({store:[[!1,this.L("no")],[!0,this.L("yes")]]}),this.callParent(arguments)},getValueToRender:function(e,t,i){return this.L(e?"yes":"no")}}),Ext.define("Gnt.column.Scale",{extend:Ext.grid.column.Template,alias:"widget.scalecolumn",tpl:null,sortable:!1,scalePoints:null,scaleStep:2,scaleLabelStep:4,scaleMin:0,scaleMax:24,width:40,availableHeight:48,scaleCellCls:"gnt-scalecolumn",initComponent:function(){this.tdCls=(this.tdCls||"")+" "+this.scaleCellCls,this.tpl||(this.tpl=new Ext.XTemplate('<div class="'+this.scaleCellCls+'-wrap" style="height:{scaleHeight}px;">','<tpl for="scalePoints">',"<tpl if=\"label !== ''\">",'<span class="'+this.scaleCellCls+'-label-line {cls}" style="top:{top}px"><span class="'+this.scaleCellCls+'-label">{label}</span></span>',"<tpl else>",'<span class="'+this.scaleCellCls+'-line {cls}" style="top:{top}px"></span>',"</tpl>","</tpl>","</div>")),this.setAvailableHeight(this.availableHeight,!0),this.callParent(arguments)},setAvailableHeight:function(e,t){this.availableHeight=e,this.scalePoints?(t&&(this.scalePoints.sort(function(e,t){return e.value-t.value}),this.scaleMin=this.scalePoints[0].value,this.scaleMax=this.scalePoints[this.scalePoints.length-1].value,this.scaleStep=(this.scaleMax-this.scaleMin)/10),this.scaleStepHeight=this.availableHeight/(this.scaleMax-this.scaleMin+this.scaleStep),this.updateScalePointsTops()):(this.scaleStepHeight=this.availableHeight/(this.scaleMax-this.scaleMin+this.scaleStep),this.scalePoints=this.buildScalePoints())},defaultRenderer:function(e,t,i){var n={record:Ext.apply({},i.data,i.getAssociatedData()),scaleHeight:this.availableHeight,scalePoints:this.scalePoints};return this.tpl.apply(n)},buildScalePoints:function(){for(var e=this.scaleMin,t=e,i=this.scaleStep,n=this.scaleLabelStep,r=this.scaleStepHeight,a=this.availableHeight,s=this.scaleCellCls,o=s+"-min",l=[],d=function(t,i,n){return{top:Math.round(a-(t-e)*r),value:t,label:"undefined"!=i?i:"",cls:n||""}};t<this.scaleMax;)l.push(d(t,t%n||t===e?"":t,o)),o="",t+=i;return l.push(d(this.scaleMax,this.scaleMax,s+"-max")),l},updateScalePointsTops:function(){var e=this.scaleStepHeight,t=this.availableHeight;Ext.Array.forEach(this.scalePoints,function(i){i.top=Math.round(t-i.value*e)})}}),Ext.define("Gnt.field.SchedulingMode",{extend:Ext.form.field.ComboBox,mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],alias:"widget.schedulingmodefield",alternateClassName:"Gnt.widget.SchedulingmodeField",taskField:"schedulingModeField",setTaskValueMethod:"setSchedulingMode",getTaskValueMethod:"getSchedulingMode",pickerAlign:"tl-bl?",matchFieldWidth:!0,editable:!1,forceSelection:!0,triggerAction:"all",constructor:function(e){e=e||{},e.store||this.initStore(e),this.callParent([e]),this.on("change",this.onFieldChange,this)},initStore:function(e){var t=this;e.store=t.getDefaultSchedulingModes()},getDefaultSchedulingModes:function(){var e=this;return[["Normal",e.L("Normal")],["FixedDuration",e.L("FixedDuration")],["EffortDriven",e.L("EffortDriven")],["DynamicAssignment",e.L("DynamicAssignment")]]},valueToVisible:function(e,t){var i=this,n=[],r=this.findRecordByValue(e);return r?n.push(r.data):Ext.isDefined(i.valueNotFoundText)&&n.push(i.valueNotFoundText),i.displayTpl.apply(n)},getValue:function(){return this.value},onFieldChange:function(e){this.instantUpdate&&!this.getSuppressTaskUpdate()&&this.task&&this.value&&this.applyChanges()}}),Ext.define("Gnt.column.SchedulingMode",{extend:Ext.grid.column.Column,mixins:[Gnt.column.mixin.TaskFieldColumn],alias:["widget.schedulingmodecolumn","widget.ganttcolumn.schedulingmode"],width:100,align:"left",data:null,fieldProperty:"schedulingModeField",editor:"schedulingmodefield",instantUpdate:!1,initComponent:function(){this.initTaskFieldColumn({store:this.data}),this.callParent(arguments)}}),Ext.define("Gnt.column.Sequence",{extend:Ext.grid.column.Column,alias:["widget.sequencecolumn","widget.ganttcolumn.sequence"],mixins:[Gnt.mixin.Localizable],width:40,align:"right",sortable:!1,dataIndex:"index",constructor:function(e){e=e||{},this.text=e.text||this.L("text"),this.callParent(arguments)},renderer:function(e,t,i){return i.getSequenceNumber()}}),Ext.define("Gnt.column.ShowInTimeline",{extend:Ext.grid.column.Check,alias:["widget.showintimelinecolumn","widget.ganttcolumn.showintimeline"],mixins:[Gnt.column.mixin.TaskFieldColumn],fieldProperty:"showInTimelineField",initComponent:function(e){this.initTaskFieldColumn(),this.callParent([e]),this.tdCls=(this.tdCls||"")+" gnt-showintimeline-cell"},onReadOnlySet:function(e,t){this.setDisabled(t)},taskFieldRenderer:function(){var e=this.defaultRenderer.apply(this,arguments);return this.applyColumnCls.apply(this,arguments),e}}),Ext.define("Gnt.column.Slack",{extend:Ext.grid.column.Column,mixins:[Gnt.mixin.Localizable],alias:["widget.slackcolumn","widget.ganttcolumn.slack"],decimalPrecision:2,useAbbreviation:!1,slackUnit:"d",width:100,align:"left",constructor:function(e){e=e||{},this.text=e.text||this.L("text"),this.callParent(arguments),this.renderer=e.renderer||this.rendererFunc,this.scope=e.scope||this,this.hasCustomRenderer=!0},afterRender:function(){this.up("ganttpanel").registerLockedDependencyListeners(),this.callParent(arguments)},rendererFunc:function(e,t,i){return t.tdCls=(t.tdCls||"")+" sch-column-readonly",e=i.getSlack(),Ext.isNumber(e)?parseFloat(Ext.Number.toFixed(e,this.decimalPrecision))+" "+Sch.util.Date[this.useAbbreviation?"getShortNameOfUnit":"getReadableNameOfUnit"](this.slackUnit,1!==e):""}}),Ext.define("Gnt.column.Successor",{extend:Gnt.column.Dependency,mixins:[Gnt.mixin.Localizable],alias:["widget.successorcolumn","widget.ganttcolumn.successor"],type:"successors",constructor:function(e){e=e||{},this.text=e.text||this.L("text"),this.callParent(arguments)}}),Ext.define("Gnt.column.WBS",{extend:Ext.grid.column.Column,alias:["widget.wbscolumn","widget.ganttcolumn.wbs"],mixins:[Gnt.mixin.Localizable],width:40,align:"left",sortable:!1,dataIndex:"index",constructor:function(e){e=e||{},this.text=e.text||this.L("text"),this.callParent(arguments)},renderer:function(e,t,i){return i.getWBSCode()}}),Ext.define("Gnt.constraint.Base",{mixins:[Gnt.mixin.Localizable],isSatisfied:function(e,t,i){throw"Abstract method"},getResolution:function(e,t,i){var n=this,r=!1;i=i||t.getConstraintDate();var a=function(){r||(r=!0,e.apply(this,arguments))};return{title:n.L("name"),task:t,date:i,resolutions:this.getResolutionOptions(a,t,i),getCancelActionOption:function(){return this.resolutions[0]},cancelAction:function(){return this.getCancelActionOption().resolve()},proceedAction:function(){a()},getResolution:function(e){return Ext.Array.findBy(this.resolutions,function(t){return t.id==e})}}},getResolutionOptions:function(e,t,i,n){return[{id:"cancel",title:this.L("Cancel the change and do nothing"),resolve:function(){e(!0)}}]},hasThisConstraintApplied:function(e){return e.getConstraintClass()===this},getInitialConstraintDate:function(e){return e.getConstraintDate()},getDisplayableConstraintDateForFormat:function(e,t,i){return e},adjustConstraintDateFromDisplayableWithFormat:function(e,t,i){return e},shiftToNearestValidConstraintDate:function(e,t,i){return e},statics:{getConstraintClass:function(e){var t=!Ext.isEmpty(e)&&Ext.ClassManager.getByAlias("gntconstraint."+e);return Ext.isEmpty(e)||t||Ext.Error.raise("Can't get constraint class, unrecognized constraint type: "+e),t||null}}}),Ext.define("Gnt.constraint.AsLateAsPossible",{extend:Gnt.constraint.Base,singleton:!0,isSatisfied:function(e){throw"Abstract method"}}),Ext.define("Gnt.constraint.AsSoonAsPossible",{extend:Gnt.constraint.Base,singleton:!0,isSatisfied:function(e){throw"Abstract method"}}),Ext.define("Gnt.constraint.FinishNoEarlierThan",{extend:Gnt.constraint.Base,alias:"gntconstraint.finishnoearlierthan",singleton:!0,isSatisfied:function(e,t){var i=e.getEndDate();return!(t=t||e.getConstraintDate())||!i||i>=t},getResolutionOptions:function(e,t,i,n){var r=this,a=r.callParent(arguments);return i=i||t.getConstraintDate(),r.hasThisConstraintApplied(t)&&a.push({id:"remove-constraint",title:r.L("Remove the constraint"),resolve:function(){t.setConstraintType(""),e()}}),a.push({id:"move-task",title:r.L("Move the task to finish on {0}"),resolve:function(){t.setEndDateWithoutPropagation(i,!0),e()}}),a},getInitialConstraintDate:function(e){return e.getEndDate()},getDisplayableConstraintDateForFormat:function(e,t,i){return e&&!Ext.Date.formatContainsHourInfo(t)&&e-Ext.Date.clearTime(e,!0)==0&&(e=Sch.util.Date.add(e,Sch.util.Date.DAY,-1)),e},adjustConstraintDateFromDisplayableWithFormat:function(e,t,i){return e&&!Ext.Date.formatContainsHourInfo(t)&&e-Ext.Date.clearTime(e,!0)==0&&(e=Sch.util.Date.add(e,Sch.util.Date.DAY,1)),e}}),Ext.define("Gnt.constraint.FinishNoLaterThan",{extend:Gnt.constraint.Base,alias:"gntconstraint.finishnolaterthan",singleton:!0,isSatisfied:function(e,t,i){var n=e.getEndDate();return!(t=t||e.getConstraintDate())||!n||1!==Sch.util.Date.compareWithPrecision(n,t,i)},getResolutionOptions:function(e,t,i,n){var r=this,a=r.callParent(arguments);return i=i||t.getConstraintDate(),r.hasThisConstraintApplied(t)&&a.push({id:"remove-constraint",title:r.L("Remove the constraint"),resolve:function(){t.setConstraintType(""),e()}}),a.push({id:"move-task",title:r.L("Move the task to finish on {0}"),resolve:function(){t.setEndDateWithoutPropagation(i,!0),e()}}),a},getInitialConstraintDate:function(e){return e.getEndDate()},getDisplayableConstraintDateForFormat:function(e,t,i){return e&&!Ext.Date.formatContainsHourInfo(t)&&e-Ext.Date.clearTime(e,!0)==0&&(e=Sch.util.Date.add(e,Sch.util.Date.DAY,-1)),e},adjustConstraintDateFromDisplayableWithFormat:function(e,t,i){return e&&!Ext.Date.formatContainsHourInfo(t)&&e-Ext.Date.clearTime(e,!0)==0&&(e=Sch.util.Date.add(e,Sch.util.Date.DAY,1)),e}}),Ext.define("Gnt.constraint.MustFinishOn",{extend:Gnt.constraint.Base,alias:"gntconstraint.mustfinishon",singleton:!0,isSatisfied:function(e,t,i){var n=e.getEndDate();return!(t=t||e.getConstraintDate())||!n||0===Sch.util.Date.compareWithPrecision(n,t,i)},getResolutionOptions:function(e,t,i,n){var r=this,a=r.callParent(arguments);return i=i||t.getConstraintDate(),r.hasThisConstraintApplied(t)&&a.push({id:"remove-constraint",title:r.L("Remove the constraint"),resolve:function(){t.setConstraintType(""),e()}}),a.push({id:"move-task",title:r.L("Move the task to finish on {0}"),resolve:function(){t.setEndDateWithoutPropagation(i,!0),e()}}),a},getInitialConstraintDate:function(e){return e.getEndDate()},getDisplayableConstraintDateForFormat:function(e,t,i){return e&&!Ext.Date.formatContainsHourInfo(t)&&e-Ext.Date.clearTime(e,!0)==0&&(e=Sch.util.Date.add(e,Sch.util.Date.DAY,-1)),e},adjustConstraintDateFromDisplayableWithFormat:function(e,t,i){return e&&!Ext.Date.formatContainsHourInfo(t)&&e-Ext.Date.clearTime(e,!0)==0&&(e=Sch.util.Date.add(e,Sch.util.Date.DAY,1)),e}}),Ext.define("Gnt.constraint.MustStartOn",{extend:Gnt.constraint.Base,alias:"gntconstraint.muststarton",singleton:!0,isSatisfied:function(e,t,i){var n=e.getStartDate();return!(t=t||e.getConstraintDate())||!n||0===Sch.util.Date.compareWithPrecision(n,t,i)},getResolutionOptions:function(e,t,i,n){var r=this,a=r.callParent(arguments);return i=i||t.getConstraintDate(),this.hasThisConstraintApplied(t)&&a.push({id:"remove-constraint",title:r.L("Remove the constraint"),resolve:function(){t.setConstraintType(""),e()}}),a.push({id:"move-task",title:r.L("Move the task to start at {0}"),resolve:function(){t.setStartDateWithoutPropagation(i,!0),e()}}),a},getInitialConstraintDate:function(e){return e.getStartDate()}}),Ext.define("Gnt.constraint.StartNoEarlierThan",{extend:Gnt.constraint.Base,alias:"gntconstraint.startnoearlierthan",singleton:!0,isSatisfied:function(e,t,i){var n=e.getStartDate();return!(t=t||e.getConstraintDate())||!n||-1!==Sch.util.Date.compareWithPrecision(n,t,i)},getResolutionOptions:function(e,t,i,n){var r=this,a=r.callParent(arguments);return i=i||t.getConstraintDate(),r.hasThisConstraintApplied(t)&&a.push({id:"remove-constraint",title:r.L("Remove the constraint"),resolve:function(){t.setConstraintType(""),e()}}),a.push({id:"move-task",title:r.L("Move the task to start at {0}"),resolve:function(){t.setStartDateWithoutPropagation(i,!0),e()}}),a},getInitialConstraintDate:function(e){return e.getStartDate()}}),Ext.define("Gnt.constraint.StartNoLaterThan",{extend:Gnt.constraint.Base,alias:"gntconstraint.startnolaterthan",singleton:!0,isSatisfied:function(e,t,i){var n=e.getStartDate();return!(t=t||e.getConstraintDate())||!n||1!==Sch.util.Date.compareWithPrecision(n,t,i)},getResolutionOptions:function(e,t,i,n){var r=this,a=r.callParent(arguments);return i=i||t.getConstraintDate(),r.hasThisConstraintApplied(t)&&a.push({id:"remove-constraint",title:r.L("Remove the constraint"),resolve:function(){t.setConstraintType(""),e()}}),a.push({id:"move-task",title:r.L("Move the task to start at {0}"),resolve:function(){t.setStartDateWithoutPropagation(i,!0),e()}}),a},getInitialConstraintDate:function(e){return e.getStartDate()}}),Ext.define("Gnt.data.AssignmentStore",{extend:Sch.data.AssignmentStore,model:"Gnt.model.Assignment",alias:"store.gantt_assignmentstore",storeId:"assignments",proxy:"memory",attachToEventStore:Ext.emptyFn,attachToResourceStore:Ext.emptyFn,getTaskStore:function(){return this.getEventStore()},setTaskStore:function(e){return this.setEventStore(e)},mapAssignmentsForTask:function(e,t,i){return this.mapAssignmentsForEvent(e,t,i)},getAssignmentsForTask:function(e){return this.getAssignmentsForEvent(e)},removeAssignmentsForTask:function(e){return this.removeAssignmentsForEvent(e)},getResourcesForTask:function(e){return this.getResourcesForEvent(e)},getTasksForResource:function(e){return this.getEventsForResource(e)},assignTaskToResource:function(e,t,i){return this.assignEventToResource(e,t,function(e){return e.setUnits(i),e})},unassignTaskFromResource:function(e,t){return this.unassignEventFromResource(e,t)},isTaskAssignedToResource:function(e,t,i){return this.isEventAssignedToResource(e,t,i)},getAssignmentForTaskAndResource:function(e,t){return this.getAssignmentForEventAndResource(e,t)}}),Ext.define("Gnt.data.CalendarManager",{extend:Ext.data.TreeStore,mixins:[Sch.data.mixin.UniversalModelGetter],model:"Gnt.model.Calendar",alias:"store.calendarmanager",storeId:"calendars",calendarClass:"Gnt.data.Calendar",calendarConfig:null,projectCalendar:null,myListeners:null,constructor:function(e){e=e||{},e.proxy||(e.proxy={type:"memory"}),this.callParent([e]),this.myListeners=this.on({idchanged:this.onChangeId,rootchange:this.onNewRoot,nodeappend:this.onNewNode,nodeinsert:this.onNewNode,noderemove:this.onRemoveNode,destroyable:!0,scope:this});var t=this.getRoot();t?this.bindCalendars(t):this.setRoot({expanded:!0})},destroy:function(){this.myListeners.destroy(),this.callParent(arguments)},onChangeId:function(e,t,i,n){if(e instanceof Gnt.model.Calendar){this.getCalendar(t||n).setCalendarId(i)}},onIdChanged:function(e,t,i){return this.onChangeId(e,t,i),this.callParent(arguments)},onNewNode:function(e,t){this.bindCalendars(t),t!==this.getRoot()&&this.fixCalendarParent(t);var i=this;t.cascadeBy(function(e){e.setCalendarManager(i)})},onNewRoot:function(e){this.onNewNode(null,e)},onRemoveNode:function(e,t,i){if(!i){var n=t.calendar;n&&(this.unbindCalendarEvents(n),this.__loading||(n.destroy(),Ext.data.StoreManager.unregister(n)),t.setCalendarManager(null))}},suspendCalendarsEvents:function(e){this.getRoot().cascadeBy(function(t){var i=t.getCalendar();i&&i.suspendEvents(e)},this)},resumeCalendarsEvents:function(){this.getRoot().cascadeBy(function(e){var t=e.getCalendar();t&&t.resumeEvents()},this)},getCalendarClass:function(){return this.calendarClass},getProjectCalendar:function(){return this.projectCalendar},setProjectCalendar:function(e){this.settingProjectCalendar||("object"!=typeof e&&(e=this.getCalendar(e)||Gnt.data.Calendar.getCalendar(e)),e&&(this.settingProjectCalendar=!0,this.projectCalendar=e,this.fireEvent("projectcalendarset",this,e),this.settingProjectCalendar=!1))},getCalendar:function(e){var t=this.getModelById(e);return t&&t.getCalendar()},getNodeByCalendar:function(e){if(!e)return this.getRoot();var t=this.getModelById(e.calendarId);return t||this.getRoot().cascadeBy(function(i){if(i.getCalendar()===e)return t=i,!1},this),t},onParentChange:function(e,t,i){var n=this.getNodeByCalendar(e);n&&!n.syncingCalendarParent&&this.fixNodeParent(n)},bindCalendarEvents:function(e){this.relayEvents(e,["load"],"calendar"),this.relayEvents(e,["add","update","remove","bulkremove"],"day"),this.relayEvents(e,["calendarchange"]),e.on("parentchange",this.onParentChange,this),this.on({dayadd:this.onDayAdd,dayupdate:this.onDayUpdate,dayremove:this.onDayRemove,scope:this})},unbindCalendarEvents:function(e){this.un({dayadd:this.onDayAdd,dayupdate:this.onDayUpdate,dayremove:this.onDayRemove,scope:this}),e&&e.un({parentchange:this.onParentChange,scope:this})},onDayAdd:function(e,t){this.getModelById(e.getCalendarId()).dirty=!0},onDayUpdate:function(e,t){this.getModelById(e.getCalendarId()).dirty=!0},onDayRemove:function(e,t){this.getModelById(e.getCalendarId()).dirty=!0},fixCalendarParent:function(e){if(!e.syncingCalendarParent){var t=e.parentNode.getCalendar(),i=e.getCalendar();t!==i.parent&&(e.syncingCalendarParent=!0,
i.setParent(t),e.syncingCalendarParent=!1)}},fixNodeParent:function(e){var t=e.parentNode.getCalendar(),i=e.getCalendar().parent;if(t!==i){var n=this.getNodeByCalendar(i);n&&n.appendChild(e)}},bindCalendar:function(e){if(e&&this.getRoot()!==e){var t=e.getCalendar(),i=e.getDays();i&&console.log(i);var n=e.getId()||e.internalId;if(i=Ext.isArray(i)&&i,!t||i){if(t||(t=Gnt.data.Calendar.getCalendar(n)),!t){var r=e.parentNode&&e.parentNode.getCalendar(),a=Ext.ClassManager.get(e.getCalendarClass()||this.calendarClass),s=Ext.applyIf(e.getCalendarConfig(),{data:i,parent:r});t=Ext.create(a,Ext.apply(s,this.calendarConfig))}e.setCalendar(t),this.bindCalendarEvents(t)}else this.getCalendar(t.calendarId)||this.bindCalendarEvents(t);this.fireEvent("calendarbound",this,t,e)}},unbindCalendar:function(e){if(e&&this.getRoot()!==e){var t=e.getCalendar();t&&(this.unbindCalendarEvents(t),this.fireEvent("calendarunbound",this,t,e))}},bindCalendars:function(e){var t=this;e&&Ext.Array.forEach([].concat(e),function(e){e.cascadeBy(t.bindCalendar,t)})},unbindCalendars:function(e){var t=this;e&&Ext.Array.forEach([].concat(e),function(e){e.cascadeBy(t.unbindCalendar,t)})}}),Ext.define("Gnt.data.CrudManager",{extend:Sch.crud.AbstractManager,mixins:[Sch.crud.encoder.Json,Sch.crud.transport.Ajax],calendarManager:null,taskStore:null,dependencyStore:null,resourceStore:null,assignmentStore:null,addRelatedStores:!0,constructor:function(e){e=e||{};var t=e.calendarManager||this.calendarManager,i=e.taskStore||this.taskStore||new Gnt.data.TaskStore,n=e.assignmentStore||this.assignmentStore,r=e.resourceStore||this.resourceStore,a=e.dependencyStore||this.dependencyStore,s=[];if(i&&!1!==e.addRelatedStores){var o=this.getTaskStoreInfo(i,e);t=t||o.calendarManager,n=n||o.assignmentStore,r=r||o.resourceStore,a=a||o.dependencyStore}if(t&&(this.mixins.observable.constructor.call(this,e),this.addCalendarManager(t,s)),r&&s.push(r),n&&s.push(n),a&&s.push(a),i&&s.push(i),s.length){var l=[];t&&l.push(t),r&&l.push(r),i&&l.push(i),n&&l.push(n),a&&l.push(a),l.length&&(e.syncApplySequence=(e.syncApplySequence||e.stores||[]).concat(l));var d=e.stores||this.stores;d&&!Ext.isArray(d)&&(d=[d]),e.stores=(d||[]).concat(s)}this.callParent([e]),this.calendarManager=this.getStoreDescriptor(t),this.resourceStore=this.getStoreDescriptor(r),this.assignmentStore=this.getStoreDescriptor(n),this.dependencyStore=this.getStoreDescriptor(a),this.taskStore=this.getStoreDescriptor(i)},getTaskStoreInfo:function(e,t){e instanceof Ext.data.AbstractStore||(e="string"==typeof e?Ext.data.StoreManager.get(e):e.store);var i={},n=t.calendarManager,r=t.assignmentStore,a=t.resourceStore,s=t.dependencyStore;return n||(i.calendarManager=e.calendarManager),r||(i.assignmentStore=e.getAssignmentStore()),a||(i.resourceStore=e.getResourceStore()),s||(i.dependencyStore=e.getDependencyStore()),i},addCalendarManager:function(e,t){var i,n;e instanceof Ext.data.AbstractStore?(i=e,n={store:e}):"object"==typeof e?(i=e.store,n=e):(e=Ext.data.StoreManager.get(e),i=e,n={store:e});var r=(i.getModel&&i.getModel()||i.model).prototype;n.stores||(n.stores=[{storeId:r.daysField,idProperty:r.idProperty}]),this.calendarManager=n,i.on("load",this.onCalendarManagerLoad,this),this.mon(i,{dayadd:this.onStoreChange,dayupdate:this.onStoreChange,dayremove:this.onStoreChange,daybulkremove:this.onStoreChange,scope:this}),t.push(n)},onCalendarManagerLoad:function(e){var t=e.getProjectCalendar(),i=t&&t.getCalendarId(),n=e.metaData&&e.metaData.projectCalendar;i!=n&&e.setProjectCalendar(n)},applyLoadResponse:function(){var e=this.getCalendarManager();e&&e.suspendCalendarsEvents(),this.callParent(arguments),e&&e.resumeCalendarsEvents()},getCalendarManager:function(){return this.calendarManager&&this.calendarManager.store},getResourceStore:function(){return this.resourceStore&&this.resourceStore.store},getDependencyStore:function(){return this.dependencyStore&&this.dependencyStore.store},getAssignmentStore:function(){return this.assignmentStore&&this.assignmentStore.store},getTaskStore:function(){return this.taskStore&&this.taskStore.store},prepareUpdated:function(e,t,i){if(e[0]instanceof Gnt.model.Task){e=Ext.Array.filter(e,function(e){return!e.isRoot()});var n=this.callParent([e,t,i]);if(this.resetIdsBeforeSync)for(var r=e[0].segmentsField,a=Ext.ClassManager.get(e[0].segmentClassName).prototype,s=a.idProperty,o=a.phantomIdField,l=0;l<n.length;l++){var d=n[l][r];if(d)for(var c=0;c<d.length;c++){var h=d[c];h[o]&&delete h[s]}}return n}return this.callParent(arguments)},prepareAdded:function(e){var t=this.callParent(arguments);if(this.resetIdsBeforeSync&&e[0]instanceof Gnt.model.Task)for(var i=e[0].segmentsField,n=Ext.ClassManager.get(e[0].segmentClassName).prototype.idProperty,r=0;r<t.length;r++){var a=t[r][i];if(a)for(var s=0;s<a.length;s++)delete a[s][n]}return t},applyChangesToTask:function(e,t){if(t.hasOwnProperty(e.segmentsField)){var i=e.getSegments(),n=e.segmentsField,r=i&&i[0].phantomIdField,a=i&&i[0].idProperty,s=t[n];if(s&&s.length){for(var o=s.length-1;o>=0;o--)for(var l=s[o],d=l[r],c=l[a],h=null,u=0;u<i.length;u++)if(h=i[u],h.get(r)==d||h.getId()==c){this.applyChangesToRecord(h,l);break}delete t[n]}}},applyChangesToRecord:function(e,t,i){e instanceof Gnt.model.Task&&(this.ignoreUpdates++,this.applyChangesToTask.apply(this,arguments),this.ignoreUpdates--),this.callParent(arguments)}}),Ext.define("Gnt.model.Dependency",{extend:Sch.model.Customizable,inheritableStatics:{Type:{StartToStart:0,StartToEnd:1,EndToStart:2,EndToEnd:3}},idProperty:"Id",customizableFields:[{name:"From"},{name:"To"},{name:"Type",type:"int",defaultValue:2},{name:"Lag",type:"number",defaultValue:0},{name:"LagUnit",type:"string",defaultValue:"d",convert:function(e){return e||"d"}},{name:"Cls",defaultValue:""}],fromField:"From",toField:"To",typeField:"Type",lagField:"Lag",lagUnitField:"LagUnit",clsField:"Cls",isHighlighted:!1,constructor:function(e){this.callParent(arguments),e&&(e[this.fromField]&&e[this.fromField]instanceof Gnt.model.Task&&(this.setSourceTask(e[this.fromField]),delete e.fromField),e[this.toField]&&e[this.toField]instanceof Gnt.model.Task&&(this.setTargetTask(e[this.toField]),delete e.toField))},getTaskStore:function(){return this.store.taskStore},getSourceTask:function(e){return(e||this.getTaskStore()).getModelById(this.getSourceId())},setSourceTask:function(e){this.setSourceId(e.getId()||e.internalId)},getTargetTask:function(e){return(e||this.getTaskStore()).getModelById(this.getTargetId())},setTargetTask:function(e){this.setTargetId(e.getId()||e.internalId)},getSourceId:function(){return this.get(this.fromField)},setSourceId:function(e){this.set(this.fromField,e)},getTargetId:function(){return this.get(this.toField)},setTargetId:function(e){this.set(this.toField,e)},getLagUnit:function(){return this.get(this.lagUnitField)||"d"},isPersistable:function(){var e=this.getSourceTask(),t=this.getTargetTask();return e&&!e.phantom&&t&&!t.phantom},isValid:function(e){var t=this.callParent(arguments),i=this.getSourceId(),n=this.getTargetId(),r=this.getType();return t&&(t=Ext.isNumber(r)&&!Ext.isEmpty(i)&&!Ext.isEmpty(n)&&i!=n),t&&!1!==e&&this.store&&(t=this.store.isValidDependency(i,n,r,null,null,this)),t}}),Ext.define("Gnt.data.DependencyStore",{extend:Ext.data.Store,mixins:[Sch.data.mixin.UniversalModelGetter],model:"Gnt.model.Dependency",storeId:"dependencies",alias:"store.gantt_dependencystore",taskStore:null,methodsCache:null,strictDependencyValidation:!1,transitiveDependencyValidation:!1,ignoreInitial:!0,isLoadingRecords:!1,allowedDependencyTypes:null,proxy:"memory",allowParentTaskDependencies:!0,constructor:function(e){e=e||{},this.callParent([e]),this.init(),this.ignoreInitial=!1},init:function(){this.methodsCache={},this.on({add:this.onDependencyAdd,update:this.onDependencyUpdate,load:this.onDependencyLoad,datachanged:this.onDependencyDataChanged,remove:this.onDependencyRemove,clear:this.onDependencyStoreClear,priority:100,scope:this})},onDependencyLoad:function(){var e=this.getTaskStore();e&&e.fillTasksWithDepInfo()},onDependencyDataChanged:function(){var e=this.getTaskStore();this.isLoadingRecords&&e&&e.fillTasksWithDepInfo()},loadRecords:function(){this.isLoadingRecords=!0,this.callParent(arguments),this.isLoadingRecords=!1},scheduleTask:function(e){var t=this.getTaskStore(),i=e.getStartDate(),n=e.getEndDate();i&&n||(e.beginEdit(),i||e.setStartDateWithoutPropagation(t.getProjectStartDate(),void 0!==e.getDuration()),n||e.setDurationWithoutPropagation(1),e.endEdit())},scheduleLinkedTasks:function(e,t){this.scheduleTask(e),t.getStartDate()||e.getTaskStore().cascadeChanges||t.alignByIncomingDependencies(),this.scheduleTask(t)},onDependencyAdd:function(e,t){if(!this.ignoreInitial){for(var i=0;i<t.length;i++){var n=t[i];if(!this.isValidDependencyType(n.getType()))throw"This dependency type is invalid. Check Gnt.data.DependencyStore#allowedDependencyTypes value";var r=n.getSourceTask(),a=n.getTargetTask();r&&a&&(r.successors.push(n),a.predecessors.push(n),this.scheduleLinkedTasks(r,a))}e.resetMethodsCache()}},onDependencyRemove:function(e,t,i,n){var r=this.getTaskStore(),a=[];Ext.Array.forEach(t,function(e){var t=e.getSourceTask(r),i=e.getTargetTask(r);t&&Ext.Array.remove(t.successors,e),i&&(Ext.Array.remove(i.predecessors,e),i.isManuallyScheduled()||a.push(i))}),e.resetMethodsCache(),Ext.Array.forEach(a,function(e){e.adjustToCalendarWithoutPropagation()})},onDependencyUpdate:function(e,t,i){if(i!=Ext.data.Model.COMMIT){var n=this.getTaskStore(),r=t.previous,a=t.getSourceTask(),s=t.getTargetTask(),o=r&&t.fromField in r,l=r&&t.toField in r;if(o){var d=n.getModelById(r[t.fromField]);d&&Ext.Array.remove(d.successors,t),a&&Ext.Array.indexOf(a.successors,t)<0&&a.successors.push(t)}if(l){var c=n.getModelById(r[t.toField]);c&&Ext.Array.remove(c.predecessors,t),s&&Ext.Array.indexOf(s.predecessors,t)<0&&s.predecessors.push(t)}(o||l)&&a&&s&&this.scheduleLinkedTasks(a,s),this.resetMethodsCache()}},onDependencyStoreClear:function(e){var t=e.getTaskStore();t&&t.fillTasksWithDepInfo()},getDependenciesForTask:function(e){return e.successors.concat(e.predecessors)},getIncomingDependenciesForTask:function(e,t){return t?e.predecessors:e.predecessors.slice()},getOutgoingDependenciesForTask:function(e,t){return t?e.successors:e.successors.slice()},getKeyByDeps:function(e,t,i){if(!e||!e.length)return"";for(var n="",r=0,a=e.length;r<a;r++){var s=e[r];n+=(s.getSourceId&&s.getSourceId()||s[t])+":"+(s.getTargetId&&s.getTargetId()||s[i])+","}return n},buildCacheKey:function(e,t,i,n,r){var a=r.fromField||(r.fromField=this.model.prototype.fromField),s=r.toField||(r.toField=this.model.prototype.toField),o=r.ignoreDepKey,l=r.addDepKey;return r.hasOwnProperty("ignoreDepKey")||(r.ignoreDepKey=o=i&&this.getKeyByDeps(i,a,s)||"",r.addDepKey=l=n&&this.getKeyByDeps(n,a,s)||""),e+"-"+t+"-"+o+"-"+l},hasTransitiveDependency:function(e,t,i,n,r){r=r||{visitedTasks:{}};var a=this.buildCacheKey(e,t,i,n,r),s=r.visitedTasks,o=r.extraSuccessors;if(this.isCachedResultAvailable("hasTransitiveDependency",a))return this.methodsCache.hasTransitiveDependency[a];var l,d,c=this,h=r.fromField,u=r.toField,g=this.getTaskById(e);if(s[e])return!1;if(s[e]=!0,g){if(n&&!o)for(o=r.extraSuccessors={},l=0,d=n.length;l<d;l++){var f=n[l],p=f.getSourceId&&f.getSourceId()||f[h];o[p]=o[p]||[],o[p].push(f)}var m,v=g.successors;for(o&&o[e]&&(v=v.concat(o[e])),l=0,d=v.length;l<d;l++){m=v[l];var S=m.getTargetId&&m.getTargetId()||m[u];if((!i||-1==Ext.Array.indexOf(i,m))&&(S===t||c.hasTransitiveDependency(S,t,i,n,r)))return this.setCachedResult("hasTransitiveDependency",a,!0)}}return this.setCachedResult("hasTransitiveDependency",a,!1)},successorsHaveTransitiveDependency:function(e,t,i,n,r){r=r||{};var a=this.buildCacheKey(e,t,i,n,r),s=t instanceof Gnt.model.Task?t:this.getTaskById(t);if(this.isCachedResultAvailable("successorsHaveTransitiveDependency",a))return this.methodsCache.successorsHaveTransitiveDependency[a];for(var o=0,l=s.successors.length;o<l;o++){var d=s.successors[o].getTargetId();if(this.hasTransitiveDependency(e,d,i,n)||this.predecessorsHaveTransitiveDependency(e,d,i,n)||this.successorsHaveTransitiveDependency(e,d,i,n,r))return this.setCachedResult("successorsHaveTransitiveDependency",a,!0)}return this.setCachedResult("successorsHaveTransitiveDependency",a,!1)},predecessorsHaveTransitiveDependency:function(e,t,i,n,r){r=r||{};var a=this.buildCacheKey(e,t,i,n,r),s=e instanceof Gnt.model.Task?e:this.getTaskById(e);if(this.isCachedResultAvailable("predecessorsHaveTransitiveDependency",a))return this.methodsCache.predecessorsHaveTransitiveDependency[a];for(var o=0,l=s.predecessors.length;o<l;o++){var d=s.predecessors[o].getSourceId();if(this.hasTransitiveDependency(d,t,i,n)||this.successorsHaveTransitiveDependency(d,t,i,n)||this.predecessorsHaveTransitiveDependency(d,t,i,n,r))return this.setCachedResult("predecessorsHaveTransitiveDependency",a,!0)}return this.setCachedResult("predecessorsHaveTransitiveDependency",a,!1)},isPartOfTransitiveDependency:function(e,t,i,n){var r=e instanceof Gnt.model.Task?e:this.getTaskById(e);return!(!r.predecessors.length&&!r.successors.length)&&(r.predecessors.length?this.predecessorsHaveTransitiveDependency.apply(this,arguments):this.successorsHaveTransitiveDependency.apply(this,arguments))},getCycle:function(e){e=e||{},Ext.applyIf(e,{ignoreTasks:{},visitedTasks:{},path:[],task:this.getAt(0).getSourceTask()});var t=e.visitedTasks,i=e.ignoreTasks,n=e.path,r=e.task,a=r.getId();if(!i[a]){if(n.push(r),t[a])return n;t[a]=!0;for(var s=r.successors,o=0,l=s.length;o<l;o++){e.task=s[o].getTargetTask();var d=this.getCycle(e);if(d)return d}n.pop(),delete t[a]}},getCycles:function(){var e=this,t=[],i={};return this.each(function(n){var r=e.getCycle({task:n.getSourceTask(),ignoreTasks:i});if(r){for(var a=0,s=r.length;a<s;a++)i[r[a]]=!0;t.push(r)}}),t},resetMethodsCache:function(){this.methodsCache={}},isCachedResultAvailable:function(e,t){return this.methodsCache[e]&&this.methodsCache[e].hasOwnProperty(t)},getCachedResult:function(e,t){return this.methodsCache[e][t]},setCachedResult:function(e,t,i){return this.methodsCache[e]=this.methodsCache[e]||{},this.methodsCache[e][t]=i,i},getGroupTopTasks:function(e,t){var i,n,r=e.length,a=t.length,s=r,o=a;do{i=e[s],n=t[o],s--,o--}while(i==n&&s>=0&&o>=0);return[i,n]},groupsHasTransitiveDependency:function(e,t,i,n,r){var a=r||{targets:null,visitedTasks:{}},s=this.getTaskStore().getRootNode(),o=!1,l=this,d=this.getTaskById(e),c=this.getTaskById(t),h=a.visitedTasks,u=a.targets;a.targetGroup||(a.targetGroup=c.getTopParent(!0));var g=a.fromField||(a.fromField=this.model.prototype.fromField),f=a.toField||(a.toField=this.model.prototype.toField),p=a.ignoreDepKey,m=a.addDepKey,v=this.getGroupTopTasks(d.getTopParent(!0),a.targetGroup),S=v[0],y=v[1];if(S===d&&y===c&&d.isLeaf()&&c.isLeaf())return this.hasTransitiveDependency(e,t,i);a.hasOwnProperty("ignoreDepKey")||(a.ignoreDepKey=p=i&&this.getKeyByDeps(i,g,f)||"",a.addDepKey=m=n&&this.getKeyByDeps(n,g,f)||"");var E=S.getId()+"-"+y.getId()+"-"+p+"-"+m;if(this.isCachedResultAvailable("groupsHasTransitiveDependency",E))return this.methodsCache.groupsHasTransitiveDependency[E];y!==a.targetTopParent&&(a.targetTopParent=y,u=a.targets={},y.cascadeBy(function(e){u[e.getId()]=!0}));var x=a.extraSuccessors;if(n&&!x){x=a.extraSuccessors={};for(var D=0,T=n.length;D<T;D++){var C=n[D],k=C.getSourceId&&C.getSourceId()||C[g];x[k]=x[k]||[],x[k].push(C)}}return S.cascadeBy(function(e){if(e!==s){var r=e.getId();if(h[r])return!1;h[r]=!0;var d=e.successors;x&&x[r]&&(d=d.concat(x[r]));for(var c=0,g=d.length;c<g;c++){var p=d[c],m=p.getTargetId&&p.getTargetId()||p[f];if((!i||-1==Ext.Array.indexOf(i,p))&&(u[m]||l.groupsHasTransitiveDependency(m,t,i,n,a)))return o=!0,!1}}}),this.setCachedResult("groupsHasTransitiveDependency",E,o)},getDependencyError:function(e,t,i,n,r,a){var s,o,l,d=e instanceof Gnt.model.Dependency;if(d)s=e.getSourceId(),o=this.getTaskById(s),n=t,r=i,n&&Ext.Array.contains(n,e)&&(n=Ext.Array.slice(n,0),Ext.Array.remove(n,e)),i=e.getType(),t=e.getTargetId(),l=this.getTaskById(t),e.store&&(a=e);else if(s=e,o=this.getTaskById(s),l=this.getTaskById(t),void 0===i){var c=this.model.getField(this.model.prototype.typeField).defaultValue;i=void 0!==c?c:this.model.Type.EndToStart}if(!a&&d&&!e.isValid())return-1;if(!s||!t||s==t)return-1;if(!o||!l)return-2;if(!this.isValidDependencyType(i))return-10;if(o.contains(l)||l.contains(o))return-9;var h;if((r||a)&&(h=[],a&&h.push(a),r&&(h=h.concat(r))),this.transitiveDependencyValidation){if(this.hasTransitiveDependency(s,t,h,n))return-3}else if(this.areTasksLinkedForward(s,t,h,n))return-3;if(this.hasTransitiveDependency(t,s,h,n))return-4;if(this.transitiveDependencyValidation&&this.isPartOfTransitiveDependency(s,t,h,n))return-5;if(this.strictDependencyValidation){if(this.groupsHasTransitiveDependency(t,s,h,n))return-7;if(this.transitiveDependencyValidation&&this.groupsHasTransitiveDependency(s,t,h,n))return-8}if(!(this.allowParentTaskDependencies||o.isLeaf()&&l.isLeaf()))return-11;if(l.isProject||o.isProject)return-12;var u=l.getProject(),g=o.getProject();return u!=g&&(u&&!u.getAllowDependencies()||g&&!g.getAllowDependencies())?-13:l.isReadOnly()||o.isReadOnly()?-14:0},isValidDependencyType:function(e){if(this.allowedDependencyTypes){var t=!1,i=this.model;return Ext.each(this.allowedDependencyTypes,function(n){if(i.Type[n]==e)return t=!0,!1}),t}return!0},isValidDependency:function(e,t,i,n,r,a){return!this.getDependencyError(e,t,i,n,r,a)},areTasksLinkedForward:function(e,t,i,n){var r=e instanceof Gnt.model.Task?e:this.getTaskById(e),a=t instanceof Gnt.model.Task?t:this.getTaskById(t);if(!r||!a)return!1;var s=this.model.prototype,o=s.fromField,l=s.toField,d=r.getId()+"-"+a.getId()+"-"+(this.getKeyByDeps(i,o,l)||"")+"-"+(this.getKeyByDeps(n,o,l)||"");if(this.isCachedResultAvailable("areTasksLinkedForward",d))return this.methodsCache.areTasksLinkedForward[d];var c,h,u,g=r.successors,f=a.predecessors;for(h=0,u=g.length;h<u;h++)if(c=g[h],(!i||!Ext.Array.contains(i,c))&&Ext.Array.contains(f,c))return this.setCachedResult("areTasksLinkedForward",d,!0);if(n){var p,m;for(h=0,u=n.length;h<u;h++)if(c=n[h],p=c.getSourceId&&c.getSourceId()||c[o],m=c.getTargetId&&c.getTargetId()||c[l],p==r.getId()&&m==a.getId())return this.setCachedResult("areTasksLinkedForward",d,!0)}return this.setCachedResult("areTasksLinkedForward",d,!1)},areTasksLinked:function(e,t){var i=e instanceof Gnt.model.Task?e:this.getTaskById(e),n=t instanceof Gnt.model.Task?t:this.getTaskById(t);if(!i||!n)return!1;var r=i.getId()+"-"+n.getId();return this.isCachedResultAvailable("areTasksLinked",r)?this.methodsCache.areTasksLinked[r]:this.setCachedResult("areTasksLinked",r,this.areTasksLinkedForward(i,n)||this.areTasksLinkedForward(n,i))},getByTaskIds:function(e,t){var i=this.findBy(function(i){var n=i.getTargetId(),r=i.getSourceId();if(r===e&&n===t||r===t&&n===e)return!0});return this.getAt(i)},getTaskById:function(e){var t=this.getTaskStore();return t&&t.getModelById(e)||null},getSourceTask:function(e){var t=e instanceof Gnt.model.Dependency?e.getSourceId():e;return this.getTaskById(t)},getTargetTask:function(e){var t=e instanceof Gnt.model.Dependency?e.getTargetId():e;return this.getTaskById(t)},getTaskStore:function(){return this.taskStore},setTaskStore:function(e){this.taskStore=e}}),Ext.define("Gnt.data.linearizator.CycleResolvers",function(e){function t(){return!1}function i(){Ext.Error.raise("Can't linearize dependent tasks, there's a cycle in the dependency chain!")}function n(e,t){var i=r(e,t),n={},a=function(e,t){(n[e]||(n[e]={}))[t]=t};return o(i,function(e){e.prevSibling&&(l(e.prevSibling.foldedDeps,e.foldedDeps,a),e.foldedDeps=Ext.apply(e.foldedDeps,e.prevSibling.foldedDeps)),!e.nextSibling&&e.parentNode&&(l(e.parentNode.foldedDeps,e.foldedDeps,a),e.parentNode.foldedDepds=Ext.apply(e.parentNode.foldedDeps,e.foldedDeps))}),c(t.fromById,n),!0}function r(e,t){var i,n,r=[],o={};for(i in e)e.hasOwnProperty(i)&&(n=o[i]=a(e[i].task,e,t),e.hasOwnProperty(n.parentNode)||r.push(n));for(i in o)o.hasOwnProperty(i)&&(o[i]=s(o[i],o));return 1==r.length?r[0]:{parentNode:null,prevSibling:null,nextSibling:null,children:r,foldedDeps:{}}}function a(e,t,i){var n,r,a,s,o,l,d,c,h=i.fromById,u={},g=e.internalId;for(u[g]=Ext.clone(h[g]||{}),n=e.parentNode&&t.hasOwnProperty(e.parentNode.internalId)&&e.parentNode.internalId,s=e.childNodes||[],l=[],d=0,c=s.length;d<c;d++)o=s[d].internalId,t.hasOwnProperty(o)&&l.push(o);for(a=e.previousSibling;a&&!t.hasOwnProperty(a.internalId);)a=a.previousSibling;for(a=a&&a.internalId,r=e.nextSibling;r&&!t.hasOwnProperty(r.internalId);)r=r.nextSibling;return r=r&&r.internalId,{parentNode:n,prevSibling:a,nextSibling:r,children:l,foldedDeps:u}}function s(e,t){var i,n,r=e.children;for(i=0,n=r.length;i<n;i++)r[i]=t[r[i]];return e.parentNode=(e.parentNode||0===e.parentNode)&&t[e.parentNode]||null,e.prevSibling=(e.prevSibling||0===e.prevSibling)&&t[e.prevSibling]||null,e.nextSibling=(e.nextSibling||0===e.nextSibling)&&t[e.nextSibling]||null,e}function o(e,t){var i,n,r=e.children;for(i=0,n=r.length;i<n;i++)o(r[i],t);return t(e),e}function l(e,t,i){var n,r,a,s,o,l,c,h;n=Ext.Object.getKeys(e),a=Ext.Object.getKeys(t),r=Ext.Array.flatten(Ext.Array.map(n,function(t){return Ext.Object.getKeys(e[t])})),s=Ext.Array.flatten(Ext.Array.map(a,function(e){return Ext.Object.getKeys(t[e])})),o=Ext.Array.intersect(r,a),c=Ext.Array.intersect(s,n),o.length>0&&c.length>0&&(l=0,Ext.Array.forEach(o,function(e){for(var t=0,i=r.length;t<i;t++)r[t]==e&&++l}),h=0,Ext.Array.forEach(c,function(e){for(var t=0,i=s.length;t<i;t++)s[t]==e&&++h}),l<h?Ext.Array.forEach(o,function(t){d(e,t,i)}):Ext.Array.forEach(c,function(e){d(t,e,i)}))}function d(e,t,i){var n;for(n in e)e.hasOwnProperty(n)&&e[n].hasOwnProperty(t)&&i(n,t)}function c(e,t){var i,n,r;for(i in t)if(t.hasOwnProperty(i)){r=t[i];for(n in r)r.hasOwnProperty(n)&&(e[i][n][0]="green")}return e}return{singleton:!0,none:t,exception:i,cut:n}}),Ext.define("Gnt.data.Linearizator",function(e){function t(e,t,r){return Ext.isObject(e)||Ext.isArray(e)||Ext.Error.raise("Invalid arguments, source task list must be either a task or array of tasks!"),Ext.isFunction(t)||Ext.Error.raise("Invalid arguments, processor function must be a function!"),Ext.isObject(r)||Ext.Error.raise("Invalid arguments, walking specification must be an object!"),r=n(r),i([].concat(e),t,r.tasksDepsCollectingFn,r.cycleSolverFn)}function i(e,t,i,n){var r,a,o,l,d,c=!1,g=!0;for(r=h(),a=u(),s(e,i,r,a);g;){for(c=!1;!c;){c=!0,g=!1;for(o in r)r.hasOwnProperty(o)&&"green"!=r[o].color&&(l=r[o].task,d=v(l,a),"red"!=d?(S(d,l,r,a),t(l,d,r,a),c=!1):g=!0)}g&&(g=n&&n(r,a))}}function n(e){var t,i,n,s=r(e);return n=y[s],n||(t=Gnt.data.linearizator.CycleResolvers[e.cycles||"none"],t||Ext.Error.raise("Can't resolve cycle resolution function, "+e.cycles+" is unknown!"),i=[],e.self&&i.push(o),e.ancestors&&i.push(l),e.descendants&&i.push(d),e.successors&&i.push(c),i=a(i),n={tasksDepsCollectingFn:i,cycleSolverFn:t},y[s]=n),n}function r(e){var t,i=[];for(t in e)e.hasOwnProperty(t)&&i.push(t,"=",String(e[t]));return i.join(";")}function a(e){return function(t,i,n){var r=[];return Ext.Array.forEach(e,function(e){r=r.concat(e(t,i,n))}),r}}function s(e,t,i,n){Ext.Array.forEach(e,function(e){var r=t(e,i,n);r.length>0&&s(r,t,i,n)})}function o(e,t,i){var n=[],r=e.internalId;return t.hasOwnProperty(r)||(t[r]={task:e,color:"red"},n=[e]),n}function l(e,t,i){var n,r,a=[],s=i.downFromById,o=i.downToById,l=i.upFromById,d=i.upToById,c=e.internalId,h=e.parentNode,u=h&&h.internalId;return h&&!t.hasOwnProperty(u)&&(t[u]={task:h,color:"red"},a.push(h)),h&&(n=["red"],r=["red"],!s[u]&&(s[u]={}),!s[u][c]&&(s[u][c]=n),!o[c]&&(o[c]=n),!d[u]&&(d[u]={}),!d[u][c]&&(d[u][c]=r),!l[c]&&(l[c]=r)),a}function d(e,t,i){var n=[],r=i.downFromById,a=i.downToById,s=i.upFromById,o=i.upToById,l=!e.isRoot()&&e.childNodes,d=e.internalId;return l&&Ext.Array.forEach(l,function(e){var i,l,c=e.internalId;t.hasOwnProperty(c)||(t[c]={task:e,color:"red"},n.push(e)),i=["red"],l=["red"],!r[d]&&(r[d]={}),!r[d][c]&&(r[d][c]=i),!a[c]&&(a[c]=i),!o[d]&&(o[d]={}),!o[d][c]&&(o[d][c]=l),!s[c]&&(s[c]=l)}),n}function c(e,t,i){var n=[],r=i.fromById,a=i.toById,s=e.getSuccessors(),o=e.internalId;return Ext.Array.forEach(s,function(e){var i,s=e.internalId;t.hasOwnProperty(s)||(t[s]={task:e,color:"red"},n.push(e)),i=["red"],!r[o]&&(r[o]={}),!r[o][s]&&(r[o][s]=i),!a[s]&&(a[s]={}),!a[s][o]&&(a[s][o]=i)}),n}function h(){return{}}function u(){return{fromById:{},toById:{},downFromById:{},downToById:{},upFromById:{},upToById:{}}}function g(e,t){var i,n=t.toById[e.internalId],r=!1;for(i in n)if(n.hasOwnProperty(i)&&n[i]&&"red"==n[i][0]){r=!0;break}return r}function f(e,t){var i=t.downToById,n=e.internalId;return i[n]&&"red"==i[n][0]}function p(e,t){var i,n=t.downFromById[e.internalId],r=!1;for(i in n)if(n.hasOwnProperty(i)&&n[i]&&"red"==n[i][0]){r=!0;break}return r}function m(e,t){var i,n=t.upToById[e.internalId],r=!1;for(i in n)if(n.hasOwnProperty(i)&&n[i]&&"red"==n[i][0]){r=!0;break}return r}function v(e,t){return g(e,t)||f(e,t)||m(e,t)?g(e,t)||f(e,t)||!p(e,t)?"red":"yellow":"green"}function S(e,t,i,n){var r,a=t.internalId,s=n.fromById[a],o=n.downFromById[a],l=n.upFromById[a];if(i[a].color=e,"green"==e){if(s)for(r in s)s.hasOwnProperty(r)&&(s[r][0]=e);if(o)for(r in o)o.hasOwnProperty(r)&&(o[r][0]=e);l&&(l[0]=e)}else if("yellow"==e&&o)for(r in o)o.hasOwnProperty(r)&&(o[r][0]=e)}var y={};return{singleton:!0,linearWalkBySpecification:t}}),Ext.define("Gnt.model.Resource",{extend:Sch.model.Resource,customizableFields:["CalendarId"],calendarIdField:"CalendarId",normalized:!1,calendarWaitingListener:null,getTaskStore:function(){return this.store.getTaskStore()},getEventStore:function(){return this.getTaskStore()},getTasks:function(){return this.getEvents()},getCalendar:function(e){var t=this;return e?t.getOwnCalendar():t.getOwnCalendar()||t.getProjectCalendar()},getOwnCalendar:function(){var e=this.getCalendarId();return e?Gnt.data.Calendar.getCalendar(e):null},getProjectCalendar:function(){return this.getTaskStore().getCalendar()},setCalendar:function(e){var t=e instanceof Gnt.data.Calendar;if(t&&!e.calendarId)throw new Error("Can't set calendar w/o `calendarId` property");this.setCalendarId(t?e.calendarId:e)},setCalendarId:function(e,t){e instanceof Gnt.data.Calendar&&(e=e.calendarId);var i=this.getCalendarId();if(i!=e||t){this.calendarWaitingListener&&(this.calendarWaitingListener.destroy(),this.calendarWaitingListener=null);var n={calendarchange:this.onCalendarChange,scope:this},r=this.calendar||Gnt.data.Calendar.getCalendar(i);this.calendar=null,r&&r.un(n),this.set(this.calendarIdField,e);var a=Gnt.data.Calendar.getCalendar(e);a?(a.on(n),t||this.onCalendarChange()):this.calendarWaitingListener=Ext.data.StoreManager.on("add",function(t,i,r){(a=Gnt.data.Calendar.getCalendar(e))&&(this.calendarWaitingListener.destroy(),this.calendarWaitingListener=null,a.on(n),this.onCalendarChange())},this,{destroyable:!0})}},onCalendarChange:function(){this.inOnCalendarChange=!0,this.adjustToCalendar(),this.inOnCalendarChange=!1},adjustToCalendar:function(){this.getTaskStore()&&this.forEachTask(function(e){e.adjustToCalendar()})},assignTo:function(e,t,i){return(e instanceof Gnt.model.Task?e:this.getTaskStore().getModelById(e)).assign(this,t,i)},unAssignFrom:function(e,t){return(e instanceof Gnt.model.Task?e:this.getTaskStore().getModelById(e)).unAssign(this,t)},unassignFrom:function(){return this.unAssignFrom.apply(this,arguments)},forEachAssignment:function(e,t){var i,n,r,a=this,s=a.getTaskStore(),o=s&&s.getAssignmentStore(),l=o&&o.getAssignmentsForResource(a)||[];for(t=t||this,r=!1,i=0,n=l.length;!r&&i<n;++i)r=!1===e.call(t,l[i])},forEachTask:function(e,t){var i,n,r,a,s=this,o=s.getTaskStore(),l=o&&o.getAssignmentStore(),d=l&&l.getAssignmentsForResource(s)||[];for(t=t||this,r=!1,i=0,n=d.length;!r&&i<n;++i)(a=d[i].getTask())&&(r=!1===e.call(t,a))},collectAvailabilityIntervalPoints:function(e,t,i,n,r){for(var a=0,s=e.length;a<s;a++){var o=e[a],l=o.startDate-0,d=o.endDate-0;n[l]||(n[l]=[],r.push(l)),n[l].push(t),n[d]||(n[d]=[],r.push(d)),n[d].push(i)}},forEachAvailabilityIntervalWithTasks:function(e,t,i){i=i||this;var n=e.startDate,r=e.endDate,a=e.task;if(!n||!r)throw"Both `startDate` and `endDate` are required for `forEachAvailabilityIntervalWithTasks`";var s=new Date(n),o=e.includeAllIntervals,l=e.includeResCalIntervals,d=this.getCalendar(),c=[],h=[],u=[],g=[n-0,r-0],f={};if(f[n-0]=[{type:"00-intervalStart"}],f[r-0]=[{type:"00-intervalEnd"}],this.forEachAssignment(function(e){var t=e.getTask();if(t&&(!a||t===a)){var i=t.getStartDate(),s=t.getEndDate(),o=t.getId();if(!(i>r||s<n)){if(h.push(t),u.push(t.getOwnCalendar()||this.getCalendar()),t.isSegmented())for(var l=t.getSegments(),d=0,p=l.length;d<p;d++){var m=l[d];this.collectAvailabilityIntervalPoints([{startDate:m.getStartDate(),endDate:m.getEndDate()}],{type:"05-taskStart",assignment:e,taskId:o,units:e.getUnits()},{type:"04-taskEnd",taskId:o},f,g)}else this.collectAvailabilityIntervalPoints([{startDate:i,endDate:s}],{type:"05-taskStart",assignment:e,taskId:o,units:e.getUnits()},{type:"04-taskEnd",taskId:o},f,g);c.push(e)}}}),h.length||o||l){for(var p,m,v,S=Sch.util.Date;s<r;){for(this.collectAvailabilityIntervalPoints(d.getAvailabilityIntervalsFor(s),{type:"00-resourceAvailabilityStart"},{type:"01-resourceAvailabilityEnd"},f,g),p=0,m=u.length;p<m;p++)v=h[p].getId(),this.collectAvailabilityIntervalPoints(u[p].getAvailabilityIntervalsFor(s),{type:"02-taskAvailabilityStart",taskId:v},{type:"03-taskAvailabilityEnd",taskId:v},f,g);s=S.getStartOfNextDay(s)}g.sort(function(e,t){return e-t});var y=!1,E=!1,x={},D=0,T=0,C={};for(p=0,m=g.length-1;p<m;p++){var k=f[g[p]];k.sort(function(e,t){return e.type<t.type?1:-1});for(var w=0,b=k.length;w<b;w++){var F=k[w];switch(F.type){case"00-resourceAvailabilityStart":E=!0;break;case"01-resourceAvailabilityEnd":E=!1;break;case"02-taskAvailabilityStart":D++,C[F.taskId]=!0;break;case"03-taskAvailabilityEnd":D--,delete C[F.taskId];break;case"05-taskStart":x[F.taskId]=F,T++;break;case"04-taskEnd":delete x[F.taskId],T--;break;case"00-intervalStart":y=!0;break;case"00-intervalEnd":return}}if(y&&(o||l&&E||E&&D&&T)){var R={inResourceCalendar:!!E,inTasksCalendar:!!D,inTask:T,inTaskCalendarHash:Ext.apply({},C)},A=g[p],I=g[p+1];if(A>r||I<n)continue;if(A<n&&(A=n-0),I>r&&(I=r-0),!1===t.call(i,A,I,x,R))return!1}}}},getAllocationInfo:function(e){var t=[];return this.forEachAvailabilityIntervalWithTasks(e,function(e,i,n,r){var a=0,s=[],o={},l=0,d=[],c={},h=i-e,u=0;if(r.inResourceCalendar&&r.inTasksCalendar&&r.inTask)for(var g in n)r.inTaskCalendarHash[g]&&(u+=h*n[g].units*.01,a+=n[g].units,o[g]=n[g].assignment,s.push(n[g].assignment)),l+=n[g].units,c[g]=n[g].assignment,d.push(n[g].assignment);t.push(Ext.apply({startDate:new Date(e),endDate:new Date(i),effectiveTotalAllocation:a,effectiveAssignmentsHash:o,effectiveAssignments:s,totalAllocationMS:u,totalAllocation:l,assignments:d,assignmentsHash:c},r))}),t},getUtilizationInfo:function(e,t){var i=this,n=0,r=!1,a=!1,s={},o={},l=i.getAllocationInfo({startDate:e,endDate:t});return Ext.Array.forEach(l,function(e){n+=e.totalAllocationMS,e.effectiveTotalAllocation>100?(r=!0,a=!1):!r&&e.effectiveTotalAllocation<100&&(a=!0),Ext.Array.forEach(e.effectiveAssignments,function(t){var i,n=t.getId(),r=t.getTask().getId(),a=t.getUnits(),l=Math.floor((e.endDate-e.startDate)*a/100),d=a>100,c=a<100;s.hasOwnProperty(n)?(i=s[n],i.allocationMs+=l,i.allocationDeltaMs+=0,i.isOverallocated=i.isOverallocated||d,i.isUnderallocated=i.isUnderallocated||c):(i={isUtilized:!0,allocationMs:l,allocationDeltaMs:0,isOverallocated:d,isUnderallocated:c},s[n]=i,o[r]=i)})}),{isUtilized:l.length>0,allocationMs:n,allocationDeltaMs:0,isOverallocated:r,isUnderallocated:a,assignmentInfo:s,taskInfo:o}}}),Ext.define("Gnt.data.ResourceStore",{extend:Sch.data.ResourceStore,storeId:"resources",model:"Gnt.model.Resource",
alias:"store.gantt_resourcestore",taskStore:null,proxy:"memory",constructor:function(e){this.callParent([e]),this.on({load:this.normalizeResources,remove:this.onResourceRemoved,priority:100})},normalizeResources:function(){this.each(function(e){if(!e.normalized){var t=e.getCalendarId();t&&e.setCalendarId(t,!0),e.normalized=!0}})},onResourceRemoved:function(e,t){var i=this.getAssignmentStore();Ext.Array.each(t,function(e){i.removeAssignmentsForResource(e)})},getTaskStore:function(){return this.taskStore},setTaskStore:function(e){this.taskStore=e},getAssignmentStore:function(){var e=this.getTaskStore();return e&&e.getAssignmentStore()||null},getDependencyStore:function(){var e=this.getTaskStore();return e&&e.getDependencyStore()||null}}),Ext.define("Gnt.model.utilization.UtilizationNegotiationStrategyMixin",{utilizationNegotiationStrategy:null,initUtilizationNegotiationStrategyMixin:function(e){var t=this;return e&&e.hasOwnProperty("utilizationNegotiationStrategy")?(t.utilizationNegotiationStrategy=e.utilizationNegotiationStrategy,delete e.utilizationNegotiationStrategy):t.utilizationNegotiationStrategy=new Gnt.model.utilization.DefaultUtilizationNegotiationStrategy,e},getUtilizationNegotiationStrategy:function(){return this.utilizationNegotiationStrategy},setUtilizationNegotiationStrategy:function(e){var t=this;t.utilizationNegotiationStrategy!==e&&e&&(t.utilizationNegotiationStrategy=e)}}),Ext.define("Gnt.model.UtilizationEvent",{extend:Sch.model.Event,mixins:[Gnt.model.utilization.UtilizationNegotiationStrategyMixin],originalResource:null,originalAssignment:null,customizableFields:[{name:"utilizationInfo",type:"auto",persist:!1,defaultValue:null}],utilizationInfoField:"utilizationInfo",constructor:function(e){var t,i,n=this;e=n.initUtilizationNegotiationStrategyMixin(e),e.originalResource&&(t=e.originalResource,delete e.originalResource),e.originalAssignment&&(i=e.originalAssignment,delete e.originalAssignment),n.callParent(arguments),t&&n.setOriginalResource(t),i&&n.setOriginalAssignment(i)},isSurrogateAssignment:function(){return!!this.originalAssignment},isSurrogateSummary:function(){return!!this.originalResource},getOriginalAssignment:function(){return this.originalAssignment},setOriginalAssignment:function(e){var t=this;t.originalAssignment!==e&&(t.originalAssignment=e,t.isInSyncWithOriginal()||t.syncFromOriginal())},getOriginalResource:function(){var e=this,t=e.originalResource,i=e.originalAssignment;return t||i&&i.getResource()||null},setOriginalResource:function(e){var t=this;t.originalResource!==e&&(t.originalResource=e,t.isInSyncWithOriginal()||t.syncFromOriginal())},getOriginalTask:function(){var e=this,t=e.originalAssignment;return t&&t.getTask()||null},isInSyncWithOriginal:function(){var e,t,i,n,r,a=this,s=!0;return a.isSurrogateAssignment()?(e=a.getOriginalAssignment(),i=a.getOriginalTask(),e&&(s=s&&a.getId()==a.self.getSurrogateIdFor(e)),i&&(s=s&&a.getStartDate()-a.adjustStartDateToTick(i.getStartDate())==0,s=s&&a.getEndDate()-a.adjustEndDateToTick(i.getEndDate())==0)):a.isSurrogateSummary()?(t=a.getOriginalResource(),n=a.calculateSurrogateSummaryTimeSpan(),s=s&&a.getId()==a.self.getSurrogateIdFor(t),s=s&&a.getStartDate()-n.startDate==0,s=s&&a.getEndDate()-n.endDate==0):Ext.Error.raise("Unknown surrogate type"),s&&(r=a.getUtilizationNegotiationStrategy().getUtilizationInfoForUtilizationEvent(a),s=Ext.Object.equals(a.getUtilizationInfo(),r)),s},syncFromOriginal:function(){var e,t,i,n,r,a=this;a.beginEdit(),a.isSurrogateAssignment()?(e=a.getOriginalAssignment(),i=a.getOriginalTask(),e&&a.setId(a.self.getSurrogateIdFor(e)),i&&a.setStartEndDate(a.adjustStartDateToTick(i.getStartDate()),a.adjustEndDateToTick(i.getEndDate()))):a.isSurrogateSummary()&&(t=a.getOriginalResource(),t&&a.setId(a.self.getSurrogateIdFor(t)),n=a.calculateSurrogateSummaryTimeSpan(),a.setStartEndDate(n.startDate,n.endDate)),r=a.getUtilizationNegotiationStrategy().getUtilizationInfoForUtilizationEvent(a),Ext.Object.equals(a.getUtilizationInfo(),r)||a.setUtilizationInfo(r),a.endEdit()},getUtilizationInfo:function(){var e=this,t=e.get(e.utilizationInfoField);return t||(t=e.getUtilizationNegotiationStrategy().getUtilizationInfoForUtilizationEvent(e),e.set(e.utilizationInfoField,t)),t},syncToOriginal:function(){var e,t=this;t.isSurrogateAssignment()&&(e=t.getOriginalTask())&&e.setStartEndDate(t.getStartDate(),t.getEndDate(),!0)},isInSyncWithSurrogate:function(e){var t=this;return t.getOriginalResource()===e.getOriginalResource()&&t.getOriginalAssignment()===e.getOriginalAssignment()&&t.getId()===e.getId()&&t.getStartDate()-e.getStartDate()==0&&t.getEndDate()-e.getEndDate()==0&&Ext.Object.equals(t.getUtilizationInfo(),e.getUtilizationInfo())},syncFromSurrogate:function(e){var t=this;t.originalResource=e.originalResource,t.originalAssignment=e.originalAssignment,t.beginEdit(),t.setId(e.getId()),t.setStartEndDate(e.getStartDate(),e.getEndDate()),Ext.Object.equals(t.getUtilizationInfo(),e.getUtilizationInfo())||t.setUtilizationInfo(e.getUtilizationInfo()),t.endEdit()},getUtilizationInfoForInterval:function(e){var t=this;return t.getUtilizationNegotiationStrategy().getUtilizationInfoForAssignmentEventInterval(t,e)},forEachInterval:function(e){var t=this;return t.getUtilizationNegotiationStrategy().forEachTimeSpanInterval(t,e)},calculateSurrogateSummaryTimeSpan:function(){var e=this;return e.getUtilizationNegotiationStrategy().calculateResourceAssignmentsTimespan(e.getOriginalResource())},adjustStartDateToTick:function(e){return this.getUtilizationNegotiationStrategy().adjustStartDateToTick(e)},adjustEndDateToTick:function(e){return this.getUtilizationNegotiationStrategy().adjustEndDateToTick(e)},statics:{getSurrogateIdFor:function(e){var t=e.getId();return e instanceof Gnt.model.Resource?t="resource-"+t:e instanceof Gnt.model.Assignment?t="assignment-"+t:Ext.Error.raise("Wrong original record type"),t}}}),Ext.define("Gnt.data.ResourceUtilizationEventStore",{extend:Sch.data.EventStore,model:"Gnt.model.UtilizationEvent",getModelByOriginal:function(e){var t=this;return t.getModelById(t.model.getSurrogateIdFor(e))}}),Ext.define("Gnt.model.UtilizationResource",{extend:Sch.model.Resource,customizableFields:[{name:"TaskName"},{name:"TaskSequenceNumber"}],taskNameField:"TaskName",taskSequenceNumberField:"TaskSequenceNumber",originalResource:null,originalAssignment:null,constructor:function(e){var t,i,n=this;e.originalResource&&(t=e.originalResource,delete e.originalResource),e.originalAssignment&&(i=e.originalAssignment,delete e.originalAssignment),n.callParent(arguments),t&&n.setOriginalResource(t),i&&n.setOriginalAssignment(i)},getOriginalResource:function(){return this.originalResource||this.originalAssignment&&this.originalAssignment.getResource()},setOriginalResource:function(e){var t=this;t.originalResource!==e&&(t.originalResource=e,t.isInSyncWithOriginal()||t.syncFromOriginal())},getOriginalAssignment:function(){return this.originalAssignment},setOriginalAssignment:function(e){var t=this;t.originalAssignment!==e&&(t.originalAssignment=e,t.isInSyncWithOriginal()||t.syncFromOriginal())},getOriginalTask:function(){var e=this.getOriginalAssignment();return e&&e.getTask()||null},isSurrogateResource:function(){return!this.getOriginalAssignment()},isSurrogateAssignment:function(){return!!this.getOriginalAssignment()},isInSyncWithOriginal:function(){var e=this,t=e.getOriginalResource(),i=e.getOriginalAssignment(),n=e.getOriginalTask(),r=!0;return i?(r=r&&e.getId()==e.self.getSurrogateIdFor(i),n&&(r=r&&e.getTaskName()==n.getName(),r=r&&e.getTaskSequenceNumber()==n.getSequenceNumber())):t&&(r=r&&e.getId()==e.self.getSurrogateIdFor(t),r=r&&e.getName()==t.getName()),r},syncFromOriginal:function(){var e=this,t=e.getOriginalResource(),i=e.getOriginalAssignment(),n=e.getOriginalTask();e.beginEdit(),t&&!i&&e.setId(e.self.getSurrogateIdFor(t)),i&&!t&&e.setId(e.self.getSurrogateIdFor(i)),t&&e.setName(t.getName()),n&&(e.setTaskName(n.getName()),e.setTaskSequenceNumber(n.getSequenceNumber())),e.endEdit()},syncToOriginal:function(){Ext.Error.raise("Not implmented")},isInSyncWithSurrogate:function(e){var t=this;return t.originalResource===e.originalResource&&t.originalAssignment===e.originalAssignment&&t.getName()===e.getName()&&t.getTaskName()===e.getTaskName()&&t.getTaskSequenceNumber()===e.getTaskSequenceNumber()},syncFromSurrogate:function(e){var t=this;t.originalResource=e.originalResource,t.originalAssignment=e.originalAssignment,t.beginEdit(),t.setId(e.getId()),t.setName(e.getName()),t.setTaskName(e.getTaskName()),t.setTaskSequenceNumber(e.getTaskSequenceNumber()),t.endEdit()},statics:{getSurrogateIdFor:function(e){var t=e.getId();return e instanceof Gnt.model.Resource?t="resource-"+t:e instanceof Gnt.model.Assignment?t="assignment-"+t:Ext.Error.raise("Wrong original record type"),t}},getResourceStore:function(){return this.store}},function(){Ext.data.NodeInterface.decorate(this)}),Ext.define("Gnt.data.ResourceUtilizationStore",{extend:Sch.data.ResourceTreeStore,mixins:[Gnt.model.utilization.UtilizationNegotiationStrategyMixin],model:"Gnt.model.UtilizationResource",eventModel:"Gnt.model.UtilizationEvent",proxy:"memory",root:{expanded:!0},config:{defaultResourceExpandedState:!1,taskStore:null,resourceStore:null,assignmentStore:null,timeAxis:null},folderSort:!1,taskStoreDetacher:null,resourceStoreDetacher:null,assignmentStoreDetacher:null,eventStoreDetacher:null,timeAxisDetacher:null,utilizationInfoCache:null,constructor:function(e){var t=this;t.eventModel=Ext.ClassManager.get(this.eventModel),t.utilizationInfoCache={},t.callParent([e]),t.setUtilizationNegotiationStrategy(new Gnt.model.utilization.ResourceStoreUtilizationNegotiationStrategy({resourceUtilizationStore:t})),t.getEventStore()||t.setEventStore(new Gnt.data.ResourceUtilizationEventStore({model:t.eventModel,resourceStore:t})),t.setupSorters(),t.fillStore()},destroyStore:function(){var e=this;e.callParent(arguments),Ext.destroy(e.getEventStore()),e.setEventStore(null)},setupSorters:function(){var e=this;e.setSorters([{sorterFn:function(t,i){return t.isSurrogateResource()&&i.isSurrogateResource()&&t.getName()>i.getName()?1:t.isSurrogateResource()&&i.isSurrogateResource()&&t.getName()<i.getName()?-1:t.isSurrogateResource()&&i.isSurrogateResource()?0:t.isSurrogateResource()&&i.isSurrogateAssignment()?1:t.isSurrogateAssignment()&&i.isSurrogateResource()?-1:t.isSurrogateAssignment()&&i.isSurrogateAssignment()?e.getUtilizationNegotiationStrategy().assignmentsComparator(t.getOriginalAssignment(),i.getOriginalAssignment()):0}}])},updateTaskStore:function(e,t){var i=this;t&&Ext.destroy(i.taskStoreDetacher),e&&(i.setResourceStore(e.getResourceStore()||i.setResourceStore()),i.setAssignmentStore(e.getAssignmentStore()||i.getAssignmentStore()),i.taskStoreDetacher=i.mon(e,{load:i.onSourceDataTouch,refresh:i.onSourceDataTouch,clear:i.onSourceDataTouch,add:i.onSourceDataTouch,append:i.onSourceDataTouch,update:i.onSourceDataTouch,remove:i.onSourceDataTouch,bulkremove:i.onSourceDataTouch,move:i.onSourceDataTouch,scope:i,destroyable:!0}))},updateResourceStore:function(e,t){var i=this;t&&Ext.destroy(i.resourceStoreDetacher),e&&(i.resourceStoreDetacher=i.mon(e,{load:i.onSourceDataTouch,refresh:i.onSourceDataTouch,clear:i.onSourceDataTouch,add:i.onSourceDataTouch,update:i.onSourceDataTouch,remove:i.onSourceDataTouch,bulkremove:i.onSourceDataTouch,scope:i,destroyable:!0}))},updateAssignmentStore:function(e,t){var i=this;t&&Ext.destroy(i.assignmentStoreDetacher),e&&(i.assignmentStoreDetacher=i.mon(e,{load:i.onSourceDataTouch,refresh:i.onSourceDataTouch,clear:i.onSourceDataTouch,add:i.onSourceDataTouch,update:i.onSourceDataTouch,remove:i.onSourceDataTouch,bulkremove:i.onSourceDataTouch,scope:i,destroyable:!0}))},setEventStore:function(e){var t=this,i=t.eventStore;t.callParent([e]),i!=e&&(i&&Ext.destroy(t.eventStoreDetacher),e&&(t.utilizationEventStoreDetacher=t.mon(e,{update:t.onUtilizationEventStoreUpdate,scope:t})))},updateTimeAxis:function(e,t){var i=this;t&&Ext.destroy(i.timeAxisDetacher),e&&(i.timeAxisDetacher=i.mon(e,{reconfigure:i.onSourceDataTouch,scope:i,destroyable:!0}))},makeSurrogateResource:function(e){var t=this,i=t.model;return new t.model({Id:i.getSurrogateIdFor(e),originalResource:e,expanded:t.getDefaultResourceExpandedState()})},makeSurrogateAssignment:function(e){var t=this.model;return new t({Id:t.getSurrogateIdFor(e),originalAssignment:e,leaf:!0})},makeSurrogateAssignmentEvent:function(e){var t=this,i=t.eventModel,n=i.getSurrogateIdFor(e);return new i({Id:n,ResourceId:n,originalResource:e instanceof Gnt.model.Resource&&e||null,originalAssignment:e instanceof Gnt.model.Assignment&&e||null,utilizationNegotiationStrategy:t.getUtilizationNegotiationStrategy()})},makeSurrogateResourceBranch:function(e){var t,i=this,n=i.makeSurrogateResource(e),r=[];return e.forEachAssignment(function(e){n.appendChild(i.makeSurrogateAssignment(e)),r.push(i.makeSurrogateAssignmentEvent(e))}),r.length>0&&(t=i.makeSurrogateAssignmentEvent(e),r.push(t)),{resource:n,events:r,summary:t}},fillStore:function(){var e=this,t=e.getRoot(),i=e.getResourceStore(),n=e.getEventStore(),r=i&&i.getRange();t.removeAll(),n.removeAll(),r&&Ext.Array.forEach(r,function(i){var r=e.makeSurrogateResourceBranch(i);t.appendChild(r.resource),n.add(r.events)}),e.sorters&&e.sorters.getCount()&&t.sort()},diffSyncStore:function(){var e,t=this;t.fireEvent("sync-start",t),t.suspendEvents(),e=new t.self,e.suspendEvents(),e.setTimeAxis(t.getTimeAxis()),e.setTaskStore(t.getTaskStore()),e.fillStore(),t.removeOutdatedSurrogateAssignments(t,e),t.removeOutdatedSurrogateResources(t,e),t.addNewSurrogateResources(t,e),t.addNewSurrogateAssignments(t,e),t.updatePresentSurrogates(t,e),t.rearrangePresentSurrogates(t,e),t.utilizationInfoCache=e.utilizationInfoCache,Ext.destroy(e),t.resumeEvents(),t.fireEvent("sync-complete",t),t.fireEvent("refresh",t)},removeOutdatedSurrogateAssignments:function(e,t){var i=e.getRoot(),n=[],r=[];i.cascadeBy(function(e){var i;!e.isRoot()&&e.isSurrogateAssignment()?(i=t.getModelById(e.getId()))&&i.parentNode.getId()==e.parentNode.getId()||(n.push(e),r=r.concat(e.getEvents())):!e.isRoot()&&e.isSurrogateResource()&&(r=r.concat(Ext.Array.filter(e.getEvents(),function(e){return e.isSurrogateAssignment()})))}),e.getEventStore().remove(r),Ext.Array.forEach(n,function(e){e.remove()})},removeOutdatedSurrogateResources:function(e,t){var i=e.getRoot(),n=[],r=[];i.cascadeBy(function(e){!e.isRoot()&&e.isSurrogateResource()&&(t.getModelById(e.getId())||(n.push(e),r=r.concat(e.getEvents())))}),e.getEventStore().remove(r),Ext.Array.forEach(n,function(e){e.remove()})},addNewSurrogateResources:function(e,t){var i=t.getRoot(),n=e.getRoot(),r=e.getEventStore();i.cascadeBy(function(t){!t.isRoot()&&t.isSurrogateResource()&&(e.getModelById(t.getId())||(n.insertChild(t.get("index"),e.makeSurrogateResource(t.getOriginalResource())),r.add(e.makeSurrogateAssignmentEvent(t.getOriginalResource()))))})},addNewSurrogateAssignments:function(e,t){var i=t.getRoot(),n=e.getEventStore();i.cascadeBy(function(t){var i,r;!t.isRoot()&&t.isSurrogateAssignment()&&(e.getModelById(t.getId())||(i=t.parentNode,(r=e.getModelById(i.getId()))&&(r.insertChild(t.get("index"),e.makeSurrogateAssignment(t.getOriginalAssignment())),n.add(t.getEvents()))))})},updatePresentSurrogates:function(e,t){e.getRoot().cascadeBy(function(i){var n,r,a;i.isRoot()||(n=t.getModelById(i.getId()))&&(i.isInSyncWithSurrogate(n)||i.syncFromSurrogate(n),(r=n.getEvents()[0])&&(a=e.getEventStore().getModelById(r.getId()))&&!a.isInSyncWithSurrogate(r)&&a.syncFromSurrogate(r))})},rearrangePresentSurrogates:function(e,t){t.getRoot().cascadeBy(function(t){var i;t.isRoot()||(i=e.getModelById(t.getId()))&&i.get("index")!=t.get("index")&&i.parentNode.insertChild(t.get("index"),i)})},clearUtilizationInfoCache:function(){this.utilizationInfoCache={}},getModelByOriginal:function(e){var t=this;return t.getModelById(t.model.getSurrogateIdFor(e))},onSourceDataTouch:Ext.Function.createBuffered(function(){var e=this;e.isDestroyed||(e.clearUtilizationInfoCache(),e.diffSyncStore())},10),onUtilizationEventStoreUpdate:function(e,t,i,n){var r,a=this;t.isInSyncWithOriginal()||t.syncToOriginal(),Ext.Array.contains(n,t.resourceIdField)&&(r=t.getResource(),a.getResourceStore(),Ext.Function.defer(function(){a.fireEvent("reassign",a,r.getOriginalResource(),r.getOriginalTask(),t.getOriginalResource(),t.getOriginalTask(),t.getOriginalAssignment())},1))}}),Ext.define("Gnt.data.util.IdConsistencyManager",{extend:Sch.data.util.IdConsistencyManager,config:{dependencyStore:null},onEventIdChanged:function(e,t,i,n){var r,a=this,s=a.getDependencyStore();a.callParent([e,t,i,n]),s&&(r=a.getUpdateDependencyFromToFieldsFn(s,i,n),e.on("update",r,null,{single:!0,priority:200}))},getUpdateDependencyFromToFieldsFn:function(e,t,i){var n=e.getRange();return function(){Ext.Array.forEach(n,function(e){e.getFrom()==t?e.setFrom(i):e.getTo()==t&&e.setTo(i)})}}}),Ext.define("Gnt.data.util.ModelPersistencyManager",{extend:Sch.data.util.ModelPersistencyManager,config:{dependencyStore:null},dependencyStoreDetacher:null,updateDependencyStore:function(e,t){var i=this;Ext.destroyMembers(i,"dependencyStoreDetacher"),e&&e.autoSync&&(i.dependencyStoreDetacher=e.on({beforesync:i.onDependencyStoreBeforeSync,scope:i,destroyable:!0,priority:100}))},onDependencyStoreBeforeSync:function(e){var t=this;return t.removeNonPersistableRecordsToCreate(e),t.shallContinueSync(e)}}),Ext.define("Gnt.model.mixin.ProjectableModel",function(){function e(){Ext.override(this,n)}function t(e){return this.data[e]}function i(){var e=this,t=e.getTreeStore&&e.getTreeStore()||e.store,i=t&&t.getProjection&&t.getProjection();return!(!i||!i.hasOwnProperty(e.internalId))}var n={};return n.get=function(e){var t,i,n=this,r=n.getTreeStore&&n.getTreeStore()||n.store,a=r&&r.getProjection&&r.getProjection(),s=n.internalId;return a&&a.hasOwnProperty(s)?(t=a[s],i=e in t?t[e]:n.callParent([e])):i=n.callParent([e]),i},n.set=function(e,t){var i,n,r,a,s,o,l=this,d=l.getTreeStore&&l.getTreeStore()||l.store,c=d&&d.getProjection&&d.getProjection(),h=l.internalId;if(c)if(r=[],1==arguments.length)for(n in e)e.hasOwnProperty(n)&&(t=e[n],a=l.get(n),o=void 0!==t&&null!==t?t.valueOf():t,s=void 0!==a&&null!==a?a.valueOf():a,(void 0!==o&&null!==o||o===s)&&o==s||(i=c[h]=c.hasOwnProperty(h)&&c[h]||{},i[n]=t,r.push(n)));else arguments.length>1&&(a=l.get(e),o=void 0!==t&&null!==t?t.valueOf():t,s=void 0!==a&&null!==a?a.valueOf():a,(void 0!==o&&null!==o||o===s)&&o==s||(i=c[h]=c.hasOwnProperty(h)&&c[h]||{},i[e]=t,r.push(e)));else r=l.callParent(arguments);return r},{initProjectable:e,getUnprojected:t,isProjected:i}}),Ext.define("Gnt.model.task.More",{propagating:!1,indent:function(e){var t,i=this,n=i.previousSibling;n?i.propagateChanges(function(){return i.indentWithoutPropagation(function(e){t=e})},function(i,r){i?t&&t():n.expand(),e&&e(i,r)}):e&&e(!1,{})},indentWithoutPropagation:function(e){var t,i,n,r,a,s,o=this,l=o.previousSibling;return s={parentNode:o.parentNode,previousSibling:o.previousSibling,nextSibling:o.nextSibling},t=o.getTaskStore(),t.beginIndent(o),i=o.parentNode,n=i.indexOf(o),r=l.get("leaf"),r&&(a=l.getSegments(),l.markAsParent()),l.appendChild(o),o.removeContext=s,t.endIndent(o),e&&e(function(){i.insertChild(n,o),r&&l.set("leaf",!0),r&&a&&l.setSegmentsWithoutPropagation(a)}),o},outdent:function(e){var t,i=this,n=i.parentNode;n&&!n.isRoot()?i.propagateChanges(function(){return i.outdentWithoutPropagation(function(e){t=e})},function(i,n){i&&t&&t(),e&&e(i,n)}):e&&e(!1,{})},outdentWithoutPropagation:function(e){var t,i,n,r,a=this;return r={parentNode:a.parentNode,previousSibling:a.previousSibling,nextSibling:a.nextSibling},n=a.getTaskStore(),n.beginIndent(a),t=a.parentNode,i=t.indexOf(a),t.nextSibling?t.parentNode.insertBefore(a,t.nextSibling):t.parentNode.appendChild(a),a.convertEmptyParentToLeaf&&t.set("leaf",0===t.childNodes.length),a.removeContext=r,n.endIndent(a),e&&e(function(){t.insertChild(i,a)}),t},removeInvalidDependencies:function(){for(var e=this.getDependencyStore(),t=this.getAllDependencies(),i=0;i<t.length;i++)t[i].isValid()||e.remove(t[i])},removeDependenciesToParents:function(e){var t=this.getSuccessors().concat(this.getPredecessors()),i=this;e.bubble(function(e){Ext.Array.indexOf(t,e)>=0&&i.removeLinkToTask(e)})},hasDependencies:function(){return this.hasIncomingDependencies()||this.hasOutgoingDependencies()},getAllDependencies:function(){return this.predecessors.concat(this.successors)},hasIncomingDependencies:function(){return this.predecessors.length>0},hasOutgoingDependencies:function(){return this.successors.length>0},getIncomingDependencies:function(e){return e?this.predecessors:this.predecessors.slice()},getOutgoingDependencies:function(e){return e?this.successors:this.successors.slice()},alignByIncomingDependencies:function(e,t,i){var n=this.alignByIncomingDependenciesWithoutPropagation(e,t);return this.propagateChanges(null,i,!0),n},alignByIncomingDependenciesWithoutPropagation:function(e,t,i){if(this.isManuallyScheduled())return!1;var n=!1;e=e||this.getTaskStore();var r=this.getIncomingDependenciesConstraintContext(e,i);if(r){var a=r.startDate,s=r.endDate;if(a&&s){var o=this.calculateStartDate(s,this.getDuration(),this.getDurationUnit());o>a&&(a=o),s=null}a&&a-this.getStartDate()!=0?(t&&t.addAffected(this),this.setStartDateWithoutPropagation(a,!0,e.skipWeekendsDuringDragDrop),n=!0):s&&s-this.getEndDate()!=0&&(t&&t.addAffected(this),this.setEndDateWithoutPropagation(s,!0,e.skipWeekendsDuringDragDrop),n=!0)}return n},getIncomingDependenciesConstraintContext:function(e,t){var i=this.getIncomingDependencies(!0);if(!i.length||this.isUnscheduled())return null;var n,r=Gnt.model.Dependency.Type,a=new Date(0),s=new Date(0),o=this.getProjectCalendar(),l=this.getCalendar(),d=(e||this.getTaskStore()).dependenciesCalendar;return Ext.Array.forEach(i,function(i){var c=i.getSourceTask(e);if(c&&(!t||c.isAncestor(t))){var h;if("pms"==d)h=o;else if("source"==d)h=c.getCalendar();else{if("target"!=d)throw"Unsupported value for `dependenciesCalendar` config option";h=l}var u=i.getLag()||0,g=i.getLagUnit(),f=c.getStartDate(),p=c.getEndDate();switch(i.getType()){case r.StartToEnd:f=h.skipWorkingTime(f,u,g),s<f&&(s=f,n=c);break;case r.StartToStart:f=h.skipWorkingTime(f,u,g),a<f&&(a=f,n=c);break;case r.EndToStart:p=h.skipWorkingTime(p,u,g),a<p&&(a=p,n=c);break;case r.EndToEnd:p=h.skipWorkingTime(p,u,g),s<p&&(s=p,n=c);break;default:throw"Invalid dependency type: "+i.getType()}}}),{startDate:a>0?a:null,endDate:s>0?s:null,constrainingTask:n}},getCriticalPaths:function(){for(var e=[this],t=this.getIncomingDependenciesConstraintContext();t;)e.push(t.constrainingTask),t=t.constrainingTask.getIncomingDependenciesConstraintContext();return e},addSubtask:function(e,t){var i,n,r=this;return r.propagateChanges(function(){return r.addSubtaskWithoutPropagation(e,function(e,t){n=e,i=t})},function(e,i){e&&n&&n(),t&&t(e,i)}),i},addSubtaskWithoutPropagation:function(e,t){var i,n,r,a,s,o=this;return i=e.parentNode,n=i&&i.indexOf(o),a=o.get("leaf"),a&&(o.markAsParent(),s=o.getSegments()),e=o.appendChild(e),o.expand(),t&&t(function(){i?i.insertChild(n,e):o.removeChild(e),a&&o.set("leaf",!0),a&&s&&o.setSegmentsWithoutPropagation(s)},e),i?o!==i&&o.getTaskStore(!0)===i.getTaskStore(!0)&&(r=[e,i]):r=e,r},insertSubtask:function(e,t,i){var n,r,a=this;return a.propagateChanges(function(){return a.insertSubtaskWithoutPropagation(e,t,function(e,t){r=e,n=t})},function(e,t){e&&r&&r(),i&&i(e,t)}),n},insertSubtaskWithoutPropagation:function(e,t,i){var n,r,a,s,o,l=this;return n=t.parentNode,r=n&&n.indexOf(l),s=l.get("leaf"),s&&(l.markAsParent(),o=l.getSegments()),t=l.insertChild(e,t),l.expand(),i&&i(function(){n?n.insertChild(r,t):l.removeChild(t),s&&l.set("leaf",!0),s&&o&&l.setSegmentsWithoutPropagation(o)},t),n?l!==n&&l.getTaskStore(!0)===n.getTaskStore(!0)&&(a=[t,n]):a=t,a},removeSubtask:function(e,t){var i,n=this;n.propagateChanges(function(){return n.removeSubtaskWithoutPropagation(e,function(e){i=e})},function(e,n){e&&i&&i(),t&&t(e,n)})},removeSubtaskWithoutPropagation:function(e,t){var i,n,r,a,s,o,l,d,c,h,u=this,g=u.indexOf(e);for(-1!=g||Ext.Error.raise("Can't remove subtask `"+e.getId()+"` from task `"+u.getId()+"` subtask is not a child of the task!"),n=u.getDependencyStore(),r=u.getAssignmentStore(),a=n&&n.getDependenciesForTask(e),s=r&&e.getAssignments(),i=[],o=[],l=[],e.cascadeBy(function(t){t!==e&&i.push(t)}),d=0,c=i.length;(n||r)&&d<c;d++)h=i[d],n&&(a=a.concat(n.getDependenciesForTask(h))),r&&(s=s.concat(h.getAssignments()));for(a=n&&Ext.Array.unique(a),a=n&&Ext.Array.sort(a,function(e,t){return n.indexOf(e)<n.indexOf(t)?-1:1}),d=0,c=a&&a.length;n&&d<c;d++)o.push(n.indexOf(a[d]));for(s=r&&Ext.Array.sort(s,function(e,t){return r.indexOf(e)<r.indexOf(t)?-1:1}),d=0,c=s&&s.length;r&&d<c;d++)l.push(r.indexOf(s[d]));return r&&r.remove(s),n&&n.remove(a),e=u.removeChild(e),0===u.childNodes.length&&u.convertEmptyParentToLeaf&&u.set("leaf",!0),t&&t(function(){for(u.insertChild(g,e),d=0,c=s&&s.length;r&&d<c;d++)r.insert(l[d],s[d]);for(d=0,c=a&&a.length;n&&d<c;d++)n.insert(o[d],a[d])}),u},addSuccessor:function(e,t){var i,n,r=this;return r.propagateChanges(function(){return r.addSuccessorWithoutPropagation(e,function(e,t){n=e,i=t})},function(e,i){e&&n&&n(),t&&t(e,i)}),i},addSuccessorWithoutPropagation:function(e,t){var i,n,r=this,a=r.parentNode,s=a.indexOf(r);return e=e||new r.self,e.calendar=e.calendar||r.getCalendar(),e.taskStore=e.taskStore||r.getTaskStore(!0),r.getEndDate()&&(e.beginEdit(),e.set(r.startDateField,r.getEndDate()),e.set(r.endDateField,e.calculateEndDate(r.getEndDate(),1,Sch.util.Date.DAY)),e.set(r.durationField,1),e.set(r.durationUnitField,Sch.util.Date.DAY),e.endEdit()),a.insertSubtaskWithoutPropagation(s+1,e,function(t,n){i=t,e=n}),r.linkToWithoutPropagation(e,Gnt.model.Dependency.Type.EndToStart,function(e){n=e}),t&&t(function(){n(),i()},e),r},addMilestone:function(e,t){var i=this,n=i.getEndDate();return e?!Ext.isObject(e)||e instanceof Gnt.model.Task||(e=new i.self(e)):e=new i.self,n&&!e.isMilestone()&&(e.calendar=e.calendar||i.getCalendar(),e.setStartEndDate(n,n)),i.addTaskBelow(e,t)},addPredecessor:function(e,t){var i,n,r=this;return r.propagateChanges(function(){return r.addPredecessorWithoutPropagation(e,function(e,t){n=e,i=t})},function(e,i){e&&n(),t&&t(e,i)}),i},addPredecessorWithoutPropagation:function(e,t){var i,n,r=this,a=r.parentNode,s=a.indexOf(r);return e=e||new r.self,e.calendar=e.calendar||r.getCalendar(),e.taskStore=e.taskStore||r.getTaskStore(!0),r.getStartDate()&&(e.beginEdit(),e.set(r.startDateField,e.calculateStartDate(r.getStartDate(),1,Sch.util.Date.DAY)),e.set(r.endDateField,r.getStartDate()),e.set(r.durationField,1),e.set(r.durationUnitField,Sch.util.Date.DAY),e.endEdit()),a.insertSubtaskWithoutPropagation(s,e,function(t,n){i=t,e=n}),e.linkToWithoutPropagation(r,Gnt.model.Dependency.Type.EndToStart,function(e){n=e}),t&&t(function(){n(),i()},e),e},getSuccessors:function(){for(var e=this.successors,t=[],i=0,n=e.length;i<n;i++){var r=e[i].getTargetTask();r&&t.push(r)}return t},getPredecessors:function(){for(var e=this.predecessors,t=[],i=0,n=e.length;i<n;i++){var r=e[i].getSourceTask();r&&t.push(r)}return t},addTaskAbove:function(e,t){var i,n,r=this,a=r.parentNode,s=a.indexOf(r);return e=e||new r.self,r.propagateChanges(function(){return a.insertSubtaskWithoutPropagation(s,e,function(e,t){n=e,i=t})},function(e,i){e&&n(),t&&t(e,i)}),i},addTaskBelow:function(e,t){var i,n,r=this,a=r.parentNode,s=a.indexOf(r)+1;return e=e||new r.self,r.propagateChanges(function(){return a.insertSubtaskWithoutPropagation(s,e,function(e,t){n=e,i=t})},function(e,i){e&&n(),t&&t(e,i)}),i},isAbove:function(e){for(var t=this,i=Math.min(t.data.depth,e.data.depth),n=this;n.data.depth>i;)if((n=n.parentNode)==e)return!1;for(;e.data.depth>i;)if((e=e.parentNode)==t)return!0;for(;e.parentNode!==n.parentNode;)e=e.parentNode,n=n.parentNode;return e.data.index>n.data.index},cascadeChildren:function(e,t){if(!this.isLeaf())for(var i=this.childNodes,n=0,r=i.length;n<r;n++)i[n].cascadeBy(e,t)},getSlack:function(e){e=e||Sch.util.Date.DAY;var t=this.getEarlyStartDate(),i=this.getLateStartDate();return t&&i?this.getCalendar().calculateDuration(t,i,e):null},getEarlyStartDate:function(){var e=this.getTaskStore();if(!e)return this.getStartDate();var t=this.internalId;if(e.earlyStartDates[t])return e.earlyStartDates[t];var i,n,r,a=0;if(this.childNodes.length){for(n=0,r=this.childNodes.length;n<r;n++)((i=this.childNodes[n].getEarlyStartDate())<a||!a)&&(a=i);return e.earlyStartDates[t]=a,a}if(this.isManuallyScheduled())return a=e.earlyStartDates[t]=this.getStartDate();var s,o=this.getIncomingDependencies(!0);if(!o.length)return a=e.earlyStartDates[t]=this.getStartDate();var l,d=Gnt.model.Dependency.Type,c=this.getCalendar(),h=this.getProjectCalendar();for(n=0,r=o.length;n<r;n++){if(s=o[n].getSourceTask()){switch(o[n].getType()){case d.StartToStart:i=s.getEarlyStartDate();break;case d.StartToEnd:i=s.getEarlyStartDate(),i=c.calculateStartDate(i,this.getDuration(),this.getDurationUnit());break;case d.EndToStart:i=s.getEarlyEndDate();break;case d.EndToEnd:i=s.getEarlyEndDate(),i=c.calculateStartDate(i,this.getDuration(),this.getDurationUnit())}l=o[n].getLag(),l&&(i=h.skipWorkingTime(i,l,o[n].getLagUnit())),i=h.skipNonWorkingTime(i,!0)}i>a&&(a=i)}return e.earlyStartDates[t]=a,a},getEarlyEndDate:function(){var e=this.getTaskStore();if(!e)return this.getEndDate();var t=this.internalId;if(e.earlyEndDates[t])return e.earlyEndDates[t];var i=0;if(this.childNodes.length){var n,r,a;for(r=0,a=this.childNodes.length;r<a;r++)(n=this.childNodes[r].getEarlyEndDate())>i&&(i=n);return e.earlyEndDates[t]=i,i}if(this.isManuallyScheduled())return i=e.earlyEndDates[t]=this.getEndDate();var s=this.getEarlyStartDate();return s?i=e.earlyEndDates[t]=this.getCalendar().calculateEndDate(s,this.getDuration(),this.getDurationUnit()):null},getLateEndDate:function(){var e=this.getTaskStore();if(!e)return this.getEndDate();var t=this.internalId;if(e.lateEndDates[t])return e.lateEndDates[t];var i,n,r,a=0;if(this.childNodes.length){for(n=0,r=this.childNodes.length;n<r;n++)(i=this.childNodes[n].getLateEndDate())>a&&(a=i);return e.lateEndDates[t]=a,a}if(this.isManuallyScheduled())return a=e.lateEndDates[t]=this.getEndDate();var s=this.getOutgoingDependencies(!0);if(!s.length)return a=e.lateEndDates[t]=e.getProjectEndDate();var o,l,d=Gnt.model.Dependency.Type,c=this.getCalendar(),h=this.getProjectCalendar();for(n=0,r=s.length;n<r;n++)if(o=s[n].getTargetTask()){switch(s[n].getType()){case d.StartToStart:i=o.getLateStartDate(),i=c.calculateEndDate(i,this.getDuration(),this.getDurationUnit());break;case d.StartToEnd:i=o.getLateEndDate(),i=c.calculateEndDate(i,this.getDuration(),this.getDurationUnit());break;case d.EndToStart:i=o.getLateStartDate();break;case d.EndToEnd:i=o.getLateEndDate()}l=s[n].getLag(),l&&(i=h.skipWorkingTime(i,-l,s[n].getLagUnit())),i=h.skipNonWorkingTime(i,!1),(i<a||!a)&&(a=i)}return e.lateEndDates[t]=a||e.getProjectEndDate(),e.lateEndDates[t]},getLateStartDate:function(){var e=this.getTaskStore();if(!e)return this.getStartDate();var t=this.internalId;if(e.lateStartDates[t])return e.lateStartDates[t];var i;if(this.childNodes.length){var n,r,a;for(r=0,a=this.childNodes.length;r<a;r++)((n=this.childNodes[r].getLateStartDate())<i||!i)&&(i=n);return e.lateStartDates[t]=i,i}if(this.isManuallyScheduled())return i=e.lateStartDates[t]=this.getStartDate();var s=this.getLateEndDate();return s?i=e.lateStartDates[t]=this.getCalendar().calculateStartDate(s,this.getDuration(),this.getDurationUnit()):null},resetEarlyDates:function(){var e=this.getTaskStore();if(e){var t=this.internalId;e.earlyStartDates[t]=null,e.earlyEndDates[t]=null}},resetLateDates:function(){var e=this.getTaskStore();if(e){var t=this.internalId;e.lateStartDates[t]=null,e.lateEndDates[t]=null}},getTopParent:function(e){for(var t,i=this.getTaskStore().getRootNode(),n=this,r=[this];n;){
if(n===i)return e?r:t;r.push(n),t=n,n=n.parentNode}},getInDepthWalker:function(e){var t=e?this:this.childNodes&&this.childNodes[0],i=this,n={},r=function(e){var t=e,a=t.internalId;if(t.isLeaf()||!t.childNodes.length?t=t.nextSibling:!0===n[a]?(n[a]=!1,t=t.nextSibling):(n[a]=!0,t=t.childNodes[0]),!t){t=e;do{if(t===i)return null;if((t=t.parentNode)===i)return null}while(!1===n[t.internalId]);return r(t)}return t};return function(){var e=t;return t&&(t=r(t)),e}},propagateChanges:function(e,t,i){var n,r,a,s,o=this;if(!e||Ext.isFunction(e)||Ext.Error.raise("Can't propagate changes to a task, invalid changer function given"),!t||Ext.isFunction(t)||Ext.Error.raise("Can't propagate changes to a task, invalid callback function given"),a=o.getTaskStore(!0),i=3==arguments.length?i:a&&a.cascadeChanges,!o.propagating&&a){o.propagating=!0,r={},a.suspendAutoSync(),s=a.startBatchCascade(),a.startProjection();try{n=e&&e!==Ext.emptyFn?e(o):[o]}catch(e){throw a.rejectProjection(),a.endBatchCascade(),a.resumeAutoSync(a.autoSync),o.propagating=!1,e}!0===n?n=o.isProjected()&&[o]||!1:n&&(n=[].concat(n)),n?o.propagateChangesThroughDependentTasks(a.getLinearWalkingSequenceForDependentTasks(n,{self:!0,ancestors:a.recalculateParents,descendants:a.moveParentAsGroup,successors:i,cycles:a.cycleResolutionStrategy}),a,s,n,i,r,function(e,i){e?(a.rejectProjection(),i={}):a.commitProjection(),a.endBatchCascade(),o.propagating=!1,t&&t(e,i),a.resumeAutoSync(a.autoSync&&!e&&!Ext.Object.isEmpty(i))}):(a.rejectProjection(),a.endBatchCascade(),o.propagating=!1,t&&t(!1,{}),a.resumeAutoSync(a.autoSync))}else if(o.propagating)t&&t(!0,{});else{o.propagating=!0;try{e&&e(o)}catch(e){throw o.propagating=!1,e}o.verifyConstraint(function(e,i){r={},i=!!i,i||(r[o.getId()]=o),o.propagating=!1,t&&t(i,r)})}},propagateChangesThroughDependentTasks:function(e,t,i,n,r,a,s,o){var l,d,c,h=this;for(o=o||0,c=!0,l=o,d=e.length;c&&l<d;++l)c=h.processTaskConstraints(e,l,t,i,n,r,a,function(a,o,l,c){l||a==d-1?s(l,c):o||h.propagateChangesThroughDependentTasks(e,t,i,n,r,c,s,a+1)})},processTaskConstraints:function(e,t,i,n,r,a,s,o){function l(e,t,i){var n,r,a,s,o=e.getIncomingDependencies(!0),l=!1;for(n=0,r=o.length;!l&&n<r;++n)a=o[n],s=a.getSourceTask(),l=s&&t.hasOwnProperty(s.getId())||Ext.Array.contains(i,s);return l}var d,c=e[t],h=c[0],u=c[1],g=h.hasChildNodes(),f=!g,p=!(h.isManuallyScheduled()||Ext.Array.contains(r,h)),m=a||i.cascadeChanges,v=i.recalculateParents,S=i.moveParentAsGroup,y=h.parentNode,E=y&&y.getStartDate(),x=y&&y.getUnprojected(y.startDateField),D=y&&E-x;switch(!0){case p&&f&&"green"==u&&D&&S:case p&&g&&"yellow"==u&&D&&S:if(E){var T=h.getStartDate();T>=x?(d=h.calculateDuration(x,T,null,{segments:!1}),h.setStartDateWithoutPropagation(h.calculateEndDate(E,d,null,{segments:!1}),!0,i.skipWeekendsDuringDragDrop)):(d=h.calculateDuration(T,x,null,{segments:!1}),h.setStartDateWithoutPropagation(h.calculateStartDate(E,d,null,{segments:!1}),!0,i.skipWeekendsDuringDragDrop)),l(h,s,r)&&h.alignByIncomingDependenciesWithoutPropagation(i,null,y)}break;case p&&f&&"green"==u&&m:case p&&g&&"yellow"==u&&m:l(h,s,r)&&h.alignByIncomingDependenciesWithoutPropagation(i,null);break;case g&&"green"==u&&v:h.refreshCalculatedParentNodeData()}return h.isProjected()&&(n.addAffected(h),s[h.getId()]=h),h.verifyConstraint(function(n,r){var a;!n&&g&&p&&i.recalculateParents&&"green"==u?(Ext.Array.findBy(e,function(e,t){var i=e[0],n=e[1];return a=t,h===i&&"yellow"==n}),o(a,n,!!r,s)):o(t,n,!!r,s)})},removeLinkToTask:function(e){var t=this.getDependencyStore(),i=this.getId(),n=e.getId();Ext.Array.each(this.getAllDependencies(),function(e){if(e.getSourceId()===i&&e.getTargetId()===n||e.getSourceId()===n&&e.getTargetId()===i)return t.remove(e),!1})}}),Ext.define("Gnt.model.task.Constraints",{setConstraint:function(e,t,i){function n(){return r.setConstraintWithoutPropagation(e,t)}var r=this;e?r.propagateChanges(n,i):(n(),i&&i(!1,{}))},setConstraintWithoutPropagation:function(e,t){var i,n=this;return e&&(i=Gnt.constraint.Base.getConstraintClass(e)),!t&&i&&(t=i.getInitialConstraintDate(n)),n.beginEdit(),n.set(n.constraintTypeField,e||""),n.set(n.constraintDateField,t),n.endEdit(),!0},setConstraintType:function(e,t){this.setConstraint(e,this.getConstraintDate(),t)},setConstraintTypeWithoutPropagation:function(e,t){this.setConstraintWithoutPropagation(e,this.getConstraintDate(),t)},setConstraintDate:function(e,t){this.setConstraint(this.getConstraintType(),e,t)},setConstraintDateWithoutPropagation:function(e){this.setConstraintWithoutPropagation(this.getConstraintType(),e)},hasConstraint:function(){return!!this.getConstraintType()},getConstraintClass:function(){return Gnt.constraint.Base.getConstraintClass(this.getConstraintType())},isConstraintSatisfied:function(){var e=this;return!e.hasConstraint()||e.getConstraintClass().isSatisfied(e,e.getConstraintDate())},verifyConstraint:function(e){var t,i,n,r,a,s=this;return!e||Ext.isFunction(e)||Ext.Error.raise("Can't verify task's constraint, resultion callback is invalid!"),r=s.isConstraintSatisfied(),e=e&&Ext.Function.pass(e,[r]),t=s.getTaskStore(!0),a=t&&t.hasListener("constraintconflict"),i=t&&t.constraintDatePrecision||Sch.util.Date.DAY,n=!r&&s.getConstraintClass().getResolution(e,s,null,i),!r&&t&&a?t.fireEvent("constraintconflict",s,n):r?e&&e(!1):n.cancelAction(),r},getWorkingTimeStartForDate:function(e){var t,i,n=this,r=!1;return e instanceof Date||Ext.Error.raise("Can't get working time start for a date, invalid date given!"),t=Ext.Date.clearTime(e,!0),i=Sch.util.Date.add(t,Sch.util.Date.DAY,1),n.forEachAvailabilityInterval({isForward:!0,startDate:t,endDate:i,segments:!1,resources:!0,fn:function(e,t){return r=new Date(e),!1}}),r},getWorkingTimeEndForDate:function(e){var t,i,n=this,r=!1;return e instanceof Date||Ext.Error.raise("Can't get working time end for a date, invalid date given!"),t=Ext.Date.clearTime(e,!0),i=Sch.util.Date.add(t,Sch.util.Date.DAY,1),n.forEachAvailabilityInterval({isForward:!1,startDate:t,endDate:i,segments:!1,resources:!0,fn:function(e,t){return r=new Date(t),!1}}),r},getNearestWorkingTimeStartForDate:function(e,t,i){var n,r,a=this;for(e instanceof Date||Ext.Error.raise("Can't get nearest working time start for a date, invalid date given!"),t=t||!1,i=i||365,n=t?-1:1,r=a.getWorkingTimeStartForDate(e);!r&&i--;)e=Sch.util.Date.add(e,Sch.util.Date.DAY,n),r=a.getWorkingTimeStartForDate(e);return r},getNearestWorkingTimeEndForDate:function(e,t,i){var n,r,a=this;for(e instanceof Date||Ext.Error.raise("Can't get nearest working time end for a date, invalid date given!"),t=t||!1,i=i||365,n=t?-1:1,r=a.getWorkingTimeEndForDate(e);!r&&i--;)e=Sch.util.Date.add(e,Sch.util.Date.DAY,n),r=a.getWorkingTimeEndForDate(e);return r},getWorkingTimeIntervalForDateTime:function(e){var t,i,n=this,r=!1;return e instanceof Date||Ext.Error.raise("Can't get task's working time intarval for a datetime, invalid datetime given!"),t=Ext.Date.clearTime(e,!0),i=Sch.util.Date.add(t,Sch.util.Date.DAY,1),e=e.valueOf(),n.forEachAvailabilityInterval({isForward:!0,startDate:t,endDate:i,segments:!1,resources:!0,fn:function(t,i){return t<=e&&e<=i&&(r={startDate:new Date(t),endDate:new Date(i)}),!r}}),r},isDateTimeWithinWorkingTimeInterval:function(e){var t=this;return e instanceof Date||Ext.Error.raise("Can't check if datetime is within working time intarval for a task, invalid datetime given!"),!1!==t.getWorkingTimeIntervalForDateTime(e)}});Ext.define("Gnt.model.task.Splittable",{segmentsTrackingSuspended:0,changingTaskBySegments:!1,splitsDuration:0,segmentsSnapshot:null,segmentsProjection:null,getFirstSegment:function(){var e=this.getSegments();return e&&e[0]},getLastSegment:function(){var e=this.getSegments();return e&&e[e.length-1]},normalizeSegments:function(){var e=this.getSegments();this.suspendSegmentsTracking(),e.sort(function(e,t){return e.normalized||e.normalize(),t.normalized||t.normalize(),e.getStartDate()>t.getStartDate()?1:-1}),this.mergeOverlappedSegments(),(e=this.getSegments())&&(this.data[this.durationField]=this.getSegmentsDuration()),this.resumeSegmentsTracking()},updateSegmentsDates:function(e){e=e||{},this.isSegmented()&&(this.suspendSegmentsTracking(),e=Ext.apply({useAbsoluteOffset:!1},e),e.isForward=!1!==e.isForward,this.forEachSegment(function(t){t.updateDatesByOffsets(e)},e.isForward),this.set(this.segmentsField,this.getSegments().slice()),this.resumeSegmentsTracking())},getSegmentIntervalsForRange:function(e,t,i){if(i=i||this.getSegments()){for(var n=Sch.util.Date,r=[],a=0,s=i.length;a<s;a++){var o=i[a],l=o.getStartDate(),d=o.getEndDate();n.intersectSpans(e,t,l,d)&&r.push([n.constrain(l,e,t)-0,n.constrain(d,e,t)-0])}return r.length&&r||null}},getSegmentByDate:function(e,t){if(t=t||this.getSegments())for(var i=0,n=t.length;i<n;i++){var r=t[i];if(e>=r.getStartDate()&&e<r.getEndDate())return r}},constrainSegments:function(e){if(!this.changingTaskBySegments){e=e||{};var t=this.getSegments();if(t){var i=this.getDuration("MILLI"),n=e.unit||this.getDurationUnit(),r=e.duration,a=this.getStartDate(),s=this.getEndDate(),o=this.getUnitConverter();if(!a||!s&&!i&&!r)return void this.set(this.segmentsField,null);r?r=o.convertDurationToMs(r,n):s||(r=i),this.suspendSegmentsTracking(),t[0].setStartDateWithoutPropagation(this.getStartDate(),!1);var l,d,c,h=0,u=[],g=r;c=r?function(e){return g<=0}:function(e){return e.getStartDate()>=s};for(var f=0,p=t.length;f<p;f++){if(l=t[f],c(l)){u.push.apply(u,t.slice(f));break}g-=l.getDuration("MILLI"),d&&(h+=l.getStartOffset()-d.getEndOffset()),d=l}if(this.removeSegments(u),t.length<2)this.set(this.segmentsField,null);else{var m=this.getLastSegment(),v=!1;r?g&&(m.setDurationWithoutPropagation(o.convertMSDurationToUnit(m.getEndOffset()-m.getStartOffset()+g,m.getDurationUnit())),v=!0):m.getEndDate()-s&&(m.setEndDateWithoutPropagation(s,!1),v=!0),m.setNextSegment(null),this.splitsDuration=h,!u.length&&!v||this.modified&&this.modified[this.segmentsField]||this.set(this.segmentsField,this.getSegments().slice())}this.resumeSegmentsTracking()}}},forEachSegment:function(e,t,i,n){if(e){n=n||this;var r,a;for(!1!==t?(r="getNextSegment",a=i||this.getFirstSegment()):(r="getPrevSegment",a=i||this.getLastSegment());a;){if(!1===e.call(n,a))return;a=a[r].call(a)}}},split:function(e,t,i,n,r){var a,s=this;s.propagateChanges(function(){return s.splitWithoutPropagation(e,t,i,n,function(e){a=e})},function(e,t){e&&a&&a(),r&&r(e,t)})},splitWithoutPropagation:function(e,t,i,n,r){var a=this;if(!0!==n&&!1!==n){var s=a.getTaskStore(!0);n=!!s&&s.skipWeekendsDuringDragDrop}if(e&&a.isLeaf()&&!a.isMilestone()){var o=a.getStartDate(),l=a.getEndDate();if(!(!o||!l||o>=e||e>=l)){var d,c=a.getSegments(),h=a.buildSegmentsSnapshot(c);if(c){if(!(d=a.getSegmentByDate(e)))return}else c=[];t=t||1,i=i||this.getDurationUnit();var u=new Date(e),g=u,f=u,p=a.getUnitConverter().convertDurationToMs(t,i);n&&(f=a.skipNonWorkingTime(f,!0,!0),g=a.skipNonWorkingTime(g,!1,!0));var m,v,S,y=a.getDurationUnit(),E=Ext.ClassManager.get(a.segmentClassName).prototype;a.suspendSegmentsTracking();var x=!0;if(d){m=a.calculateDuration(d.getStartDate(),g,y),v=d.getDuration(y)-m,x=!!m;var D;x?(d.setEndDateWithoutPropagation(g,!1,n),D=d.getNextSegment()):D=d,D&&a.forEachSegment(function(e){e.setStartEndOffset(e.getStartOffset()+p,e.getEndOffset()+p),e.updateDatesByOffsets()},!0,D)}else m=a.calculateDuration(o,g),v=a.getDuration()-m,S={task:a},S[E.startDateField]=o,S[E.durationField]=m,S[E.durationUnitField]=y,c.push(Ext.create(a.segmentClassName,S));if(x){f=a.skipWorkingTime(f,p),n&&(f=a.skipNonWorkingTime(f)),S={prevSegment:d||c[0],task:a},S[E.startDateField]=f,S[E.durationField]=v,S[E.durationUnitField]=y;var T=Ext.create(a.segmentClassName,S);d?Ext.Array.insert(c,Ext.Array.indexOf(c,d)+1,[T]):c.push(T)}return a.resumeSegmentsTracking(),r&&r(function(){a.rollbackSegmentsToSnapshot(h)}),d?a.onSegmentsChanged(null,null):a.setSegmentsWithoutPropagation(c),!0}}},merge:function(e,t,i){var n=this;n.propagateChanges(function(){return n.mergeWithoutPropagation(e,t)},i)},mergeWithoutPropagation:function(e,t){if(this.isSegmented()&&e&&t){var i,n;return e.getStartOffset()>t.getStartOffset()?(i=t,n=e):(i=e,n=t),i.setEndDateWithoutPropagation(n.getEndDate(),!1),!0}},suspendSegmentsTracking:function(){this.segmentsTrackingSuspended++},resumeSegmentsTracking:function(){this.segmentsTrackingSuspended--},getSegmentsDuration:function(e){e=e||this.getDurationUnit();for(var t=this.getSegments(),i=0,n=0,r=t.length;n<r;n++){var a=t[n];i+=a.getEndOffset()-a.getStartOffset()}return this.getUnitConverter().convertMSDurationToUnit(i,e)},mergeOverlappedSegments:function(e){var t=this.getSegments();if(t){for(var i,n=[],r=t[0],a=1,s=t.length;a<s;a++)i=t[a],i.getStartOffset()<=r.getEndOffset()?(n.push(i),i.getEndOffset()>r.getEndOffset()&&r.setEndDateWithoutPropagation(i.getEndDate(),!1)):(i.setPrevSegment(r),r=i);this.removeSegments(n),t.length<2&&!e?this.setSegmentsWithoutPropagation(null):t[t.length-1].setNextSegment(null)}},onSegmentEditBegin:function(e){this.snapshotSegments()},onSegmentsChanged:function(e,t){if(!this.segmentsTrackingSuspended){var i=this.getSegments();this.changingTaskBySegments=!0,this.suspendSegmentsTracking(),this.mergeOverlappedSegments(!0),i=this.getSegments(),e&&t&&e.durationField in t?this.setDurationWithoutPropagation(this.getSegmentsDuration()):this.setStartDateWithoutPropagation(this.getStartDate(),!0),i=this.getSegments(),this.set(this.segmentsField,i&&i.slice()||null),this.resumeSegmentsTracking(),this.changingTaskBySegments=!1}},removeSegments:function(e){var t=this.getSegments();if(t&&e&&e.length){Ext.isArray(e)||(e=[e]);for(var i=0,n=e.length;i<n;i++)Ext.Array.remove(t,e[i]);this.onSegmentsChanged()}},setSegments:function(e,t){var i=this;i.propagateChanges(function(){return i.setSegmentsWithoutPropagation(e)},t)},setSegmentsWithoutPropagation:function(e){this.splitsDuration=0,this.suspendSegmentsTracking();var t=this.getSegments();return this.set(this.segmentsField,this.processSegmentsValue(e)),this.isSegmented()||t&&this.removeSegments(t.slice()),this.resumeSegmentsTracking(),this.onSegmentsChanged(null,null),!0},processSegmentsValue:function(e){var t,i,n;if(e){e=[].concat(e),t=[];for(var r=0,a=e.length;r<a;r++)i=e[r],i instanceof Gnt.model.TaskSegment||(i=Ext.create(this.segmentClassName,Ext.apply(i,{task:this}))),t.push(i),i.setPrevSegment(n),n=i;e=t&&t.length>1&&t||null}return e},isSegmented:function(){return Boolean(this.getSegments())},getSegment:function(e){return this.getSegments()[e]},rejectSegmentsProjection:function(){var e,t,i=this.getTaskStore(!0).getProjectionLevel();if(this.segmentsProjection){var n;for(t=i;t>=0;t--)if(e=this.segmentsProjection[t]){n=t;break}n===i&&delete this.segmentsProjection[n]}e&&this.rollbackSegmentsToSnapshot(e)},commitSegmentsProjection:function(){var e=this.getTaskStore(!0),t=e&&e.getProjectionLevel();this.segmentsProjection&&delete this.segmentsProjection[t]},rollbackSegmentsToSnapshot:function(e){this.data[this.segmentsField]=e&&Ext.Array.map(e,function(e){return e&&e[0].readSnapshot(e)})},buildSegmentsSnapshot:function(e){return(e=e||this.getSegments())&&Ext.Array.map(e,function(e){return e&&e.buildSnapshot()})},snapshotSegments:function(){var e,t=this.getTaskStore(!0),i=this.getSegments(),n=t&&t.getProjectionLevel();n&&(this.segmentsProjection=this.segmentsProjection||{},(e=this.segmentsProjection[n-1])||(e=this.buildSegmentsSnapshot(i),this.segmentsProjection[n-1]=e)),this.segmentsSnapshot||(this.segmentsSnapshot=e||this.buildSegmentsSnapshot(i))},commitSegments:function(){if(!this.rejecting){this.segmentsSnapshot=null;var e=this.getSegments();if(e)for(var t=0,i=e.length;t<i;t++)e[t].commit()}},rejectSegments:function(){this.rollbackSegmentsToSnapshot(this.segmentsSnapshot),this.segmentsSnapshot=null;var e=this.getSegments();if(e)for(var t=0,i=e.length;t<i;t++)e[t].reject()}}),Ext.define("Gnt.model.Task",{extend:Sch.model.Range,alias:"gntmodel.event",mixins:[Gnt.model.mixin.ProjectableModel,Gnt.model.task.More,Gnt.model.task.Constraints,Gnt.model.task.Splittable],segmentClassName:"Gnt.model.TaskSegment",idProperty:"Id",customizableFields:[{name:"Duration",type:"number",allowNull:!0},{name:"Effort",type:"number",allowNull:!0},{name:"EffortUnit",type:"string",defaultValue:"h"},{name:"CalendarId",type:"string"},{name:"Note",type:"string"},{name:"DurationUnit",type:"string",defaultValue:"d",convert:function(e){return e||"d"}},{name:"PercentDone",type:"number",defaultValue:0},{name:"ConstraintType",type:"string",defaultValue:""},{name:"ConstraintDate",type:"date",dateFormat:"c"},{name:"ManuallyScheduled",type:"boolean",defaultValue:!1},{name:"SchedulingMode",type:"string",defaultValue:"Normal"},{name:"BaselineStartDate",type:"date",dateFormat:"c"},{name:"BaselineEndDate",type:"date",dateFormat:"c"},{name:"BaselinePercentDone",type:"int",defaultValue:0},{name:"Draggable",type:"boolean",persist:!1,defaultValue:!0},{name:"Resizable",persist:!1,defaultValue:""},{name:"Rollup",type:"boolean",defaultValue:!1},{name:"Segments",persist:!0,convert:function(e,t){return t.processSegmentsValue(e,t)},serialize:function(e){return e?Ext.Array.map([].concat(e),function(e){return e.serialize()}):null}},{name:"PhantomId",type:"string"},{name:"PhantomParentId",type:"string"},{name:"ShowInTimeline",type:"bool"},{name:"index",type:"int",persist:!0}],constraintTypeField:"ConstraintType",constraintDateField:"ConstraintDate",draggableField:"Draggable",resizableField:"Resizable",nameField:"Name",durationField:"Duration",durationUnitField:"DurationUnit",effortField:"Effort",effortUnitField:"EffortUnit",percentDoneField:"PercentDone",manuallyScheduledField:"ManuallyScheduled",schedulingModeField:"SchedulingMode",rollupField:"Rollup",calendarIdField:"CalendarId",baselineStartDateField:"BaselineStartDate",baselineEndDateField:"BaselineEndDate",baselinePercentDoneField:"BaselinePercentDone",noteField:"Note",segmentsField:"Segments",readOnlyField:"ReadOnly",calendar:null,dependencyStore:null,taskStore:null,phantomIdField:"PhantomId",phantomParentIdField:"PhantomParentId",showInTimelineField:"ShowInTimeline",normalized:!1,recognizedSchedulingModes:["Normal","FixedDuration","EffortDriven","DynamicAssignment"],convertEmptyParentToLeaf:!0,autoCalculateEffortForParentTask:!0,autoCalculatePercentDoneForParentTask:!0,isHighlighted:!1,calendarWaitingListener:null,childTasksDuration:null,completedChildTasksDuration:null,totalCount:null,predecessors:null,successors:null,removeChildIsCalledFromReplaceChild:!1,savedDirty:null,useOwnCalendarAsConverter:!1,constructor:function(){this._singleProp={},this.initProjectable(),this.callParent(arguments),this.phantom&&(this.data[this.phantomIdField]=this.getId()),this.predecessors=[],this.successors=[]},normalize:function(){var e=this.getDurationUnit(),t=this.getStartDate(),i=this.getEndDate(),n=this.data,r=this.getTaskStore(!0),a=this.getSchedulingMode();"Manual"==a&&(a=n[this.schedulingModeField]="Normal",n[this.manuallyScheduledField]=!0);var s=this.endDateField;if(r&&this.isSegmented()){this.normalizeSegments();var o;(o=this.getLastSegment())&&(i=n[s]=o.getEndDate())}var l=this.getDuration(),d=this.effortField;if(i&&this.inclusiveEndDate){var c=this.getField(s).dateFormat;(c&&!Ext.Date.formatContainsHourInfo(c)||0===i.getHours()&&0===i.getMinutes()&&0===i.getSeconds()&&0===i.getMilliseconds())&&(i=Ext.isNumber(l)?n[s]=this.calculateEndDate(t,l,e):n[s]=Ext.Date.add(i,Ext.Date.DAY,1))}null==l&&t&&i&&(l=n[this.durationField]=this.calculateDuration(t,i,e)),("Normal"==a||this.isManuallyScheduled())&&null==i&&t&&Ext.isNumber(l)&&(i=n[s]=this.calculateEndDate(t,l,e));var h=this.get(d),u=this.getEffortUnit();switch(a){case"FixedDuration":null==i&&t&&Ext.isNumber(l)&&(i=n[s]=this.calculateEndDate(t,l,e)),null==h&&t&&i&&(n[d]=this.calculateEffort(t,i,u));break;case"EffortDriven":null==h&&t&&i&&(n[d]=this.calculateEffort(t,i,u)),null==i&&t&&h&&(n[s]=this.calculateEffortDrivenEndDate(t,h,u),null==l&&(n[this.durationField]=this.calculateDuration(t,n[s],e)));break;default:null==i&&t&&Ext.isNumber(l)&&(i=n[s]=this.calculateEndDate(t,l,e))}var g=this.getCalendarId();g&&this.setCalendarId(g,!0),this.normalized=!0},getUnitConverter:function(){return this.useOwnCalendarAsConverter&&this.getCalendar()||this.getProjectCalendar()},normalizeParent:function(){for(var e=this.childNodes,t=0,i=0,n=0,r=this.autoCalculatePercentDoneForParentTask,a=this.autoCalculateEffortForParentTask,s=0;s<e.length;s++){var o=e[s],l=o.isLeaf();if(l||o.normalizeParent(),a&&(t+=o.getEffort("MILLI")),r){var d=l?o.getDuration("MILLI")||0:o.childTasksDuration;i+=d,n+=l?d*(o.getPercentDone()||0):o.completedChildTasksDuration}}if(r){this.childTasksDuration=i,this.completedChildTasksDuration=n;var c=i?n/i:0;this.getPercentDone()!=c&&(this.data[this.percentDoneField]=c)}a&&this.getEffort("MILLI")!=t&&(this.data[this.effortField]=this.getUnitConverter().convertMSDurationToUnit(t,this.getEffortUnit()))},getCalendar:function(e){return e?this.getOwnCalendar():this.getOwnCalendar()||this.parentNode&&this.parentNode.getCalendar()||this.getProjectCalendar()},getOwnCalendar:function(){var e=this.get(this.calendarIdField);return e?Gnt.data.Calendar.getCalendar(e):this.calendar},getProject:function(){var e=this,t=null;return this.bubble(function(i){if(e!==i&&i.isProject)return t=i,!1},this),t},getProjectCalendar:function(){var e=this.getTaskStore(!0),t=e&&e.getCalendar()||this.parentNode&&this.parentNode.getProjectCalendar()||this.isRoot()&&this.calendar;return t||Ext.Error.raise("Can't find a pms calendar in `getProjectCalendar`"),t},setCalendar:function(e,t){var i=this,n=e instanceof Gnt.data.Calendar;if(n&&!e.calendarId)throw new Error("Can't set calendar w/o `calendarId` property");return i.setCalendarId(n?e.calendarId:e,!1,t)},setCalendarId:function(e,t,i){var n=this;t?n.setCalendarIdWithoutPropagation(e,t):n.propagateChanges(function(){return n.setCalendarIdWithoutPropagation(e,t)},i)},setCalendarIdWithoutPropagation:function(e,t){var i=!1;e instanceof Gnt.data.Calendar&&(e=e.calendarId);var n=this.getCalendarId();if(n!=e||t){i=!0,this.calendarWaitingListener&&(this.calendarWaitingListener.destroy(),this.calendarWaitingListener=null);var r={calendarchange:this.adjustToCalendarWithoutPropagation,scope:this},a=this.calendar||Gnt.data.Calendar.getCalendar(n);this.calendar=null,a&&a.un(r),this.set(this.calendarIdField,e);var s=Gnt.data.Calendar.getCalendar(e);s?(s.on(r),t||this.adjustToCalendarWithoutPropagation()):this.calendarWaitingListener=Ext.data.StoreManager.on("add",function(){(s=Gnt.data.Calendar.getCalendar(e))&&(this.calendarWaitingListener.destroy(),this.calendarWaitingListener=null,s.on(r),this.adjustToCalendarWithoutPropagation())},this,{destroyable:!0})}return i},getDependencyStore:function(){var e=this.getTaskStore(!0),t=e&&e.getDependencyStore();return t||Ext.Error.raise("Can't find a dependencyStore in `getDependencyStore`"),t},getResourceStore:function(){var e=this.getTaskStore(!0);return e&&e.getResourceStore()},getAssignmentStore:function(){var e=this.getTaskStore(!0);return e&&e.getAssignmentStore()},getTaskStore:function(e){var t=this;return t.taskStore||(t.taskStore=t.getTreeStore()||t.parentNode&&t.parentNode.getTaskStore(e)),t.taskStore||e||Ext.Error.raise("Can't find a taskStore in `getTaskStore`"),t.taskStore},getEventStore:function(){return this.getTaskStore()},setTaskStore:function(e){this.taskStore=e},isManuallyScheduled:function(){return"Manual"===this.get(this.schedulingModeField)||this.get(this.manuallyScheduledField)},isShowInTimeline:function(){return Boolean(this.getShowInTimeline())},setManuallyScheduled:function(e,t){var i=this;i.propagateChanges(function(){return i.setManuallyScheduledWithoutPropagation(e)},function(e){e?i.rejectSegmentsProjection():i.commitSegmentsProjection(),t&&t.apply(this,arguments)})},setManuallyScheduledWithoutPropagation:function(e){var t,i=this;return i.isManuallyScheduled()!=e&&(this.set(i.manuallyScheduledField,e),e||(t=i.getPredecessors()[0]),t=t||i),t},setSchedulingMode:function(e,t){var i=this;i.propagateChanges(function(){return i.setSchedulingModeWithoutPropagation(e)},t)},setSchedulingModeWithoutPropagation:function(e){var t,i=this;if(Ext.Array.contains(i.recognizedSchedulingModes,e)||Ext.Error.raise("Unrecognized scheduling mode: "+e),i.getSchedulingMode()!=e){switch(i.set(this.schedulingModeField,e),e){case"FixedDuration":i.updateEffortBasedOnDuration();break;case"EffortDriven":i.updateSpanBasedOnEffort()}var n=i.getPredecessors();t=n.length?n[0]:i}return t},skipWorkingTime:function(e,t,i,n){var r,a;i=!1!==i;var s={isForward:i,segments:n||!1,resources:this.hasResources(),fn:function(e,t){var n=t-e,s=new Date(e).getTimezoneOffset()-new Date(t).getTimezoneOffset();if(n>=a)return r=new Date((i?e:t)-0+(i?1:-1)*a),!1;a-=n+60*s*1e3}};return Ext.isObject(e)?Ext.apply(s,e):i?s.startDate=e:s.endDate=e,(a=t||s.duration)?(this.forEachAvailabilityInterval(s),r):e},skipNonWorkingTime:function(e,t,i){var n=!1;t=!1!==t;var r={isForward:t,segments:i||!1,resources:this.hasResources(),fn:function(i,r){if(i!==r)return e=t?i:r,n=!0,!1}};return Ext.isObject(e)?Ext.apply(r,e):t?r.startDate=e:r.endDate=e,this.forEachAvailabilityInterval(r),n?new Date(e):this.getCalendar().skipNonWorkingTime(e,t)},setStartDate:function(e,t,i,n){var r=this;r.propagateChanges(function(){return r.setStartDateWithoutPropagation(e,t,i)},function(e,t){e?r.rejectSegmentsProjection():r.commitSegmentsProjection(),n&&n.apply(this,arguments)})},setStartDateWithoutPropagation:function(e,t,i){var n,r,a=this,s=a.getTaskStore(!0);if(t=!1!==t,s&&!0!==i&&!1!==i?i=s.skipWeekendsDuringDragDrop:!0!==i&&!1!==i&&(i=!1),a.beginEdit(),e){i&&(e=a.skipNonWorkingTime(e,!a.isMilestone()));a.getStartDate();a.set(a.startDateField,e),s&&a.isSegmented()&&a.updateSegmentsDates(),!1!==t?a.set(a.endDateField,a.recalculateEndDate(e)):(r=this.getEndDate())&&(this.constrainSegments(),a.set(a.durationField,a.calculateDuration(e,r,a.getDurationUnit())))}else a.set(a.durationField,null),a.set(a.startDateField,null),a.setSegments(null);return n=a.getDuration(),r=a.getEndDate(),e&&r&&(void 0===n||null===n)&&a.set(a.durationField,a.calculateDuration(e,r,a.getDurationUnit())),a.onPotentialEffortChange(),a.endEdit(),!0},setEndDate:function(e,t,i,n){var r=this;r.propagateChanges(function(){return r.setEndDateWithoutPropagation(e,t,i)},function(e,t){e?r.rejectSegmentsProjection():r.commitSegmentsProjection(),n&&n.apply(this,arguments)})},setEndDateWithoutPropagation:function(e,t,i){var n,r,a=this,s=a.getTaskStore(!0);t=!1!==t,!0!==i&&!1!==i&&s?i=s.skipWeekendsDuringDragDrop:!0!==i&&!1!==i&&(i=!1),a.beginEdit();var o=a.getEndDate();if(e)if(r=a.getStartDate(),e<r&&!1===t&&(e=r),i&&(e=a.skipNonWorkingTime(e,!1)),!1!==t)n=a.getDuration(),Ext.isNumber(n)?(s&&a.isSegmented()&&e-o&&a.updateSegmentsDates({isForward:!1,endDate:e}),a.set(a.startDateField,a.calculateStartDate(e,n,a.getDurationUnit())),a.set(a.endDateField,e)):a.set(a.endDateField,e);else{var l=a.isMilestone();if(e<r&&a.set(a.startDateField,e),a.set(a.endDateField,e),a.constrainSegments(),r&&(a.set(a.durationField,a.calculateDuration(r,e,a.getDurationUnit())),l&&!a.isMilestone())){var d=a.skipNonWorkingTime(r,!0);d-r!=0&&a.set(a.startDateField,d)}}else a.set(a.durationField,null),a.set(a.endDateField,null),a.setSegments(null);return n=a.getDuration(),r=a.getStartDate(),e&&r&&(void 0===n||null===n)&&a.set(a.durationField,a.calculateDuration(r,e,a.getDurationUnit())),a.onPotentialEffortChange(),a.endEdit(),!0},setStartEndDate:function(e,t,i,n){var r=this;i=i||!1,r.propagateChanges(function(){return r.setStartEndDateWithoutPropagation(e,t,i)},function(e,t){e?r.rejectSegmentsProjection():r.commitSegmentsProjection(),n&&n.apply(this,arguments)})},setStartEndDateWithoutPropagation:function(e,t,i){var n=this,r=n.getTaskStore(!0);!0!==i&&!1!==i&&r?i=r.skipWeekendsDuringDragDrop:!0!==i&&!1!==i&&(i=!1),i&&(e=e&&n.skipNonWorkingTime(e,!0),(t=t&&n.skipNonWorkingTime(t,!1))<e&&(e=t));var a=n.getStartDate(),s=n.getEndDate();return n.beginEdit(),n.set(n.startDateField,e),n.set(n.endDateField,t),n.getTaskStore(!0)&&n.isSegmented()&&(e-a||t-s)&&n.updateSegmentsDates(),t-s&&n.constrainSegments(),n.set(n.durationField,n.calculateDuration(e,t,n.getDurationUnit())),n.onPotentialEffortChange(),n.endEdit(),!0},shift:function(e,t,i){var n=this;n.setStartEndDate(Sch.util.Date.add(n.getStartDate(),e,t),Sch.util.Date.add(n.getEndDate(),e,t),void 0,i)},getDuration:function(e){if(!e)return this.get(this.durationField);var t=this.getUnitConverter(),i=t.convertDurationToMs(this.get(this.durationField),this.get(this.durationUnitField));return t.convertMSDurationToUnit(i,e)},getEffort:function(e){var t=this.get(this.effortField)||0;if(!e)return t;var i=this.getUnitConverter(),n=i.convertDurationToMs(t,this.getEffortUnit());return i.convertMSDurationToUnit(n,e)},setEffort:function(e,t,i){var n=this;n.propagateChanges(function(){return n.setEffortWithoutPropagation(e,t)},function(e){e?n.rejectSegmentsProjection():n.commitSegmentsProjection(),i&&i.apply(this,arguments)})},setEffortWithoutPropagation:function(e,t){var i=this;switch(t=t||i.getEffortUnit(),i.beginEdit(),i.set(i.effortField,e),i.set(i.effortUnitField,t),i.getSchedulingMode()){case"EffortDriven":i.updateSpanBasedOnEffort();break;case"DynamicAssignment":i.updateAssignments()}return i.endEdit(),!0},getCalendarDuration:function(e){return this.getUnitConverter().convertMSDurationToUnit(this.getEndDate()-this.getStartDate(),e||this.get(this.durationUnitField))},setDuration:function(e,t,i){var n=this;n.propagateChanges(function(){return n.setDurationWithoutPropagation(e,t)},function(e){e?n.rejectSegmentsProjection():n.commitSegmentsProjection(),i&&i.apply(this,arguments)})},setDurationWithoutPropagation:function(e,t){var i=this;t=t||i.getDurationUnit();var n=i.isMilestone();if(i.beginEdit(),Ext.isNumber(e)&&!i.getStartDate()){var r=i.getTaskStore(!0),a=r&&r.getProjectStartDate()||Ext.Date.clearTime(new Date);i.setStartDateWithoutPropagation(a)}var s=null;if(this.constrainSegments({duration:e,unit:t}),Ext.isNumber(e)&&(s=i.calculateEndDate(i.getStartDate(),e,t)),i.set(i.endDateField,s),i.set(i.durationField,e),i.set(i.durationUnitField,t),i.isMilestone()!=n)if(n){var o=i.getStartDate();if(o){var l=i.skipNonWorkingTime(o,!0);l-o!=0&&i.set(i.startDateField,l)}}else if(s){var d=i.skipNonWorkingTime(s,!1);d-s!=0&&(i.set(i.startDateField,d),i.set(i.endDateField,d))}return i.onPotentialEffortChange(),i.endEdit(),!0},calculateStartDate:function(e,t,i,n){if(i=i||this.getDurationUnit(),!t)return e;n=Ext.apply({endDate:e,isForward:!1,resources:this.hasResources()},n);var r=this.getSchedulingMode();if(this.getTaskStore(!0)&&"FixedDuration"!=r&&"DynamicAssignment"!=r&&"EffortDriven"!=r){var a,s=this.getUnitConverter().convertDurationToMs(t,i);return this.forEachAvailabilityInterval(n,function(e,t){var i=t-e;if(i>=s)return a=new Date(t-s),!1;var n=new Date(t).getTimezoneOffset()-new Date(e).getTimezoneOffset();s-=i+60*n*1e3}),a}return this.getCalendar().calculateStartDate(e,t,i)},recalculateEndDate:function(e){var t,i,n=this;return e=e||n.getStartDate(),e&&"EffortDriven"==n.getSchedulingMode()?t=n.calculateEffortDrivenEndDate(e,n.getEffort()):(i=n.getDuration(),t=e&&Ext.isNumber(i)?n.calculateEndDate(e,i,n.getDurationUnit()):n.getEndDate()),t},calculateEndDate:function(e,t,i,n){if(i=i||this.getDurationUnit(),!t)return e;n=Ext.apply({startDate:e},n);var r,a=this.getSchedulingMode();if(!this.getTaskStore(!0)||"FixedDuration"==a||"DynamicAssignment"==a||"EffortDriven"==a)return this.getCalendar().calculateEndDate(e,t,i);var s=this.getUnitConverter().convertDurationToMs(t,i);return n.resources=this.hasResources(),this.forEachAvailabilityInterval(n,function(e,t){var i=t-e;if(i>=s)return r=new Date(e+s),!1;var n=new Date(e).getTimezoneOffset()-new Date(t).getTimezoneOffset();s-=i+60*n*1e3}),r},calculateDuration:function(e,t,i,n){if(i=i||this.getDurationUnit(),!e||!t)return 0;if(this.getTaskStore(!0)){var r=0
;return this.forEachAvailabilityInterval(Ext.apply({startDate:e,endDate:t,resources:this.hasResources()},n),function(e,t){var i=new Date(e).getTimezoneOffset()-new Date(t).getTimezoneOffset();r+=t-e+60*i*1e3}),this.getUnitConverter().convertMSDurationToUnit(r,i)}return this.getCalendar().calculateDuration(e,t,i)},isCalendarApplicable:function(e){var t=this.getStartDate();if(!t)return!0;var i=this.getTaskStore(!0);if(!i)return!0;var n=Sch.util.Date.add(t,"d",i&&i.availabilitySearchLimit||1825),r=this.getAssignments(),a=[];if(Ext.Array.forEach(r,function(e){var t=e.getResource();t&&a.push(t.getCalendar())}),!a.length)return!0;for(var s=Gnt.data.Calendar.getCalendar(e),o=0,l=a.length;o<l;o++)if(s.isAvailabilityIntersected(a[o],t,n))return!0;return!1},forEachAvailabilityInterval:function(e,t,i){t=t||e.fn,i=i||e.scope||this;var n,r,a=this,s=e.startDate,o=e.endDate,l=e.includeEmptyIntervals,d=e.resources,c=e.segments||!1!==e.segments,h=!1!==e.isForward,u=Sch.util.Date,g=this.getStartDate(),f=this.getEndDate(),p=this.getTaskStore(!0);if(h){if(!s)throw new Error("forEachAvailabilityInterval: `startDate` is required when `isForward` is true");o||(o=u.add(s,"d",e.availabilitySearchLimit||p&&p.availabilitySearchLimit||1825)),n=new Date(s)}else{if(!o)throw new Error("forEachAvailabilityInterval: `endDate` is required when `isForward` is false");s||(s=u.add(o,"d",-(e.availabilitySearchLimit||p&&p.availabilitySearchLimit||1825))),n=new Date(o)}var m=this.getOwnCalendar(),v=this.getProjectCalendar(),S={},y=[];if(d){var E=!1,x=e.assignments,D=function(e){var t=e.getId(),i=x&&Ext.Array.findBy(x,function(e){return e.getResourceId()==t})||a.getAssignmentFor(e),n=e.getCalendar(),r=n.getCalendarId();S[r]||(S[r]=[],y.push(n)),S[r].push({assignment:i,resourceId:t,units:i&&i.getUnits()}),E=!0};if(!0!==d?Ext.each(d,D):Ext.Array.forEach(this.getAssignments(),function(e){var t=e.getResource();t&&D(t)}),!E)return}else m=m||v;c&&(r=Ext.isArray(c)?c:this.getSegments());for(var T,C,k,w,b,F;h?n<o:n>s;){var R={},A=[],I=n-(h?0:1);if(m){var P=m.getAvailabilityIntervalsFor(I);for(C=0,k=P.length;C<k;C++)w=P[C],b=w.startDate-0,F=w.endDate-0,R[b]||(R[b]=[],A.push(b)),R[b].push({type:"00-taskAvailailabilityStart",typeBackward:"01-taskAvailailabilityStart"}),A.push(F),R[F]=R[F]||[],R[F].push({type:"01-taskAvailailabilityEnd",typeBackward:"00-taskAvailailabilityEnd"})}if(r){var M,L;h?(M=n,L=u.getStartOfNextDay(n)):(M=u.getEndOfPreviousDay(n),L=n);var V=this.getSegmentIntervalsForRange(M,L,r);if(V)for(T=0,k=V.length;T<k;T++)b=V[T][0],F=V[T][1],R[b]||(R[b]=[],A.push(b)),R[b].push({type:"04-taskSegmentStart",typeBackward:"05-taskSegmentStart"}),A.push(F),R[F]=R[F]||[],R[F].push({type:"05-taskSegmentEnd",typeBackward:"04-taskSegmentEnd"})}var B;for(T=0,k=y.length;T<k;T++){var W=y[T],O=W.getAvailabilityIntervalsFor(I);for(B=S[W.getCalendarId()],C=0;C<O.length;C++)w=O[C],b=w.startDate-0,F=w.endDate-0,R[b]||(R[b]=[],A.push(b)),R[b].push({type:"02-resourceAvailailabilityStart",typeBackward:"03-resourceAvailailabilityStart",resources:B}),R[F]||(R[F]=[],A.push(F)),R[F].push({type:"03-resourceAvailailabilityEnd",typeBackward:"02-resourceAvailailabilityEnd",resources:B})}A.sort(function(e,t){return e-t});var N,G,H,z,U=!g||!f||n>=g&&n<=f,j=!1,Y=!1,_={},X=0;if(h)for(T=0,k=A.length;T<k;T++){for(N=R[A[T]],N.sort(function(e,t){return e.type<t.type?1:-1}),C=0;C<N.length;C++)switch(G=N[C],G.type){case"00-taskAvailailabilityStart":j=!0;break;case"01-taskAvailailabilityEnd":j=!1;break;case"02-resourceAvailailabilityStart":for(B=G.resources,H=0,z=B.length;H<z;H++)_[B[H].resourceId]=B[H],X++;break;case"03-resourceAvailailabilityEnd":for(B=G.resources,H=0,z=B.length;H<z;H++)delete _[B[H].resourceId],X--;break;case"04-taskSegmentStart":Y=!0;break;case"05-taskSegmentEnd":Y=!1}if((j||!m)&&(!r||!U||Y)&&(!d||X||l)){if(b=A[T],F=A[T+1],b>=o||F<=s)continue;if(b<s&&(b=s-0),F>o&&(F=o-0),!1===t.call(i,b,F,_))return!1}}else for(T=A.length-1;T>=0;T--){for(N=R[A[T]],N.sort(function(e,t){return e.typeBackward<t.typeBackward?1:-1}),C=0;C<N.length;C++)switch(G=N[C],G.typeBackward){case"00-taskAvailailabilityEnd":j=!0;break;case"01-taskAvailailabilityStart":j=!1;break;case"02-resourceAvailailabilityEnd":for(B=G.resources,H=0,z=B.length;H<z;H++)_[B[H].resourceId]=B[H],X++;break;case"03-resourceAvailailabilityStart":for(B=G.resources,H=0,z=B.length;H<z;H++)delete _[B[H].resourceId],X--;break;case"04-taskSegmentEnd":Y=!0;break;case"05-taskSegmentStart":Y=!1}if((j||!m)&&(!r||!U||Y)&&(!d||X||l)){if(b=A[T-1],F=A[T],b>o||F<=s)continue;if(b<s&&(b=s-0),F>o&&(F=o-0),!1===t.call(i,b,F,_))return!1}}n=h?u.getStartOfNextDay(n):u.getEndOfPreviousDay(n)}},forEachAvailabilityIntervalWithResources:function(e,t,i){e.resources||(e.resources=!0),this.forEachAvailabilityInterval.apply(this,arguments)},calculateEffortDrivenEndDate:function(e,t,i){if(!t)return e;var n=this.getUnitConverter().convertDurationToMs(t,i||this.getEffortUnit()),r=new Date(e);return this.forEachAvailabilityIntervalWithResources({startDate:e},function(e,t,i){var a=0;for(var s in i)a+=i[s].units;var o=t-e,l=a*o/100;if(l>=n)return r=new Date(e+n/l*o),!1;n-=l}),r},refreshCalculatedParentNodeData:function(){var e=this.autoCalculatePercentDoneForParentTask,t=this.autoCalculateEffortForParentTask,i=this.childNodes,n=i.length,r={};if(n>0&&(t||e)){for(var a=0,s=0,o=0,l=0;l<n;l++){var d=i[l];if(d.parentNode){var c=d.isLeaf();if(t&&(a+=d.getEffort("MILLI")),e){var h=c?d.getDuration("MILLI")||0:d.childTasksDuration;s+=h,o+=c?h*(d.getPercentDone()||0):d.completedChildTasksDuration}}}if(t&&this.getEffort("MILLI")!=a&&(r.Effort=!0,this.setEffortWithoutPropagation(this.getUnitConverter().convertMSDurationToUnit(a,this.getEffortUnit()))),e){this.childTasksDuration=s,this.completedChildTasksDuration=o;var u=s?o/s:0;this.getPercentDone()!=u&&(r.PercentDone=!0,this.setPercentDone(u))}}var g,f;if(!this.isRoot()&&n>0&&!this.isManuallyScheduled()){for(var p=new Date(-864e13),m=new Date(864e13),v=new Date(864e13),S=new Date(-864e13),y=0;y<n;y++){var E=i[y];v=Sch.util.Date.min(v,E.getStartDate()||v),S=Sch.util.Date.max(S,E.getEndDate()||S)}if(S<v&&v<m&&S>p){var x;x=S,S=v,v=x}g=r.StartDate=v-m!=0&&this.getStartDate()-v!=0,f=r.EndDate=S-p!=0&&this.getEndDate()-S!=0,g&&f?this.setStartEndDateWithoutPropagation(v,S,!1):g?this.setStartDateWithoutPropagation(v,!1,!1):f&&this.setEndDateWithoutPropagation(S,!1,!1)}return r},recalculateParents:function(){var e=this.parentNode;e&&(e.refreshCalculatedParentNodeData(),!this.getTaskStore().cascading&&e.recalculateParents())},recalculateAllParents:function(){var e,t=this.parentNode,i=!1;if(t){e=t.refreshCalculatedParentNodeData();for(var n in e)if(e[n]){i=!0;break}i&&t.recalculateAllParents()}},isMilestone:function(e){if(e)return this.isBaselineMilestone();if(!this.get("leaf")){var t=this.getStartDate(),i=this.getEndDate();if(t&&i)return i-t==0}return 0===this.getDuration()},convertToMilestone:function(e){var t=this;t.propagateChanges(function(){return t.convertToMilestoneWithoutPropagation()},e)},convertToMilestoneWithoutPropagation:function(){var e=this,t=!1;return e.isMilestone()||(e.setStartDateWithoutPropagation(e.getEndDate(),!1),e.setDurationWithoutPropagation(0),t=!0),t},convertToRegular:function(e){var t=this;t.propagateChanges(function(){return t.convertToRegularWithoutPropagation()},e)},convertToRegularWithoutPropagation:function(){var e,t,i=this,n=!1;return i.isMilestone()&&(e=i.get(i.durationUnitField),t=i.calculateStartDate(i.getStartDate(),1,e),i.setDurationWithoutPropagation(1,e),i.setStartDateWithoutPropagation(t,!0,!1,!1),n=!0),n},isBaselineMilestone:function(){var e=this.getBaselineStartDate(),t=this.getBaselineEndDate();return!(!e||!t)&&t-e==0},markAsParent:function(){var e=this;e.isSegmented()&&e.setSegmentsWithoutPropagation(null),e.set("leaf",!1)},getDurationUnit:function(){return this.get(this.durationUnitField)||"d"},getEffortUnit:function(){return this.get(this.effortUnitField)||"h"},getBaselinePercentDone:function(){return this.get(this.baselinePercentDoneField)||0},isPersistable:function(){var e=this.parentNode;return!e||!e.phantom||e.isRoot()},getResources:function(){var e=this,t=e.getAssignmentStore();return t&&t.getResourcesForEvent(e)||[]},getAssignments:function(){var e=this,t=e.getAssignmentStore();return t&&t.getAssignmentsForTask(e)||[]},hasAssignments:function(){return this.getAssignments().length>0},hasResources:function(){var e,t,i=this.getAssignments(),n=!1;for(e=0,t=i.length;!n&&e<t;e++)n=!!i[e].getResource();return n},getAssignmentFor:function(e){var t=this,i=t.getAssignmentStore();return i&&i.getAssignmentForEventAndResource(t,e)||null},isAssignedTo:function(e){var t=this,i=t.getAssignmentStore();return i&&i.isTaskAssignedToResource(t,e)||!1},assign:function(e,t,i){var n,r,a=this;return a.propagateChanges(function(){return a.assignWithoutPropagation(e,t,function(e,t){r=e,n=t})},function(e,t){e&&r&&r(),i&&i(e,t)}),n},assignWithoutPropagation:function(e,t,i){var n,r,a=this,s=[],o=a.getTaskStore(),l=o.getAssignmentStore(),d=o.getResourceStore();return t=t||100,!a.getAssignmentFor(e)||Ext.Error.raise("Resource can't be assigned twice to the same task"),e instanceof Gnt.model.Resource&&-1==d.indexOf(e)?(r=e.getId(),d.add(e),s.push(function(){d.remove(e)})):e instanceof Gnt.model.Resource?r=e.getId():d.indexOfId(e)>=0?r=e:Ext.Error.raise("Can't assign resource to a task, task's resource store doesn't contain resource id given"),n=l.assignTaskToResource(a,r,t),s.push(function(){l.unassignTaskFromResource(a,r)}),i&&i(function(){Ext.Array.forEach(s,function(e){e()})},n[0]),!0},unassign:function(){return this.unAssign.apply(this,arguments)},unAssign:function(e,t){var i,n=this;n.propagateChanges(function(){return n.unassignWithoutPropagation(e,function(e){i=e})},function(e,n){e&&i&&i(),t&&t(e,n)})},unassignWithoutPropagation:function(e,t){var i,n=this,r=e instanceof Gnt.model.Resource?e.getId():e,a=n.getAssignmentStore(),s=n.getAssignmentFor(r);return s||Ext.Error.raise("Can't unassign resource `"+r+"` from task `"+n.getId()+"` resource is not assigned to the task!"),i=a.indexOf(s),a.unassignTaskFromResource(n,e),t&&t(function(){a.insert(i,s)}),!0},reassign:function(e,t,i){var n,r,a=this;a.propagateChanges(function(){var i=a.getAssignmentFor(e).getUnits();return a.unassignWithoutPropagation(e,function(e){n=e}),a.assignWithoutPropagation(t,i,function(e){r=e}),!0},function(e,t){e&&(r&&r(),n&&n()),i&&i(e,t)})},linkTo:function(e,t,i,n){var r,a=this;a.propagateChanges(function(){return a.linkToWithoutPropagation(e,t,function(e){r=e},n)},function(e,t){e&&r&&r(),i&&i(e,t)})},linkToWithoutPropagation:function(e,t,i,n){var r,a=this,s=a.getId(),o=a.getTaskStore(),l=a.getDependencyStore();return e=e instanceof Gnt.model.Task?e.getId():e,t=(null===t||void 0===t)&&Gnt.model.Dependency.Type.EndToStart||t,-1!=o.getModelById(e instanceof Gnt.model.Task?e.getId():e)||Ext.Error.raise("Can't link task `"+s+"` to task with id `"+e+"` the task is not present in the task store!"),r=new l.model,r.setSourceId(s),r.setTargetId(e),r.setType(t),!l.isValidDependency(r)||n&&!1===n(r)||l.add(r),i&&i(function(){l.remove(r)}),a},unlinkFrom:function(e,t){var i,n=this;n.propagateChanges(function(){return n.unlinkFromWithoutPropagation(e,function(e){i=e})},function(e,n){e&&i&&i(),t&&t(e,n)})},unlinkFromWithoutPropagation:function(e,t){var i,n,r=this,a=r.getId(),s=r.getDependencyStore();return e=e instanceof Gnt.model.Task?e.getId():e,i=s.getByTaskIds(e,a),i||Ext.Error.raise("Can't unlink task '"+a+"' from task '"+e+", tasks are not linked!"),n=s.indexOf(i),s.remove(i),t&&t(function(){s.insert(n,i)}),r},calculateEffort:function(e,t,i){if(!e||!t)return 0;var n=0;return this.forEachAvailabilityIntervalWithResources({startDate:e,endDate:t},function(e,t,i){var r=0;for(var a in i)r+=i[a].units;n+=(t-e)*r/100}),this.getUnitConverter().convertMSDurationToUnit(n,i||this.getEffortUnit())},updateAssignments:function(){var e=this.getStartDate(),t=this.getEndDate();if(e&&t){var i=0;if(this.forEachAvailabilityIntervalWithResources({startDate:e,endDate:t},function(e,t,n){for(var r in n)i+=t-e}),i){var n=this.getEffort(Sch.util.Date.MILLI);Ext.Array.each(this.getAssignments(),function(e){e.setUnits(n/i*100)})}}},updateEffortBasedOnDuration:function(){this.setEffortWithoutPropagation(this.calculateEffort(this.getStartDate(),this.getEndDate()))},updateEffortBasedOnSpan:function(){this.updateEffortBasedOnDuration()},updateSpanBasedOnEffort:function(){this.setStartEndDateWithoutPropagation(this.getStartDate(),this.recalculateEndDate())},onPotentialEffortChange:function(){switch(this.getSchedulingMode()){case"FixedDuration":this.updateEffortBasedOnDuration();break;case"DynamicAssignment":this.updateAssignments()}},onAssignmentMutation:function(){switch(this.getSchedulingMode()){case"FixedDuration":this.updateEffortBasedOnDuration();break;case"EffortDriven":this.updateSpanBasedOnEffort();break;case"DynamicAssignment":this.updateAssignments()}},onAssignmentStructureMutation:function(){switch(this.getSchedulingMode()){case"FixedDuration":this.updateEffortBasedOnDuration();break;case"EffortDriven":this.updateSpanBasedOnEffort();break;case"DynamicAssignment":this.updateAssignments()}},adjustToCalendar:function(e){var t=this;t.propagateChanges(function(){return t.adjustToCalendarWithoutPropagation()},e)},adjustToCalendarWithoutPropagation:function(){var e=this,t=e.getTaskStore(!0),i=!1;return e.taskStore&&(e.get("leaf")?(e.setStartDateWithoutPropagation(e.getStartDate(),!0,t.skipWeekendsDuringDragDrop),e.alignByIncomingDependenciesWithoutPropagation(t,null),i=this):e.getStartDate()&&e.getEndDate()&&(e.set(e.durationField,e.calculateDuration(e.getStartDate(),e.getEndDate(),e.getDurationUnit())),i=this)),i},isReadOnly:function(e){var t;return e||(t=this.getProject()),t&&t.getReadOnly()||this.getReadOnly()},isEditable:function(e){if(!this.isProject){var t=this.getProject();if(t&&t.isReadOnly())return!1}if(e===this.readOnlyField)return!0;if(this.isReadOnly(!0))return!1;if(!this.isLeaf()){if(e===this.effortField&&this.autoCalculateEffortForParentTask)return!1;if(e===this.percentDoneField&&this.autoCalculatePercentDoneForParentTask)return!1}return(e!==this.durationField&&e!==this.endDateField||"EffortDriven"!==this.getSchedulingMode())&&(e!==this.effortField||"FixedDuration"!==this.getSchedulingMode())},isDraggable:function(){return this.getDraggable()},isResizable:function(){return this.getResizable()},getWBSCode:function(){for(var e=[],t=this;t.parentNode;)e.push(t.data.index+1),t=t.parentNode;return e.reverse().join(".")},resetTotalCount:function(e){for(var t=this;t;)t.totalCount=e?-1:null,t=t.parentNode},getTotalCount:function(){var e=this.totalCount,t=-1==e;if(null==e||t){var i=this.childNodes;e=i.length;for(var n=0,r=i.length;n<r;n++)e+=i[n].getTotalCount();if(t)return e;this.totalCount=e}return e},getPreviousSiblingsTotalCount:function(){for(var e=this.previousSibling,t=this.data.index;e;)t+=e.getTotalCount(),e=e.previousSibling;return t},getPredecessorsCount:function(){return this.getPreviousSiblingsTotalCount.apply(this,arguments)},getSequenceNumber:function(){for(var e=0,t=this;t.parentNode;)e+=t.getPredecessorsCount()+1,t=t.parentNode;return e},getBySequenceNumber:function(e){var t,i,n=null;if(0===e)n=this;else if(e>0&&e<=this.getTotalCount()){e--;for(var r=0,a=this.childNodes.length;r<a;r++){if(t=this.childNodes[r],i=t.getTotalCount(),!(e>i)){t=this.childNodes[r],n=t.getBySequenceNumber(e);break}e-=i+1}}return n},getDisplayStartDate:function(e,t,i,n,r){return e=e||Ext.Date.defaultFormat,arguments.length<3&&(i=this.getStartDate(),arguments.length<2&&(t=!0)),i&&t&&this.isMilestone(r)&&i-Ext.Date.clearTime(i,!0)==0&&!Ext.Date.formatContainsHourInfo(e)&&(i=Sch.util.Date.add(i,Sch.util.Date.MILLI,-1)),n?i:i?Ext.util.Format.date(i,e):""},getDisplayEndDate:function(e,t,i,n,r){return e=e||Ext.Date.defaultFormat,arguments.length<3&&(i=this.getEndDate(),arguments.length<2&&(t=!0)),!i||this.isMilestone(r)&&!t||i-Ext.Date.clearTime(i,!0)!=0||Ext.Date.formatContainsHourInfo(e)||(i=Sch.util.Date.add(i,Sch.util.Date.MILLI,-1)),n?i:i?Ext.util.Format.date(i,e):""},copy:function(){var e=this.callParent(arguments),t=e.getSegments();if(t)for(var i=0;i<t.length;i++){var n=t[i];t[i]=n.copy(n.getId(),!1)}return e},fullCopy:function(e){var t=this.callParent(arguments);return t.taskStore=this.getTaskStore(),t},commit:function(){this.callParent(arguments),this.commitSegments()},reject:function(){this.callParent(arguments),this.rejectSegments()},isUnscheduled:function(){return!this.getStartDate()||!this.getEndDate()},getReadOnly:Ext.emptyFn,setReadOnly:Ext.emptyFn},function(){Ext.data.NodeInterface.decorate(this),this.override({remove:function(){var e,t=this,i=t.parentNode,n=t.getTaskStore(!0);return e=t.callParent(arguments),i&&n&&n.recalculateParents&&i.convertEmptyParentToLeaf&&!i.isRoot()&&0===i.childNodes.length?i.set("leaf",!0):i&&n&&n.recalculateParents&&!n.suspendAutoRecalculateParents&&!i.isRoot()&&i.childNodes.length>0&&(i.refreshCalculatedParentNodeData(),i.recalculateParents()),e},insertBefore:function(e,t){if(e=this.createNode(e)){var i=this.getTaskStore(!0),n=i&&i.getRoot(),r=this.phantomParentIdField,a=this!==n&&this.phantom,s=!!e.parentNode,o=this.getId();a&&(this.data[this.phantomIdField]=o),o!==e.data[r]&&(e.phantom||(e.modified=e.modified||{},e.modified[r]=e.data[r]),e.data[r]=a?o:null);var l=t&&t.get("index");this.resetTotalCount(s),s&&e.hasDependencies()&&e.removeDependenciesToParents(this);var d=this.callParent(arguments);return s&&(this.hasDependencies()&&(i.getDependencyStore().resetMethodsCache(),this.removeInvalidDependencies()),this.resetTotalCount()),t&&t.get("index")!=l&&(t.modified=t.modified||{},t.modified.index=l),d}},appendChild:function(e,t,i){e=e instanceof Array?e:[e];for(var n=this.getTaskStore(!0),r=n&&n.getRoot(),a=!1,s=this.phantomParentIdField,o=this!==r&&this.phantom,l=this.getId(),d=0,c=0;c<e.length;c++){var h=this.createNode(e[c]);h&&(d++,e[c]=h,h.parentNode&&(a=!0,h.hasDependencies()&&h.removeDependenciesToParents(this)),l!==h.data[s]&&(h.phantom||(h.modified=h.modified||{},h.modified[s]=h.data[s]),h.data[s]=o?l:null))}if(d){o&&(this.data[this.phantomIdField]=l),this.resetTotalCount(a);var u=this.callParent([e.length>1?e:e[0],t,i]);return a&&(this.hasDependencies()&&(n.getDependencyStore().resetMethodsCache(),this.removeInvalidDependencies()),this.resetTotalCount()),this.beginEdit(),this.markAsParent(),this.set(this.schedulingModeField,"Normal"),this.endEdit(),u}},removeChild:function(e,t,i,n){var r,a=this,s=!a.removeChildIsCalledFromReplaceChild&&a.convertEmptyParentToLeaf&&1==a.childNodes.length,o=a.getTaskStore(!0);return a.resetTotalCount(),a.removeChildIsCalledFromReplaceChild=!1,r=a.callParent(arguments),n&&a.resetTotalCount(),o&&o.recalculateParents&&!o.suspendAutoRecalculateParents&&a.refreshCalculatedParentNodeData(),s&&!a.isRoot()&&a.set("leaf",!0),r},replaceChild:function(){this.removeChildIsCalledFromReplaceChild=!0,this.callParent(arguments)},removeAll:function(){this.resetTotalCount(),this.callParent(arguments)},createNode:function(e){var t,i=this,n=i.getTaskStore(!0),r=n&&n.getRoot();if(n){t=n.getProxy().getReader();var a=t.getChildType;t.getChildType=function(){return a.apply(this,arguments)||this.getModel()}}if(e=this.callParent(arguments),n&&t&&delete t.getChildType,!n||r===this||!e.isProject){var s=n&&n.autoNormalizeNodes&&!e.normalized&&!e.normalizeScheduled;if(e=this.callParent(arguments),s){var o=e.updateInfo;e.updateInfo=function(){o.apply(this,arguments),delete e.updateInfo,e.normalize()},e.normalizeScheduled=!0}return e}}})}),Ext.define("Gnt.model.Project",{extend:Gnt.model.Task,alias:"gntmodel.pms",isProject:!0,descriptionField:"Note",allowDependenciesField:"AllowDependencies",customizableFields:[{name:"Description",type:"string"},{name:"AllowDependencies",persist:!1,type:"bool",defaultValue:!1}],recognizedSchedulingModes:["Normal"],isEditable:function(e){switch(e){case this.nameField:case this.startDateField:case this.endDateField:case this.durationField:case this.durationUnitField:case this.allowDependenciesField:case this.descriptionField:case this.allowDependenciesField:return this.callParent(arguments);default:return!1}}}),Ext.define("Gnt.patches.TaskStore",{extend:Ext.Mixin,onClassMixedIn:function(e){Ext.getVersion().isGreaterThan("5.1.1")&&Ext.override(e,{onTasksLoad:function(){this._refreshCalled||this.onTasksLoaded(),this.un("refresh",this.onTaskStoreRefresh,this)},onTasksBeforeLoad:function(){this._refreshCalled=!1,this.on("refresh",this.onTaskStoreRefresh,this,{priority:100})},onTaskStoreRefresh:function(){this._refreshCalled=!0,this.onTasksLoaded()},setupListeners:function(){this.callParent(arguments),this.on("beforeload",this.onTasksBeforeLoad,this,{priority:100}),this.un({load:this.onTasksLoaded,rootchanged:this.onTasksLoaded,scope:this}),this.on({load:this.onTasksLoad,rootchanged:this.onTasksLoad,scope:this})}})}}),Ext.define("Gnt.data.mixin.ProjectableStore",function(){function e(e,t){return e.byInternalIdMap&&e.byInternalIdMap[t]||e.getByInternalId(t)}function t(){var e=this,t=e.projectionStack;return t&&t[t.length-1]}function i(){var e=this,t=e.projectionStack;return t&&t.length||0}function n(e){var t,i,n;for(e=[].concat(e),n=!1,t=0,i=e.length;!n&&t<i;t++)n=e[t].isProjected();return n}function r(){var e,t,i=this,n=i.projectionStack;n?(t=n[n.length-1],e={},Ext.Object.each(t,function(t,i){var n=function(){};n.prototype=i,e[t]=new n}),n.push(e)):i.projectionStack=[{}]}function a(){var t,i,n,r,a,s,o,l=this,d=l.projectionStack;if(1===d.length){i=d[0],l.projectionStack=null;for(s in i)if(i.hasOwnProperty(s)&&(o=e(l,s))){r=i[s],a=!1;for(n in r)if(r.hasOwnProperty(n)){a=!0;break}a&&o.set(r)}}else{i=d.pop(),t=d[d.length-1];for(s in i)i.hasOwnProperty(s)&&(t.hasOwnProperty(s)?t[s]=Ext.apply(t[s],i[s]):t[s]=i[s])}this.fireEvent("projectioncommit",this,d&&d[d.length-1],i)}function s(){var e=this,t=e.projectionStack,i=t.pop();0===t.length&&(e.projectionStack=null),this.fireEvent("projectionreject",this,t&&t[t.length-1],i)}return{projectionStack:null,getProjection:t,areProjected:n,getProjectionLevel:i,startProjection:r,commitProjection:a,rejectProjection:s}}),Ext.define("Gnt.data.TaskStore",{extend:Ext.data.TreeStore,mixins:[Gnt.patches.TaskStore,Sch.data.mixin.FilterableTreeStore,Sch.data.mixin.UniversalModelGetter,Sch.data.mixin.CacheHintHelper,Sch.data.mixin.EventStore,Gnt.data.mixin.ProjectableStore],model:"Gnt.model.Task",alias:"store.gantt_taskstore",storeId:"tasks",proxy:"memory",typeProperty:"TaskType",calendarManager:null,calendar:null,dependencyStore:null,resourceStore:null,assignmentStore:null,weekendsAreWorkdays:!1,cascadeChanges:!0,batchSync:!0,recalculateParents:!0,skipWeekendsDuringDragDrop:!0,cascadeDelay:0,moveParentAsGroup:!0,enableDependenciesForParentTasks:!0,availabilitySearchLimit:1825,cycleResolutionStrategy:"cut",autoNormalizeNodes:!0,cascading:!1,isFillingRoot:!1,isSettingRoot:!1,earlyStartDates:null,earlyEndDates:null,lateStartDates:null,lateEndDates:null,lastTotalTimeSpan:null,suspendAutoRecalculateParents:0,suspendAutoCascade:0,currentCascadeBatch:null,batchCascadeLevel:0,fillTasksWithDepInfoCounter:0,dependenciesCalendar:"pms",pendingDataUpdates:null,constructor:function(e){e=e||{};var t="calendarManager"in e?e.calendarManager:this.calendarManager;delete e.calendarManager,this.setCalendarManager(t);var i=e.calendar||this.calendar;if(!i){var n={};e.hasOwnProperty("weekendsAreWorkdays")?n.weekendsAreWorkdays=e.weekendsAreWorkdays:this.self.prototype.hasOwnProperty("weekendsAreWorkdays")&&this.self!=Gnt.data.TaskStore&&(n.weekendsAreWorkdays=this.weekendsAreWorkdays),this.calendarManager&&(i=this.calendarManager.getProjectCalendar()),i=i&&Ext.data.StoreManager.lookup(i)||new Gnt.data.Calendar(n)}var r=e.dependencyStore||this.dependencyStore;r=r&&Ext.data.StoreManager.lookup(r)||Ext.create("Gnt.data.DependencyStore"),delete e.dependencyStore;var a=e.resourceStore||this.resourceStore;a=a&&Ext.data.StoreManager.lookup(a)||Ext.create("Gnt.data.ResourceStore"),delete e.resourceStore;var s=e.assignmentStore||this.assignmentStore;s=s&&Ext.data.StoreManager.lookup(s)||Ext.create("Gnt.data.AssignmentStore",{resourceStore:a}),delete e.assignmentStore,i&&(delete e.calendar,this.setCalendar(i,!0,!0)),this.resetEarlyDates(!0),this.resetLateDates(!0),this.pendingDataUpdates={recalculateParents:{}};var o=e.root||this.root;this.root=null,delete e.root,this.callParent([e]),this.setResourceStore(a),this.setAssignmentStore(s),this.setDependencyStore(r),o&&this.setRoot(o),this.setupListeners(),this.fillTasksWithDepInfo();var l=this.getRoot();l&&this.autoNormalizeNodes&&l.normalizeParent(),this.autoSync&&this.batchSync&&(this.sync=Ext.Function.createBuffered(this.sync,500)),this.initTreeFiltering()},setCalendarManager:function(e){return this.calendarManagerListeners&&this.calendarManagerListeners.destroy(),e=e&&Ext.data.StoreManager.lookup(e),this.calendarManager=e,e&&(this.projectCalendarSet=Boolean(e.getProjectCalendar()),this.calendarManagerListeners=e.on({projectcalendarset:function(e,t){this.settingCalendar||(this.setCalendar(t,!this.projectCalendarSet),this.projectCalendarSet=!0)},scope:this,destroyable:!0})),e},setupListeners:function(){this.on({nodeappend:this.onMyNodeAdded,nodeinsert:this.onMyNodeAdded,update:this.onTaskUpdated,scope:this}),this.on({noderemove:this.onTaskRemoved,nodemove:this.onTaskMoved,write:this.onTaskStoreWrite,sort:this.onTasksSorted,load:this.onTasksLoaded,rootchange:this.onTasksLoaded,scope:this,priority:100})},createResourceEventsCache:Ext.emptyFn,createIdConsistencyManager:function(){var e=this;return new Gnt.data.util.IdConsistencyManager({eventStore:e,resourceStore:e.getResourceStore(),assignmentStore:e.getAssignmentStore(),dependencyStore:e.getDependencyStore()})},createModelPersistencyManager:function(){var e=this;return new Gnt.data.util.ModelPersistencyManager({eventStore:e,resourceStore:e.getResourceStore(),assignmentStore:e.getAssignmentStore(),dependencyStore:e.getDependencyStore()})},fillNode:function(e,t){e.isRoot()&&(this.isSettingRoot=!0),this.callParent(arguments),e.isRoot()&&(this.isSettingRoot=!1)},onTasksLoaded:function(){var e=this.getRoot();this.fillTasksWithDepInfoCounter=1,this.fillTasksWithDepInfo(),e&&this.autoNormalizeNodes&&e.normalizeParent()},load:function(e){this.un("noderemove",this.onTaskRemoved,this),this.un("nodeappend",this.onMyNodeAdded,this),this.un("update",this.onTaskUpdated,this),this.callParent(arguments),this.on("noderemove",this.onTaskRemoved,this),this.on("nodeappend",this.onMyNodeAdded,this),this.on("update",this.onTaskUpdated,this)},setProxy:function(){if(this.callParent(arguments),this.typeProperty){var e=this,t=e.getProxy()&&e.getProxy().getReader();t&&!t.getTypeProperty()&&t.setTypeProperty(e.typeProperty)}},setRoot:function(e){var t=this,i=this.count()&&this.getRoot();this.isSettingRoot=!0,Ext.apply(e,{calendar:t.calendar,taskStore:t,dependencyStore:t.dependencyStore,phantom:!1,dirty:!1});var n=this.callParent(arguments);return this.isSettingRoot=!1,i&&i.cascadeBy(function(e){e.setTaskStore(null)}),n},getDependencyStore:function(){return this.dependencyStore},fillTasksWithDepInfo:function(){if(this.getRoot()){var e=this.getDependencyStore();this.fillTasksWithDepInfoCounter++>0&&this.forEachTaskUnordered(function(e){e.successors=[],e.predecessors=[]}),e&&e.each(function(e){var t=e.getSourceTask(),i=e.getTargetTask();t&&i&&(t.successors.push(e),i.predecessors.push(e))})}},setDependencyStore:function(e){var t=this,i=t.dependencyStore,n={add:t.onDependencyAdd,update:t.onDependencyUpdate,remove:t.onDependencyDelete,scope:t};i&&i.isStore&&(i.un(n),i.setTaskStore(null),t.idConsistencyManager&&t.idConsistencyManager.setDependencyStore(null),t.modelPersistencyManager&&t.modelPersistencyManager.setDependencyStore(null)),t.dependencyStore=e&&Ext.StoreMgr.lookup(e)||null,t.dependencyStore&&(t.modelPersistencyManager&&t.modelPersistencyManager.setDependencyStore(t.dependencyStore),t.idConsistencyManager&&t.idConsistencyManager.setDependencyStore(t.dependencyStore),t.dependencyStore.setTaskStore(t),t.dependencyStore.on(n),t.fillTasksWithDepInfo()),(i||e)&&i!==e&&t.events&&t.fireEvent("dependencystorechange",t,e,i)},getResourceStore:function(){return this.resourceStore||null},setResourceStore:function(e){var t=this,i=t.resourceStore;i&&i.isStore&&(i.setTaskStore(null),t.idConsistencyManager&&t.idConsistencyManager.setResourceStore(null),t.modelPersistencyManager&&t.modelPersistencyManager.setResourceStore(null)),t.resourceStore=e&&Ext.StoreMgr.lookup(e)||null,t.resourceStore&&(t.modelPersistencyManager&&t.modelPersistencyManager.setResourceStore(t.resourceStore),t.idConsistencyManager&&t.idConsistencyManager.setResourceStore(t.resourceStore),t.resourceStore.setTaskStore(t),t.resourceStore.normalizeResources()),(i||e)&&i!==e&&t.events&&t.fireEvent("resourcestorechange",t,e,i)},getAssignmentStore:function(){return this.assignmentStore||null},setAssignmentStore:function(e){var t=this,i=t.assignmentStore,n={add:t.onAssignmentStructureMutation,update:t.onAssignmentMutation,remove:t.onAssignmentStructureMutation,scope:t};i&&i.isStore&&(i.un(n),i.setTaskStore(null),t.idConsistencyManager&&t.idConsistencyManager.setAssignmentStore(null),t.modelPersistencyManager&&t.modelPersistencyManager.setAssignmentStore(null)),t.assignmentStore=e&&Ext.StoreMgr.lookup(e)||null,t.assignmentStore&&(t.modelPersistencyManager&&t.modelPersistencyManager.setAssignmentStore(t.assignmentStore),t.idConsistencyManager&&t.idConsistencyManager.setAssignmentStore(t.assignmentStore),e.setTaskStore(t),e.on(n)),(i||e)&&i!==e&&t.events&&t.fireEvent("assignmentstorechange",t,e,i)},adjustToCalendar:function(e,t){var i=this;if(i.resetEarlyDates(),i.resetLateDates(),e instanceof Gnt.model.Task)e.adjustToCalendar(t);else{Ext.isFunction(e)&&(t=e,e=[]);var n=i.getRoot(),r={};Ext.isArray(e)&&e.length||(e=n&&n.childNodes||[]);for(var a=0,s=e.length;a<s;a++){var o=e[a];r[o.getId()]||o.propagateChanges(function(){return o.cascadeBy(function(e){e!==n&&e.adjustToCalendarWithoutPropagation()}),o},function(e,i){e||Ext.apply(r,i),t&&t.apply(this,arguments)})}}},renormalizeTasks:function(e,t,i){this.adjustToCalendar(t,i)},getCalendar:function(){return this.calendar||null},setCalendar:function(e,t,i){if(!this.settingCalendar){this.settingCalendar=!0;var n={calendarchange:this.renormalizeTasks,scope:this};if(this.calendar&&this.calendar.un(n),this.calendar=e,e){e.on(n);var r=this.getRoot();r&&(r.calendar=e),t||this.renormalizeTasks(),i||this.fireEvent("calendarset",this,e),this.calendarManager&&this.calendarManager.setProjectCalendar(e)}this.settingCalendar=!1}},getCriticalPaths:function(){var e=this.getRoot(),t=[],i=new Date(0);return e.cascadeBy(function(e){i=Sch.util.Date.max(e.getEndDate(),i)}),e.cascadeBy(function(e){i-e.getEndDate()!=0||e.isRoot()||!e.isLeaf()&&e.childNodes.length||t.push(e)}),Ext.Array.map(t,function(e){return e.getCriticalPaths()})},onMyNodeAdded:function(e,t){if(!t.isRoot()){if(this.lastTotalTimeSpan){var i=this.getTotalTimeSpan();(t.getEndDate()>i.end||t.getStartDate()<i.start)&&(this.lastTotalTimeSpan=null)}t.getEndDate()-this.getProjectEndDate()==0&&this.resetLateDates(),this.cascading||!this.recalculateParents||this.suspendAutoRecalculateParents||(this.updating?this.pendingDataUpdates.recalculateParents[t.getId()]=t:t.recalculateParents())}},onTaskUpdated:function(e,t,i){var n=t.previous;if(this.lastTotalTimeSpan){var r=this.getTotalTimeSpan();(n&&(n[t.endDateField]-r.end==0||n[t.startDateField]-r.start==0)||t.getEndDate()>r.end||t.getStartDate()<r.start)&&(this.lastTotalTimeSpan=null)}if(!this.cascading&&i!==Ext.data.Model.COMMIT&&n){var a=t.percentDoneField in n;if(t.startDateField in n||t.endDateField in n||"parentId"in n||t.effortField in n||"Manual"===n[t.schedulingModeField]||n[t.manuallyScheduledField]){var s=t;if(this.cascadeChanges&&!this.suspendAutoCascade){if("Manual"==n[s.schedulingModeField]){
var o=s.getIncomingDependencies(!0);o.length&&(s=o[0].getSourceTask())}Ext.Function.defer(this.cascadeChangesForTask,this.cascadeDelay,this,[s])}else this.resetEarlyDates(),this.resetLateDates();a=!0}else(n[t.schedulingModeField]||t.manuallyScheduledField in n)&&t.isManuallyScheduled()&&(this.resetEarlyDates(),this.resetLateDates());a&&this.recalculateParents&&!this.suspendAutoRecalculateParents&&(this.updating?this.pendingDataUpdates.recalculateParents[t.getId()]=t:t.recalculateParents())}},onEndUpdate:function(){var e,t=this,i={};for(Ext.Object.each(t.pendingDataUpdates.recalculateParents,function(e,t){t.parentNode&&(i[t.parentNode.getId()]=t.parentNode)}),i=Ext.Array.sort(Ext.Object.getValues(i),function(e,t){return e.data.depth>t.data.depth?1:e.data.depth<t.data.depth?-1:0});i.length>0;)e=i.pop(),e.refreshCalculatedParentNodeData(),e.recalculateParents();return t.pendingDataUpdates.recalculateParents={},t.callParent(arguments)},getEmptyCascadeBatch:function(){var e=this;return{nbrAffected:0,affected:{},visitedCounters:{},addVisited:function(e){var t=e.internalId;this.visitedCounters[t]?this.visitedCounters[t]++:this.visitedCounters[t]=1},addAffected:function(t,i){var n=t.internalId;if(!this.affected[n]&&(this.affected[n]=t,this.nbrAffected++,!e.cascading&&this.nbrAffected>1&&(e.fireEvent("beforecascade",e),e.cascading=!0),!i))for(var r=this.affectedParentsbyInternalId,a=this.affectedParentsArray,s=t.isLeaf()?t.parentNode:t;s&&!s.data.root&&!r[s.internalId];)r[s.internalId]=s,a.push(s),this.addAffected(s,!0),s=s.parentNode},affectedParentsArray:[],affectedParentsbyInternalId:{},parentsStartDates:{}}},startBatchCascade:function(){return this.batchCascadeLevel||(this.currentCascadeBatch=this.getEmptyCascadeBatch(),this.suspendAutoRecalculateParents++,this.suspendAutoCascade++),this.batchCascadeLevel++,this.currentCascadeBatch},endBatchCascade:function(){if(!--this.batchCascadeLevel){this.suspendAutoRecalculateParents--,this.suspendAutoCascade--;var e=this.currentCascadeBatch;this.currentCascadeBatch=null,this.resetEarlyDates(),this.resetLateDates(),this.cascading&&(this.cascading=!1,this.fireEvent("cascade",this,e))}},cascadeChangesForTask:function(e,t){e.propagateChanges(Ext.emptyFn,t,!0)},removeTaskDependencies:function(e){var t=this.dependencyStore,i=e.getAllDependencies(t);i.length&&t.remove(i)},removeTaskAssignments:function(e){var t=this.getAssignmentStore(),i=e.getAssignments();i.length&&t.remove(i)},onTaskRemoved:function(e,t,i){var n=this.getDependencyStore(),r=this.getAssignmentStore(),a=!t.isReplace&&!i;n&&a&&t.cascadeBy(this.removeTaskDependencies,this),r&&a&&(r.fireEvent("beforetaskassignmentschange",r,t.getId(),[]),t.cascadeBy(this.removeTaskAssignments,this),r.fireEvent("taskassignmentschanged",r,t.getId(),[]));var s=this.getTotalTimeSpan(),o=t.getStartDate();t.getEndDate()-s.end!=0&&o-s.start!=0||(this.lastTotalTimeSpan=null),a&&t.setTaskStore(null),this.resetEarlyDates(),this.resetLateDates()},onTaskMoved:function(e,t,i,n){var r=this.getTotalTimeSpan(),a=e.getStartDate();e.getEndDate()-r.end!=0&&a-r.start!=0||(this.lastTotalTimeSpan=null),this.resetEarlyDates(),this.resetLateDates()},onAssignmentMutation:function(e,t){var i=this;Ext.Array.forEach([].concat(t),function(e){var t=e.getTask(i);t&&t.onAssignmentMutation(e)})},onAssignmentStructureMutation:function(e,t){var i=this;Ext.Array.forEach([].concat(t),function(e){var t=e.getTask(i);t&&t.onAssignmentStructureMutation(e)})},onDependencyUpdate:function(e,t,i){i!==Ext.data.Model.COMMIT&&this.onDependencyAdd(e,t)},onDependencyAdd:function(e,t){if(this.resetEarlyDates(),this.resetLateDates(),this.cascadeChanges&&!this.suspendAutoCascade){var i=this,n=[];Ext.isArray(t)?(Ext.Array.forEach(t,function(e){var t=e.getSourceTask();t&&n.push(t)}),n.length&&i.getRoot().propagateChanges(function(){return n})):(n=t.getSourceTask())&&n.propagateChanges()}},onDependencyDelete:function(e,t){this.resetEarlyDates(),this.resetLateDates()},onTaskStoreWrite:function(e,t){var i,n=this,r=t.getRecords();Ext.Array.forEach(r,function(e){Ext.each(e.childNodes,function(e){if(e.phantom)return i=!0,!1})}),i&&!this.autoSync&&setTimeout(function(){n.sync()},1)},forEachTaskUnordered:function(e,t){var i=this.getRoot();i&&i.cascadeBy(function(n){if(n!==i)return e.call(t||this,n)})},getTimeSpanForTasks:function(e){var t=new Date(9999,0,1),i=new Date(0),n=function(e){var n=e.getStartDate(),r=e.getEndDate();n&&n<t&&(t=n),n&&r&&r>i&&(i=r)};return e?(Ext.isArray(e)||(e=[e]),Ext.Array.each(e,n)):this.forEachTaskUnordered(n),t=t<new Date(9999,0,1)?t:null,i=i>new Date(0)?i:null,{start:t,end:i||t&&Ext.Date.add(t,Ext.Date.DAY,1)||null}},getTotalTimeSpan:function(){return this.lastTotalTimeSpan?this.lastTotalTimeSpan:(this.lastTotalTimeSpan=this.getTimeSpanForTasks(),this.lastTotalTimeSpan)},getProjectStartDate:function(){return this.getTotalTimeSpan().start},getProjectEndDate:function(){return this.getTotalTimeSpan().end},getProjects:function(){for(var e=this.getRoot(),t=[],i=e.childNodes,n=0,r=i.length;n<r;n++)i[n].isProject&&t.push(i[n]);return t},getTotalTaskCount:function(e){var t=!1===e?1:0;return this.forEachTaskUnordered(function(){t++}),t},toArray:function(){var e=[];return this.getRoot().cascadeBy(function(t){e.push(t)}),e},beginIndent:function(e){this.isSuspended()||this.fireEvent("beforeindentationchange",this,e),this.suspendEvents(!0)},endIndent:function(e){this.resumeEvents(),this.isSuspended()||this.fireEvent("indentationchange",this,e)},indent:function(e){e=Ext.isArray(e)?e.slice():[e],e.sort(function(e,t){return e.data.index-t.data.index}),this.beginIndent(e),Ext.Array.forEach(e,function(e){e.indent()}),this.endIndent(e)},outdent:function(e){e=Ext.isArray(e)?e.slice():[e],e.sort(function(e,t){return t.data.index-e.data.index}),this.beginIndent(e),Ext.Array.forEach(e,function(e){e.outdent()}),this.endIndent(e)},getTasksForResource:function(e){return this.getEventsForResource(e)},getResourcesForTask:function(e){return this.getResourcesForEvent(e)},forEachScheduledEvent:function(e,t){t=t||this,this.forEachTaskUnordered(function(i){var n=i.getStartDate(),r=i.getEndDate();if(n&&r)return e.call(t,i,n,r)})},onTasksSorted:function(){this.lastTreeFilter&&this.filterTreeBy(this.lastTreeFilter)},append:function(e){return this.getRoot().appendChild(e)},resetEarlyDates:function(e){this.earlyStartDates={},this.earlyEndDates={},e||this.fireEvent("resetearlydates")},resetLateDates:function(e){this.lateStartDates={},this.lateEndDates={},e||this.fireEvent("resetlatedates")},getBySequenceNumber:function(e){return this.getRoot().getBySequenceNumber(e)},destroy:function(){this.setCalendar(null),this.setAssignmentStore(null),this.setDependencyStore(null),this.setResourceStore(null),this.calendarManagerListeners&&this.calendarManagerListeners.destroy(),this.callParent(arguments)},moveSeveralTasks:function(e){for(var t,i=this.startBatchCascade();t=e();){var n=t.task;n.isLeaf()||!n.childNodes.length?i.affected[n.internalId]||(i.addAffected(n),t.method&&n[t.method].apply(n,t.args),this.cascadeChanges&&this.cascadeChangesForTask(n)):this.recalculateParents&&i.addAffected(n)}this.endBatchCascade()},linearWalkDependentTasks:function(e,t,i){var n=this;return!i||Ext.isObject(i)||Ext.Error.raise("Invalid arguments: walking specification must be an object"),i=i||{self:!0,ancestors:n.recalculateParents,descendants:n.moveParentAsGroup,successors:n.cascadeChanges,cycles:n.cycleResolutionStrategy},Gnt.data.Linearizator.linearWalkBySpecification(e,t,i)},getLinearWalkingSequenceForDependentTasks:function(e,t){var i=[];return this.linearWalkDependentTasks(e,function(e,t,n,r){i.push(Array.prototype.slice.call(arguments))},t),i},isVisible:function(e){for(var t=e.parentNode,i=e.get("visible"),n=this.getRoot();i&&t;)i=t.get("expanded")&&t.get("visible"),t=t.parentNode;return i&&!(e===n&&!this.getRootVisible())}},function(){this.override(Sch.data.mixin.FilterableTreeStore.prototype.inheritables()||{})}),Ext.define("Gnt.data.calendar.BusinessTime",{extend:Gnt.data.Calendar,daysPerMonth:20,daysPerWeek:5,hoursPerDay:8,defaultAvailability:["08:00-12:00","13:00-17:00"]}),Ext.define("Gnt.feature.DependencyDragZone",{extend:Ext.dd.DragZone,mixins:{observable:Ext.util.Observable},rtl:null,useLineProxy:null,terminalSelector:null,ganttView:null,fromText:null,toText:null,startText:null,endText:null,toolTipTpl:null,constructor:function(e,t){this.mixins.observable.constructor.call(this,t),this.callParent(arguments)},initLineProxy:function(e,t){var i=this.lineProxyEl=this.lineProxyEl||this.el.createChild({cls:"sch-gantt-connector-proxy"}),n=Ext.isIE9m?0:4,r=this.rtl?t?"r":"l":t?"l":"r",a=this.ganttView.getScroll();i.alignTo(e,r,[t?-n:n,0]),Ext.apply(this,{containerTop:this.el.getTop(),containerLeft:this.el.getLeft(),startXY:i.getXY(),startScrollLeft:a.left,startScrollTop:a.top})},onDrag:function(e,t){this.useLineProxy&&this.updateLineProxy(e.getXY())},updateLineProxy:function(e){var t,i=this.lineProxyEl,n=this.ganttView.getScroll(),r=e[0]-this.startXY[0]+n.left-this.startScrollLeft,a=e[1]-this.startXY[1]+n.top-this.startScrollTop,s=Math.max(1,Math.sqrt(Math.pow(r,2)+Math.pow(a,2))-2),o=Math.atan2(a,r)-Math.PI/2;if(Ext.isIE9m){var l,d,c=Math.cos(o),h=Math.sin(o),u='progid:DXImageTransform.Microsoft.Matrix(sizingMethod="auto expand", M11 = '+c+", M12 = "+-h+", M21 = "+h+", M22 = "+c+")";l=n.top!==this.startScrollTop?this.startScrollTop-this.containerTop:n.top-this.containerTop,d=n.left!==this.startScrollLeft?this.startScrollLeft-this.containerLeft:n.left-this.containerLeft,t={height:s+"px",top:Math.min(0,a)+this.startXY[1]+l+(a<0?2:0)+"px",left:Math.min(0,r)+this.startXY[0]+d+(r<0?2:0)+"px",filter:u,"-ms-filter":u}}else{var g="rotate("+o+"rad)";t={height:s+"px","-o-transform":g,"-webkit-transform":g,"-ms-transform":g,"-moz-transform":g,transform:g}}i.setStyle(t)},onStartDrag:function(){if(this.el.addCls("sch-gantt-dep-dd-dragging"),this.proxy.el.addCls("sch-dd-dependency-proxy"),this.fireEvent("dndstart",this),this.useLineProxy){var e=this.dragData;this.initLineProxy(e.sourceNode,e.isStart),this.lineProxyEl.show()}},getDragData:function(e){var t=e.getTarget(this.terminalSelector);if(t){var i=this.ganttView.resolveTaskRecord(t);if(!1===this.fireEvent("beforednd",this,i))return null;var n=!!t.className.match("sch-gantt-terminal-start"),r={fromLabel:this.fromText,fromTaskName:Ext.String.htmlEncode(i.getName()),fromSide:n?this.startText:this.endText,toLabel:this.toText,toTaskName:"",toSide:""},a=Ext.core.DomHelper.createDom({html:this.toolTipTpl.apply(r)}).firstChild;return{fromId:i.getId()||i.internalId,tplData:r,isStart:n,repairXY:Ext.fly(t).getXY(),ddel:a,sourceNode:Ext.fly(t).up(this.ganttView.eventSelector)}}return!1},afterRepair:function(){this.el.removeCls("sch-gantt-dep-dd-dragging"),this.dragging=!1,this.fireEvent("afterdnd",this)},onMouseUp:function(){if(this.el.removeCls("sch-gantt-dep-dd-dragging"),this.lineProxyEl){var e=Ext.isIE9m?0:400,t=this.lineProxyEl;t.animate({to:{height:0},duration:e,callback:function(){Ext.destroy(t)}}),this.lineProxyEl=null}},getRepairXY:function(){return this.dragData.repairXY},destroy:function(){Ext.destroy(this.lineProxyEl),this.callParent(arguments)}}),Ext.define("Gnt.feature.DependencyDropZone",{extend:Ext.dd.DropZone,mixins:{observable:Ext.util.Observable},terminalSelector:null,dependencyStore:null,toText:null,startText:null,endText:null,ganttView:null,constructor:function(e,t){this.mixins.observable.constructor.call(this,t),this.callParent(arguments)},getTargetFromEvent:function(e){return e.getTarget(this.terminalSelector)},onNodeEnter:function(e,t,i,n){Ext.fly(e).addCls("sch-gantt-terminal-drophover")},onNodeOut:function(e,t,i,n){Ext.fly(e).removeCls("sch-gantt-terminal-drophover"),this.toolTipTpl.overwrite(t.proxy.el.down(".sch-dd-dependency"),n.tplData)},onNodeOver:function(e,t,i,n){var r=this.ganttView.resolveTaskRecord(e),a=r.getId()||r.internalId,s=e.className.match("sch-gantt-terminal-start"),o={};Ext.apply(o,{toLabel:this.toText,toTaskName:Ext.String.htmlEncode(r.getName()),toSide:s?this.startText:this.endText},n.tplData),this.toolTipTpl.overwrite(t.proxy.el.down(".sch-dd-dependency"),o);var l=this.resolveType(n.isStart,e);return this.dependencyStore.isValidDependency(n.fromId,a,l)?this.dropAllowed:this.dropNotAllowed},onNodeDrop:function(e,t,i,n){var r,a=this.resolveType(n.isStart,e),s=this.ganttView.resolveTaskRecord(e),o=s.getId()||s.internalId;return this.el.removeCls("sch-gantt-dep-dd-dragging"),r=this.dependencyStore.isValidDependency(n.fromId,o,a),r&&this.fireEvent("drop",this,n.fromId,o,a),this.fireEvent("afterdnd",this),r},resolveType:function(e,t){var i=Gnt.model.Dependency.Type,n=t.className.match("sch-gantt-terminal-start");return e&&n?i.StartToStart:e&&!n?i.StartToEnd:!e&&n?i.EndToStart:i.EndToEnd}}),Ext.define("Gnt.feature.DependencyDragDrop",{extend:Ext.util.Observable,mixins:{localizable:Gnt.mixin.Localizable},useLineProxy:!0,dragZoneConfig:null,dropZoneConfig:null,toolTipTpl:['<div class="sch-dd-dependency">',"<table><tbody>","<tr>",'<td><span class="sch-dd-dependency-from">{fromLabel}:</span></td>','<td><span class="sch-dd-dependency-from-name">{fromTaskName}</span> - {fromSide}</td>',"</tr>","<tr>",'<td><span class="sch-dd-dependency-to">{toLabel}:</span></td>','<td><span class="sch-dd-dependency-to-name">{toTaskName}</span> - {toSide}</td>',"</tr>","</tbody></table>","</div>"],terminalSelector:".sch-gantt-terminal",el:null,rtl:null,ddGroup:null,ganttView:null,dependencyStore:null,constructor:function(e){var t=e.ganttView;Ext.apply(this,e),this.ddGroup=t.id+"-sch-dependency-dd",this.el.on("mousemove",this.doSetup,this,{single:!0}),this.callParent(arguments)},doSetup:function(){this.dragZone=new Gnt.feature.DependencyDragZone(this.el,Ext.apply({rtl:this.rtl,terminalSelector:this.terminalSelector,useLineProxy:this.useLineProxy,ddGroup:this.ddGroup,ganttView:this.ganttView,startText:this.L("startText"),endText:this.L("endText"),fromText:this.L("fromText"),toText:this.L("toText"),toolTipTpl:Ext.XTemplate.getTpl(this,"toolTipTpl")},this.dragZoneConfig)),this.relayEvents(this.dragZone,["beforednd","dndstart","afterdnd"]),this.dropZone=Ext.create("Gnt.feature.DependencyDropZone",this.el,Ext.apply({rtl:this.rtl,terminalSelector:this.terminalSelector,ddGroup:this.ddGroup,ganttView:this.ganttView,dependencyStore:this.dependencyStore,startText:this.L("startText"),endText:this.L("endText"),toText:this.L("toText"),toolTipTpl:Ext.XTemplate.getTpl(this,"toolTipTpl")},this.dropZoneConfig)),this.relayEvents(this.dropZone,["drop","afterdnd"]),this.configureAllowedSourceTerminals(),this.dependencyStore.allowedDependencyTypes?this.dragZone.on("dndstart",this.configureAllowedTargetTerminals,this):this.el.addCls(["sch-gantt-terminal-allow-target-start","sch-gantt-terminal-allow-target-end"])},configureAllowedSourceTerminals:function(){var e=this.dependencyStore.allowedDependencyTypes,t=["sch-gantt-terminal-allow-source-start","sch-gantt-terminal-allow-source-end"];e&&(t=[],(Ext.Array.indexOf(e,"EndToEnd")>-1||Ext.Array.indexOf(e,"EndToStart")>-1)&&t.push("sch-gantt-terminal-allow-source-end"),(Ext.Array.indexOf(e,"StartToStart")>-1||Ext.Array.indexOf(e,"StartToEnd")>-1)&&t.push("sch-gantt-terminal-allow-source-start")),this.el.addCls(t)},configureAllowedTargetTerminals:function(){var e=this.dependencyStore.allowedDependencyTypes,t=[];this.el.removeCls(["sch-gantt-terminal-allow-target-start","sch-gantt-terminal-allow-target-end"]),(Ext.Array.contains(e,"EndToEnd")||Ext.Array.contains(e,"StartToEnd"))&&t.push("sch-gantt-terminal-allow-target-end"),(Ext.Array.contains(e,"StartToStart")||Ext.Array.contains(e,"EndToStart"))&&t.push("sch-gantt-terminal-allow-target-start"),this.el.addCls(t)},destroy:function(){this.dragZone&&this.dragZone.destroy(),this.dropZone&&this.dropZone.destroy()}}),Ext.define("Gnt.feature.DragCreator",{constructor:function(e){Ext.apply(this,e||{}),this.init()},disabled:!1,showDragTip:!0,tooltipConfig:null,dragTolerance:2,validatorFn:Ext.emptyFn,validatorFnScope:null,setDisabled:function(e){this.disabled=e,this.dragTip&&this.dragTip.setDisabled(e)},getProxy:function(){return this.proxy||(this.proxy=this.template.append(this.ganttView.ownerCt.el,{},!0)),this.proxy},onBeforeDragStart:function(e){var t=this.ganttView,i=e.getTarget("."+t.timeCellCls,2);if(i){var n=t.resolveTaskRecord(i),r=t.getDateFromDomEvent(e);if(!(this.disabled||n.isReadOnly()||n.getStartDate()||n.getEndDate()||!1===t.fireEvent("beforedragcreate",t,n,r,e)))return e.stopEvent(),this.record=n,this.originalStart=r,this.rowRegion=t.getScheduleRegion(this.record,this.originalStart),this.dateConstraints=t.getDateConstraints(this.resourceRecord,this.originalStart),!0}return!1},onDragStart:function(){var e=this,t=(e.ganttView,e.getProxy());e.start=e.originalStart,e.end=e.start,e.rowBoundaries={top:e.rowRegion.top,bottom:e.rowRegion.bottom},t.setBox({x:e.tracker.startXY[0],y:e.rowBoundaries.top,width:1,height:e.rowBoundaries.bottom-e.rowBoundaries.top}),t.show(),e.ganttView.fireEvent("dragcreatestart",e.ganttView),e.showDragTip&&(e.dragTip.updateContent(e.start,e.end,!0,this.record),e.dragTip.enable(),e.dragTip.show(t))},onDrag:function(e){var t=this,i=t.ganttView,n=t.tracker.getRegion().constrainTo(t.rowRegion),r=i.getStartEndDatesFromRegion(n,"round");if(r){t.start=r.start||t.start,t.end=r.end||t.end;var a=t.dateConstraints;a&&(t.end=Sch.util.Date.constrain(t.end,a.start,a.end),t.start=Sch.util.Date.constrain(t.start,a.start,a.end)),t.valid=!1!==this.validatorFn.call(t.validatorFnScope||t,this.record,t.start,t.end,e),t.showDragTip&&t.dragTip.updateContent(t.start,t.end,t.valid,this.record),Ext.apply(n,t.rowBoundaries),this.getProxy().setBox(n)}},onDragEnd:function(e){var t=this,i=t.ganttView,n=!1;t.createContext={start:t.start,end:t.end,e:e,record:t.record,finalize:function(){t.finalize.apply(t,arguments)}},t.showDragTip&&t.dragTip.disable(),(!t.start||!t.end||t.end<t.start)&&(t.valid=!1),t.valid&&(n=!1!==i.fireEvent("beforedragcreatefinalize",t,t.createContext,e)),n&&t.finalize(t.valid)},finalize:function(e){var t=this,i=t.createContext,n=t.ganttView;e&&(i.record.setStartEndDate(i.start,i.end,i.record.getTaskStore().skipWeekendsDuringDragDrop),n.fireEvent("dragcreateend",n,i.record,i.e)),t.proxy.hide(),n.fireEvent("afterdragcreate",n)},init:function(){var e=this.ganttView,t=e.el,i=Ext.Function.bind;this.lastTime=new Date,this.template=this.template||Ext.create("Ext.Template",'<div class="sch-gantt-dragcreator-proxy"></div>',{compiled:!0,disableFormats:!0}),e.on({destroy:this.onGanttDestroy,scope:this}),this.tracker=new Sch.util.DragTracker({el:t,tolerance:this.dragTolerance,onBeforeStart:i(this.onBeforeDragStart,this),onStart:i(this.onDragStart,this),onDrag:i(this.onDrag,this),onEnd:i(this.onDragEnd,this)}),this.showDragTip&&(this.dragTip=new Gnt.Tooltip(Ext.apply({mode:"duration",cls:"sch-gantt-dragcreate-tip",gantt:e},this.tooltipConfig)))},onGanttDestroy:function(){this.dragTip&&this.dragTip.destroy(),this.tracker&&this.tracker.destroy(),this.proxy&&(Ext.destroy(this.proxy),this.proxy=null)}}),Ext.define("Gnt.feature.LabelEditor",{extend:Ext.Editor,labelPosition:"",triggerEvent:"dblclick",delegate:null,dataIndex:null,shadow:!1,completeOnEnter:!0,cancelOnEsc:!0,ignoreNoChange:!0,constructor:function(e,t){this.ganttView=e,this.ganttView.on("afterrender",this.onGanttRender,this),Ext.apply(this,t),"left"===this.labelPosition?this.alignment="r-r":"right"===this.labelPosition&&(this.alignment="l-l"),this.delegate=".sch-gantt-label-"+this.labelPosition,this.callParent([t])},edit:function(e){if(e.isEditable(this.dataIndex)){var t=this.ganttView.getElementFromEventRecord(e);if(t){var i=t.up(this.ganttView.eventWrapSelector);this.record=e,this.rendered||this.render(this.ganttView.getSecondaryCanvasEl()),this.startEdit(i.down(this.delegate),this.dataIndex?e.get(this.dataIndex):"")}}},onGanttRender:function(e){this.field.width||(this.autoSize="width"),this.on({beforestartedit:function(t,i,n){return e.fireEvent("labeledit_beforestartedit",e,this.record,n,t)},beforecomplete:function(t,i,n){return e.fireEvent("labeledit_beforecomplete",e,i,n,this.record,t)},complete:function(t,i,n){this.record.set(this.dataIndex,i),e.fireEvent("labeledit_complete",e,i,n,this.record,t)},scope:this}),e.el.on(this.triggerEvent,function(t,i){this.edit(e.resolveTaskRecord(i))},this,{delegate:this.delegate})}}),Ext.define("Gnt.feature.ProgressBarResize",{constructor:function(e){Ext.apply(this,e||{});var t=this.ganttView;t.on({destroy:this.cleanUp,scope:this}),t.el.on("mousedown",this.onMouseDown,this,{delegate:".sch-gantt-progressbar-handle"}),this.callParent(arguments)},useTooltip:!0,increment:10,tip:null,resizable:null,ganttView:null,onMouseDown:function(e,t){var i=this.ganttView,n=i.resolveTaskRecord(t);if(!1!==i.fireEvent("beforeprogressbarresize",i,n)){var r=Ext.fly(t).prev(".sch-gantt-progress-bar");e.stopEvent(),r.addCls("active"),this.resizable=this.createResizable(r,n,e),i.fireEvent("progressbarresizestart",i,n),Ext.getBody().on("mouseup",this.onBodyMouseUp,this,{single:!0,delay:1})}},createResizable:function(e,t,i){var n=(i.getTarget(),this.ganttView.rtl),r=e.up(this.ganttView.eventSelector),a=r.getWidth()-2*this.ganttView.eventBorderWidth,s=a*this.increment/100,o=Ext.create("Ext.resizer.Resizer",{target:e,taskRecord:t,handles:n?"w":"e",minWidth:0,maxWidth:a,minHeight:1,widthIncrement:s,listeners:{resizedrag:this.partialResize,resize:this.afterResize,scope:this}});return o.resizeTracker.onMouseDown(i,o[n?"west":"east"].dom),r.addCls("sch-gantt-resizing"),this.useTooltip&&(this.tip=Ext.create("Ext.ToolTip",{autoHide:!1,anchor:"b",html:"%"}),this.tip.setTarget(e),this.tip.update(t.getPercentDone()+"%"),this.tip.show()),o},partialResize:function(e,t){var i=Math.round(100*t/(e.maxWidth*this.increment))*this.increment;this.tip&&this.tip.body.update(i+"%")},afterResize:function(e,t,i,n){var r=e.taskRecord;this.tip&&(this.tip.destroy(),this.tip=null);var a=e.taskRecord.getPercentDone();if(Ext.isNumber(t)){var s=Math.round(100*t/(e.maxWidth*this.increment))*this.increment;s=Math.min(100,Math.max(0,s)),e.taskRecord.setPercentDone(s)}a===e.taskRecord.getPercentDone()&&this.ganttView.refreshNode(this.ganttView.indexOf(e.taskRecord)),e.destroy(),this.resizable=null,this.ganttView.fireEvent("afterprogressbarresize",this.ganttView,r)},onBodyMouseUp:function(){this.resizable&&this.afterResize(this.resizable)},cleanUp:function(){this.tip&&this.tip.destroy()}}),Ext.define("Gnt.feature.TaskDragDrop",{extend:Ext.dd.DragZone,useTooltip:!0,tooltipConfig:null,validatorFn:function(e,t,i,n){return!0},validatorFnScope:null,showExactDropPosition:!1,containerScroll:!1,dropAllowed:"sch-gantt-dragproxy",dropNotAllowed:"sch-gantt-dragproxy",valid:!1,gantt:null,onDragEnter:Ext.emptyFn,onDragOut:Ext.emptyFn,tip:null,constructor:function(e,t){t=t||{},Ext.apply(this,t),Ext.isIE&&(Ext.isIE8||Ext.ieVersion<9)&&window.top!==window&&(Ext.dd.DragDropManager.notifyOccluded=!0),this.proxy=this.proxy||new Ext.dd.StatusProxy({shadow:!1,dropAllowed:"sch-gantt-dragproxy",dropNotAllowed:"sch-gantt-dragproxy",ensureAttachedToBody:Ext.emptyFn}),this.gantt.rtl&&this.proxy.addCls("sch-rtl");var i=this,n=i.gantt;i.useTooltip&&(i.tip=new Gnt.Tooltip(Ext.apply({cls:"gnt-dragdrop-tip",gantt:n},i.tooltipConfig))),i.callParent([e,Ext.apply(t,{ddGroup:n.id+"-task-dd"})]),i.scroll=!1,i.isTarget=!0,i.ignoreSelf=!1,i.addInvalidHandleClass("sch-resizable-handle"),i.addInvalidHandleClass(Ext.baseCSSPrefix+"resizable-handle"),i.addInvalidHandleClass("sch-gantt-terminal"),i.addInvalidHandleClass("sch-gantt-progressbar-handle"),i.addInvalidHandleClass("sch-rollup-task"),n.ownerCt.el.appendChild(this.proxy.el),n.on({destroy:i.destroy,scope:i})},destroy:function(){this.tip&&this.tip.destroy(),this.callParent(arguments)},getDragData:function(e){var t=this.gantt,i=e.getTarget(t.eventSelector);if(i&&!e.getTarget(".sch-gantt-baseline-item")){var n,r,a,s,o=e.getTarget(".sch-gantt-task-segment"),l=t.resolveTaskRecord(i);if(l.isReadOnly())return null;o?(n=parseInt(o.getAttribute("data-segmentIndex"),10),r=0===n?i:o):r=i;var d,c=l.isMilestone();if(n>0&&(l=l.getSegment(n)),!1===t.fireEvent("beforetaskdrag",t,l,e))return null;var h=e.getXY(),u=r.cloneNode(!0),g=this.showExactDropPosition?0:t.getSnapPixelAmount(),f=Ext.fly(r).getXY(),p=[h[0]-f[0],h[1]-f[1]];u.id=Ext.id();var m=Ext.fly(r).getHeight(),v=Ext.fly(r).getWidth();if(Ext.fly(u).setHeight(m-0),Ext.isIE8m&&c&&Ext.fly(u).setSize(m+5,m+5),t.rtl?u.style.left=v-p[0]+"px":u.style.left=-p[0]+"px",n>0){var S=l.getPrevSegment(),y=l.getNextSegment();a=Sch.util.Date.max(S.getEndDate(),t.timeAxis.getStart()),s=y?Sch.util.Date.min(y.getStartDate(),t.timeAxis.getEnd()):t.timeAxis.getEnd(),d={left:t.getCoordinateFromDate(a,!1)+p[0],right:t.getCoordinateFromDate(s,!1)-v+p[0]}}else d=Ext.fly(t.findItemByChild(r)).getRegion();return this.constrainTo(d,Ext.fly(r).getRegion(),p[0],p[1]),this.valid=!1,g>=1&&this.setXConstraint(this.leftConstraint,this.rightConstraint,g),{sourceNode:r,repairXY:f,offsets:p,ddel:u,record:l,duration:Sch.util.Date.getDurationInMinutes(l.getStartDate(),l.getEndDate()),sourceDate:t.getDateFromCoordinate(h[0]),minDate:a,maxDate:s,origStart:l.getStartDate(),start:null}}return null},autoOffset:function(e,t){this.setDelta(0,0)},setXConstraint:function(e,t,i){this.leftConstraint=e,this.rightConstraint=t,this.minX=e,this.maxX=t,i&&this.setXTicks(this.initPageX,i),this.constrainX=!0},setYConstraint:function(e,t,i){this.topConstraint=e,this.bottomConstraint=t,this.minY=e,this.maxY=t,i&&this.setYTicks(this.initPageY,i),this.constrainY=!0},constrainTo:function(e,t,i,n){this.resetConstraints(),this.initPageX=e.left+i,this.initPageY=t.top+n,this.setXConstraint(e.left,e.right,this.xTickSize),this.setYConstraint(t.top-1,t.top-1,this.yTickSize)},onDragOver:function(e){var t=this.dragData,i=t.record,n=this.gantt;t.hidden||(Ext.fly(t.sourceNode).hide(),t.hidden=!0);var r,a=n.getDateFromCoordinate(e.getXY()[0])-t.sourceDate,s=new Date(t.origStart-0+a),o=this.proxy.el;if(t.minDate&&(s=Sch.util.Date.constrain(new Date(t.origStart-0+a),t.minDate,t.maxDate)),n.timeAxis.isContinuous())r=n.timeAxis.roundDate(s,!!n.snapRelativeToEventStartDate&&t.origStart);else{var l=o.getX()+(n.rtl?o.getWidth():0)+n.getXOffset(i)-t.offsets[0];r=n.getDateFromXY([l,0],"round")}if(this.showExactDropPosition&&n.taskStore.skipWeekendsDuringDragDrop){var d=Ext.fly(t.ddel.id),c=0,h=i.skipNonWorkingTime(r,!i.isMilestone());s.getTime()!=h.getTime()&&(c=n.timeAxisViewModel.getDistanceBetweenDates(s,h));var u=i.recalculateEndDate(h);s>n.timeAxis.getStart()&&(d.setWidth(n.timeAxisViewModel.getDistanceBetweenDates(h,Sch.util.Date.min(u,n.timeAxis.getEnd()))),c&&o.setX(o.getX()+c))}if(r&&r-t.start!=0&&(t.start=r,this.valid=!1!==this.validatorFn.call(this.validatorFnScope||n,i,r,t.duration,e),this.tip)){var g=i.calculateEndDate(r,i.getDuration(),i.getDurationUnit());this.updateTip(i,r,g,this.valid)}},startDrag:function(){var e=Ext.dd.ScrollManager;return this.gantt.el.ddScrollConfig={increment:e.increment,hthresh:e.hthresh,vthresh:-1},this.callParent(arguments)},endDrag:function(){return delete this.gantt.el.ddScrollConfig,this.callParent(arguments)},onStartDrag:function(){var e=this.dragData.record,t=this.tip;t&&(t.enable(),t.show(this.proxy.el),this.updateTip(e,e.getStartDate(),e.getEndDate())),this.gantt.fireEvent("taskdragstart",this.gantt,e)},updateTip:function(e,t,i,n){n=!1!==n,e.isMilestone()&&t-Ext.Date.clearTime(t,!0)==0&&(t=Sch.util.Date.add(t,Sch.util.Date.MILLI,-1),i=Sch.util.Date.add(i,Sch.util.Date.MILLI,-1)),this.tip.updateContent(t,i,n,e)},afterRepair:function(){Ext.fly(this.dragData.sourceNode).show(),this.tip&&this.tip.hide(),this.dragging=!1},getRepairXY:function(){return this.gantt.fireEvent("aftertaskdrop",this.gantt),this.dragData.repairXY},onDragDrop:function(e,t){var i=this,n=i.cachedTarget||Ext.dd.DragDropMgr.getDDById(t),r=i.dragData,a=i.gantt,s=r.record,o=r.start,l=!0;r.ddCallbackArgs=[n,e,t],this.tip&&this.tip.disable(),this.valid&&o&&s.getStartDate()-o!=0&&(r.finalize=function(){i.finalize.apply(i,arguments)},l=!1!==a.fireEvent("beforetaskdropfinalize",a,r,e)),l&&this.finalize(this.valid)},finalize:function(e){var t,i,n=this,r=this.dragData,a=this.gantt,s=r.record,o=r.start;e?(t=s.getStartDate(),s.setStartDate(o,!0,a.taskStore.skipWeekendsDuringDragDrop,function(e,o){i=s.getStartDate(),t<i||t>i?(a.fireEvent("taskdrop",a,s),Ext.isIE9?(n.proxy.el.setStyle("visibility","hidden"),Ext.Function.defer(n.onValidDrop,10,n,r.ddCallbackArgs)):n.onValidDrop.apply(n,r.ddCallbackArgs)):n.onInvalidDrop.apply(n,r.ddCallbackArgs),a.fireEvent("aftertaskdrop",a,s)})):(n.onInvalidDrop.apply(n,r.ddCallbackArgs),a.fireEvent("aftertaskdrop",a,s))},onInvalidDrop:function(e,t,i){return Ext.isIE&&!t&&(t=e,e=e.getTarget()||document.body),this.callParent([e,t,i])}}),Ext.define("Gnt.feature.TaskResize",{constructor:function(e){Ext.apply(this,e);var t=this.ganttView;t.on({destroy:this.cleanUp,scope:this}),t.mon(t.el,"mousedown",this.onMouseDown,this,{delegate:".sch-resizable-handle"}),this.callParent(arguments)},showDuration:!0,showExactResizePosition:!1,useTooltip:!0,tooltipConfig:null,validatorFn:Ext.emptyFn,validatorFnScope:null,taskRec:null,taskEl:null,isStart:null,ganttView:null,resizable:null,onMouseDown:function(e,t){var i=this.ganttView,n=e.getTarget(".sch-gantt-task-segment"),r=e.getTarget(i.eventSelector),a=i.resolveTaskRecord(r);n&&(r=n,a=a.getSegment(parseInt(n.getAttribute("data-segmentIndex"),10)));var s=a.isResizable();0!==e.button||!1===s||"string"==typeof s&&!r.className.match(s)||!1!==i.fireEvent("beforetaskresize",i,a,e)&&(e.stopEvent(),this.taskEl=Ext.get(r),this.taskRec=a,this.isStart=!!t.className.match("sch-resizable-handle-start"),i.el.on({mousemove:this.onMouseMove,mouseup:this.onMouseUp,scope:this,single:!0}))},onMouseMove:function(e,t){var i,n=this.ganttView,r=this.taskRec,a=this.taskEl,s=n.rtl,o=this.isStart,l=s&&!o||!s&&o,d=n.getSnapPixelAmount();a.getWidth();d=Math.max(1,d);var c={otherEdgeX:l?a.getRight():a.getLeft(),target:a,record:r,isStart:o,isWest:l,handles:l?"w":"e",minHeight:1,minWidth:d,widthIncrement:d,listeners:{resizedrag:this.partialResize,resize:this.afterResize,scope:this}};r instanceof Gnt.model.TaskSegment&&(i=this.taskEl.next(".sch-gantt-task-segment"))&&(c.maxWidth=s?i.getRight()-a.getRight():i.getLeft()-a.getLeft()),c.constrainRegion=a.up(n.getItemSelector()).getRegion(),a.addCls("sch-gantt-resizing"),this.ganttView.fireEvent("taskresizestart",this.ganttView,this.taskRec);var h=a.down(".sch-gantt-progress-bar");h&&h.setWidth(100*h.getWidth()/a.getWidth()+"%"),this.resizable=Ext.create("Ext.resizer.Resizer",c),this.resizable.resizeTracker.onMouseDown(e,this.resizable[l?"west":"east"].dom),this.useTooltip&&(this.tip?this.tip.enable():this.tip=Ext.create("Gnt.Tooltip",Ext.apply({mode:this.showDuration?"duration":"startend",gantt:this.ganttView},this.tooltipConfig)),this.tip.show(a,e.getX()-15),this.tip.updateContent(r.getStartDate(),r.getEndDate(),!0,r),Ext.getBody().on("mouseup",function(){this.tip.disable()},this,{single:!0}))},onMouseUp:function(e,t){this.ganttView.el.un({mousemove:this.onMouseMove,mouseup:this.onMouseUp,scope:this,single:!0})},partialResize:function(e,t,i,n){var r,a=this.ganttView,s=e.isWest,o=e.record;if((r=s?a.getDateFromCoordinate(e.otherEdgeX-Math.min(t,this.resizable.maxWidth),this.showExactResizePosition?null:"round"):a.getDateFromCoordinate(e.otherEdgeX+Math.min(t,this.resizable.maxWidth),this.showExactResizePosition?null:"round"))&&e.date-r!=0){var l,d,c;if(this.showExactResizePosition){var h=a.timeAxis.roundDate(r,!!a.snapRelativeToEventStartDate&&o.getStartDate());h=o.skipNonWorkingTime(h,!o.isMilestone());var u,g=e.target.el;if(s){l=o.skipNonWorkingTime(h,!o.isMilestone()),c=l,u=a.timeAxisViewModel.getDistanceBetweenDates(l,o.getEndDate()),g.setWidth(u);var f=a.timeAxisViewModel.getDistanceBetweenDates(r,l);g.setX(g.getX()+f)}else{
var p=Gnt.util.Data.cloneModelSet([o])[0],m=o.getTaskStore();p.setTaskStore(m),p.setCalendar(o.getCalendar()),p.setEndDateWithoutPropagation(h,!1,m.skipWeekendsDuringDragDrop),d=p.getEndDate(),c=d,u=a.timeAxisViewModel.getDistanceBetweenDates(o.getStartDate(),d),g.setWidth(u)}}else l=e.isStart?r:e.record.getStartDate(),d=e.isStart?e.record.getEndDate():r,c=r;if(e.date=c,a.fireEvent("partialtaskresize",a,o,l,d,e.el,n),this.useTooltip){var v=!1!==this.validatorFn.call(this.validatorFnScope||this,o,l,d);this.tip.updateContent(l,d,v,o)}}},afterResize:function(e,t,i,n){this.useTooltip&&this.tip.disable();var r=this,a=e.record,s=a.getStartDate(),o=a.getEndDate(),l=e.isStart?e.date:s,d=e.isStart?o:e.date,c=r.ganttView,h=!1,u=!0;r.resizeContext={record:a,start:l,end:d,oldStart:a.getStartDate(),finalize:function(){r.finalize.apply(r,arguments)}},l&&d&&(l-s||d-o)&&!1!==r.validatorFn.call(r.validatorFnScope||r,a,l,d,n)?(u=!1!==c.fireEvent("beforetaskresizefinalize",r,r.resizeContext,n),h=!0):c.refreshKeepingScroll(),u&&r.finalize(h)},finalize:function(e){var t,i,n=this,r=n.ganttView,a=n.resizeContext,s=a.record,o=s.task||s,l=r.taskStore.skipWeekendsDuringDragDrop;e?a.start-a.oldStart!=0?(t=s.getStartDate(),i=a.start<=a.end?a.start:a.end,s.setStartDate(i,!1,l,function(e,n){i=s.getStartDate(),i<t||i>t||r.refreshNode(r.store.indexOf(o)),r.fireEvent("aftertaskresize",r,o)})):(t=s.getEndDate(),i=a.start<=a.end?a.end:a.start,s.setEndDate(i,!1,l,function(e,n){i=s.getEndDate(),i<t||i>t||r.refreshNode(r.store.indexOf(o)),r.fireEvent("aftertaskresize",r,o)})):(r.refreshNode(r.store.indexOf(o)),r.fireEvent("aftertaskresize",r,o)),n.resizable.destroy(),n.resizeContext=null},cleanUp:function(){this.tip&&this.tip.destroy()}}),Ext.define("Gnt.feature.WorkingTime",{extend:Sch.plugin.Zones,expandToFitView:!0,calendar:null,init:function(e){this.calendar||Ext.Error.raise("Required attribute 'calendar' missed during initialization of 'Gnt.feature.WorkingTime'"),this.bindCalendar(this.calendar),Ext.apply(this,{store:new Ext.data.Store({model:"Sch.model.Range"})}),this.callParent(arguments),e.on("viewchange",this.onViewChange,this),this.onViewChange()},bindCalendar:function(e){var t={datachanged:this.refresh,update:this.refresh,scope:this,delay:1};this.calendar&&this.calendar.un(t),e&&e.on(t),this.calendar=e},onViewChange:function(){var e=Sch.util.Date;e.compareUnits(this.timeAxis.unit,e.WEEK)>0?this.setDisabled(!0):(this.setDisabled(!1),this.refresh())},refresh:function(){var e=this.schedulerView;this.store.removeAll(!0),this.store.add(this.calendar.getHolidaysRanges(e.timeAxis.getStart(),e.timeAxis.getEnd(),!0))},destroy:function(){this.bindCalendar(null),this.callParent(arguments)}}),Ext.define("Gnt.field.ReadOnly",{extend:Ext.form.field.Checkbox,mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],alias:"widget.readonlyfield",alternateClassName:["Gnt.widget.ReadOnlyField"],taskField:"readOnlyField",setTaskValueMethod:"setReadOnly",getTaskValueMethod:"isReadOnly",instantUpdate:!0,valueToVisible:function(e){return e?this.L("yes"):this.L("no")},getValue:function(){return this.value},setValue:function(e){this.callParent([e]),this.instantUpdate&&!this.getSuppressTaskUpdate()&&this.task&&this.applyChanges()}}),Ext.define("Gnt.field.ShowInTimeline",{extend:Ext.form.field.Checkbox,mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],alias:"widget.showintimelinefield",alternateClassName:["Gnt.widget.ShowInTimelineField"],taskField:"showInTimelineField",setTaskValueMethod:"setShowInTimeline",getTaskValueMethod:"getShowInTimeline",valueToVisible:function(e){return e?this.L("yes"):this.L("no")},setValue:function(e){this.callParent(arguments),this.instantUpdate&&!this.getSuppressTaskUpdate()&&this.task&&this.applyChanges()}}),Ext.define("Gnt.model.ProjectLine",{extend:Ext.data.Model,idProperty:"Id",fields:[{name:"Id"},{name:"ProjectId"},{name:"Date",type:"date"},{name:"Cls",type:"string"},{name:"Text",type:"string"}]}),Ext.define("Gnt.model.TaskSegment",{extend:Gnt.model.Task,task:null,prevSegment:null,nextSegment:null,customizableFields:[{name:"StartOffset",type:"int"},{name:"EndOffset",type:"int"}],startOffsetField:"StartOffset",endOffsetField:"EndOffset",taskNotifyingSuspended:0,respectNeighbours:0,constructor:function(e){if(e=e||{},e.leaf=!0,!e.task)throw"'task' has to be specified";this.task=e.task,this.setPrevSegment(e.prevSegment),this.callParent(arguments),Ext.override(this,this.overridables),this.getTask().normalized&&this.getTaskStore(!0)&&!this.normalized&&this.normalize()},overridables:{set:function(){var e=this.getTask();!this.editing&&e&&e.onSegmentEditBegin(this),this.callParent(arguments)}},serialize:function(){var e={};return this.getId()&&(e[this.idProperty]=this.getId()),e[this.phantomIdField]=this.getPhantomId(),e[this.startDateField]=this.getStartDate(),e[this.endDateField]=this.getEndDate(),e[this.durationField]=this.getDuration(),e[this.durationUnitField]=this.getDurationUnit(),e[this.clsField]=this.getCls(),e},setStartOffset:function(e){var t=this.getTask().getProjectCalendar(),i=t.convertMSDurationToUnit(this.getEndOffset()-e,this.getDurationUnit());this.beginEdit(),this.set(this.startOffsetField,e),this.set(this.durationField,i),this.endEdit()},setEndOffset:function(e){var t=this.getTask().getProjectCalendar(),i=t.convertMSDurationToUnit(e-this.getStartOffset(),this.getDurationUnit());this.beginEdit(),this.set(this.endOffsetField,e),this.set(this.durationField,i),this.endEdit()},setStartEndOffset:function(e,t){var i=this.getTask().getProjectCalendar(),n=i.convertMSDurationToUnit(t-e,this.getDurationUnit());this.beginEdit(),this.set(this.startOffsetField,e),this.set(this.endOffsetField,t),this.set(this.durationField,n),this.endEdit()},normalize:function(){this.callParent(arguments);var e=this.getStartDate();if(!this.getStartOffset()&&e){var t=this.getTask(),i=this.calculateDuration(t.getStartDate(),e,"MILLI"),n=i+this.getDuration("MILLI"),r=t.getProjectCalendar(),a=r.convertMSDurationToUnit(n-i,this.getDurationUnit());this.data[this.startOffsetField]=i,this.data[this.endOffsetField]=n,this.data[this.durationField]=a}},updateOffsetsByDates:function(){if(this.getTaskStore(!0)&&!this.updatingOffsets&&!this.updatingDates){this.updatingOffsets=!0;var e=this.calculateDuration(this.getTask().getStartDate(),this.getStartDate(),"MILLI");this.setStartEndOffset(e,e+this.getDuration("MILLI")),this.updatingOffsets=!1}},updateDatesByOffsets:function(e){if(e=e||{},!this.updatingDates&&!this.updatingOffsets){var t=!1!==e.isForward,i=!1!==e.useAbsoluteOffset,n=e.startDate,r=e.endDate,a=this.getTaskStore(!0);if(a){this.updatingDates=!0;var s,o;t?(o=this.getPrevSegment(),s=o&&!i?this.skipWorkingTime(o.getEndDate(),this.getStartOffset()-o.getEndOffset()):this.skipWorkingTime(n||this.getTask().getStartDate(),this.getStartOffset())):(o=this.getNextSegment(),s=o&&!i?this.skipWorkingTime(o.getStartDate(),o.getStartOffset()-this.getEndOffset()+this.getDuration("MILLI"),!1):this.skipWorkingTime(r||this.getTask().getEndDate(),this.getDuration("MILLI"),!1)),this.setStartDateWithoutPropagation(s,!0,a.skipWeekendsDuringDragDrop),this.updatingDates=!1}}},getPrevSegment:function(){return this.prevSegment},getNextSegment:function(){return this.nextSegment},setPrevSegment:function(e){this.prevSegment=e,e&&(e.nextSegment=this)},setNextSegment:function(e){this.nextSegment=e,e&&(e.prevSegment=this)},buildSnapshot:function(){return[this,Ext.apply({},this.data),{prevSegment:this.getPrevSegment(),nextSegment:this.getNextSegment()}]},readSnapshot:function(e){return e?(Ext.apply(this.data,e[1]),Ext.apply(this,e[2]),this):e},enableRespectNeighbours:function(){this.respectNeighbours++},disableRespectNeighbours:function(){this.respectNeighbours--},suspendTaskNotifying:function(){this.taskNotifyingSuspended++},resumeTaskNotifying:function(){this.taskNotifyingSuspended--},setStartDate:function(e,t){t&&this.enableRespectNeighbours(),this.callParent(arguments),t&&this.disableRespectNeighbours()},setStartDateWithoutPropagation:function(){if(this.beginEdit(),this.callParent(arguments),this.updateOffsetsByDates(),!this.inShifting&&this.respectNeighbours&&this.getNextSegment()){var e=this.getNextSegment(),t=this.getEndOffset()-e.getStartOffset();e&&t>0&&(e.suspendTaskNotifying(),e.enableRespectNeighbours(),e.shiftWithoutPropagation(t),e.resumeTaskNotifying(),e.disableRespectNeighbours())}return this.endEdit(),!0},shiftWithoutPropagation:function(e){var t=this;if(e){t.beginEdit(),t.inShifting=!0,t.setStartEndOffset(t.getStartOffset()+e,t.getEndOffset()+e),t.updateDatesByOffsets();var i;return t.respectNeighbours&&(i=e>0?t.getNextSegment():t.getPrevSegment())&&(i.suspendTaskNotifying(),i.enableRespectNeighbours(),i.shiftWithoutPropagation(e),i.resumeTaskNotifying(),i.disableRespectNeighbours()),t.inShifting=!1,t.endEdit(),!0}},setEndDateWithoutPropagation:function(){return this.beginEdit(),this.callParent(arguments),this.updateOffsetsByDates(),this.endEdit(),!0},setStartEndDateWithoutPropagation:function(){return this.beginEdit(),this.callParent(arguments),this.updateOffsetsByDates(),this.endEdit(),!0},setDurationWithoutPropagation:function(){return this.beginEdit(),this.callParent(arguments),this.updateOffsetsByDates(),this.endEdit(),!0},getTask:function(){return this.task},beginEdit:function(){var e=this.getTask();e&&!this.__editCounter&&e.onSegmentEditBegin(this),this.callParent(arguments)},endEdit:function(){var e=this.previous;this.callParent(arguments),this.__editCounter||this.taskNotifyingSuspended||(this.startDateField in e||this.endDateField in e||this.startOffsetField in e||this.endOffsetField in e||this.durationField in e)&&this.getTask().onSegmentsChanged(this,e)},setSegments:Ext.emptyFn,getSegments:Ext.emptyFn,callTask:function(e){var t=this.task,i=this.callTask.caller,n=i&&t[i.$name];if(n)return n.apply(t,e)},getSchedulingMode:function(){return"Normal"},getCalendar:function(){return this.callTask(arguments)},getOwnCalendar:function(){return this.callTask(arguments)},getProjectCalendar:function(){return this.callTask(arguments)},getDependencyStore:function(){return this.callTask(arguments)},getResourceStore:function(){return this.callTask(arguments)},getAssignmentStore:function(){return this.callTask(arguments)},getTaskStore:function(){return this.callTask(arguments)},forEachAvailabilityInterval:function(e){return e.segments=e.segments||!1,this.callTask(arguments)},propagateChanges:function(){return this.callTask(arguments)},rejectSegmentsProjection:function(){return this.callTask(arguments)},commitSegmentsProjection:function(){return this.callTask(arguments)},getAssignments:function(){return this.callTask(arguments)},getAssignmentFor:function(){return this.callTask(arguments)},isAssignedTo:function(){return this.callTask(arguments)},getResources:function(){return this.callTask(arguments)}}),Ext.define("Gnt.model.Week",{extend:Ext.data.Model,idProperty:"Id",fields:[{name:"Id"},{name:"name",type:"string"},{name:"startDate",type:"date"},{name:"endDate",type:"date"},{name:"mainDay"},{name:"weekAvailability"}],set:function(e,t){"name"==e&&Ext.Array.each(this.get("weekAvailability").concat(this.get("mainDay")),function(e){e&&e.setName(t)}),this.callParent(arguments)}}),Ext.define("Gnt.model.utilization.DefaultUtilizationNegotiationStrategy",{getUtilizationInfoForUtilizationEvent:function(e){var t=this,i={};return t.forEachTimeSpanInterval(e,function(n,r){var a;return e.isSurrogateAssignment()?a=e.getOriginalAssignment().getUtilizationInfo(n,r):e.isSurrogateSummary()?a=e.getOriginalResource().getUtilizationInfo(n,r):Ext.Error.raise("Unknown utilization event type"),Ext.Object.each(a,function(e,a){i[t.self.makeUtilizationInfoKey(n,r,e)]=a}),a}),i},getUtilizationInfoForAssignmentEventInterval:function(e,t,i){var n=Ext.Date,r=this,a={isUtilized:!1,allocationMs:0,allocationDeltaMs:0,isOverallocated:!1,isUnderallocated:!1,assignmentInfo:null,taskInfo:null},s=e.getUtilizationInfo();return i=i||n.add(t,n.DAY,1),Ext.Object.each(a,function(e,n){var o=r.self.makeUtilizationInfoKey(t,i,e);a[e]=s.hasOwnProperty(o)?s[o]:n}),a},forEachTimeSpanInterval:function(e,t){var i,n=Ext.Date,r=e.getStartDate?e.getStartDate():e.startDate,a=e.getEndDate?e.getEndDate():e.endDate;for(i=n.clearTime(r,!0);i<a;)r=i,i=n.add(i,n.DAY,1),t(r,i)},adjustStartDateToTick:function(e){return e&&Ext.Date.clearTime(e,!0)||e},adjustEndDateToTick:function(e){var t,i=Ext.Date,n=e;return e&&(t=new Date(e.getTime()-1),n=t.getDate()!=e.getDate()?new Date(e):i.clearTime(i.add(e,i.DAY,1))),n},calculateResourceAssignmentsTimespan:function(e){var t,i,n=this,r=!1;return t=new Date(864e13),i=new Date(-864e13),e.forEachAssignment(function(e){var n=e.getTask(),a=n&&n.getStartDate()||t,s=n&&n.getEndDate()||i;t>a&&(t=a),i<s&&(i=s),r=!0}),{startDate:r&&n.adjustStartDateToTick(t)||null,endDate:r&&n.adjustEndDateToTick(i)||null}},assignmentsComparator:function(e,t){return e.getTask().getName()>t.getTask().getName()?1:-1},inheritableStatics:{makeUtilizationInfoKey:function(e,t,i){return[e.getTime(),t.getTime(),i].join("-")}}}),Ext.define("Gnt.model.utilization.ResourceStoreUtilizationNegotiationStrategy",{extend:Gnt.model.utilization.DefaultUtilizationNegotiationStrategy,config:{resourceUtilizationStore:null},constructor:function(e){this.initConfig(e)},getUtilizationInfoForUtilizationEvent:function(e){var t,i,n,r,a=Gnt.model.UtilizationEvent,s=this,o=s.getResourceUtilizationStore(),l=e.getId(),d=o&&o.utilizationCache||{},c=d[l]||null;return c||(t=e.getOriginalResource(),i=s.calculateResourceAssignmentsTimespan(t),n=[],t.forEachAssignment(function(e){n.push(e)}),n.sort(function(e,t){return s.assignmentsComparator(e,t)}),s.forEachTimeSpanInterval(i,function(e,i){var o,l,c=t.getUtilizationInfo(e,i);o=a.getSurrogateIdFor(t),l=d[o]=d[o]||{},Ext.Object.each(c,function(t,n){l[s.self.makeUtilizationInfoKey(e,i,t)]=n}),r=0,Ext.Array.forEach(n,function(t){var n,r=t.getId();c.assignmentInfo.hasOwnProperty(r)&&(o=a.getSurrogateIdFor(t),l=d[o]=d[o]||{},n=c.assignmentInfo[r],Ext.Object.each(n,function(t,n){l[s.self.makeUtilizationInfoKey(e,i,t)]=n}))})}),c=d[l]||{}),c},getUtilizationInfoForAssignmentEventInterval:function(e,t){var i,n=Ext.Date,r=this,a=r.getResourceUtilizationStore(),s=a.getTimeAxis(),o=s.getTickFromDate(t);return i=-1!==o?s.getAt(o).getEndDate():n.add(t,1,s.unit),r.callParent([e,t,i])},forEachTimeSpanInterval:function(e,t){var i,n,r=this,a=r.getResourceUtilizationStore(),s=a.getTimeAxis();s?(i=e.getStartDate?e.getStartDate():e.startDate,n=e.getEndDate?e.getEndDate():e.endDate,Ext.Array.forEach(s.generateTicks(i,n),function(e){t(e.start,e.end)})):r.callParent([e,t])},adjustStartDateToTick:function(e){var t=this,i=t.getResourceUtilizationStore(),n=i.getTimeAxis(),r=n&&n.getAdjustedDates(e,e)||null;return r?r.start:t.callParent([e])},adjustEndDateToTick:function(e){var t=this,i=t.getResourceUtilizationStore(),n=i.getTimeAxis(),r=n&&n.getAdjustedDates(e,e)||null;return r?r.end:t.callParent([e])}}),Ext.define("Gnt.patches.CellEditor",{extend:Sch.util.Patch,target:"Ext.grid.CellEditor",minVersion:"5.1.0",overrides:{onHide:function(){this.restoreCell(),this.superclass.onHide.apply(this,arguments)}}}),Ext.define("Gnt.patches.CellEditing",{extend:Sch.util.Patch,target:"Ext.grid.plugin.CellEditing",minVersion:"5.1.1",overrides:{showEditor:function(e,t,i){e.context&&e.context.record!==t.record&&e.field instanceof Ext.form.field.ComboBox&&(e.field.lastSelectedRecords=null),this.callParent(arguments)}}}),Ext.define("Gnt.view.DependencyPainter",{ganttView:null,rowHeight:null,arrowOffset:8,lineWidth:2,xOffset:6,constructor:function(e){e=e||{},Ext.apply(this,e)},setRowHeight:function(e){this.rowHeight=e},getTaskBox:function(e){var t=Sch.util.Date,i=e.getStartDate(),n=e.getEndDate(),r=this.ganttView,a=r.bufferedRenderer,s=r.timeAxis.getStart(),o=r.timeAxis.getEnd();if(!(e.isVisible()&&i&&n&&t.intersectSpans(i,n,s,o)))return null;if(r.store.indexOf(e)<0){var l=r.taskStore;if(!a)return null;if(l.isTreeFiltered()&&!l.lastTreeFilter.filter.call(l.lastTreeFilter.scope||l,e))return null}var d,c=r.getXFromDate(t.max(i,s)),h=r.getXFromDate(t.min(n,o)),u=r.getNodeByRecord(e);if(u||a){var g,f,p=r.getXOffset(e),m=e.isMilestone(),v=!0;c>p&&(c-=p),h+=p;var S=r.el,y=r.getScroll().top-(r.bufferedRenderer?r.bufferedRenderer.bodyTop:0);if(u){var E=r.getElementsFromEventRecord(e),x=E.length&&E[0];if(!x)return null;d=Ext.fly(x).getOffsetsTo(S),g=d[1]+y+(m&&Ext.isIE8?3:0),f=g+Ext.fly(x).getHeight(),m&&(h+=1)}else{var D=r.all.elements,T=r.store.getAt(r.all.startIndex);e.isAbove(T)?(u=D[r.all.startIndex],d=Ext.fly(u).getOffsetsTo(S),d[1]-=r.getRowHeight()):(u=D[r.all.endIndex],d=Ext.fly(u).getOffsetsTo(S),d[1]+=r.getRowHeight()),g=d[1]+y,f=g+this.rowHeight,v=!1}return{top:g,end:h,bottom:f,start:c,rendered:v}}},getRenderData:function(e){var t=e.getSourceTask(),i=e.getTargetTask();if(!(t&&t.getTreeStore()&&i&&i.getTreeStore()))return null;var n=this.getTaskBox(t),r=this.getTaskBox(i),a=this.ganttView;if(a.bufferRender&&n&&!n.rendered&&r&&!r.rendered){var s=a.store.getAt(a.all.startIndex),o=a.store.getAt(a.all.endIndex);if(t.isAbove(s)&&i.isAbove(s)||o.isAbove(t)&&o.isAbove(i))return null}return{fromBox:n,toBox:r}},getDependencyTplData:function(e){var t=this,i=t.ganttView;if(e instanceof Ext.data.Model&&(e=[e]),0!==e.length&&0!==i.store.getCount()){for(var n,r,a,s,o=[],l=0,d=e.length;l<d;l++){s=e[l];var c=this.getRenderData(s);c&&(r=c.fromBox,a=c.toBox,r&&a&&(n=t.getLineCoordinates(r,a,s))&&o.push({dependency:s,id:s.internalId,cls:s.getCls(),lineCoordinates:n}))}return o}},getLineCoordinates:function(e,t,i){var n,r,a,s,o,l=[0,e.top-1+(e.bottom-e.top)/2],d=[0,t.top-1+(t.bottom-t.top)/2],c=d[1]>l[1],h=i.self.Type,u=this.arrowOffset+this.xOffset,g=i.getType(),f=[],p=i.getTargetTask().isMilestone();switch(g){case h.StartToEnd:l[0]=e.start,d[0]=t.end+u,n="l",r="r";break;case h.StartToStart:l[0]=e.start,d[0]=t.start-u,n="l",r="l";break;case h.EndToStart:l[0]=e.end,d[0]=t.start-u,n="r",r="l";break;case h.EndToEnd:l[0]=e.end,d[0]=t.end+u,n="r",r="r";break;default:throw"Invalid dependency type: "+i.getType()}f.push(l);var m=l[0]+("r"===n?this.xOffset:-this.xOffset);c&&g===h.EndToStart&&e.end<t.start+5?(a=Math.min(t.start,t.end)+this.xOffset,f.push([a,l[1]]),f.push([a,t.top-this.arrowOffset-(p?2:0)])):n!==r&&("r"===n&&m>d[0]||"l"===n&&m<d[0])?(s=t["l"===r?"start":"end"],o=d[1]+(c?-1:1)*(this.rowHeight/2),f.push([m,l[1]]),f.push([m,o]),f.push([d[0],o]),f.push(d),f.push([s+(d[0]<s?-this.arrowOffset:this.arrowOffset)-(p&&"l"===r&&!Ext.isIE8m?2:0),d[1]])):(s=t["l"===r?"start":"end"],a="r"===n?Math.max(m,d[0]):Math.min(m,d[0]),f.push([a,l[1]]),f.push([a,d[1]]),f.push([s+(a<s?-this.arrowOffset:this.arrowOffset)-(p&&"l"===r?2:0),d[1]]));for(var v=[],S=0;S<f.length-1;S++)v.push({x1:f[S][0],y1:f[S][1],x2:f[S+1][0],y2:f[S+1][1]});return v}}),Ext.define("Gnt.view.Dependency",{extend:Ext.util.Observable,lineWidth:1,dragZoneConfig:null,dropZoneConfig:null,dependencyPainterClass:"Gnt.view.DependencyPainter",ganttView:null,painter:null,taskStore:null,store:null,dnd:null,lineTpl:null,renderTimer:null,enableDependencyDragDrop:!0,renderAllDepsBuffered:!1,dependencyCls:"sch-dependency",selectedCls:"sch-dependency-selected",constructor:function(e){this.callParent(arguments);var t=this.ganttView;if(t.bufferedRenderer&&t.on({itemadd:this.renderAllDependenciesBuffered,scope:this}),t.on({refresh:this.renderAllDependenciesBuffered,itemupdate:this.onTaskUpdated,scope:this}),this.bindTaskStore(t.getTaskStore()),this.bindDependencyStore(e.store),!this.lineTpl){var i=this.rtl,n=i?"right":"left";this.lineTpl=new Ext.XTemplate('<tpl for=".">'+('<tpl for="lineCoordinates"><div class="{0} {[ parent.dependency.isHighlighted ? "{1}" : "" ]} {[values.x1==values.x2 ? "sch-dependency-line-v" : "sch-dependency-line-h"]} {lineCls} sch-dep-{parent.id} {0}-line {[this.getSuffixedCls(parent.cls, "-line")]}" style="'+n+":{[Math.min(values.x1, values.x2)]}px;top:{[Math.min(values.y1, values.y2)]}px;width:{[Math.abs(values.x1-values.x2)+"+this.lineWidth+"]}px;height:{[Math.abs(values.y1-values.y2)+"+this.lineWidth+']}px"></div></tpl><div style="'+n+':{[values.lineCoordinates[values.lineCoordinates.length - 1].x2]}px;top:{[values.lineCoordinates[values.lineCoordinates.length - 1].y2]}px" class="{0}-arrow-ct {0} {[ values.dependency.isHighlighted ? "{1}" : "" ]} sch-dep-{id} {[this.getSuffixedCls(values.cls, "-arrow-ct")]}"><img src="'+Ext.BLANK_IMAGE_URL+'" class="{0}-arrow {0}-arrow-{[this.getArrowDirection(values.lineCoordinates)]} {[this.getSuffixedCls(values.cls, "-arrow")]}" /></div>').replace(/\{0\}/g,this.dependencyCls).replace(/\{1\}/g,this.selectedCls)+"</tpl>",{disableFormats:!0,getArrowDirection:function(e){var t=e[e.length-1];return t.y2<t.y1?"up":t.x1===t.x2?"down":!i&&t.x1>t.x2||i&&t.x1<t.x2?"left":"right"},getSuffixedCls:function(e,t){return e&&-1!=e.indexOf(" ")?e.replace(/^\s*(.*)\s*$/,"$1").split(/\s+/).join(t+" ")+t:e+t}})}this.painter=Ext.create(this.dependencyPainterClass,Ext.apply({rowHeight:t.getRowHeight(),ganttView:t},e)),this.enableDependencyDragDrop&&(this.dnd=Ext.create("Gnt.feature.DependencyDragDrop",{el:t.getEl(),rtl:t.rtl,ganttView:t,dragZoneConfig:this.dragZoneConfig,dropZoneConfig:this.dropZoneConfig,dependencyStore:this.store}),this.dnd.on("drop",this.onDependencyDrop,this),this.relayEvents(this.dnd,["beforednd","dndstart","afterdnd","drop"])),t.rendered&&this.renderAllDependenciesBuffered(),this.initDependencyListeners()},initDependencyListeners:function(){var e=this;e.ganttView.mon(e.ganttView.getEl(),{dblclick:e.onDependencyClick,click:e.onDependencyClick,contextmenu:e.onDependencyClick,scope:e,delegate:"."+e.dependencyCls})},createDependencyCanvas:function(e){return Ext.fly(e).insertFirst({cls:"sch-dependencyview-ct "+(1===this.lineWidth?" sch-dependencyview-thin ":"")})},getDependencyCanvas:function(){var e=this,t=e.ganttView.getNodeContainer()||e.ganttView.scrollerEl,i=t&&Ext.fly(t).child("div.sch-dependencyview-ct");return t&&!i&&(i=e.createDependencyCanvas(t)),i},bindDependencyStore:function(e){this.depStoreListeners={refresh:this.renderAllDependenciesBuffered,clear:this.renderAllDependenciesBuffered,load:this.renderAllDependenciesBuffered,add:this.onDependencyAdd,update:this.onDependencyUpdate,remove:this.onDependencyDelete,scope:this},e.on(this.depStoreListeners),this.store=e},unBindDependencyStore:function(){this.depStoreListeners&&this.store.un(this.depStoreListeners)},bindTaskStore:function(e){this.taskStoreListeners={cascade:this.onTaskStoreCascade,noderemove:this.renderAllDependenciesBuffered,nodeinsert:this.renderAllDependenciesBuffered,nodeappend:this.renderAllDependenciesBuffered,nodemove:this.renderAllDependenciesBuffered,nodeexpand:this.renderAllDependenciesBuffered,nodecollapse:this.renderAllDependenciesBuffered,sort:this.renderAllDependenciesBuffered,scope:this},e.on(this.taskStoreListeners),this.taskStore=e},onTaskStoreCascade:function(e,t){t&&t.nbrAffected>0&&this.renderAllDependenciesBuffered()},unBindTaskStore:function(e){(e=e||this.taskStore)&&(this.ganttViewListeners&&this.ganttView.un(this.ganttViewListeners),e.un(this.taskStoreListeners))},onDependencyClick:function(e,t){var i=this.getRecordForDependencyEl(t);this.fireEvent("dependency"+e.type,this,i,e,t)},highlightDependency:function(e){e instanceof Ext.data.Model||(e=this.getDependencyRecordByInternalId(e)),e&&(e.isHighlighted=!0,this.getElementsForDependency(e).addCls(this.selectedCls))},unhighlightDependency:function(e){e instanceof Ext.data.Model||(e=this.getDependencyRecordByInternalId(e)),e&&(e.isHighlighted=!1,this.getElementsForDependency(e).removeCls(this.selectedCls))},getElementsForDependency:function(e){var t=this,i=e instanceof Ext.data.Model?e.internalId:e,n=t.getDependencyCanvas();return n&&n.select(".sch-dep-"+i)},depRe:new RegExp("sch-dep-([^\\s]+)"),getDependencyRecordByInternalId:function(e){return this.store.getModelByInternalId(e)},getRecordForDependencyEl:function(e){var t=e.className.match(this.depRe),i=null;if(t&&t[1]){var n=t[1];i=this.getDependencyRecordByInternalId(n)}return i},renderAllDependenciesBuffered:function(){var e=this,t=e.ganttView.up("{isHidden()}");if(t)return clearTimeout(e.renderTimer),e.renderTimer=null,void t.on("show",e.renderAllDependenciesBuffered,e,{single:!0});e.renderTimer||(e.getDependencyCanvas(),e.renderTimer=setTimeout(function(){e.renderTimer=null,e.ganttView.isDestroyed||e.renderAllDependencies()},0))},renderAllDependencies:function(){var e=this;e.getDependencyCanvas()&&(e.renderDependencies(this.store.data.items,!0),e.fireEvent("refresh",this))},getDependencyElements:function(){var e=this,t=e.getDependencyCanvas();return t&&t.select("."+e.dependencyCls)},renderDependencies:function(e,t){var i,n=this,r=n.getDependencyCanvas();r&&(e&&!Ext.isArray(e)&&(e=[e]),e&&e.length>0?(i=n.painter.getDependencyTplData(e),n.lineTpl[t?"overwrite":"append"](r,i)):t&&r.update())},renderTaskDependencies:function(e){var t=[];e instanceof Ext.data.Model&&(e=[e]);for(var i=0,n=e.length;i<n;i++)t=t.concat(e[i].getAllDependencies());this.renderDependencies(t)},onDependencyUpdate:function(e,t){this.removeDependencyElements(t,!1),this.renderDependencies(t)},onDependencyAdd:function(e,t){this.renderDependencies(t)},removeDependencyElements:function(e,t){!1!==t?this.getElementsForDependency(e).fadeOut({remove:!0}):this.getElementsForDependency(e).remove()},onDependencyDelete:function(e,t){Ext.Array.each(t,function(e){this.removeDependencyElements(e)},this)},dimEventDependencies:function(e){var t=this,i=t.getDependencyCanvas();i&&i.select(t.depRe+e).setOpacity(.2)},clearSelectedDependencies:function(){var e=this;e.getDependencyCanvas().select("."+e.selectedCls).removeCls(e.selectedCls),e.store.each(function(e){e.isHighlighted=!1})},onTaskUpdated:function(e){!this.taskStore.cascading&&(!e.previous||e.startDateField in e.previous||e.endDateField in e.previous)&&this.updateDependencies(e)},updateDependencies:function(e){var t=this;e instanceof Ext.data.Model&&(e=[e]),Ext.Array.forEach(e,function(e){Ext.Array.forEach(e.getAllDependencies(),function(e){t.removeDependencyElements(e,!1)})}),this.renderTaskDependencies(e)},onNewDependencyCreated:function(){},onDependencyDrop:function(e,t,i,n){var r,a=this,s=a.taskStore;(r=s&&s.getModelById(t))&&r.linkTo(i,n,null,Ext.Function.bind(a.onNewDependencyCreated,a))},destroy:function(){this.dnd&&this.dnd.destroy(),this.unBindTaskStore(),this.unBindDependencyStore()},setRowHeight:function(e,t){this.rowHeight=e,this.painter.setRowHeight(e),t||this.renderAllDependencies()}}),Ext.define("Gnt.template.Template",{extend:Ext.XTemplate,isLegacyIE:Ext.isIE8m,getInnerTpl:Ext.emptyFn,innerTpl:null,dependencyTerminalMarkup:'<div class="sch-gantt-terminal sch-gantt-terminal-start"></div><div class="sch-gantt-terminal sch-gantt-terminal-end"></div>',constructor:function(e){Ext.apply(this,e);var t=e.rtl?"right":"left",i=this.getInnerTpl(e)||"";this.callParent(['<div class="sch-event-wrap {ctcls} '+Ext.baseCSSPrefix+'unselectable" style="'+t+':{offset}px">','<tpl if="isRollup">',i,"<tpl else>",e.leftLabel?'<div class="sch-gantt-labelct sch-gantt-labelct-left"><label class="sch-gantt-label sch-gantt-label-left">{leftLabel}</label></div>':"",e.rightLabel?'<div class="sch-gantt-labelct sch-gantt-labelct-right" style="left:{width}px"><label class="sch-gantt-label sch-gantt-label-right">{rightLabel}</label></div>':"",e.topLabel?'<div class="sch-gantt-labelct sch-gantt-labelct-top"><label class="sch-gantt-label sch-gantt-label-top">{topLabel}</label></div>':"",i,e.bottomLabel?'<div class="sch-gantt-labelct sch-gantt-labelct-bottom"><label class="sch-gantt-label sch-gantt-label-bottom">{bottomLabel}</label></div>':"","</tpl>","</div>",{disableFormats:!0}])}}),Ext.define("Gnt.template.Task",{extend:Gnt.template.Template,innerTpl:'<div class="sch-gantt-progress-bar" style="width:{progressBarWidth}px;{progressBarStyle}" unselectable="on">&#160;</div>',getInnerTpl:function(e){var t=e.rtl?"right":"left";return'<div id="'+e.prefix+'{id}" class="sch-gantt-item sch-gantt-task-bar {cls}" unselectable="on" style="width:{width}px;{style}"><tpl if="isRollup"><tpl else><tpl if="segments"><div class="sch-gantt-segment-connector"></div></tpl>'+("both"===e.resizeHandles||"left"===e.resizeHandles?'<div class="sch-resizable-handle sch-gantt-task-handle sch-resizable-handle-start"></div>':"")+'<tpl for="segments"><div id="'+e.prefix+'{parent.Id}-segment-{[xindex-1]}" class="sch-gantt-task-segment {cls}" style="left:{left}px;width:{width}px;{style}" data-segmentIndex="{[xindex-1]}">'+this.innerTpl+("both"===e.resizeHandles||"right"===e.resizeHandles?'<div class="sch-resizable-handle sch-gantt-task-handle sch-resizable-handle-end"></div>':"")+"</div></tpl>"+this.innerTpl+("both"===e.resizeHandles||"right"===e.resizeHandles?'<div class="sch-resizable-handle sch-gantt-task-handle sch-resizable-handle-end"></div>':"")+(e.enableProgressBarResize?'<div style="'+t+':{progressBarWidth}px" class="sch-gantt-progressbar-handle"></div>':"")+(e.enableDependencyDragDrop?this.dependencyTerminalMarkup:"")+"</tpl></div>"}}),Ext.define("Gnt.template.ParentTask",{extend:Gnt.template.Template,innerTpl:'<div class="sch-gantt-progress-bar" style="width:{progressBarWidth}px;{progressBarStyle}">&#160;</div><div class="sch-gantt-parenttask-arrow sch-gantt-parenttask-leftarrow"></div><div class="sch-gantt-parenttask-arrow sch-gantt-parenttask-rightarrow"></div>',getInnerTpl:function(e){return'<div id="'+e.prefix+'{id}" class="sch-gantt-item sch-gantt-parenttask-bar {cls}" style="width:{width}px; {style}">'+this.innerTpl+(e.enableDependencyDragDrop&&e.allowParentTaskDependencies?this.dependencyTerminalMarkup:"")+"</div>"}}),Ext.define("Gnt.template.Milestone",{extend:Gnt.template.Template,innerTpl:Ext.isIE8m?'<div style="border-width:{[Math.floor(values.side*0.7)]}px;{style}" class="sch-gantt-milestone-diamond-top {cls}" unselectable="on"></div><div style="border-width:{[Math.floor(values.side*0.7)]}px;{style}" class="sch-gantt-milestone-diamond-bottom {cls}" unselectable="on"></div>':'<img style="{[values.print ? "height:" + values.side + "px;border-left-width:" + values.side + "px" : ""]};{style}" src="'+Ext.BLANK_IMAGE_URL+'" class="sch-gantt-milestone-diamond {cls}" unselectable="on"/>',getInnerTpl:function(e){return"<div "+(this.isLegacyIE?'style="width:{[Math.floor(values.side*0.7)]}px"':"")+' id="'+e.prefix+'{id}" class="sch-gantt-item sch-gantt-milestone-diamond-ct">'+this.innerTpl+'<tpl if="isRollup"><tpl else>'+(e.enableDependencyDragDrop?this.dependencyTerminalMarkup:"")+"</tpl></div>"}}),Ext.define("Gnt.template.RollupTask",{extend:Ext.XTemplate,isLegacyIE:Ext.isIE8m,tplConfig:null,constructor:function(e){Ext.apply(this,e);var t=['<div class="sch-rollup-wrap">','<tpl for=".">',"{[values.tpl.apply(values)]}","</tpl>","</div>"];this.tplConfig=Ext.apply(this.tplConfig||{},{disableFormats:!0,applyRollup:this.applyRollup}),this.callParent(t.concat([this.tplConfig]))}}),Ext.define("Gnt.view.Gantt",{extend:Sch.view.TimelineGridView,alias:["widget.ganttview"],mixins:[Sch.mixin.FilterableTreeView],_cmpCls:"sch-ganttview",barMargin:4,scheduledEventName:"task",trackOver:!1,toggleOnDblClick:!1,eventSelector:".sch-gantt-item",eventWrapSelector:".sch-event-wrap",progressBarResizer:null,taskResizer:null,taskDragDrop:null,dragCreator:null,dependencyView:null,resizeConfig:null,createConfig:null,dragDropConfig:null,progressBarResizeConfig:null,dependencyViewConfig:null,externalGetRowClass:null,outsideLabelsGatherWidth:200,constructor:function(e){e=e||{},e&&(this.externalGetRowClass=e.getRowClass,delete e.getRowClass),this.callParent(arguments),this.on("boxready",this.onMyBoxReady,this),this.initTreeFiltering()},onRender:function(){this.addCls("sch-ganttview-touch-only"),this.configureLabels(),this.setupGanttEvents(),this.setupTemplates(),this.callParent(arguments),Ext.getBody().on("mousemove",function(){this.removeCls("sch-ganttview-touch-only")},this,{single:!0})},
onMyBoxReady:function(){Ext.supports.Touch&&this.getNodeContainer()&&this.getDependencyView().getDependencyCanvas().insertBefore(this.getNodeContainer())},getDependencyStore:function(){return this.dependencyStore},configureFeatures:function(){!1!==this.enableProgressBarResize&&(this.progressBarResizer=Ext.create("Gnt.feature.ProgressBarResize",Ext.apply({ganttView:this},this.progressBarResizeConfig||{})),this.on({beforeprogressbarresize:this.onBeforeTaskProgressBarResize,progressbarresizestart:this.onTaskProgressBarResizeStart,afterprogressbarresize:this.onTaskProgressBarResizeEnd,scope:this})),"none"!==this.resizeHandles&&(this.taskResizer=Ext.create("Gnt.feature.TaskResize",Ext.apply({ganttView:this,validatorFn:this.resizeValidatorFn||Ext.emptyFn,validatorFnScope:this},this.resizeConfig||{})),this.on({beforedragcreate:this.onBeforeDragCreate,beforetaskresize:this.onBeforeTaskResize,taskresizestart:this.onTaskResizeStart,aftertaskresize:this.onTaskResizeEnd,scope:this})),this.enableTaskDragDrop&&(this.taskDragDrop=Ext.create("Gnt.feature.TaskDragDrop",this.ownerCt.el,Ext.apply({gantt:this,validatorFn:this.dndValidatorFn||Ext.emptyFn,validatorFnScope:this},this.dragDropConfig)),this.on({beforetaskdrag:this.onBeforeTaskDrag,taskdragstart:this.onDragDropStart,aftertaskdrop:this.onDragDropEnd,scope:this})),this.enableDragCreation&&(this.dragCreator=Ext.create("Gnt.feature.DragCreator",Ext.apply({ganttView:this,validatorFn:this.createValidatorFn||Ext.emptyFn,validatorFnScope:this},this.createConfig)))},getTemplateForTask:function(e,t){return e.isMilestone(t)?this.milestoneTemplate:e.isLeaf()?this.eventTemplate:this.parentEventTemplate},refreshParentNode:function(e){var t=e.parentNode;t&&this.refreshNode(t)},refreshChildNodes:function(e,t){var i=this;e.cascadeBy(function(n){t&&n===e||i.refreshNode(n)})},setShowRollupTasks:function(e){this.showRollupTasks=e;var t={};this.taskStore.getRootNode().cascadeBy(function(e){if(e.getRollup()){var i=e.parentNode;t[i.internalId]=i}});for(var i in t){var n=this.store.indexOf(t[i]);n>=0&&this.refreshNode(n)}},getRollupRenderData:function(e){for(var t=[],i=this.timeAxis,n=i.getStart(),r=i.getEnd(),a=0;a<e.childNodes.length;a++){var s=e.childNodes[a],o=s.getStartDate(),l=s.getEndDate()||o&&Sch.util.Date.add(o,s.getDurationUnit()||Sch.util.Date.DAY,1);if(s.getRollup()&&o&&l&&Sch.util.Date.intersectSpans(o,l,n,r)){var d={},c=s.isMilestone();d.isRollup=!0,d.id="rollup_"+s.getId();var h=l>r,u=Sch.util.Date.betweenLesser(o,n,r),g=Math.floor(this.getXFromDate(u?o:n)),f=Math.floor(this.getXFromDate(h?r:l)),p=c?0:f-g;d.offset=c?(f||g)-this.getXOffset(s):g,d.tpl=c?this.milestoneTemplate:this.eventTemplate,d.cls=s.getCls(),d.ctcls="",d.record=s,c?(d.side=Ext.isIE8m?Math.round(.3*this.getRowHeight()):Math.round(.5*this.getRowHeight()),d.ctcls+=" sch-gantt-milestone"):(d.width=Math.max(1,p),h&&(d.ctcls+=" sch-event-endsoutside "),u||(d.ctcls+=" sch-event-startsoutside "),d.ctcls+=" sch-gantt-task"),d.cls+=" sch-rollup-task",t.push(d)}}return t},getLabelRenderData:function(e){var t=this.leftLabelField,i=this.rightLabelField,n=this.topLabelField,r=this.bottomLabelField,a={};return t&&(a.leftLabel=Ext.util.Format.htmlEncode(t.renderer.call(t.scope||this,e.data[t.dataIndex],e))),i&&(a.rightLabel=Ext.util.Format.htmlEncode(i.renderer.call(i.scope||this,e.data[i.dataIndex],e))),n&&(a.topLabel=Ext.util.Format.htmlEncode(n.renderer.call(n.scope||this,e.data[n.dataIndex],e))),r&&(a.bottomLabel=Ext.util.Format.htmlEncode(r.renderer.call(r.scope||this,e.data[r.dataIndex],e))),a},columnRenderer:function(e,t,i){var n,r,a,s=i.getStartDate(),o=this.timeAxis,l=Sch.util.Date,d={},c="",h="",u=o.getStart(),g=o.getEnd(),f=i.isMilestone(),p=i.isLeaf(),m=i.isProject,v=i.isReadOnly(),S=!1;if(s){var y=i.getEndDate()||l.add(s,i.getDurationUnit()||l.DAY,1),E=o.getAt(0),x=(E.getEndDate()-E.getStartDate())/this.timeAxisViewModel.getTickWidth(),D=x*this.outsideLabelsGatherWidth,T=l.intersectSpans(s,y,u,g),C=this.outsideLabelsGatherWidth>0,k=C&&l.intersectSpans(s,y,g,new Date(g.getTime()+D)),w=C&&l.intersectSpans(s,y,new Date(u.getTime()-D),u);if(T||k||w){a=y>g,r=l.betweenLesser(s,u,g);var b,F,R;T?(b=Math.floor(this.getXFromDate(r?s:u)),F=Math.floor(this.getXFromDate(a?g:y)),R=f?0:F-b):(r=!0,R=0,b=k?Math.floor(this.getXFromDate(g)+(s-g)/x):Math.floor(this.getXFromDate(u)-(u-y)/x));var A,I,P,M,L=f?(F||b)-this.getXOffset(i):b,V=Math.min(i.getPercentDone()||0,100)/100,B=i.getSegments();if(B){var W,O,N=0,G=B.length;for(W=0;W<G;W++)O=B[W],N+=(O.getEndDate()-O.getStartDate())*V;M=[];var H,z,U,j;for(W=0;W<G;W++){O=B[W];var Y={},_=O.getCls()||"";j=O.getEndDate()||i.getStartDate(),U=O.getStartDate(),l.betweenLesser(U,u,g)?(H=Math.floor(this.getXFromDate(U)),z=l.betweenLesser(j,u,g)?Math.floor(this.getXFromDate(j)):Math.floor(this.getXFromDate(g))):(H=Math.floor(this.getXFromDate(u)),l.betweenLesser(j,u,g)?z=Math.floor(this.getXFromDate(j)):U>g&&j>g?H=z=Math.floor(this.getXFromDate(g))+100:U<u&&j<u?H=z=Math.floor(this.getXFromDate(u))-100:z=Math.floor(this.getXFromDate(g))),Y.left=H-b,Y.width=z-H,A?Y.progressBarWidth=0:(N-=j-U,N<=0?(A=l.add(j,l.MILLI,N),_+=" sch-segment-in-progress",I=Math.floor(this.getXFromDate(A)),Y.progressBarWidth=Math.min(Math.abs(I-H),Y.width)):Y.progressBarWidth=O.width),Y.percentDone=100*V,Ext.apply(Y,O.data),Y.cls=_,Y.SegmentIndex=W,M.push(Y)}M[0].cls+=" sch-gantt-task-segment-first",M[G-1].cls+=" sch-gantt-task-segment-last"}else A=new Date((y-s)*V+s.getTime()),A<u?A=u:A>g&&(A=g);I=Math.floor(this.getXFromDate(A)),P=Math.min(Math.abs(I-b),R),d=Ext.apply({},{id:i.internalId+"-x-x",offset:L,width:Math.max(1,R),ctcls:"",cls:"",print:this._print,record:i,percentDone:100*V,progressBarWidth:Math.max(0,P-2*this.eventBorderWidth),segments:M},i.data),n=this.eventRenderer.call(this.eventRendererScope||this,i,d,i.store)||{},Ext.apply(d,this.getLabelRenderData(i)),S=!0,Ext.apply(d,n);var X=" sch-event-resizable-"+i.getResizable();if(f?(d.side=Math.round((this.enableBaseline?.4:.5)*this.getRowHeight()),h+=" sch-gantt-milestone"):(d.width=Math.max(1,R),a&&(h+=" sch-event-endsoutside "),r||(h+=" sch-event-startsoutside "),h+=p?" sch-gantt-task":" sch-gantt-parent-task",v&&(h+=" sch-gantt-task-readonly")),m&&(h+=" sch-gantt-pms-task"),i.dirty&&(X+=" sch-dirty "),!1===i.isDraggable()&&(X+=" sch-event-fixed "),X+=i.isSegmented()?" sch-event-segmented ":" sch-event-notsegmented ",d.cls=(d.cls||"")+(i.getCls()||"")+X,d.ctcls+=" "+h,this.showRollupTasks){var q=this.getRollupRenderData(i);q.length>0&&(c+=this.rollupTemplate.apply(q))}c+=this.getTemplateForTask(i).apply(d)}}return this.enableBaseline&&(n||(n=this.eventRenderer.call(this,i,d,i.store)||{}),c+=this.baselineRenderer(i,n,u,g,S)),c},baselineRenderer:function(e,t,i,n,r){var a=Sch.util.Date,s=e.getBaselineStartDate(),o=e.getBaselineEndDate();if(s&&o&&a.intersectSpans(s,o,i,n)){var l=o>n,d=a.betweenLesser(s,i,n),c=e.isBaselineMilestone(),h=Math.floor(this.getXFromDate(d?s:i)),u=Math.floor(this.getXFromDate(l?n:o)),g=Math.max(1,c?0:u-h),f=this.getTemplateForTask(e,!0),p={progressBarStyle:t.baseProgressBarStyle||"",id:"base-"+e.internalId,progressBarWidth:Math.min(100,e.getBaselinePercentDone())*g/100,percentDone:e.getBaselinePercentDone(),offset:c?(u||h)-this.getXOffset(e,!0):h,print:this._print,width:Math.max(1,g),baseline:!0},m="";return c?(p.side=Math.round(.4*this.getRowHeight()),m="sch-gantt-milestone-baseline sch-gantt-baseline-item"):m=e.isLeaf()?"sch-gantt-task-baseline sch-gantt-baseline-item":"sch-gantt-parenttask-baseline sch-gantt-baseline-item",l&&(m+=" sch-event-endsoutside "),d||(m+=" sch-event-startsoutside "),p.ctcls=m+" "+(t.basecls||""),r||Ext.apply(p,this.getLabelRenderData(e)),f.apply(p)}return""},setupTemplates:function(){var e,t={leftLabel:this.leftLabelField,rightLabel:this.rightLabelField,topLabel:this.topLabelField,bottomLabel:this.bottomLabelField,prefix:this.eventPrefix,resizeHandles:this.resizeHandles,enableDependencyDragDrop:!1!==this.enableDependencyDragDrop,allowParentTaskDependencies:!1!==this.allowParentTaskDependencies,enableProgressBarResize:this.enableProgressBarResize,rtl:this.rtl};this.eventTemplate||(e=this.taskBodyTemplate?Ext.apply({innerTpl:this.taskBodyTemplate},t):t,this.eventTemplate=Ext.create("Gnt.template.Task",e)),this.parentEventTemplate||(e=this.parentTaskBodyTemplate?Ext.apply({innerTpl:this.parentTaskBodyTemplate},t):t,this.parentEventTemplate=Ext.create("Gnt.template.ParentTask",e)),this.milestoneTemplate||(e=this.milestoneBodyTemplate?Ext.apply({innerTpl:this.milestoneBodyTemplate},t):t,this.milestoneTemplate=Ext.create("Gnt.template.Milestone",e)),this.rollupTemplate||(this.rollupTemplate=Ext.create("Gnt.template.RollupTask",t))},getDependencyView:function(){return this.dependencyView},getTaskStore:function(){return this.taskStore},initDependencies:function(){if(this.dependencyStore){var e=this,t=Ext.create("Gnt.view.Dependency",Ext.apply({containerEl:e.el,ganttView:e,enableDependencyDragDrop:e.enableDependencyDragDrop,allowParentTaskDependencies:e.allowParentTaskDependencies,store:e.dependencyStore,rtl:e.rtl},this.dependencyViewConfig));t.on({beforednd:e.onBeforeDependencyDrag,dndstart:e.onDependencyDragStart,drop:e.onDependencyDrop,afterdnd:e.onAfterDependencyDragDrop,scope:e}),e.dependencyView=t,e.relayEvents(t,["dependencyclick","dependencycontextmenu","dependencydblclick"])}},setupGanttEvents:function(){var e=this.taskStore;this.toggleParentTasksOnClick&&this.on({taskclick:function(t,i){if(!i.isLeaf()&&(!e.isTreeFiltered()||e.allowExpandCollapseWhileFiltered)){var n=this,r=function(){this.fireEvent.apply(this,["taskdblclick"].concat(Array.prototype.slice.apply(arguments)))};this.on("taskclick",r),setTimeout(function(){n.un("taskclick",r)},300),i.isExpanded()?i.collapse():i.expand()}}})},configureLabels:function(){var e={renderer:function(e){return e},dataIndex:void 0};Ext.Array.forEach(["left","right","top","bottom"],function(t){var i=this[t+"LabelField"];i&&(Ext.isString(i)&&(i=this[t+"LabelField"]={dataIndex:i}),Ext.applyIf(i,e),i.editor&&(i.editor=Ext.create("Gnt.feature.LabelEditor",this,{labelPosition:t,field:i.editor,dataIndex:i.dataIndex})))},this),this.on("labeledit_beforestartedit",this.onBeforeLabelEdit,this)},onBeforeTaskDrag:function(e,t){return!this.readOnly&&!1!==t.isDraggable()&&(this.allowParentTaskMove||t.isLeaf())},onDragDropStart:function(){this.tip&&this.tip.on("beforeshow",this.falseReturningFn)},falseReturningFn:function(){return!1},onDragDropEnd:function(){this.tip&&this.tip.un("beforeshow",this.falseReturningFn)},onTaskProgressBarResizeStart:function(){this.tip&&(this.tip.hide(),this.tip.disable())},onTaskProgressBarResizeEnd:function(){this.tip&&this.tip.enable()},onTaskResizeStart:function(){this.tip&&(this.tip.hide(),this.tip.disable()),this.scrollManager&&this.scrollManager.scroller.setDisabled(!0)},onTaskResizeEnd:function(){this.tip&&this.tip.enable(),this.scrollManager&&this.scrollManager.scroller.setDisabled(!1)},onBeforeDragCreate:function(){return!this.readOnly},onBeforeTaskResize:function(e,t){return!this.readOnly&&"EffortDriven"!==t.getSchedulingMode()},onBeforeTaskProgressBarResize:function(){return!this.readOnly},onBeforeLabelEdit:function(){return!this.readOnly},onBeforeEdit:function(){return!this.readOnly},afterRender:function(){this.initDependencies(),this.callParent(arguments),this.el.on("mousemove",this.configureFeatures,this,{single:!0}),Ext.dd.ScrollManager.register(this.el)},resolveTaskRecord:function(e){return this.findItemByChild(e)?this.getRecord(this.findItemByChild(e)):null},resolveEventRecord:function(e){return this.resolveTaskRecord(e)},resolveEventRecordFromResourceRow:function(e){return this.resolveTaskRecord(e)},highlightTask:function(e,t){if(e instanceof Ext.data.Model||(e=this.taskStore.getModelById(e)),e){e.isHighlighted=!0;var i=this.getRow(e);if(i&&Ext.fly(i).addCls("sch-gantt-task-highlighted"),!1!==t)for(var n=0,r=e.successors.length;n<r;n++){var a=e.successors[n];this.highlightDependency(a),this.highlightTask(a.getTargetTask(),t)}}},unhighlightTask:function(e,t){if(e instanceof Ext.data.Model||(e=this.taskStore.getModelById(e)),e){e.isHighlighted=!1;var i=this.getRow(e);if(i&&Ext.fly(i).removeCls("sch-gantt-task-highlighted"),!1!==t)for(var n=0,r=e.successors.length;n<r;n++){var a=e.successors[n];this.unhighlightDependency(a),this.unhighlightTask(a.getTargetTask(),t)}}},getRowClass:function(e){var t="";return e.isHighlighted&&(t="sch-gantt-task-highlighted"),this.externalGetRowClass&&(t+=" "+(this.externalGetRowClass.apply(this,arguments)||"")),t},clearSelectedTasksAndDependencies:function(){this.getDependencyView().clearSelectedDependencies(),this.el.select(".sch-gantt-task-highlighted").removeCls("sch-gantt-task-highlighted"),this.taskStore.getRootNode().cascadeBy(function(e){e.isHighlighted=!1})},getCriticalPaths:function(){return this.taskStore.getCriticalPaths()},highlightCriticalPaths:function(){this.clearSelectedTasksAndDependencies();var e,t,i,n,r=this.getCriticalPaths(),a=this.getDependencyView();Ext.Array.forEach(r,function(r){for(t=0,i=r.length;t<i;t++)if(e=r[t],this.highlightTask(e,!1),t<i-1){for(var s=0,o=e.predecessors.length;s<o;s++)if(e.predecessors[s].getSourceId()==r[t+1].getId()){n=e.predecessors[s];break}a.highlightDependency(n)}},this),this.addCls("sch-gantt-critical-chain")},unhighlightCriticalPaths:function(){this.removeCls("sch-gantt-critical-chain"),this.clearSelectedTasksAndDependencies()},getXOffset:function(e,t){var i=0;return e.isMilestone(t)&&(i=Math.floor(this.getRowHeight()*Math.sqrt(2)/4)-2),i},onDestroy:function(){this.dependencyView&&this.dependencyView.destroy(),this.rendered&&Ext.dd.ScrollManager.unregister(this.el),this.callParent(arguments)},highlightDependency:function(e){this.dependencyView.highlightDependency(e)},unhighlightDependency:function(e){this.dependencyView.unhighlightDependency(e)},onBeforeDependencyDrag:function(e,t){return this.fireEvent("beforedependencydrag",this,t)},onDependencyDragStart:function(e){this.fireEvent("dependencydragstart",this),this.tip&&this.tip.disable(),this.preventOverCls=!0},onDependencyDrop:function(e,t,i,n){this.fireEvent("dependencydrop",this,this.taskStore.getModelById(t),this.taskStore.getModelById(i),n)},onAfterDependencyDragDrop:function(){this.fireEvent("afterdependencydragdrop",this),this.tip&&this.tip.enable(),this.preventOverCls=!1},getLeftEditor:function(){return this.leftLabelField&&this.leftLabelField.editor},getRightEditor:function(){return this.rightLabelField&&this.rightLabelField.editor},getTopEditor:function(){return this.topLabelField&&this.topLabelField.editor},getBottomEditor:function(){return this.bottomLabelField&&this.bottomLabelField.editor},editLeftLabel:function(e){var t=this.getLeftEditor();t&&t.edit(e)},editRightLabel:function(e){var t=this.getRightEditor();t&&t.edit(e)},editTopLabel:function(e){var t=this.getTopEditor();t&&t.edit(e)},editBottomLabel:function(e){var t=this.getBottomEditor();t&&t.edit(e)},getDependenciesForTask:function(e){return window.console&&console.warn&&console.warn("`ganttPanel.getDependenciesForTask()` is deprecated, use `task.getAllDependencies()` instead"),e.getAllDependencies()},onUpdate:function(e,t,i){if(this.callParent(arguments),i==Ext.data.Model.EDIT){var n=t.previous;n&&((t.rollupField in n||t.getRollup())&&this.refreshParentNode(t),t.isProject&&t.readOnlyField in n&&this.refreshChildNodes(t,!0))}},handleScheduleEvent:function(e){var t=e.getTarget("."+this.timeCellCls,3);if(t){var i=this.findRowByChild(t);e.type.indexOf("pinch")>=0?this.fireEvent("schedule"+e.type,this,e):this.fireEvent("schedule"+e.type,this,this.getDateFromDomEvent(e,"floor"),this.indexOf(i),e)}},scrollEventIntoView:function(e,t,i,n,r){r=r||this;var a=this,s=this.taskStore,o=function(e,s){a.up("panel").scrollTask.cancel(),a.scrollElementIntoView(e,s,i),t&&("boolean"==typeof t?e.highlight():e.highlight(null,t)),n&&n.call(r)};e.isVisible()||e.bubble(function(e){e.expand()});var l,d=e.getStartDate(),c=e.getEndDate(),h=Boolean(d&&c);if(h){var u=this.timeAxis;if(!u.dateInAxis(d)||!u.dateInAxis(c)){var g=u.getEnd()-u.getStart();u.setTimeSpan(new Date(d.getTime()-g/2),new Date(c.getTime()+g/2))}l=this.getElementFromEventRecord(e)}else(l=this.getNode(e))&&(l=Ext.fly(l).down(this.getCellSelector()));l?o(l,h):this.bufferedRenderer&&Ext.Function.defer(function(){a.bufferedRenderer.scrollTo(s.getIndexInTotalDataset(e),!1,function(){var t=a.getElementFromEventRecord(e);t?o(t,!0):n&&n.call(r)})},10)},setRowHeight:function(e){this.getDependencyView().setRowHeight(e,!0),this.callParent(arguments)}}),Ext.define("Gnt.patches.RightClick",{extend:Sch.util.Patch,target:"Gnt.view.Gantt",minVersion:"5.1.0",overrides:{handleScheduleBarEvent:function(e){return(!Ext.isGecko||"click"!==e.type||2!==e.button)&&this.callParent(arguments)}}}),Ext.define("Gnt.widget.ConstraintResolutionForm",{extend:Ext.form.Panel,mixins:[Gnt.mixin.Localizable],alias:"widget.constraintresolutionform",legacyMode:!1,config:{resolutionContext:null,dateFormat:null},bodyPadding:5,autoScroll:!0,constructor:function(e){var t=this;-1==Ext.Version.compare(Ext.versions.extjs,"5.0.0")&&t.initConfig(e),t.callParent([e])},initComponent:function(){var e=this;Ext.isObject(e.resolutionContext)||Ext.Error.raise("Can't initialize constration resolution form, resolution context is not given!"),e.setupItemsFromResolutionContext(e.resolutionContext),e.setupFooterFromResolutionContext(e.resolutionContext),e.callParent(arguments)},setupItemsFromResolutionContext:function(e){var t=this,i=[];Ext.isObject(e)&&Ext.isArray(e.resolutions)&&Ext.isFunction(e.getCancelActionOption)||Ext.Error.raise("Invalid resolution context provided!"),Ext.Array.each(e.resolutions,function(n,r){i.push({xtype:"radio",boxLabel:t.getResolutionOptionDescription(n.title,e),name:"resolutionOption",checked:n===e.getCancelActionOption(),inputValue:r,tabIndex:r})}),t.items=[{xtype:"displayfield",itemId:"description",value:t.getConstraintViolationDescription(e),anchor:"-0"},{xtype:"radiogroup",itemId:"options",columns:1,title:t.L("Resolution options"),allowBlank:!1,items:i,anchor:"-0"}]},setupFooterFromResolutionContext:function(e){var t=this;Ext.isObject(e)&&Ext.isArray(e.resolutions)||Ext.Error.raise("Invalid resolution context provided!"),t.fbar={itemId:"footer-tb",items:[{xtype:"checkbox",itemId:"dont-ask-cb",boxLabel:t.L("Don't ask again"),tabIndex:e.resolutions.length+1},"->",{text:t.L("OK"),itemId:"ok-btn",formBind:!0,tabIndex:e.resolutions.length+2,handler:t.onUserActionOk,scope:t},{text:t.L("Cancel"),itemId:"cancel-btn",tabIndex:e.resolutions.length+3,handler:t.onUserActionCancel,scope:t}]}},getDontAskValue:function(){return this.down("#dont-ask-cb").getValue()},getConstraintViolationDescription:function(e){var t,i,n,r,a,s,o=this;return Ext.isObject(e)&&Ext.isDefined(e.title)&&Ext.isDefined(e.task)||Ext.Error.raise("Invalid resolution context provided!"),t=e.title,r=e.task,a=r.getName()||"",n=r.getConstraintClass(),s=o.dateFormat||o.L("dateFormat")||Ext.Date.defaultFormat,i=n&&n.getDisplayableConstraintDateForFormat(e.date,s,r)||e.date,i?Ext.String.format(o.L("Task {0} violates constraint {1} {2}"),a,t,Ext.Date.format(i,s)):Ext.String.format(o.L("Task {0} violates constraint {1}"),a,t)},getResolutionOptionDescription:function(e,t){var i,n,r,a,s=this;return Ext.isObject(t)||Ext.Error.raise("Invalid resolution context provided!"),i=t.task,r=i.getConstraintClass(),a=s.dateFormat||s.L("dateFormat")||Ext.Date.defaultFormat,n=r&&r.getDisplayableConstraintDateForFormat(t.date,a,i)||t.date,n?Ext.String.format(e,Ext.Date.format(n,a)):Ext.String.format(e,"")},onUserActionOk:function(e){var t,i=this;t=i.getValues(),t.dontAsk=i.getDontAskValue(),i.fireEvent("ok",i,t)},onUserActionCancel:function(e){var t=this;t.fireEvent("cancel",t)},getOptimalHeight:function(e){var t,i,n,r,a,s,o=this;return e&&(t=o.getXY(),i=o.getWidth(),o.setXY([-1e4,-1e4]),o.setWidth(e)),n=o.getComponent("options"),r=n.getEl().getOffsetsTo(o.body),s=o.getDockedComponent("footer-tb"),a=r[1]+Ext.getDom(n.getEl()).scrollHeight+2*o.bodyPadding+s.getHeight()+10,e&&(o.setWidth(i),o.setXY(t)),a}}),Ext.define("Gnt.widget.ConstraintResolutionWindow",{extend:Ext.window.Window,alias:"widget.constraintresolutionwindow",mixins:[Gnt.mixin.Localizable],modal:!0,closable:!0,resizable:!0,collapsible:!1,border:!1,bodyBorder:!1,config:{resolutionContext:null,dateFormat:null},form:null,constructor:function(e){var t=this;-1==Ext.Version.compare(Ext.versions.extjs,"5.0.0")&&t.initConfig(e),t.callParent([e])},initComponent:function(){var e=this;e.title=e.L("Constraint violation"),e.setupItems(),e.height=Math.round(Ext.dom.Element.getViewportHeight()/3),e.width=Math.round(Ext.dom.Element.getViewportWidth()/4),e.callParent(arguments),e.on("afterlayout",e.onAfterOptimalLayout,e,{single:!0})},setupItems:function(){var e=this;e.layout="fit",e.form=new Gnt.widget.ConstraintResolutionForm({margin:"0 0 3 0",resolutionContext:e.getResolutionContext(),dateFormat:e.getDateFormat(),bubbleEvents:["ok","cancel"]}),e.items=e.form},onAfterOptimalLayout:function(){var e,t,i,n,r=this;e=r.getHeight(),t=r.form.getHeight(),i=r.form.getOptimalHeight(),n=i+e-t,e!=n&&r.setHeight(n)}}),Ext.define("Gnt.plugin.ConstraintResolutionGui",{extend:Ext.AbstractPlugin,alias:"plugin.constraintresolutiongui",config:{dateFormat:null},cmpDetacher:null,storeDetacher:null,storedResolutions:null,constructor:function(e){var t=this;-1==Ext.Version.compare(Ext.versions.extjs,"5.0.0")&&t.initConfig(e),t.callParent([e])},init:function(e){var t=this;t.callParent(arguments),t.disabled||t.enable()},enable:function(){var e=this,t=e.getCmp();e.callParent(),t.rendered?e.attachToTaskStore():e.cmpDetacher=t.on("afterrender",function(){e.attachToTaskStore()},null,{destroyable:!0,single:!0})},disable:function(){var e=this,t=e.getCmp();e.callParent(),t.rendered?e.detachFromTaskStore():(e.cmpDetacher&&Ext.destroy(e.cmpDetacher),e.cmpDetacher=null)},attachToTaskStore:function(){var e,t,i=this;i.storeDetacher||(e=i.getCmp(),t=e.getTaskStore(),i.storeDetacher=e.mon(t,"constraintconflict",i.onConstraintConflict,i,{destroyable:!0}))},detachFromTaskStore:function(){var e=this;e.storeDetacher&&Ext.destroy(e.storeDetacher),e.storeDetacher=null},onConstraintConflict:function(e,t){function i(){-1!=c&&(o.refreshNode(c),l.refreshNode(c),d.updateDependencies(e))}var n,r,a=this,s=a.getCmp(),o=s.lockedGrid.getView(),l=s.normalGrid.getView(),d=s.getDependencyView(),c=l.indexOf(e),h={destroy:function(){Ext.destroy(r)}};i(),a.hasStoredResolutionForContext(t)?a.resolveSilently(t,i):(n=new Gnt.widget.ConstraintResolutionWindow({dateFormat:a.getDateFormat(),resolutionContext:t}),r=n.on({ok:Ext.Function.bind(a.onUserActionOk,a,[t,i,n,h],!0),cancel:Ext.Function.bind(a.onUserActionCancel,a,[t,i,n,h],!0),close:Ext.Function.bind(a.onUserActionClose,a,[t,i,h],!0),scope:a,destroyable:!0}),s.completeEdit(),n.show())},getStoredResolutions:function(){var e=this;return e.storedResolutions||(e.storedResolutions={}),e.storedResolutions},getStoredResolutionKeyForContext:function(e){return Ext.isObject(e)&&Ext.isString(e.title)&&Ext.isArray(e.resolutions)||Ext.Error.raise("Can't get stored resolution key for context, invalid context is given!"),e.title+e.resolutions.length},hasStoredResolutionForContext:function(e){var t=this,i=t.getStoredResolutionKeyForContext(e),n=t.getStoredResolutions();return Ext.isDefined(n[i])},getStoredResolutionForContext:function(e){var t=this,i=t.getStoredResolutionKeyForContext(e),n=t.getStoredResolutions();return Ext.isDefined(n[i])||Ext.Error.raise("Can't get resolution for context, no resolutions has been stored previously!"),n[i]},storeResolutionForContext:function(e,t){var i=this,n=i.getStoredResolutionKeyForContext(e);i.storedResolutions;i.storedResolutions[n]=t},resolveSilently:function(e,t){var i=this,n=i.getStoredResolutionForContext(e);Ext.isObject(e)&&Ext.isArray(e.resolutions)&&Ext.isDefined(e.resolutions[n])||Ext.Error.raise("Can't resolve constraint confict silently, stored resolution is inconsistent to the context given!"),e.resolutions[n].resolve(),t()},onUserActionOk:function(e,t,i,n,r,a,s){var o=this;Ext.isObject(t)&&Ext.isDefined(t.resolutionOption)&&Ext.isDefined(t.dontAsk)||Ext.Error.raise("Can't resolve constraint conflict according to user choise, user choise is invalid!"),Ext.isObject(n)&&Ext.isArray(n.resolutions)&&Ext.isDefined(n.resolutions[t.resolutionOption])||Ext.Error.raise("Can't resolve constraint conflict according to user choise, resolution context is inconsistent to user choise!"),Ext.destroy(s),a.close(),t.dontAsk&&o.storeResolutionForContext(n,t.resolutionOption),n.resolutions[t.resolutionOption].resolve(),r()},onUserActionCancel:function(e,t,i,n,r,a){Ext.isObject(i)&&Ext.isFunction(i.cancelAction)||Ext.Error.raise("Invalid resolution context given!"),Ext.destroy(a),r.close(),i.cancelAction(),n()},onUserActionClose:function(e,t,i,n,r){i&&Ext.isFunction(i.cancelAction)||Ext.Error.raise("Invalid resolution context given!"),Ext.destroy(r),i.cancelAction(),n()}}),Ext.define("Gnt.plugin.ProjectLines",{extend:Sch.plugin.Lines,alias:"plugin.gantt_projectlines",innerTpl:'<span class="sch-gantt-pms-line-text">{Text}</span>',showHeaderElements:!0,taskStore:null,linesFor:"both",allRemoved:!1,init:function(e){this.taskStore=this.taskStore||e.getTaskStore(),this.bindTaskStore(this.taskStore),this.store||(this.store=new Ext.data.Store({model:"Gnt.model.ProjectLine"})),this.callParent(arguments),e.on("viewchange",this.onViewChange,this),this.onViewChange()},bindTaskStore:function(e){var t={datachanged:this.onDataChanged,update:this.onUpdate,scope:this,delay:1};this.taskStore&&this.taskStore.un(t),e&&e.on(t),this.taskStore=e},onDataChanged:function(e){this.refresh()},onUpdate:function(e,t,i){if(t&&t.isProject&&i==Ext.data.Model.EDIT){var n=t.modified&&t.modified.Id||t.getId();this.store.remove(this.getProjectLines(n)),this.store.add(this.retrieveProjectLines(t))}},onViewChange:function(){this.refresh()},loadStore:function(){this.store.removeAll(!0),this.store.add(this.retrieveProjectLines())},refresh:function(){this.loadStore()},getProjectLines:function(e){var t=[];return this.store.each(function(i){i.get("ProjectId")==e&&t.push(i)}),t},prepareProjectStartLine:function(e){return{Date:e.getStartDate(),Text:"Start of: "+e.getName(),Cls:"sch-gantt-pms-line-start sch-gantt-pms-line-"+e.getId(),ProjectId:e.getId()}},prepareProjectEndLine:function(e){return{Date:e.getEndDate(),Text:"End of: "+e.getName(),Cls:"sch-gantt-pms-line-end sch-gantt-pms-line-"+e.getId(),ProjectId:e.getId()}},retrieveProjectLines:function(e){for(var t=this,i=Ext.isArray(e)?e:e&&[e]||this.taskStore.getProjects(),n=[],r=t.linesFor,a=0;a<i.length;a++)"end"!=r&&n.push(t.prepareProjectStartLine(i[a])),"start"!=r&&n.push(t.prepareProjectEndLine(i[a]));return n},destroy:function(){this.bindTaskStore(null),this.callParent(arguments)}}),Ext.define("Gnt.panel.Gantt",{extend:Sch.panel.TimelineTreePanel,alias:["widget.ganttpanel"],alternateClassName:["Sch.gantt.GanttPanel"],viewType:"ganttview",layout:"border",rowLines:!0,syncRowHeight:!1,useSpacer:!1,rowHeight:24,topLabelField:null,leftLabelField:null,bottomLabelField:null,rightLabelField:null,highlightWeekends:!0,weekendsAreWorkdays:!1,skipWeekendsDuringDragDrop:!0,enableTaskDragDrop:!0,enableDependencyDragDrop:!0,enableProgressBarResize:!1,toggleParentTasksOnClick:!0,addRowOnTab:!0,recalculateParents:!0,cascadeChanges:!1,showTodayLine:!1,enableBaseline:!1,baselineVisible:!1,enableAnimations:!1,animate:!1,workingTimePlugin:null,todayLinePlugin:null,allowParentTaskMove:!0,allowParentTaskDependencies:!0,enableDragCreation:!0,eventRenderer:Ext.emptyFn,eventRendererScope:null,eventTemplate:null,parentEventTemplate:null,rollupTemplate:null,milestoneTemplate:null,taskBodyTemplate:null,parentTaskBodyTemplate:null,milestoneBodyTemplate:null,autoHeight:null,calendar:null,crudManager:null,taskStore:null,dependencyStore:null,resourceStore:null,assignmentStore:null,columnLines:!1,dndValidatorFn:Ext.emptyFn,createValidatorFn:Ext.emptyFn,resizeHandles:"both",resizeValidatorFn:Ext.emptyFn,resizeConfig:null,progressBarResizeConfig:null,dragDropConfig:null,createConfig:null,autoFitOnLoad:!1,showRollupTasks:!1,enableConstraintsResolutionGui:!0,showProjectLines:!0,projectLinesConfig:null,constraintResolutionGuiConfig:null,scrollTaskIntoViewOnClick:!1,enableTaskReordering:!0,refreshLockedTreeOnDependencyUpdate:!1,_lockedDependencyListeners:null,earlyStartColumn:null,earlyEndColumn:null,lateStartColumn:null,lateEndColumn:null,earlyDatesListeners:null,lateDatesListeners:null,slackListeners:null,refreshTimeout:100,lastFocusedRecord:null,lastFocusedRecordFrom:null,ganttEditingPlugin:null,simpleCascadeThreshold:30,forceDefineTimeSpanByStore:!0,setShowRollupTasks:function(e){this.showRollupTasks=e,this.getSchedulingView().setShowRollupTasks(e)},onCalendarSet:function(e,t){this.needToTranslateOption("weekendsAreWorkdays")&&t.setWeekendsAreWorkDays(this.weekendsAreWorkdays),this.workingTimePlugin&&(this.workingTimePlugin.bindCalendar(t),this.workingTimePlugin.refresh()),this.calendar=t},initStores:function(){this.crudManager&&(this.taskStore||(this.taskStore=this.crudManager.getTaskStore()),this.dependencyStore||(this.dependencyStore=this.crudManager.getDependencyStore()),this.resourceStore||(this.resourceStore=this.crudManager.getResourceStore()),this.assignmentStore||(this.assignmentStore=this.crudManager.getAssignmentStore())),this.taskStore||Ext.Error.raise("You must specify a taskStore config.");var e=Ext.StoreMgr.lookup(this.taskStore);e||Ext.Error.raise("You have provided an incorrect taskStore identifier"),e instanceof Gnt.data.TaskStore||Ext.Error.raise("A `taskStore` should be an instance of `Gnt.data.TaskStore` (or of a subclass)"),this.mon(e,{calendarset:this.onCalendarSet,scope:this}),Ext.getVersion().isGreaterThan("6.0.0")&&this.mon(e,{indentationchange:this.onIndentationChange,scope:this}),Ext.apply(this,{store:e,taskStore:e});var t=this.calendar=e.calendar;this.dependencyStore?(this.dependencyStore=Ext.StoreMgr.lookup(this.dependencyStore),e.setDependencyStore(this.dependencyStore)):this.dependencyStore=e.dependencyStore,this.dependencyStore.allowParentTaskDependencies=this.allowParentTaskDependencies,this.dependencyStore instanceof Gnt.data.DependencyStore||Ext.Error.raise("The Gantt dependency store should be a Gnt.data.DependencyStore, or a subclass thereof.");var i=this.resourceStore?Ext.StoreMgr.lookup(this.resourceStore):e.getResourceStore();i instanceof Gnt.data.ResourceStore||Ext.Error.raise("A `ResourceStore` should be an instance of `Gnt.data.ResourceStore` (or of a subclass)");var n=this.assignmentStore?Ext.StoreMgr.lookup(this.assignmentStore):e.getAssignmentStore();n instanceof Gnt.data.AssignmentStore||Ext.Error.raise("An `assignmentStore` should be an instance of `Gnt.data.AssignmentStore` (or of a subclass)"),this.bindAssignmentStore(n,!0),this.bindResourceStore(i,!0),this.needToTranslateOption("weekendsAreWorkdays")&&t.setWeekendsAreWorkDays(this.weekendsAreWorkdays)},onIndentationChange:function(){this.getView().refresh()},initComponent:function(){Ext.isBoolean(this.showBaseline)&&(this.enableBaseline=this.baselineVisible=this.showBaseline,this.showBaseline=Gnt.panel.Gantt.prototype.showBaseline),this.autoHeight=!1,this.initStores(),this.needToTranslateOption("cascadeChanges")&&this.setCascadeChanges(this.cascadeChanges),this.needToTranslateOption("recalculateParents")&&this.setRecalculateParents(this.recalculateParents),this.needToTranslateOption("skipWeekendsDuringDragDrop")&&this.setSkipWeekendsDuringDragDrop(this.skipWeekendsDuringDragDrop),this.normalViewConfig=this.normalViewConfig||{},Ext.apply(this.normalViewConfig,{taskStore:this.taskStore,dependencyStore:this.dependencyStore,snapRelativeToEventStartDate:this.snapRelativeToEventStartDate,enableDependencyDragDrop:this.enableDependencyDragDrop,enableTaskDragDrop:this.enableTaskDragDrop,enableProgressBarResize:this.enableProgressBarResize,
enableDragCreation:this.enableDragCreation,allowParentTaskMove:this.allowParentTaskMove,allowParentTaskDependencies:this.allowParentTaskDependencies,toggleParentTasksOnClick:this.toggleParentTasksOnClick,resizeHandles:this.resizeHandles,enableBaseline:this.baselineVisible||this.enableBaseline,leftLabelField:this.leftLabelField,rightLabelField:this.rightLabelField,topLabelField:this.topLabelField,bottomLabelField:this.bottomLabelField,eventTemplate:this.eventTemplate,parentEventTemplate:this.parentEventTemplate,milestoneTemplate:this.milestoneTemplate,rollupTemplate:this.rollupTemplate,taskBodyTemplate:this.taskBodyTemplate,parentTaskBodyTemplate:this.parentTaskBodyTemplate,milestoneBodyTemplate:this.milestoneBodyTemplate,resizeConfig:this.resizeConfig,dragDropConfig:this.dragDropConfig,showRollupTasks:this.showRollupTasks}),(this.topLabelField||this.bottomLabelField)&&(this.addCls("sch-gantt-topbottom-labels "+(this.topLabelField?"sch-gantt-top-label":"")),this.normalViewConfig.rowHeight=52),this.configureFunctionality(),this.mon(this.taskStore,{beforecascade:this.onBeforeCascade,cascade:this.onAfterCascade,scope:this}),this.callParent(arguments),this.autoFitOnLoad&&(this.store.getCount()&&this.zoomToFit(),this.mon(this.store,"load",function(){this.zoomToFit()},this)),this.bodyCls=(this.bodyCls||"")+" sch-ganttpanel-container-body";var e=this.getSchedulingView();if(this.relayEvents(e,["taskclick","taskdblclick","taskcontextmenu","beforetaskresize","taskresizestart","partialtaskresize","beforetaskresizefinalize","aftertaskresize","beforeprogressbarresize","progressbarresizestart","afterprogressbarresize","beforetaskdrag","taskdragstart","beforetaskdropfinalize","beforedragcreate","dragcreatestart","beforedragcreatefinalize","dragcreateend","afterdragcreate","taskdrop","aftertaskdrop","labeledit_beforestartedit","labeledit_beforecomplete","labeledit_complete","beforedependencydrag","dependencydragstart","dependencydrop","afterdependencydragdrop","dependencyclick","dependencycontextmenu","dependencydblclick","scheduleclick","scheduledblclick","schedulecontextmenu"]),this.addRowOnTab)if(6===Ext.getVersion().getMajor()){var t=this.lockedGrid.getView();t.onRowExit=Ext.Function.createInterceptor(t.onRowExit,this.beforeRowExit,this)}else{var i=this.getSelectionModel();i.onEditorTab=Ext.Function.createInterceptor(i.onEditorTab,this.onEditorTabPress,this)}var n=this.getSchedulingView();this.registerRenderer(n.columnRenderer,n);var r=" sch-ganttpanel sch-horizontal ";this.highlightWeekends&&(r+=" sch-ganttpanel-highlightweekends "),this.addCls(r),this.eventBorderWidth<1&&this.addCls("sch-gantt-no-task-border"),this.baselineVisible&&this.showBaseline(),this.on("add",function(e,t){t instanceof Ext.Editor&&(e.lockedGrid.suspendLayouts(),e.suspendLayouts(),e.lockedGrid.add(t),e.resumeLayouts(),e.lockedGrid.resumeLayouts())}),this.on("viewready",this.onMyViewReady,this),this.on({dragcreatestart:function(){var e=this.findPlugin("scheduler_pan");e&&e.disable()},afterdragcreate:function(){var e=this.findPlugin("scheduler_pan");e&&e.enable()},scope:this}),this.scrollTaskIntoViewOnClick&&this.lockedGrid.on("itemclick",this.onRowClicked,this)},setReadOnly:function(e){this.callParent(arguments),this.fireEvent("setreadonly",this,e)},getTimeSpanDefiningStore:function(){return this.taskStore},bindAutoTimeSpanListeners:function(){this.autoFitOnLoad||this.callParent(arguments)},onBeforeCascade:function(){this.lockedGrid.view.onUpdate=this.normalGrid.view.onUpdate=Ext.emptyFn,this.suspendLayouts()},onAfterCascade:function(e,t){var i=this;if(this.lockedGrid.view.onUpdate=this.lockedGrid.view.self.prototype.onUpdate,this.normalGrid.view.onUpdate=this.normalGrid.view.self.prototype.onUpdate,i.resumeLayouts(),t.nbrAffected>0){var n=this.lockedGrid.getView();if(t.nbrAffected<=i.simpleCascadeThreshold){var r=this.getView(),a=this.getSchedulingView();a.suspendEvents(!0);for(var s in t.affected){var o=t.affected[s],l=n.store.indexOf(o);l>=0&&r.refreshNode(l)}return void a.resumeEvents()}this.normalGrid.getView().refreshKeepingScroll(!0),i.suspendLayouts(),n.refresh(),i.resumeLayouts()}},bindFullRefreshListeners:function(e){var t,i=this,n=function(){t||(t=setTimeout(function(){t=null,i.redrawColumns([e])},i.refreshTimeout))};e.mon(this.taskStore,{nodeappend:n,nodeinsert:n,noderemove:n,scope:this})},bindSequentialDataListeners:function(e){var t=this.lockedGrid.view,i=this.taskStore;e.mon(i,{nodeappend:function(t,n,r){i.fillCount||this.updateAutoGeneratedCells(e,r)},nodeinsert:function(i,n,r){this.updateAutoGeneratedCells(e,t.store.indexOf(r))},move:function(i){if(i.__recordBelow){var n=t.store,r=Math.min(n.indexOf(i),n.indexOf(i.__recordBelow));this.updateAutoGeneratedCells(e,r)}},_noderemove:function(){this.updateAutoGeneratedCells(e,this.lockedGrid.view.all.startIndex)},scope:this}),e.mon(this.normalGrid.getView(),{itemremove:function(){this.updateAutoGeneratedCells(e,this.lockedGrid.view.all.startIndex)},scope:this})},bindSlackListeners:function(){var e=Ext.Function.createBuffered(this.updateSlackColumns,this.refreshTimeout,this,[]);this.slackListeners=this.mon(this.taskStore,{resetearlydates:e,resetlatedates:e,scope:this,destroyable:!0})},bindEarlyDatesListeners:function(){var e=Ext.Function.createBuffered(this.updateEarlyDateColumns,this.refreshTimeout,this,[]);this.earlyDatesListeners=this.mon(this.taskStore,{resetearlydates:e,scope:this,destroyable:!0})},bindLateDatesListeners:function(){var e=Ext.Function.createBuffered(this.updateLateDateColumns,this.refreshTimeout,this,[]);this.lateDatesListeners=this.mon(this.taskStore,{resetlatedates:e,scope:this,destroyable:!0})},startEditScrollToEditor:function(e){var t=this.ganttEditingPlugin;!Sch.disableOverrides&&t&&t.on("beforeedit",function(i,n){var r=n.column,a=t.getEditor(e,r),s=this.lockedGrid.getView();a.on("startedit",function(){s.scrollCellIntoView(s.getCell(e,r))},null,{single:!0,delay:1})},this,{single:!0})},beforeRowExit:function(e,t,i){if(i&&!t){var n=this.lockedGrid.getView(),r=n.getRecord(e),a=r.addTaskBelow({leaf:!0});this.startEditScrollToEditor(a)}},onEditorTabPress:function(e){var t=this.lockedGrid.headerCt,i=e.getActiveRecord(),n=t.items.indexOf(e.getActiveColumn()),r=this.store.indexOf(i)===this.getStore().getCount()-1,a=function(e){return t.items.indexOf(e)>n&&e.isVisible()&&e.getEditor()};if(r&&t.items.findIndexBy(a)<0){var s=i.addTaskBelow({leaf:!0});this.startEditScrollToEditor(s)}},needToTranslateOption:function(e){return this.hasOwnProperty(e)||this.self.prototype.hasOwnProperty(e)&&this.self!=Gnt.panel.Gantt},getDependencyView:function(){return this.getSchedulingView().getDependencyView()},disableWeekendHighlighting:function(e){this.workingTimePlugin.setDisabled(e)},resolveTaskRecord:function(e){return this.getSchedulingView().resolveTaskRecord(e)},fitTimeColumns:function(){this.getSchedulingView().fitColumns()},getResourceStore:function(){return this.getTaskStore().getResourceStore()},getAssignmentStore:function(){return this.getTaskStore().getAssignmentStore()},getCrudManager:function(){return this.crudManager},getTaskStore:function(){return this.taskStore},getEventStore:function(){return this.taskStore},getDependencyStore:function(){return this.dependencyStore},onDragDropStart:function(){this.tip&&(this.tip.hide(),this.tip.disable())},onDragDropEnd:function(){this.tip&&this.tip.enable()},configureFunctionality:function(){var e=this.plugins=[].concat(this.plugins||[]);if(this.highlightWeekends&&(this.workingTimePlugin=Ext.create("Gnt.feature.WorkingTime",{calendar:this.calendar}),e.push(this.workingTimePlugin)),this.showTodayLine&&(this.todayLinePlugin=new Sch.plugin.CurrentTimeLine,e.push(this.todayLinePlugin)),this.enableConstraintsResolutionGui&&!Ext.Array.findBy(e,function(e){return e instanceof Gnt.plugin.ConstraintResolutionGui||"constraintresolutiongui"==e.ptype})&&e.push(Ext.apply(this.constraintResolutionGuiConfig||{},{pluginId:"constraintresolutiongui",ptype:"constraintresolutiongui"})),this.showProjectLines&&e.push(Ext.apply({pluginId:"gantt_projectlines",ptype:"gantt_projectlines"},this.projectLinesConfig)),this.enableTaskReordering){this.lockedViewConfig=this.lockedViewConfig||{},this.lockedViewConfig.plugins=[].concat(this.lockedViewConfig.plugins||[]);var t,i=this.lockedViewConfig.plugins;if(Ext.Array.forEach(i,function(e){"treeviewdragdrop"!==e&&"treeviewdragdrop"!==e.ptype||(t=!0)}),!t){var n="boolean"!=typeof this.enableTaskReordering?this.enableTaskReordering:{ptype:"treeviewdragdrop",pluginId:"bryntum_treedragdrop",containerScroll:!0,dragZone:{onBeforeDrag:Ext.Function.bind(this.onBeforeTaskReorder,this)}};i.push(n)}}},getWorkingTimePlugin:function(){return this.workingTimePlugin},registerLockedDependencyListeners:function(){var e=this,t=this.getDependencyStore();this._lockedDependencyListeners=this._lockedDependencyListeners||{load:function(){var t=e.getTaskStore();t.resetEarlyDates(),t.resetLateDates(),e.lockedGrid.getView().refresh()},clear:function(){var t=e.getTaskStore();t.resetEarlyDates(),t.resetLateDates(),e.lockedGrid.getView().refresh()},add:function(t,i){for(var n=0;n<i.length;n++)e.updateDependencyTasks(i[n])},update:function(t,i,n){if(n!=Ext.data.Model.COMMIT){var r=e.lockedGrid.view,a=r.store;if(i.previous[i.fromField]){var s=e.taskStore.getModelById(i.previous[i.fromField]);s&&r.refreshNode(a.indexOf(s))}if(i.previous[i.toField]){var o=e.taskStore.getModelById(i.previous[i.toField]);o&&r.refreshNode(a.indexOf(o))}e.updateDependencyTasks(i)}},remove:function(t,i){Ext.Array.each(i,function(t){e.updateDependencyTasks(t)})}},this.mun(t,this._lockedDependencyListeners),this.mon(t,this._lockedDependencyListeners)},updateDependencyTasks:function(e){var t=e.getSourceTask(this.taskStore),i=e.getTargetTask(this.taskStore),n=this.lockedGrid.getView(),r=n.store.indexOf(t),a=n.store.indexOf(i);t&&t.getTreeStore()&&r>=0&&n.refreshNode(r),i&&i.getTreeStore()&&a>=0&&n.refreshNode(a)},showBaseline:function(){this.addCls("sch-ganttpanel-showbaseline")},hideBaseline:function(){this.removeCls("sch-ganttpanel-showbaseline")},toggleBaseline:function(){this.toggleCls("sch-ganttpanel-showbaseline")},zoomToFit:function(e,t){t=Ext.apply({adjustStart:1,adjustEnd:1},t),!e&&this.taskStore.isTreeFiltered()&&(e=this.getSchedulingView().store.getRange());var i=e?this.taskStore.getTimeSpanForTasks(e):this.taskStore.getTotalTimeSpan();null===this.zoomToSpan(i,t)&&(e||this.fitTimeColumns())},getCascadeChanges:function(){return this.taskStore.cascadeChanges},setCascadeChanges:function(e){this.taskStore.cascadeChanges=e},getRecalculateParents:function(){return this.taskStore.recalculateParents},setRecalculateParents:function(e){this.taskStore.recalculateParents=e},setSkipWeekendsDuringDragDrop:function(e){this.taskStore.skipWeekendsDuringDragDrop=this.skipWeekendsDuringDragDrop=e},getSkipWeekendsDuringDragDrop:function(){return this.taskStore.skipWeekendsDuringDragDrop},bindResourceStore:function(e,t){var i=this,n={scope:i,update:i.onResourceStoreUpdate,datachanged:i.onResourceStoreDataChanged};!t&&i.resourceStore&&(e!==i.resourceStore&&i.resourceStore.autoDestroy?i.resourceStore.destroy():i.mun(i.resourceStore,n),e||(i.resourceStore=null)),e&&(e=Ext.data.StoreManager.lookup(e),i.mon(e,n),this.taskStore.setResourceStore(e)),i.resourceStore=e,e&&!t&&i.refreshViews()},refreshViews:function(){if(this.rendered){var e=this.lockedGrid.getView(),t={left:e.getScrollX(),top:e.getScrollY()};e.refresh(),this.getSchedulingView().refreshKeepingScroll(),e.setScrollX(t.left),e.setScrollY(t.top)}},bindAssignmentStore:function(e,t){var i=this,n={scope:i,beforetaskassignmentschange:i.onBeforeSingleTaskAssignmentChange,taskassignmentschanged:i.onSingleTaskAssignmentChange,update:i.onAssignmentStoreUpdate,datachanged:i.onAssignmentStoreDataChanged};!t&&i.assignmentStore&&(e!==i.assignmentStore&&i.assignmentStore.autoDestroy?i.assignmentStore.destroy():i.mun(i.assignmentStore,n),e||(i.assignmentStore=null)),e&&(e=Ext.data.StoreManager.lookup(e),i.mon(e,n),this.taskStore.setAssignmentStore(e)),i.assignmentStore=e,e&&!t&&i.refreshViews()},onResourceStoreUpdate:function(e,t){var i=t.getTasks();Ext.Array.each(i,function(e){var t=this.lockedGrid.view.store.indexOf(e);t>=0&&this.getView().refreshNode(t)},this)},onResourceStoreDataChanged:function(){this.taskStore.getRootNode().childNodes.length>0&&this.refreshViews()},onAssignmentStoreDataChanged:function(){this.taskStore.getRootNode().childNodes.length>0&&this.refreshViews()},onAssignmentStoreUpdate:function(e,t){var i=t.getTask();if(i){var n=this.lockedGrid.view.store.indexOf(i);n>=0&&this.getView().refreshNode(n)}},onBeforeSingleTaskAssignmentChange:function(){this.assignmentStore.un("datachanged",this.onAssignmentStoreDataChanged,this)},onSingleTaskAssignmentChange:function(e,t){if(this.assignmentStore.on("datachanged",this.onAssignmentStoreDataChanged,this),this.rendered){var i=this.taskStore.getModelById(t);if(i&&i.parentNode){var n=this.taskStore.indexOf(i);n>=0&&this.getView().refreshNode(n)}}},updateAutoGeneratedCells:function(e,t){var i=this.lockedGrid.view,n=i.all.startIndex,r=i.all.endIndex;if(!(t<0||t>r))for(var a=Math.max(n,t);a<=r;a++){var s=i.store.getAt(a),o=this.getCellDom(i,s,e);o&&(o.firstChild.innerHTML=e.renderer(null,null,s))}},getCellDom:function(e,t,i){var n=e.getNode(t,!0);return n&&Ext.fly(n).down(i.getCellSelector(),!0)},redrawColumns:function(e){if(e.length&&!this.isDestroyed)for(var t=this.lockedGrid.view,i=t.all.startIndex;i<=t.all.endIndex;i++)for(var n=t.store.getAt(i),r=0,a=e.length;r<a;r++){var s=this.getCellDom(t,n,e[r]);if(s){var o=[];t.renderCell(e[r],n,i,e[r].getIndex(),i,o),s.innerHTML=o.join("")}}},updateSlackColumns:function(){this.slackColumn&&this.redrawColumns([this.slackColumn])},updateEarlyDateColumns:function(){var e=[];this.earlyStartColumn&&e.push(this.earlyStartColumn),this.earlyEndColumn&&e.push(this.earlyEndColumn),e.length&&this.redrawColumns(e)},updateLateDateColumns:function(){var e=[];this.lateStartColumn&&e.push(this.lateStartColumn),this.lateEndColumn&&e.push(this.lateEndColumn),e.length&&this.redrawColumns(e)},onMyViewReady:function(){this.on("beforeedit",function(e,t){var i=t.column;return!this.isReadOnly()&&t.record.isEditable(t.field)&&(!i.isEditable||i.isEditable(t.record))},this),this.setupColumnListeners();var e=this.getDependencyView();this.getView().on({expandbody:e.renderAllDependencies,collapsebody:e.renderAllDependencies,scope:e});var t=this.lockedGrid.plugins||[];Ext.Array.each(t,function(e){if(Sch.plugin&&Sch.plugin.TreeCellEditing&&e instanceof Sch.plugin.TreeCellEditing)return this.ganttEditingPlugin=e,!1},this),this.mon(this.taskStore,{"nodestore-datachange-start":this.onFilterChange,"filter-clear":this.onFilterChange,scope:this});var i=this.down("splitter");i&&i.on("dragend",function(){this.saveState()},this,{delay:10})},onFilterChange:function(){this.getSelectionModel().deselectAll()},setupColumnListeners:function(){var e=this,t=this.lockedGrid.headerCt;t.on("add",this.onLockedColumnAdded,this),t.items.each(function(i){e.onLockedColumnAdded(t,i)})},onLockedColumnAdded:function(e,t){var i=Gnt.column;i&&(i.WBS&&t instanceof i.WBS||i.Sequence&&t instanceof i.Sequence?this.bindSequentialDataListeners(t):i.Dependency&&t instanceof i.Dependency&&t.useSequenceNumber?this.bindFullRefreshListeners(t):i.EarlyStartDate&&t instanceof i.EarlyStartDate?this.earlyStartColumn=t:i.EarlyEndDate&&t instanceof i.EarlyEndDate?this.earlyEndColumn=t:i.LateStartDate&&t instanceof i.LateStartDate?this.lateStartColumn=t:i.LateEndDate&&t instanceof i.LateEndDate?this.lateEndColumn=t:i.Slack&&t instanceof i.Slack&&(this.slackColumn=t)),!this.slackListeners&&this.slackColumn&&this.bindSlackListeners(),this.earlyDatesListeners||!this.earlyStartColumn&&!this.earlyEndColumn||this.bindEarlyDatesListeners(),this.lateDatesListeners||!this.lateStartColumn&&!this.lateEndColumn||this.bindLateDatesListeners()},getState:function(){var e=this,t=e.callParent(arguments);return t.lockedWidth=e.lockedGrid.getWidth(),t},applyState:function(e){var t=this;t.callParent(arguments),e&&e.lockedWidth&&t.lockedGrid.setWidth(e.lockedWidth)},completeEdit:function(){this.ganttEditingPlugin&&this.ganttEditingPlugin.completeEdit()},cancelEdit:function(){this.ganttEditingPlugin&&this.ganttEditingPlugin.cancelEdit()},setRowHeight:function(e){var t="#"+this.getId()+" ."+Ext.baseCSSPrefix+"grid-cell";Ext.util.CSS.getRule(t)?Ext.util.CSS.updateRule(t,"height",e+"px"):Ext.util.CSS.createStyleSheet(t+"{ height:"+e+"px; }"),this.getSchedulingView().setRowHeight(e)},getTaskEditor:function(e){for(var t=this.plugins,i=0,n=t.length;i<n;i++){var r=t[i];if(r.isTaskEditor&&(!e||r.matchFilters(e)))return r}},onRowClicked:function(e,t){this.getSchedulingView().scrollEventIntoView(t,!1,!1)},onBeforeTaskReorder:function(){return!this.isReadOnly()}}),Ext.define("Gnt.view.ResourceHistogram",{extend:Sch.view.TimelineGridView,alias:"widget.resourcehistogramview",_cmpCls:"gnt-resourcehistogramview",scheduledEventName:"bar",eventSelector:".gnt-resourcehistogram-bar",barTpl:null,barRenderer:Ext.emptyFn,limitLineRenderer:Ext.emptyFn,lineRenderer:Ext.emptyFn,lineTpl:null,limitLineTpl:null,_barCls:"gnt-resourcehistogram-bar",_limitLineCls:"gnt-resourcehistogram-limitline",_limitLineVerticalCls:"gnt-resourcehistogram-limitline-vertical",_lineCls:"gnt-resourcehistogram-line",barCls:null,limitLineCls:null,lineCls:null,limitLineWidth:1,rowHeight:60,showLimitLinesThreshold:10,showVerticalLimitLines:!0,labelMode:!1,labelPercentFormat:"0",labelUnitsFormat:"0.0",histogram:null,unitHeight:null,availableRowHeight:null,initComponent:function(e){this.barCls&&(this.eventSelector="."+this.barCls),this.barTpl||(this.barTpl=new Ext.XTemplate('<tpl for=".">','<div id="{id}" class="gnt-resourcehistogram-bar '+(this.barCls||"")+' {cls}" gnt-bar-index="{index}" style="left:{left}px;top:{top}px;height:{height}px;width:{width}px">',"<tpl if=\"text !== ''\">",'<span class="gnt-resourcehistogram-bar-text" style="bottom:'+Math.floor(this.rowHeight/2)+'px">{text}</span>',"</tpl>","</div>","</tpl>")),this.lineTpl||(this.lineTpl=new Ext.XTemplate('<tpl for=".">','<div class="gnt-resourcehistogram-line '+(this.lineCls||"")+' {cls}" style="top:{top}px;"></div>',"</tpl>")),this.limitLineTpl||(this.limitLineTpl=new Ext.XTemplate('<tpl for=".">','<div class="gnt-resourcehistogram-limitline '+(this.limitLineCls||"")+' {cls}" style="left:{left}px;top:{top}px;width:{width}px;height:{height}px"></div>',"</tpl>")),this.callParent(arguments),this.unitHeight=this.getAvailableRowHeight()/(this.scaleMax-this.scaleMin+this.scaleStep)},renderLines:function(){return this.lineTpl.apply(this.prepareLines())},prepareLines:function(){var e,t,i=this.scaleMin,n=this.scaleMax,r=i,a=this.scaleLabelStep,s=this.getAvailableRowHeight(),o=[],l=this._lineCls,d=l+"min";if(this.scalePoints)for(var c=0,h=this.scalePoints.length;c<h;c++){var u=this.scalePoints[c];e={value:u.value,top:u.top||Math.round(s-this.unitHeight*(u.value-i)),cls:u.cls+(u.label?" "+l+"-label":"")+(0===c?" "+l+"-min":c==h?" "+l+"-max":"")},t=this.lineRenderer(o,e),o.push(Ext.apply(e,t))}else{for(;r<=n;)e={value:r,top:Math.round(s-this.unitHeight*(r-i)),cls:d},t=this.lineRenderer(o,e),o.push(Ext.apply(e,t)),r+=this.scaleStep,d=r%a?"":l+"-label",r==n&&(d+=" "+l+"-max");o.length&&o[o.length-1].value!==n&&(e={value:n,top:Math.round(s-this.unitHeight*(n-i)),cls:(n%a?"":l+"-label")+" "+l+"-max"},t=this.lineRenderer(o,e),o.push(Ext.apply(e,t)))}return o},renderLimitLines:function(e){return this.limitLineTpl.apply(this.prepareLimitLines(e))},getLimitLinesConnector:function(e,t){return{left:e.right,width:1,top:Math.min(e.top,t.top),height:Math.abs(e.top-t.top)+this.limitLineWidth,cls:this._limitLineCls+"-top "+this._limitLineVerticalCls}},pushLimitLine:function(e,t,i){var n=e[e.length-1];i&&(n?(n.width=i.right-n.left,n.right=i.right):(t.left=i.left,t.width=t.right-i.left)),n&&this.showVerticalLimitLines&&(n.visible||e.pop(),e.push(this.getLimitLinesConnector(n,t)));var r=this.limitLineRenderer(e,t,i);e.push(Ext.apply(t,r))},prepareLimitLines:function(e){if(e){for(var t,i,n,r=[],a=this.scaleMin,s=this.scaleMax,o=this.scaleStep,l=this.scaleUnit,d=this.getAvailableRowHeight(),c=this._limitLineCls,h=this.getTimeAxisViewModel()&&this.getTimeAxisViewModel().getTotalWidth(),u=0,g=e.length;u<g;u++){var f=this.calendar.convertMSDurationToUnit(e[u].allocationMS,l),p=!0;f*this.unitHeight>d?(f=s+o,p=!1):f<=0&&(f=0,p=!1);var m=e[u].startDate&&this.getXFromDate(e[u].startDate,!0)||0,v=e[u].endDate&&this.getXFromDate(e[u].endDate,!0)||h;m<0&&(m=0),v<0&&(v=h),i={left:m,width:v-m,right:v,top:"",height:0,cls:"",visible:p},i.top=Math.round(d-(f-a)*this.unitHeight),p&&(i.cls+=" "+c+"-top"),n=r[r.length-1]||t;var S=i.width<=this.showLimitLinesThreshold;if(n&&(i.top==n.top||S&&!p))n.width=v-n.left,n.right=v,i=null,r[r.length-1]?t=null:t.width>this.showLimitLinesThreshold&&(this.pushLimitLine(r,t),t=null);else if(S&&p){if(t){var y=t.width+i.width;t.top=Math.round(i.top*i.width/y+t.top*t.width/y),t.width=v-t.left,t.right=v}else t=i;t.width>this.showLimitLinesThreshold&&(this.pushLimitLine(r,t),i=t=null)}else this.pushLimitLine(r,i,t),i=t=null}return i&&this.pushLimitLine(r,i,t),n=r[r.length-1],n&&!n.visible&&r.pop(),r}},renderBars:function(e,t){return this.barTpl.apply(this.prepareBars(e,t))},prepareBars:function(e,t){if(e){for(var i,n,r=[],a=this.getAvailableRowHeight(),s=this._barCls,o=this.scaleUnit,l=Sch.util.Date.getShortNameOfUnit(o),d=this.scaleMin,c=this.scaleMax,h=this.scaleStep,u=c+h,g=0,f=e.length;g<f;g++)if(e[g].totalAllocation){if(n=this.calendar.convertMSDurationToUnit(e[g].allocationMS,o),i={id:t+"-"+g,index:g,left:this.getXFromDate(e[g].startDate,!0),width:this.getXFromDate(e[g].endDate,!0)-this.getXFromDate(e[g].startDate,!0),height:a,top:0,text:"",cls:""},this.labelMode)switch(this.labelMode){case"percent":i.text=Ext.util.Format.number(e[g].totalAllocation,this.labelPercentFormat)+"%";break;case"units":i.text=Ext.util.Format.number(n,this.labelUnitsFormat)+l;break;default:i.text=this.labelMode.apply({allocation:n,percent:e[g].totalAllocation})}n<=u?(i.height=n>=d?Math.round((n-d)*this.unitHeight):0,i.top=a-i.height):i.cls+=" "+s+"-partofbar",(e[g].totalAllocation>100||e[g].totalOverAllocationMS>0)&&(i.cls+=" "+s+"-overwork");var p=this.barRenderer(t,e[g],i);p&&p.cls&&(p.cls=i.cls+" "+p.cls),i=Ext.apply(i,p),r.push(i)}return r}},getAvailableRowHeight:function(){return this.availableRowHeight?this.availableRowHeight:(this.availableRowHeight=this.rowHeight-this.cellTopBorderWidth-this.cellBottomBorderWidth,this.availableRowHeight)},resolveEventRecord:function(e){var t=this.findItemByChild(e);if(t){var i=this.getRecord(t);if(i){var n={resource:i},r=this.histogram.allocationData[i.getId()],a=e.getAttribute("gnt-bar-index"),s=r.bars[a];return s&&(n.startDate=s.startDate,n.endDate=s.endDate,n.assignments=s.assignments,n.allocationMS=s.allocationMS,n.totalAllocation=s.totalAllocation),n}}return null},resolveEventRecordFromResourceRow:function(e){return this.resolveEventRecord(e)},getDataForTooltipTpl:function(e){return e}}),Ext.define("Gnt.panel.ResourceHistogram",{extend:Sch.panel.TimelineGridPanel,mixins:[Gnt.mixin.Localizable],alias:"widget.resourcehistogram",viewType:"resourcehistogramview",layout:"border",preserveScrollOnRefresh:!0,showScaleLines:!1,showLimitLines:!0,showLimitLinesThreshold:10,showVerticalLimitLines:!0,cacheLimitDurationMS:0,cacheLimitDuration:6,cacheLimitDurationUnit:"mo",calendarResources:null,calendarListenersHash:null,calendar:null,taskStore:null,resourceStore:null,assignmentStore:null,startDate:null,endDate:null,highlightWeekends:!0,allocationData:null,scaleUnit:"HOUR",scaleMin:0,scaleMax:24,scaleLabelStep:4,scaleStep:2,rowHeight:50,scaleColumnClass:"Gnt.column.Scale",scaleColumnConfigs:["scalePoints","scaleStep","scaleLabelStep","scaleMin","scaleMax","scaleLabelStep","scaleStep"],normalViewConfigs:["barCls","barTpl","barRenderer","lineRenderer","limitLineRenderer","lineTpl","lineCls","limitLineTpl","limitLineCls","limitLineWidth","labelMode","labelPercentFormat","labelUnitsFormat","scaleMin","scaleMax","scaleStep","scaleLabelStep","scalePoints","scaleUnit","loadMask","showLimitLinesThreshold","showVerticalLimitLines","calendar"],cacheUpdateSuspended:!1,suspendedCacheUpdatesCount:0,gapThreshold:864e5,initComponent:function(){var e=new Date;this.cacheLimitDurationMS=Sch.util.Date.add(e,this.cacheLimitDurationUnit,1)-e,this.resetAllocationDataCache(),this.initStores(),this.lockedGridConfig=Ext.applyIf(this.lockedGridConfig||{},{reserveScrollbar:!1,width:300,forceFit:!0}),this.normalViewConfig=Ext.apply(this.normalViewConfig||{},{histogram:this,trackOver:!1,rowHeight:this.rowHeight,preserveScrollOnRefresh:this.preserveScrollOnRefresh}),this.lockedViewConfig=Ext.apply(this.lockedViewConfig||{},{rowHeight:this.rowHeight,preserveScrollOnRefresh:this.preserveScrollOnRefresh}),this.scalePoints&&(this.scalePoints.sort(function(e,t){return e.value>t.value?1:-1}),this.scaleMin=this.scalePoints[0].value,this.scaleMax=this.scalePoints[this.scalePoints.length-1].value,this.scaleStep=(this.scaleMax-this.scaleMin)/10),this.initColumns(),Ext.Array.forEach(this.normalViewConfigs,function(e){e in this&&(this.normalViewConfig[e]=this[e])},this),this.highlightWeekends&&this.initWeekendsHightlight(),this.callParent(arguments);var t="gnt-resourcehistogram sch-horizontal ";this.highlightWeekends&&(t+=" gnt-resourcehistogram-highlightweekends "),this.addCls(t),this.registerRenderer(this.columnRenderer,this);var i=this.getSchedulingView();this.relayEvents(i,["barclick","bardblclick","barcontextmenu"]),this.syncRowHeight||this.enableRowHeightInjection(this.lockedGrid.getView(),i)},initStores:function(){var e=!1;if(this.crudManager&&(this.setCrudManager(this.crudManager),e=!0),this.store=this.resourceStore,this.taskStore=this.taskStore||this.store.getTaskStore(),this.calendar=this.calendar||this.taskStore&&this.taskStore.getCalendar(),!this.calendar)throw'Cannot get pms calendar instance: please specify either "calendar" or "taskStore" option';this.assignmentStore=this.assignmentStore||this.store.getAssignmentStore()||this.taskStore&&this.taskStore.getAssignmentStore(),e||this.bindStores()},getCrudManager:function(){return this.crudManager},setCrudManager:function(e){this.unbindStores(),this.crudManagerListeners&&this.crudManagerListeners.destroy(),this.crudManager=e,this.taskStore=this.crudManager.getTaskStore(),this.store=this.resourceStore=this.crudManager.getResourceStore(),this.assignmentStore=this.crudManager.getAssignmentStore(),this.crudManagerListeners=this.mon(this.crudManager,{beforeloadapply:{fn:this.beforeCrudManagerLoad,priority:-999},load:this.afterCrudManagerLoad,destroyable:!0,scope:this}),this.bindStores()},beforeCrudManagerLoad:function(){this.suspendStoreListeners()},afterCrudManagerLoad:function(){this.beforeCrudOperationStart(this.crudManager,null,"load"),this.resumeStoreListeners(!0),this.onCrudOperationComplete()},bindStores:function(){this.taskStore&&this.mon(this.taskStore,{refresh:this.onTaskStoreRefresh,load:this.onTaskStoreRefresh,update:this.onTaskUpdate,nodeappend:this.onTaskUpdate,scope:this}),this.assignmentStore&&this.mon(this.assignmentStore,{refresh:this.onAssignmentsRefresh,remove:this.onAssignmentsChange,update:this.onAssignmentUpdate,add:this.onAssignmentsChange,scope:this}),this.calendar&&this.mon(this.calendar,{calendarchange:this.onProjectCalendarChange,scope:this}),this.bindCalendarListeners(),this.store&&this.mon(this.store,{update:this.onResourceUpdate,refresh:this.onResourceStoreRefresh,scope:this,priority:100})},unbindStores:function(){this.taskStore&&this.mun(this.taskStore,{refresh:this.onTaskStoreRefresh,load:this.onTaskStoreRefresh,update:this.onTaskUpdate,nodeappend:this.onTaskUpdate,scope:this}),this.assignmentStore&&this.mun(this.assignmentStore,{refresh:this.onAssignmentsRefresh,remove:this.onAssignmentsChange,update:this.onAssignmentUpdate,add:this.onAssignmentsChange,scope:this}),this.calendar&&this.mun(this.calendar,{calendarchange:this.onProjectCalendarChange,scope:this}),this.unbindCalendarListeners(),this.store&&this.mun(this.store,{update:this.onResourceUpdate,refresh:this.onResourceStoreRefresh,scope:this,priority:100})},suspendStoreListeners:function(){this.cacheUpdateSuspended=!0,this.suspendedCacheUpdatesCount=0,this.unbindStores()},resumeStoreListeners:function(e){this.cacheUpdateSuspended=!1,this.bindStores(),e&&this.suspendedCacheUpdatesCount&&this.clearCacheAndRefresh()},clearCacheAndRefresh:function(e){this.resetAllocationDataCache(e),this.refreshIfRendered(e)},createDefaultColumns:function(){var e,t,i=[];return e=this.resourceNameCol=new Ext.grid.column.Column({flex:1,resizable:!1,header:this.resourceText||this.L("resourceText"),dataIndex:this.resourceStore.model.prototype.nameField}),i.push(e),t={width:40,resizable:!1},Ext.copyTo(t,this,this.scaleColumnConfigs,!0),t=this.scaleCol=Ext.create(this.scaleColumnClass,t),this.mon(t,{beforerender:function(){t.setAvailableHeight(this.getSchedulingView().getAvailableRowHeight()),this.scalePoints&&(this.scalePoints=t.scalePoints)},scope:this,single:!0}),i.push(t),i},initColumns:function(){if(this.columns)for(var e=Ext.isArray(this.columns)?this.columns:[this.columns],t=0;t<e.length;t++){var i=e[t];this.isScaleColumn(i)&&(Ext.copyToIf(i,this,this.scaleColumnConfigs),i instanceof Gnt.column.Scale||(i=e[t]=Ext.ComponentManager.create(i,i.xtype)),this.mon(i,{beforerender:function(){i.setAvailableHeight(this.getSchedulingView().getAvailableRowHeight())},scope:this,single:!0}))}else{this.columns=this.createDefaultColumns();var n=this.scaleCol;this.scalePoints&&(this.scaleMin=n.scaleMin,this.scaleMax=n.scaleMax,this.scaleStep=n.scaleStep)}},isScaleColumn:function(e){var t=e.xtype&&Ext.ClassManager.getByAlias(e.xtype);return t=t&&t.prototype,e instanceof Gnt.column.Scale||t&&t instanceof Gnt.column.Scale},initWeekendsHightlight:function(){this.workingTimePlugin=new Gnt.feature.WorkingTime({calendar:this.calendar}),this.plugins=[].concat(this.plugins||[]),this.plugins.push(this.workingTimePlugin)},destroy:function(){this.unbindStores(),this.callParent(arguments)},getEventStore:function(){return this.taskStore},getTimeSpanDefiningStore:function(){return this.taskStore},unbindResourceCalendarListener:function(e,t){var i=this.calendarResources[t];i&&(Ext.Array.remove(i,e),i.length||(this.calendarListenersHash[t].destroy(),delete this.calendarListenersHash[t],delete this.calendarResources[t]))},bindResourceCalendarListener:function(e){var t=this,i=e.getOwnCalendar(),n=i.getCalendarId();t.calendarListenersHash[n]||(t.calendarListenersHash[n]=t.mon(i,{load:t.onCalendarChange,calendarchange:t.onCalendarChange,scope:t,destroyable:!0})),t.calendarResources[n]?-1===Ext.Array.indexOf(t.calendarResources,e)&&t.calendarResources[n].push(e):t.calendarResources[n]=[e]},bindCalendarListeners:function(){var e=this;e.unbindCalendarListeners(),e.store.each(function(t){var i=t.getOwnCalendar();i&&i!==e.calendar&&e.bindResourceCalendarListener(t)})},unbindCalendarListeners:function(){for(var e in this.calendarListenersHash)this.calendarListenersHash[e].destroy();this.calendarResources=[],this.calendarListenersHash={}},onTaskStoreRefresh:function(){this.clearCacheAndRefresh()},onCalendarChange:function(e){var t=this.calendarResources[e.getCalendarId()];if(t)for(var i=0;i<t.length;i++)this.clearCacheAndRefresh(t[i])},onProjectCalendarChange:function(){this.clearCacheAndRefresh()},onTaskUpdate:function(e,t){var i;i=this.assignmentStore&&t.getAssignmentStore()!=this.assignmentStore?this.assignmentStore.getAssignmentsForTask(t.getId()):t.getAssignments(),this.onAssignmentsChange(this.assignmentStore,i)},onAssignmentsRefresh:function(e){this.onAssignmentsChange(e,e.getRange())},onAssignmentUpdate:function(e,t,i,n){var r,a=this,s=a.assignmentStore.model.prototype.resourceIdField;if(i==Ext.data.Model.EDIT){if(n&&Ext.Array.contains(n,s)){var o=t.previous[s]
;r=this.resourceStore.getModelById(o),r&&this.clearCacheAndRefresh(r)}a.onAssignmentsChange(e,[t])}},onAssignmentsChange:function(e,t){var i,n=this;Ext.isArray(t)||(t=[t]);for(var r=0,a=t.length;r<a;r++)(i=n.resourceStore.getModelById(t[r].getResourceId()))&&!i.inOnCalendarChange&&n.clearCacheAndRefresh(i)},enableRowHeightInjection:function(e,t){var i=new Ext.XTemplate("{%","this.processCellValues(values);","this.nextTpl.applyOut(values, out, parent);","%}",{priority:1,processCellValues:function(e){if("horizontal"==t.orientation){var i=t.getAvailableRowHeight();e.style=(e.style||"")+";height:"+i+"px;"}}});e.addCellTpl(i),t.addCellTpl(i)},findEndIndex:function(e,t){t=t||this.getEndDate();for(var i=e.length-1,n=i;n>=0;n--)if(e[n].startDate<t){i=n;break}return i},findStartIndex:function(e,t){t=t||this.getStartDate();for(var i=0,n=0,r=e.length;n<r;n++)if(e[n].endDate>t){i=n;break}return i},resetAllocationDataCache:function(e){var t=this;e?(t.allocationData=t.allocationData||{},t.allocationData[e.getId()]=null):t.allocationData={}},constrainAllocationDataCache:function(e){var t=this,i=new Date(t.timeAxis.getStart()-this.cacheLimitDurationMS),n=new Date(t.timeAxis.getEnd()-0+this.cacheLimitDurationMS),r=e.maxBars.length-1,a=0,s=e.bars.length-1,o=0,l=!1;return e.cacheEnd>n&&(r=t.findEndIndex(e.maxBars,n),s=t.findEndIndex(e.bars,n),e.cacheEnd=n,l=!0),e.cacheStart<i&&(a=t.findStartIndex(e.maxBars,i),o=t.findStartIndex(e.bars,i),e.cacheStart=i,l=!0),l&&(e.maxBars=Ext.Array.splice(e.maxBars,a,r+1-a),e.bars=Ext.Array.splice(e.bars,o,s+1-o)),l},updateAllocationDataCache:function(e,t,i){var n,r,a,s,o,l=Sch.util.Date,d=this;if(d.cacheUpdateSuspended)return void d.suspendedCacheUpdatesCount++;if(t=t||d.getStartDate(),i=i||d.getEndDate(),e){if(n=d.allocationData[e.getId()]||{},r=n.cacheStart,a=n.cacheEnd,r!=t||a!=i)if(r&&a&&l.intersectSpans(r,a,t,i)){if(r>t){if(s=d.processAllocationData(e.getAllocationInfo({startDate:t,endDate:r,includeResCalIntervals:!0})),s.maxBars.length&&s.maxBars[s.maxBars.length-1].startDate.getTime()===r.getTime()&&s.maxBars.pop(),s.bars.length&&n.bars.length){var c=s.bars[s.bars.length-1],h=n.bars[0];c.startDate>=h.startDate&&c.endDate<=h.endDate&&s.bars.pop()}s.maxBars.length&&(s.maxBars[s.maxBars.length-1].endDate=r),n.maxBars.length&&(n.maxBars[0].startDate=r),n.bars=s.bars.concat(n.bars),n.maxBars=s.maxBars.concat(n.maxBars),n.maxBarsStartIndex=0,n.barsStartIndex=0,n.cacheStart=t}if(a<i){if(o=d.processAllocationData(e.getAllocationInfo({startDate:a,endDate:i,includeResCalIntervals:!0})),o.maxBars.length){var u=o.maxBars[0];u.endDate.getTime()===a.getTime()?o.maxBars.shift():u.startDate=a}if(o.bars.length&&n.bars.length){var g=o.bars[0],f=n.bars[n.bars.length-1];g.startDate>=f.startDate&&g.endDate<=f.endDate&&o.bars.shift()}o.maxBars.length&&(o.maxBars[o.maxBars.length-1].endDate=i),n.maxBars.length&&(n.maxBars[n.maxBars.length-1].endDate=a),n.bars=n.bars.concat(o.bars),n.maxBars=n.maxBars.concat(o.maxBars),n.maxBarsEndIndex=n.maxBars.length-1,n.barsEndIndex=n.bars.length-1,n.cacheEnd=i}d.cacheLimitDuration>0&&d.constrainAllocationDataCache(n),n.maxBarsStartIndex=d.findStartIndex(n.maxBars,t),n.barsStartIndex=d.findStartIndex(n.bars,t),n.maxBarsEndIndex=d.findEndIndex(n.maxBars,i),n.barsEndIndex=d.findEndIndex(n.bars,i)}else n=d.processAllocationData(e.getAllocationInfo({startDate:t,endDate:i,includeResCalIntervals:!0})),n.maxBarsStartIndex=0,n.maxBarsEndIndex=n.maxBars.length-1,n.barsStartIndex=0,n.barsEndIndex=n.bars.length-1,n.cacheStart=t,n.cacheEnd=i;d.allocationData[e.getId()]=n}else d.resourceStore.each(function(e){d.updateAllocationDataCache(e,t,i)})},isBarAssignmentsChanged:function(e){var t=e.bar,i=e.period;if(!(t.assignments&&i.inResourceCalendar&&i.totalAllocation&&i.inTasksCalendar))return!1;for(var n=0,r=t.assignments.length;n<r;n++)if(i.assignmentsHash[t.assignments[n].getTaskId()])return!1;return!0},openBar:function(e,t){return t.bar={startDate:e,totalAllocation:t.period.totalAllocation,allocationMS:t.allocationMS,assignments:t.period.assignments,totalOverAllocationMS:t.totalOverAllocationMS},t.barOpened=!0,t.bar},closeBar:function(e,t){if(!t.barOpened)return!1;e&&(t.bar.endDate=e),t.bars.push(t.bar),t.barOpened=!1},appendZeroMaxBars:function(e,t,i){if(!e)return!1;var n=this;if(Sch.util.Date.getDurationInDays(e,t)<2)return!1;var r=!0,a=i.maxBar,s=i.maxBars;return a&&(a.allocationMS?(a.endDate=Sch.util.Date.getStartOfNextDay(e,!0),s.push(a)):r=!1),r&&(i.maxBar={startDate:a&&a.endDate||n.getStart(),allocationMS:0}),i.maxAllocationMS=0,i.maxBar},getMergePeriodStart:function(e){return Ext.Date.clearTime(e,!0)},processAllocationData:function(e){var t,i,n,r,a,s,o,l,d,c,h,u=[],g=[],f=this,p={bars:u,maxBars:g},m=f.getMergePeriodStart(e[0].startDate);m>this.getStartDate()&&g.push({startDate:this.getStartDate(),endDate:m,allocationMS:0});for(var v=0,S=e.length;v<S;v++){if(t=p.period=e[v],(m=f.getMergePeriodStart(t.startDate))-r!=0){this.showLimitLines&&f.appendZeroMaxBars(r,m,p)&&(n=p.maxBar),r=m,l=p.allocationMS,p.totalOverAllocationMS,c=p.maxAllocationMS,o=0,h=0,d=0;for(var y=v;e[y]&&f.getMergePeriodStart(e[y].startDate)-m==0;)e[y].inResourceCalendar&&(d+=e[y].endDate-e[y].startDate,e[y].totalAllocationMS&&(o+=e[y].totalAllocationMS,h+=e[y].totalOverAllocationMS||0)),y++;p.allocationMS=o,p.totalOverAllocationMS=h,p.maxAllocationMS=d}else m=!1;if(f.showLimitLines&&(m&&d!=c&&(n&&(n.endDate=m,g.push(n)),n=p.maxBar={startDate:m,allocationMS:d}),n.endDate=t.endDate),p.barOpened)if(t.inTask){var E=!1;f.isBarAssignmentsChanged(p)?(a=i.endDate,s=new Date(t.startDate),E=!0):m&&m-i.endDate>=f.gapThreshold?(a=Ext.Date.clearTime(i.endDate,!0),a<i.endDate&&(a=Sch.util.Date.add(a,Sch.util.Date.DAY,1)),s=Ext.Date.clearTime(t.startDate,!0),E=!0):m&&o!==l&&t.totalAllocation&&(a=s=Ext.Date.clearTime(t.startDate,!0),E=!0),E&&(f.closeBar(a,p),i=f.openBar(s,p))}else f.closeBar(null,p);else t.inTask&&(i=f.openBar(new Date(t.startDate),p));p.barOpened&&(i.endDate=t.endDate)}return f.closeBar(null,p),f.showLimitLines&&(f.appendZeroMaxBars(r||f.getStart(),f.getEnd(),p)&&(n=p.maxBar),n&&g.push(n)),{bars:u,maxBars:g}},onResourceUpdate:function(e,t,i,n){if(Ext.Array.indexOf(n,t.calendarIdField)>-1){this.resetAllocationDataCache(t);var r=t.previous[t.calendarIdField];this.unbindResourceCalendarListener(t,r);var a=t.getOwnCalendar();a&&a!==this.calendar&&this.bindResourceCalendarListener(t)}},onResourceStoreRefresh:function(){var e=this;e.clearCacheAndRefresh(),e.bindCalendarListeners()},refreshIfRendered:function(e){var t=this;t.rendered&&t.resourceStore&&e?t.getView().refreshNode(t.resourceStore.indexOf(e)):t.rendered&&t.getView().refresh()},columnRenderer:function(e,t,i,n,r){var a,s,o,l=this,d=i.getId(),c=this.normalGrid.getView();return l.updateAllocationDataCache(i),a=l.allocationData[d],s=a&&a.bars,o=a&&a.maxBars,s&&(a.barsStartIndex>0||a.barsEndIndex<s.length-1)&&(s=Ext.Array.slice(s,a.barsStartIndex,a.barsEndIndex+1)),o&&(a.maxBarsStartIndex>0||a.maxBarsEndIndex<o.length-1)&&(o=Ext.Array.slice(o,a.maxBarsStartIndex,a.maxBarsEndIndex+1)),(l.showScaleLines?c.renderLines():"")+c.renderBars(s,d)+(l.showLimitLines?c.renderLimitLines(o):"")}}),Ext.define("Gnt.panel.ResourceUtilization",{extend:Sch.panel.SchedulerTree,alias:"widget.resourceutilizationpanel",enableDragCreation:!1,enableEventDragDrop:!1,eventResizeHandles:"none",readOnly:!0,rowHeight:32,rowLines:!0,eventBorderWidth:0,columnLines:{useLowestHeader:!0},columns:[{xtype:"treecolumn",flex:1,resizable:!1,sortable:!1,renderer:function(e,t,i){return i.isSurrogateResource()?i.getName():i.getTaskName()}}],config:{taskStore:null,numberFormat:"0"},resourceStoreClass:"Gnt.data.ResourceUtilizationStore",viewConfig:{markDirty:!1,dynamicRowHeight:!1,getRowClass:function(e){return e.data.leaf?"gnt-utilizationrow-task":"gnt-utilizationrow-resource"}},eventBodyTemplate:['<tpl for=".">','<div class="gnt-resource-utilization-interval {cls}" style="{dir}: {position}px; width: {width}px"','data-utilization-interval-start="{startTime}"','data-utilization-interval-end="{endTime}">',"{value}</div>","</tpl>"].join(""),lockedGridConfig:{width:200},initComponent:function(){var e=this;e.eventRendererScope=e,e.setupComponentStores(),e.callParent(arguments),e.provideTimeAxisToStore(),e.partnerTimelinePanel&&Ext.isFunction(e.partnerTimelinePanel.getTaskStore)&&(e.resourceStore.setTaskStore(e.partnerTimelinePanel.getTaskStore()),e.resourceStore.fillStore()),e.addCls("gnt-resourceutilizationpanel")},setupComponentStores:function(){var e=this;e.resourceStore=e.resourceStore||Ext.create(e.resourceStoreClass,{taskStore:e.getTaskStore()}),e.eventStore=e.resourceStore.getEventStore()},provideTimeAxisToStore:function(){var e=this;e.getStore().setTimeAxis(e.timeAxis)},eventRenderer:function(e,t,i){var n,r,a,s,o=Ext.util.Format,l=this,d=l.getSchedulingView(),c=e.getStartDate(),h=l.getNumberFormat(),u=[];return n=d.getXFromDate(c),e.forEachInterval(function(t,i){var c=e.getUtilizationInfoForInterval(t);r=d.getXFromDate(t),a=d.getXFromDate(i)-1,s=c.isUtilized?c.isUnderallocated&&c.isOverallocated?"gnt-resource-utilization-interval-indefinablyallocated":c.isUnderallocated?"gnt-resource-utilization-interval-underallocated":c.isOverallocated?"gnt-resource-utilization-interval-overallocated":"gnt-resource-utilization-interval-optimallyallocated":"gnt-resource-utilization-interval-notutilized",u.push({cls:s,dir:l.rtl?"right":"left",position:r-n,width:a-r,startTime:t.getTime(),endTime:i.getTime(),value:a-r>10?o.number(c.allocationMs/36e5,h):""})}),u},getRowHeight:function(){return this.rowHeight}}),Ext.define("Gnt.panel.TimelineScheduler",{extend:Sch.panel.SchedulerGrid,alias:"widget.gantt_timelinescheduler",taskStore:null,split:!1,milestoneBottomPadding:23,barMargin:0,header:!1,enableColumnMove:!1,enableColumnHide:!1,enableColumnResize:!1,sortableColumns:!1,trackMouseOver:!1,bufferedRenderer:!1,border:!1,rowLines:!1,columnLines:!1,readOnly:!0,enableDragCreation:!1,forceFit:!0,autoAdjustTimeAxis:!1,leftTimespanMargin:25,rightTimespanMargin:50,resourceStoreClass:"Sch.data.ResourceStore",eventStoreClass:"Sch.data.EventStore",refreshMainRowTimeout:5,needToZoom:!1,initComponent:function(){var e=this;e.addCls("sch-gantt-timeline-scheduler"),e.setTaskStore(this.taskStore),Ext.apply(e,{normalViewConfig:{onEventUpdate:Ext.Function.bind(e.onEventUpdate,e),onEventAdd:Ext.Function.bind(e.onEventAdd,e),onEventRemove:Ext.Function.bind(e.onEventRemove,e)},resourceStore:e.buildResourceStore(),eventStore:e.buildEventStore(),refreshMainRow:Ext.Function.createBuffered(e.refreshMainRow,e.refreshMainRowTimeout,e)});var t=e.taskStore.getRoot();t&&t.childNodes.length&&e.on({afterlayout:e.fillStoreFromTaskStore,scope:e,single:!0}),e.callParent(arguments),e.on("resize",e.onSchedResize,e),e.resourceRecord=e.resourceStore.first();var i=e.getSchedulingView(),n=i.eventLayout.horizontal,r=n.applyLayout;n.applyLayout=function(e,t){return e=Ext.Array.filter(e,function(e){return e.event.getDuration()>0}),r.call(this,e,t)}},setTaskStore:function(e,t){var i=this,n={load:i.fillStoreFromTaskStore,add:i.onTaskAdded,update:i.onTaskUpdated,noderemove:i.onTaskRemoved,clear:i.onTaskStoreClear,scope:i};return t&&i.mun(t,n),e=Ext.data.StoreManager.lookup(e),i.mon(e,n),i.taskStore=e,e},buildResourceStore:function(e){return Ext.create(this.resourceStoreClass,Ext.apply({data:[{Id:1}]},e))},buildEventStore:function(e){return Ext.create(this.eventStoreClass,Ext.apply({createResourceEventsCache:Ext.emptyFn,filterEventsForResource:function(){return this.getRange()},getEventsForResource:function(){return this.getRange()},isDate_RangeAvailable:function(e,t,i,n){if(!e||!t)return!0;for(var r,a=Sch.util.Date,s=this.getRange(),o=0,l=s.length;o<l;o++){var d=s[o];if(!(r=i===d||0===d.getDuration()||!d.getStartDate()||!d.getEndDate()||!a.intersectSpans(e,t,d.getStartDate(),d.getEndDate())))break}return r}},e))},refreshMainRow:function(e){e||this.needToZoom?this.zoomToFit():(this.getSchedulingView().repaintEventsForResource(this.resourceRecord),this.fitEvents())},eventRenderer:function(e,t,i){return e.store.isDate_RangeAvailable(e.getStartDate(),e.getEndDate(),e,t)&&(i.cls="sch-gantt-timeline-stretch"),e.isMilestone()||(i.style="line-height:"+i.height+"px"),e.getName()},onTaskStoreClear:function(){this.eventStore.removeAll()},onTaskRemoved:function(e,t,i){i||this.eventStore.remove(t)},onTaskAdded:function(e,t){for(var i=[],n=0;n<t.length;n++){var r=t[n];r.getShowInTimeline()&&i.push(r)}i.length&&this.eventStore.add(i)},onTaskUpdated:function(e,t,i,n){n&&Ext.Array.contains(n,t.showInTimelineField)&&(t.getShowInTimeline()?this.eventStore.add(t):this.eventStore.remove(t))},onEventAdd:function(){if(!this.needToZoom){var e=this.eventStore.getTotalTimeSpan();this.needToZoom=e.start<this.getStart()||e.end>this.getEnd()}this.refreshMainRow()},onEventRemove:function(e,t){if(!this.needToZoom)for(var i=this.eventStore.getTotalTimeSpan(),n=0;n<t.length;n++){var r=t[n];if(i.start>r.getStartDate()||i.end<r.getEndDate()){this.needToZoom=!0;break}}this.refreshMainRow()},onEventUpdate:function(e,t,i,n){var r=t.previous,a=this.eventStore.lastTotalTimeSpan;n&&(!this.needToZoom&&r&&a&&(t.startDateField in r||t.endDateField in r)&&(this.needToZoom=t.startDateField in r&&a.start-r[t.startDateField]==0||t.endDateField in r&&a.end-r[t.endDateField]==0||t.startDateField in r&&a.start>t.getStartDate()||t.endDateField in r&&a.end<t.getEndDate()),this.refreshMainRow())},fillStoreFromTaskStore:function(){var e=[],t=[];this.taskStore.forEachTaskUnordered(function(i){i.getShowInTimeline()&&(i.isMilestone()?t.push(i):e.push(i))}),e=e.concat(t),this.eventStore.removeAll(),(e.length||this.eventStore.getCount())&&(this.eventStore.loadData(e),this.zoomToFit())},zoomToFit:function(){this.suspendLayouts(),this.needToZoom=!1,this.callParent([{leftMargin:this.leftTimespanMargin,rightMargin:this.rightTimespanMargin}]),this.fitEvents(),this.resumeLayouts()},onSchedResize:function(e,t,i,n,r){i!==r&&this.fitEvents()},fitEvents:function(e,t,i,n,r){var a=this.getSchedulingView().eventLayout.horizontal.nbrOfBandsByResource[this.resourceRecord.internalId]||1,s=this.getSchedulingView().getHeight();this.setRowHeight(Math.ceil((s-this.milestoneBottomPadding)/a))}}),Ext.define("Gnt.panel.Timeline",{extend:Ext.Panel,mixins:[Gnt.mixin.Localizable],alias:"widget.gantt_timeline",layout:{type:"hbox",align:"stretch"},bodyPadding:"10 0 20 0",height:190,labelWidth:100,taskStore:null,scheduler:null,schedulerClass:"Gnt.panel.TimelineScheduler",initComponent:function(){this.addCls("sch-gantt-timeline"),this.scheduler=Ext.create(this.schedulerClass,{taskStore:this.taskStore,flex:1}),this.scheduler.on("viewchange",this.onTimespanChange,this),this.items=this.buildItems(),this.callParent(arguments)},buildItems:function(){return[{xtype:"displayfield",fieldLabel:this.L("start"),labelAlign:"top",itemId:"startlabel",cls:"sch-gantt-timeline-label sch-gantt-timeline-left-label",width:this.labelWidth},this.scheduler,{xtype:"displayfield",fieldLabel:this.L("end"),labelAlign:"top",itemId:"endlabel",cls:"sch-gantt-timeline-label sch-gantt-timeline-right-label",width:this.labelWidth}]},getStartLabel:function(){return this.startLabel||(this.startLabel=this.down("#startlabel"))},getEndLabel:function(){return this.endLabel||(this.endLabel=this.down("#endlabel"))},onTimespanChange:function(){var e=this.scheduler.getStart(),t=this.scheduler.getEnd();this.getStartLabel().setValue(Ext.Date.format(e,Ext.Date.defaultFormat)),this.getEndLabel().setValue(Ext.Date.format(t,Ext.Date.defaultFormat))}}),Ext.define("Gnt.patches.ComponentManager",{extend:Sch.util.Patch,minVersion:"6.0.0",applyFn:function(){Ext.ComponentManager.onGlobalFocus=function(e){var t,i=this,n=e.toElement,r=e.fromElement,a=Ext.Component.fromElement(n),s=Ext.Component.fromElement(r),o=i.getCommonAncestor(s,a);if(s&&!s.destroyed&&!s.destroying)for(s.handleBlurEvent&&s.handleBlurEvent(e),t=s;t&&t!==o&&!(t instanceof Gnt.widget.AssignmentGrid&&t.view.refreshing&&t.getRefOwner()instanceof Gnt.field.Assignment);t=t.getRefOwner())t.destroyed||t.destroying||t.onFocusLeave({event:e.event,type:"focusleave",target:r,relatedTarget:n,fromComponent:s,toComponent:a});if(a&&!a.destroyed)for(a.handleFocusEvent&&a.handleFocusEvent(e),t=a;t&&t!==o;t=t.getRefOwner())t.onFocusEnter({event:e.event,type:"focusenter",relatedTarget:r,target:n,fromComponent:s,toComponent:a})}}}),Ext.define("Gnt.patches.IETreeStore",{extend:Sch.util.Patch,target:"Gnt.data.TaskStore",ieOnly:!0,maxVersion:"5.1.0",overrides:{onNodeAdded:function(e,t){var i,n=this,r=n.getProxy(),a=r.getReader(),s=t.raw||t[t.persistenceProperty];Ext.Array.remove(n.removed,t),t.join(n),t.isLeaf()||(i=a.getRoot(s))&&(n.fillNode(t,a.extractData(i)),s[a.root]&&delete s[a.root]),n.autoSync&&!n.autoSyncSuspended&&(t.phantom||t.dirty)&&n.sync()}}}),Ext.define("Gnt.patches.LabelEditor",{extend:Sch.util.Patch,target:"Gnt.feature.LabelEditor",minVersion:"6.0.0",maxVersion:"6.0.1",ieOnly:!0,overrides:{constructor:function(){this.callParent(arguments),this.rendered?this.getEl().setVisibilityMode(Ext.dom.Element.OFFSETS):this.on("render",function(){this.getEl().setVisibilityMode(Ext.dom.Element.OFFSETS)},this,{single:!0})}}}),Ext.define("Gnt.patches.Tooltip",{extend:Sch.util.Patch,target:"Ext.tip.ToolTip",minVersion:"5.1.0",overrides:{onDocMouseDown:function(){this.isDisabled()||this.callParent(arguments)}}}),Ext.define("Gnt.plugin.DependencyEditor",{extend:Ext.form.Panel,alias:"plugin.gantt_dependencyeditor",ptype:"gantt_dependencyeditor",mixins:[Ext.AbstractPlugin,Gnt.mixin.Localizable],lockableScope:"top",header:!1,hideOnBlur:!0,showLag:!1,border:!1,width:260,frame:!0,labelWidth:60,triggerEvent:"dependencydblclick",constrain:!1,initComponent:function(){Ext.apply(this,{defaults:{width:240},floating:!0,hideMode:"offsets"}),this.callParent(arguments),this.addCls("sch-gantt-dependencyeditor")},getState:function(){if(this.rendered)return this.callParent(arguments)},init:function(e){e.on(this.triggerEvent,this.onDependencyDblClick,this),e.on("afterrender",this.onGanttRender,this,{delay:50}),this.gantt=e,this.taskStore=e.getTaskStore(),this.add(this.buildFields())},onGanttRender:function(){this.render(Ext.getBody()),this.collapse(Ext.Component.DIRECTION_TOP,!0),this.hide(),this.hideOnBlur&&this.on({show:function(){this.mon(Ext.getBody(),{click:this.onMouseClick,scope:this})},hide:function(){this.mun(Ext.getBody(),{click:this.onMouseClick,scope:this})},delay:50})},show:function(e,t){if(this.dependencyRecord=e,this.getForm().loadRecord(e),this.fromLabel.setValue(Ext.String.htmlEncode(this.dependencyRecord.getSourceTask().getName())),this.toLabel.setValue(Ext.String.htmlEncode(this.dependencyRecord.getTargetTask().getName())),this.typeField){var i=this.taskStore&&this.taskStore.getDependencyStore(),n=i&&i.allowedDependencyTypes;this.typeField.store.filter(),this.typeField.setReadOnly(n&&n.length<2)}this.callParent([]),this.el.setXY(t),this.expand(!this.constrain),this.constrain&&this.doConstrain(Ext.util.Region.getRegion(Ext.getBody()))},buildFields:function(){var e=this.taskStore&&this.taskStore.getDependencyStore(),t=Gnt.model.Dependency,i=[this.fromLabel=new Ext.form.DisplayField({fieldLabel:this.L("fromText")}),this.toLabel=new Ext.form.DisplayField({fieldLabel:this.L("toText")}),this.typeField=this.buildTypeField()];return this.showLag&&i.push(this.lagField=new Ext.form.NumberField({name:e?e.model.prototype.lagField:t.prototype.lagField,fieldLabel:this.L("lagText")})),i},onDependencyDblClick:function(e,t,i,n){t!=this.dependencyRecord&&this.show(t,i.getXY())},filterAllowedTypes:function(e){var t=this.taskStore&&this.taskStore.getDependencyStore();if(!t||!t.allowedDependencyTypes)return!0;for(var i=t.allowedDependencyTypes,n=t.model.Type,r=0,a=i.length;r<a;r++){var s=n[i[r]];if(e.getId()==s)return!0}return!1},buildTypeField:function(){var e=this.taskStore?this.taskStore.getDependencyStore().model:Gnt.model.Dependency,t=e.Type;this.typesFilter=new Ext.util.Filter({filterFn:this.filterAllowedTypes,scope:this});var i=new Ext.data.ArrayStore({fields:[{name:"id",type:"int"},"text"],data:[[t.EndToStart,this.L("endToStartText")],[t.StartToStart,this.L("startToStartText")],[t.EndToEnd,this.L("endToEndText")],[t.StartToEnd,this.L("startToEndText")]]});return i.filter(this.typesFilter),new Ext.form.field.ComboBox({name:e.prototype.typeField,fieldLabel:this.L("typeText"),triggerAction:"all",queryMode:"local",editable:!1,valueField:"id",displayField:"text",store:i})},onMouseClick:function(e){this.collapsed||e.within(this.getEl())||e.getTarget("."+Ext.baseCSSPrefix+"layer")||e.getTarget(".sch-ignore-click")||this.collapse()},afterCollapse:function(){delete this.dependencyRecord,this.hide(),this.callParent(arguments),this.hideOnBlur&&this.mun(Ext.getBody(),"click",this.onMouseClick,this)}}),Ext.define("Gnt.plugin.exporter.mixin.DependencyPainter",{taskBoxes:null,dependencyPainter:null,dependenciesHtml:"",ganttView:null,initDependencyPainter:function(){var e=this;e.dependencyPainter=e.normalView.dependencyView.painter,e.ganttView=e.dependencyPainter.ganttView,e.taskBoxes={}},getLineCoordinates:function(){var e=this;return e.dependencyPainter.getLineCoordinates.apply(e.dependencyPainter,arguments)},renderDependencies:function(e){var t=this;t.dependenciesHtml=t.normalView.dependencyView.lineTpl.apply(t.getDependencyTplData(e))},fillTaskBox:function(e){var t=this,i=t.normalView.dependencyView.painter;if(e.hasIncomingDependencies()||e.hasOutgoingDependencies()){var n;t.ganttView.bufferedRenderer&&(n=t.ganttView.bufferedRenderer.bodyTop,t.ganttView.bufferedRenderer.bodyTop=0),t.taskBoxes[e.getId()]=i.getTaskBox(e),t.ganttView.bufferedRenderer&&(t.ganttView.bufferedRenderer.bodyTop=n)}},getRenderData:function(e){var t=this,i=e.getSourceTask(),n=e.getTargetTask();if(i&&n)return{fromBox:t.taskBoxes[i.getId()],toBox:t.taskBoxes[n.getId()]}},getDependencyTplData:function(e){return e=e||this.normalView.dependencyView.store.getRange(),this.dependencyPainter.getDependencyTplData.call(this,e)}}),Ext.define("Gnt.plugin.exporter.SinglePage",{extend:Sch.plugin.exporter.SinglePage,mixins:[Gnt.plugin.exporter.mixin.DependencyPainter],setComponent:function(){this.callParent(arguments),this.initDependencyPainter()},collectNormalRow:function(e,t){var i=this,n=i.callParent(arguments);return i.fillTaskBox(n.record),n},onRowsCollected:function(){this.renderDependencies(),this.callParent(arguments)},preparePageToCommit:function(){var e=this,t=e.callParent(arguments),i=t.select(".sch-dependencyview-ct").first(),n=t.select("."+Ext.baseCSSPrefix+"splitter").first();i.dom.innerHTML=e.dependenciesHtml,i.applyStyles({top:"0px",left:"0px"}),n&&n.setHeight("100%");var r=e.component.normalGrid,a=r.el.down(e.tableSelector).getWidth(),s=r.getView().id;return t.select("#"+s).first().dom.style.width=a+"px",t}}),Ext.define("Gnt.plugin.exporter.MultiPage",{extend:Sch.plugin.exporter.MultiPage,mixins:[Gnt.plugin.exporter.mixin.DependencyPainter],depsTopOffset:0,normalGridOffset:0,collectNormalRow:function(e,t){var i=this,n=i.callParent(arguments);return i.fillTaskBox(n.record),n},setComponent:function(){var e=this;e.callParent(arguments),e.initDependencyPainter()},onRowsCollected:function(){var e=this;e.renderDependencies(),e.depsTopOffset=0,e.normalGridOffset=0,e.callParent(arguments)},commitPage:function(e){var t=this;t.callParent(arguments),t.depsTopOffset-=e.rowsHeight},startPage:function(e,t){var i=this;i.normalGridOffset=e.normalGridOffset,t&&(i.depsTopOffset=0),i.callParent(arguments)},buildPageFrame:function(e,t){var i=this,n=i.callParent(arguments);return n.normalHidden=i.normalGrid.hidden,n.lockedHidden=i.lockedGrid.hidden,n},preparePageToCommit:function(){var e=this,t=e.callParent(arguments),i=t.select(".sch-dependencyview-ct").first(),n=e.pageFrames[e.columnPageIndex-1],r=function(e){var i=t.select("#"+e).first();return i&&i.dom};if(!n.normalHidden){i.dom.innerHTML=e.dependenciesHtml,i.applyStyles({top:e.depsTopOffset+"px"});var a=e.normalGrid,s=a.getView().id,o=r(s);if(o){var l=a.el.down(e.tableSelector).getWidth();o.style.width=l+"px",o.style.overflow="hidden"}}if(!n.lockedHidden){var d=r(e.lockedView.id);d&&(d.style.overflow="hidden")}return t}}),Ext.define("Gnt.plugin.exporter.MultiPageVertical",{extend:Sch.plugin.exporter.MultiPageVertical,mixins:[Gnt.plugin.exporter.mixin.DependencyPainter],depsTopOffset:0,collectNormalRow:function(e,t){var i=this,n=i.callParent(arguments);return i.fillTaskBox(n.record),n},setComponent:function(){var e=this;e.callParent(arguments),e.initDependencyPainter()},onRowsCollected:function(){var e=this;e.renderDependencies(),e.depsTopOffset=0,e.callParent(arguments)},commitPage:function(e){var t=this;t.callParent(arguments),t.depsTopOffset-=e.rowsHeight},preparePageToCommit:function(){var e=this,t=e.callParent(arguments),i=t.select(".sch-dependencyview-ct").first(),n=t.select("."+Ext.baseCSSPrefix+"splitter").first(),r=function(e){var i=t.select("#"+e).first();return i&&i.dom};i.dom.innerHTML=e.dependenciesHtml,i.applyStyles({top:e.depsTopOffset+"px",left:"0px"}),n&&n.setHeight("100%");var a=e.normalGrid,s=a.el.down(e.tableSelector).getWidth(),o=a.getView().id,l=r(o);return l.style.width=s+"px",l.style.overflow="hidden",r(e.lockedView.id).style.overflow="hidden",t}}),Ext.define("Gnt.plugin.Export",{extend:Sch.plugin.Export,alias:"plugin.gantt_export",alternateClassName:"Gnt.plugin.PdfExport",buildExporters:function(){return["Gnt.plugin.exporter.SinglePage","Gnt.plugin.exporter.MultiPage","Gnt.plugin.exporter.MultiPageVertical"]},showExportDialog:function(){this.exportDialogConfig.scrollerDisabled=!0,this.callParent(arguments)}}),Ext.define("Gnt.plugin.Printable",{extend:Sch.plugin.Printable,alias:"plugin.gantt_printable",buildExporters:function(){return["Gnt.plugin.exporter.MultiPage","Gnt.plugin.exporter.MultiPageVertical"]},showExportDialog:function(){this.exportDialogConfig.scrollerDisabled=!0,this.callParent(arguments)}}),Ext.define("Gnt.plugin.TaskContextMenu",{extend:Ext.menu.Menu,alias:"plugin.gantt_taskcontextmenu",ptype:"gantt_taskcontextmenu",mixins:[Ext.AbstractPlugin,Gnt.mixin.Localizable],lockableScope:"top",plain:!0,triggerEvent:["itemcontextmenu","containercontextmenu"],hideEvent:null,grid:null,rec:null,triggerEventXY:null,lastHighlightedItem:null,taskEditorInjected:!1,config:{splitDuration:0,splitDurationUnit:"d",maxSplitDuration:1,maxSplitDurationUnit:"d",minSplitDuration:1,minSplitDurationUnit:"h"},getState:function(){if(this.rendered)return this.callParent(arguments)},isNotProject:function(e){return!e||!e.isProject},createMenuItems:function(){var e=this;return[{handler:this.deleteTask,requiresTask:!0,itemId:"deleteTask",text:this.L("deleteTask")},{handler:this.editLeftLabel,requiresTask:!0,itemId:"editLeftLabel",text:this.L("editLeftLabel"),isValidAction:function(){return e.grid.getSchedulingView().getLeftEditor()}},{handler:this.editRightLabel,requiresTask:!0,itemId:"editRightLabel",text:this.L("editRightLabel"),isValidAction:function(){return e.grid.getSchedulingView().getRightEditor()}},{handler:this.toggleMilestone,requiresTask:!0,itemId:"toggleMilestone",text:this.L("convertToMilestone"),isValidAction:this.isNotProject},{handler:this.splitTask,requiresTask:!0,itemId:"splitTask",isValidAction:function(e,t){return e&&e.getStartDate()&&e.getEndDate()&&!e.isMilestone()&&e.isLeaf()&&t&&t.getTarget(".sch-gantt-task-bar")},text:this.L("splitTask")},{text:this.L("add"),itemId:"addTaskMenu",menu:{plain:!0,defaults:{scope:this},items:[{handler:this.addTaskAboveAction,requiresTask:!0,itemId:"addTaskAbove",text:this.L("addTaskAbove")},{handler:this.addTaskBelowAction,itemId:"addTaskBelow",text:this.L("addTaskBelow")},{handler:this.addMilestone,itemId:"addMilestone",requiresTask:!0,text:this.L("addMilestone")},{handler:this.addSubtask,requiresTask:!0,itemId:"addSubtask",text:this.L("addSubtask")},{handler:this.addSuccessor,requiresTask:!0,itemId:"addSuccessor",text:this.L("addSuccessor"),isValidAction:this.isNotProject},{handler:this.addPredecessor,requiresTask:!0,itemId:"addPredecessor",text:this.L("addPredecessor"),isValidAction:this.isNotProject}]}},{text:this.L("deleteDependency"),requiresTask:!0,itemId:"deleteDependencyMenu",isValidAction:function(e){return e&&e.getAllDependencies().length>0},menu:{plain:!0,listeners:{beforeshow:this.populateDependencyMenu,mouseover:this.onDependencyMouseOver,mouseleave:this.onDependencyMouseOut,scope:this}}}]},buildMenuItems:function(){this.items=this.createMenuItems()},initComponent:function(){var e=this.triggerEvent,t=this.hideEvent;this.defaults=this.defaults||{},this.defaults.scope=this,e&&(Ext.isArray(e)||(e=[e])),this.triggerEvent=e,t&&(Ext.isArray(t)||(t=[t])),Ext.isIE&&(t=t||[],t.push("itemclick")),this.hideEvent=t,this.buildMenuItems(),this.callParent(arguments)},init:function(e){this.grid=e,this.bindTriggerEvent(),this.bindHideEvent()},bindTriggerEvent:function(){var e=this.triggerEvent,t=this.grid||this.getCmp();if(e)for(var i=e.length-1;i>=0;i--)t.on(e[i],this.onTriggerEvent,this)},bindHideEvent:function(){var e=this.hideEvent,t=this.grid||this.getCmp();if(e)for(var i=e.length-1;i>=0;i--)t.on(e[i],this.onHideEvent,this)},onHideEvent:function(){this.hide()},populateDependencyMenu:function(e){if(e.up("menuitem").isDisabled())return!1;var t=this.grid,i=t.getTaskStore(),n=this.rec.getAllDependencies(),r=t.dependencyStore;if(e.removeAll(),!n.length)return!1;var a=this.rec.getId()||this.rec.internalId;Ext.Array.forEach(n,function(t){var n=t.getSourceId(),s=i.getModelById(n==a?t.getTargetId():n);s&&e.add({dependency:t,text:Ext.util.Format.ellipsis(Ext.String.htmlEncode(s.getName()),30),scope:this,handler:function(e){r.remove(e.dependency)}})},this)},onDependencyMouseOver:function(e,t,i){if(t){var n=this.grid.getSchedulingView();this.lastHighlightedItem&&n.unhighlightDependency(this.lastHighlightedItem.dependency),this.lastHighlightedItem=t,n.highlightDependency(t.dependency)}},onDependencyMouseOut:function(e,t){this.lastHighlightedItem&&this.grid.getSchedulingView().unhighlightDependency(this.lastHighlightedItem.dependency)},onTriggerEvent:function(){var e=this.getTriggerEventContext.apply(this,arguments);this.activateMenu(e.record,e.e)},getTriggerEventContext:function(){for(var e={},t=0,i=arguments.length-1;t<=i;t++)if(arguments[t]instanceof Gnt.model.Task){e.record=arguments[t];break}for(t=arguments.length-1;t>=0;t--)if(arguments[t]instanceof Ext.EventObjectImpl){e.e=arguments[t];break}return e},activateMenu:function(e,t){this.grid.isReadOnly()||this.grid.taskStore.getRootNode()===e||(t.stopEvent(),this.rec=e,this.triggerEventXY=t.getXY(),this.configureMenuItems(t),this.showAt(t.getXY()),this.focus())},addTaskEditorEntry:function(){this.insert(0,{text:this.L("taskInformation"),itemId:"taskEditor",requiresTask:!0,handler:function(){this.grid.getTaskEditor(this.rec).showTask(this.rec)},isValidAction:function(e){return this.grid.getTaskEditor(e)},scope:this}),this.taskEditorInjected=!0},setTaskEditorEntryLabel:function(e){var t=this.down("#taskEditor");e&&t&&t.setText(e.isProject?this.L("projectInformation"):this.L("taskInformation"))},configureMenuItems:function(e){var t=this.rec;this.grid.getTaskEditor()&&(this.taskEditorInjected||this.addTaskEditorEntry(),this.setTaskEditorEntryLabel(t)),Ext.Array.forEach(this.query("menuitem"),function(i){var n=i.requiresTask&&!t||i.isValidAction&&!i.isValidAction.call(i.scope||i,t,e);i.setDisabled(n)});var i=this.down("#toggleMilestone");t&&i&&i.setText(t.isMilestone()?this.L("convertToRegular"):this.L("convertToMilestone"))},copyTask:function(e){var t=this.grid.getTaskStore().model,i=new t({leaf:!0});return i.setPercentDone(0),i.setName(this.L("newTaskText",this.texts)),i.set(i.startDateField,e&&e.getStartDate()||null),i.set(i.endDateField,e&&e.getEndDate()||null),i.set(i.durationField,e&&e.getDuration()||null),i.set(i.durationUnitField,e&&e.getDurationUnit()||"d"),i},addTaskAbove:function(e){var t=this.rec
;t?t.addTaskAbove(e):this.grid.taskStore.getRootNode().appendChild(e)},addTaskBelow:function(e){var t=this.rec;t?t.addTaskBelow(e):this.grid.taskStore.getRootNode().appendChild(e)},deleteTask:function(){this.grid.getSelectionModel().selected.each(function(e){e.parentNode?e.parentNode.removeSubtask(e):e.remove()})},editLeftLabel:function(){this.grid.getSchedulingView().editLeftLabel(this.rec)},editRightLabel:function(){this.grid.getSchedulingView().editRightLabel(this.rec)},addTaskAboveAction:function(){this.addTaskAbove(this.copyTask(this.rec))},addTaskBelowAction:function(){this.addTaskBelow(this.copyTask(this.rec))},addSubtask:function(){var e=this.rec;e.addSubtask(this.copyTask(e))},addSuccessor:function(){var e=this.rec;e.addSuccessor(this.copyTask(e))},addPredecessor:function(){var e=this.rec;e.addPredecessor(this.copyTask(e))},addMilestone:function(){var e=this.rec,t=this.copyTask(e);e.addTaskBelow(t),t.setStartEndDate(e.getEndDate(),e.getEndDate())},toggleMilestone:function(){this.rec.isMilestone()?this.rec.convertToRegular():this.rec.convertToMilestone()},getSplitDate:function(e){var t,i=e.task,n=e.date,r=e.tick,a=e.timeAxis,s=this.getMaxSplitDuration();return r&&(t=r.getStartDate(),s&&(s=i.getUnitConverter().convertDurationToMs(s,this.getMaxSplitDurationUnit()))<r.getEndDate()-r.getStartDate()&&(t=null)),t||a.roundDate(n,i.getStartDate())},getSplitDuration:function(e){if(this.splitDuration)return this.splitDuration;var t=e.task,i=e.pos,n=e.date,r=e.tick;if(r){var a=t.calculateDuration(r.getStartDate(),r.getEndDate(),Sch.util.Date.MILLI),s=t.getUnitConverter(),o=this.getMinSplitDuration(),l=this.getMaxSplitDuration();return(o||l)&&(l&&(a=Math.min(a,s.convertDurationToMs(l,this.getMaxSplitDurationUnit()))),o&&(a=Math.max(a,s.convertDurationToMs(o,this.getMinSplitDurationUnit())))),s.convertMSDurationToUnit(a,this.getSplitDurationUnit(t,i,n,r))}},getSplitDurationUnit:function(e){return this.splitDuration?this.splitDurationUnit:Sch.util.Date.MILLI},splitTask:function(){var e=this,t=e.grid.getSchedulingView(),i=t.getDateFromX(e.triggerEventXY[0]),n=t.timeAxis,r={task:e.rec,pos:e.triggerEventXY,date:i,timeAxis:n,tick:n.getAt(Math.floor(n.getTickFromDate(i)))};r.task.split(e.getSplitDate(r),e.getSplitDuration(r),e.getSplitDurationUnit(r))}}),Ext.define("Gnt.plugin.taskeditor.BaseEditor",{extend:Ext.window.Window,mixins:[Ext.AbstractPlugin,Gnt.mixin.Localizable],lockableScope:"top",taskEditorCls:"Gnt.widget.taskeditor.TaskEditor",isTaskEditor:!0,taskEditor:null,panelConfig:null,height:340,width:600,layout:"card",constrain:!0,triggerEvent:"taskdblclick",closeAction:"hide",modal:!0,gantt:null,assignmentStore:null,resourceStore:null,taskStore:null,monitorDataUpdates:!1,monitorDataUpdatesInterval:500,taskEditorConfigs:"l10n,task,taskStore,assignmentStore,resourceStore",taskFilters:null,constructor:function(e){e=e||{},this.taskFilters=[],Ext.apply(this,e),this.title=this.L("title"),e.buttons||(this.buttons=["->",{itemId:"teOkBtn",text:this.L("okText"),handler:function(){this.completeEditing()||Ext.Msg.alert(this.L("alertCaption"),this.L("alertText"))},scope:this},{text:this.L("cancelText"),handler:this.close,scope:this}]),this.callParent([e]),this.addCls("gnt-taskeditor-window")},getState:function(){if(this.rendered)return this.callParent(arguments)},init:function(e){this.assignmentStore=this.assignmentStore||e.getAssignmentStore(),this.resourceStore=this.resourceStore||e.getResourceStore(),this.taskStore=this.taskStore||e.getTaskStore();var t={width:null,height:null,border:!1};Ext.copyTo(t,this,this.taskEditorConfigs),t.showBaseline=e.enableBaseline,t.showRollup=e.showRollupTasks,t.allowParentTaskDependencies=e.allowParentTaskDependencies,this.buildTaskEditor(Ext.apply(t,this.panelConfig)),this.add(this.taskEditor),this.mon(e,this.triggerEvent,this.onTriggerEvent,this),this.gantt=e},buildTaskEditor:function(e){this.taskEditor=Ext.create(this.taskEditorCls,e),this.relayEvents(this.taskEditor,["loadtask","validate","beforeupdatetask","afterupdatetask"])},onTriggerEvent:function(e,t){this.showTask(t)},showTask:function(e){this.taskEditor&&e&&this.matchFilters(e)&&(this.taskEditor.loadTask(e),this.show())},matchFilters:function(e){if(e){for(var t=0;t<this.taskFilters.length;t++){var i=this.taskFilters[t];if(!i.fn.call(i.scope,e))return!1}return!0}},addFilter:function(e,t){this.taskFilters.push({fn:e,scope:t||this})},validate:function(){if(this.taskEditor)return this.taskEditor.validate()},completeEditing:function(){if(this.taskEditor){var e=this.taskEditor.getActiveTab();return e.editingPlugin&&e.editingPlugin.completeEdit&&e.editingPlugin.completeEdit(),!!this.taskEditor.validate()&&(!!this.taskEditor.updateTask()&&(this.hide(),!0))}},updateTask:function(){if(this.taskEditor)return this.taskEditor.updateTask()},afterRender:function(){var e=this;e.callParent(arguments),e.startDataUpdatesMonitoring()},startDataUpdatesMonitoring:function(){function e(){r&&n&&i.taskEditor&&(n.setDisabled(!i.taskEditor.isDataChanged()||!i.taskEditor.isDataValid()),r=Ext.Function.defer(e,i.monitorDataUpdatesInterval))}function t(){!0!==r&&clearTimeout(r),r=!0}var i=this,n=i.down("#teOkBtn"),r=!0;i.monitorDataUpdates&&n&&i.on({show:e,hide:t,destroy:t})}}),Ext.define("Gnt.util.Data",{singleton:!0,cloneModelSet:function(e,t,i){var n,r=[],a=function(a){n=a.copy(),n.phantom=!1,n.originalRecord=a,t&&!1===t.call(i||e,n,a)||r.push(n)};return e.each?e.each(a):Ext.Array.each(e,a),r},applyCloneChanges:function(e,t,i,n){var r=[],a=t.autoSyncSuspended;t.autoSync&&!a&&t.suspendAutoSync();for(var s=e.getRemovedRecords(),o=0,l=s.length;o<l;o++)s[o].originalRecord&&r.push(s[o].originalRecord);r.length&&(t.remove(r),e.removed.length=0);var d,c,h,u=e.getModifiedRecords();for(o=0,l=u.length;o<l;o++){if(d=u[o].originalRecord,c=u[o].getData(),delete c[u[o].idProperty],d){d.beginEdit();for(var g in c)d.set(g,c[g]);i&&i.call(n||u[o],c,u[o]),d.endEdit()}else i&&i.call(n||u[o],c,u[o]),h=t.add(c),u[o].originalRecord=h&&h[0];u[o].commit(!0)}t.autoSync&&!a&&(t.resumeAutoSync(),t.sync())}}),Ext.define("Gnt.widget.taskeditor.BaseEditor",{extend:Ext.tab.Panel,mixins:[Gnt.mixin.Localizable],margin:"5 0 0 0",height:340,width:600,layout:"fit",border:!1,plain:!0,defaults:{margin:5,border:!1},eventIndicator:"task",task:null,taskBuffer:null,taskStore:null,assignmentStore:null,resourceStore:null,clonedStores:null,constructor:function(e){var t=this;e=e||{},Ext.apply(t,e),t.clonedStores||(t.clonedStores=t.task||t.taskStore?t.cloneStores():{});var i=t.buildItems(e),n=t.items;n&&(i.push.apply(i,Ext.isArray(n)?n:[n]),delete e.items),t.items=i,t.items.length<=1&&(e.tabBar=e.tabBar||{},Ext.applyIf(e.tabBar,{hidden:!0})),this.callParent([e])},buildItems:function(e){return[]},cloneTaskBranch:function(e,t){e=e||this.task;var i,n,r=this,a=r.getTaskStore(),s=a&&a.getRoot(),o=r.clonedStores;return e.bubble(function(e){if(e!==s){var a=t[e.getId()];if(a)return n&&a.appendChild(n),n=null,!1;a=r.cloneTask(e),t[e.getId()]=a,a.taskStore=o.taskStore,n?a.appendChild(n):i=a,n=a}}),{branch:n,task:i}},cloneRelevantTasks:function(e){e=e||this.task;var t=this,i={},n=t.cloneTaskBranch(e,i),r=n.task,a=[n.branch];return Ext.Array.each(e.predecessors,function(e){var n=t.cloneTaskBranch(e.getSourceTask(),i);n.branch&&a.push(n.branch)}),Ext.Array.each(e.successors,function(e){var n=t.cloneTaskBranch(e.getTargetTask(),i);n.branch&&a.push(n.branch)}),{task:r,tasks:a}},loadTask:function(e){e&&(this.clonedStores=this.cloneStores({task:e}),this.loadClonedStores(this.clonedStores,e))},cloneTaskStore:function(e,t){var i=this.getTaskStore();if(!i)return null;var n=new(Ext.getClass(i))(Ext.apply({isCloned:!0,calendarManager:null,storeId:null,calendar:i.getCalendar(),model:i.model,weekendsAreWorkdays:i.weekendsAreWorkdays,cascadeChanges:i.cascadeChanges,batchSync:!1,recalculateParents:!1,skipWeekendsDuringDragDrop:i.skipWeekendsDuringDragDrop,moveParentAsGroup:i.moveParentAsGroup,enableDependenciesForParentTasks:i.enableDependenciesForParentTasks,availabilitySearchLimit:i.availabilitySearchLimit,dependenciesCalendar:"pms",proxy:{type:"memory",reader:{type:"json"}}},t));return this.mon(i,{calendarset:function(e,t){n.setCalendar(t)}}),n},cloneDependencyStore:function(e,t){var i=this.getTaskStore(),n=this.dependencyStore||i&&i.getDependencyStore();return n?new(Ext.getClass(n))(Ext.apply({isCloned:!0,model:n.model,strictDependencyValidation:n.strictDependencyValidation,allowedDependencyTypes:n.allowedDependencyTypes,proxy:{type:"memory",reader:{type:"json"}}},t)):null},cloneAssignmentStore:function(e,t){var i=this.getTaskStore(),n=this.assignmentStore||i&&i.getAssignmentStore();return n?new(Ext.getClass(n))(Ext.apply({isCloned:!0,model:n.model,proxy:{type:"memory",reader:{type:"json"}}},t)):null},cloneResourceStore:function(e,t){var i=this.getTaskStore(),n=this.resourceStore||i&&i.getResourceStore();return n?new(Ext.getClass(n))(Ext.apply({isCloned:!0,model:n.model,proxy:{type:"memory",reader:{type:"json"}}},t)):null},cloneStores:function(e){e=e||{};var t=e.task||this.task,i=this.clonedStores||{},n=i.resourceStore||this.cloneResourceStore(t,e&&e.resourceStore),r=i.assignmentStore||this.cloneAssignmentStore(t,e&&e.assignmentStore),a=i.dependencyStore||this.cloneDependencyStore(t,e&&e.dependencyStore),s=i.taskStore||this.cloneTaskStore(t,Ext.apply({assignmentStore:r,resourceStore:n,dependencyStore:a},e&&e.taskStore));return n.taskStore=s,Ext.apply(i,{resourceStore:n,assignmentStore:r,dependencyStore:a,taskStore:s}),i},getTaskStore:function(e){return e=e||this.task,this.taskStore||e&&e.getTaskStore()},loadClonedStores:function(e,t){var i=this,n=i.cloneRelevantTasks(t),r=n.tasks,a=n.task;a.taskStore.on({update:function(e,t,n){t===a&&n==Ext.data.Model.EDIT&&t.fireEvent(i.eventIndicator+"updated",t)}}),e.taskStore.setRootNode({expanded:!0,children:r}),i.loadClonedDependencyStore(e,t),i.loadClonedResourceStore(e,t),i.loadClonedAssignmentStore(e,t),i.taskBuffer=a},loadClonedDependencyStore:function(e,t){e=e||this.clonedStores,e.dependencyStore&&e.dependencyStore.loadData(Gnt.util.Data.cloneModelSet(t.getAllDependencies(),function(e,t){e.setId(t.getId())}))},loadClonedResourceStore:function(e,t){e=e||this.clonedStores,e.resourceStore&&e.resourceStore.loadData(Gnt.util.Data.cloneModelSet(this.resourceStore||this.getTaskStore().getResourceStore(),function(e,t){e.setId(t.getId())}))},loadClonedAssignmentStore:function(e,t){e=e||this.clonedStores,e.assignmentStore&&e.assignmentStore.loadData(Gnt.util.Data.cloneModelSet(t.getAssignments(),function(e,t){e.setId(t.getId())}))},cloneTask:function(e){return e.copy(e.getId(),!1)},getTabByComponent:function(e){var t;return this.items.each(function(i){if(e===i||e.isDescendantOf(i))return t=i,!1},this),t},validate:function(){var e,t,i=this.getActiveTab(),n=[];return e=this.doValidate(function(e){n.push(e)}),e||!i||Ext.Array.contains(n,i)?!e&&i?t=i:e||(t=n[0]):(t=n[0],this.setActiveTab(t)),!1!==this.fireEvent("validate",this,t)&&e},updateTask:function(){var e=this,t=!1;return!1!==e.fireEvent("beforeupdate"+e.eventIndicator,e,function(){e.doUpdateTask()})&&(e.doUpdateTask(),e.fireEvent("afterupdate"+e.eventIndicator,e),t=!0),t},onDestroy:function(){this.clonedStores.taskStore&&this.clonedStores.taskStore.destroy(),this.callParent(arguments)},doValidate:function(){return!0},isDataValid:function(){return this.doValidate()},isDataChanged:function(){return!1},doUpdateTask:Ext.emptyFn}),Ext.define("Gnt.widget.taskeditor.BaseForm",{extend:Ext.form.Panel,highlightTaskUpdates:!0,task:null,taskBuffer:null,taskStore:null,taskListeners:null,autoScroll:!0,defaults:{labelWidth:110},bodyPadding:5,border:!1,layout:"anchor",defaultType:"textfield",initComponent:function(){this.task&&(this.fieldNames=this.getFieldNames(this.task)),this.items||this.buildFields(),this.callParent(arguments),this.task&&this.loadRecord(this.task,this.taskBuffer)},getFieldNames:function(e){if(e){var t={};for(var i in this.fieldNames)t[i]=e[i];return t}},renameFields:function(e){var t=this.getFieldNames(e);if(t){var i,n=this.getForm(),r=!1;for(var a in this.fieldNames)(i=n.findField(this.fieldNames[a]))&&t[a]&&t[a]!=i.name&&(r=!0,i.name=t[a]);r&&(this.fieldNames=t)}},setSuppressTaskUpdate:function(e){this.getForm().getFields().each(function(t){t.setSuppressTaskUpdate&&t.setSuppressTaskUpdate(e)})},isDataChanged:function(){return this.isDirty()},buildTaskBuffer:function(e){var t=this;t.taskBuffer=e.copy(),t.taskBuffer.taskStore=e.taskStore},loadRecord:function(e,t){var i=this;e&&e!==i.task&&i.renameFields(e),i.task=e,i.taskBuffer=t,i.taskBuffer||i.buildTaskBuffer(e),i.taskListeners&&i.taskListeners.destroy(),i.taskListeners=i.mon(i.taskBuffer,{taskupdated:i.onTaskUpdated,destroyable:!0,scope:i});var n=i.getForm();n._record=e,this.suspendLayouts();var r=e.getData();n.getFields().each(function(e){e.getName()in r&&(e.setTask?e.setTask(i.taskBuffer):(e.setValue(r[e.getName()]),i.updateFieldReadOnly(e)),n.trackResetOnLoad&&e.resetOriginalValue())}),this.resumeLayouts(!0),this.fireEvent("afterloadrecord",this,e)},updateFieldReadOnly:function(e){var t=this;e.disabled||(!1===e.editable?t.taskBuffer.isEditable(e.name)?e.inputEl&&(e.setReadOnly(!1),e.inputEl.dom.readOnly=!0):e.setReadOnly(!0):e.setReadOnly(!t.taskBuffer.isEditable(e.name)))},updateReadOnly:function(){var e=this,t=e.getForm(),i=e.taskBuffer.getData();t.getFields().each(function(t){t.getName()in i&&!t.isTaskField&&e.updateFieldReadOnly(t)})},updateRecord:function(e){var t=this;return!(!(e=e||t.task)||!1===t.fireEvent("beforeupdaterecord",t,e,t.updateRecordFn))&&(t.setSuppressTaskUpdate(!0),t.updateRecordFn.call(t,e),t.setSuppressTaskUpdate(!1),t.fireEvent("afterupdaterecord",t,e),!0)},updateRecordWithFieldValue:function(e,t){var i=e.getField(t.name);t.applyChanges?t.applyChanges(e):i&&t.name in this.getForm().getFieldValues()&&e.set(t.name,t.getValue())},updateRecordFn:function(e){var t=this;e.beginEdit(),t.getForm().getFields().each(function(i){t.updateRecordWithFieldValue(e,i)}),e.endEdit()},initFieldDefinition:function(e,t){var i=this,n={taskStore:i.taskStore,task:i.task,highlightTaskUpdates:i.highlightTaskUpdates};return!e.readOnly&&i.task&&(n.readOnly=!i.task.isEditable(e.name)),Ext.apply(e,n,t)},getTaskFieldValue:function(e){var t=this,i=this.task;return i?i.get(t.fieldNames[e]):""},onTaskUpdated:function(e,t){this.updateReadOnly()}}),Ext.define("Gnt.widget.taskeditor.ProjectForm",{extend:Gnt.widget.taskeditor.BaseForm,alias:"widget.projectform",mixins:[Gnt.mixin.Localizable],alternateClassName:["Gnt.widget.ProjectForm"],showCalendar:!1,nameConfig:null,readOnlyConfig:null,allowDependenciesConfig:null,startConfig:null,finishConfig:null,calendarConfig:null,constructor:function(e){e=e||{};var t=e.taskStore&&e.taskStore.projectModel&&e.taskStore.projectModel.prototype||Gnt.model.Project.prototype;this.fieldNames={calendarIdField:t.calendarIdField,allowDependenciesField:t.allowDependenciesField,startDateField:t.startDateField,endDateField:t.endDateField,nameField:t.nameField,descriptionField:t.descriptionField},this.callParent(arguments),this.addBodyCls("gnt-projecteditor-projectform")},buildFields:function(){var e=this,t=e.fieldNames;e.items=e.items||[],e.items.push({xtype:"fieldset",title:e.L("projectText"),layout:"vbox",defaults:{allowBlank:!1},items:[e.initFieldDefinition({xtype:"textfield",fieldLabel:e.L("nameText"),name:t.nameField,labelWidth:110,flex:1,value:e.getTaskFieldValue(t.nameField)},e.nameConfig),e.initFieldDefinition({xtype:"checkboxfield",fieldLabel:e.L("allowDependenciesText"),name:t.allowDependenciesField,labelWidth:110,flex:1,value:e.getTaskFieldValue(t.allowDependenciesField)},e.allowDependenciesConfig)]},e.initFieldDefinition({xtype:"fieldset",title:e.L("datesText"),layout:"hbox",defaults:{labelWidth:110,allowBlank:!1,margin:"5 5 5 0"},items:[e.initFieldDefinition({xtype:"startdatefield",fieldLabel:e.L("startText"),width:260,name:t.startDateField,value:e.getTaskFieldValue(t.startDateField)},e.startConfig),e.initFieldDefinition({xtype:"enddatefield",fieldLabel:e.L("finishText"),flex:1,labelWidth:110,name:t.endDateField,value:e.getTaskFieldValue(t.endDateField)},e.finishConfig)]})),e.showCalendar&&e.items.push({xtype:"fieldset",layout:"hbox",defaults:{labelWidth:110,allowBlank:!1,margin:"5 0 5 0"},items:[e.initFieldDefinition({xtype:"calendarfield",fieldLabel:this.L("calendarText"),width:260,name:t.calendarIdField,value:e.getTaskFieldValue(t.calendarIdField)},e.calendarConfig)]})}}),Ext.define("Gnt.widget.taskeditor.ProjectEditor",{extend:Gnt.widget.taskeditor.BaseEditor,alias:"widget.projecteditor",alternateClassName:["Gnt.widget.ProjectEditor"],eventIndicator:"pms",projectFormClass:"Gnt.widget.taskeditor.ProjectForm",showDescription:!0,projectFormConfig:null,descriptionConfig:null,descriptionPanel:null,descriptionEditor:null,projectForm:null,buildItems:function(){var e=this,t=[],i=this.task;return e.projectForm=Ext.create(e.projectFormClass,Ext.applyIf(e.projectFormConfig||{},{task:i,taskStore:e.taskStore})),t.push(e.projectForm),e.showDescription&&(e.descriptionEditor=Ext.create("Ext.form.field.HtmlEditor",Ext.apply({listeners:{afterrender:function(t){e.descriptionEditor.setValue(e.task.get(e.task.descriptionField))}},readOnly:i&&!i.isEditable(i.descriptionField),isDataChanged:function(){return this.isDirty()}},e.descriptionConfig)),e.descriptionPanel=Ext.create("Ext.panel.Panel",{border:!1,layout:"fit",items:e.descriptionEditor}),t.push(e.descriptionPanel)),e.projectForm.title||(e.projectForm.title=e.L("generalText")),e.descriptionPanel&&!e.descriptionPanel.title&&(e.descriptionPanel.title=this.L("descriptionText")),t},loadProject:function(e){this.loadTask.apply(this,arguments)},loadTask:function(e){if(e){this.task=e;var t=this.projectForm;t.setSuppressTaskUpdate(!0),t.getForm().reset(),this.callParent(arguments),t.loadRecord(e,this.taskBuffer),this.descriptionEditor&&(this.descriptionEditor.setValue(e.getDescription()),this.descriptionEditor.setReadOnly(!e.isEditable(e.descriptionField))),t.setSuppressTaskUpdate(!1),this.fireEvent("loadproject",this,e)}},updateProject:function(){this.updateTask()},loadClonedDependencyStore:Ext.emptyFn,loadClonedResourceStore:Ext.emptyFn,loadClonedAssignmentStore:Ext.emptyFn,doValidate:function(e){var t=this.callParent(arguments);return this.projectForm&&!this.projectForm.isValid()&&(t=!1,e&&e(this.getTabByComponent(this.projectForm))),t},doUpdateTask:function(){var e=this.task;this.callParent(arguments),this.projectForm&&this.projectForm.updateRecord(),this.descriptionEditor&&e.set(e.descriptionField,this.descriptionEditor.getValue())},isDataChanged:function(e){var t=this.callParent(arguments);return this.projectForm&&this.projectForm.isDataChanged()&&(t=!0,e&&e(this.getTabByComponent(this.projectForm))),this.descriptionEditor&&this.descriptionEditor.isDataChanged()&&(t=!0,e&&e(this.getTabByComponent(this.descriptionEditor))),t}}),Ext.define("Gnt.plugin.taskeditor.ProjectEditor",{extend:Gnt.plugin.taskeditor.BaseEditor,alternateClassName:["Gnt.plugin.ProjectEditor"],alias:"plugin.gantt_projecteditor",ptype:"gantt_projecteditor",taskEditorCls:"Gnt.widget.taskeditor.ProjectEditor",taskEditorConfigs:"l10n,task,taskStore,assignmentStore,resourceStore,projectFormClass,showDescription,projectFormConfig,descriptionConfig",constructor:function(e){this.callParent(arguments),this.addCls("gnt-projecteditor-window"),this.addFilter(this.isProject)},init:function(e){this.callParent(arguments),e.projectEditor=this},isProject:function(e){return e&&e.isProject}}),Ext.define("Gnt.widget.taskeditor.TaskForm",{extend:Gnt.widget.taskeditor.BaseForm,alias:"widget.taskform",mixins:[Gnt.mixin.Localizable],alternateClassName:["Gnt.widget.TaskForm"],showGeneral:!0,showBaseline:!0,editBaseline:!1,showCalendar:!1,showManuallyScheduled:!1,showSchedulingMode:!1,showWbsCode:!1,showRollup:!1,showConstraint:!1,taskNameConfig:null,durationConfig:null,startConfig:null,finishConfig:null,percentDoneConfig:null,baselineStartConfig:null,baselineFinishConfig:null,baselinePercentDoneConfig:null,effortConfig:null,calendarConfig:null,manuallyScheduledConfig:null,schedulingModeConfig:null,wbsCodeConfig:null,rollupConfig:null,constraintTypeConfig:null,constraintDateConfig:null,constructor:function(e){e=e||{},this.showBaseline=e.showBaseline,this.editBaseline=e.editBaseline;var t=e.taskStore?e.taskStore.model.prototype:Gnt.model.Task.prototype;this.fieldNames={baselineEndDateField:t.baselineEndDateField,baselinePercentDoneField:t.baselinePercentDoneField,baselineStartDateField:t.baselineStartDateField,calendarIdField:t.calendarIdField,clsField:t.clsField,draggableField:t.draggableField,durationField:t.durationField,durationUnitField:t.durationUnitField,effortField:t.effortField,effortUnitField:t.effortUnitField,endDateField:t.endDateField,manuallyScheduledField:t.manuallyScheduledField,nameField:t.nameField,percentDoneField:t.percentDoneField,resizableField:t.resizableField,rollupField:t.rollupField,schedulingModeField:t.schedulingModeField,startDateField:t.startDateField,noteField:t.noteField,constraintTypeField:t.constraintTypeField,constraintDateField:t.constraintDateField},this.callParent(arguments),this.addBodyCls("gnt-taskeditor-taskform")},buildFields:function(){var e=this,t=e.fieldNames;e.items=e.items||[],e.showGeneral&&e.items.push({xtype:"fieldcontainer",layout:"hbox",items:[e.initFieldDefinition({xtype:"textfield",fieldLabel:e.L("taskNameText"),name:t.nameField,labelWidth:110,allowBlank:!1,flex:1,value:e.getTaskFieldValue(t.nameField)},e.nameConfig)]},{xtype:"fieldcontainer",layout:"hbox",defaults:{labelWidth:110,allowBlank:!1},items:[e.initFieldDefinition({xtype:"percentfield",fieldLabel:e.L("percentDoneText"),name:t.percentDoneField,margin:"0 0 0 8",flex:1,value:e.getTaskFieldValue(t.percentDoneField)},e.percentDoneConfig),e.initFieldDefinition({xtype:"durationfield",fieldLabel:e.L("durationText"),name:t.durationField,flex:1,value:e.getTaskFieldValue(t.durationField)},e.durationConfig)]},{xtype:"fieldset",title:e.L("datesText"),layout:"hbox",defaults:{labelWidth:110,allowBlank:!1},items:[e.initFieldDefinition({xtype:"startdatefield",fieldLabel:e.L("startText"),flex:1,name:t.startDateField,value:e.getTaskFieldValue(t.startDateField)},e.startConfig),e.initFieldDefinition({xtype:"enddatefield",fieldLabel:e.L("finishText"),flex:1,name:t.endDateField,value:e.getTaskFieldValue(t.endDateField)},e.finishConfig)]},e.initFieldDefinition({xtype:"effortfield",fieldLabel:e.L("effortText"),name:t.effortField,invalidText:e.L("invalidEffortText"),width:200,allowBlank:!0,value:e.getTaskFieldValue(t.effortField)},e.effortConfig)),e.showBaseline&&e.items.push({xtype:"fieldset",title:e.L("baselineText"),layout:"hbox",defaults:{labelWidth:110,width:260,cls:"gnt-baselinefield"},items:[e.initFieldDefinition({xtype:"baselinestartdatefield",fieldLabel:e.L("baselineStartText"),name:t.baselineStartDateField,value:e.getTaskFieldValue(t.baselineStartDateField),readOnly:!e.editBaseline,forceReadOnly:!this.editBaseline},e.baselineStartConfig),e.initFieldDefinition({xtype:"baselineenddatefield",fieldLabel:e.L("baselineFinishText"),name:t.baselineEndDateField,flex:1,value:e.getTaskFieldValue(t.baselineEndDateField),readOnly:!e.editBaseline,forceReadOnly:!this.editBaseline},e.baselineFinishConfig)]},e.initFieldDefinition({xtype:"percentfield",fieldLabel:e.L("baselinePercentDoneText"),name:t.baselinePercentDoneField,labelWidth:110,width:200,cls:"gnt-baselinefield",value:e.getTaskFieldValue(t.baselinePercentDoneField),readOnly:!e.editBaseline},e.baselinePercentDoneConfig)),e.showCalendar&&e.items.push(e.initFieldDefinition({xtype:"calendarfield",fieldLabel:this.L("calendarText"),width:260,name:t.calendarIdField,value:e.getTaskFieldValue(t.calendarIdField)},e.calendarConfig)),e.showManuallyScheduled&&e.items.push(e.initFieldDefinition({xtype:"manuallyscheduledfield",fieldLabel:e.L("manuallyScheduledText"),name:t.manuallyScheduledField,value:e.getTaskFieldValue(t.manuallyScheduledField)},e.manuallyScheduledConfig)),e.showSchedulingMode&&e.items.push(e.initFieldDefinition({xtype:"schedulingmodefield",fieldLabel:e.L("schedulingModeText"),width:260,name:t.schedulingModeField,value:e.getTaskFieldValue(t.schedulingModeField),allowBlank:!1},e.schedulingModeConfig)),e.showWbsCode&&e.items.push(e.initFieldDefinition({xtype:"textfield",fieldLabel:e.L("wbsCodeText"),name:"wbsCode",width:260,readOnly:!0,value:e.task&&e.task.getWBSCode()},e.wbsCodeConfig)),e.showRollup&&this.items.push(e.initFieldDefinition({xtype:"checkboxfield",fieldLabel:this.L("rollupText"),name:t.rollupField,value:e.getTaskFieldValue(t.rollupField)},e.rollupConfig)),e.showConstraint&&e.items.push(e.initFieldDefinition({xtype:"constrainttypefield",fieldLabel:e.L("Constraint Type"),name:t.constraintTypeField,width:260,value:e.getTaskFieldValue(t.constraintTypeField)},e.constraintTypeConfig),e.initFieldDefinition({xtype:"constraintdatefield",fieldLabel:e.L("Constraint Date"),name:t.constraintDateField,width:260,value:e.getTaskFieldValue(t.constraintDateField)},e.constraintDateConfig))},updateRecordWithFieldValue:function(e,t){var i=this;if(t.name!=i.fieldNames.constraintTypeField&&t.name!=i.fieldNames.constraintDateField)return this.callParent(arguments)},updateRecordFn:function(e){var t=this,i=t.fieldNames,n=t.getForm(),r=n.findField(i.constraintTypeField),a=n.findField(i.constraintDateField);e.beginEdit(),this.callParent(arguments),r&&a&&e.setConstraint&&e.setConstraint(r.getValue(),a.getValue()),e.endEdit()},buildTaskBuffer:function(e){this.callParent(arguments),this.taskBuffer.getProject=function(){return e.getProject()}}}),Ext.define("Gnt.widget.AssignmentEditGrid",{extend:Ext.grid.Panel,alias:"widget.assignmenteditgrid",mixins:[Gnt.mixin.Localizable],assignmentStore:null,resourceStore:null,readOnly:!1,cls:"gnt-assignmentgrid",defaultAssignedUnits:100,confirmAddResource:!0,addResources:!0,taskId:null,refreshTimeout:100,resourceDupStore:null,resourceComboStore:null,assignmentUnitsEditor:null,constructor:function(e){Ext.apply(this,e);var t=e.assignmentStore,i=e.taskStore||t.getTaskStore();this.store=e.store||new t.self({model:t.model,taskStore:i});var n=i.getResourceStore();this.resourceDupStore=e.resourceDupStore||new n.self({model:n.model,taskStore:i}),this.resourceComboStore=new Ext.data.JsonStore({model:this.resourceDupStore.model}),void 0!==e.addResources&&(this.addResources=e.addResources),this.columns=this.buildColumns(),this.readOnly||(this.plugins=this.buildPlugins()),this.callParent(arguments)},suspendRefreshResources:function(){this.refreshResourcesSuspended++},resumeRefreshResources:function(){this.refreshResourcesSuspended--},refreshResources:function(){this.refreshResourcesSuspended||this.loadResources()},suspendRefreshAssignments:function(){this.refreshAssignmentsSuspended++},resumeRefreshAssignments:function(){this.refreshAssignmentsSuspended--},refreshAssignments:function(){this.refreshAssignmentsSuspended||this.loadTaskAssignments()},initComponent:function(){this.loadResources();var e=Ext.Function.createBuffered(this.refreshResources,this.refreshTimeout,this,[]);this.mon(this.resourceStore,{add:e,remove:e,load:e,clear:e}),this.loadTaskAssignments();var t=Ext.Function.createBuffered(this.refreshAssignments,this.refreshTimeout,this,[]);this.mon(this.assignmentStore,{add:t,remove:t,load:t,clear:t}),this.callParent(arguments)},loadResources:function(e){if(!this.resourceStore)return!1;var t=Gnt.util.Data.cloneModelSet(this.resourceStore);return this.resourceDupStore.loadData(t),this.resourceComboStore.loadData(t),e||this.loadTaskAssignments(),!0},getUnitsEditor:function(){return this.readOnly||this.assignmentUnitsEditor||(this.assignmentUnitsEditor=this.down("assignmentunitscolumn").getEditor()),this.assignmentUnitsEditor},setEditableFields:function(e){var t=this.getUnitsEditor();if(t)switch(e.getSchedulingMode()){case"DynamicAssignment":t.setReadOnly(!0);break;default:t.setReadOnly(!1)}},loadTaskAssignments:function(e){if(!(e=e||this.taskId))return!1;var t,i=this.taskStore||this.assignmentStore.getTaskStore(),n=i&&i.getModelById(e);if(n)t=n.getAssignments();else{if(!this.assignmentStore)return!1;t=this.assignmentStore.queryBy(function(t){return t.getTaskId()==e})}this.taskId=e;var r=this.store,a=this.resourceDupStore,s=Gnt.util.Data.cloneModelSet(t,function(e,t){var i=t.getResourceId(),n=a.queryBy(function(e){var t=e.originalRecord;return(t.getId()||t.internalId)==i});n.getCount()&&(n=n.first(),e.setResourceId(n.getId()||n.internalId))});return r.loadData(s),n&&this.rendered&&this.setEditableFields(n),!0},insertAssignment:function(e,t){if(this.store){var i=this.store.model.prototype,n={};e?n=e:n[i.unitsField]=this.defaultAssignedUnits,n[i.taskIdField]=this.taskId;var r=this.store.insert(0,n),a=this,s=r[0].isValid;return r[0].isValid=function(){return s.apply(this,arguments)&&a.isValidAssignment(this)},!t&&this.cellEditing&&this.cellEditing.startEditByPosition({row:0,column:0}),r}},isValid:function(){var e=!0;return this.store.each(function(t){if(!t.isValid())return e=!1,!1}),e},getAssignmentErrors:function(e){var t=e.getResourceId();return t?this.resourceDupStore.getModelById(t)?void 0:[Ext.String.format(this.L("noResourceText"),t)]:[this.L("noValueText")]},isValidAssignment:function(e){return!this.getAssignmentErrors(e)},buildPlugins:function(){var e=this.cellEditing=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1}),t=e.startEdit;return e.startEdit=function(){return this.completeEdit(),t.apply(this,arguments)},e.on({beforeedit:this.onEditingStart,scope:this}),[e]},hide:function(){return this.cellEditing.cancelEdit(),this.callParent(arguments)},onEditingStart:function(e,t){var i=this.store.model.prototype;t.field==i.resourceIdField&&(this.assignment=t.record,this.resourceId=t.record.getResourceId(),this.resourceComboStore.loadData(this.resourceDupStore.getRange()),this.resourceComboStore.filter(this.resourcesFilter))},resourceRender:function(e,t,i){var n=this.getAssignmentErrors(i);n&&n.length?(t.tdCls=Ext.baseCSSPrefix+"form-invalid",t.tdAttr='data-errorqtip="'+n.join("<br>")+'"'):(t.tdCls="",t.tdAttr='data-errorqtip=""');var r=this.resourceDupStore.getModelById(e);return Ext.String.htmlEncode(r&&r.getName()||e)},filterResources:function(e){var t=e.getId(),i=this.store.model.prototype.resourceIdField,n=!0;return t!==this.resourceId&&this.store.each(function(e){if(t==e.get(i))return n=!1,!1}),n},onResourceComboAssert:function(e){var t=e.getRawValue();if(t){var i=this.resourceDupStore.findExact(e.displayField,t),n=-1!==i&&this.resourceDupStore.getAt(i);if(n)e.select(n,!0);else{var r=this.assignment,a=this,s=function(t){var i=a.resourceStore.model,n={};n[i.prototype.nameField]=e.rawValue,n=new i(n),n.setId(n.internalId);var s=a.resourceDupStore.add(n);s&&s.length&&(t?r.setResourceId(s[0].getId()):(e.getStore().add(n),e.setValue(s[0].getId())))};if(this.confirmAddResource){var o=Ext.String.format(this.L("confirmAddResourceText"),Ext.String.htmlEncode(t));Ext.Msg.confirm(this.L("confirmAddResourceTitle"),o,function(e){"yes"==e&&s(!0)})}else s()}}},buildColumns:function(){var e=this;this.resourceCombo=new Ext.form.field.ComboBox({queryMode:"local",store:this.resourceComboStore,allowBlank:!1,editing:this.addResources,validateOnChange:!1,autoSelect:!1,forceSelection:!this.addResources,valueField:this.resourceComboStore.model.prototype.idProperty,displayField:this.resourceComboStore.model.prototype.nameField,queryCaching:!1,listConfig:{getInnerTpl:function(){return"{"+this.displayField+":htmlEncode}"}}}),this.resourcesFilter=Ext.create("Ext.util.Filter",{filterFn:this.filterResources,scope:this}),this.addResources&&Ext.Function.interceptBefore(this.resourceCombo,"assertValue",function(){e.onResourceComboAssert(this)});var t;if(this.taskId){var i=this.taskStore||this.assignmentStore.getTaskStore();t=i&&i.getModelById(this.taskId)}return[{xtype:"resourcenamecolumn",editor:this.resourceCombo,dataIndex:this.assignmentStore.model.prototype.resourceIdField,renderer:this.resourceRender,
scope:this},{xtype:"assignmentunitscolumn",assignmentStore:this.assignmentStore,dataIndex:this.assignmentStore.model.prototype.unitsField,editor:{xtype:"percentfield",step:10,readOnly:t&&"DynamicAssignment"==t.getSchedulingMode()}}]},saveResources:function(){Gnt.util.Data.applyCloneChanges(this.resourceDupStore,this.resourceStore)},saveTaskAssignments:function(){this.suspendRefreshAssignments(),this.suspendRefreshResources(),this.saveResources();var e=this.store.model,t=this.resourceDupStore,i=!0;return Gnt.util.Data.applyCloneChanges(this.store,this.assignmentStore,function(n){var r=t.getById(this.getResourceId());if(!r||!r.originalRecord)return void(i=!1);var a=r.originalRecord;n[e.prototype.resourceIdField]=a.getId()||a.internalId}),this.resumeRefreshAssignments(),this.resumeRefreshResources(),i},isDataChanged:function(){var e=this;return e.store&&e.store.getUpdatedRecords().length>0||e.store.getNewRecords().length>0||e.store.getRemovedRecords().length>0},isDataValid:function(){var e=!0;return this.store.each(function(t){if(!t.isValid())return e=!1,!1}),e}}),Ext.define("Gnt.widget.DependencyGrid",{extend:Ext.grid.Panel,alias:"widget.dependencygrid",mixins:[Gnt.mixin.Localizable],readOnly:!1,showCls:!1,cls:"gnt-dependencygrid",task:null,dependencyStore:null,taskModel:null,direction:"predecessors",oppositeStore:null,taskStoreListeners:null,refreshTimeout:100,allowParentTaskDependencies:!1,useSequenceNumber:!1,lagEditor:null,typesCombo:null,constructor:function(e){if(e=e||{},Ext.Array.each(["idText","taskText","blankTaskText","invalidDependencyText","parentChildDependencyText","duplicatingDependencyText","transitiveDependencyText","cyclicDependencyText","typeText","lagText","clsText","endToStartText","startToStartText","endToEndText","startToEndText"],function(t){t in e&&(this[t]=e[t])},this),this.store=e.store||new Ext.data.JsonStore({model:e.dependencyStore?e.dependencyStore.model:"Gnt.model.Dependency"}),this.readOnly||(this.plugins=this.buildPlugins()),this.direction=e.direction||this.direction,!e.taskModel&&(e.taskModel=Ext.ClassManager.get("Gnt.model.Task"),e.dependencyStore)){var t=e.dependencyStore.getTaskStore();t&&(e.taskModel=t.model)}e.oppositeStore&&this.setOppositeStore(e.oppositeStore),this.callParent([e])},initComponent:function(){this.task&&(this.setTask(this.task),this.loadDependencies(this.task)),this.columns=this.buildColumns(),this.callParent(arguments)},destroy:function(){this.deferredStoreBind&&this.tasksCombo.un("render",this.bindTaskStore,this),this.tasksCombo.destroy(),this.typesCombo.destroy(),this.lagEditor.destroy(),this.callParent(arguments),this.cellEditing.destroy()},setTask:function(e){if(e){this.task=e;var t=e.dependencyStore||e.getTaskStore().dependencyStore;t&&t!==this.dependencyStore&&(this.dependencyStore&&this.mun(this.dependencyStore,this.onDependencyStoreDataChanged,this),this.dependencyStore=t,this.typesCombo&&this.typesCombo.store.filter(this.typesFilter),this.mon(this.dependencyStore,this.onDependencyStoreDataChanged,this))}},onDependencyStoreDataChanged:function(){this.loadDependencies()},buildPlugins:function(){var e=this.cellEditing=new Ext.grid.plugin.CellEditing({clicksToEdit:1});return e.on({beforeedit:this.onEditingStart,edit:this.onEditingDone,scope:this}),[e]},hide:function(){this.cellEditing.cancelEdit(),this.callParent(arguments)},onEditingStart:function(e,t){var i=this.store.model.prototype;switch(t.field){case i.lagField:this.lagEditor.durationUnit=t.record.getLagUnit();break;case i.typeField:if(this.typesCombo.store.filter(this.typesFilter),this.typesCombo.store.count()<2)return!1;break;case i.fromField:"predecessors"==this.direction&&(this.activeDependency=t.record,this.refilterTasksCombo());break;case i.toField:"predecessors"!=this.direction&&(this.activeDependency=t.record,this.refilterTasksCombo())}},onEditingDone:function(e,t){var i=this.store.model.prototype;t.field==i.lagField&&t.record.setLagUnit(this.lagEditor.durationUnit),this.getView().refresh()},dependencyTypeRender:function(e){var t=this.store.model.Type;switch(e){case t.EndToStart:return this.L("endToStartText");case t.StartToStart:return this.L("startToStartText");case t.EndToEnd:return this.L("endToEndText");case t.StartToEnd:return this.L("startToEndText")}return e},taskValidate:function(e,t){if(!e)return[this.L("blankTaskText")];if(!t.isValid()){var i=this.getDependencyErrors(t);return i&&i.length?i:[this.L("invalidDependencyText")]}},taskRender:function(e,t,i){var n,r=this.taskValidate(e,i);r&&r.length?(t.tdCls=Ext.baseCSSPrefix+"form-invalid",t.tdAttr='data-errorqtip="'+r.join("<br>")+'"'):(t.tdCls="",t.tdAttr='data-errorqtip=""');var a=this.dependencyStore&&this.dependencyStore.getTaskStore();return a?(n=a.getModelById(e))&&Ext.String.htmlEncode(n.getName())||"":""},filterTasks:function(e){var t,i,n,r=e.getId();return"predecessors"===this.direction?(i=r,n=this.task.getId(),t=this.activeDependency&&this.activeDependency.getSourceId()):(n=r,i=this.task.getId(),t=this.activeDependency&&this.activeDependency.getTargetId()),!this.activeDependency||r==t||this.isValidDependency(i,n)},refilterTasksCombo:function(){this.tasksCombo.getStore().addFilter(this.tasksFilter)},bindTaskStore:function(){var e=this.dependencyStore&&this.dependencyStore.getTaskStore();if(e){if(!this.taskStoreListeners){var t=Ext.Function.createBuffered(this.bindTaskStore,this.refreshTimeout,this,[]);this.taskStoreListeners=this.mon(e,{nodeappend:t,nodeinsert:t,noderemove:t,update:t,refresh:t,clear:t,"nodestore-datachange-end":t,scope:this,destroyable:!0})}var i=new Ext.data.JsonStore({model:e.model,sorters:e.model.prototype.nameField}),n=e.getRoot();i.loadData(Gnt.util.Data.cloneModelSet(e.toArray(),function(e,t){if(t===n||t.hidden)return!1;t.getId()||e.setId(t.getId())})),this.tasksFilter=new Ext.util.Filter({id:"dependencygrid-tasksfilter",filterFn:this.filterTasks,scope:this}),i.filter(this.tasksFilter),this.tasksCombo.bindStore(i)}},buildTasksCombo:function(){var e=this;return new Ext.form.field.ComboBox({queryMode:"local",allowBlank:!1,editing:!1,forceSelection:!0,valueField:this.taskModel.prototype.idProperty,displayField:this.taskModel.prototype.nameField,queryCaching:!1,listConfig:{getInnerTpl:function(){return"{"+this.displayField+":htmlEncode}"}},validator:function(t){return!!t||e.L("blankTaskText")}})},filterAllowedTypes:function(e){if(!this.dependencyStore||!this.dependencyStore.allowedDependencyTypes)return!0;for(var t=this.dependencyStore.allowedDependencyTypes,i=this.store.model.Type,n=0,r=t.length;n<r;n++){var a=i[t[n]];if(e.getId()==a)return!0}return!1},buildTypesCombo:function(){var e=this.store.model.Type;this.typesFilter=new Ext.util.Filter({id:"typesfilter",filterFn:this.filterAllowedTypes,scope:this});var t=new Ext.data.ArrayStore({fields:[{name:"id",type:"int"},"text"],data:[[e.EndToStart,this.L("endToStartText")],[e.StartToStart,this.L("startToStartText")],[e.EndToEnd,this.L("endToEndText")],[e.StartToEnd,this.L("startToEndText")]]});return t.filter(this.typesFilter),new Ext.form.field.ComboBox({triggerAction:"all",queryMode:"local",editable:!1,valueField:"id",displayField:"text",store:t})},buildLagEditor:function(){return new Gnt.field.Duration({minValue:Number.NEGATIVE_INFINITY})},buildColumns:function(){var e=this,t=this.store.model.prototype,i=[],n=this.dependencyStore&&this.dependencyStore.getTaskStore();this.tasksCombo=this.buildTasksCombo(),n?this.bindTaskStore():(this.deferredStoreBind=!0,this.tasksCombo.on("render",this.bindTaskStore,this));var r={};return r=this.useSequenceNumber?{text:this.L("snText"),dataIndex:t.fromField,renderer:function(t,i,n){var r=e.dependencyStore&&e.dependencyStore.getTaskStore(),a=r&&r.getModelById(n.get("From"));return a?a.getSequenceNumber():""},width:50}:{text:this.L("idText"),dataIndex:t.fromField,width:50},i.push(r,{text:this.L("taskText"),dataIndex:t["predecessors"===this.direction?"fromField":"toField"],flex:1,editor:this.tasksCombo,renderer:function(t,i,n){return e.taskRender(t,i,n)}}),this.lagEditor=this.buildLagEditor(),this.typesCombo=this.buildTypesCombo(),i.push({text:this.L("typeText"),dataIndex:t.typeField,width:120,renderer:this.dependencyTypeRender,scope:this,editor:this.typesCombo},{text:this.L("lagText"),dataIndex:t.lagField,width:100,editor:this.lagEditor,renderer:function(i,n,r){return e.lagEditor.valueToVisible(i,r.get(t.lagUnitField),2)}},{text:this.L("clsText"),dataIndex:t.clsField,hidden:!this.showCls,width:100}),i},insertDependency:function(e,t){if(this.dependencyStore){var i=this.task.getId(),n=this.store.model.prototype,r={},a=this;e?r=e:(r[n.typeField]=this.typesCombo.store.getAt(0).getId(),r[n.lagField]=0,r[n.lagUnitField]="d"),"predecessors"===this.direction?r[n.toField]=i:r[n.fromField]=i;var s=this.store.insert(0,r);if(s.length){var o=s[0].isValid;s[0].isValid=function(){return o.call(this,!1)&&a.isValidDependency(this)}}return t||this.cellEditing.startEditByPosition({row:0,column:1}),s}},onOppositeStoreChange:function(){this.getView().refresh()},setOppositeStore:function(e){var t={update:this.onOppositeStoreChange,datachanged:this.onOppositeStoreChange,scope:this};this.oppositeStore&&this.mun(this.oppositeStore,t),this.oppositeStore=e,this.mon(this.oppositeStore,t)},loadDependencies:function(e){var t=this;if(e=e||this.task){this.task!==e&&this.setTask(e);var i;"predecessors"===this.direction?(i=e.getIncomingDependencies(!0),this.oppositeStore||(this.oppositeData=e.getOutgoingDependencies(!0))):(i=e.getOutgoingDependencies(!0),this.oppositeStore||(this.oppositeData=e.getIncomingDependencies(!0)));var n=Gnt.util.Data.cloneModelSet(i,function(e){var i=e.isValid;e.isValid=function(){return i.call(this,!1)&&t.isValidDependency(this)}});this.store.loadData(n),this.fireEvent("loaddependencies",this,this.store,n,e)}},getDependencyErrors:function(e,t){var i,n,r=this,a=r.dependencyStore,s=[];if(e instanceof Gnt.model.Dependency&&(i=e,e=r.task.getId(),t=e,n=i.getType(),"predecessors"===r.direction?e=i.getSourceId():t=i.getTargetId()),i&&(r.store.each(function(n){if(e==n.getSourceId()&&t==n.getTargetId()&&n!==i)return s.push(r.L("duplicatingDependencyText")),!1}),s.length))return s;var o=r.store.getRange();i&&o.splice(Ext.Array.indexOf(o,i),1);var l=r.task[r.direction],d=a.getDependencyError(e,t,n,o,l);if(d){switch(d){case-3:case-8:case-5:case-6:return[r.L("transitiveDependencyText")];case-4:case-7:return[r.L("cyclicDependencyText")];case-9:return[r.L("parentChildDependencyText")]}return[this.L("invalidDependencyText")]}return s},isValidDependency:function(){return!this.getDependencyErrors.apply(this,arguments).length},isValid:function(){var e=!0;return this.store.each(function(t){if(!t.isValid())return e=!1,!1}),e},saveDependencies:function(){this.dependencyStore&&this.isValid()&&Gnt.util.Data.applyCloneChanges(this.store,this.dependencyStore)},isDataChanged:function(){var e=this;return e.store&&e.store.getUpdatedRecords().length>0||e.store.getNewRecords().length>0||e.store.getRemovedRecords().length>0},isDataValid:function(){return this.isValid()}}),Ext.define("Gnt.widget.taskeditor.TaskEditor",{extend:Gnt.widget.taskeditor.BaseEditor,alias:"widget.taskeditor",alternateClassName:["Gnt.widget.TaskEditor"],taskFormClass:"Gnt.widget.taskeditor.TaskForm",advancedFormClass:"Gnt.widget.taskeditor.TaskForm",showAssignmentGrid:!0,showDependencyGrid:!0,allowParentTaskDependencies:!0,showNotes:!0,showAdvancedForm:!0,showRollup:!1,showBaseline:!0,taskFormConfig:null,dependencyGridClass:"Gnt.widget.DependencyGrid",dependencyGridConfig:null,assignmentGridClass:"Gnt.widget.AssignmentEditGrid",assignmentGridConfig:null,advancedFormConfig:null,notesConfig:null,notesPanel:null,notesEditor:null,taskForm:null,assignmentGrid:null,dependencyGrid:null,advancedForm:null,buildItems:function(){var e=this,t=[],i=e.clonedStores||{};return e.taskFormConfig=e.taskFormConfig||{},Ext.applyIf(e.taskFormConfig,{showBaseline:e.showBaseline,showRollup:!1}),e.taskForm=Ext.create(e.taskFormClass,Ext.apply({task:e.task,taskStore:e.taskStore},e.taskFormConfig)),t.push(e.taskForm),e.showDependencyGrid&&(e.dependencyGrid=Ext.create(e.dependencyGridClass,Ext.apply({allowParentTaskDependencies:e.allowParentTaskDependencies,taskModel:e.taskStore.model,task:e.task,margin:5,tbar:{layout:"auto",items:[{xtype:"button",iconCls:"gnt-action-add",text:e.L("addDependencyText"),itemId:"add-dependency-btn",handler:function(){e.dependencyGrid.insertDependency()}},{xtype:"button",iconCls:"gnt-action-remove",text:e.L("dropDependencyText"),itemId:"drop-dependency-btn",disabled:!0,handler:function(){var t=e.dependencyGrid.getSelectionModel().getSelection();t&&t.length&&e.dependencyGrid.store.remove(t)}}]},listeners:{selectionchange:function(t,i){var n=e.dependencyGrid;n.dropDepBtn||(n.dropDepBtn=n.down("#drop-dependency-btn")),n.dropDepBtn&&n.dropDepBtn.setDisabled(!i.length)}}},e.dependencyGridConfig)),t.push(e.dependencyGrid)),e.showAssignmentGrid&&e.assignmentStore&&e.resourceStore&&(i.assignmentStore||(i.assignmentStore=e.cloneAssignmentStore(e.task)),i.resourceStore||(i.resourceStore=e.cloneResourceStore(e.task)),e.assignmentGrid=Ext.create(e.assignmentGridClass,Ext.apply({assignmentStore:e.assignmentStore,resourceStore:e.resourceStore,store:i.assignmentStore,resourceDupStore:i.resourceStore,tbar:{layout:"auto",items:[{xtype:"button",iconCls:"gnt-action-add",text:e.L("addAssignmentText"),itemId:"add-assignment-btn",handler:function(){e.assignmentGrid.insertAssignment()}},{xtype:"button",iconCls:"gnt-action-remove",text:e.L("dropAssignmentText"),itemId:"drop-assignment-btn",disabled:!0,handler:function(){var t=e.assignmentGrid.getSelectionModel().getSelection();t&&t.length&&e.assignmentGrid.store.remove(t)}}]},listeners:{afterrender:{fn:function(t){t.loadTaskAssignments(e.task.get(e.task.idProperty))},single:!0},selectionchange:function(t,i){var n=e.assignmentGrid;n.dropBtn||(n.dropBtn=n.down("#drop-assignment-btn")),n.dropBtn&&n.dropBtn.setDisabled(!i.length)}}},e.assignmentGridConfig)),t.push(e.assignmentGrid)),e.showAdvancedForm&&(e.advancedFormConfig=e.advancedFormConfig||{},e.advancedForm=Ext.create(e.advancedFormClass,Ext.applyIf(e.advancedFormConfig,{showGeneral:!1,showBaseline:!1,showCalendar:!0,showManuallyScheduled:!0,showSchedulingMode:!0,showWbsCode:!0,showConstraint:!0,showRollup:e.showRollup,task:e.task,taskStore:e.taskStore})),t.push(e.advancedForm)),e.showNotes&&(e.notesEditor=Ext.create("Ext.form.field.HtmlEditor",Ext.apply({listeners:{afterrender:function(t){e.notesEditor.setValue(e.task.get(e.task.noteField))}},readOnly:e.task&&!e.task.isEditable(e.task.noteField),isDataChanged:function(){return this.isDirty()}},e.notesConfig)),e.notesPanel=Ext.create("Ext.panel.Panel",{border:!1,layout:"fit",items:e.notesEditor}),t.push(e.notesPanel)),e.taskForm.title||(e.taskForm.title=e.L("generalText")),e.dependencyGrid&&!e.dependencyGrid.title&&(e.dependencyGrid.title=e.L("dependencyText")),e.assignmentGrid&&!e.assignmentGrid.title&&(e.assignmentGrid.title=e.L("resourcesText")),e.advancedForm&&!e.advancedForm.title&&(e.advancedForm.title=e.L("advancedText")),e.notesPanel&&!e.notesPanel.title&&(e.notesPanel.title=e.L("notesText")),t},bindDependencyGrid:function(){var e=this.clonedStores.dependencyStore,t=this.dependencyGrid;t.store.taskStore=this.clonedStores.taskStore,e&&(this.mon(t,{loaddependencies:function(t,i){e.loadData(i.getRange().concat(Gnt.util.Data.cloneModelSet(t.oppositeData)))}}),this.mon(t.store,{add:function(t,i){e.add(i)},remove:function(t,i){e.remove(i)}}),this.dependencyGridBound=!0)},loadTask:function(e){if(e){this.task=e;var t=this,i=t.taskForm,n=t.dependencyGrid,r=t.assignmentGrid;i.setSuppressTaskUpdate(!0),i.getForm().reset(),t.callParent([e,!n,!r]);var a=t.clonedStores,s=t.taskBuffer;if(n&&(t.dependencyGridBound||t.bindDependencyGrid(),n.loadDependencies(e),t.allowParentTaskDependencies||e.isLeaf()?n.tab.show():n.tab.hide()),r&&(a.assignmentStore!==r.getStore()&&r.reconfigure(a.assignmentStore),r.resourceDupStore!==a.resourceStore&&(r.resourceDupStore=a.resourceStore),r.loadResources(!0),r.loadTaskAssignments(e.getId()||e.getPhantomId()),r.task=s),i.loadRecord(e,s),t.advancedForm){t.advancedForm.setSuppressTaskUpdate(!0);var o=t.advancedForm.getForm();o.reset(),t.advancedForm.loadRecord(e,i.taskBuffer);var l=o.findField("wbsCode");l&&l.setValue(e.getWBSCode()),t.advancedForm.setSuppressTaskUpdate(!1)}i.setSuppressTaskUpdate(!1),t.notesEditor&&(t.notesEditor.setValue(e.getNote()),t.notesEditor.setReadOnly(!e.isEditable(e.noteField))),t.fireEvent("loadtask",t,e)}},doValidate:function(e){var t=this.callParent(arguments);return this.taskForm&&!this.taskForm.isValid()&&(t=!1,e&&e(this.getTabByComponent(this.taskForm),this.taskForm)),this.dependencyGrid&&!this.dependencyGrid.isValid()&&(t=!1,e&&e(this.getTabByComponent(this.dependencyGrid),this.dependencyGrid)),this.assignmentGrid&&!this.assignmentGrid.isValid()&&(t=!1,e&&e(this.getTabByComponent(this.assignmentGrid),this.assignmentGrid)),this.advancedForm&&!this.advancedForm.isValid()&&(t=!1,e&&e(this.getTabByComponent(this.advancedForm),this.advancedForm)),t},doUpdateTask:function(){this.callParent(arguments),this.taskForm&&this.taskForm.updateRecord(),this.advancedForm&&this.advancedForm.updateRecord(),this.notesEditor&&this.task.set(this.task.noteField,this.notesEditor.getValue()),this.assignmentGrid&&this.assignmentGrid.saveTaskAssignments(),this.dependencyGrid&&this.dependencyGrid.saveDependencies()},isDataChanged:function(e){var t=this.callParent(arguments);return this.taskForm&&this.taskForm.isDataChanged()&&(t=!0,e&&e(this.getTabByComponent(this.taskForm))),this.dependencyGrid&&this.dependencyGrid.isDataChanged()&&(t=!0,e&&e(this.getTabByComponent(this.dependencyGrid))),this.assignmentGrid&&this.assignmentGrid.isDataChanged()&&(t=!0,e&&e(this.getTabByComponent(this.assignmentGrid))),this.advancedForm&&this.advancedForm.isDataChanged()&&(t=!0,e&&e(this.getTabByComponent(this.advancedForm))),this.notesEditor&&this.notesEditor.isDataChanged()&&(t=!0,e&&e(this.getTabByComponent(this.notesEditor))),t}}),Ext.define("Gnt.plugin.taskeditor.TaskEditor",{extend:Gnt.plugin.taskeditor.BaseEditor,alternateClassName:["Gnt.plugin.TaskEditor"],alias:"plugin.gantt_taskeditor",ptype:"gantt_taskeditor",taskEditorCls:"Gnt.widget.taskeditor.TaskEditor",height:420,width:650,taskEditorConfigs:"l10n,task,taskStore,assignmentStore,resourceStore,generalText,resourcesText,dependencyText,addDependencyText,dropDependencyText,notesText,advancedText,wbsCodeText,addAssignmentText,dropAssignmentText,showAssignmentGrid,showDependencyGrid,allowParentTaskDependencies,showNotes,showStyle,showAdvancedForm,taskFormClass,advancedFormClass,taskFormConfig,dependencyGridConfig,assignmentGridConfig,advancedFormConfig,styleFormConfig,dependencyGridClass,assignmentGridClass",constructor:function(e){this.callParent(arguments),this.addFilter(this.isTask)},init:function(e){this.callParent(arguments),e.taskEditor=this},isTask:function(e){return e&&!e.isProject}}),Ext.define("Gnt.widget.Calendar",{extend:Ext.picker.Date,alias:"widget.ganttcalendar",mixins:[Gnt.mixin.Localizable],calendar:null,startDate:null,endDate:null,initComponent:function(){this.calendar||Ext.Error.raise('Required attribute "calendar" missing during initialization of `Gnt.widget.Calendar`'),this.startDate||Ext.Error.raise('Required attribute "startDate" missing during initialization of `Gnt.widget.Calendar`'),this.endDate||(this.endDate=Sch.util.Date.add(this.startDate,Sch.util.Date.MONTH,1)),this.setCalendar(this.calendar),this.minDate=this.value=this.startDate,this.callParent(arguments),this.injectDates()},injectDates:function(){var e=this,t=e.disabledDates=[];Ext.Array.forEach(e.calendar.getHolidaysRanges(e.startDate,e.endDate),function(i){i.forEachDate(function(i){t.push(Ext.Date.format(i,e.format))})}),e.setDisabledDates(t)},setCalendar:function(e){var t={update:this.injectDates,remove:this.injectDates,add:this.injectDates,load:this.injectDates,clear:this.injectDates,scope:this};this.calendar&&this.mun(e,t),this.calendar=e,e&&this.mon(e,t)}}),Ext.define("Gnt.widget.calendar.AvailabilityGrid",{extend:Ext.grid.Panel,mixins:[Gnt.mixin.Localizable],alias:"widget.calendaravailabilitygrid",calendarDay:null,height:160,addButton:null,removeButton:null,maxIntervalsNum:5,initComponent:function(){this.tbar||(this.tbar=this.buildToolbar()),Ext.applyIf(this,{store:new Ext.data.Store({fields:["startTime","endTime"],data:this.calendarDay.getAvailability()}),plugins:[new Ext.grid.plugin.CellEditing({clicksToEdit:2})],columns:[{xtype:"datecolumn",header:this.L("startText"),format:"g:i a",dataIndex:"startTime",flex:1,editor:{xtype:"timefield",allowBlank:!1,initDate:"31/12/1899"}},{xtype:"datecolumn",header:this.L("endText"),format:"g:i a",dataIndex:"endTime",flex:1,editor:{xtype:"timefield",allowBlank:!1,initDate:"31/12/1899"}}],listeners:{selectionchange:this.onAvailabilityGridSelectionChange,scope:this}}),this.callParent(arguments)},buildToolbar:function(){return this.addButton=new Ext.Button({text:this.L("addText"),iconCls:"gnt-action-add",handler:this.addAvailability,scope:this}),this.removeButton=new Ext.Button({text:this.L("removeText"),iconCls:"gnt-action-remove",handler:this.removeAvailability,scope:this,disabled:!0}),[this.addButton,this.removeButton]},onAvailabilityGridSelectionChange:function(e,t){this.removeButton.setDisabled(!t.length)},setAvailability:function(e){this.store.loadData(e),this.addButton.setDisabled(this.store.getCount()>=this.maxIntervalsNum)},addAvailability:function(){var e=this.getStore(),t=e.count();t>=this.maxIntervalsNum||(e.add({startTime:new Date(0,0,0,12,0),endTime:new Date(0,0,0,13,0)}),t+1>=this.maxIntervalsNum&&this.addButton&&this.addButton.disable())},removeAvailability:function(){var e=this.getStore(),t=e.getCount(),i=this.getSelection();i.length&&(e.remove(i[0]),t<this.maxIntervalsNum&&this.addButton&&this.addButton.enable())},isValid:function(e){try{this.calendarDay.verifyAvailability(this.getIntervals())}catch(t){return e||Ext.MessageBox.show({title:this.L("error"),msg:t,modal:!0,icon:Ext.MessageBox.ERROR,buttons:Ext.MessageBox.OK}),!1}return!0},extractTimeFromDate:function(e){return new Date(0,0,0,e.getHours(),e.getMinutes(),e.getSeconds())},getIntervals:function(){var e=[],t=this;return this.getStore().each(function(i){var n=t.extractTimeFromDate(i.get("endTime"));n-new Date(0,0,0,0,0,0)==0&&(n=new Date(0,0,1,0,0)),e.push({startTime:t.extractTimeFromDate(i.get("startTime")),endTime:n})}),e}}),Ext.define("Gnt.widget.calendar.DayEditor",{extend:Gnt.widget.calendar.AvailabilityGrid,mixins:[Gnt.mixin.Localizable],alias:"widget.calendardayeditor",height:160,initComponent:function(){var e=this.calendarDay.getIsWorkingDay();this.dockedItems=this.dockedItems||[{xtype:"radiogroup",dock:"top",name:"dayType",padding:"0 5px",margin:0,items:[{boxLabel:this.L("workingTimeText"),name:"IsWorkingDay",inputValue:!0,checked:e},{boxLabel:this.L("nonworkingTimeText"),name:"IsWorkingDay",inputValue:!1,checked:!e}],listeners:{change:this.onDayTypeChanged,scope:this}}],this.on("afterrender",this.myApplyState,this),this.callParent(arguments)},getDayTypeRadioGroup:function(){return this.down('radiogroup[name="dayType"]')},myApplyState:function(){this.isWorkingDay()||(this.viewSetDisabled(!0),this.addButton.disable())},viewSetDisabled:function(e){e?(this.getView().getEl().mask(),this.headerCt.getEl().mask()):(this.getView().getEl().unmask(),this.headerCt.getEl().unmask())},onDayTypeChanged:function(e){var t=e.getValue();Ext.isArray(t.IsWorkingDay)||(this.viewSetDisabled(!t.IsWorkingDay),this.addButton.setDisabled(!t.IsWorkingDay||this.getStore().getCount()>=this.maxIntervalsNum))},isWorkingDay:function(){return this.getDayTypeRadioGroup().getValue().IsWorkingDay},isValid:function(){return!this.isWorkingDay()||this.callParent()},getIntervals:function(){return this.isWorkingDay()?this.callParent():[]}}),Ext.define("Gnt.widget.calendar.WeekEditor",{extend:Ext.form.Panel,mixins:[Gnt.mixin.Localizable],alias:"widget.calendarweekeditor",weekName:null,startDate:null,endDate:null,weekAvailability:null,calendarWeekAvailability:null,defaultWeekAvailability:null,backupWeekAvailability:null,layout:"anchor",defaults:{border:!1,anchor:"100%"},calendarDayModel:null,currentDayIndex:null,_weekDaysGrid:null,_availabilityGrid:null,initComponent:function(){this.backupWeekAvailability=[],this.items=[{xtype:"radiogroup",padding:"0 5px",name:"dayType",items:[{boxLabel:this.L("defaultTimeText"),name:"IsWorkingDay",inputValue:0},{boxLabel:this.L("workingTimeText"),name:"IsWorkingDay",inputValue:1},{boxLabel:this.L("nonworkingTimeText"),name:"IsWorkingDay",inputValue:2}],listeners:{change:this.onDayTypeChanged,scope:this}},{layout:"column",padding:"0 0 5px 0",defaults:{border:!1},items:[{margin:"0 10px 0 5px",columnWidth:.5,items:this.getWeekDaysGrid()},{columnWidth:.5,margin:"0 5px 0 0",items:this.getAvailabilityGrid()}]}],this.callParent(arguments)},getWeekDaysGrid:function(){if(null!=this._weekDaysGrid)return this._weekDaysGrid;var e=Ext.Date.dayNames;return this._weekDaysGrid=new Ext.grid.Panel({hideHeaders:!0,height:160,columns:[{header:"",dataIndex:"name",flex:1}],store:new Ext.data.Store({fields:["id","name"],idProperty:"id",data:[{id:1,name:e[1]},{id:2,name:e[2]},{id:3,name:e[3]},{id:4,name:e[4]},{id:5,name:e[5]},{id:6,name:e[6]},{id:0,name:e[0]}]}),listeners:{viewready:this.onWeekDaysListViewReady,selectionchange:this.onWeekDaysListSelectionChange,beforeselect:this.onWeekDaysListBeforeSelect,scope:this}})},getAvailabilityGrid:function(){return this._availabilityGrid||(this._availabilityGrid=new Gnt.widget.calendar.AvailabilityGrid({calendarDay:new this.calendarDayModel})),this._availabilityGrid},getDayTypeRadioGroup:function(){return this.dayTypeRadioGroup||(this.dayTypeRadioGroup=this.down('radiogroup[name="dayType"]')),this.dayTypeRadioGroup},getWeekAvailability:function(){return this.weekAvailability},onWeekDaysListViewReady:function(){var e=this.getWeekDaysGrid(),t=e.getStore().getAt(0);this.currentDayIndex=t.getId(),this.readFromData(),e.getSelectionModel().select(t,!1,!0)},onWeekDaysListBeforeSelect:function(){if(!this.saveToData())return!1},applyChanges:function(e){if(!this.saveToData())return!1;for(var t=this.weekAvailability,i=!1,n=0;n<7;n++){var r=t[n];r?(i=!0,e[n]||(e[n]=r),e[n].setIsWorkingDay(r.getIsWorkingDay()),e[n].setAvailability(r.getAvailability())):e[n]=null}return!!i||(Ext.MessageBox.show({title:this.L("error"),msg:this.L("noOverrideError"),modal:!0,icon:Ext.MessageBox.ERROR,buttons:Ext.MessageBox.OK}),!1)},onWeekDaysListSelectionChange:function(e,t){this.currentDayIndex=t[0].getId(),this.readFromData()},getCurrentTypeOfWeekDay:function(e){return this.weekAvailability[e]?this.weekAvailability[e].getIsWorkingDay()?1:2:0},getCurrentWeekDay:function(e){return this.weekAvailability[e]||this.calendarWeekAvailability[e]||this.defaultWeekAvailability[e]},saveToData:function(){var e=this.currentDayIndex,t=this.getDayTypeRadioGroup().getValue().IsWorkingDay,i=this.weekAvailability;if(0===t)return i[e]=null,!0;var n=this.getAvailabilityGrid();return 1==t?!!n.isValid()&&(i[e]||(i[e]=this.copyDefaultWeekDay(e)),i[e].setIsWorkingDay(!0),i[e].setAvailability(n.getIntervals()),this.backupWeekAvailability[e]=null,!0):(i[e]||(i[e]=this.copyDefaultWeekDay(e)),i[e].setIsWorkingDay(!1),i[e].setAvailability([]),!0)},copyDefaultWeekDay:function(e){var t=(this.calendarWeekAvailability[e]||this.defaultWeekAvailability[e]).copy();return t.phantom=!0,t.beginEdit(),t.setType("WEEKDAYOVERRIDE"),t.setOverrideStartDate(this.startDate),t.setOverrideEndDate(this.endDate),t.setName(this.weekName),t.endEdit(),t},readFromData:function(e){var t=this.getCurrentWeekDay(this.currentDayIndex),i=this.getCurrentTypeOfWeekDay(this.currentDayIndex),n=this.getAvailabilityGrid();n.setAvailability(e||t.getAvailability());var r=this.getDayTypeRadioGroup();r.suspendEvents(),r.setValue({IsWorkingDay:[i]}),r.resumeEvents(),n.setDisabled(1!=i)},onDayTypeChanged:function(e,t,i){var n=e.getValue();if(null!=n.IsWorkingDay&&!Ext.isArray(n.IsWorkingDay)){var r,a=this.weekAvailability,s=this.backupWeekAvailability,o=this.currentDayIndex,l=this.getAvailabilityGrid();switch(1==i.IsWorkingDay&&(s[o]=l.getIntervals()),n.IsWorkingDay){case 0:a[o]=null;break;case 1:a[o]||(a[o]=this.copyDefaultWeekDay(o)),r=s[o],a[o].setIsWorkingDay(!0);break;case 2:a[o]||(a[o]=this.copyDefaultWeekDay(o)),a[o].setAvailability([]),a[o].setIsWorkingDay(!1);break;default:throw"Unrecognized day type"}this.readFromData(r)}}}),Ext.define("Gnt.widget.calendar.DatePicker",{extend:Ext.picker.Date,alias:"widget.gntdatepicker",workingDayCls:"gnt-datepicker-workingday",nonWorkingDayCls:"gnt-datepicker-nonworkingday",overriddenDayCls:"gnt-datepicker-overriddenday",overriddenWeekDayCls:"gnt-datepicker-overriddenweekday",weekOverridesStore:null,dayOverridesCalendar:null,update:function(){this.callParent(arguments),this.refreshCssClasses()},refreshCssClasses:function(){var e=this,t=e.cells.elements;this.removeCustomCls();for(var i=0;i<e.numDays;i++){var n=t[i].firstChild.dateValue;t[i].className+=" "+this.getDateCls(new Date(n))}},getDateCls:function(e){var t="";if(e.getMonth()===this.getActive().getMonth()){var i=this.dayOverridesCalendar;if(i.getOwnCalendarDay(e))t+=" "+this.overriddenDayCls,i.isWorkingDay(e)||(t+=" "+this.nonWorkingDayCls);else{var n=null;if(this.weekOverridesStore.each(function(t){if(Ext.Date.between(e,t.get("startDate"),t.get("endDate")))return n=t,!1}),n){t+=" "+this.overriddenWeekDayCls;var r=e.getDay(),a=n.get("weekAvailability");a&&a[r]&&!a[r].getIsWorkingDay()&&(t+=" "+this.nonWorkingDayCls)}else i.isWorkingDay(e)||(t+=" "+this.nonWorkingDayCls)}return t||this.workingDayCls}},removeCustomCls:function(){this.cells.removeCls([this.overriddenDayCls,this.nonWorkingDayCls,this.workingDayCls,this.overriddenWeekDayCls])}}),Ext.define("Gnt.widget.calendar.Calendar",{extend:Ext.form.Panel,mixins:[Gnt.mixin.Localizable],alias:"widget.calendar",defaults:{padding:10,border:!1},workingDayCls:"gnt-datepicker-workingday",nonWorkingDayCls:"gnt-datepicker-nonworkingday",overriddenDayCls:"gnt-datepicker-overriddenday",overriddenWeekDayCls:"gnt-datepicker-overriddenweekday",calendar:null,calendarManager:null,dayGridConfig:null,weekGridConfig:null,datePickerConfig:null,dayGrid:null,weekGrid:null,datePicker:null,legendTpl:'<ul class="gnt-calendar-legend"><li class="gnt-calendar-legend-item"><div class="gnt-calendar-legend-itemstyle {workingDayCls}"></div><span class="gnt-calendar-legend-itemname">{workingDayText}</span><div style="clear: both"></div></li><li><div class="gnt-calendar-legend-itemstyle {nonWorkingDayCls}"></div><span class="gnt-calendar-legend-itemname">{weekendsText}</span><div style="clear: both"></div></li><li class="gnt-calendar-legend-override"><div class="gnt-calendar-legend-itemstyle {overriddenDayCls}">31</div><span class="gnt-calendar-legend-itemname">{overriddenDayText}</span><div style="clear: both"></div></li><li class="gnt-calendar-legend-override"><div class="gnt-calendar-legend-itemstyle {overriddenWeekDayCls}">31</div><span class="gnt-calendar-legend-itemname">{overriddenWeekText}</span><div style="clear: both"></div></li></ul>',dateInfoTpl:null,dayOverridesCalendar:null,weekOverridesStore:null,copiesIndexByOriginalId:null,currentDayOverrideEditor:null,calendarDayModel:null,layout:{type:"vbox",align:"stretch"},initComponent:function(){var e=this;e.copiesIndexByOriginalId={},e.setupTemplates();var t=e.calendar;!t&&e.calendarManager&&(t=e.calendarManager.getProjectCalendar()||e.calendarManager.getRoot().firstChild),e.calendarDayModel||(e.calendarDayModel=t&&t.getModel&&t.getModel()||t.model),e.buildItems(),e.bindListeners(),e.callParent(arguments),e.calendar&&e.setCalendar(e.calendar)},bindListeners:function(){var e=this;e.on("calendarset",e.onCalendarSet),e.on("afterrender",e.onCalendarSet),e.dayGrid.on({selectionchange:e.onDayGridSelectionChange,validateedit:e.onDayGridValidateEdit,
edit:e.onDayGridEdit,scope:e}),e.dayGrid.store.on({update:e.refreshView,remove:e.refreshView,add:e.refreshView,scope:e}),e.weekGrid.on({selectionchange:e.onWeekGridSelectionChange,validateedit:e.onWeekGridValidateEdit,edit:e.onWeekGridEdit,scope:e}),e.weekGrid.store.on({update:e.refreshView,remove:e.refreshView,add:e.refreshView,scope:e}),e.datePicker.on({select:e.onDateSelect,scope:e})},buildItems:function(){this.dateInfoPanel=new Ext.Panel({cls:"gnt-calendar-dateinfo",padding:"10 10 10 10",columnWidth:.33,border:!1,height:200}),this.cmbParentCalendar=new Ext.form.field.ComboBox({name:"cmb_parentCalendar",fieldLabel:this.L("parentCalendarText"),store:new Ext.data.Store({fields:["Id","Name"]}),queryMode:"local",displayField:"Name",valueField:"Id",editable:!1,emptyText:this.L("selectParentText"),flex:1}),this.buildWeekGrid(),this.buildDayGrid(),this.buildDatePicker(),this.items=[{xtype:"container",layout:"hbox",pack:"start",align:"stretch",items:[{xtype:"textfield",itemId:"calendarName",fieldLabel:this.L("calendarNameText"),margin:"0 10 0 0",flex:1},this.cmbParentCalendar]},{layout:"column",padding:"10 10 0 10",defaults:{border:!1},items:[{columnWidth:.3,html:this.legendTpl.apply({workingDayText:this.L("workingDayText"),weekendsText:this.L("weekendsText"),overriddenDayText:this.L("overriddenDayText"),overriddenWeekText:this.L("overriddenWeekText"),workingDayCls:this.workingDayCls,nonWorkingDayCls:this.nonWorkingDayCls,overriddenDayCls:this.overriddenDayCls,overriddenWeekDayCls:this.overriddenWeekDayCls})},{columnWidth:.37,layout:{type:"hbox",pack:"center"},items:[this.datePicker]},this.dateInfoPanel]},{xtype:"tabpanel",padding:"10 10 10 10",flex:1,items:[this.dayGrid,this.weekGrid]}]},buildDayGrid:function(){var e=this.calendarDayModel.prototype;this.dayGrid=new Ext.grid.Panel(Ext.apply({title:this.L("dayOverridesText"),itemId:"dayGrid",tbar:[{text:this.L("addText"),itemId:"btnAdd",action:"add",iconCls:"gnt-action-add",handler:this.addDay,scope:this},{text:this.L("editText"),itemId:"btnEdit",action:"edit",iconCls:"gnt-action-edit",handler:this.editDay,scope:this},{text:this.L("removeText"),itemId:"btnRemove",action:"remove",iconCls:"gnt-action-remove",handler:this.removeDay,scope:this}],store:new Gnt.data.Calendar,plugins:[new Ext.grid.plugin.CellEditing({clicksToEdit:2})],columns:[{header:this.L("dayOverrideNameHeaderText"),dataIndex:e.nameField,flex:1,editor:{allowBlank:!1}},{header:this.L("dateText"),dataIndex:e.dateField,width:100,xtype:"datecolumn",editor:{xtype:"datefield"}}]},this.dayGridConfig||{})),this.dayOverridesCalendar=this.dayGrid.store},updateGrids:function(){this.dayGrid&&this.fillDaysStore(),this.weekGrid&&this.fillWeeksStore()},buildWeekGrid:function(){this.weekGrid=new Ext.grid.Panel(Ext.apply({title:this.L("weekOverridesText"),border:!0,itemId:"weekGrid",plugins:[new Ext.grid.plugin.CellEditing({clicksToEdit:2})],store:new Ext.data.Store({model:"Gnt.model.Week"}),tbar:[{text:this.L("addText"),itemId:"btnAdd",action:"add",iconCls:"gnt-action-add",handler:this.addWeek,scope:this},{text:this.L("editText"),itemId:"btnEdit",action:"edit",iconCls:"gnt-action-edit",handler:this.editWeek,scope:this},{text:this.L("removeText"),itemId:"btnRemove",action:"remove",iconCls:"gnt-action-remove",handler:this.removeWeek,scope:this}],columns:[{header:this.L("overrideName"),dataIndex:"name",flex:1,editor:{allowBlank:!1}},{xtype:"datecolumn",header:this.L("startDate"),dataIndex:"startDate",width:100,editor:{xtype:"datefield"}},{xtype:"datecolumn",header:this.L("endDate"),dataIndex:"endDate",width:100,editor:{xtype:"datefield"}}]},this.weekGridConfig||{})),this.weekOverridesStore=this.weekGrid.store},buildDatePicker:function(){this.datePicker=new Gnt.widget.calendar.DatePicker(Ext.apply({dayOverridesCalendar:this.dayGrid.store,weekOverridesStore:this.weekGrid.store},this.datePickerConfig))},onCalendarSet:function(e){this.weekOverridesStore.commitChanges()},setCalendar:function(e){this.calendar&&this.mun(this.calendar,{load:this.onCalendarChange,add:this.onCalendarChange,remove:this.onCalendarChange,update:this.onCalendarChange,parentchange:this.onParentChange,scope:this}),this.calendar=e,e&&this.mon(this.calendar,{load:this.onCalendarChange,add:this.onCalendarChange,remove:this.onCalendarChange,update:this.onCalendarChange,parentchange:this.onParentChange,scope:this}),this.onCalendarChange(),this.fireEvent("calendarset",e)},onParentChange:function(){this.updateComboBox()},updateComboBox:function(){var e=this,t=[];if(e.calendarManager){var i=e.calendarManager.getRoot(),n=e.calendarManager.getNodeByCalendar(e.calendar);i.cascadeBy(function(e){var r=e.getCalendar();e===i||e===n||n.contains(e)||t.push({Id:r.calendarId,Name:e.getName()||r.calendarId})})}else t=e.calendar.getParentableCalendars();this.cmbParentCalendar.store.loadData([{Id:-1,Name:this.L("noParentText")}].concat(t));var r=this.calendar&&this.calendar.parent,a=r&&r.calendarId;this.cmbParentCalendar.setValue(a||-1),Ext.isIE10p&&this.cmbParentCalendar.doQueryTask.cancel()},onCalendarChange:function(){this.updateComboBox(),this.fillDaysStore(),this.fillWeeksStore(),this.refreshView()},setupTemplates:function(){var e=this.L("tplTexts");this.dateInfoTpl||(this.dateInfoTpl=Ext.String.format('<div class="gnt-calendar-overridedate"><tpl if="isWorkingDay">'+e.tplWorkingHours+" {date}:<tpl else>{date} "+e.tplIsNonWorking+'</tpl></div><ul class="gnt-calendar-availabilities"><tpl for="availability"><li>{.}</li></tpl></ul><span class="gnt-calendar-overridesource">'+e.tplBasedOn+': <tpl if="override">'+e.tplOverride+' "{name}" '+e.tplInCalendar+' "{calendarName}"<tpl else>'+e.tplDayInCalendar+' "{calendarName}"</tpl></span>')),this.dateInfoTpl instanceof Ext.Template||(this.dateInfoTpl=new Ext.XTemplate(this.dateInfoTpl)),this.legendTpl instanceof Ext.Template||(this.legendTpl=new Ext.XTemplate(this.legendTpl))},afterRender:function(){this.callParent(arguments),this.onDateSelect(this.datePicker,new Date)},fillDaysStore:function(){var e=Gnt.util.Data.cloneModelSet(this.calendar,function(e){return"DAY"==e.getType()&&e.getDate()});this.dayOverridesCalendar.loadData(e)},copyCalendarDay:function(e){var t=e.copy(null);return t.__COPYOF__=e.getId(),this.copiesIndexByOriginalId[e.getId()]=t.getId(),t},fillWeeksStore:function(){var e=this,t=[];this.calendar.forEachNonStandardWeek(function(i){var n=Ext.apply({},i);n.weekAvailability=Ext.Array.map(n.weekAvailability,function(t){return t&&e.copyCalendarDay(t)||null}),n.mainDay=e.copyCalendarDay(n.mainDay),t.push(n)}),this.weekOverridesStore.loadData(t)},addDay:function(){var e=this.datePicker.getValue();if(this.dayOverridesCalendar.getOwnCalendarDay(e))return void this.alert({msg:this.L("overrideErrorText")});var t=this.calendar.model,i=t.prototype,n={};n[i.nameField]=this.L("newDayName"),n[i.typeField]="DAY",n[i.dateField]=e,n=new t(n),this.dayGrid.getStore().insert(0,n),this.dayGrid.getSelectionModel().select([n],!1,!1)},editDay:function(){var e=this,t=this.dayGrid.getSelection(),i=t[0];if(i){var n=this.currentDayOverrideEditor=new Gnt.widget.calendar.DayEditor({addText:this.L("addText"),removeText:this.L("removeText"),workingTimeText:this.L("workingTimeText"),nonworkingTimeText:this.L("nonworkingTimeText"),calendarDay:i}),r=Ext.create("Ext.window.Window",{title:this.L("dayOverridesText"),modal:!0,width:280,height:260,layout:"fit",items:n,buttons:[{text:this.L("okText"),handler:function(){if(n.isValid()){var t=n.calendarDay;t.setIsWorkingDay(n.isWorkingDay()),t.setAvailability(n.getIntervals()),e.applyCalendarDay(t,i),e.refreshView(),r.close()}}},{text:this.L("cancelText"),handler:function(){r.close()}}]});r.show()}},removeDay:function(){var e=this.dayGrid,t=e.getSelection();t[0]&&(e.getStore().remove(t[0]),this.refreshView())},refreshView:function(){var e,t,i=this.datePicker.getValue(),n=this.getCalendarDay(i),r=this.weekGrid,a=this.dayGrid,s=this.dayOverridesCalendar.getOwnCalendarDay(i);s?(a.getSelectionModel().select([s],!1,!0),t=s.getName()):(e=this.getWeekOverrideByDate(i))&&(r.getSelectionModel().select([e],!1,!0),t=e.get("name"));var o={name:t||n.getName(),date:Ext.Date.format(i,"M j, Y"),calendarName:this.calendar.name||this.calendar.calendarId,availability:n.getAvailability(!0),override:Boolean(s||e),isWorkingDay:n.getIsWorkingDay()};this.dateInfoPanel.update(this.dateInfoTpl.apply(o)),this.down("#calendarName").setValue(this.calendar.name),this.datePicker.rendered&&this.datePicker.refreshCssClasses()},onDayGridSelectionChange:function(e,t){t[0]&&(this.datePicker.setValue(t[0].getDate()),this.refreshView())},onDayGridEdit:function(e,t){"Date"===t.field&&(t.grid.getStore().clearCache(),this.datePicker.setValue(t.value)),this.refreshView()},onDayGridValidateEdit:function(e,t){var i=this.dayGrid.store;if(t.field===i.model.prototype.dateField&&i.getOwnCalendarDay(t.value)&&t.value!==t.originalValue)return this.alert({msg:this.L("overrideErrorText")}),!1},onDateSelect:function(e,t){this.refreshView()},getCalendarDay:function(e){var t=this.dayOverridesCalendar.getOwnCalendarDay(e);return t||((t=this.getWeekOverrideDay(e))||(this.calendar.weekAvailability[e.getDay()]||this.calendar.defaultWeekAvailability[e.getDay()]))},getWeekOverrideDay:function(e){var t=new Date(e),i=this.getWeekOverrideByDate(e),n=t.getDay();if(null==i)return null;var r=i.get("weekAvailability");return r?r[n]:null},getWeekOverrideByDate:function(e){var t=null;return this.weekOverridesStore.each(function(i){if(Ext.Date.between(e,i.get("startDate"),i.get("endDate")))return t=i,!1}),t},intersectsWithCurrentWeeks:function(e,t,i){var n=!1;return this.weekOverridesStore.each(function(r){if(r!=i){var a=r.get("startDate"),s=r.get("endDate");return a<=e&&e<s||a<t&&t<=s?(n=!0,!1):void 0}}),n},addWeek:function(){for(var e,t=this.weekOverridesStore,i=this.datePicker.getValue(),n=7;n>0&&(e=Sch.util.Date.add(i,Sch.util.Date.DAY,n),this.intersectsWithCurrentWeeks(i,e));n--);if(!n)return void this.alert({msg:Ext.String.format(this.L("overrideDateError"),Ext.Date.format(i,"Y/m/d"))});var r=new this.calendar.model;r.setType("WEEKDAYOVERRIDE"),r.setName(this.L("newDayName")),r.setOverrideStartDate(i),r.setOverrideEndDate(e),r.setWeekday(-1);var a=t.insert(0,{name:this.L("newDayName"),startDate:i,endDate:e,weekAvailability:[],mainDay:r})[0];this.weekGrid.getSelectionModel().select([a],!1,!1)},editWeek:function(){var e=this.weekGrid.getSelection(),t=this;if(0!==e.length){var i=e[0],n=new Gnt.widget.calendar.WeekEditor({startDate:i.get("startDate"),endDate:i.get("endDate"),weekName:i.get("name"),calendarDayModel:this.calendar.model,weekAvailability:i.get("weekAvailability"),calendarWeekAvailability:this.calendar.weekAvailability,defaultWeekAvailability:this.calendar.defaultWeekAvailability}),r=Ext.create("Ext.window.Window",{title:this.L("weekOverridesText"),modal:!0,width:370,defaults:{border:!1},layout:"fit",items:n,buttons:[{action:"ok",text:this.L("okText"),handler:function(){n.applyChanges(i.get("weekAvailability"))&&(t.refreshView(),r.close())}},{text:this.L("cancelText"),handler:function(){r.close()}}]});r.show()}},removeWeek:function(){var e=this.weekGrid.getSelection();e[0]&&(this.weekOverridesStore.remove(e[0]),this.refreshView())},onWeekGridSelectionChange:function(e,t){t[0]&&this.datePicker.setValue(t[0].get("startDate"))},onWeekGridEdit:function(e,t){var i=t.record,n=i.get("startDate"),r=i.get("endDate");"startDate"!=t.field&&"endDate"!=t.field||(Ext.Array.each(i.get("weekAvailability").concat(i.get("mainDay")),function(e){e&&(e.setOverrideStartDate(n),e.setOverrideEndDate(r))}),this.datePicker.setValue(n)),this.refreshView()},alert:function(e){e=e||{},Ext.MessageBox.show(Ext.applyIf(e,{title:this.L("error"),icon:Ext.MessageBox.WARNING,buttons:Ext.MessageBox.OK}))},onWeekGridValidateEdit:function(e,t){var i=t.record,n="startDate"==t.field?t.value:i.get("startDate"),r="endDate"==t.field?t.value:i.get("endDate");return n>r?(this.alert({msg:this.L("startAfterEndError")}),!1):this.intersectsWithCurrentWeeks(n,r,i)?(this.alert({msg:this.L("weeksIntersectError")}),!1):void 0},applyCalendarDay:function(e,t){t.beginEdit(),t.setName(e.getName()),t.setIsWorkingDay(e.getIsWorkingDay()),t.setDate(e.getDate()),t.setOverrideStartDate(e.getOverrideStartDate()),t.setOverrideEndDate(e.getOverrideEndDate()),e.getAvailability(!0)+""!=t.getAvailability(!0)+""&&t.setAvailability(e.getAvailability()),t.endEdit()},applySingleDay:function(e,t){e.__COPYOF__?this.applyCalendarDay(e,this.calendar.getModelByInternalId(e.__COPYOF__)):(e.store&&e.unjoin(e.store),t.push(e))},applyChanges:function(){var e=this,t=this.calendar,i=this.down('combobox[name="cmb_parentCalendar"]').getValue(),n=this.down("#calendarName").getValue();if(this.calendarManager){var r=this.calendarManager.getModelById(t.calendarId);r&&r.setName(n)}t.suspendEvents(!0),t.suspendCacheUpdate++,t.name=n,t.setParent(i?Gnt.data.Calendar.getCalendar(i):null),t.proxy.extraParams&&(t.proxy.extraParams.calendarId=t.calendarId),Gnt.util.Data.applyCloneChanges(this.dayOverridesCalendar,t);var a=[],s=[],o={};this.weekOverridesStore.each(function(t){Ext.Array.each(t.get("weekAvailability").concat(t.get("mainDay")),function(t){t&&(t.__COPYOF__&&(o[t.__COPYOF__]=!0),e.applySingleDay(t,a))})}),t.forEachNonStandardWeek(function(e){Ext.Array.each(e.weekAvailability.concat(e.mainDay),function(e){e&&!o[e.getId()]&&s.push(e)})}),t.add(a),t.remove(s),t.suspendCacheUpdate--,t.clearCache(),t.resumeEvents(),this.fireEvent("calendarset",t)},hasChanges:function(){if(!this.calendar)return!1;var e=this.dayOverridesCalendar.getModifiedRecords().length||this.dayOverridesCalendar.getRemovedRecords().length,t=this.weekOverridesStore.getModifiedRecords().length||this.weekOverridesStore.getRemovedRecords().length,i=this.down("#calendarName").getValue()!=this.calendar.name,n=this.calendar.parent&&this.calendar.parent.calendarId||-1,r=this.cmbParentCalendar.getValue()!=n;return e||t||i||r}}),Ext.define("Gnt.widget.calendar.CalendarManager",{extend:Ext.panel.Panel,mixins:[Gnt.mixin.Localizable],alias:"widget.calendarmanager",treePanelConfig:null,treePanel:null,calendarPanelConfig:null,calendarManager:null,calendarPanel:null,layout:"border",width:800,height:600,initComponent:function(){var e=this;e.cls=e.cls+" gnt-calendarmanager",e.treePanel=e.buildTreePanel(),e.calendarPanel=new Gnt.widget.calendar.Calendar(Ext.apply({region:"center",calendar:e.calendar,split:!0,calendarManager:e.calendarManager},this.calendarPanelConfig)),e.items=[this.treePanel,this.calendarPanel],this.callParent(arguments),this.contextMenu=this.buildContextMenu();var t=e.calendarManager;this.setCalendar(e.calendar||t.getProjectCalendar()||t.getRoot().firstChild),this.counter=1},buildTreePanel:function(){var e=this;return new Ext.tree.Panel(Ext.apply({split:!0,region:"west",width:200,store:e.calendarManager,displayField:e.calendarManager.model.prototype.nameField,rootVisible:!1,tbar:[{itemId:"btnAdd",text:e.L("addText"),action:"add",iconCls:"gnt-action-add",handler:e.doAddRootNode,scope:e},{itemId:"btnRemove",text:e.L("removeText"),action:"remove",iconCls:"gnt-action-remove",handler:e.doRemoveCalendar,scope:e}],viewConfig:{plugins:{ptype:"treeviewdragdrop",allowContainerDrops:!0,dropZone:{onNodeDrop:function(e){return this.valid=!0,this.currentPosition="append",this.overRecord=this.view.getRecord(e),this.self.prototype.onNodeDrop.apply(this,arguments)}}},getRowClass:function(t){if(e.calendarManager.getProjectCalendar()==t.calendar)return"gnt-pms-calendar-row"},listeners:{drop:e.onDrop,scope:e}},listeners:{containercontextmenu:e.onContainerContextMenu,itemcontextmenu:e.onItemContextMenu,selectionchange:e.onSelectionChange,scope:e}},e.treePanelConfig))},buildContextMenu:function(){return new Ext.menu.Menu({margin:"0 0 10 0",items:[{text:this.L("add_node"),handler:this.doAddRootNode,itemId:"add-node",scope:this},{text:this.L("add_child"),handler:this.doAddChildNode,scope:this},{text:this.L("add_sibling"),handler:this.doAddSiblingCalendar,scope:this},{text:this.L("remove"),handler:this.doRemoveCalendar,scope:this}]})},showContextMenu:function(e,t){var i=this.contextMenu.query("menuitem");t?(Ext.Array.each(i,function(e){e.show()}),this.contextMenu.down("#add-node").hide()):(Ext.Array.each(i,function(e){e.hide()}),this.contextMenu.down("#add-node").show()),e.stopEvent(),this.contextMenu.showAt(e.getXY())},onContainerContextMenu:function(e,t){this.showContextMenu(t)},onItemContextMenu:function(e,t,i,n,r){this.showContextMenu(r,t)},hasChanges:function(){return this.calendarPanel.hasChanges()},onSelectionChange:function(e,t,i){var n=this,r=n.calendarManager,a=n.calendarPanel;if(t.length>0){var s=t[0];a.calendar&&a.hasChanges()?Ext.Msg.show({title:n.L("confirm_action"),msg:n.L("confirm_message"),buttons:Ext.Msg.YESNOCANCEL,icon:Ext.Msg.QUESTION,fn:function(t){"yes"==t?(n.applyChanges(),a.setCalendar(s.getCalendar())):"no"==t?a.setCalendar(s.getCalendar()):(e.suspendEvents(),e.select(r.getNodeByCalendar(a.calendar)),e.resumeEvents())}}):a.setCalendar(s.getCalendar())}},onDrop:function(e,t,i,n){i=i||this.calendarManager.getRootNode(),i.expand()},onDestroy:function(){this.contextMenu.destroy(),this.callParent(arguments)},applyChanges:function(){this.calendarPanel.applyChanges()},doAddRootNode:function(){this.addCalendar()},doAddChildNode:function(){var e=this.treePanel.getSelectionModel().getSelection();this.addCalendar(e[0])},doAddSiblingCalendar:function(){var e=this.treePanel.getSelectionModel().getSelection();this.addCalendar(e[0]&&e[0].parentNode)},doRemoveCalendar:function(){var e=this.treePanel.getSelectionModel().getSelection();this.removeCalendar(e[0])},addCalendar:function(e){var t=Ext.ClassManager.get(this.calendarManager.calendarClass).prototype,i=this.calendarManager.model.prototype,n=i.getModelConfig(t);n[i.nameField]=this.L("calendarName")+this.counter++,n.expanded=!0,n.leaf=!0,e=e||this.treePanel.getRootNode(),e.data.expanded=!0,e.appendChild(n)},removeCalendar:function(e){var t=this.treePanel.getRootNode();if(e){var i=e.nextSibling||e.previousSibling||(e.parentNode==t?t.firstChild:e.parentNode);i&&this.treePanel.getSelectionModel().select(i),e.remove()}},setCalendar:function(e){e instanceof Gnt.model.Calendar?(this.treePanel.setSelection(e),this.calendarPanel.setCalendar(e.getCalendar())):(this.treePanel.setSelection(this.calendarManager.getNodeByCalendar(e)),this.calendarPanel.setCalendar(e))}}),Ext.define("Gnt.widget.calendar.CalendarManagerWindow",{extend:Ext.window.Window,mixins:[Gnt.mixin.Localizable],alias:"widget.calendarmanagerwindow",width:850,height:600,layout:"fit",border:!1,calendarConfig:null,calendarManager:null,panel:null,initComponent:function(){this.panel=new Gnt.widget.calendar.CalendarManager({calendarManager:this.calendarManager,calendarConfig:this.calendarConfig}),Ext.apply(this,{title:this.title||this.L("title"),items:[this.panel],buttons:[{text:this.L("ok"),handler:function(){this.applyChanges()},scope:this},{text:this.L("cancel"),handler:function(){this.close()},scope:this}],listeners:{beforeclose:this.onBeforeClose,close:this.onAfterClose}}),this.callParent(arguments)},applyChanges:function(){this.panel.applyChanges()},onBeforeClose:function(){var e=this,t=this.panel;if(!e.closing&&t.hasChanges())return Ext.Msg.show({title:e.L("confirm_action"),msg:e.L("confirm_message"),buttons:Ext.Msg.YESNOCANCEL,icon:Ext.Msg.QUESTION,fn:function(i){switch(i){case"yes":t.applyChanges(),e.close();break;case"no":e.closing=!0,e.close()}}}),!1},onAfterClose:function(){this.closing=!1}}),Ext.define("Gnt.widget.calendar.CalendarWindow",{extend:Ext.window.Window,mixins:[Gnt.mixin.Localizable],alias:"widget.calendarwindow",calendarConfig:null,calendar:null,calendarWidget:null,initComponent:function(){Ext.apply(this,{width:600,layout:"fit",items:this.calendarWidget=new Gnt.widget.calendar.Calendar(Ext.apply({calendar:this.calendar},this.calendarConfig)),buttons:[{text:this.L("ok"),handler:function(){this.applyChanges(),this.close()},scope:this},{text:this.L("cancel"),handler:this.close,scope:this}]}),this.callParent(arguments)},applyChanges:function(){this.calendarWidget.applyChanges()},setCalendar:function(e){this.calendarWidget.setCalendar(e)}}),Ext.define("Gnt.widget.calendar.ResourceCalendarGrid",{extend:Ext.grid.Panel,mixins:[Gnt.mixin.Localizable],alias:"widget.resourcecalendargrid",resourceStore:null,calendarStore:null,cellEditingConfig:null,initComponent:function(){var e=this;this.calendarStore=this.calendarStore||{xclass:"Ext.data.Store",model:"Gnt.model.Calendar"},this.calendarStore instanceof Ext.data.Store||(this.calendarStore=Ext.create(this.calendarStore));var t=Ext.create("Ext.grid.plugin.CellEditing",Ext.apply({clicksToEdit:2},this.cellEditingConfig));this.mon(t,{edit:function(e,t){this.onCalendarChange(t.record,t.value)},scope:this}),Ext.apply(e,{store:e.resourceStore,columns:[{header:this.L("name"),dataIndex:"Name",flex:1},{header:this.L("calendar"),flex:1,renderer:function(t,i,n){var r=n.getCalendar(),a=e.calendarStore.getModelById?"getModelById":"getById",s=e.calendarStore[a](r&&r.calendarId);return s&&s.getName()||t},editor:{xtype:"combobox",store:e.calendarStore,queryMode:"local",displayField:"Name",valueField:"Id",editable:!1,allowBlank:!1}}],border:!0,height:180,plugins:t}),this.calendarStore.loadData(this.getCalendarData()),this.callParent(arguments)},getCalendarData:function(){return Ext.Array.map(Gnt.data.Calendar.getAllCalendars(),function(e){return{Id:e.calendarId,Name:e.name||e.calendarId}})},onCalendarChange:function(e,t){e.setCalendarId(t)}}),Ext.data.Connection.override({parseStatus:function(e){var t=this.callOverridden(arguments);return 0===e&&(t.success=!0),t}}),function(){var e={eventChain:[],init:function(){document.addEventListener&&this.initEventRecording(),this.initErrorLogging()},setupAnalytics:function(){window._gaq=window._gaq||[],window._gaq.push(["_setAccount","UA-11046863-1"]),window._gaq.push(["_setDomainName","none"]),window._gaq.push(["_setAllowLinker",!0]),window._gaq.push(["_trackPageview"]);var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js"},initEventRecording:function(){var e=["-focus$","-over$","-selected$","-active$","x-body","x-box-item","x-btn-wrap","x-component","x-datepicker-cell","x-fit-item","x-form-field","x-form-empty-field","x-form-required-field","x-grid-cell-inner","x-grid-view","x-grid-row-focused","x-grid-resize-marker","x-layout","x-menu-item-link","x-noicon","x-resizable-overlay","x-tab-noicon","x-tab-default-noicon","x-tab-default","x-tree-icon","x-trigger-index-","x-unselectable","sch-gantt-terminal$","sch-gantt-task-handle$","sch-gantt-item","sch-resizable-handle$","null","undefined"],t=new RegExp(e.join("|")),i=function(e){if(!e)return"";var n="",r=Ext.String.trim(e.className||"");return e.id?"#"+e.id:(r&&r.split(" ").forEach(function(e){e&&!t.test(e)&&(n+="."+e)}),i(e.parentNode&&e.parentNode!==document.body&&e.parentNode)+" "+n)},n=this,r=function(e){try{e=e||window.event;var t=e.target;if(t&&3==t.nodeType&&(t=t.parentNode),!t)return;var r="contextmenu"==e.type||3==e.which||2==e.button?"rightclick":e.type,a={desc:r+' "'+i(t)+'"'};a[r]=[e.pageX,e.pageY],n.eventChain.push(a)}catch(e){n.eventChain.push({error:e.name,message:e.message||e.description,stack:e.stack})}};document.addEventListener("click",r,!0),document.addEventListener("dblclick",r,!0),document.addEventListener("contextmenu",r,!0)},initErrorLogging:function(){var e=this,t=window,i=document;t.onerror=function(n,r,a,s,o){if(!(!n||n.match("chrome://")||n.match("Script error")||r&&(r.match("localhost")||r.match("fiesta")))&&!t.__reported&&n&&(a||r)){t.__reported=!0;try{var l=t.innerWidth||i.documentElement.clientWidth||i.body.clientWidth,d=t.innerHeight||i.documentElement.clientHeight||i.body.clientHeight,c="";e.eventChain.length&&l&&d&&(c+="t.setWindowSize("+l+", "+d+");"),Ext.JSON&&(c+="t.chain("+Ext.JSON.encode(e.eventChain).replace(/^\[|\]$/g,"")+");");var h={msg:n,url:r,line:a,href:t.location.href,windowWidth:l,windowHeight:d,extVersion:Ext.versions&&Ext.versions.extjs&&Ext.versions.extjs.version,prodVersion:Sch.VERSION||"-",localDate:(new Date).toString(),browser:Ext.ieVersion&&"IE"+Ext.ieVersion||Ext.chromeVersion&&"Chrome"+Ext.chromeVersion||Ext.firefoxVersion&&"FF"+Ext.firefoxVersion||Ext.safariVersion&&"Safari"+Ext.safariVersion||Ext.operaVersion&&"Opera"+Ext.operaVersion||navigator.userAgent,column:s||"",stack:o&&o.stack||"",chain:c},u="";Ext.Object.each(h,function(e,t){u+=e+"="+encodeURIComponent(t)+"&"})}catch(e){}}},t.onbeforeunload=function(){t.onerror=null}}};Ext.onReady(e.init,e)}();