!function(){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var e=function(e,t,s){return t&&a(e.prototype,t),s&&a(e,s),e};function a(e,t){for(var s=0;s<t.length;s++){var a=t[s];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function t(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e){i(this,r),$.extend(this,o,e),e.className&&(this.className=$.extend({},o.className,e.className)),e.message&&(this.message=$.extend({},o.message,e.message))}var n,o={readonly:!1,key:"state",name:"board",message:{loading:"loading ...",stateDisabled:"Current issue cannot switch to this state",allComplete:"Showing all issues",empty:"There are no issues here",btnSetFirst:"Move it to the first",btnSetLast:"Move it to the last"},className:{iconComment:"icon comments outline",iconAngleLeft:"icon angle double left",iconAngleRight:"icon angle double right",iconIssue:"note outline",card:"ui link card",action:"ui button",actions:"ui mini basic icon buttons",avatar:"ui avatar image"},actions:function(r){return r.plugins.Sortable?[{id:"btn-set-first",class:r.className.action,icon:r.className.iconAngleLeft,title:r.message.btnSetFirst,callback:function(e,t){var s=t.state.toString(),a=e.sortable.toArray(),i=a.indexOf(s);0<=i&&(a.splice(i,1),a.splice(0,0,s),e.sortable.sort(a),r.onSorted(a),e.load())}},{id:"btn-set-last",class:r.className.action,icon:r.className.iconAngleRight,title:r.message.btnSetLast,callback:function(e,t){var s=t.state.toString(),a=e.sortable.toArray(),i=a.indexOf(s);0<=i&&(a.splice(i,1),a.push(s),e.sortable.sort(a),r.onSorted(a),e.load())}}]:[]},data:[{order:1,name:"Backlog",state:"open",color:"#ffa726",issuesCount:0},{order:2,name:"Done",state:"closed",color:"#2baf2b",issuesCount:0}],plugins:{},types:[],user:{id:0,admin:!1},onLoad:function(e,t){$.ajax({url:"issues",data:{state:e.state,page:e.page}}).done(function(){t([],0)}).fail(function(){t([],0)})},onUpdate:function(e,t){var s=this;$.ajax({type:"PUT",url:e.url,data:{state:e.state}}).done(function(e){s.updateIssue(e)}).fail(function(){s.setIssueState(e.id,t)})},onRender:function(e,t){return t.addClass("issue-state-"+e.state),t},onSorted:function(e){window.console.log(e)}},l=(n=$("<div/>"),function(e){return n.text(e).html()}),d=(e(c,[{key:"getAvatarUrl",value:function(e,t){var s=this.config.plugins.LetterAvatar;return t&&0!==t.indexOf("no_portrait.png")||!s?t:s(e)}},{key:"getCardId",value:function(e){return this.config.getIusseId?this.config.getIusseId(e):"issue-card-"+e.id}}]),c);function c(e){i(this,c),this.config=e}var u=(t(h,d),e(h,[{key:"render",value:function(e){var t=this.config.user,s=this.config.readonly,a="",i=this.config.className.card;s||!t.admin&&t.id!==e.author.id||(a='draggable="true"',i+=" card-draggable");var r="#464a4b";0<e.base_status_id&&(r="#"+this.config.paramConfig.status_config[e.base_status_id].color);var n=Strack.calculation_progress_bar(Strack.translate_timespinner_val(e[this.config.paramConfig.formula_config.estimate_working_hours.field]),Strack.translate_timespinner_val(e.base_plan_duration),Strack.translate_timespinner_val(e[this.config.paramConfig.formula_config.actual_time_consuming.field])),o="#e1e1e1";e.base_end_time&&(o=this.config.paramConfig.time_config.current_time<e.base_end_time?e.base_end_time<this.config.paramConfig.time_config.urgent_time?"#faad14":"#1890ff":"#f5222d");var l="grid_kanban_tg_"+Math.floor(1e4*Math.random()+1),d={};d=this.config.paramConfig.timelog_config.active_timelog&&this.config.paramConfig.timelog_config.active_timelog[e.id]?{id:this.config.paramConfig.timelog_config.active_timelog[e.id],color:"red"}:{id:0,color:"green"};var c=Strack.generate_kanban_timelog_bnt({user_id:this.config.paramConfig.timelog_config.my_user_id,random_id:l,item_id:e.id,timelog:d,module_id:this.config.gridParam.grid_param.module_id},e[this.config.paramConfig.formula_config.assignee_field.field]);return['<li class="',i,'" ',a,'id="',this.config.name,"-issue-",e.id,'" data-id="',e.id,'">','<div class="kanban-card-title" style="overflow: hidden">','<div class="aign-left"><div class="kanban-card-status" style="background-color: '+r+'"></div></div>','<div class="issue-name aign-left">'+e.title+"</div>",'<div class="issue-assignee aign-left">',"<div>分派人："+Strack.generate_grid_user(e[this.config.paramConfig.formula_config.reviewed_by.field])+"</div>","<div>执行人："+Strack.generate_grid_user(e[this.config.paramConfig.formula_config.assignee_field.field])+"</div>","</div>","</div>",'<div class="kanban-card-bnt" style="overflow: hidden">','<div class="aign-left">',c,"</div>",'<div class="kanban-card-end aign-right">','<div class="card-end-time" style="background-color: '+o+'">'+e.base_end_time+"</div>","</div>","</div>",'<div class="kanban-card-time">','<div class="" style="overflow: hidden;margin-bottom: 5px;">','<div class="card-item aign-left">预估工时</div>','<div class="card-progress aign-left">','<div class="card-progress-est color-progress-est" style="width: calc('+n.est_progress.per+' - 22px);" title="预估工时：'+n.est_progress.show_val+'">'+n.est_progress.show_val+"</div>","</div>","</div>",'<div class="card-item aign-left">实际/计划工时</div>','<div class="card-progress aign-left">','<div class="card-progress-plan" style="width: calc('+n.actual_plan_progress.per+' - 10px)">','<div class="progress-item color-progress-plan aign-left" style="width: calc('+n.actual_plan_progress.left.per+");padding-left: "+n.actual_plan_progress.left.padding+'" title="实际工时：'+n.actual_plan_progress.left.show_val+'">'+n.actual_plan_progress.left.show_val+"</div>",'<div class="progress-pre" style="left: calc('+n.actual_plan_progress.left.per+');">',n.actual_plan_progress.left.show_per,"</div>",'<div class="progress-item color-progress-'+n.actual_plan_progress.right.css_name+' aign-left" style="width: calc('+n.actual_plan_progress.right.per+");padding-right: "+n.actual_plan_progress.right.padding+'" title="'+n.actual_plan_progress.right.over_name+"："+n.actual_plan_progress.right.show_val+'">'+n.actual_plan_progress.right.show_val+"</div>","</div>","</div>","</div>","</li>"].join("")}},{key:"renderState",value:function(e){var t=e.state_data;return t&&"state"!==this.config.key?['<div class="state">','<i title="',t.name,'" class="',t.icon,'"','style="color: ',t.color,'"></i>',"</div>"].join(""):""}},{key:"renderAssignee",value:function(e){var t,s=e.assignee;return s&&s.id&&"state"===this.config.key?['<div class="assignee">','<a target="_blank" href="',(t=s).html_url||t.path,'" title="',l(s.name),'">','<img src="',this.getAvatarUrl(s.name,s.avatar_url),'" alt="',l(s.name),'" class="',this.config.className.avatar,'">',"</a>","</div>"].join(""):""}},{key:"renderComments",value:function(e){var t=this.config.className.iconComment;return e.comments?'<span class="card-comments"><i class="'+t+'"></i>'+e.comments+"</span>":""}}]),h);function h(){return i(this,h),s(this,(h.__proto__||Object.getPrototypeOf(h)).apply(this,arguments))}var f=(t(g,d),e(g,[{key:"render",value:function(e){return['<div class="board" data-state="',e.state,'">','<div class="board-inner">',this.renderHeader(e),'<div class="board-list-wrapper">','<ul class="board-list"></ul>','<div class="ui inverted dimmer">','<div class="ui loader"></div>',"</div>",'<div class="board-blur-message">','<p><i class="icon ban"></i></p>',"<p>",this.config.message.stateDisabled,"</p>","</div>",'</div><a href="javascript:;" class="board-list-bottom" data-state="',e.state,'"><span><i class="icon-uniE672"></i></span><span>添加任务</span></a>',"</div>","</div>"].join("")}},{key:"renderHeader",value:function(e){var t,s,a,i,r,n="",o="board-header";return e.color&&(n="background"===e.colorTarget?"background-color: "+(t=e.color,s=.04,a=/^#([\da-fA-F]{2})([\da-fA-F]{2})([\da-fA-F]{2})$/.exec(t),"rgba("+parseInt(a[1],16)+","+parseInt(a[2],16)+","+parseInt(a[3],16)+","+s+")"):(o+=" has-border","border-color: "+e.color)),['<div class="',o,'" style="',n,'">','<h3 class="board-title">',this.renderActions(),'<div class="right floated issues-count-badge">','<i class="',this.config.className.iconIssue,'" />','<span class="issues-count">',e.issuesCount,"</span>","</div>",this.renderAvatar(e),(r="",(i=e).color&&(r='style="color: '+i.color+'"'),i.icon?'<i class="iconfont '+i.icon+'" '+r+"></i>":""),l(e.name),"</h3>","</div>"].join("")}},{key:"renderActions",value:function(){var e=this.config,t=e.actions;return"function"==typeof t&&(t=t(e)),['<div class="right floated board-actions ',e.className.actions,'">',t.map(function(e){return['<button type="button" class="board-action ',e.class,'" title="',e.title,'" data-id="',e.id,'">','<i class="',e.icon,'" />',"</button>"].join("")}).join(""),"</div>"].join("")}},{key:"renderAvatar",value:function(e){return e.avatarUrl?['<img class="',this.config.className.avatar,' board-avatar" alt="',e.state,'" src="',this.getAvatarUrl(e.name,e.avatarUrl),'">'].join(""):""}},{key:"renderTip",value:function(e){var t=this.config.message;return e.loadable?['<li class="board-tip">','<span class="ui active mini inline loader" /> ',t.loading,"</li>"].join(""):e.completed&&0<e.issues.length?['<li class="board-tip">',t.allComplete,"</li>"].join(""):['<li class="board-tip">',t.empty,"</li>"].join("")}}]),g);function g(){return i(this,g),s(this,(g.__proto__||Object.getPrototypeOf(g)).apply(this,arguments))}var p=(e(v,[{key:"add",value:function(e){this.issues.push(e),this.issuesCount+=1,this.$issuesCount.text(this.issuesCount)}},{key:"find",value:function(e){for(var t=0;t<this.issues.length;++t)if(this.issues[t].id===e)return t;return-1}},{key:"get",value:function(e){var t=this.find(e);return 0<=t?this.issues[t]:null}},{key:"remove",value:function(e){var t=this.find(e);return 0<=t?(--this.issuesCount,this.$issuesCount.text(this.issuesCount),this.issues.splice(t,1)):null}},{key:"clear",value:function(){this.page=0,this.issues=[],this.issuesCount=0,this.loading=!1,this.loadable=!0,this.completed=!1,this.$issuesCount.text(0),this.$issues.empty(),this.$tip=null}},{key:"autoload",value:function(){this.completed||(!this.$tip||this.$tip.position().top<this.$issues.height())&&this.load()}},{key:"load",value:function(){return!this.loading&&(this.page+=1,this.loading=!0,1===this.page&&this.$dimmer.addClass("active"),this.config.onLoad(this,this.onLoadDone.bind(this)),!0)}},{key:"onLoadDone",value:function(e,t){this.issuesCount=t,this.$issuesCount.text(this.issuesCount),this.appendIssues(e),!(0<this.issuesCount)||e.length<1||this.issuesCount===e.length?(this.loadable=!1,this.completed=!0):(this.loadable=!0,this.completed=!1),1===this.page&&this.$dimmer.removeClass("active"),this.loading=!1,this.updateTip(),this.autoload()}},{key:"firstload",value:function(){return!(0<this.page)&&this.load()}},{key:"updateTip",value:function(){this.$tip&&this.$tip.remove(),this.$tip=$(this.renderer.renderTip(this)),this.$issues.append(this.$tip)}},{key:"createCard",value:function(s){var e=$(this.cardRenderer.render(s)),a=this.config.onSelect;return a&&e.on("click",function(e){var t=$(e.target);t.is("a")||(t=t.parent()),!t.parent().hasClass("card-header")&&t.is("a")&&t.attr("href")||a(s,e)}),this.config.onRender(s,e,this.config)}},{key:"appendIssue",value:function(e){this.issues.push(e),this.$issues.append(this.createCard(e))}},{key:"prependIssue",value:function(e){this.issuesCount+=1,this.issues.splice(0,0,e),this.$issues.prepend(this.createCard(e)),this.$issuesCount.text(this.issuesCount)}},{key:"updateIssue",value:function(e){var t=$("#"+this.config.name+"-issue-"+e.id);t.length<1?this.prependIssue(e):t.before(this.createCard(e)).remove()}},{key:"appendIssues",value:function(e){var s=this;e.filter(function(t){return s.issues.every(function(e){return e.id!==t.id})}).forEach(function(e){e[s.config.Key]=s.state,s.appendIssue(e)})}},{key:"clickAddIssue",value:function(e){var t=this.config.gridParam.grid_param,s={};switch(this.config.gridParam.group_raw_param.field_type){case"custom":s.field=this.config.gridParam.group_raw_param.module_code+"-"+this.config.gridParam.group_raw_param.field_value_map;break;case"built_in":s.field=this.config.gridParam.group_raw_param.module+"-"+this.config.gridParam.group_raw_param.field_value_map}s.value=e;var a={};a[s.field]=e,Strack.item_operate_dialog(this.config.gridParam.grid_param.module_name,{mode:"create",field_list_type:["edit"],module_id:t.module_id,project_id:t.project_id,page:t.page,schema_page:t.page,type:"add_panel",select_fields:{config:[s],map:a}},function(){$(".datagrid-view-kanban").boards().data("boards").reload(e)})}}]),v);function v(e,t){var s=this;i(this,v),this.page=0,this.loadable=!0,this.loading=!1,this.completed=!1,this.issues=[],this.name=e.name,this.icon=e.icon,this.state=e.state,this.color=e.color,this.colorTarget=e.colorTarget,this.issuesCount=e.issuesCount||0,this.avatarUrl=e.avatarUrl,this.config=t,this.renderer=new f(t),this.cardRenderer=new u(t),this.$tip=null,this.$el=$(this.renderer.render(this)),this.$dimmer=this.$el.find(".ui.dimmer"),this.$issues=this.$el.find(".board-list"),this.$issuesCount=this.$el.find(".issues-count");var a=this;this.$el.find(".board-list-bottom").on("click",function(){var e=$(this).data("state");a.clickAddIssue(e)}),this.$issues.on("scroll",function(){s.autoload()})}var m=(e(b,[{key:"initPlugins",value:function(){this.initSortable()}},{key:"initSortable",value:function(){var r=this,e=r.config.plugins.Sortable;return!!e&&(r.$el.addClass("boards-sortable"),r.sortable=e.create(r.$el[0],{handle:".board-title",dataIdAttr:"data-state",onUpdate:function(){r.config.onSorted(r.sortable.toArray())}}),r.$el.on("click",".board-action",function(t){var e=$(this),s=e.data("id"),a=e.parents(".board").data("state"),i=r.config.actions;"function"==typeof i&&(i=i(r.config)),i.some(function(e){return!(e.id!==s||!e.callback||(e.callback(r,r.boards[a],t),0))})}),!0)}},{key:"bindScroll",value:function(){var e=this,t=null;function s(){t&&clearTimeout(t),t=setTimeout(function(){t=null,e.load()},200)}$(window).on("resize",s),this.$el.on("scroll",s)}},{key:"bindDrag",value:function(){var n=this;n.config.readonly||(n.$el.on("dragstart",".card",function(e){var t=$(this).data("id"),s=n.getIssue(t);s&&n.setFocus(s.type,s.state),n.$selectedIssue=$(this),e.originalEvent.dataTransfer.setData("text/plain",t),e.stopPropagation()}),n.$el.on("dragend",".card",function(){n.clearFocus()}),n.$el.on("drop",".board-list",function(e){if(e.preventDefault(),e.stopPropagation(),n.$hoverIssue&&n.$hoverIssue.removeClass("card-dragover"),!n.$selectedIssue)return!1;if(n.config.readonly)return!1;var t=n.$selectedIssue,s=t.data("id"),a=$(this).parents(".board").data("state"),i=t.parents(".board").data("state"),r=n.$hoverIssue?n.$hoverIssue.data("id"):null;return n.setIssueState(s,a,r,function(e){n.config.onUpdate(e,i,r)}),!0}),n.$el.on("dragover",".board-list",function(e){var t=n.config.key,s=$(e.target);if(n.$selectedIssue){for(e.preventDefault();0<s.length&&!s.hasClass("card");)s=s.parent();if(s.length<1)return n.$hoverIssue&&n.$hoverIssue.removeClass("card-dragover"),void(n.$hoverIssue=null);n.$hoverIssue&&n.$hoverIssue.removeClass("card-dragover"),n.$hoverIssue=s;var a=n.getIssue(s.data("id")),i=n.getIssue(n.$selectedIssue.data("id"));a&&i&&a[t]!==i[t]&&n.$hoverIssue.addClass("card-dragover")}}))}},{key:"clickCardShowSidebar",value:function(){var t=this;t.config.readonly||t.$el.on("click",".card",function(e){t.config.gridParam.grid_param.item_id=$(e.currentTarget).data("id"),Strack.open_datagrid_slider(t.config.gridParam.grid_param)})}},{key:"setFocus",value:function(t,s){var a=this,i=[],r=null;"state"===this.config.key&&(this.config.types.some(function(e){return e.id===t&&(r=e,!0)}),r&&(i=r.states.map(function(e){return e.id.toString()})),Object.keys(this.boards).forEach(function(e){e!==s.toString()&&-1===i.indexOf(e)&&a.boards[e].$el.addClass("board-blur")}))}},{key:"clearFocus",value:function(){var t=this;Object.keys(this.boards).forEach(function(e){t.boards[e].$el.removeClass("board-blur")})}},{key:"getIssueCard",value:function(e){return $("#"+this.config.name+"-issue-"+e)}},{key:"getIssue",value:function(e){var t=this.getIssueCard(e).parents(".board").data("state"),s=this.boards[t];return s?s.get(e):null}},{key:"removeIssue",value:function(e){var t=null,s=this.getIssueCard(e);if(s.length<1)return t;var a=s.parents(".board").data("state");if(a){var i=this.boards[a];i&&(t=i.remove(e))}return s.remove(),t}},{key:"updateIssue",value:function(e){var t=this.boards[e[this.config.key]];return!!t&&(t.updateIssue(e),!0)}},{key:"prependIssue",value:function(e){var t=this.boards[e[this.config.key]];return!!t&&(t.prependIssue(e),!0)}},{key:"setIssueState",value:function(e,t,s,a){var i=this.getIssueCard(e),r=s?this.getIssueCard(s):null;if(i.length<1)return null;var n=this.config.user,o=i.parents(".board").data("state"),l=this.boards[o],d=this.boards[t];if(l.state===t)return null;if(d.exclude&&0<=d.exclude.indexOf(o))return null;var c=l.get(e);return n.admin||c.author.id===n.id?(c[this.config.key]=t,d.add(c),l.remove(c.id),i.hide(256,function(){r?r.before(i):d.$issues.prepend(i),i.show(256,function(){a&&a(c)})}),d.updateTip(),l.updateTip(),l.autoload(),c):null}},{key:"load",value:function(){var a=this,i=0,r=this.$el.offset();return r.width=this.$el.width(),r.height=this.$el.height(),Object.keys(this.boards).forEach(function(e){var t=a.boards[e],s=t.$el.offset();s.top+t.$el.height()>r.top&&s.left+t.$el.width()>r.left&&s.top<r.top+r.height&&s.left<r.left+r.width&&t.firstload()&&(i+=1)}),i}},{key:"resetQueryConfig",value:function(e){var t=JSON.parse(e.filter_data);return this.config.filter_param.filter=t.filter,this}},{key:"reload",value:function(e){if(e)this.boards[e].clear(),this.boards[e].load();else for(var t in this.clearData(),this.boards)this.boards[t].load()}},{key:"setData",value:function(e){var s=this;this.boards={},this.$el.addClass("boards-list").empty(),e.forEach(function(e){var t=new p(e,s.config);s.boards[e.state]=t,s.$el.append(t.$el)})}},{key:"clearData",value:function(){var t=this;Object.keys(this.boards).forEach(function(e){t.boards[e].clear()})}}]),b);function b(e,t){i(this,b);var s=new r(t);this.$el=e,this.config=s,this.boards={},this.gridParam={},this.paramConfig={},this.$hoverIssue=null,this.$selectedIssue=null,this.timerForScrollLoad=null,t.drag_card&&this.bindDrag(),this.bindScroll(),this.initPlugins(),this.clickCardShowSidebar(),this.setData(s.data)}$.fn.boards=function(e){var t=this.data("boards"),s=$.extend({},$.fn.boards.settings,e);return t||(t=new m(this,s),this.data("boards",t),t.load()),this},$.fn.boards.settings=o}();