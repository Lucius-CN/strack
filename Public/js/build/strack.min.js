var Strack={set_cookie:function(e,t,a){Strack.remove_cookie(e);var i=new Date;a<=0&&(a=1),i.setTime(i.getTime()+864e5*a),document.cookie=e+"="+encodeURI(t)+"; expires="+i.toGMTString()+";path=/"},get_cookie:function(e){var t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));return null!=t?decodeURIComponent(t[2]):""},get_query_variable:function(e){for(var t=window.location.search.substring(1).split("&"),a=0;a<t.length;a++){var i=t[a].split("=");if(i[0]==e)return i[1]}return!1},remove_cookie:function(e){var t=new Date;""!==Strack.get_cookie(e)&&(t.setTime(t.getTime()-864e5),document.cookie=e+"=;expires="+t.toGMTString())},is_string:function(e){return"string"==typeof e&&e.constructor==String},deep_copy:function(e){if(!Strack.isObject(e))throw new Error("obj 不是一个对象！");var t=Array.isArray(e)?[]:{};for(var a in e)t[a]=Strack.isObject(e[a])?Strack.deep_copy(e[a]):e[a];return t},isObject:function(e){return("object"==typeof e||"function"==typeof e)&&null!==e},save_storage:function(e,t){sessionStorage.setItem(e,t)},read_storage:function(e){return sessionStorage.getItem(e)},delete_storage:function(e){sessionStorage.removeItem(e)},save_local_storage:function(e,t){localStorage.setItem(e,t)},read_local_storage:function(e){return localStorage.getItem(e)},delete_local_storage:function(e){localStorage.removeItem(e)},clear_all_storage:function(){sessionStorage.clear()},get_page_uuid:function(){var e=$(document.body),t={identity:e.data("identity"),created:e.data("created")};return t.uid=t.identity+"_"+t.created,t.group="message",t},parse_dom:function(e){try{return(new DOMParser).parseFromString(e,"text/xml")}catch(e){alert(e.message)}return null},indexOfArray:function(e,t,a){if(e)for(var i=0,d=e.length;i<d;i++)if(null==a){if(e[i]==t)return i}else if(e[i][t]==a)return i;return-1},getArrayItem:function(e,t,a){var i=Strack.indexOfArray(e,t,a);return-1==i?null:e[i]},css:function(e,t){if(!t||0===t.length)throw new Error('CSS "path" is required !');var a=document.getElementById(e);$(a).append("<link type='text/css' rel='stylesheet' href='"+t+"' />")},js:function(e,t){if(!t||0===t.length)throw new Error('JS "path" is required !');var a=document.getElementById(e);$(a).append("<script type='text/javascript' language='javascript' src='"+t+"'/><\/script>")},html_encode:function(e){return $("<div/>").text(e).html()},html_decode:function(e){return $("<div/>").html(e).text()},get_obj_by_id:function(e){return document.getElementById(e)},array_distinct:function(e,t){for(var a=[],i=e.concat(t),d={},r=0;r<i.length;r++)i[r]in d?d[i[r]]++:d[i[r]]=1;for(x in d)1==d[x]&&a.push(x);return a},array_group:function(e,i){return e.reduce(function(e,t,a){return e[t[i]]=e[t[i]]||[],e[t[i]].push(t),e},{})},get_base_path:function(e){var t=e.split("/");return t.pop(),t.join("/")},trim_spaces:function(e,t){var a=e.replace(/(^\s+)|(\s+$)/g,"");return"g"===t.toLowerCase()&&(a=a.replace(/\s/g,"")),a},string_ucwords:function(e){if(-1==e.indexOf("_"))return e.substring(0,1).toUpperCase()+e.substring(1);var t=e.split("_"),a=[];return t.forEach(function(e){a.push(e.substring(0,1).toUpperCase()+e.substring(1))}),a.join("_")},prefix_integer:function(e,t){return(Array(t).join(0)+e).slice(-t)},time_to_frame:function(e,t){var a=e*(t||Strack.G.FrameRates.film);return Math.round(a)},replace_textarea:function(e){if(e){var t=new RegExp("\r\n","g");e=e.replace(t,"<br>")}return e},revert_textarea:function(e){var t=new RegExp("＜br＞","g"),a=new RegExp("＜p＞","g");return e=(e=e.replace(t,"\r\n")).replace(a," ")},replace_html_tag:function(e){return e=e.replace(/<\/?[^>]*>/g,"")},remove_html_ext:function(e){return e.replace(".html","")},hex_to_rgb:function(e,t){var a=("#"+e).toLowerCase();if(a&&/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/.test(a)){if(4===a.length){for(var i="#",d=1;d<4;d+=1)i+=a.slice(d,d+1).concat(a.slice(d,d+1));a=i}for(var r=[],o=1;o<7;o+=2)r.push(parseInt("0x"+a.slice(o,o+2)));return"RGBA("+r.join(",")+","+t+")"}return a},current_time:function(){return Date.parse(new Date)/1e3},remove_parent:function(e){$(e).parent().remove()},date_format:function(e,t){var a={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};for(var i in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length))),a)new RegExp("("+i+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?a[i]:("00"+a[i]).substr((""+a[i]).length)));return t},MDFormat:function(e){e=new Date(e);var t,a,i,d=(new Date).getFullYear(),r=e.getFullYear(),o=Strack.date_format(e,"yyyy-M-d"),n="",s=[StrackLang.January,StrackLang.February,StrackLang.March,StrackLang.April,StrackLang.May,StrackLang.June,StrackLang.July,StrackLang.August,StrackLang.September,StrackLang.October,StrackLang.November,StrackLang.December],l=new Date,c=new Date,_=new Date;return t=Strack.date_format(l,"yyyy-M-d"),c.setHours(0,0,0,0),c.setDate(c.getDate()-1),a=Strack.date_format(c,"yyyy-M-d"),_.setHours(0,0,0,0),_.setDate(_.getDate()+1),i=Strack.date_format(_,"yyyy-M-d"),t==o?n=StrackLang.Today:a==o?n=StrackLang.Yesterday:i==o?n=StrackLang.Tomorrow:(n=s[e.getMonth()]+" "+e.getDate()+StrackLang.UnitTH,r!=d&&(n="("+r+") "+n)),n},lastMFirst:function(e){var t=new Date,a=t.getFullYear(),i=t.getMonth()+1;return 0==i&&(i=12,--a),i<10&&(i="0"+i),"today"==e?a+"-"+i+"-"+t.getDate():a+"-"+i+"-01"},getLastDay:function(e,t){var a=e,i=t++;12<t&&(i-=12,a++);var d=new Date(a,i,1);return new Date(d.getTime()-864e5).getDate()},lastMonthDate:function(){var e=new Date,t=e.getFullYear(),a=e.getMonth()+1,i=e.getDate(),d=new Array(0,31,28,31,30,31,30,31,31,30,31,30,31);return 1==a?(t=e.getFullYear()-1,a=12):--a,t%4==0&&t%100!=0&&(d[2]=29),d[a]<i&&(i=d[a]),i<10&&(i="0"+i),a<10&&(a="0"+a),t+"-"+a+"-"+i},date_to_unix:function(e){return new Date(e).getTime()},unix_to_date:function(e,t){t=t||"Y-m-d H:i:s";function a(e){return e<10?"0"+e:e}var i=e?new Date(e):new Date,d=i.getFullYear(),r=a(i.getMonth()+1),o=a(i.getDate()),n=a(i.getHours()),s=a(i.getMinutes()),l=a(i.getSeconds());return t.replace(/Y|m|d|H|i|s/gi,function(e){return{Y:d,m:r,d:o,H:n,i:s,s:l}[e]})},getTime2Time:function(e,t){var a=e,i=t;return((a=Date.parse(a)/1e3)-(i=Date.parse(i)/1e3))/86400},generate_hidden_param:function(e){var t,a={};return $(e||"#page_hidden_param").find("input").each(function(){t=$(this).attr("name"),a[t]=$(this).val()}),Strack.G.pageHiddenParam=a},copy_to_clipboard:function(){layer.msg(StrackLang.Copy_Clipboard_SC)},number_add_zero:function(e,t){return(""+e).length<t?(new Array(t+1).join("0")+e).slice(-t):""+e},add_animate_effect:function(e,t,a,i,d,r){$(e).hasClass(t)||($(e).addClass(t),a&&($(i).hide(),$(e).append(r)),window.setTimeout(function(){$(e).removeClass(t)},1e3))},init_lazy_load:function(e,t){$(e).lazyload({container:$(t),event:"scroll",effect:"fadeIn"})},fall_load_data:function(e,d,r,o){$(e).on("scroll",function(){var e=this.scrollTop||this.scrollTop,t=this.scrollHeight||this.scrollHeight,a=this.clientHeight||this.clientHeight;if(o&&o(),e===t-a){d.page_number++;var i=Math.ceil(d.total/d.page_size);d.page_number<=i&&r&&r(d)}})},array_to_json:function(e){var t="";for(var a in e)t+=a+"="+e[a]+"&";return t=t.substring(0,t.length-1)},validate_form:function(e){var o={},n=200;return $("#"+e+" .form-input").each(function(){var e=$(this).attr("id"),t=$(this).attr("wiget-type"),a=$(this).attr("wiget-need"),i=$(this).attr("wiget-field"),d=$(this).attr("wiget-name"),r="";switch(t){case"input":case"textarea":r=$("#"+e).val();break;case"combobox":r=Strack.get_combos_val("#"+e,"combobox","getValue");break;case"combotree":r=Strack.get_combos_val("#"+e,"combotree","getValue");break;case"combobox_s":r=Strack.get_combos_val("#"+e,"combobox","getValues");break;case"switch":r=Strack.get_switch_val("#"+e);break;case"datebox":r=(r=$("#"+e).datebox("getValue"))||"";break;case"json":r=Strack.get_json_editor_val(e)}if("yes"===a&&0===r.length)return n=404,layer.msg(d+" : "+StrackLang.Required_Field,{icon:2,time:1200,anim:6}),!1;o[i]=r}),{status:n,message:"",data:o}},validate_date_format:function(e){var t=!1,a=e.split("-"),i=0,d=0,r=0,o=0,n=0,s=0;if(3==a.length){var l=a[2].split(" ");if(2==l.length){var c=l[1].split(":");i=a[0],d=a[1],r=l[0],o=c[0],n=c[1];var _=!1;if(((s=0)<=o&&o<=23&&0<=n&&n<=59&&0<=s&&s<=59||24==o&&0==n&&0==s)&&(_=!0),_){var m=!1;i%4==0&&(m=!0),((4==d||6==d||9==d||11==d)&&0<=r&&r<=30||2!=d&&0<=r&&r<=31)&&(t=!0),t||(m?2==d&&0<=r&&r<=29&&(t=!0):2==d&&0<=r&&r<=28&&(t=!0))}}}return t},check_email:function(e){return!0!=!new RegExp(/^([a-zA-Z0-9]+[_|\-|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\-|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]$/).test(e)},check_auth_format:function(e){return!(e.length<1||e.indexOf("/")<1)},check_long:function(e,t){return e.length==t},valid_form:function(e,t,a){if(isNaN(e)){var i=e.split(","),d=parseInt(i[0]),r=parseInt(i[1]);return d===r?t.length<d?{status:!1,error_num:-1,message:a+""+StrackLang.Error_Valid_Fixed+" "+d}:{status:!0,error_num:0,message:""}:t.length<d||t.length>r?{status:!1,error_num:-1,message:a+""+StrackLang.Error_Valid_Range+" "+d+"-"+r}:{status:!0,error_num:0,message:""}}switch(e){case 0:return{status:!0,error_num:0,message:""};case 1:return""===t||null===t?{status:!1,error_num:-1,message:a+""+StrackLang.Error_Valid_Empty}:{status:!0,error_num:0,message:""};case 2:return Strack.check_email(t)?{status:!0,error_num:0,message:""}:{status:!1,error_num:-1,message:a+""+StrackLang.Error_Format};case 3:return Strack.check_auth_format(t)?{status:!0,error_num:0,message:""}:{status:!1,error_num:-1,message:a+""+StrackLang.Error_Format};default:return{status:!1,error_num:666,message:StrackLang.Illegal_Operation}}},dialog_dom:function(e){var t,a="",i="",d="",r="";switch(t=e.hidden?e.hidden:[],e.type){case"normal":d+='<div class="st-dialog-main">',r+=Strack.dialog_hide(t),r+=Strack.dialog_form(e.items),i=Strack.dialog_footer(e.footer,"",e.keep_panel),a+=Strack.dialog_build(d,"",r,i);break;case"adv_filter":d+='<div class="st-dialog-datalist pitem-wrap">',r+=Strack.dialog_hide(t),r+='<div id="adv_fdialog" class="adv-filter-main"><div class="dgcb-query-all"><div class="query-all-name aign-left">'+StrackLang.ConditionalLogic+'</div><div class="query-all-input aign-left"><input id="logic_comb"></div><a href="javascript:;" onclick="Strack.add_filter_group(this)" class="query-all-btn aign-left"><i class="icon-uniEA33"></i>'+StrackLang.AddFilterGroup+'</a></div><div id="dg_adv_filter" class="dgcb-query-wrap"></div></div>',i=Strack.dialog_footer(e.footer,"",e.keep_panel),a+=Strack.dialog_build(d,"",r,i);break;case"adv_sort":var o=[{case:106,lang:StrackLang.Sort_First_By,index:"first"},{case:106,lang:StrackLang.Then_By,index:"second"},{case:106,lang:StrackLang.Then_By,index:"third"}];r+=Strack.dialog_hide(t),i=Strack.dialog_footer(e.footer,"",e.keep_panel);var n="";o.forEach(function(e){n+=Strack.dialog_items(e)}),d+='<div class="st-dialog-main">',r+="<div>"+n+"</div>",a+=Strack.dialog_build(d,"",r,i);break;case"relationship_set":r+=Strack.dialog_hide(t),d+='<div class="st-dialog-main">',r+='<div class="st-dg-relate-r"><div class="dg-relate-r-t">'+StrackLang.Related_Module_Title+'</div><div class="dg-relate-r-list"><table class="ui celled striped table"><tbody id="related_module_list" ></tbody></table></div></div>',r+='<div class="st-dg-relate-l"><div class="st-dialog-toolbar"><a href="javascript:;" class="easyui-linkbutton" iconCls="icon-add" plain="true"onclick="Strack.dialog_relationship_item();">'+StrackLang.Add+'</a></div><div id="st_relationship" class="st-dialog-relate"></div></div>',i=Strack.dialog_footer(e.footer,"",e.keep_panel),a+=Strack.dialog_build(d,"",r,i);break;case"download":break;case"avatar":d+='<div class="st-dialog-main">',r+=Strack.dialog_hide(t),r+=Strack.dialog_avatar(e.header_extra,e.footer),a+=Strack.dialog_build(d,"",r,i);break;case"item_operation":d+='<div class="st-dialog-main">',r+=Strack.dialog_hide(t),r+=Strack.dialog_form(e.items),r+='<div class="st-dialog-up"><ul id="st_dialog_item" class="dg-report-list"></ul></div>',i=Strack.dialog_footer(e.footer,"",e.keep_panel),a+=Strack.dialog_build(d,"",r,i);break;case"datagrid":d+='<div class="st-dialog-datalist pitem-wrap">',r+=Strack.dialog_hide(t),r+=Strack.dialog_grid(e.grid),i=Strack.dialog_footer(e.footer,"",e.keep_panel),a+=Strack.dialog_build(d,"",r,i);break;case"add_custom_field":d+='<div class="st-dialog-datalist pitem-wrap">',r+=Strack.dialog_hide(t),r+=Strack.dialog_custom_field(),i=Strack.dialog_footer(e.footer,"",e.keep_panel),a+=Strack.dialog_build(d,"",r,i);break;case"add_entity_task":d+='<div class="st-dialog-entity-task pitem-wrap">',r+=Strack.dialog_hide(t),r+=Strack.dialog_add_entity_task(e.entity_title),i=Strack.dialog_footer(e.footer,"",e.keep_panel),a+=Strack.dialog_build(d,"",r,i)}return a},dialog_build:function(e,t,a,i){var d="";return d+=e,d+=t,d+='<form id="st_dialog_form" style="height: 100%">'+a+"</form>",d+=i,d+="</div>"},dialog_hide:function(e){var t="";return e.forEach(function(e){t+=Strack.dialog_items(e)}),'<div id="st_dialog_form_hide">'+t+"</div>"},dialog_form:function(e){var t="";return e.forEach(function(e){t+=Strack.dialog_base_item(e.lang,e)}),t},dialog_footer:function(e,t,a){var i="<footer>";t&&(i+='<div class="st-dialog-lfooter">'+Strack.dialog_button(0,t)+"</div>");var d="stf-bottom-10";return a&&(d="stf-bottom-25"),i+='<div class="st-dialog-footer '+d+'">'+Strack.dialog_button(0,e)+"</div>",i+=Strack.dialog_footer_keep_dom(a),i+="</footer>"},dialog_footer_keep_dom:function(e){var t="";return e&&(t+='<div class="std-keep-wrap"><div class="std-keep-item"><a href="javascript:;" class="std-ck std-continue-next" onclick="Strack.toggle_dialog_keep(this)" data-type="continue_next"><i class="icon-uniF204"></i></a>'+StrackLang.Keep_And_Continue_To_Next+'</div><div class="std-keep-item"><a href="javascript:;" class="std-ck std-keep-data" onclick="Strack.toggle_dialog_keep(this)" data-type="keep_data"><i class="icon-uniF204"></i></a>'+StrackLang.Keep_The_Current_Content+"</div></div>"),t},toggle_dialog_keep:function(e){var t=$(e).data("type");Strack.do_toggle_dialog_keep(e,t)},do_toggle_dialog_keep:function(e,t){var a=$(e).find("i");a.hasClass("active")?(a.removeClass("icon-uniF205").addClass("icon-uniF204").removeClass("active"),Strack.G.dialogKeepBntStatus[t]="no"):(a.removeClass("icon-uniF204").addClass("icon-uniF205").addClass("active"),Strack.G.dialogKeepBntStatus[t]="yes")},set_dialog_keep_status_bnt:function(e,t){Strack.G.dialogKeepBntStatus=t;var a=$("#"+e).find(".std-continue-next")[0],i=$("#"+e).find(".std-keep-data")[0];"yes"===t.keep_data&&Strack.do_toggle_dialog_keep(i,"keep_data"),"yes"===t.continue_next&&Strack.do_toggle_dialog_keep(a,"continue_next")},dialog_grid:function(e){var t="";return t+='<div id="'+e.wrap_dom+'" class="entity-datalist" style="height: '+e.height+'px ;width: 100%" >',e.toolbar_show&&(t+='<div id="'+e.toolbar_id+'" class="proj_tb tb-padding-grid-small st-buttons-blue" style="overflow: hidden">'+Strack.dialog_grid_toolbar(e.toolbar_dom)+"</div>"),e.top_notice&&(t+='<div class="dg-data-notice text-ellipsis">'+e.top_notice+"</div>"),t+='<table id="'+e.table_dom+'" ></table></div>'},dialog_grid_toolbar:function(e){var t="";return e.forEach(function(e){t+=Strack.toolbar_dom_build(e)}),t},toolbar_dom_build:function(e){var t="";switch(e.type){case"button":t+='<a href="javascript:;" class="easyui-linkbutton" iconCls="'+e.icon+'" plain="true" onclick="'+e.obj+'(this);">'+e.title+"</a>"}return t},dialog_custom_field:function(){var e="";return e+='<div class="stdg-add-field"><div class="stdg-field-left aign-left"><div class="stdg-left-header">'+StrackLang.Field_Type+'</div><div id="stdg_fd_list" class="stdg-left-wrap"></div></div><div class="stdg-field-right aign-left"><div id="stdg_fd_title" class="stdg-right-header">'+StrackLang.Please_One_Field_Type+'</div><div id="stdg_fd_main" class="stdg-right-wrap"></div></div></div>'},dialog_add_entity_task:function(e){var t="",a=Strack.dialog_form([{case:2,id:"Mentity",lang:e,name:"entity_ids",valid:"1"},{case:2,id:"Mstep",lang:StrackLang.Step,name:"step_ids",valid:"1"}]),i=Strack.dialog_form([{case:2,id:"Nup_fields",type:"text",lang:StrackLang.Fields,name:"fields",valid:1,value:""}]);return t+='<div class="stdg-etask-wrap"><div class="stdg-etask-left"><div class="stdg-etask-l-input">'+a+'</div><div id="stdg_etask_list" class="stdg-etask-l-list"><div class="datagrid-empty-no">'+StrackLang.Please_Select_Step+'</div></div></div><div class="stdg-etask-right"><div class="etask-right-null"><div class="datagrid-empty-no">'+StrackLang.Please_Select_Base+'</div></div><div class="etask-right-main"><div class="etask-right-input">'+i+'</div><div class="st-dialog-up"><ul id="st_dialog_item" class="dg-report-list"></ul></div></div></div></div>'},remove_entity_step_task:function(e){var t=$(e).closest(".stdg-etask-l-item"),a=t.attr("id"),i=t.attr("data-stepcode"),d=t.attr("data-stepid"),r=$(e).closest(".etask-l-lists");if(t.remove(),Strack.reset_entity_step_task_data({type:"remove",param:{id:d,code:i},step_code:i,md5_name:a}),0===r.find(".stdg-etask-l-item").length){var o=$(e).data("step");$("#"+o).combobox("unselect",d)}},remove_entity_step_task_group:function(e,t){$("#etask_g_"+t.code).remove(),Strack.check_entity_step_task_list(e)},copy_entity_step_task:function(e){var t=$(e).closest(".stdg-etask-l-item"),a=(t.attr("id"),t.attr("data-stepcode")),i=t.attr("data-stepid"),d={step_id:$(e).data("step"),list_id:$(e).data("list"),combox_id:$(e).data("combox"),edit_id:$(e).data("edit")},r=$(e).data("md5name"),o=Strack.check_item_operate_fields("#"+d.combox_id,"#"+d.edit_id);Strack.G.entityStepTaskAddData.data[a][r]=o.up_data,o.allow_up&&t.after(Strack.entity_step_task_item_dom(d,{id:i,code:a,md5_name:r},"new"))},add_entity_step_task_group:function(e,t,a){var i=Strack.entity_step_task_item_dom(e,t,a),d=$("#"+e.list_id);if(0===d.find(".etask-l-list-g").length&&d.empty(),"new"===a)d.append(Strack.entity_step_task_group_dom(t,i,a));else{var r=$("#etask_g_"+t.step_code);0<r.length?r.find(".etask-l-lists").append(i):d.append(Strack.entity_step_task_group_dom(t,i,a))}},entity_step_task_item_dom:function(e,t,a){var i="",d="new"===a?t.code+"_"+Math.floor(1e4*Math.random()+1):t.code,r="new"===a?t.code:t.step_code;return i+='<div id="'+d+'" class="stdg-etask-l-item" data-stepcode="'+r+'" data-stepid="'+t.id+'"><a href="javascript:;" class="etask-l-item-bnt etask-l-remove" onclick="Strack.remove_entity_step_task(this)" title="'+StrackLang.Delete+'" data-step="'+e.step_id+'"><i class="icon-uniE6DB"></i></a><a href="javascript:;" class="etask-l-item-bnt etask-l-copy" onclick="Strack.copy_entity_step_task(this)" title="'+StrackLang.Copy+'" data-md5name="'+d+'" data-combox="'+e.combox_id+'" data-step="'+e.step_id+'" data-list="'+e.list_id+'" data-edit="'+e.edit_id+'"><i class="icon-uniE92A"></i></a><a href="javascript:;" class="text-ellipsis etask-l-item-name" onclick="Strack.set_entity_step_task(this)" data-combox="'+e.combox_id+'" data-list="'+e.list_id+'" data-edit="'+e.edit_id+'">'+d+"</a></div>",Strack.reset_entity_step_task_data({type:"add",param:t,step_code:r,md5_name:d,mode:a}),i},reset_entity_step_task_data:function(t){if("add"===t.type){if(Strack.G.entityStepTaskAddData.data.hasOwnProperty(t.step_code)||(Strack.G.entityStepTaskAddData.data[t.step_code]={}),"old"!==t.mode)if(t.param.md5_name&&$("#"+t.param.md5_name).hasClass("etask-l-active")){var e=Strack.G.entityStepTaskAddData.data[t.step_code][t.param.md5_name],a=[];e.base.forEach(function(e){0<=$.inArray(e.field,["base-name","base-code"])&&(e.value=t.md5_name),a.push(e)}),e.base=a,Strack.G.entityStepTaskAddData.data[t.step_code][t.md5_name]=e}else Strack.G.entityStepTaskAddData.data[t.step_code][t.md5_name]={base:[{field:"base-name",field_type:"built_in",value:t.md5_name,variable_id:0},{field:"base-code",field_type:"built_in",value:t.md5_name,variable_id:0}]}}else if("remove"===t.type){var i=Strack.G.entityStepTaskAddData.data[t.step_code],d={};for(var r in i)t.md5_name!==r&&(d[r]=i[r]);Strack.G.entityStepTaskAddData.data[t.step_code]=d}},entity_step_task_group_dom:function(e,t,a){var i="",d="new"===a?e.name:e.step_name;return i+='<div id="etask_g_'+("new"===a?e.code:e.step_code)+'" class="etask-l-list-g"><div class="etask-l-list-title text-ellipsis">'+d+'</div><div class="etask-l-lists">'+t+"</div></div>"},set_entity_step_task:function(e){var t=$(e).closest(".stdg-etask-l-item"),a=t.attr("id"),i=t.attr("data-stepcode"),d=$(e).data("list"),r=$(e).data("combox"),o=$(e).data("edit"),n=$("#"+d),s=$("#"+o),l=n.find(".etask-l-active"),c=!0;if(0<l.length){var _=l.attr("id"),m=l.attr("data-stepcode"),u=Strack.check_item_operate_fields("#"+r,"#"+o);c=u.allow_up,Strack.G.entityStepTaskAddData.data[m][_]=u.up_data}else"m_review_task_item"===o&&$("#step_task_details").show(),$(".etask-right-null").hide(),$(".etask-right-main").show();if(c){n.find(".stdg-etask-l-item").removeClass("etask-l-active"),t.addClass("etask-l-active"),l.addClass("form_ok");var g=Strack.G.entityStepTaskAddData.data[i][a],p={};if($.isEmptyObject(g))p["base-name"]=a,p["base-code"]=a;else for(var f in g)g[f].forEach(function(e){p[e.field]=e.value});$(".form-tip").remove(),s.find(".field_edit_item").each(function(){var e=$(this).attr("data-editor"),t=$(this).attr("data-field"),a=$(this).attr("data-multiple");if(p.hasOwnProperty(t))switch(e){case"combobox":"yes"===a?$(this).combobox("setValues",p[t]):$(this).combobox("setValue",p[t]);break;case"datebox":$(this).datebox("setValue",p[t]);break;case"checkbox":"yes"===p[t]?$(this).attr("checked","checked"):$(this).attr("checked","");break;default:$(this).val(p[t])}else switch(e){case"combobox":$(this).combobox("clear");break;case"datebox":$(this).datebox("clear");break;case"checkbox":$(this).attr("checked","");break;default:$(this).val("")}})}else l.removeClass("form_ok")},check_entity_step_task_list:function(e){var t=$("#"+e.list_id);0===t.find(".etask-l-list-g").length&&(t.empty().append('<div class="datagrid-empty-no">'+StrackLang.Please_Select_Step+"</div>"),$(".etask-right-main").hide(),$(".etask-right-null").show())},dialog_avatar:function(e,t){var a="";return a+='<div class="up-avatar"><header id="crop_avatar_js"></header><div class="user-avatar">'+$("#"+e.user_data.dom_id).html()+'</div><div class="user-avatar-wrap"><span class="avatar-w-title"><p>'+e.lang+'</p></span></div></div><div class="crop-avatar-wrap"><div class="crop-avatar-img"></div><div class="crop-avatar-view"><div class="avatar-view-sm1"></div><div class="avatar-view-sm2"></div><div class="avatar-view-sm3"></div></div><div class="crop-avatar-footer"><a href="javascript:;" class="file">'+StrackLang.Select_Image_File+'<input id="img_upload" type="file" name="" id=""></a><div class="user-avatar-button">'+Strack.dialog_button(0,t)+"</div></div></div>"},dialog_button:function(e,t){for(var a="",i=e;i<t.length;i++){switch(t[i].type){case 1:a+='<a href="javascript:;" class="st-dialog-button st-button-base button-dgsub" onclick="obj.'+t[i].obj+'();">';break;case 2:a+='<a href="javascript:;" class="st-dialog-button st-button-base button-dgcel" onclick="obj.'+t[i].obj+'();">';break;case 3:a+='<a href="javascript:;" id="'+t[i].id+'" class="st-dialog-button button-dgcel">';break;case 4:a+='<a href="javascript:;" class="st-dialog-button file">'+StrackLang.Select_Image_File+'<input id="img_up_bnt" type="file" name="">';break;case 5:a+='<a href="javascript:;" class="st-dialog-button st-button-base button-dgsub" onclick="Strack.'+t[i].obj+'(this);">';break;case 6:a+='<input id="'+t[i].obj+'" class="aign-left" name="'+t[i].obj+'" type="file" multiple="true">';break;case 7:a+='<a href="javascript:;" class="st-dialog-button st-button-base stdown-filter project_filter" onclick="Strack.'+t[i].obj+"(this,"+t[i].value[3]+","+t[i].value[0]+","+t[i].value[1]+","+t[i].value[2]+');" data-dtype="'+t[i].value[3]+'" data-height="'+t[i].value[1]+'">'+t[i].title+'<i class="dropdown icon project_filter"></i></a>';break;case 8:a+='<a href="javascript:;" class="st-dialog-button st-button-base button-dgcel" onclick="Strack.'+t[i].obj+'(this);">';break;case 9:a+='<div id="dailog_error" class="dailog-error aign-left" style="width:'+t[i].width+'"><div class="error-icon aign-left icon-left"><i class="icon-uniEA30"></i></div><div class="error-notice aign-left text-ellipsis"></div></div>';break;case 10:a+='<a href="javascript:;" class="st-dialog-button st-button-base button-dgcel" onclick="Strack.'+t[i].obj+'(this);" data-tab="prev">';break;case 11:a+='<a href="javascript:;" class="st-dialog-button st-button-base button-dgsub" onclick="Strack.'+t[i].obj+'(this);" data-tab="next">';break;case 12:a+='<div class="dailog-upexcel aign-left"><input id="'+t[i].obj+'" class="aign-left" name="'+t[i].obj+'" type="file" multiple="true"></div>';break;case 13:a+='<a href="javascript:;" class="st-dialog-button st-button-base button-dgsstop" onclick="obj.'+t[i].obj+'();">';break;case 14:a+='<a href="javascript:;" class="st-dialog-button st-button-base button-dgsstop" onclick="Strack.'+t[i].obj+'();">';break;default:a+='<a href="javascript:;" class="st-dialog-button st-button-base button-dgsub" onclick="obj.'+t[i].obj+'();">'}[7,9].indexOf(t[i].type)<0&&(a+=t[i].title,a+="</a>")}return a},dialog_relationship_item:function(){var e=Math.floor(1e3*Math.random()+1),t=$("#Mmodule_id").val(),a=$("#hide_temp_id").val();return $("#st_relationship").append(Strack.dialog_items({case:108,index:e,module_id:t})),Strack.combobox_widget("#first_"+e,{url:StrackPHP.getRelationshipModuleList,valueField:"id",textField:"name",width:160,value:t,queryParams:{module_id:t,template_id:a,type:"entity",position:"first"}}),Strack.combobox_widget("#second_"+e,{url:StrackPHP.getRelationshipModuleList,valueField:"id",textField:"name",width:160,queryParams:{module_id:t,template_id:a,type:"entity",position:"second"}}),e},dialog_items:function(e){var t=e.case,a="",i="";switch(e.mask&&(i=e.mask),t){case 1:a='<input id="'+e.id+'" class="dialog-widget-val" data-widget="input" type="'+e.type+'" autocomplete="off" data-name="'+e.name+'" data-valid="'+e.valid+'" value="'+e.value+"\" data-inputmask=\"'alias':'"+i+"'\">";break;case 2:a='<input id="'+e.id+'" class="dialog-widget-val" data-widget="widget" data-name="'+e.name+'" data-valid="'+e.valid+'" >';break;case 3:a='<div class="dialog-json-editor"><div id="'+e.id+'" class="dialog-widget-val" data-widget="json" data-name="'+e.name+'" data-valid="'+e.valid+'"></div></div>';break;case 4:a='<div id="'+e.id+'" class="dialog-widget-val" data-widget="datalist" data-name="'+e.name+'" ></div>';break;case 5:a='<div class="template-columns-wrap" ><div class="template-columns-item template-margin" ><div id="template-field" ></div></div><div class="template-columns-item" ><table id="template-columns" ></table></div></div>';break;case 6:a+='<a class="admin-softicon-amd" href="javascript:;" onclick="obj.'+e.name+"("+e.sid+');">',a+='<img class="admin-softicon-md" src="'+StrackPHP.UPLOADS+"/SoftwareIcon/"+e.value+'.jpg">',a+="</a>";break;case 7:a='<textarea id="'+e.id+'" class="dialog-widget-val" data-widget="textarea" data-name="'+e.name+'" data-valid="'+e.valid+'">'+e.value+"</textarea>";break;case 8:a+='<div id="'+e.id+'" data-name="'+e.name+'" data-valid="'+e.valid+'"><div class="'+e.value+'"></div></div>';break;case 9:a+='<div id="queue" class="img_queue"></div>';break;case 10:a+='<div style="" class="st-dialog-tags"><input id="'+e.id+'" class="combo-tags dialog-widget-val" data-widget="tags" data-name="'+e.name+'" placeholder="'+StrackLang.InputTag+'" style="width: calc(100% - 10px); padding: 2px 5px 3px;"></div>';break;case 11:a+='<div id="queue" class="single_queue"></div>';break;case 12:a='<div class="template-columns-wrap" ><div class="template-columns-item" ><input id="h_relationship_search"><table id="h_relationship_src" ></table></div><div class="template-columns-bnt"><a href="javascript:;" class="move-bnt" onclick="Strack.remove_h_relate_set(this)"><i class="icon-uniF100"></i></a><a href="javascript:;" class="move-bnt" onclick="Strack.move_to_h_relation_panel(this)"><i class="icon-uniF101"></i></a></div><div class="template-columns-item" ><table id="h_relationship_dst" ></table></div></div>';break;case 14:a='<div id="dialog_img_list" class="dialog-imgs"></div>';break;case 101:a='<input id="'+e.id+'" class="dialog-widget-val" data-widget="input" type="'+e.type+'" data-name="'+e.name+'"  data-valid="'+e.valid+'" value="'+e.value+'">';break;case 102:a='<div id="'+e.id+'" class="hidden"></div>';break;case 103:a='<div id="dg_comb_list" class="dg-comb-list"></div>';break;case 104:a='<div id="dg_comb_display" class="dg-cb-display"><div class="dgcb-disp-name aign-left">'+StrackLang.Summafield+'</div><div class="dgcb-disp-input aign-left"><input id="Fdgcb_field" ></div><div class="dgcb-cal-name aign-left">'+StrackLang.Calculation+'</div><div class="dgcb-cal-input aign-left"><input id="Fdgcb_cal" ></div></div>';break;case 105:a='<div id="dg_comb_query" class="dg-cb-query"><div class="dgcb-query-all"><div class="query-all-name aign-left">'+StrackLang.ConditionalLogic+'</div><div class="query-all-input aign-left"><input id="logic_comb"></div><a href="javascript:;" onclick="Strack.add_filter_group(this)" class="query-all-btn aign-left"><i class="icon-uniEA33"></i>'+StrackLang.AddFilterGroup+'</a></div><div id="dgcb_qwrap" class="dgcb-query-wrap"></div></div>';break;case 106:a='<div class="st-dialog-items"><div class="st-dialog-name">'+e.lang+'</div><div id="shang_'+e.index+'" class="st-dialog-input" data-name="'+e.index+'" style="overflow: hidden;"><div class="input-left aign-left"><input  id="sort_'+e.index+'" autocomplete="off" type="text"></div><div class="input-right aign-left"><input id="sort_'+e.index+'_func" autocomplete="off" type="text"></div></div></div>';break;case 107:a='<div class="template-columns-wrap" ><div class="template-columns-item template-margin" ><div id="template_field" ></div></div><div class="template-columns-item" ><input id="m_view_id" value="0" type="hidden"/><div class="st-dialog-items"><div class="st-dialog-name">'+StrackLang.Name+'</div><div class="st-dialog-input"><input id="m_view_name" /></div></div><div class="st-dialog-items"><div class="st-dialog-name">'+StrackLang.Public+'</div><div class="st-dialog-input"><input id="m_view_share" /></div></div></div></div>';break;case 108:a='<div class="st-dialog-items"><div class="st-dialog-input" data-name="'+e.index+'" style="overflow: hidden;"><div class="input-left aign-left"><input  id="first_'+e.index+'" autocomplete="off" type="text"></div><div class="input-right aign-left"><input id="second_'+e.index+'" autocomplete="off" type="text"></div><a href="javascript:;" class="a-close-bnt aign-left" onclick="Strack.remove_parent(this)"><i class=" icon-uniE6DB"></i></a></div></div>';break;case 109:a='<div id="dg_status_comb_list" class="dg-comb-list"></div>';break;case 110:a='<div id="dg_express_setting" class="dg-express-setting"><div class="dg-express-list"><div class="exp-list-wrap"></div><a href="javascript:;" class="exp-bnt exp-bnt-orange aign-left" onclick="Strack.add_new_custom_operator_express(this)" data-moduleid="'+e.module_id+'" data-projectid="'+e.project_id+'"><i class="icon-uniEA85"></i></a><a href="javascript:;" class="exp-bnt exp-bnt-blue aign-left" onclick="Strack.add_new_custom_field_express(this)" data-moduleid="'+e.module_id+'" data-projectid="'+e.project_id+'"><i class="icon-uniE680"></i></a></div><div class="dg-express-show"></div></div>';break;default:a="404"}return a},dialog_base_item:function(e,t){var a='<div class="st-dialog-items">',i=0<t.valid.length?"required":"";switch(parseInt(t.case)){case 103:a+='<div class="st-dialog-name '+i+'"><div class="g-comb-name aign-left">'+e+'</div><a href="javascript:;" onclick="Strack.add_cf_comb_item(this)" class="dg-comb-add aign-left"><i class="icon-uniEA33 icon-right"></i></a></div>';break;case 109:a+='<div class="st-dialog-name '+i+'"><div class="g-comb-name aign-left">'+e+'</div><a href="javascript:;" onclick="Strack.add_cf_status_comb_item(this)" class="dg-comb-add aign-left"><i class="icon-uniEA33 icon-right"></i></a></div>';break;default:a+='<div class="st-dialog-name '+i+'">'+e+"</div>"}return a+='<div class="st-dialog-input">'+Strack.dialog_items(t)+"</div></div>"},fill_slider_page_param:function(e){$("#datagrid_slider_action,#grid_slider_af_settlement_bnt,#grid_slider_jj_settlement_bnt,#grid_slider_cf_settlement_bnt").attr("data-moduleid",e.module_id).attr("data-projectid",e.project_id).attr("data-linkid",e.item_id),$("#grid_slider_af_settlement_bnt,#grid_slider_jj_settlement_bnt,#grid_slider_cf_settlement_bnt").removeClass(function(e,t){return(t.match(/(^|\s)settlement_bnt_\S+/g)||[]).join(" ")}),$("#grid_slider_af_settlement_bnt").addClass("settlement_bnt_af_"+e.item_id),$("#grid_slider_jj_settlement_bnt").addClass("settlement_bnt_jj_"+e.item_id),$("#grid_slider_cf_settlement_bnt").addClass("settlement_bnt_cf_"+e.item_id),$("#datagrid_top_fields_config,#datagrid_main_fields_config").attr("data-id",e.item_id).attr("data-page",e.page).attr("data-moduleid",e.module_id).attr("data-modulecode",e.module_code).attr("data-projectid",e.project_id).attr("data-templateid",e.template_id)},open_datagrid_slider:function(e){var t=$("#datagrid_slider");t.show().addClass("grid-slider-in"),$("#datagrid_slider_mask").show(),Strack.fill_slider_page_param(e),Strack.G.gridSliderParam=e,Strack.init_breadcrumb("datagrid_slider_breadcrumb",e),Strack.get_datagrid_slider_thumb(e),Strack.get_datagrid_slider_topinfo(e),e.position="grid_slider",Strack.init_tab_list("grid_slider_tab",e,function(e){var t=null;$.isEmptyObject(Strack.G.gridSliderActiveTab)?e.forEach(function(e){t=t||e}):t=Strack.G.gridSliderActiveTab,Strack.show_datagrid_slider_tab(t)}),t.hasClass("init-active")||(t.addClass("init-active"),Strack.init_grid_resize_envent(t)),setTimeout(function(){t.removeClass("grid-slider-in")},300)},close_datagrid_slider:function(e){var t=$("#datagrid_slider");t.addClass("grid-slider-out"),Strack.G.gridSliderParam={},Strack.remove_task_repeat_editor(),$("body").hasClass("schedule")&&Strack.reload_fullCalendar_data("scheduler_my_index"),setTimeout(function(){t.hide().removeClass("grid-slider-out"),$("#datagrid_slider_mask").hide()},500)},get_datagrid_slider_thumb:function(a){$.ajax({type:"POST",url:StrackPHP.getDetailTopThumb,data:a,dataType:"json",beforeSend:function(){$("#grid_slider_thumb").prepend(Strack.loading_dom("white","","slider_thumb"))},success:function(e){var t=e.data;t.link_id=a.item_id,t.module_id=a.module_id,t.param.icon="icon-uniE61A",Strack.thumb_media_widget("#grid_slider_thumb",t,{modify_thumb:a.rule_side_thumb_modify,clear_thumb:a.rule_side_thumb_clear}),$("#st-load_slider_thumb").remove()}})},get_datagrid_slider_topinfo:function(t){t.category="top_field";var a=$("#grid_slider_tg_bnt"),i=$("#grid_slider_af_settlement_bnt"),d=$("#grid_slider_jj_settlement_bnt"),r=$("#grid_slider_cf_settlement_bnt");a.hide(),i.hide(),d.hide(),r.hide(),Strack.G.sliderTopfieldsRequestParam={id:"#grid_slider_top_info",mask:"top_info",pos:"min",url:StrackPHP.getModuleItemInfo,data:t,loading_type:"white"},Strack.load_info_panel(Strack.G.sliderTopfieldsRequestParam,function(e){a.removeClass(function(e,t){return(t.match(/(^|\s)time_log_bnt_\S+/g)||[]).join(" ")}),a.attr("data-linkid",t.item_id).attr("data-moduleid",t.module_id).addClass("time_log_bnt_"+t.item_id),"base"===t.module_code&&("yes"===e.is_my_task&&(a.show(),Strack.init_timelog_bnt("#grid_slider_tg_bnt",e.timelog)),"yes"===e.af_settlement_bnt&&(i.html(Strack.show_application_for_settlement_lang(e.assignee_id,e.reviewed_id)),i.attr("data-eq",e.assignee_eq_reviewed),i.show()),"yes"===e.jj_settlement_bnt&&(d.attr("data-eq",e.assignee_eq_reviewed),d.show()),"yes"===e.cf_settlement_bnt&&(r.attr("data-eq",e.assignee_eq_reviewed),r.show()))})},reset_my_schedule:function(e){var t=$(e).closest(".my-scheduler-index").attr("id");Strack.reload_fullCalendar_data(t)},show_application_for_settlement_lang:function(e,t){return e===t?StrackLang.Confirmation_For_Settlement:StrackLang.Application_For_Settlement},application_for_settlement:function(t,e){e.stopPropagation(),e.preventDefault();var a={link_id:$(t).attr("data-linkid"),module_id:$(t).attr("data-moduleid"),assignee_eq_reviewed:$(t).attr("data-eq"),type:"apply"};Strack.submit_base_confirmation_data(a,function(e){200===parseInt(e.status)?Strack.Websocket.List.hasOwnProperty("update")||(Strack.refrash_confirmation_bnt_show(t,"apply"),Strack.reset_my_schedule(t)):layer.msg(e.message,{icon:7,time:1200,anim:6})})},reject_for_settlement:function(a,e){e.stopPropagation(),e.preventDefault();var i=$(a).attr("data-linkid"),d=$(a).attr("data-moduleid"),r=$(a).attr("data-eq");Strack.get_media_server(function(t){Strack.open_dialog("dialog",{title:StrackLang.Reasons_For_Refusal,width:440,height:340,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mlink_id",type:"hidden",name:"link_id",valid:1,value:i},{case:101,id:"Mmodule_id",type:"hidden",name:"module_id",valid:1,value:d},{case:101,id:"Massignee_eq_reviewed",type:"hidden",name:"assignee_eq_reviewed",valid:1,value:r},{case:101,id:"Mtype",type:"hidden",name:"type",valid:1,value:"reject"}],items:[{case:7,id:"Mreject_txt",type:"text",lang:StrackLang.Content,name:"reject_txt",valid:0,value:""},{case:11,id:"Mmedia_queue",type:"text",lang:StrackLang.Media_Attachment,name:"media_queue",valid:0,value:""}],footer:[{obj:"choice_media",type:6,title:""},{obj:"submit_reject_for_settlement",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){$("#choice_media").uploadifive({auto:!1,formData:{timestamp:Strack.current_time(),belong_system:StrackPHP.Belong_System,token:t.token,size:"250x140"},multi:!0,queueSizeLimit:0,queueID:"queue",uploadScript:t.upload_url,onUpload:function(e){0==e?layer.msg(StrackLang.Please_Select_File,{icon:2,time:1200,anim:6}):$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},onUploadComplete:function(e,t){var a=JSON.parse(t);200===parseInt(a.status)&&Strack.G.Note_Uploadifive_Imgs.push(a.data)},onQueueComplete:function(){var e={link_id:i,module_id:d,text:$("#Mreject_txt").val(),type:"reject",media_data:{media_server:t,images:Strack.G.Note_Uploadifive_Imgs}};Strack.submit_base_confirmation_data(e,function(e){200===parseInt(e.status)?Strack.dialog_cancel():layer.msg(e.message,{icon:7,time:1200,anim:6})})}})},close:function(){Strack.Websocket.List.hasOwnProperty("update")||(Strack.refrash_confirmation_bnt_show(a,"reject"),Strack.reset_my_schedule(a)),Strack.G.Note_Uploadifive_Imgs=[]}})},function(e){Strack.open_dialog("dialog",{title:StrackLang.Reasons_For_Refusal,width:440,height:340,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mlink_id",type:"hidden",name:"link_id",valid:1,value:i},{case:101,id:"Mmodule_id",type:"hidden",name:"module_id",valid:1,value:d},{case:101,id:"Mtype",type:"hidden",name:"type",valid:1,value:"reject"}],items:[{case:7,id:"Mreject_txt",type:"text",lang:StrackLang.Content,name:"reject_txt",valid:0,value:""}],footer:[{obj:"submit_reject_for_settlement",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){},close:function(){Strack.Websocket.List.hasOwnProperty("update")||(Strack.refrash_confirmation_bnt_show(a,"reject"),Strack.reset_my_schedule(a)),Strack.G.Note_Uploadifive_Imgs=[]}})})},submit_reject_for_settlement:function(){if(0<$(".uploadifive-queue-item").length)$("#choice_media").uploadifive("upload");else{var e={link_id:$("#Mlink_id").val(),module_id:$("#Mmodule_id").val(),text:$("#Mreject_txt").val(),type:"reject"};Strack.submit_base_confirmation_data(e,function(e){200===parseInt(e.status)?Strack.dialog_cancel():layer.msg(e.message,{icon:7,time:1200,anim:6})})}},confirmation_for_settlement:function(t,e){e.stopPropagation(),e.preventDefault();var a={link_id:$(t).attr("data-linkid"),module_id:$(t).attr("data-moduleid"),assignee_eq_reviewed:$(t).attr("data-eq"),type:"confirm",media_data:{}};Strack.submit_base_confirmation_data(a,function(e){200===parseInt(e.status)?Strack.Websocket.List.hasOwnProperty("update")||(Strack.refrash_confirmation_bnt_show(t,"confirm"),Strack.reset_my_schedule(t)):layer.msg(e.message,{icon:7,time:1200,anim:6})})},refrash_confirmation_bnt_show:function(e,t){var a=$(e).attr("data-from"),i=a?$("#"+a+"_slider_af_settlement_bnt"):$("#slider_af_settlement_bnt"),d=a?$("#"+a+"_slider_jj_settlement_bnt"):$("#slider_jj_settlement_bnt"),r=a?$("#"+a+"_slider_cf_settlement_bnt"):$("#slider_cf_settlement_bnt");i.hide(),d.hide(),r.hide(),console.log(r);var o=$(e).closest("#tools_slider_inbox");if(0<o.length){var n="";o.find("#slider_msg_tab_all").hasClass("active")&&(n="all"),o.find("#slider_msg_tab_at_me").hasClass("active")&&(n="at_me"),Strack.load_side_inbox(n)}"reject"===t&&i.show()},submit_base_confirmation_data:function(e,t){$.ajax({type:"POST",url:StrackPHP.updateBaseConfirmationData,data:JSON.stringify(e),dataType:"json",contentType:"application/json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),t(e)}})},show_datagrid_slider_tab:function(e){if(e){Strack.G.gridSliderActiveTab=e,Strack.active_select_tab("grid_slider_tab",e.tab_id),$(".grid-slider-main .pitem-wrap").hide();var t=[],a=Strack.deep_copy(Strack.G.gridSliderParam),i=$("#grid_slider_datagrid_add_bnt"),d=$("#grid_slider_datagrid_related_bnt");switch(i.show(),d.hide(),e.type){case"fixed":if(0<=$.inArray(e.tab_id,["correlation_base","file_commit","file","base"])){switch($("#grid_slider_tab_table").show(),e.tab_id){case"base":t=[{field:"id",field_type:"built_in",editor:"combobox",value:a.item_id,condition:"NEQ",module_code:e.module_code,table:"Base"}];break;case"file":case"file_commit":t=[{field:"module_id",field_type:"built_in",editor:"combobox",value:a.module_id,condition:"EQ",module_code:e.tab_id,table:"File"},{field:"link_id",value:a.item_id,condition:"EQ",module_code:e.tab_id,table:"File"}];break;case"correlation_base":t=[{field:"id",field_type:"built_in",editor:"combobox",value:a.item_id,condition:"NEQ",module_code:a.module_code,table:"Base"},{field:"entity_id",field_type:"built_in",editor:"combobox",value:a.entity_id,condition:"EQ",module_code:a.module_code,table:"Base"}]}Strack.load_grid_slider_grid_data(a,e,t)}else switch($("#grid_slider_tab_"+e.tab_id).show(),e.tab_id){case"note":Strack.grid_slider_note_panel();break;case"info":Strack.grid_slider_info_panel();break;case"history":Strack.grid_slider_history_panel();break;case"onset":Strack.grid_slider_onset_panel();break;case"onset_att":Strack.grid_slider_onset_att_panel()}break;case"entity_child":case"horizontal_relationship":case"be_horizontal_relationship":$("#grid_slider_tab_table").show(),"be_horizontal_relationship"===e.type?i.hide():d.show(),Strack.load_grid_slider_grid_data(a,e,t);break;case"other_page":switch($("#grid_slider_tab_iframe_page").show(),e.tab_id){case"cloud_disk":Strack.grid_slider_cloud_disk_panel()}}}},add_grid_slider_item:function(e){var t=Strack.G.gridSliderActiveTab,a=Strack.deep_copy(Strack.G.gridSliderParam);"fixed"===t.type?Strack.item_operate_dialog(t.name,{mode:"create",field_list_type:["edit"],from_item_id:a.item_id,from_module_id:a.module_id,module_id:t.module_id,project_id:a.project_id,page:a.page,schema_page:"project_"+t.module_code,type:"add_panel",keep_panel:!0},function(){$("#grid_slider_datagrid_box").datagrid("reload")}):Strack.item_operate_dialog(t.name,{mode:"create_related",field_list_type:["edit"],from_item_id:a.item_id,from_module_id:t.module_id,module_id:t.dst_module_id,project_id:a.project_id,horizontal_type:t.horizontal_type,variable_id:t.variable_id,page:a.page,schema_page:"project_"+t.module_code,type:"add_panel",keep_panel:!0},function(){$("#grid_slider_datagrid_box").datagrid("reload")})},related_grid_slider_item:function(e){var t=Strack.G.gridSliderActiveTab,a=Strack.deep_copy(Strack.G.gridSliderParam),i={project_id:a.project_id,grid_id:"grid_slider_datagrid_box",variable_id:t.variable_id,src_module_id:t.module_id,dst_module_id:t.dst_module_id,src_link_id:a.item_id,horizontal_type:t.horizontal_type,link_data:[],from:"toolbar"};Strack.open_h_relationship_dialog(i)},delete_grid_slider_item:function(e){var t,a,i=Strack.G.gridSliderActiveTab,d=Strack.deep_copy(Strack.G.gridSliderParam),r="Delete_"+Strack.string_ucwords(i.module_code)+"_Notice",o=0,n=0;"fixed"===i.type?(t=i.module_id,a=i.module_code):(t=i.dst_module_id,a=i.dst_module_code,o=d.item_id,n=d.module_id),Strack.ajax_grid_delete("grid_slider_datagrid_box","id",StrackLang[r],StrackPHP.deleteGridData,{from_item_id:o,from_module_id:n,lang:i.name,module_code:a,module_id:t,module_type:i.type,page:d.page,project_id:d.project_id,rule_side_thumb_clear:d.rule_side_thumb_clear,rule_side_thumb_modify:d.rule_side_thumb_modify,rule_tab_base:d.rule_tab_base,rule_tab_cloud_disk:d.rule_tab_cloud_disk,rule_tab_correlation_task:d.rule_tab_correlation_task,rule_tab_file:d.rule_tab_file,rule_tab_file_commit:d.rule_tab_file_commit,rule_tab_history:d.rule_tab_history,rule_tab_horizontal_relationship:d.rule_tab_horizontal_relationship,rule_tab_info:d.rule_tab_info,rule_tab_notes:d.rule_tab_notes,rule_tab_onset:d.rule_tab_onset,rule_template_fixed_tab:d.rule_template_fixed_tab,schema_page:"project_"+i.module_code,template_id:d.template_id})},grid_slider_note_panel:function(){var e=Strack.deep_copy(Strack.G.gridSliderParam);e.status="new",e.page_number=1,e.page_size=20,Strack.load_notes({page_id:"#slider_note_list",content_id:".grid-slider-main",avatar_id:"",editor_id:"grid_slider_comments_editor",list_id:"grid_slider_comments_list",tab_id:".grid_slider_tab",details_top_bar:!1,tab_bar_id:""},e)},grid_slider_info_panel:function(){var e=Strack.deep_copy(Strack.G.gridSliderParam);e.category="main_field",Strack.G.sliderMainfieldsRequestParam={id:"#grid_slider_info_main",mask:"main_info",pos:"max",url:StrackPHP.getModuleItemInfo,data:e,loading_type:"white"},Strack.load_info_panel(Strack.G.sliderMainfieldsRequestParam)},get_endpoints_heatly:function(a,i,t){$.ajax({url:i.check_url+"/login/check_status",type:"HEAD",timeout:3e3,success:function(e){console.log("成功：",i.check_url),$.isEmptyObject(i)||Strack.generate_check_cloud_token(i,t,function(e,t){0===parseInt(e.status)?$.ajax({type:"POST",url:StrackPHP.frontendCheckCouldDiskServer,data:JSON.stringify({type:"back",data:e.data,param:a,fast_endpoints:i}),dataType:"json",contentType:"application/json",success:function(e){200===parseInt(e.status)&&$(a.dom_id).empty().append(' <iframe src="'+e.data.url+'" name="cloud_disk_iframe" class="page-iframe-base page-iframe-wh-100"></iframe>'),$("#st-load_slider_iframe_page_load").remove()}}):(console.log(e.message),$("#st-load_slider_iframe_page_load").remove())})},error:function(){console.log("失败：",data.check_url)}})},generate_check_cloud_token:function(e,t,a){$.ajax({type:"POST",url:e.check_url+"/login/generate_check_cloud_token",data:JSON.stringify({login:{login_name:e.login_name,password:e.password},user_data:t}),dataType:"json",contentType:"application/json",success:function(e){a(e,t)}})},check_cloud_disk_endpoints:function(e,a){$.ajax({type:"POST",url:StrackPHP.frontendCheckCouldDiskServer,data:{type:"check"},beforeSend:function(){$(e).prepend(Strack.loading_dom("white","","slider_iframe_page_load"))},success:function(e){for(var t in e.endpoints)Strack.get_endpoints_heatly(a,e.endpoints[t],e.user_data)}})},grid_slider_cloud_disk_panel:function(){var e=Strack.deep_copy(Strack.G.gridSliderParam);Strack.check_cloud_disk_endpoints("#grid_slider_tab_iframe_page",{dom_id:"#grid_slider_tab_iframe_page",type:"task",link_id:e.item_id})},grid_slider_onset_panel:function(){$("#grid_slider_onset_entity_not_exit,#grid_slider_onset_link_not_exit,#grid_slider_onset_info_main").hide(),Strack.get_item_onset_data(Strack.G.gridSliderParam,function(e){200===parseInt(e.status)?"yes"===e.data.has_link_onset?($("#grid_slider_onset_info_main").show(),Strack.grid_slider_load_onset_info(e.data)):($("#grid_slider_onset_link_not_exit").show(),$("#grid_slider_onset_select_module_id").val(e.data.module_id),$("#grid_slider_onset_select_entity_id").val(e.data.entity_id),$("#grid_slider_onset_select_entity_module_id").val(e.data.entity_module_id),Strack.combobox_widget("#grid_slider_onset_select_list",{url:StrackPHP.getProjectOnsetList,valueField:"id",textField:"name",width:300,height:30,queryParams:{project_id:Strack.G.gridSliderParam.project_id}})):$("#grid_slider_onset_entity_not_exit").show()})},grid_slider_onset_att_panel:function(){$("#grid_slider_onset_att_entity_not_exit,#grid_slider_onset_att_link_not_exit,#grid_slider_onset_att_link_main").hide(),Strack.get_item_onset_data(Strack.G.gridSliderParam,function(e){200===parseInt(e.status)?"yes"===e.data.has_link_onset?($("#grid_slider_onset_att_link_main").show(),Strack.grid_slider_load_onset_attachment({module_id:e.data.module_id,onset_id:e.data.onset_id})):($("#grid_slider_onset_att_link_not_exit").show(),$("#grid_slider_onset_att_select_module_id").val(e.data.module_id),$("#grid_slider_onset_att_select_entity_id").val(e.data.entity_id),$("#grid_slider_onset_att_select_entity_module_id").val(e.data.entity_module_id),Strack.combobox_widget("#grid_slider_onset_att_select_list",{url:StrackPHP.getProjectOnsetList,valueField:"id",textField:"name",width:300,height:30,queryParams:{project_id:Strack.G.gridSliderParam.project_id}})):$("#grid_slider_onset_att_entity_not_exit").show()})},add_link_onset:function(e){var t=$(e).attr("data-tab"),a="info"===t?"grid_slider_onset_add_link_onset":"grid_slider_onset_att_add_link_onset",i=Strack.validate_form(a);200===parseInt(i.status)&&$.ajax({type:"POST",url:StrackPHP.addEntityLinkOnset,data:i.data,dataType:"json",beforeSend:function(){$("#grid_slider_tab_onset_att").prepend(Strack.loading_dom("white","","onset_add"))},success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),"info"===t?($("#grid_slider_onset_select_list").combobox("clear"),$("#grid_slider_onset_entity_not_exit,#grid_slider_onset_link_not_exit").hide(),$("#grid_slider_onset_info_main").show(),Strack.grid_slider_load_onset_info(e.data)):($("#grid_slider_onset_att_select_list").combobox("clear"),$("#grid_slider_onset_att_entity_not_exit,#grid_slider_onset_att_link_not_exit").hide(),$("#grid_slider_onset_att_link_main").show(),Strack.grid_slider_load_onset_attachment({module_id:i.data.onset_module_id,onset_id:i.data.onset_id}))):layer.msg(e.message,{icon:7,time:1200,anim:6}),$("#st-load_onset_add").remove()}})},grid_slider_load_onset_info:function(e){var t=Strack.deep_copy(Strack.G.gridSliderParam);t.category="detail_onset_field",t.module_id=e.entity_module_id,t.onset_id=e.onset_id,Strack.load_info_panel({id:"#grid_slider_onset_info",mask:"grid_slider_onset_info",pos:"onset",url:StrackPHP.getOnsetInfoData,data:t,loading_type:"white"},function(e){})},grid_slider_load_onset_attachment:function(e){$("#grid_slider_onset_att_bnt").attr("data-linkid",e.onset_id).attr("data-moduleid",e.module_id),Strack.load_onset_attachment("#grid_slider_onset_att_wrap",{module_id:e.module_id,link_id:e.onset_id})},grid_slider_history_panel:function(){var e=Strack.deep_copy(Strack.G.gridSliderParam);e.status="new",e.page_number=1,e.page_size=30,Strack.grid_slider_history_data(e)},grid_slider_history_data:function(a){$.ajax({type:"POST",url:StrackPHP.getDataGridSliderHistoryData,data:a,beforeSend:function(){$("#grid_slider_tab_history").prepend(Strack.loading_dom("white","","slider_history"))},success:function(e){var t=$("#grid_slider_history");"new"===a.status&&(a.total=e.total,Strack.fall_load_data("#grid_slider_history",a,function(e){a.status="more",Strack.grid_slider_history_data(ids,a)}),t.empty(),$("#st-load_slider_history").remove()),t.append(Strack.grid_slider_history_list_dom(e.rows))}})},load_grid_slider_grid_data:function(t,a,i){$.ajax({type:"POST",url:StrackPHP.getDataGridSliderTableConfig,data:JSON.stringify({tab_param:a,grid_param:t}),dataType:"json",contentType:"application/json",beforeSend:function(){$("#grid_slider_tab_table").prepend(Strack.loading_dom("white","","slider_table"))},success:function(e){200===parseInt(e.status)&&Strack.init_grid_slider_grid_data(t,a,e,i),$("#st-load_slider_table").remove()}})},init_grid_slider_grid_data:function(e,t,a,i){var d=i||[],r=0,o="";switch(t.type){case"horizontal_relationship":r=t.dst_module_id,o=Strack.generate_schema_page(t.dst_module_code);break;default:r=t.module_id,o=Strack.generate_schema_page(t.module_code)}var n={page:"details_"+t.tab_id,schema_page:o,module_id:r,project_id:e.project_id,item_id:e.item_id,grid_id:"grid_slider_datagrid_box",view_type:"grid"},s=Strack.generate_grid_columns_data(n,a),l={filter:{temp_fields:{add:{},cut:{}},group:s.grid.group_name,sort:s.grid.sort_config.sort_query,request:d,filter_input:s.grid.filter_config.filter_input,filter_panel:s.grid.filter_config.filter_panel,filter_advance:s.grid.filter_config.filter_advance},page:n.page,schema_page:n.schema_page,module_id:n.module_id,project_id:e.project_id,item_id:e.item_id,module_code:t.module_code,module_type:t.type,horizontal_type:t.horizontal_type,parent_module_id:e.module_id},c=$("#grid_slider_tab_table");if(c.hasClass("load_active"))_={moduleId:t.module_id,projectId:n.project_id,queryParams:{filter_data:JSON.stringify(l)},panelConfig:{active_filter_id:s.grid.filter_config.filter_id},sortConfig:s.grid.sort_config,sortData:s.grid.sort_config.sort_data,renderNewPage:!0,columnsFieldConfig:s.grid.columnsFieldConfig,frozenColumns:s.grid.frozenColumns,columns:s.grid.columns},$.isEmptyObject(s.grid.group_name)||(_.groupActive=!0,_.groupField=Strack.get_grid_group_field(s.grid.group_name).field,_.groupFormatter=function(e,t){return'<span class="">'+e+"( "+t.length+" )</span>"}),$("#grid_slider_datagrid_box").datagrid("setOptions",_).datagrid("reload");else{c.addClass("load_active");var _={url:StrackPHP.getDetailGridData,height:Strack.panel_height(".grid-slider-tab-table",215),view:scrollview,rowheight:50,differhigh:!1,singleSelect:!1,adaptive:{dom:"#datagrid_slider",min_width:680,exth:215,domresize:1},ctrlSelect:!0,multiSort:!0,DragSelect:!0,moduleId:n.module_id,projectId:n.project_id,queryParams:{filter_data:JSON.stringify(l)},panelConfig:{active_filter_id:s.grid.filter_config.filter_id},sortConfig:s.grid.sort_config,sortData:s.grid.sort_config.sort_data,columnsFieldConfig:s.grid.columnsFieldConfig,frozenColumns:s.grid.frozenColumns,columns:s.grid.columns,toolbar:"#grid_slider_tb",pagination:!0,pageNumber:1,pageSize:200,pageList:[100,200,300,400,500],pagePosition:"bottom",remoteSort:!1};$.isEmptyObject(s.grid.group_name)||(_.groupActive=!0,_.groupField=Strack.get_grid_group_field(s.grid.group_name).field,_.groupFormatter=function(e,t){return'<span class="">'+e+"( "+t.length+" )</span>"}),$("#grid_slider_datagrid_box").datagrid(_).datagrid("enableCellEditing").datagrid("disableCellSelecting").datagrid("gotoCell",{index:0,field:"id"}).datagrid("columnMoving")}},grid_slider_history_list_dom:function(e){var t="";return e.forEach(function(e){t+=Strack.grid_slider_history_item_dom(e)}),t},grid_slider_history_item_dom:function(e){var t="",a="";switch(e.operate){case"update":a+=e.created_by+" "+StrackLang.Modify+" "+e.module_name+" "+e.link_name+" ( "+e.id+" )";break;case"create":a+=e.created_by+" "+StrackLang.Create+" "+e.module_name+" "+e.link_name+" ( "+e.id+" )";break;case"delete":a+=e.created_by+" "+StrackLang.Delete+" "+e.module_name+" "+e.link_name+" ( "+e.id+" )"}return t+='<div class="history-items"><div class="history-items-thumb">'+Strack.build_avatar(e.avatar.id,e.avatar.avatar,Strack.upper_first_str(e.avatar.pinyin))+'</div><div class="history-items-info"><div class="history-content text-ellipsis">'+a+'</div><div class="history-date">'+e.created+"</div></div></div>"},init_grid_resize_envent:function(t){var a,i,d,r=t.find(".grid-slider-dotted"),o=t.find(".grid-slider-wrap");t.find(".x-resizable-handle").on("mousedown",function(e){e.preventDefault(),Strack.G.onSideHandleResize=!0,$(document).on("mousemove",function(e){a=e.pageX,d=document.documentElement.clientWidth-660,a=a<=400?400:d<a?d:a,i=document.documentElement.clientWidth-a,r.show().addClass("st_wrap_dotted").css({width:i+"px"}),t.css({left:a+"px"})}).on("mouseup",function(e){$(this).off("mousemove"),r.hide().removeClass("st_wrap_dotted"),o.css({width:i+"px"}),Strack.G.onSideHandleResize=!1})})},switch_top_nav:function(e){var t=$(e).attr("data-tools");switch(t){case"timelog":Strack.load_side_timelog("active");break;case"inbox":Strack.load_side_inbox("all")}$("#tools_slider_"+t).sidebar("toggle")},toggle_slider_tab:function(e){var t=$(e).attr("data-panel"),a=$(e).attr("data-tab");switch(t){case"timelog":Strack.load_side_timelog(a);break;case"inbox":Strack.load_side_inbox(a)}},load_side_inbox:function(e){$("#slider_inbox_wrap").find(".sd-msg-tab").removeClass("active"),$("#slider_msg_tab_"+e).addClass("active"),$(".slider-inbox-list").removeClass("active"),$("#slider_msg_main_"+e).addClass("active"),$("#slider_msg_refresh").attr("data-tab",e),Strack.load_side_inbox_data(e,{page_number:1,page_size:30,tab:e,status:"new"})},load_side_inbox_data:function(t,a){var e="#slider_msg_list_"+t,i=$(e).closest(".slider-inbox-main")[0],d=$(e);Strack.marked_read_message(),$.ajax({type:"POST",url:StrackPHP.getSideInboxData,dataType:"json",contentType:"application/json",data:JSON.stringify(a),beforeSend:function(){$("#slider_inbox_wrap").prepend(Strack.loading_dom("white","","inbox"))},success:function(e){"new"===a.status&&(0<e.total?(d.empty(),a.status="more",a.total=e.total,Strack.fall_load_data(i,a,function(e){Strack.load_side_inbox_data(t,a)})):d.html('<div class="datagrid-empty-no text-center">'+StrackLang.Datagird_No_Data+"</div>")),Strack.fill_inbox_list(d,e.rows),Strack.init_note_att_event("#slider_inbox_wrap"),$("#st-load_inbox").remove()}})},marked_read_message:function(){Strack.G.UnReadMessageData&&0<Strack.G.UnReadMessageData.created&&$.ajax({type:"POST",url:StrackPHP.readMessage,dataType:"json",data:{created:Strack.G.UnReadMessageData.created},success:function(e){200===parseInt(e.status)&&(Strack.G.UnReadMessageData.created=0,Strack.G.UnReadMessageData.massage_number=0,Strack.top_tool_number("#top_msg_number",0))}})},refresh_inbox_slider:function(e){var t=$(e).attr("data-tab");Strack.load_side_inbox_data(t,{page_number:1,page_size:30,tab:t,status:"new"})},fill_inbox_list:function(t,e){e.forEach(function(e){t.append(Strack.inbox_list_dom(e))})},inbox_list_dom:function(e){var t="";return t+='<div class="event"><div class="label avatar avatar-show">'+Strack.build_avatar(e.sender.id,e.sender.user_avatar,Strack.upper_first_str(e.sender.pinyin))+'</div><div class="content">',t+=Strack.inbox_list_title_item_dom(e),t+=Strack.inbox_list_content_dom(e.content),t+=Strack.inbox_list_bnt_dom(e.content),t+=Strack.inbox_list_img_item_dom(e.media_data),t+="</div>"},generate_inbox_position:function(e){var t="";return e.name&&(t+='<span style="margin-right: 5px">'+StrackLang.At_Position+"</span>",e.url?t+='<a href="'+e.url+'" target="_blank" style="margin-right: 5px">'+e.name+"</a>":t+='<a href="javascript:;" style="margin-right: 5px">'+e.name+"</a>",t+="<span>"+e.module_name+"</span>"),t},generate_inbox_item_name:function(e){var t="";return e.url?t+='<a href="'+e.url+'" target="_blank" style="margin-right: 5px">'+e.item_name+"</a>":t+='<a href="javascript:;" style="margin-right: 5px">'+e.item_name+"</a>",t},inbox_list_title_item_dom:function(e){var t="",a=e.content.title;return t+='<div class="summary"><div class="title"><span class="user" style="margin-right: 5px">'+a.created_by+'</span><span style="margin-right: 5px"><strong>'+Strack.inbox_list_title_lang(e.content.operate)+"</strong></span>"+Strack.generate_inbox_item_name(a)+"<span>"+a.module_name+'</span></div><div class="date"><span style="margin-right: 5px">'+e.created+"</span>"+Strack.generate_inbox_position(e.content.position)+"</div></div>"},inbox_list_content_dom:function(e){var t="";return e.update_data&&e.update_data.content&&e.update_data.content&&(t+='<div class="b-content">'+Strack.html_decode(e.update_data.content)+"</div>"),t},check_user_inbox_list_bnt_show:function(e){return Strack.G.userId!=e.created&&(Strack.G.userId==e.reviewed_by||Strack.G.userId==e.assignee)},inbox_list_bnt_dom:function(e){var t="",a=Math.floor(1e6*Math.random()+1);if(e.bnt)switch(e.operate){case"apply":e.bnt.forEach(function(e){switch(e.lang){case"Reject_For_Settlement":Strack.check_user_inbox_list_bnt_show(e)&&(t+='<a href="javascript:;" id="'+a+'_slider_jj_settlement_bnt" class="ui button red" onclick="Strack.reject_for_settlement(this, event)" data-linkid="'+e.link_id+'" data-moduleid="'+e.module_id+'" data-projectid="'+e.project_id+'" data-from="'+a+'" title="">'+StrackLang.Reject_For_Settlement+"</a>");break;case"Confirmation_For_Settlement":Strack.check_user_inbox_list_bnt_show(e)&&(t+='<a href="javascript:;" id="'+a+'_slider_cf_settlement_bnt" class="ui button green" onclick="Strack.confirmation_for_settlement(this, event)" data-linkid="'+e.link_id+'" data-moduleid="'+e.module_id+'" data-projectid="'+e.project_id+'" data-from="'+a+'" title="">'+StrackLang.Confirmation_For_Settlement+"</a>")}})}var i="";return t&&(i+='<div class="msg-bnt">'+t+"</div>"),i},inbox_list_title_lang:function(e){var t="";switch(e){case"add":t=StrackLang.Create;break;case"update":t=StrackLang.Modify;break;case"delete":t=StrackLang.Delete;break;case"apply":t=StrackLang.Application_For_Settlement;break;case"reject":t=StrackLang.Reject_For_Settlement;break;case"confirm":t=StrackLang.Confirmation_For_Settlement}return t},inbox_list_text_item_dom:function(t,e){var a="";if(0<e.length){var i="";e.forEach(function(e){i+=Strack.inbox_list_item_dom(t,e)}),a+='<div class="extra text">'+i+"</div>"}return a},inbox_list_item_dom:function(e,t){var a="",i="",d="";switch(e){case"add":i="info",d="blue";break;case"update":i="checkmark",d="green";break;case"delete":i="minus",d="red"}return a+='<div class="item"><i class="'+i+" box icon "+d+'"></i><a style="margin: 0 5px">'+t.field+"</a>"+t.value+"</div>"},inbox_list_img_item_dom:function(e){var t="";if("yes"===e.has_media){var a="main_"+Math.floor(1e4*Math.random()+1);t+='<div class="extra images"><div class="note-att" data-id="'+a+'">'+Strack.show_note_img_att(a,e)+"</div></div>"}return t},load_side_timelog:function(e){switch($("#slider_timelog_wrap").find(".sd-tg-tab").removeClass("active"),$("#slider_tg_tab_"+e).addClass("active"),$(".slider-menu-main").removeClass("active"),$("#slider_tg_main_"+e).addClass("active"),$("#slider_tg_refresh").attr("data-tab",e),Strack.G.sideTimelogParam=Strack.generate_hidden_param("#side_timelog_hidden_param"),e){case"active":$.ajax({type:"POST",url:StrackPHP.getSideTimelogMyTimer,dataType:"json",contentType:"application/json",beforeSend:function(){$("#slider_timelog_wrap").prepend(Strack.loading_dom("white","","timelog")),$("#slider_timer_list").empty()},success:function(e){e.forEach(function(e){Strack.init_active_timer(e)}),Strack.check_timer_exit(),$("#st-load_timelog").remove()}});break;case"history":Strack.load_timelog_slider_history("#slider_tg_history_list",{page_number:1,page_size:100,status:"new"})}},load_timelog_slider_history:function(a,i){$.ajax({type:"POST",url:StrackPHP.getSideTimelogMyData,dataType:"json",data:{page_number:i.page_number,page_size:i.page_size},beforeSend:function(){$("#slider_timelog_wrap").prepend(Strack.loading_dom("white","","timelog"))},success:function(e){var t=e.timelog_list;"new"===i.status&&($(a).empty(),i.status="more",i.total=t.total,Strack.fall_load_data(a,i,function(e){Strack.load_timelog_slider_history(a,i)})),Strack.fill_timelog_history_list(a,t.rows,e.timelog_group_total),$("#st-load_timelog").remove()}})},fill_timelog_history_list:function(t,e,a){var i;e.forEach(function(e){0<(i=$("#timelog_g_"+e.group)).length?i.prepend(Strack.timelog_history_item_dom(e)):$(t).append(Strack.timelog_history_group_dom(e,a[e.group]))})},timelog_history_group_dom:function(e,t){var a="";return a+='<div class="time-item-title"><div class="time-title-show"><div class="name aign-left">'+e.group_name+'</div><div class="total aign-right">'+StrackLang.Work_Hour_Total+"："+Strack.format_timer_time(t)+'</div></div></div><div id="timelog_g_'+e.group+'" class="timelog-group">'+Strack.timelog_history_item_dom(e)+"</div>"},timelog_history_item_dom:function(e){var t="";return t+='<li id="timelog_i_'+e.id+'" class="time-base-item"><div class="acrive-task-show"><div class="time-task-info aign-left"><div href="javascript:;" class="task-step text-ellipsis">'+e.title+'</div><div href="javascript:;" class="task-belog-to text-ellipsis">'+e.belong+'</div></div><div class="time-date-show aign-left"><div class="itime-total">'+Strack.format_timer_time(e.duration)+'</div><div class="itime-range">'+e.start_time+" - "+e.end_time+'</div></div><div class="time-task-close aign-left">',"yes"===Strack.G.sideTimelogParam.rule_delete&&(t+='<a href="javascript:;" onclick="Strack.delete_timelog_history_item(this);" data-timeid="'+e.id+'"><i class="icon-uniEA36"></i></a>'),t+="</div></div></li>"},refresh_timelog_slider:function(e){var t=$(e).attr("data-tab");Strack.load_side_timelog(t)},generate_kanban_timelog_bnt:function(e,t){var a="";return t&&0<t.rows.length&&e.user_id==t.rows[0].id&&(a=Strack.init_timelog_bnt_dom(e,e.random_id,"kanban",!0)),a},init_timelog_bnt:function(e,t){var a=$(e);switch(a.attr("data-from","slider"),t.color){case"red":a.attr("data-timelogid",t.id),a.removeClass("green").addClass("red"),a.html('<i class="icon-uniE974 icon-left"></i>'+StrackLang.Pause);break;case"green":a.attr("data-timelogid",0),a.removeClass("red").addClass("green"),a.html('<i class="icon-uniE974 icon-left"></i>'+StrackLang.Start)}},init_timelog_bnt_dom:function(e,t,a,i){var d="",r=i?"":"fc-h-event-";switch(e.timelog.color){case"red":d+='<div class="fc-h-event-all-day-tg aign-left"><a id="'+t+'" href="javascript:;" class="ui button basic '+r+"red time_log_bnt_"+e.item_id+'" onclick="Strack.item_start_timelog(this, event)" data-linkid="'+e.item_id+'" data-timelogid="'+e.timelog.id+'" data-moduleid="'+e.module_id+'" title="" data-id="'+t+'" data-from="'+a+'"><i class="icon-uniE974 icon-left"></i>'+StrackLang.Pause+"</a></div>";break;case"green":d+='<div class="fc-h-event-all-day-tg aign-left"><a id="'+t+'" href="javascript:;" class="ui button basic '+r+"green time_log_bnt_"+e.item_id+'" onclick="Strack.item_start_timelog(this, event)" data-linkid="'+e.item_id+'" data-timelogid="0" data-moduleid="'+e.module_id+'" title="" data-id="'+t+'" data-from="'+a+'"><i class="icon-uniE974 icon-left"></i>'+StrackLang.Start+"</a></div>"}return d},init_active_timer:function(e){var t="timer_"+Math.floor(1e4*Math.random()+1);Strack.add_side_timer_item(t,{status:"stop",time:"00:00",value:e.link_id,disabled:!0}),Strack.run_timer(t,e.timer_start);var a=$("#item_"+t);a.addClass("active"),a.attr("data-timerid",e.id)},add_side_timer:function(e){var t="timer_"+Math.floor(1e4*Math.random()+1);Strack.add_side_timer_item(t,{status:"start",time:"00:00",value:"",disabled:!1})},add_side_timer_item:function(e,t){$("#slider_timer_list .datagrid-empty-no").remove(),$("#slider_timer_list").prepend(Strack.side_timer_dom(e,t));var a=$("input[name=project_id]").val();a=a||0,Strack.combobox_widget("#"+e,{url:StrackPHP.getTimeLogIssuesCombobox,prompt:StrackLang.Please_Select_Timer_Issue,valueField:"id",textField:"name",groupField:"group_lang",value:t.value,disabled:t.disabled,width:220,queryParams:{project_id:a},onSelect:function(e){}})},start_timer:function(a){var i=$(a).data("id"),e=$("#"+i).combobox("getRowValue","id");$.isEmptyObject(e)?layer.msg(StrackLang.Please_Select_Timelog_Issue,{icon:2,time:1200,anim:6}):$.ajax({type:"POST",url:StrackPHP.addTimelogTimer,dataType:"json",data:e,beforeSend:function(){$("#slider_timer_list").prepend(Strack.loading_dom("white","","timer"))},success:function(e){if(200===parseInt(e.status)){Strack.top_message({bg:"g",msg:e.message}),$("#"+i).combobox("disable"),Strack.run_timer(i,0);var t=$(a).closest(".tg-ac-item");t.addClass("active"),t.attr("data-timerid",e.data.id),t.find(".control-bnt").empty().append(Strack.timer_control_bnt("stop",i)),Strack.check_timer_exit()}else layer.msg(e.message,{icon:7,time:1200,anim:6});$("#st-load_timer").remove()}})},stop_timer:function(e){var t=$(e).data("id"),a=$(e).closest(".tg-ac-item").attr("data-timerid");$.ajax({type:"POST",url:StrackPHP.stopTimelogTimer,dataType:"json",data:{timer_id:a},beforeSend:function(){$("#slider_timer_list").prepend(Strack.loading_dom("white","","timer"))},success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),$("#"+t).combobox("destroy"),$("#item_"+t).remove(),clearInterval(Strack.G.TllogTerval[t]),Strack.check_timer_exit()):layer.msg(e.message,{icon:7,time:1200,anim:6}),$("#st-load_timer").remove()}})},delete_timer:function(e){var t=$(e).data("id"),a=$(e).closest(".tg-ac-item");if(a.hasClass("active")){var i=a.attr("data-timerid");$.ajax({type:"POST",url:StrackPHP.deleteTimelog,dataType:"json",data:{primary_ids:i},beforeSend:function(){$("#slider_timer_list").prepend(Strack.loading_dom("white","","timer"))},success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),$("#"+t).combobox("destroy"),$("#item_"+t).remove(),clearInterval(Strack.G.TllogTerval[t]),Strack.check_timer_exit()):layer.msg(e.message,{icon:7,time:1200,anim:6}),$("#st-load_timer").remove()}})}else $("#"+t).combobox("destroy"),$("#item_"+t).remove(),Strack.check_timer_exit()},delete_timelog_history_item:function(e){var t=$(e).data("timeid");0<t&&$.ajax({type:"POST",url:StrackPHP.deleteTimelog,dataType:"json",data:{primary_ids:t},beforeSend:function(){$("#slider_timelog_wrap").prepend(Strack.loading_dom("white","","timelog"))},success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),$("#timelog_i_"+t).remove()):layer.msg(e.message,{icon:7,time:1200,anim:6}),$("#st-load_timelog").remove()}})},run_timer:function(e,t){var a=$("#item_"+e).find(".time"),i=0<t?t:0;Strack.G.TllogTerval[e]=setInterval(function(){a.html(Strack.format_timer_time(i)),i++},1e3)},format_timer_time:function(e){var t=e,a=parseInt(t/86400),i=parseInt(t%86400/3600),d=parseInt(t%86400%3600/60),r=t%86400%360%60,o="";return 0!==a&&(o+=a+StrackLang.Days+" "),0===i&&0===a||(o+=Strack.fix_timer_number(i,2)+":"),0===d&&0===i&&0===a||(o+=Strack.fix_timer_number(d,2)+":"),o+=Strack.fix_timer_number(r,2),0===a&&0===i&&0===d&&(o+=" "+StrackLang.Unit_Sec),0===a&&0===i&&0!==d&&(o+=" "+StrackLang.Unit_Min),o},fix_timer_number:function(e,t){return(""+e).length<t?(new Array(t+1).join("0")+e).slice(-t):""+e},check_timer_exit:function(){var e=$("#slider_timer_list"),t=e.find(".tg-ac-item").length;0===t&&e.empty().append('<div class="datagrid-empty-no text-center">'+StrackLang.Datagird_No_Data+"</div>"),Strack.top_tool_number("#top_timer_number",t)},side_timer_dom:function(e,t){var a="";return a+='<div id="item_'+e+'" class="ui grid tg-ac-item"><div class="center aligned four column row"><div class="seven wide column"><div style="padding-left: 20px"><input id="'+e+'" autocomplete="off"></div></div><div class="five wide column button-wrap time">'+t.time+'</div><div class="two wide column button-wrap control-bnt">'+Strack.timer_control_bnt(t.status,e)+'</div><div class="two wide column button-wrap">',"yes"===Strack.G.sideTimelogParam.rule_delete&&(a+='<a href="javascript:;" class="button" onclick="Strack.delete_timer(this)" data-id="'+e+'"><button class="ui basic gray button">'+StrackLang.Delete+"</button></a>"),a+="</div></div></div>"},timer_control_bnt:function(e,t){var a="";return"yes"===Strack.G.sideTimelogParam.rule_start_stop&&(a+="start"===e?'<a href="javascript:;" class="button" onclick="Strack.start_timer(this)" data-id="'+t+'"><button class="ui basic green button">'+StrackLang.Start+"</button></a>":'<a href="javascript:;" class="button" onclick="Strack.stop_timer(this)" data-id="'+t+'"><button class="ui basic red button">'+StrackLang.Pause+"</button></a>"),a},item_start_timelog:function(t,e){e.stopPropagation(),e.preventDefault();var a=$(t).attr("data-id"),i=$(t).attr("data-linkid"),d=$(t).attr("data-timelogid"),r=$(t).attr("data-moduleid"),o=$(t).attr("data-from");$.ajax({type:"POST",url:StrackPHP.startOrStopTimelog,data:{id:i,timelog_id:d,module_id:r,from:o},dataType:"json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.top_tool_number("#top_timer_number",e.data.timer_number),Strack.Websocket.List.hasOwnProperty("update")||Strack.item_timelog_bnt_refresh(t,"add",{id:a,link_id:i,timelog_id:d,module_id:r,from:o,data:e.data})):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},item_timelog_bnt_refresh:function(e,t,a){var i={color:"",id:0};switch(a.from){case"kanban":0<a.timelog_id?(i={color:"green",id:0},Strack.init_timelog_bnt("#"+a.id,i),$(".kanban-card-bnt a.button").each(function(){$(this).hasClass("red")&&$(this).removeClass("red").addClass("green")})):(i={color:"red",id:a.data.id},Strack.init_timelog_bnt("#"+a.id,i));break;case"slider":i=0<a.timelog_id?{color:"green",id:0}:{color:"red",id:a.data.id},Strack.init_timelog_bnt("#"+a.id,i);break;case"schedule":var d=$("#"+a.id);0<a.timelog_id?(i={color:"green",id:0},d.attr("data-timelogid",0),d.removeClass("fc-h-event-red").addClass("fc-h-event-green"),d.html('<i class="icon-uniE974 icon-left"></i>'+StrackLang.Start)):(i={color:"red",id:a.data.id},d.attr("data-timelogid",a.data.id),d.removeClass("fc-h-event-green").addClass("fc-h-event-red"),d.html('<i class="icon-uniE974 icon-left"></i>'+StrackLang.Pause))}$.inArray(a.link_id,Strack.G.tempStartTimelogids.ids)<0&&Strack.G.tempStartTimelogids.ids.push(parseInt(a.link_id)),Strack.G.tempStartTimelogids.status[parseInt(a.link_id)]=i},top_header:function(){var e=$("input[name = project_id]"),t=0<e.length?e.val():0;$.ajax({type:"POST",url:StrackPHP.getTopRightData,dataType:"json",data:{project_id:t},success:function(e){var t=e.user_data;Strack.G.userId=t.user_id,Strack.notice.license(e.license_data),Strack.notice.demo_project(e.project_data),Strack.top_tool_number("#top_timer_number",e.timer_number),Strack.G.UnReadMessageData={massage_number:e.message_data.massage_number,created:e.message_data.last_message_data.created},Strack.top_tool_number("#top_msg_number",e.message_data.massage_number),$("#top_avatar").append(Strack.build_avatar(t.user_id,t.avatar,Strack.upper_first_str(t.pinyin)));var a=$("#padmin_avatar");0<a.length&&(a.empty().append(Strack.build_avatar(t.user_id,t.avatar,Strack.upper_first_str(t.pinyin))),$("#padmin_name").html(t.name)),0<$("#acinfo_menu").length&&($("#acinfo_avatar").empty().append(Strack.build_avatar(t.user_id,t.avatar,Strack.upper_first_str(t.pinyin))),$("#acinfo_name").html(t.name))}})},top_tool_number:function(e,t){0<parseInt(t)?$(e).html(t).addClass("st-sup-ac"):$(e).removeClass("st-sup-ac").empty()},load_notes:function(o,n){var s=$(o.content_id).find('[data-tab="note"]');$.ajax({type:"POST",url:StrackPHP.getNoteListData,data:n,dataType:"json",beforeSend:function(){"new"===n.status&&s.addClass("loading")},success:function(e){var t=$("#"+o.list_id+" .note-no-stick"),a=$("#"+o.list_id+" .note-stick");if("new"===n.status){var i="comments_list_"+n.module_id+"_"+n.item_id,d=$("#"+o.list_id);d.attr("class").split(" ").forEach(function(e){$.inArray(e,["ui","threaded","comments","note-comments"])<0&&d.removeClass(e)}),d.addClass(i),n.total=e.note_list.total,o.avatar_id&&$(o.avatar_id).empty().append(Strack.build_avatar(e.user_data.user_id,e.user_data.avatar,Strack.upper_first_str(e.user_data.pinyin)));var r={item_id:n.item_id,project_id:n.project_id,module_id:n.module_id,module_type:n.module_type,structure_id:n.structure_id,list_id:o.list_id,list_class:"comments_list_"+n.module_id,parent_id:0};$(".simditor-body").attr("contenteditable",!1),Strack.init_note_editor(o.editor_id,0,r,"panel","add",!0),Strack.fall_load_data(o.page_id,n,function(e){e.status="more",Strack.load_notes(o,e)},function(){if(o.details_top_bar){var e=$("#"+o.tab_bar_id);0<$(".globel-top-notice").length?e.css("top",85):e.css("top",49),$(o.tab_id).offset().top<80?e.show(200):e.hide(200)}}),a.empty().append(Strack.show_note_list(e.stick_note_list)),0<e.stick_note_list.total&&a.addClass("note-stick-bottom"),t.empty(),s.removeClass("loading")}t.append(Strack.show_note_list(e.note_list)),e.note_list.rows.forEach(function(e){Strack.init_note_att_event(".comment_note_"+e.id)})}})},init_note_att_event:function(e){e?$(e).find(".note-att").each(function(){Strack.init_thumb_media($(this).data("id"))}):$(".note-att").each(function(){Strack.init_thumb_media($(this).data("id"))})},init_note_editor:function(e,a,t,i,d,r){Strack.G.GeditorParam["e_"+a]=t;Strack.G.Geditor["e_"+a]=new Simditor({textarea:$("#"+e),placeholder:StrackLang.Add_Note_Notice,toolbarHidden:r,toolbartype:a,panel_type:"main",toolbar:["color","bold","emoji","|","strikethrough","ol","ul","blockquote","table","hr"],footer_control:!0,from:i,edit_mode:d,module_type:t.module_type,list_class:t.list_class,emoji:{imagePath:"images/emoji/"},mention:{url:StrackPHP.getAtUserList,nameKey:"name",pinyinKey:"pinyin",abbrKey:"abbr",param:t}}),0===a&&Strack.G.Geditor["e_"+a].on("focus",function(e,t){Strack.hide_note_reply(),$(".toolbar_"+a).show(),Strack.reset_slider_note_hight(this.wrapper,"focus"),Strack.G.mediaScreenshotStatus&&obj.exit_media_painter()})},reset_slider_note_hight:function(e,t){var a=$(e).closest(".note-editor-slider");if(0<a.length){var i=parseInt(a.attr("data-baseh")),d=a.find(".pyn-fd-wrap");"focus"===t?d.css("height","calc(100% - "+(i+58)+"px)"):d.css("height","calc(100% - "+i+"px)")}},show_note_reply:function(e){var t=$(e).attr("data-noteid");Strack.hide_note_reply(),$(e).parent().hide().after(Strack.note_reply_editor(t));var a=Strack.G.GeditorParam.e_0;a.parent_id=t,Strack.init_note_editor("editor-reply_"+t,t,a,"panel","add",!1)},hide_note_reply:function(){$(".reply-editor").each(function(){Strack.close_note(this)})},note_reply_editor:function(e){return'<div id="reply-wrap_'+e+'" class="reply-editor" toolbar_type="'+e+'"><textarea id="editor-reply_'+e+'" autocomplete="off"></textarea></div>'},show_note_list:function(e){var t="";return e.rows.forEach(function(e){t+=Strack.notes_single_item_dom(e,"add")}),t},notes_single_item_dom:function(e,t){var a="",i=Strack.notes_item_dom(e);return"add"===t?(a+='<div class="comment comment_note_'+e.id+'" stick="'+e.stick+'">',a+=i,a+="</div>"):i},notes_item_dom:function(e){var t="";t+='<a href="javascript:;" class="avatar avatar-show" title="'+e.user_data.name+'">',t+=Strack.build_avatar(e.user_data.user_id,e.user_data.avatar,Strack.upper_first_str(e.user_data.pinyin));var a="";switch(e.type){case"text":a=e.text;break;case"audio":a+='<p class="weixinAudio"> <audio src="'+e.audio_data.path+'" id="media" width="1" height="1" preload></audio> <span id="audio_area" class="db audio_area"> <span class="audio_wrp db"> <span class="audio_play_area"> <i class="icon_audio_default"></i> <i class="icon_audio_playing"></i> </span> <span id="audio_length" class="audio_length tips_global">'+e.audio_data.duration+'</span> <span class="db audio_info_area"> <span class="audio_source tips_global">'+e.audio_data.description+'</span> </span> <span id="audio_progress" class="progress_bar" style="width: 0%;"></span> </span> </span> </p>',a+=e.text}var i="";i+='<a href="javascript:;" onclick="Strack.edit_note(this)" class="note-editicon" data-noteid="'+e.id+'"><i class="icon-uniF040 icon-left"></i></a>',i+='<a href="javascript:;" onclick="Strack.delete_note(this)" class="note-editicon" data-noteid="'+e.id+'"><i class="icon-uniE765"></i></a>';var d="";0<e.reply_data.length&&(d=StrackLang.Reply+" #"+e.parent_id+" "+e.reply_data.reply_user_name);var r="main_"+Math.floor(1e4*Math.random()+1);return t+='</a><div class="content">'+Strack.init_note_tag(e.tag_data)+'<div class="note-toolbar"><a href="javascript:;" class="author" target="_blank">#'+e.id+" "+e.user_data.name+'</a><span class="reply_auth_name">'+d+'</span><div class="metadata"><span class="date">'+e.last_updated+'</span></div><div class="aign-right note-tedit">'+i+'</div></div><div class="text  editor-style ntext_'+e.id+'"><div class="simditor-body">'+a+'</div></div><div class="note-att" data-id="'+r+'">'+Strack.show_note_img_att(r,e.media_data)+"</div>",t+='<div class="actions"><a class="reply" onclick="Strack.show_note_reply(this)" data-noteid="'+e.id+'">'+StrackLang.Reply+"</a></div>",t+="</div>",t+=Strack.init_link_note(e.link_note_data)},init_link_note:function(e){var t="";if(e.length){var a="";e.forEach(function(e){a+='<a href="javascript:;" onclick="Strack.edit_note(this)" data-noteid="'+e.id+'"> # '+e.id+"</a>"}),t+='<div class="link-note"><ul class="link-note-wrap"><li class="link-note-item"><span class="link-icon"><i class="icon-uniE612"></i></span><span class="link-title">'+StrackLang.Link_Note+'</span><div class="link-note-bnt">'+a+"</div></li></ul></div>"}return t},init_note_tag:function(e){if(e.length){var t="";e.forEach(function(e){t+=Strack.note_tag_dom(e)});var a="";return"yes"===Strack.read_storage("note-tag-show")&&(a="note-tags-show"),'<a href="javascript:;" class="note-tags '+a+'" onclick="Strack.toggle_note_tag_show(this)">'+t+"</a>"}return""},note_tag_dom:function(e){return e?'<span class="card-label mod-card-front" title="'+e.name+'" style="background-color: #'+e.color+'">'+e.name+"</span>":""},toggle_note_tag_show:function(e){$(e).hasClass("note-tags-show")?($(".note-tags").removeClass("note-tags-show"),Strack.save_storage("note-tag-show","no")):($(".note-tags").addClass("note-tags-show"),Strack.save_storage("note-tag-show","yes"))},delete_note:function(e){var t=$(e).attr("data-noteid");$.messager.confirm(StrackLang.Confirmation_Box,StrackLang.Note_Delete_Confirm,function(e){e&&$.ajax({type:"POST",url:StrackPHP.deleteNote,dataType:"json",data:{primary_ids:t},beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){Strack.top_message({bg:"g",msg:e.message}),$.messager.progress("close"),Strack.Websocket.List.hasOwnProperty("update")||Strack.update.note(e.data)}})})},close_note:function(e){var t=$(e).attr("toolbar_type");if(Strack.reset_slider_note_hight(e,"blur"),Strack.destroy_note_img_uploadifive(t),$(".ed_rethumb_"+t).empty().removeClass("simditor-fields-ac"),$(e).closest(".simditor-footer").find(".toolbar-foot-item").removeClass("ntool-active"),0<t){var a=$("#reply-wrap_"+t);a.prev().show(),a.remove()}else $(".toolbar_"+t).hide(),Strack.G.Geditor["e_"+t].setValue(""),$(".fieldsbar_"+t).removeClass("simditor-fields-ac").find("li").each(function(){$(this).find("input.ed_fiedlds").combobox("destroy"),$(this).remove()});Strack.G.closeNoteObj=null},reset_note:function(e){$(".ed_rethumb_"+e).empty().removeClass("simditor-fields-ac"),Strack.G.Geditor["e_"+e].setValue(""),$(".fieldsbar_"+e).removeClass("simditor-fields-ac").find("li").each(function(){$(this).find("input.ed_fiedlds").combobox("destroy"),$(this).remove()})},data_url_to_file:function(e){for(var t=e.split(","),a=t[0].match(/:(.*?);/)[1],i=atob(t[1]),d=i.length,r=new Uint8Array(d);d--;)r[d]=i.charCodeAt(d);return new File([r],"img.png",{type:a})},add_note:function(e){var t=$(e).attr("toolbar_type"),a=$("#nodeimg_"+t+" .uploadifive-queue-item").length,i=Strack.G.Geditor["e_"+t].getValue();Strack.G.closeNoteObj=e;var d=$("#screenshot_list .pyn-st-img img");0<d.length?Strack.add_review_img_to_uploadfive(e,t,d):0<i.length||0<a?0<a?$("#nodeimg_bnt_"+t).uploadifive("upload"):Strack.update_note(t,StrackPHP.addNote,"add"):layer.msg(StrackLang.Note_Text_Empty_Or_Media_Empty,{icon:2,time:1200,anim:6})},add_review_img_to_uploadfive:function(e,t,a){$(".simditor-rethumb").hasClass("simditor-fields-ac")?(a.each(function(){$("#nodeimg_bnt_"+t).uploadifive("addQueueItem",Strack.data_url_to_file($(this).attr("src")))}),$("#nodeimg_bnt_"+t).uploadifive("upload")):Strack.note_add_image(e,t,"add",function(){a.each(function(){$("#nodeimg_bnt_"+t).uploadifive("addQueueItem",Strack.data_url_to_file($(this).attr("src")))}),$("#nodeimg_bnt_"+t).uploadifive("upload")})},update_note:function(e,t,a,i,d){var r=Strack.G.Geditor["e_"+e].body,o=$(".fieldsbar_"+e),n=Strack.G.GeditorParam["e_"+e];n.file_commit_id=Strack.G.mediaViewPlayIndex,d&&(n.media_server=d),n.type="text",n.id=e,n.text=Strack.G.Geditor["e_"+e].getValue();var s=[];r.find("a").each(function(){$(this).hasClass("simditor-mention")&&s.push($(this).data("uid"))}),n.at_user_ids=s.join(","),n.status_id=0,n.stick="no",n.version_id=0,n.tags="",o.find(".ed_fiedlds").each(function(){var e=$("#"+$(this).attr("id"));switch($(this).attr("data-input")){case"status":n.status_id=e.combobox("getValue");break;case"stick":n.stick=e.combobox("getValue");break;case"tag":var t=e.combobox("getValues");n.tags=t.join(",")}}),n.images=i||[],"modify"===a&&(n.delete_media_ids=Strack.G.Note_Delete_Img_Ids),$.ajax({type:"POST",url:t,data:JSON.stringify(n),dataType:"json",contentType:"application/json",beforeSend:function(){d||$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){if($.messager.progress("close"),200===parseInt(e.status)){switch($("#screenshot_list .pyn-st-img").length&&$("#screenshot_list").html('<div class="pyn-st-null">'+StrackLang.Screenshot_Null+"</div>"),Strack.top_message({bg:"g",msg:e.message}),Strack.G.Note_Uploadifive_Imgs=[],a){case"modify":case"batch_add":Strack.dialog_cancel();break;case"add":Strack.close_note(Strack.G.closeNoteObj)}Strack.Websocket.List.hasOwnProperty("update")||Strack.update.note(e.data)}else layer.msg(e.message,{icon:7,time:1200,anim:6})}})},batch_add_note:function(e){var t=$(e).closest(".datagrid-toolbar"),a=t.attr("data-grid"),i=t.attr("data-moduleid"),d=t.attr("data-projectid"),r=$("#"+a).datagrid("getSelections"),o=[];r.forEach(function(e){o.push(parseInt(e.id))}),0<o.length?Strack.open_dialog("dialog",{title:StrackLang.Batch_Add_Note,width:700,height:470,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mlink_ids",type:"hidden",name:"link_ids",valid:1,value:o.join(",")},{case:101,id:"Mmodule_id",type:"hidden",name:"module_id",valid:1,value:i},{case:101,id:"Mproject_id",type:"hidden",name:"project_id",valid:1,value:d}],items:[{case:7,id:"Mnote_text",type:"text",lang:"",name:"note_text",valid:1,value:""},{case:14,id:"Mnote_meida",type:"text",lang:"",name:"note_meida",valid:1,value:""}],footer:[{obj:"submit_batch_add_note",type:11,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){var e={item_id:o.join(","),project_id:d,module_id:i,list_id:o.list_id,list_class:"comments_list_"+i,parent_id:0};Strack.init_note_editor("Mnote_text",i+"_0",e,"dialog","batch_add",!1),$("#st_dialog_form").find(".simditor-body").css({height:"140px"})}}):layer.msg(StrackLang.Please_Select_One,{icon:2,time:1200,anim:6})},submit_batch_add_note:function(){var e=$("#Mmodule_id").val()+"_0",t=Strack.G.Geditor["e_"+e].getValue(),a=$("#nodeimg_"+e+" .uploadifive-queue-item").length;0<t.length||0<a?0<a?$("#nodeimg_bnt_"+e).uploadifive("upload"):Strack.update_note(e,StrackPHP.batchAddNote,"batch_add"):layer.msg(StrackLang.Note_Text_Empty_Or_Media_Empty,{icon:2,time:1200,anim:6})},edit_note:function(e){var i=$(e).attr("data-noteid");0<i&&(Strack.hide_note_reply(),$.ajax({type:"POST",url:StrackPHP.getOneNoteData,data:{note_id:i},dataType:"json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(a){Strack.G.Note_Uploadifive_Imgs=[],$.messager.progress("close"),Strack.open_dialog("dialog",{title:StrackLang.Modify_Note,width:700,height:470,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mnote_id",type:"hidden",name:"note_id",valid:1,value:i}],items:[{case:7,id:"Mnote_text",type:"text",lang:"",name:"note_text",valid:1,value:a.text},{case:14,id:"Mnote_meida",type:"text",lang:"",name:"note_meida",valid:1,value:""}],footer:[{obj:"modify_note",type:11,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){var e=Strack.G.GeditorParam.e_0;if(e.parent_id=i,Strack.init_note_editor("Mnote_text",i,e,"dialog","modify",!1),$("#st_dialog_form").find(".simditor-body").css({height:"140px"}),Strack.editor_footer_item(i,"stick",StrackLang.Stick,a.stick),a.status_id&&Strack.editor_footer_item(i,"status",StrackLang.Status,a.status_id),0<a.tag_data.length){var t=[];a.tag_data.forEach(function(e){0<e.tag_id&&t.push(e.tag_id)}),0<t.length&&Strack.editor_footer_item(i,"tag",StrackLang.Tag,t)}"yes"===a.media_data.has_media&&Strack.init_modify_note_img_list("#dialog_img_list",a.media_data.param)},close:function(){Strack.G.Note_Delete_Img_Ids=[],Strack.G.Note_Has_Img_Length=0}})}}))},init_modify_note_img_list:function(e,t){var a="";t.forEach(function(e){a+=Strack.modify_note_img_item_dom(e)}),Strack.G.Note_Has_Img_Length=t.length,$(e).empty().append('<div class="note-del-img-title">'+StrackLang.Select_The_Media_To_Delete+'</div><div class="note-del-img-wrap">'+a+"</div>")},modify_note_img_item_dom:function(e){var t="",a="";switch(e.type){case"image":a=e.base_url+e.md5_name+"_origin."+e.ext;break;case"video":a=e.base_url+e.md5_name+".jpg"}return t+='<a href="javascript:;" class="note-del-img aign-left" onclick="Strack.sign_delete_note_images(this)" data-id="'+e.media_id+'"><img src="'+a+'"></a>'},sign_delete_note_images:function(e){var t=parseInt($(e).attr("data-id"));if($(e).hasClass("active")){var a=[];Strack.G.Note_Delete_Img_Ids.forEach(function(e){e!==t&&a.push(e)}),Strack.G.Note_Delete_Img_Ids=a,Strack.G.Note_Has_Img_Length++}else Strack.G.Note_Delete_Img_Ids.push(t),Strack.G.Note_Has_Img_Length--;$(e).toggleClass("active")},modify_note:function(){var e=$("#Mnote_id").val(),t=Strack.G.Geditor["e_"+e].getValue(),a=$("#nodeimg_"+e+" .uploadifive-queue-item").length;0<t.length||0<a||0<Strack.G.Note_Has_Img_Length?0<a?$("#nodeimg_bnt_"+e).uploadifive("upload"):Strack.update_note(e,StrackPHP.modifyNote,"modify"):layer.msg(StrackLang.Note_Text_Empty_Or_Media_Empty,{icon:2,time:1200,anim:6})},click_editor_footer:function(e){var t=$(e).attr("toolbar_type"),a=$(e).attr("toolbar_area");switch(a){case"image":var i=$(e).attr("edit_mode");Strack.note_add_image(e,t,i);break;default:var d=$(e).attr("lang");Strack.editor_footer_item(t,a,d,"")}},editor_footer_item:function(e,t,a,i){var d=$(".fieldsbar_"+e),r="ed_field_"+t+"_"+e,o=$("#"+r);$(".toolbar_"+e).find(".toolbar-foot-item").each(function(){$(this).attr("toolbar_area")===t&&$(this).toggleClass("ntool-active")}),0===o.length?(d.addClass("simditor-fields-ac"),Strack.init_editor_footer_item(d.find("ul"),e,r,t,a,i)):(o.find("input.ed_fiedlds").combobox("destroy"),o.remove(),0===d.find("li").length&&d.removeClass("simditor-fields-ac"))},init_editor_footer_item:function(e,t,a,i,d,r){var o="",n="ed_input_"+i+"_"+t;o+='<li id="'+a+'" class="e-fields-item" ><div class="e-fiedlds-name aign-left">'+d+'</div><div class="e-fiedlds-input"><input id="'+n+'" class="ed_fiedlds" data-input="'+i+'"></div></li>',e.append(o);var s=Strack.G.GeditorParam["e_"+t],l=!1;"tag"===(s.area=i)&&(l=!0),$("#"+n).combobox({url:StrackPHP.getNoteWidgetData,valueField:"id",textField:"name",queryParams:s,multiple:l,value:r,width:320,onLoadSuccess:function(){var e=$(this).combobox("getData");e.length&&0===r.length&&$(this).combobox("select",e[0].id)}})},note_add_image:function(a,i,d,r){var o=$(".ed_rethumb_"+i);o.hasClass("simditor-fields-ac")?($(a).removeClass("ntool-active"),Strack.destroy_note_img_uploadifive(i),o.removeClass("simditor-fields-ac").empty()):Strack.get_media_server(function(e){$(a).addClass("ntool-active");var t="";t+='<div id="nodeimg_'+i+'" class="rethumb-images aign-left"></div><div class="rethumb-add aign-right"><input id="nodeimg_bnt_'+i+'" class="aign-left" name="nodeimg_bnt_'+i+'" type="file" multiple="true"></div>',o.addClass("simditor-fields-ac").empty().append(t),Strack.init_note_img_uploadifive(i,e,{edit_mode:d},r)})},init_note_img_uploadifive:function(i,d,r,e){$("#nodeimg_bnt_"+i).uploadifive({auto:!1,removeCompleted:!0,formData:{timestamp:Strack.current_time(),belong_system:StrackPHP.Belong_System,token:d.token,size:"250x140"},queueID:"nodeimg_"+i,uploadScript:d.upload_url,onUpload:function(e){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},onInit:function(){e&&e()},onUploadComplete:function(e,t){var a=JSON.parse(t);200===parseInt(a.status)&&Strack.G.Note_Uploadifive_Imgs.push(a.data)},onQueueComplete:function(e,t){var a="";switch(r.edit_mode){case"batch_add":a=StrackPHP.batchAddNote;break;case"modify":a=StrackPHP.modifyNote;break;default:a=StrackPHP.addNote}Strack.update_note(i,a,r.edit_mode,Strack.G.Note_Uploadifive_Imgs,d)}})},destroy_note_img_uploadifive:function(e){$("#nodeimg_bnt_"+e).uploadifive("destroy")},follow_item:function(e){var t=$(e),a={module_id:t.attr("data-moduleid"),module_type:t.attr("data-moduletype"),follow_status:t.attr("data-followstatus"),link_id:t.attr("data-linkid")};"yes"===a.follow_status?$.messager.confirm(StrackLang.Confirmation_Box,StrackLang.Confirm_UnFollow,function(e){e&&Strack.do_follow_item(t,a)}):Strack.do_follow_item(t,a)},do_follow_item:function(t,e){$.ajax({type:"POST",url:StrackPHP.followItem,data:e,dataType:"json",beforeSend:function(){t.addClass("disabled")},success:function(e){t.removeClass("disabled"),200===parseInt(e.status)?(Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message}),t.attr("data-followstatus",e.data.follow_status),t.html(e.data.follow_status_name)):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},open_action_slider:function(e){var t=$(e).data("from"),a=$(e).data("moduleid"),i=$(e).data("projectid"),d=$("#action_search_bnt");switch($("#action_list_slider").sidebar("toggle"),d.attr("data-from",t).attr("data-moduleid",a).attr("data-projectid",i),t){case"grid":var r=$(e).data("grid"),o=$("#"+r).datagrid("getSelections"),n=[];o.forEach(function(e){n.push(e.id)}),d.attr("data-grid",r).attr("data-ids",n.join(",")),Strack.load_sidebar_action_list({from:t,grid:r,module_id:a,project_id:i,filter:""});break;case"details":var s=$(e).data("linkid");d.attr("data-ids",s),Strack.load_sidebar_action_list({from:t,grid:"",module_id:a,project_id:i,filter:""})}},search_action:function(e){var t=$(e),a=$("#action_search_box").val(),i="";0<a.length&&(i={name:["-lk","%"+a+"%"]});var d={from:t.data("from"),grid:t.data("grid"),module_id:t.data("moduleid"),project_id:t.data("projectid"),filter:i};Strack.load_sidebar_action_list(d)},open_schedule_slider:function(e){var t=$("#schedule_list_slider");t.sidebar("toggle");t.hasClass("slider-active")||Strack.init_schedule_panel("scheduler_my",28)},check_event_end_time:function(e,t){},init_schedule_panel:function(e,t,i){var n="yes"===i.rule_update_widget;$("#"+e).fullCalendar({header:{left:"today prev,next",center:"title",right:"agendaDay,agendaWeek,agendaMonth,listWeek,"},contentHeight:Strack.panel_height("#"+e,t),domParam:{dom:e,min_h:t},defaultView:"agendaDay",slotDuration:"00:10:00",defaultDate:Strack.date_format(new Date,"yyyy-MM-dd"),selectable:!0,handleWindowResize:!0,defaultTimedEventDuration:"00:30:00",eventOrder:"end_time",navLinks:!0,eventLimit:!0,nowIndicator:!0,param:i,loading:function(e,t){if(1!=e&&0==e){if("refetchEvents"!==Strack.G.calendarLoadMode){var a=$(".fc-scroller .fc-time-grid").height(),i=(new Date).getHours();$(".fc-scroller").scrollTop(i/24*a);var d=i+":00:00";$(".fc-scroller .fc-time-grid tr").each(function(){$(this).attr("data-time")===d&&$(this).find("td").css("color","red")})}Strack.G.calendarLoadMode="",$.messager.progress("close")}},windowResize:function(e){$(this).fullCalendar("option","contentHeight",Strack.panel_height("#scheduler_my",39))},events:function(e,t,a,i){$.ajax({url:StrackPHP.getMyScheduleData,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({start:e.unix(),end:t.unix(),filter:Strack.G.calendarEventsFilter}),success:function(a){Strack.right_menu_dom({copy_id:"",edit_id:"",id:"my_schedule_rmenu",data:a.right_menu_config});var t=[];a.events_list.forEach(function(e){"yes"===e.lock_status?e.editable=!1:e.editable=n,"yes"===e.is_all_day&&(e.allDay=!0,e.durationEditable=!1),t.push(e)}),Strack.G.calendarLockDateList=a.lock_date_list,Strack.G.calendarTaskRemainderLime={plan_available_time:a.task_remainder_time,task_remainder_end_time:a.task_remainder_end_time},a.page_auth_rules.list.forEach(function(e){var t=Strack.deep_copy(a.page_auth_rules.base);t.event_id=e.event_id,t.item_id=e.item_id,t.entity_id=e.entity_id,t.project_id=e.project_id,t.template_id=e.template_id,Strack.G.myScheduleSideParam[e.event_id]=t}),Strack.toggle_task_plan_lock_bnt(a.lock_bnt_status),i(t)}})},select:function(e,t,a,i,d){},eventClick:function(e,t,a){if($(t.target).hasClass("fc-h-event-copy")||0<$(t.target).closest(".fc-h-event-copy").length){var i=$(a.el[0]).closest(".my-scheduler-index").attr("id");Strack.copy_calendar_plan(t,e,i)}if($(t.target).hasClass("fc-h-event-del")||0<$(t.target).closest(".fc-h-event-del").length){var d=$(t.target).closest(".fc-h-event-del").data("id");i=$(a.el[0]).closest(".my-scheduler-index").attr("id");Strack.del_calendar_plan(t,e,i,d)}},contextmenu:function(e,t,a){"base"===e.type&&"yes"===i.rule_schedule_delete_task&&(Strack.G.myScheduleDeleteTaskData=e,$("#my_schedule_rmenu").menu("show",{left:t.pageX,top:t.pageY}))},eventDBClick:function(e,t,a){0===$(t.target).closest(".item-list-pt").length&&Strack.open_datagrid_slider(Strack.G.myScheduleSideParam[e.id])},eventResize:function(e,t,a,i,d,r){n&&Strack.update_scheduler_event(e)},eventDrop:function(e,t,a,i,d,r){if(n)if(e.allDay||"yes"!==e.is_all_day)Strack.update_scheduler_event(e);else{var o=$(r.el[0]).closest(".my-scheduler-index").attr("id");Strack.add_scheduler_task_plan_event(e,o)}},eventMouseover:function(e,t,a){},eventMouseout:function(e,t,a){}})},toggle_task_plan_lock_bnt:function(e){var t=$(".fc-lock-plan a");"agendaDay"===t.attr("data-view")&&(e?t.show().attr("data-mode","unlock").removeClass("blue").addClass("red").html('<i class="icon-uniE9B9 icon-left"></i>'+StrackLang.UnLock_Task_Plan):t.show().attr("data-mode","lock").removeClass("red").addClass("blue").html('<i class="icon-uniE9B8 icon-left"></i>'+StrackLang.Lock_Task_Plan))},filter_fullCalendar_data:function(e){var t=$(e).closest(".my-scheduler-index").attr("id"),a=$(e).data("filter");$(".fc-filter-bnt-ac").removeClass("active"),a&&$(e).addClass("active"),Strack.reload_fullCalendar_data(t,a)},reload_fullCalendar_data:function(e,t){t&&(Strack.G.calendarEventsFilter=t),Strack.G.calendarLoadMode="refetchEvents",$("#"+e).fullCalendar("refetchEvents")},update_kanban_issue:function(e,t){Strack.submit_update_item("",!0,e,t)},add_scheduler_task_plan_event:function(e,t){var a=0,i=0;e.start&&(a=e.start.format()),i=e.end?e.end.format():e.start.format();var d={lock:"no",link_id:e.item_id,start_time:a,end_time:i,estimate_append:e.estimate_working_hours_val,operation:"add"};Strack.add_scheduler_task_plan_event_update(d,t,!1)},add_scheduler_task_plan_event_update:function(e,t,a){$.ajax({type:"POST",url:StrackPHP.addTaskPlan,data:JSON.stringify(e),dataType:"json",contentType:"application/json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.reload_fullCalendar_data(t),a&&Strack.dialog_cancel()):($.messager.progress("close"),layer.msg(e.message,{icon:7,time:1200,anim:6}))}})},update_scheduler_event:function(e){var t={};t[e.table_name]=[];var a="",i="";i="event"===e.event_type?(a="start_time","end_time"):(a="plan_start_time","plan_end_time"),e.allDay?(t[e.table_name].push({field:e.table_name+"-"+a,field_type:"built_in",value:e.start.format(),variable_id:0}),t[e.table_name].push({field:e.table_name+"-"+i,field_type:"built_in",value:0,variable_id:0})):(e.start&&t[e.table_name].push({field:e.table_name+"-"+a,field_type:"built_in",value:e.start.format(),variable_id:0}),e.end?t[e.table_name].push({field:e.table_name+"-"+i,field_type:"built_in",value:e.end.format(),variable_id:0}):t[e.table_name].push({field:e.table_name+"-"+i,field_type:"built_in",value:e.start.format(),variable_id:0})),Strack.submit_update_item("",!0,{from_item_id:"0",from_module_id:"0",mode:"modify",module_id:e.module_id,page:e.page,primary_id:e.item_id,project_id:e.project_id,type:"update_panel"},t)},show_scheduler_tips:function(e,t){},close_schedule_slider:function(e){$("#schedule_list_slider").sidebar("toggle")},load_sidebar_action_list:function(i){$.ajax({type:"POST",url:StrackPHP.getSidebarActionData,dataType:"json",data:i,beforeSend:function(){$("#action_list_slider").append(Strack.loading_dom("white","","action"))},success:function(e){var t="",a="";e.common.forEach(function(e){t+=Strack.action_list_item_dom(e,i,"common")}),e.other.forEach(function(e){a+=Strack.action_list_item_dom(e,i,"other")}),$("#common_action_list").empty().append(t),$("#other_action_list").empty().append(a),$("#st-load_action").remove()}})},action_list_item_dom:function(e,t,a){var i="",d="other"===a?StrackLang.Set_Action_Common:StrackLang.Cancel_Action_Common;return i+='<div class="column dgat-item"><a href="javascript:;" class="dgat-img" onclick="Strack.click_run_action(this)" data-from="'+t.from+'" data-grid="'+t.grid+'" data-actionid="'+e.id+'" data-moduleid="'+e.module_id+'"><div class="action-icon"><div class="soft-avatar"><img src="'+e.thumb+'"></div></div></a><div class="dgat-dcname"><strong>'+e.name+'</strong></div><div class="dgat-dcname">'+e.version+'</div><div class="dgat-bnt" ><a href="javascript:;" onclick="Strack.toggle_action_common(this)" data-type="'+a+'" data-actionid="'+e.id+'" data-moduleid="'+e.module_id+'">'+d+"</a></div></div>"},toggle_action_common:function(e){var t=$(e).data("type"),a=$(e).data("actionid"),i=$(e).data("moduleid"),d="common"===t?"cancel":"set";$.ajax({type:"POST",url:StrackPHP.setActionCommonStatus,data:{mode:d,action_id:a,module_id:i},dataType:"json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.search_action(Strack.get_obj_by_id("action_search_bnt"))):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},close_action_slider:function(e){$("#action_list_slider").sidebar("toggle")},click_run_action:function(s){Strack.Websocket.init("action",{url:"ws://localhost:9888",afterInit:function(e){if("error"===e.status)layer.msg(e.message,{icon:7,time:1200,anim:6});else{var t=$(s).data("from"),a=$(s).data("actionid"),i=$(s).data("moduleid");switch(t){case"grid_edit":case"grid":var d=$(s).data("grid"),r=$("#"+d).datagrid("getSelections");if(0<r.length){var o=[];r.forEach(function(e){o.push(e.id)}),Strack.run_action({action_id:a,module_id:i,link_ids:o})}else layer.msg(StrackLang.Please_Select_Grid_One,{icon:2,time:1200,anim:6});break;default:var n=$("#action_search_bnt").data("ids");Strack.run_action({action_id:a,module_id:i,link_ids:n})}}}})},run_action:function(t){$.ajax({type:"POST",url:StrackPHP.getActionModuleData,dataType:"json",contentType:"application/json",data:JSON.stringify(t),beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),Strack.Websocket.List.action.send(JSON.stringify({action_id:t.action_id,link_ids:t.link_ids,module_data:e}))}})},word_limit:function(e,t){return t<e.length?e.substr(0,t)+"...":e},format_step_task:function(a){var i,d,r="",o={};return a.field_data&&a.field_data.forEach(function(e,t){"thumb"===a.config.fields&&"media"===a.config.module_code?(i=a.config.field.replace("thumb","param"),d=a.row_data[i][t].fields.value,e.fields.value&&d?o[a.config.fields]={total:1,rows:[{id:0,param:JSON.parse(d),thumb:e.fields.value}]}:o[a.config.fields]={total:0,rows:[]}):o[a.config.fields]=e.fields.value,r+=Strack.widget_input_dom(a.config,e.primary.value,Strack.widget_input_value(a.config,o,a.project_id,!1,{primary:e.primary.value,module_id:a.module_id,from:"grid"}),"grid",!1,{module_id:e.module_id,url:e.url})}),r},generate_grid_columns_config:function(col_config,param,columns_field_config,step_first_col_status){var cols=[];return col_config.forEach(function(val){if(val.step){if(val.hidden&&step_first_col_status[val.belong])return!1;val.formatter=function(e,t,a){return Strack.format_step_task({project_id:param.project_id,module_id:param.task_module_id,config:columns_field_config[val.field],field_data:e,row_data:t})}}else if(val.outreach_formatter&&(val.formatter=function(value,row,index){return eval(val.outreach_formatter)}),"yes"===val.is_has_many&&(val.formatter=function(e,t,a){if(e&&0<e.total){var i=[];return e.rows.forEach(function(e){i.push(e.name)}),i.join(" , ")}return""}),"custom"===val.field_type)switch(val.custom_type){case"belong_to":switch(val.custom_config.relation_module_code){case"media":val.formatter=function(e,t,a){return e&&0<e.total?Strack.build_grid_preview_thumb_dom({id:t.id,thumb:e.rows[0].thumb,param:e.rows[0].param,module_id:param.module_id,field_type:"horizontal",field_config:columns_field_config[val.field]}):Strack.build_grid_preview_thumb_dom({id:t.id,thumb:null,param:null,module_id:param.module_id,field_type:"horizontal",field_config:columns_field_config[val.field]})};break;case"status":val.formatter=function(e,t,a){return e&&0<e.total?Strack.widget_status_dom(e.rows[0].icon,e.rows[0].name,e.rows[0].color):""}}break;case"checkbox":val.formatter=function(e,t,a){return"on"===e?StrackLang.Checked:StrackLang.UnChecked}}else!val.step&&"media"===val.module_code&&0<=val.field.indexOf("thumb")&&(val.formatter=function(e,t,a){var i=val.field.replace("thumb","param");return e&&t[i]?Strack.build_grid_preview_thumb_dom({id:t.id,thumb:e,param:t[i],module_id:param.module_id,field_type:"direct",field_config:columns_field_config[val.field]}):Strack.build_grid_preview_thumb_dom({id:t.id,thumb:null,param:null,module_id:param.module_id,field_type:"direct",field_config:columns_field_config[val.field]})});if(val.editor)switch(val.editor.type){case"tagbox":var query_params={primary:0,add_default:"no",project_id:param.project_id,module:val.module,field_type:val.field_type,fields:val.field,variable_id:val.variable_id,frozen_module:val.frozen_module,flg_module:val.flg_module,data_source:val.data_source,module_id:param.module_id};val.editor.options={height:"auto",valueField:"id",textField:"name",method:"post",url:StrackPHP.getWidgetData,hasDownArrow:!0,limitToList:!0,queryParams:query_params},"tag"===val.module&&(val.editor.options.limitToList=!1,val.editor.options.allowInput=!0,val.editor.options.appendToDB={allow:!0,param:query_params}),val.group&&(val.editor.options.groupField="group");break;case"combobox":val.editor.options={height:31,valueField:"id",textField:"name",method:"post",url:StrackPHP.getWidgetData,queryParams:{primary:0,project_id:param.project_id,module:val.module,field_type:val.field_type,fields:val.field,variable_id:val.variable_id,frozen_module:val.frozen_module,flg_module:val.flg_module,data_source:val.data_source,module_id:param.module_id}},val.group&&(val.editor.options.groupField="group")}cols.push(val)}),cols},load_grid_columns:function(e,t,a){var i=t.loading_type?t.loading_type:"white";$.ajax({type:"POST",url:StrackPHP.getGridColumns,data:t,dataType:"json",beforeSend:function(){$(t.loading_id).append(Strack.loading_dom(i,"","grid_columns"))},success:function(e){200===parseInt(e.status)&&(e=Strack.generate_grid_columns_data(t,e)),a(e),$("#st-load_grid_columns").remove()}})},generate_schema_page:function(e){var t="";switch(e){case"correlation_base":t="project_base";break;case"user":t="admin_account";break;case"action":t="admin_action";break;case"eventlog":t="admin_eventlog";break;default:t="project_"+e}return t},generate_grid_columns_data:function(e,t){var a,i,d=0,r=0;Strack.G.dataGridStepColunmsConfig[e.grid_id]={step_list:[],step_columns:{}},t.grid.step_columns_config.step_list&&t.grid.step_columns_config.step_list.forEach(function(a){Strack.G.dataGridStepColunmsConfig[e.grid_id].step_columns[a.code]={},Strack.G.dataGridStepColunmsConfig[e.grid_id].step_list.push(a.code);var i,d="",r=[],o=[],n="",s="",l={},c=0;0<(i=t.grid.step_columns_config.step_fields.length)&&(t.grid.step_columns_config.step_fields.forEach(function(e,t){c=e.width?e.width:160,s=e.module_code+"_"+e.fields,n=a.code+"_"+s,l={field:n,title:e.lang,align:"center",width:c,findex:t+1,hidden:!0,drag:!1,step:!0,step_index:"",belong:a.code},0===t?(l.bdc=a.color,l.cbd="colboth",l.cellClass="datagrid-cell-c1-"+n,l.deltaWidth=1,l.hidden=!1,l.step_index="first",d=s):r.push(s),t===i-1&&(l.bdc=a.color,l.cbd="colright",l.cellClass="datagrid-cell-c1-"+n,l.deltaWidth=1,l.step_index="last"),o.push(l)}),Strack.G.dataGridStepColunmsConfig[e.grid_id].step_columns[a.code]={first:{bgc:a.color,but:a.code,class:a.code+"_h",colspan:1,fhcol:!0,fname:a.code,step:"yes",title:a.name,first_field:d,field_list:r.join(",")},second:o})});var o=t.grid.columnsFieldConfig;if(1===t.grid.columns.length)d=0,a=t.grid.columns[0];else{d=1,a=t.grid.columns[1];var n=[],s={};t.grid.columns[0].forEach(function(e){"yes"===e.step?"yes"!==e.hidden_status?(n.push(e),s[e.fname]=!1):s[e.fname]=!0:n.push(e)}),t.grid.columns[0]=n}return t.grid.columns[d]=Strack.generate_grid_columns_config(a,e,o,s),i=1===t.grid.frozenColumns.length?(r=0,t.grid.frozenColumns[0]):(r=1,t.grid.frozenColumns[1]),t.grid.frozenColumns[r]=Strack.generate_grid_columns_config(i,e,o,s),t},generate_grid_right_menu:function(a){var i,d,r=[],o="",n=[],s="",l="";return $(a.contextMenuData.edit_id).children(".item").each(function(){if(i="right_menu_"+Math.floor(1e6*Math.random()+1),"DIV"===$(this).prop("tagName")){o=$(this).attr("data-lang");var e={id:i,lang:o,iconCls:"",type:"button",click:"",children:[]},t=[];$(this).find(".group-field").each(function(){i="right_menu_item"+Math.floor(1e6*Math.random()+1),o=Strack.trim_spaces($(this).text(),"g"),d=$(this).attr("onclick"),t.push({id:i,lang:o,iconCls:"",type:"function",click:d,attr_data:{grid:a.id,moduleid:a.moduleId}})}),0<t.length&&(e.children=t,r.push(e))}else o=Strack.trim_spaces($(this).text(),"g"),l=$(this).attr("data-lang"),n=$(this).find("i").attr("class"),s=n?n.split(" ")[0]:"",d=$(this).attr("onclick"),r.push({id:i,lang:o,iconCls:s,type:"function",click:d,attr_data:{lang:l,grid:a.id,moduleid:a.moduleId}})}),r.push({id:"ac_copy_cell",lang:StrackLang.Copy_Grip_Cell,iconCls:"icon-uniE943",type:"function",click:"Strack.copy_to_clipboard(this)",attr_data:{"clipboard-action":"copy","clipboard-target":"#grid_clipboard"}}),r},right_menu_dom:function(e){if(0===$("#"+e.id).length){var t="";e.data.forEach(function(e){e.children?t+=Strack.menu_item_dom("multi",e):t+=Strack.menu_item_dom("single",e)}),$("body").append('<div id="'+e.id+'" class="easyui-menu">'+t+"</div>"),$("#"+e.id).menu({itemHeight:28,minWidth:160}),e.copy_id&&new Clipboard("#st_menu_"+e.copy_id)}},menu_item_dom:function(e,t){var a="",i="iconCls:'"+t.iconCls+"'";switch(e){case"single":a+='<div id="st_menu_'+t.id+'" data-options="'+i+'" '+Strack.menu_item_atrr(t)+">"+t.lang+"</div>";break;case"multi":var d="";a+='<div id="st_menu_'+t.id+'" data-options="'+i+'" '+Strack.menu_item_atrr(t)+">"+t.lang+"<div>",t.children.forEach(function(e){d="iconCls:'"+e.iconCls+"'",a+='<div id="st_menu_'+e.id+'" data-options="'+d+'" '+Strack.menu_item_atrr(e)+">"+e.lang+"</div>"}),a+="</div></div>"}return a},menu_item_atrr:function(e){var t="";switch(e.type){case"function":for(var a in t+='onclick="'+e.click+'"',e.attr_data)t+=" data-"+a+'="'+e.attr_data[a]+'"'}return t},load_view_config:function(e,i,d){$.ajax({type:"POST",url:StrackPHP.getListViewConfig,data:i,dataType:"json",success:function(e){var t=$("#"+i.tool_id),a=t.find(".grid_sort");a.append(Strack.toolbar_down_init("sort",i.module_code,e.sort_list,i.opts,"list")),Strack.init_show_sort_down_icon(a,e.sort_config.sort_data,e.sort_config.sort_type),t.find(".grid_group").append(Strack.toolbar_down_init("group",i.module_code,e.group_list,i.opts,"list")),t.find(".grid_view").append(Strack.toolbar_view_init("view",e.view_list,"list")),d(e)}})},toolbar_down_init:function(d,e,t,r){var a,o="";"show"===d&&(Strack.G.gridFieldCache[t.toolbarConfig.page]={});var n={grouping_of_persons:{icon:"icon-uniF007",lang:StrackLang.Persons_View_Mode},grouping_of_stage:{icon:"icon-uniE9C6",lang:StrackLang.Stage_View_Mode},status:{icon:"icon-uniE9D0",lang:StrackLang.Status_View_Mode}};for(var i in e)for(var s in e[i])$.isEmptyObject(e[i][s].fields)||(t.isKanban?e[i][s].fields.forEach(function(e){if("yes"===e.can_use_kanban_view){var t="",a="",i="basic blue";a="status"===e.module?(t=n.status.icon,n.status.lang):(t=n[e.kanban_view_mode].icon,n[e.kanban_view_mode].lang),e.is_checked&&(i="green"),o+='<div class="aign-left"><a href="javascript:;" class="ui '+i+' button view-kanban-mode" onclick="Strack.toggle_kanban_view(this);" data-panel="'+r+'" panel="'+r+'" from="'+d+'" field="'+e.fields+'" field_type="'+e.field_type+'" field_width="'+e.width+'" field_sort="'+e.sort+'" field_edit="'+e.edit+'" module="'+e.module+'" table="'+e.table+'" module_code="'+e.module_code+'" module_type="'+e.module_type+'" belong="'+e.belong+'" editor="'+e.editor+'" lang="'+e.lang+'" value_show="'+e.value_show+'" can_use_kanban="'+e.can_use_kanban_view+'"><i class="icon-left '+t+'"></i>'+a+"</a></div>"}}):(a="",e[i][s].fields.forEach(function(e){a+=Strack.toolbar_down_item(d,e,r),"show"===d&&(Strack.G.gridFieldCache[t.toolbarConfig.page][e.value_show]=e)}),o+='<div class="divider custom-menu-item"></div>',o+=Strack.toolbar_down_other(e[i][s].title,a)));return o},toolbar_down_other:function(e,t){var a="";return a+='<div class="item custom-menu-item"><i class="dropdown icon"></i>'+e+'<div class="menu st-down-menu">'+t+"</div></div>"},toolbar_down_item:function(e,t,a){var i="",d=e+"_"+t.module+"_"+t.fields,r=t.is_checked?"icon-checked":"icon-unchecked",o=e+"-field",n="";return"group"===e&&"yes"===t.can_use_kanban_view&&(n='<span class="can-use-kanban icon-uniE6E7"></span>'),i+='<a href="javascript:;" id="'+d+'" class="item '+o+'" onclick="Strack.click_down_item(this);" panel="'+a+'" from="'+e+'" field="'+t.fields+'" field_type="'+t.field_type+'" field_width="'+t.width+'" field_sort="'+t.sort+'" field_edit="'+t.edit+'" module="'+t.module+'" table="'+t.table+'" module_code="'+t.module_code+'" module_type="'+t.module_type+'" belong="'+t.belong+'" editor="'+t.editor+'" lang="'+t.lang+'" value_show="'+t.value_show+'" can_use_kanban="'+t.can_use_kanban_view+'"><i class="icon-left '+r+'"></i>'+t.lang+n+"</a>"},toolbar_step_init:function(e,t,a,i){var d="";return t.forEach(function(e){d+=Strack.toolbar_step_dom(e,a)}),d},toolbar_step_dom:function(e,t){var a="",i="";e.is_checked?a='<i class="icon-uniEA39"></i>':i="hide";var d="";return d+='<a href="javascript:;" id="stid_'+e.code+'" class="item steps_box custom-menu-item '+i+'" onclick="Strack.toggle_steps(this);" data-step="'+e.code+'" data-stepid="'+e.id+'" data-grid="'+t.id+'" data-maindom="'+t.searchConfig.filterBar.main_dom+'"><div class="steps_box_icon">'+a+'</div><div class="steps_box_color" style="background-color:#'+e.color+'"></div><div class="steps_box_name">'+e.name+"</div></a>"},toolbar_common_action:function(t,a,e){var i="";return e.forEach(function(e){e.grid=t,e.module_id=a.moduleId,i+=Strack.common_action_dom("grid_edit",e)}),i},common_action_dom:function(e,t){var a="",i=t.link_id?t.link_id:0;return a+='<a href="javascript:;" class="item group-field" onclick="Strack.click_run_action(this);" data-from="'+e+'" data-grid="'+t.grid+'" data-actionid="'+t.id+'" data-linkid="'+i+'" data-moduleid="'+t.module_id+'">'+t.name+"</a>"},show_all_steps:function(e){var t={mode:"show_all",grid:$(e).data("grid"),maindom:$(e).data("maindom")};Strack.show_or_hide_steps(t)},hide_all_steps:function(e){var t={mode:"hide_all",grid:$(e).data("grid"),maindom:$(e).data("maindom")};Strack.show_or_hide_steps(t)},toggle_steps:function(e){var t={mode:"",step:$(e).data("step"),step_id:$(e).data("stepid"),grid:$(e).data("grid"),maindom:$(e).data("maindom")};$(e).hasClass("hide")?(t.mode="show",$(e).removeClass("hide")):(t.mode="hide",$(e).addClass("hide")),Strack.show_or_hide_steps(t)},show_or_hide_steps:function(a){var i,d=$("#"+a.grid),e=d.datagrid("options"),t=e.columns.length,r=e.columns[t-1],o=[];switch(r.forEach(function(e){e.step&&(0<=$.inArray(a.mode,["show","hide"])&&e.belong===a.step||0<=$.inArray(a.mode,["hide_all","show_all"]))&&o.push({field:e.field,belong:e.belong})}),a.mode){case"show":var n;if(0<(i=$("."+a.step+"_h")).length)o.forEach(function(e){i.is(":hidden")&&e.belong===a.step&&(i.show(),d.datagrid("showColumn",e.field),1<i.attr("colspan")&&(n=i.find(".colswitch").data("fieldlist"),n.split(",").forEach(function(e){d.datagrid("showColumn",a.step+"_"+e)})))});else{var s=Strack.G.dataGridStepColunmsConfig[a.grid].step_columns[a.step];$.isEmptyObject(s)||d.datagrid("appendStepColumn",s).datagrid("reload")}break;case"hide":o.forEach(function(e){e.belong===a.step&&(d.datagrid("hideColumn",e.field),$("."+e.belong+"_h").hide())});break;case"show_all":var l=Strack.G.dataGridStepColunmsConfig[a.grid].step_list,c=!1,_={};o.forEach(function(e){_.hasOwnProperty(e.belong)||(_[e.belong]=e)}),l.forEach(function(t){if(0<(i=$("."+t+"_h")).length)i.is(":hidden")&&(i.show(),d.datagrid("showColumn",_[t].field),1<i.attr("colspan")&&(n=i.find(".colswitch").data("fieldlist"),n.split(",").forEach(function(e){d.datagrid("showColumn",t+"_"+e)})));else{c=!0;var e=Strack.G.dataGridStepColunmsConfig[a.grid].step_columns[t];$.isEmptyObject(e)||d.datagrid("appendStepColumn",e)}}),c&&d.datagrid("reload");break;case"hide_all":o.forEach(function(e){d.datagrid("hideColumn",e.field),$("."+e.belong+"_h").hide()})}Strack.show_or_hide_steps_icon(a)},show_or_hide_steps_icon:function(e){var t;$("#"+e.maindom).find(".steps_box").each(function(){switch(t=$(this).data("step"),e.mode){case"show":e.step===t&&$(this).find(".steps_box_icon").html('<i class="icon-uniEA39"></i>');break;case"hide":e.step===t&&$(this).find(".steps_box_icon").empty();break;case"show_all":$(this).find(".steps_box_icon").html('<i class="icon-uniEA39"></i>');break;case"hide_all":$(this).find(".steps_box_icon").empty()}})},show_or_hide_grid_step:function(e){var t=$(e);t.html('<div class="ui active centered mini inline loader"></div>');var a=t.data("grid"),i=$("#"+a),d=t.attr("data-col"),r=(t.attr("data-color"),t.attr("data-firstfield")),o=t.attr("data-fieldlist").split(","),n=[];if(0<o.length){o.forEach(function(e){n.push(d+"_"+e)});var s=0;t.hasClass("showcol")?(s=1,t.removeClass("showcol").parent().parent().attr("colspan",s),$("td[field="+d+"_"+r+"]").removeClass("colleft").addClass("colboth"),setTimeout(function(){t.html('<i class="icon-uniF101"></i>')},200)):(s=n.length+1,t.addClass("showcol").parent().parent().attr("colspan",s),$("td[field="+d+"_"+r+"]").removeClass("colboth").addClass("colleft"),setTimeout(function(){t.html('<i class="icon-uniF100"></i>')},200)),i.datagrid("ResetStepColumnColspan",{step:d,colspan:s,field_list:n})}},toolbar_view_init:function(t,e,a){var i="",d="",r="";return $.isEmptyObject(e)||(e.views.forEach(function(e){e.checked||$(".grid_view_mode").attr("view_mode",e.view_mode).html("切换到"+e.name)}),r+='<div class="divider custom-menu-item"></div>',r+=Strack.toolbar_view_item(t,e.checked,"view-g-active",a),$(".current_view").text("（"+e.checked.name+"）"),e.self.forEach(function(e){i+=Strack.toolbar_view_item(t,e,"",a)}),r+='<div class="divider custom-menu-item"></div>',r+=Strack.toolbar_down_other(StrackLang.Self_View,i),e.public.forEach(function(e){d+=Strack.toolbar_view_item(t,e,"",a)}),r+='<div class="divider custom-menu-item"></div>',r+=Strack.toolbar_down_other(StrackLang.Public_View,d)),r},toolbar_view_mode_item:function(e,t,a,i){var d="",r=t.checked?"icon-checked":"icon-unchecked";return d+='<a href="javascript:;" class="item view-mode-item custom-menu-item '+a+'" onclick="Strack.click_view_mode_item(this);" data-panel="'+i+'" from="view_mode" view_mode="'+t.view_mode+'" ><i class="icon-left '+r+'"></i>'+t.name+"</a>"},toolbar_view_item:function(e,t,a,i){var d="",r=t.checked?"icon-checked":"icon-unchecked",o=t.show_artist?'<span style="color: #777"> ( '+t.user_name+" ) </span>":"";return d+='<a href="javascript:;" class="item view-g-item custom-menu-item '+a+'" onclick="Strack.click_down_item(this);" panel="'+i+'" from="'+e+'" view_id="'+t.id+'" view_name="'+t.name+'" view_public="'+t.public+'" allow_edit="'+t.allow_edit+'"><i class="icon-left '+r+'"></i>'+t.name+o+"</a>"},build_view_toolbar:function(t,a){$.ajax({type:"POST",url:StrackPHP.getViewData,dataType:"json",data:{module_id:t.module_id,structure_id:t.structure_id,tab_name:t.tab_name},success:function(e){Strack.build_toolbar_sort(t,e.sort_fields),Strack.build_toolbar_group(t,e.group_fields),a(e)}})},build_toolbar_sort:function(t,e){var a=$("#"+t.tab_name+"_sort_"+t.structure_id),i="";if(0<a.length){switch(t.tab_name){case"list":e.forEach(function(e){i+=Strack.sort_field_dow(t,e)})}a.empty().append(i)}},sort_field_dow:function(e,t){var a="";return a+='<a href="javascript:;" id="sort_field_'+e.tab_name+"_"+e.structure_id+"_"+t.field+'" class="item sort_fields" onclick="Strack.sort_change(this);" data-field="'+t.field+'" data-pid="'+t.p_id+'" data-structureid="'+t.structure_id+'" data-grid="'+t.grid+'"><i class="icon-left sort_list icon-unchecked"></i>'+t.lang+"</a>"},build_toolbar_group:function(t,e){var a=$("#"+t.tab_name+"_group_"+t.structure_id),i="";if(0<a.length){switch(t.tab_name){case"list":e.forEach(function(e){i+=Strack.group_field_dow(t,e)})}a.empty().append(i)}},group_field_dow:function(e,t){var a="";return a+='<a href="javascript:;" id="group_field_'+e.tab_name+"_"+e.structure_id+"_"+t.field+'" onclick="Strack.group_sort_change(this);" data-field="'+t.field+'" data-pid="'+t.p_id+'" data-structureid="'+t.structure_id+'" data-grid="'+t.grid+'"><i class="icon-left filter_list icon-unchecked"></i>'+t.lang+"</a>"},project_warn:function(e){return'<div class="page-warning"><i class="icon-uniF071"></i>'+e+"</div>"},init_breadcrumb:function(a,i,d){$.ajax({type:"POST",url:StrackPHP.getModuleBreadcrumb,dataType:"json",data:i,beforeSend:function(){$("#"+a).append(Strack.loading_dom("white","","breadcrumb"))},success:function(e){var t=Strack.breadcrumb_dom(e,i);$("#"+a).empty().append(t),d&&d(t)}})},details_url:function(e,t){return Strack.remove_html_ext(StrackPHP.details)+"/"+e.module_id+"-"+e.project_id+"-"+t+".html"},breadcrumb_dom:function(e,t){var a=[],i=Strack.remove_html_ext(StrackPHP.details);return e.forEach(function(e){"no"===e.is_self?"no"===e.is_details?a.push('<a class="section" href="'+e.url+'" title="('+e.module_lang+") "+e.name+'" target="_blank">('+e.module_lang+") "+e.name+"</a>"):a.push('<a class="section" href="'+i+"/"+e.module_id+"-"+t.project_id+"-"+e.item_id+'.html" title="('+e.module_lang+") "+e.name+'" target="_blank">('+e.module_lang+") "+e.name+"</a>"):a.push('<div class="section" title="'+e.name+'">'+e.name+"</div>")}),'<div class="ui small breadcrumb" >'+a.join('<div class="divider"> / </div>')+"</div>"},init_tab_list:function(t,a,i){$.ajax({type:"POST",url:StrackPHP.getTabConfig,dataType:"json",data:a,beforeSend:function(){$("#"+t).append(Strack.loading_dom("white","","tab"))},success:function(e){Strack.generate_tab_list(t,a,e),i(e),$("#st-load_tab").remove()}})},generate_tab_list:function(t,e,a){var i=$("#"+t),d=i.find(".tabs-tab-list"),r="";0<a.length&&a.forEach(function(e){r+=Strack.tab_item_dom(t,e)}),"yes"===e.rule_template_fixed_tab&&(r+=Strack.tab_item_config_dom(e)),d.empty().append(r),Strack.tab_auto_hide(i);var o=0;o="details"===i.attr("data-pos")?document.body.clientWidth:i.width(),d[0].scrollWidth>o&&i.addClass("tabs-nav-container-scrolling")},tab_auto_hide:function(e){var t=e.find(".tabs-tab-prev"),a=e.find(".tabs-tab-next");e.on("mresize",function(){Strack.init_tab_scrolling(e,t,a)})},tab_item_dom:function(e,t){var a="",i="be_horizontal_relationship"===t.type?'<i class="icon-uniE692 icon-left"></i>'+t.name:t.name;return a+='<a href="javascript:;" id="'+t.tab_id+'" class="item tab_item" onclick="Strack.select_tab_item(this);"  data-parentid="'+e+'" data-horizontaltype="'+t.horizontal_type+'" data-table="'+t.table+'" data-tabid="'+t.tab_id+'" data-group="'+t.group+'" data-type="'+t.type+'" data-moduleid="'+t.module_id+'"  data-dstmoduleid="'+t.dst_module_id+'"  data-dstmodulecode="'+t.dst_module_code+'" data-variableid="'+t.variable_id+'" data-modulecode="'+t.module_code+'" data-moduletype="'+t.module_type+'">'+i+"</a>"},tab_item_config_dom:function(e){var t="";return t+='<a href="javascript:;" class="item tab_item" onclick="Strack.tab_item_config(this);" data-itemid="'+e.item_id+'" data-moduleid="'+e.module_id+'" data-modulecode="'+e.module_code+'" data-templateid="'+e.template_id+'" data-projectid="'+e.project_id+'"><i class="icon-uniF013 icon-left"></i>'+StrackLang.Template_Fixed_Tab+"</a>"},tab_item_config:function(e){var t=StrackLang.Template_Fixed_Tab,a=$(e).attr("data-moduleid"),i=$(e).attr("data-itemid"),d=$(e).attr("data-modulecode"),r=$(e).attr("data-templateid"),o=$(e).attr("data-projectid"),n=$(e).closest(".projitem-footer").attr("data-pos");Strack.template_set_dialog({datalist_url:StrackPHP.getModuleTabList,config_url:StrackPHP.getTemplateConfig,title:t,item_id:i,temp_id:r,module_code:d,module_id:a,project_id:o,category:"tab",id_field:"tab_id",text_field:"name",text_field_lang:StrackLang.Tab,group:"group",limit:0,submit_bnt:"update_details_tab_set",pos:n})},select_tab_item:function(e){var t=$(e).html(),a=$(e).attr("data-parentid"),i=$(e).attr("data-tabid"),d=$(e).attr("data-moduleid"),r=$(e).attr("data-moduletype"),o=$(e).attr("data-dstmoduleid"),n=$(e).attr("data-dstmodulecode"),s=$(e).attr("data-modulecode"),l=$(e).attr("data-variableid"),c=$(e).attr("data-type"),_=$(e).attr("data-group"),m=$(e).attr("data-horizontaltype"),u=$(e).attr("data-table");switch(a){case"details_tab":obj.show_details_tab_page({tab_id:i,name:t,type:c,group:_,module_id:d,module_type:r,dst_module_id:o,dst_module_code:n,variable_id:l,module_code:s,horizontal_type:m,table:u});break;case"grid_slider_tab":Strack.show_datagrid_slider_tab({tab_id:i,name:t,type:c,group:_,module_id:d,dst_module_id:o,dst_module_code:n,module_code:s,variable_id:l,horizontal_type:m,table:u})}},active_select_tab:function(e,t){$("#"+e).find(".tabs-tab-list .tab_item").each(function(){$(this).attr("data-tabid")===t?$(this).addClass("active"):$(this).removeClass("active")})},init_tab_scrolling:function(e,t,a){var i=0,d=e.find(".tabs-tab-list"),r=d[0].scrollWidth;Strack.G.leftScrolling=0,d.scrollLeft(0),t.addClass("tabs-tab-btn-disabled"),a.removeClass("tabs-tab-btn-disabled");("details"===e.attr("data-pos")?document.body.clientWidth:e.width())<r?e.hasClass("scrolling_active")||(e.addClass("scrolling_active"),e.addClass("tabs-nav-container-scrolling"),t.addClass("tabs-tab-arrow-show").addClass("tabs-tab-btn-disabled").on("click",function(){$(this).hasClass("tabs-tab-btn-disabled")||(i=d.width(),0<Strack.G.leftScrolling&&(Strack.G.leftScrolling=d.scrollLeft()-i,d.scrollLeft(Strack.G.leftScrolling),a.removeClass("tabs-tab-btn-disabled"),Strack.G.leftScrolling<=0&&t.addClass("tabs-tab-btn-disabled")))}),a.addClass("tabs-tab-arrow-show").on("click",function(){$(this).hasClass("tabs-tab-btn-disabled")||(i=d.width(),Strack.G.leftScrolling<=r&&(Strack.G.leftScrolling=i+d.scrollLeft(),d.scrollLeft(Strack.G.leftScrolling),t.removeClass("tabs-tab-btn-disabled"),Strack.G.leftScrolling>=r&&a.addClass("tabs-tab-btn-disabled")))})):(e.removeClass("tabs-nav-container-scrolling"),e.removeClass("scrolling_active"),e.find(".tabs-tab-prev").removeClass("tabs-tab-arrow-show").off("click"),e.find(".tabs-tab-next").removeClass("tabs-tab-arrow-show").off("click"))},dialog_cancel:function(e){if(e){var t=$(e).closest(".window-body").attr("id");$("#"+t).dialog("close")}else $("#dialog").dialog("close")},scheduler_tips:function(a,e){$.ajax({url:StrackPHP.getSchedulerTips,type:"post",data:{resourceId:e},dataType:"json",success:function(e){var t="";e.forEach(function(e){t+="<p>"+e+"</p>"}),layer.tips(t,a,{tips:[3,"#464646"],time:2e4})}})},widget_field_validate:function(t){var a="";return["status_id"].every(function(e){return 0<=t.indexOf(e)?(a=e,!1):(a=t,!0)}),a},widget_input_value:function(e,t,a,i,d){var r=e.value_show,o={value:t[r],project_id:a};if("custom"===e.field_type&&("belong_to"===e.type&&0<=$.inArray(e.relation_module_code,["status","media"])||e.hasOwnProperty("custom_config")&&0<=$.inArray(e.custom_config.relation_module_code,["status","media"]))){switch(e.hasOwnProperty("custom_config")?e.custom_config.relation_module_code:e.relation_module_code){case"status":t[r]&&0<t[r].total?(o.value=t[r].rows[0].id,o.show_val=Strack.widget_status_dom(t[r].rows[0].icon,t[r].rows[0].name,t[r].rows[0].color),o.bg_clolor=t[r].rows[0].color,o.font_set=!0):(o.value="",o.show_val="");break;case"media":o.value="",o.show_val=Strack.thumb_media_common_dom(t[r],{param:d,from:d.from,config:e})}}else{if("custom"===e.field_type&&"has_many"===e.editor_type)if(t[r]&&0<t[r].total){var n=[],s=[];t[r].rows.forEach(function(e){n.push(e.id),s.push(e.name)}),o.value=n.join(","),o.show_val=s.join(",")}else o.value="",o.show_val="";else if("thumb"===e.fields&&"media"===e.module_code)o.value="",o.show_val=Strack.thumb_media_common_dom(t[r],{param:d,from:d.from,config:e});else if(t[r]&&0<=t[r].total){n=[],s=[];0<t[r].total?(t[r].rows.forEach(function(e){n.push(e.id),s.push(e.name)}),o.value=n.join(","),o.show_val=s.join(",")):(o.value="",o.show_val="")}else o.show_val=t[r];o.bg_clolor="",o.font_set=""}return o},generate_widget:function(e,t,a,i,d,r){var o=d||"",n=r||0,s="";if("no"===e.group)e.data.forEach(function(e){"yes"===e.show&&(s+=Strack.widget_input_dom(e,a,Strack.widget_input_value(e,t,i,!1,{primary:a,module_id:n,from:o}),o,!0,{module_id:n}))});else for(var l in e.data)s+='<div class="task-info-names"><i class="icon-uniF05A icon-left"></i>'+StrackLang[l]+"</div>",e.data[l].forEach(function(e){"yes"===e.show&&(s+=Strack.widget_input_dom(e,a,Strack.widget_input_value(e,t,i,!0,{primary:a,module_id:n,from:o}),o,!0,{module_id:n}))});return s},translate_timespinner_val:function(e){var t=0;if(e)if(-1!==e.indexOf(":")){var a=e.split(":");t=60*parseFloat(a[0])+parseFloat(a[1])}else t=parseFloat(e);return t},calculation_progress_bar:function(e,t,a){var i=0,d=0,r="",o="",n=0,s=0,l=0,c=0;a<=t?(d=(i=t)-a,c=a,r="shortage",o="剩余工时",s=0<i?(n=a/i*100).toFixed(2)+"%":"0%",l=100-n):(r="over",o="超时工时",n=100-(l=(d=(i=a)-(c=t))/i*100),s=(100+l).toFixed(2)+"%");var _=100,m=100;e<i?0<i&&(_=e/i*100):0<e&&(m=i/e*100);var u="0px",g="0px",p="0px",f="0px";return 3<n&&(g=n.toFixed(2)+"% - 6px",u="6px"),3<l&&(f=l.toFixed(2)+"% - 6px",p="6px"),{est_progress:{per:_.toFixed(3)+"%",show_val:Strack.format_timespinner_val(e)},actual_plan_progress:{per:m.toFixed(3)+"%",left:{per:g,show_val:Strack.format_timespinner_val(c),show_per:s,padding:u},right:{per:f,show_val:Strack.format_timespinner_val(d),css_name:r,over_name:o,padding:p}}}},format_timespinner_val:function(e){var t="",a=e+"";if(e&&-1!==a.indexOf(":")){var i=a.split(":");t=i[0]+"小时"+i[1]+"分钟"}else{t=parseInt(e/60)+"小时"+parseInt(e%60)+"分钟"}return t},widget_input_dom:function(e,t,a,i,d,r){var o=a.bg_clolor?Strack.hex_to_rgb(a.bg_clolor,.3):"transparent",n=a.font_set?"font-size-10":"",s=r.hasOwnProperty("module_id")?r.module_id:0,l="",c="";c="yes"===e.is_foreign_key?(l=e.foreign_key,e.frozen_module):(l=e.fields,e.module_code);var _,m,u=l+"_"+t+"_"+Math.floor(1e4*Math.random()+1),g="",p=0;switch("custom"===e.field_type&&(p=e.variable_id),_=a.value&&!/^[0-9]+.?[0-9]*$/.test(a.value)?a.value.toString().replace(/\"/g,"&quot;"):a.value?a.value:"",i){case"grid":case"min":m={wrap:"item-list-pt",lang:"item-list-ptn",content:"item-list-input",hide:"icon-hide-min"};break;case"schedule":m={wrap:"item-list-pt",lang:"item-list-ptn",content:"schedule-list-input",hide:"icon-hide-min"};break;case"max":default:m={wrap:"task-info-items",lang:"task-info-title",content:"task-info-content",hide:"icon-hide"}}var f={},h="";switch(e.editor){case"textarea":f.ellipsis="info-textarea",h=a.show_val?Strack.revert_textarea(a.show_val):"";break;case"timespinner":if(a.show_val&&-1!==a.show_val.indexOf(":")){var v=a.show_val.split(":");h=v[0]+"小时"+v[1]+"分钟"}else{var k=parseInt(a.show_val/60),b=parseInt(a.show_val%60);h=k+"小时"+b+"分钟",a.value=k.toFixed(2)+":"+b.toFixed(2)}break;default:f.ellipsis="text-ellipsis",h=a.show_val?a.show_val:""}g+='<div class="'+m.wrap+' overflow-hide">',d&&(g+='<div class="'+m.lang+' aign-left">'+e.lang+"</div>");var S=e.value_show+"_"+t;g+='<div class="widget_input '+m.content+" aign-left item-hover "+S+" "+n+' " style="background-color:'+o+'">';var y="";e.data_source&&(y=e.data_source);var $=e.mask?e.mask:"";("deny"!==e.edit&&(e.from_module_code===e.belong_module&&"none"!==e.editor||e.from_module_code!==e.belong_module&&"none"!==e.outreach_editor)?(g+='<a href="javascript:;" class="aign-right '+m.hide+' widget-edit" onclick="Strack.widget_input_edit(this)"  data-widgetid="'+u+'" data-module="'+e.module+'" data-flgmodule="'+e.flg_module+'" data-table="'+e.table+'" data-ofields='+e.fields+' data-fields="'+l+'" data-fieldtype="'+e.field_type+'" data-value="'+_+'" data-primary="'+t+'"  data-editor="'+e.editor+'" data-mask="'+$+'" data-multiple="'+e.multiple+'" data-projectid="'+a.project_id+'" data-frozenmodule="'+c+'" data-datasource="'+y+'" data-variableid="'+p+'" data-moduleid="'+s+'" data-modulecode="'+e.module_code+'" data-fielduuid="'+S+'">',g+='<i class="icon-uniE684"></i>'):(g+='<a href="javascript:;" class="aign-right '+m.hide+' widget-edit">',g+='<i class="icon-uniE63D2"></i>'),g+="</a>","grid"===i)?"thumb"===e.fields||"custom"===e.field_type&&"media"===e.custom_config.relation_module_code?(g+='<div class=item-list-ptc">',g+=h,g+="</div>"):(g+='<a href="'+(r.hasOwnProperty("url")?r.url:"javascript:;")+'" class="info-content-show  info-grid-content '+f.ellipsis+" widget-show-"+u+'" target="_blank">',g+=h,g+="</a>"):(g+='<div class="info-content-show  '+f.ellipsis+" widget-show-"+u+'">',g+=h,g+="</div>");return g+="</div>",g+="</div>"},widget_input_edit:function(e){var t=$(e).parent().width(),a=$(e).parent().height();a=35<a?35:a;var i=$(e).attr("data-module"),d=$(e).attr("data-frozenmodule"),r=$(e).attr("data-fields"),o=$(e).attr("data-flgmodule"),n=$(e).attr("data-fieldtype"),s=$(e).attr("data-widgetid"),l=$(e).attr("data-value"),c=$(e).attr("data-primary"),_=$(e).attr("data-editor"),m=$(e).attr("data-validate"),u=$(e).attr("data-mask"),g=$(e).attr("data-multiple"),p=$(e).attr("data-datasource"),f=$(e).attr("data-projectid"),h=$(e).attr("data-moduleid"),v=$(e).attr("data-modulecode"),k=$(e).attr("data-variableid"),b="";if(m){var S=m.split(",");b="length["+S[0]+","+S[1]+"]"}switch(_){case"upload":Strack.open_change_item_media({title:StrackLang.Modify_Thumb,link_id:c,module_id:h,mode:"single",from:"common",field_type:n,variable_id:k},function(){});break;default:Strack.widget_edit_active(e,t,a,{module:i,fields:r,flg_module:o,frozen_module:d,field_type:n,widgetid:s,value:l,primary:c,editor:_,validate:b,mask:u,multiple:g,project_id:f,variable_id:k,module_id:h,module_code:v,data_source:p})}},widget_edit_active:function(e,t,a,i){Strack.widget_update();var d,r=$(e),o=r.parent();if(r.hide().next().hide(),o.hasClass("widget-active")){o.addClass("widget-show").find(".info-content-edit").show(),d=o.find(".info-content-edit").find("input").eq(0).attr("id");var n=$("#"+d);switch(i.editor){case"tagbox":i.value&&n.tagbox("setValues",i.value);break;case"combobox":n.combobox("setValue",i.value);break;case"datebox":n.datebox("setValue",i.value);break;case"checkbox":1===parseInt(i.value)?n.prop("checked","checked"):n.removeAttr("checked");break;case"task_repeat":break;default:n.val(i.value)}}else{var s="";switch(d=i.widgetid,i.editor){case"textarea":o.append('<div class="info-content-edit"><textarea id="'+d+'" class="widget-edit" data-module="'+i.module+'" data-field="'+i.fields+'" data-oldval="'+i.value+'" data-fieldtype="'+i.field_type+'" data-widgetid="'+i.widgetid+'"  data-primary="'+i.primary+'"  data-editor="'+i.editor+'" data-variableid="'+i.variable_id+'" data-moduleid="'+i.module_id+'" data-modulecode="'+i.module_code+'" ></textarea></div>').addClass("widget-active widget-show");break;case"task_repeat":var l='<div class="info-content-edit"><a href="javascript:;" id="'+d+'" class="task-repeat ui icon button '+("yes"===i.value?"active":"")+'" onclick="Strack.toggle_task_repeat_editor(this, event)" data-id="'+d+'"><i class="history icon"></i><input id="val_'+d+'" type="hidden" class="widget-edit" data-module="'+i.module+'" data-field="'+i.fields+'" data-oldval="'+i.value+'" data-fieldtype="'+i.field_type+'" data-widgetid="'+i.widgetid+'"  data-primary="'+i.primary+'"  data-editor="'+i.editor+'" data-variableid="'+i.variable_id+'" data-moduleid="'+i.module_id+'" data-modulecode="'+i.module_code+'" /></a></div>';o.append(l).addClass("widget-active widget-show");break;default:0<=$.inArray(i.editor,["input","combobox","datebox"])&&(s="info-content-comb"),o.append('<div class="info-content-edit '+s+'"><input id="'+d+'" class="widget-edit" data-module="'+i.module+'" data-field="'+i.fields+'" data-oldval="'+i.value+'" data-fieldtype="'+i.field_type+'" data-widgetid="'+i.widgetid+'"  data-primary="'+i.primary+'"  data-editor="'+i.editor+'" data-variableid="'+i.variable_id+'" data-moduleid="'+i.module_id+'" data-modulecode="'+i.module_code+'" /></div>').addClass("widget-active widget-show")}Strack.widget_init_dom(d,t,a,i)}},active_inputmask:function(e,t){t&&$("#"+e).inputmask(t)},widget_init_dom:function(t,e,a,i){var d=$("#"+t),r=i.value?i.value:i.default_val?i.default_val:"",o="tagbox";switch(i.editor){case"input":case"text":0<=i.validate.indexOf(",")?i.validate:i.validate,d.css({width:e-32,height:a-2,padding:"0px 15px"}).addClass("widget-edit").val(r).select(),Strack.active_inputmask(t,i.mask);break;case"combobox":if("horizontal_relationship"!==i.custom_type){var n=!0,s=!1;switch("yes"===i.multiple&&(s=!0),i.field){case"assignee":case"cc":d.combobox({url:StrackPHP.getWidgetData,queryParams:i,valueField:"id",textField:"name",groupField:i.group,multiple:s,width:e,height:a,editable:n,value:r,formatter:function(e){return Strack.build_comb_avatar(e)}}).next().find("input").eq(0).addClass("widget-edit");break;default:d.combobox({url:StrackPHP.getWidgetData,queryParams:i,valueField:"id",textField:"name",groupField:i.group,multiple:s,width:e,height:a,editable:n,value:r}).next().find("input").eq(0).addClass("widget-edit")}break}o="combobox";case"tagbox":var l={primary:0,add_default:"no",project_id:i.project_id,module:i.module,field_type:i.field_type,fields:i.fields,variable_id:i.variable_id,frozen_module:i.frozen_module,flg_module:i.flg_module,data_source:i.data_source,module_id:i.module_id},c={width:e,height:"auto",minHeight:a-2,valueField:"id",textField:"name",method:"post",url:StrackPHP.getWidgetData,hasDownArrow:!0,limitToList:!0,value:r,queryParams:l};0<=$.inArray(i.module,["tag","tag_link"])&&(c.limitToList=!1,c.allowInput=!0,c.appendToDB={allow:!0,param:l}),i.group&&(c.groupField="group"),"tagbox"===o?d.tagbox(c).next().find("input").eq(0).addClass("widget-edit"):d.combobox({url:StrackPHP.getWidgetData,queryParams:l,valueField:"id",textField:"name",groupField:i.group,multiple:!1,width:e,height:a,editable:n,value:r}).next().find("input").eq(0).addClass("widget-edit");break;case"checkbox":var _;_=!(0===parseInt(i.value)||!i.value),d.attr("type","checkbox").attr("checked",_).parent().css("padding","0px 10px");break;case"datebox":d.datebox({width:e,height:a,editable:!1,value:r}).next().find("input").eq(0).addClass("widget-edit");break;case"datetimebox":d.datetimebox({width:e,height:a,editable:!1,value:r}).next().find("input").eq(0).addClass("widget-edit");break;case"timespinner":d.timespinner({width:e,height:a,editable:!0,value:r}).next().find("input").eq(0).addClass("widget-edit");break;case"textarea":d.html(r);break;case"upload":Strack.widget_init_upload_dom(t,e,a,i);break;case"task_repeat":r?$.ajax({type:"POST",url:StrackPHP.getWidgetData,data:JSON.stringify(i),contentType:"application/json",dataType:"json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),Strack.G.repeatTaskConfigData=e,$("body").append(Strack.task_repeat_editor_dom(t,e)),Strack.init_task_repeat_editor(t,e)}}):($("body").append(Strack.task_repeat_editor_dom(t)),Strack.init_task_repeat_editor(t,{mode:"none"}))}},task_repeat_editor_dom:function(e,t){var a="",i=t||{};return 0<$(".task-repeat-editor").length&&Strack.remove_task_repeat_editor(),a+='<div id="task_repeat_'+e+'" class="task-repeat-editor combo-p" data-id="'+e+'"><div id="fixed_repeat_'+e+'"  class="dropdown-wrap ui vertical menu">'+Strack.task_repeat_editor_select_dom("none",i)+Strack.task_repeat_editor_select_dom("daily",i)+Strack.task_repeat_editor_select_dom("weekly",i)+Strack.task_repeat_editor_select_dom("monthly",i)+Strack.task_repeat_editor_select_dom("annually",i)+Strack.task_repeat_editor_select_dom("working_days",i)+'<div class="divider"></div>'+Strack.task_repeat_editor_select_dom("custom",i)+'<div id="tr_optional_tips_'+e+'" class="custom-tips"></div></div><div id="custom_repeat_'+e+'" class="custom-repeat"><div class="cr-head"><a href="javascript:;" class="cr-back" data-id="'+e+'" onclick="Strack.quit_task_custom_repeat(this);"><i class="icon-uniE768"></i>'+StrackLang.Back+'</a></div><div class="cr-form"><div class="cr-f-item cr-f-input"><div class="name aign-left">'+StrackLang.Repeat_Item_Name+'</div><div class="val aign-left"><input id="tr_method_'+e+'"></div></div><div class="cr-f-item cr-f-input"><div class="name aign-left">'+StrackLang.Repeat_Item_Inter+'</div><div class="val aign-left"><input id="tr_inter_'+e+'"><div id="tr_inter_unit_'+e+'" class="unit aign-right"></div></div></div><div class="cr-f-item"><ul id="tr_optional_day_'+e+'" class="optional-days"></ul></div><div class="cr-f-item"><p id="tr_optional_descr_'+e+'" class="repeat-description" data-type="">'+StrackLang.Repeat_Daily+'</p></div><div class="cr-f-item"><div class="aign-right"><a href="javascript:;" id="tr_optional_bnt_'+e+'" class="st-dialog-button st-button-base button-dgsub" onclick="Strack.submit_task_repeat(this);" data-id="'+e+'">'+StrackLang.OK+"</a></div></div></div></div></div>"},task_repeat_editor_select_dom:function(e,t){var a="",i={none:StrackLang.Not_Repeat,daily:StrackLang.Repeat_Daily,weekly:StrackLang.Repeat_Weekly,monthly:StrackLang.Repeat_Monthly,annually:StrackLang.Repeat_Annually,working_days:StrackLang.Repeat_Working_Days,custom:StrackLang.Repeat_Custom},d="none";return $.isEmptyObject(t)||(d=t.mode),a+=e===d?'<a href="javascript:;" class="item" onclick="Strack.click_task_repeat_item(this)" data-item="'+e+'">'+i[e]+'<span class="icon aign-right"><i class="icon-uniE764"></i></span></a>':'<a href="javascript:;" class="item" onclick="Strack.click_task_repeat_item(this)" data-item="'+e+'">'+i[e]+'<span class="icon aign-right"></span></a>'},quit_task_custom_repeat:function(e){var t=$(e).data("id");$("#fixed_repeat_"+t).show(),$("#custom_repeat_"+t).hide()},click_task_repeat_item:function(e){var t=$(e).data("item"),a=$(e).closest(".task-repeat-editor").data("id"),i=$("#"+a),d="no";switch(t){case"none":d="no",Strack.save_task_repeat_param(a,t);break;case"daily":case"weekly":case"monthly":case"annually":case"working_days":d="yes",Strack.save_task_repeat_param(a,t);break;case"custom":d="yes",$("#fixed_repeat_"+a).hide(),$("#custom_repeat_"+a).show()}i.find("input").val(d),Strack.set_task_repeat_icon(a,t)},save_task_repeat_param:function(e,t){var a={},i=$("#"+e);switch(t){case"none":i.removeClass("active");break;case"daily":case"weekly":case"monthly":case"annually":case"working_days":a.mode=t,a.config={},i.addClass("active");break;case"custom":a.mode=t;var d={mode:"",inter:"",date:[]};d.mode=$("#tr_method_"+e).combobox("getValue"),d.inter=$("#tr_inter_"+e).combobox("getValue"),$("#tr_optional_day_"+e).find(".optional-day").each(function(){$(this).hasClass("active")&&d.date.push($(this).data("id"))}),a.config=d,i.addClass("active")}Strack.G.repeatTaskConfigData=a},set_task_repeat_icon:function(e,t){$("#fixed_repeat_"+e).find(".item").each(function(){$(this).data("item")===t?$(this).find(".icon").html('<i class="icon-uniE764"></i>'):$(this).find(".icon").empty()})},init_task_repeat_editor:function(a,e){var t="daily",i=1,d=$("#val_"+a);"none"!==Strack.G.repeatTaskConfigData.mode?d.val("yes"):d.val("no"),"custom"===Strack.G.repeatTaskConfigData.mode&&(t=Strack.G.repeatTaskConfigData.config.mode,i=Strack.G.repeatTaskConfigData.config.inter,Strack.generate_task_repeat_datebox(a,Strack.G.repeatTaskConfigData.config.mode,i)),$("#tr_method_"+a).combobox({valueField:"id",textField:"text",width:130,value:t,data:[{id:"daily",text:StrackLang.Repeat_Daily},{id:"weekly",text:StrackLang.Repeat_Weekly},{id:"monthly",text:StrackLang.Repeat_Monthly}],onSelect:function(e){var t=$("#tr_inter_unit_"+a);switch(e.id){case"daily":t.html(StrackLang.UnitTH);break;case"weekly":t.html(StrackLang.Week);break;case"monthly":t.html(StrackLang.Months)}$("#tr_inter_"+a).combobox("setValue",1),Strack.generate_task_repeat_datebox(a,e.id)}}),"custom"===e.mode&&"daily"===e.config.mode&&Strack.activate_task_repeat_bnt(a,"active"),$("#tr_inter_"+a).combobox({valueField:"id",textField:"text",width:100,value:i,data:[{id:1,text:1},{id:2,text:2},{id:3,text:3},{id:4,text:4},{id:5,text:5},{id:6,text:6},{id:7,text:7}],onSelect:function(e){var t=$("#tr_method_"+a).combobox("getValue");Strack.generate_task_repeat_datebox_descr(a,t)}})},generate_task_repeat_datebox:function(e,t,a){var i=$("#tr_optional_day_"+e),d=0,r="",o=[];switch(Strack.G.repeatTaskConfigData.config&&(o=Strack.G.repeatTaskConfigData.config.date),i.empty(),t){case"daily":break;case"weekly":d=7;for(var n=1;n<=d;n++)0<=$.inArray(n+"",o)?r+='<a href="javascript:;" data-id="'+n+'" class="optional-day  toggle-monthday-handle active" onclick="Strack.click_task_repeat_datebox(this)">'+n+"</li>":r+='<a href="javascript:;" data-id="'+n+'" class="optional-day  toggle-monthday-handle" onclick="Strack.click_task_repeat_datebox(this)">'+n+"</li>";i.append(r);break;case"monthly":d=31;for(n=1;n<=d;n++)0<=$.inArray(n+"",o)?r+='<a href="javascript:;" data-id="'+n+'" class="optional-day  toggle-monthday-handle active" onclick="Strack.click_task_repeat_datebox(this)">'+n+"</a>":r+='<a href="javascript:;" data-id="'+n+'" class="optional-day  toggle-monthday-handle" onclick="Strack.click_task_repeat_datebox(this)">'+n+"</a>";i.append(r)}Strack.generate_task_repeat_datebox_descr(e,t,a)},generate_task_repeat_datebox_descr:function(e,t,a){var i=$("#tr_optional_descr_"+e),d="",r=" ",o=[];if(i.empty(),a)n=a;else var n=$("#tr_inter_"+e).combobox("getValue");var s="";1<n&&(s=n);var l=[];$("#tr_optional_day_"+e).find(".optional-day").each(function(){$(this).hasClass("active")&&l.push($(this).data("id"))});var c="cancel";switch(t){case"daily":d+=StrackLang.Repeat_Prefix,d+=s,d+=StrackLang.Days,d+=StrackLang.Repeat,c="active";break;case"weekly":var _={1:StrackLang.Monday,2:StrackLang.Tuesday,3:StrackLang.Wednesday,4:StrackLang.Thursday,5:StrackLang.Friday,6:StrackLang.Saturday,7:StrackLang.Sunday};d+=StrackLang.Repeat_Prefix,d+=s,d+=StrackLang.Week,l.forEach(function(e){o.push(_[e])}),c=0<o.length?(r+=o.join(",")+" ","active"):"cancel",d+=r,d+=StrackLang.Repeat;break;case"monthly":d+=StrackLang.Repeat_Prefix,d+=s,d+=StrackLang.Month,l.forEach(function(e){o.push(e)}),c=0<o.length?(r+=o.join(",")+" ","active"):"cancel",d+=r,d+=StrackLang.Repeat_Monthly_Suffix}i.append(d),Strack.activate_task_repeat_bnt(e,c)},activate_task_repeat_bnt:function(e,t){var a=$("#tr_optional_bnt_"+e);a.removeClass("button-dgcel").removeClass("button-dgsub"),"active"===t?a.addClass("button-dgsub"):a.addClass("button-dgcel")},submit_task_repeat:function(e){var t=$(e).data("id");if($(e).hasClass("button-dgsub")){var a=$("#tr_optional_tips_"+t),i=$("#tr_optional_descr_"+t);a.html(i.html()),Strack.save_task_repeat_param(t,"custom"),Strack.quit_task_custom_repeat(e)}else layer.msg(StrackLang.Select_Date_To_Repeat,{icon:2,time:1200,anim:6})},click_task_repeat_datebox:function(e){$(e).hasClass("active")?$(e).removeClass("active"):$(e).addClass("active");var t=$(e).closest(".task-repeat-editor").data("id"),a=$("#tr_method_"+t).combobox("getValue");0<=$.inArray(a,["weekly","monthly"])&&Strack.generate_task_repeat_datebox_descr(t,a)},remove_task_repeat_editor:function(){var e=$(".task-repeat-editor"),t=e.data("id");$("#tr_method_"+t).combobox("destroy"),$("#tr_inter_"+t).combobox("destroy"),Strack.G.repeatTaskConfigData={},e.remove()},toggle_task_repeat_editor:function(e,t){var a=$(e).data("id"),i=$("#task_repeat_"+a),d=$(e).offset(),r=$(window).height()-($(e).height()+d.top);(t.stopPropagation(),$(e).hasClass("loaded"))?($(e).removeClass("loaded"),i.hide()):($(e).addClass("loaded"),r<i.height()?i.show().css({position:"absolute",bottom:13+r+"px",left:d.left+"px","z-index":19999}):i.show().css({position:"absolute",top:d.top+25+"px",left:d.left+"px","z-index":19999}))},widget_init_upload_dom:function(e,t,a,i){var r;Strack.get_media_server(function(d){$("#"+e).uploadifive({auto:!1,width:258,formData:{timestamp:Strack.current_time(),belong_system:StrackPHP.Belong_System,token:d.token,size:"250x140"},multi:!1,queueSizeLimit:1,queueID:"widget_queue",uploadScript:d.upload_url,onUpload:function(e){var t=$(this).closest(".window-body"),a=t.find("#Nup_fields")[0],i=t.find("#st_dialog_form")[0];if(!(r=Strack.check_item_operate_fields(a,i)).allow_up||0===e)return!1;$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},onUploadComplete:function(e,t){var a=JSON.parse(t);if(200===parseInt(a.status)){var i=Strack.get_update_item_hide_param(this);r.up_data.media=Strack.generate_widget_media_fields(d,i,a.data),Strack.submit_update_item(this,!0,i,r.up_data)}else layer.msg(a.message,{icon:7,time:1200,anim:6})}})},function(e){layer.msg(e.message,{icon:7,time:1200,anim:6}),$("#Nup_fields").combobox("unselect","media-thumb")})},generate_widget_media_fields:function(e,t,a){var i=Strack.assembly_media_thumb_data(e,a);return a.base_url=e.request_url+a.path,{type:Strack.G.batchUploadMediaType,data:[{field:"media-module_id",field_type:"built_in",value:t.module_id,variable_id:0},{field:"media-md5_name",field_type:"built_in",value:a.md5_name,variable_id:0},{field:"media-thumb",field_type:"built_in",value:i.thumb,variable_id:0},{field:"media-size",field_type:"built_in",value:i.size,variable_id:0},{field:"media-param",field_type:"built_in",value:a,variable_id:0},{field:"media-media_server_id",field_type:"built_in",value:e.id,variable_id:0}]}},item_operate_update:function(e){var t=$(e).closest(".window-body"),a=t.find(".media-upload-bnt"),i=t.find("#Nup_fields")[0],d=t.find("#st_dialog_form")[0];if(0<a.length)a.uploadifive("upload");else{var r=Strack.check_item_operate_fields(i,d);r.allow_up&&Strack.submit_update_item(e,!1,Strack.get_update_item_hide_param(e),r.up_data)}},item_combobox_new_update:function(e){var t=$(e).closest(".window-body"),a=t.find(".media-upload-bnt"),i=t.find("#Ncomb_up_fields")[0],d=t.find("#st_dialog_form")[0];if(0<a.length)a.uploadifive("upload");else{var r=Strack.check_item_operate_fields(i,d);r.allow_up&&Strack.submit_update_item(e,!1,Strack.get_update_item_hide_param(e),r.up_data)}},get_update_item_hide_param:function(e){var t=$(e).closest(".window-body"),a={};t.find("#st_dialog_form_hide input").each(function(){a[$(this).attr("data-name")]=$(this).val()});var i=$("#Nprimary_id").val();return a.primary_id=0<i.length?i:0,a},submit_update_item:function(t,e,a,i){$.ajax({type:"POST",url:StrackPHP.updateItemDialog,data:JSON.stringify({param:a,data:i}),contentType:"application/json",dataType:"json",beforeSend:function(){e||$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),t&&Strack.check_dialog_keep_status(t),Strack.G.batchUploadMediaType=""):layer.msg(e.message,{icon:7,time:1200,anim:6}),$.messager.progress("close")}})},check_dialog_keep_status:function(e){if("no"===Strack.G.dialogKeepBntStatus.continue_next&&"no"===Strack.G.dialogKeepBntStatus.keep_data)e?Strack.dialog_cancel(e):Strack.dialog_cancel();else if("yes"===Strack.G.dialogKeepBntStatus.continue_next&&"no"===Strack.G.dialogKeepBntStatus.keep_data){var t;if(e){var a=$(e).closest(".window-body").attr("id");t=$("#"+a)}else t=$("#dialog");var i=t.find("#Nup_fields")[0],d=t.find("#st_dialog_form")[0];d&&i&&Strack.clear_dialog_editor_item_data(i,d)}},widget_update:function(){var e=$(".widget-show");if(0<e.length){var t=e.find("a").eq(0),a=e.find(".info-content-edit").find("input").eq(0).attr("id"),i=t.attr("data-table"),d=t.attr("data-module"),r=t.attr("data-ofields"),o=t.attr("data-fields"),n=t.attr("data-fieldtype"),s=t.attr("data-editor"),l=t.attr("data-widgetid"),c=t.attr("data-variableid"),_=t.attr("data-primary"),m=t.attr("data-multiple"),u=t.attr("data-moduleid"),g=t.attr("data-modulecode"),p=t.attr("data-projectid"),f=t.attr("data-datasource"),h=t.attr("data-fielduuid"),v=$("#"+a),k="",b=v.attr("data-value"),S=!1,y={};switch(b=b||"",e.removeClass("widget-show").find("a").eq(0).show().next().show().next().hide(),s){case"text":k=v.val();break;case"tagbox":(k=Strack.get_combos_val("#"+a,"tagbox","getValues"))?k=k.join(","):S=!0;break;case"combobox":k="yes"===m?(k=Strack.get_combos_val("#"+a,"combobox","getValues"))&&k.join(","):Strack.get_combos_val("#"+a,"combobox","getValue");break;case"datebox":k=v.datebox("getValue");break;case"datetimebox":k=v.datetimebox("getValue");break;case"timespinner":k=v.timespinner("getValue");break;case"checkbox":k=v.is(":checked")?1:0;break;case"tags":var w=[];v.parent().find("span").each(function(){w.push($(this).attr("data-id"))}),k=0<w.length?w.join(","):"";break;case"textarea":var x=e.find(".info-content-edit").find("textarea").eq(0).attr("id");k=$("#"+x).val();break;case"task_repeat":k=v.val(),S=!0,y=Strack.G.repeatTaskConfigData}if(k!==b||S){var j={dom:h,editor:"common",original_field:r,other_param:y};$.ajax({type:"POST",url:StrackPHP.updateWidget,dataType:"json",contentType:"application/json",data:JSON.stringify({editor:s,table:i,module:d,project_id:p,field:o,original_field:r,field_type:n,primary_value:_,data_source:f,widget_id:l,variable_id:c,module_id:u,module_code:g,old_val:b,val:k,widget_param:j}),success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.Websocket.List.hasOwnProperty("update")||(e.data.status=200,Strack.update.widget(e.data,j))):Strack.top_message({bg:"r",msg:e.message})}})}}},listen_keyboard_event:function(t){var a={};$(document).on("keydown",function(e){switch(e.keyCode){case 13:a.code="enter";break;case 32:a.code="space";break;case 37:a.code="left";break;case 39:a.code="right";break;case 70:a.code="f_key";break;case 73:a.code="i_key";break;case 86:a.code="v_key";break;default:a.code=""}t&&t(e,a)})},load_info_panel:function(d,r){$.ajax({type:"POST",url:d.url,data:d.data,beforeSend:function(){$(d.id).prepend(Strack.loading_dom(d.loading_type),d.mask)},success:function(e){var t,a;switch(d.data.category){case"detail_onset_field":t=d.data.onset_id,a=d.data.onset_module_id;break;default:t=d.data.item_id,a=d.data.module_id}var i=Strack.generate_widget(e.config,e.data,t,d.data.project_id,d.pos,a);$(d.id).empty().append(i),Strack.init_other_thumb_media("common"),$("#st-load_"+d.mask).remove(),r&&r(e)}})},get_item_fields:function(e,t){$.ajax({type:"POST",url:StrackPHP.getFields,dataType:"json",contentType:"application/json",data:JSON.stringify(e),success:function(e){Strack.G.dialogItemFieldsConfig=e,t(e)}})},get_item_onset_data:function(e,t){$.ajax({type:"POST",url:StrackPHP.getItemOnsetLinkData,dataType:"json",contentType:"application/json",data:JSON.stringify(e),success:function(e){t(e)}})},common_add_task:function(e){var t=$(e).data("page");Strack.item_operate_dialog("任务",{mode:"create",field_list_type:["edit"],module_id:4,project_id:0,page:t,schema_page:"project_base",type:"add_panel",keep_panel:!0},function(){})},calendar_lock_plan:function(e){var t=$(e).closest(".my-scheduler-index").attr("id"),a=$(e).attr("data-mode"),i=$("#"+t).fullCalendar("getView");$.ajax({type:"POST",url:StrackPHP.lockTaskPlan,dataType:"json",data:{type:a,date:i.start.format()},beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.reload_fullCalendar_data(t)):($.messager.progress("close"),layer.msg(e.message,{icon:7,time:1200,anim:6}))}})},copy_calendar_plan:function(e,t,a){e.stopPropagation(),e.preventDefault(),Strack.open_dialog("dialog",{title:StrackLang.Copy_Task_Plan_Title,width:480,height:240,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mparent_id",type:"hidden",name:"id",valid:1,value:a},{case:101,id:"Mplan_id",type:"hidden",name:"id",valid:1,value:t.item_id},{case:101,id:"Mlink_id",type:"hidden",name:"id",valid:1,value:t.link_id}],items:[{case:2,id:"Mplan_start_date",type:"text",lang:StrackLang.Plan_Start_Time,name:"name",valid:"1",value:"name"},{case:2,id:"Mplan_end_date",type:"text",lang:StrackLang.Plan_End_Time,name:"code",valid:"1",value:"code"}],footer:[{obj:"copy_calendar_plan_update",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){Strack.open_datetime_box("#Mplan_start_date",378,26),Strack.open_datetime_box("#Mplan_end_date",378,26)},close:function(){}})},copy_calendar_plan_update:function(){$("#Mplan_id").val();var e=$("#Mparent_id").val(),t=$("#Mlink_id").val(),a=$("#Mplan_start_date").datetimebox("getValue"),i=$("#Mplan_end_date").datetimebox("getValue"),d=!0;if(a||(d=!1,layer.msg(StrackLang.Base_Plan_Start_Time_Null,{icon:2,time:1200,anim:6})),i||(d=!1,layer.msg(StrackLang.Base_Plan_End_Time_Null,{icon:2,time:1200,anim:6})),d){var r={lock:"no",link_id:t,start_time:a,end_time:i,operation:"copy"};Strack.add_scheduler_task_plan_event_update(r,e,!0)}},del_calendar_plan:function(e,t,a,i){e.stopPropagation(),e.preventDefault(),0<i&&$.messager.confirm(StrackLang.Confirmation_Box,StrackLang.Delete_Task_Plan_Notice,function(e){e&&$.ajax({type:"POST",url:StrackPHP.deleteTaskPlan,data:{primary_ids:i},dataType:"json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.reload_fullCalendar_data(a)):($.messager.progress("close"),layer.msg(e.message,{icon:7,time:1200,anim:6}))}})})},item_operate_dialog:function(e,o,t){var a="";switch(o.mode){case"create":case"create_related":a=StrackLang.Submit;break;case"modify":a=StrackLang.Update}var i=o.hasOwnProperty("from_module_id")?o.from_module_id:0,d=o.hasOwnProperty("from_item_id")?o.from_item_id:0,r=o.hasOwnProperty("horizontal_type")?o.horizontal_type:"",n=o.hasOwnProperty("variable_id")?o.variable_id:0,s=!!o.keep_panel&&o.keep_panel,l=s?420:380;Strack.open_dialog("dialog",{title:e,width:620,height:l,content:Strack.dialog_dom({type:"item_operation",keep_panel:s,hidden:[{case:101,id:"Nmodule_id",type:"hidden",name:"module_id",valid:1,value:o.module_id},{case:101,id:"Nfrom_module_id",type:"hidden",name:"from_module_id",valid:1,value:i},{case:101,id:"Nfrom_item_id",type:"hidden",name:"from_item_id",valid:1,value:d},{case:101,id:"Nhorizontal_type",type:"hidden",name:"horizontal_type",valid:1,value:r},{case:101,id:"Nvariable_id",type:"hidden",name:"variable_id",valid:1,value:n},{case:101,id:"Npage",type:"hidden",name:"page",valid:1,value:o.page},{case:101,id:"Nproject_id",type:"hidden",name:"project_id",valid:1,value:o.project_id},{case:101,id:"Nmode",type:"hidden",name:"mode",valid:1,value:o.mode},{case:101,id:"Ntype",type:"hidden",name:"type",valid:1,value:o.type},{case:101,id:"Nprimary_id",type:"hidden",name:"primary_id",valid:1,value:o.primary_id}],items:[{case:2,id:"Nup_fields",type:"text",lang:StrackLang.Fields,name:"fields",valid:1,value:""}],footer:[{obj:"item_operate_update",type:5,title:a},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel},{obj:"save_dialog_setting",type:8,title:StrackLang.Save_Setting}]}),inits:function(){var r=this;Strack.get_item_fields(o,function(a){var t=[];for(var i in a.field_list)for(var d in a.field_list[i])"type"!==d&&a.field_list[i][d].fields.forEach(function(e){e.field_group_name=a.field_list[i][d].title,e.project_id=o.project_id,e.module_id=o.module_id,e.frozen_module=e.frozen_module,e.flg_module=e.flg_module,e.fields=e.module+"-"+e.id,t.push(e)});Strack.G.dialogItemMustFields=a.required_setting,$("#Nup_fields").combobox({data:t,width:350,valueField:"fields",textField:"lang",groupField:"field_group_name",multiple:!0,value:"",onSelect:function(e){if(0===$("#dgup_i_"+e.fields).length)if(Strack.check_upload_editor_unique(r,e)){o.hasOwnProperty("select_fields")&&o.select_fields.map.hasOwnProperty(e.fields)&&(e.value=o.select_fields.map[e.fields]),0<=$.inArray(e.fields,a.must_setting)&&(e.required=!0);var t=Strack.field_item_dom(e,o,1);$("#st_dialog_item").append(t.item_dom),Strack.field_item_init(t.dom_id,o.primary_id,e,o)}else $(this).combobox("unselect",e.fields)},onUnselect:function(e){$.inArray(e.fields,a.must_setting)<0?("task_repeat"===e.editor&&Strack.remove_task_repeat_editor(),Strack.destroy_field_item(e.fields)):($(this).combobox("select",e.fields),layer.msg(e.id+": "+StrackLang.Must_Field,{icon:2,time:1200,anim:6}))},onLoadSuccess:function(){var t=$(this);o.hasOwnProperty("select_fields")&&o.select_fields.config.forEach(function(e){0===$("#dgup_i_"+e.field).length&&t.combobox("select",e.field)}),a.user_setting.forEach(function(e){t.combobox("select",e)})}}),s&&Strack.set_dialog_keep_status_bnt("dialog",a.keep_status)})},close:function(){t()}})},check_upload_editor_unique:function(e,t){return!("upload"===t.editor&&0<$(e).find(".single-queue-item").length)||(layer.msg(StrackLang.Only_One_Media_Upload,{icon:2,time:1200,anim:6}),!1)},destroy_field_item:function(e){var t=$("#dgup_i_"+e),a=t.attr("data-widgetid"),i=t.attr("data-editor"),d=$("#"+a);switch(i){case"upload":try{d.uploadifive("destroy")}catch(e){}break;case"combobox":d.combobox("destroy");break;case"datebox":d.datebox("destroy");break;case"datetimebox":d.datetimebox("destroy")}t.remove()},field_item_dom:function(e,t,a){var i="",d="dgup_"+e.fields+Math.floor(1e3*Math.random()+1),r="";r=e.field_group_name?e.lang+" ("+e.field_group_name+")":e.lang;var o=e.required?"required":"";return i+='<li id="dgup_i_'+e.fields+'" class="dg-report-item" data-field="'+e.fields+'" data-widgetid="'+d+'" data-editor="'+e.editor+'"><a href="javascript:;" onclick="Strack.field_item_delete(this)" class="dg-report-de aign-left"  data-field="'+e.fields+'" data-mode="'+t.mode+'" data-type="'+t.type+'"><i class="icon-uniE6DB"></i></a><div class="dg-report-step aign-left '+o+'"><label>'+r+'</label></div><div class="dg-report-user st-dialog-input aign-left">'+Strack.field_editor_dom(d,e)+"</div>","combobox"===e.editor&&"allow"===e.create_in_time&&1===a&&(i+='<a href="javascript:;" class="dg-report-add" onclick="Strack.add_combobox_new_val(this)" data-page="'+t.page+'" data-schemapage="'+t.schema_page+'" data-moduleid="'+e.module_id+'" data-projectid="'+t.project_id+'" data-widgetid="'+d+'" data-flgmodule="'+e.flg_module+'" data-modulecode="'+e.module_code+'"><i class="icon-uni3432"></i></a>'),{item_dom:i+="</li>",dom_id:d}},add_combobox_new_val:function(e){var t=$(e),a=t.attr("data-moduleid"),i=t.attr("data-flgmodule"),d=t.attr("data-widgetid"),o=t.attr("data-projectid"),n=t.attr("data-page"),s=t.attr("data-schemapage"),r="no";-1!==$.inArray(i,["status","step"])&&(r="yes");var l="yes";-1!==$.inArray(i,["status","step"])&&(l="yes");var c="Add_"+Strack.string_ucwords(i),_="dialog_combobox_add_"+Math.floor(1e4*Math.random()+1);Strack.open_dialog(_,{title:StrackLang[c],width:620,height:380,content:Strack.dialog_dom({type:"item_operation",hidden:[{case:101,id:"Ncomb_project_id",type:"hidden",name:"project_id",valid:1,value:o},{case:101,id:"Ncomb_module_id",type:"hidden",name:"module_id",valid:1,value:a},{case:101,id:"Ncomb_module_code",type:"hidden",name:"module_code",valid:1,value:i},{case:101,id:"Ncomb_update_template",type:"hidden",name:"update_template",valid:1,value:r},{case:101,id:"Ncomb_mode",type:"hidden",name:"mode",valid:1,value:"create"},{case:101,id:"Ncomb_type",type:"hidden",name:"type",valid:1,value:"combobox_add_panel"},{case:101,id:"Ncomb_page",type:"hidden",name:"page",valid:1,value:n}],items:[{case:2,id:"Ncomb_up_fields",type:"text",lang:StrackLang.Fields,name:"fields",valid:1,value:""}],footer:[{obj:"item_combobox_new_update",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){var r={mode:"create",field_list_type:["edit"],from_module_id:a,module_code:i,project_id:o,has_schema:l,page:n,from_schema_page:s,type:"combobox_add_panel"};Strack.get_item_fields(r,function(a){var t=[];for(var i in a.field_list)for(var d in a.field_list[i])"type"!==d&&a.field_list[i][d].fields.forEach(function(e){e.field_group_name=a.field_list[i][d].title,e.project_id=r.project_id,e.module_id=r.module_id,e.frozen_module=e.frozen_module,e.flg_module=e.flg_module,e.fields=e.module+"-"+e.id,t.push(e)});$("#Ncomb_up_fields").combobox({data:t,width:350,valueField:"fields",textField:"lang",groupField:"field_group_name",multiple:!0,value:"",onSelect:function(e){if(0===$("#"+_+" #dgup_i_"+e.fields).length){var t=Strack.field_item_dom(e,r,2);$("#"+_+" #st_dialog_item").append(t.item_dom),Strack.field_item_init(t.dom_id,r.project_id,e)}},onUnselect:function(e){Strack.destroy_field_item(e.fields)},onLoadSuccess:function(){var t=$(this);a.user_setting.forEach(function(e){t.combobox("select",e)})}})})},close:function(){$("#"+d).combobox("reload")}})},field_item_init:function(e,t,a,i){if(a.primary=t,Strack.widget_init_dom(e,260,25,a),i&&"my_scheduler"===i.page){var d=$("#"+e);switch(Strack.G.dialogDomList[a.id]=d,a.id){case"project_id":d.combobox({onSelect:function(e){0===e.id?Strack.G.dialogDomList.status_id.combobox("setValue",0).combobox("disable"):Strack.combobox_append_project_id("status_id",e.id)}});break;case"status_id":d.combobox("disable")}}},combobox_append_project_id:function(e,t){var a=Strack.G.dialogDomList[e].combobox("options");a.queryParams.project_id=t,Strack.G.dialogDomList[e].combobox("reload",a.queryParams).combobox("enable")},field_item_delete:function(e){var t=$(e).data("field");switch($(e).data("type")){case"add_entity_task_panel":0<$(e).closest("#st_dialog_form").length?$("#Nup_fields").combobox("unselect",t):$("#m_review_task_fields").combobox("unselect",t);break;default:$("#Nup_fields").combobox("unselect",t)}},field_editor_dom:function(e,t){var a="",i="";i=t.field_group_name?t.lang+" ("+t.field_group_name+")":t.lang;var d="built_in"===t.field_type?0:t.variable_id,r="entity"===t.module_type?"entity":t.module_code;switch(t.editor){case"upload":Strack.G.batchUploadMediaType="custom"===t.field_type?"horizontal":"direct",a='<div id="widget_queue" class="single-queue-item"></div><div class="widget-upload"><input id="'+e+'" class="media-upload-bnt field_edit_item" type="file" multiple="true" data-field="'+t.fields+'" data-variableid="'+d+'" data-fieldtype="'+t.field_type+'" data-lang="'+i+'" data-editor="'+t.editor+'" data-multiple="'+t.multiple+'" data-table="'+r+'"></div>';break;case"textarea":a='<textarea id="'+e+'" class="field_edit_item widget-edit" data-field="'+t.fields+'" data-variableid="'+d+'" data-fieldtype="'+t.field_type+'" data-lang="'+i+'" data-editor="'+t.editor+'" data-multiple="'+t.multiple+'" data-table="'+r+'"></textarea>';break;case"task_repeat":a+='<a href="javascript:;" id="'+e+'" class="task-repeat ui icon button" onclick="Strack.toggle_task_repeat_editor(this, event)" data-id="'+e+'"><i class="history icon"></i>',a+='<input id="val_'+e+'" type="hidden" value="no" class="field_edit_item" data-field="'+t.fields+'" data-variableid="'+d+'" data-fieldtype="'+t.field_type+'" data-lang="'+i+'" data-editor="'+t.editor+'" data-multiple="'+t.multiple+'" data-table="'+r+'">',a+="</a>";break;default:a='<input id="'+e+'" type="'+("password"===t.id?"password":"text")+'" class="field_edit_item" data-field="'+t.fields+'" data-variableid="'+d+'" data-fieldtype="'+t.field_type+'" data-lang="'+i+'" data-editor="'+t.editor+'" data-multiple="'+t.multiple+'" data-table="'+r+'">'}return a},dg_ask_repeat_editor_dom:function(e,t,a){var i="dgup_"+a.fields+Math.floor(1e3*Math.random()+1),d="",r=(a.row_h-26)/2,o=(a.row_w-26)/2,n="yes"===a.value?"active":"";d+='<div style="position: relative;background-color:#FFFFFF;width: 100%;height: '+a.row_h+'px">',d+='<a href="javascript:;" id="'+i+'" class="task-repeat ui icon button '+n+'" style="position: absolute;top:'+r+"px;left: "+o+'px" onclick="Strack.toggle_task_repeat_editor(this, event)" data-id="'+i+'">',d+='<i class="history icon"></i>',d+='<input id="val_'+i+'" type="hidden" value="no" class="field_edit_item" data-field="'+a.fields+'" data-variableid="'+a.variable_id+'" data-fieldtype="'+a.field_type+'" data-lang="'+StrackLang.Repeat+'" data-editor="'+a.editor+'" data-multiple="no" data-table="'+a.table+'">',d+="</a>",d+="</div>",e.empty().append(d),Strack.widget_init_dom(i,260,25,a)},check_item_operate_fields:function(e,t){var a=Strack.get_combos_val(e,"combobox","getValues"),c={},_=!0;return a?($(".form-tip").remove(),$(t).find(".field_edit_item").each(function(){var e=$(this).attr("data-lang"),t=$(this).attr("data-editor"),a=$(this).attr("data-field"),i=$(this).attr("data-fieldtype"),d=$(this).attr("data-multiple"),r=$(this).attr("data-variableid"),o=$(this).attr("data-table"),n="",s=[];switch(t){case"combobox":n="yes"===d?(s=Strack.get_combos_val(this,"combobox","getValues"))?s.join(","):"":Strack.get_combos_val(this,"combobox","getValue"),0<=$.inArray(a,Strack.G.dialogItemMustFields)&&0==n&&(n=""),$.inArray(a,Strack.G.dialogItemMustFields)<0&&-1!==a.search("id")&&!n&&(n=0);break;case"tagbox":case"horizontal_relationship":case"relation":n=(s=Strack.get_combos_val(this,"combobox","getValues"))?s.join(","):"";break;case"datebox":n=$(this).datebox("getValue");break;case"datetimebox":n=$(this).datetimebox("getValue");break;case"checkbox":n=$(this).is(":checked")?"yes":"no";break;case"upload":0<$("#widget_queue .uploadifive-queue-item").length&&(n="yes");break;case"task_repeat":if("yes"===(n=$(this).val())&&!$.isEmptyObject(Strack.G.repeatTaskConfigData)){var l=[];l.push({field:"base_repeat_config-mode",field_type:"built_in",value:Strack.G.repeatTaskConfigData.mode,variable_id:0}),l.push({field:"base_repeat_config-config",field_type:"built_in",value:Strack.G.repeatTaskConfigData.config,variable_id:0}),c.base_repeat_config=l}break;default:n=$(this).val()}if(!(n||"combobox"===t&&0===n))return $(this).closest("li").append(Strack.dialog_error_icon("e")),layer.msg(e+" : "+StrackLang.Required_Field,{icon:2,time:1200,anim:6}),_=!1;$(this).closest("li").append(Strack.dialog_error_icon("t")),c.hasOwnProperty(o)?c[o].push({field:a,field_type:i,value:n,variable_id:r}):c[o]=[{field:a,field_type:i,value:n,variable_id:r}]})):(_=!1,layer.msg(StrackLang.Please_Select_Field,{icon:2,time:1200,anim:6})),{allow_up:_,up_data:c}},clear_dialog_editor_item_data:function(e,t){Strack.get_combos_val(e,"combobox","getValues")&&$(t).find(".field_edit_item").each(function(){$(this).attr("data-lang");var e=$(this).attr("data-editor");$(this).attr("data-field"),$(this).attr("data-fieldtype"),$(this).attr("data-multiple"),$(this).attr("data-variableid"),$(this).attr("data-table");switch(e){case"combobox":case"tagbox":case"horizontal_relationship":case"relation":$(this).combobox("clear");break;case"datebox":$(this).datebox("clear");break;case"datetimebox":$(this).datetimebox("clear");break;case"checkbox":$(this).prop("checked",!1);break;case"upload":$("#widget_queue .uploadifive-queue-item").remove();break;default:$(this).val("")}})},entity_add_task:function(e){var t=$(e).closest(".datagrid-toolbar"),a=$(e).attr("data-lang"),i=$(e).attr("data-modulecode"),d=$(e).attr("data-taskmoduleid"),o=$(e).attr("data-schemapage"),r=$("#page_hidden_param input[name=module_name]").val(),n=t.attr("data-grid"),s=t.attr("data-page"),l=t.attr("data-maindom"),c=t.attr("data-bardom"),_=t.attr("data-moduleid"),m=t.attr("data-projectid"),u=$("#"+n).datagrid("getSelections"),g=[];u.forEach(function(e){g.push(parseInt(e.id))}),0<g.length?Strack.open_dialog("dialog",{title:StrackLang.Add_Task,width:920,height:500,content:Strack.dialog_dom({type:"add_entity_task",entity_title:a,hidden:[{case:101,id:"Nmodule_id",type:"hidden",name:"module_id",valid:1,value:_},{case:101,id:"Ntask_module_id",type:"hidden",name:"task_module_id",valid:1,value:d},{case:101,id:"Nmodule_name",type:"hidden",name:"module_name",valid:1,value:r},{case:101,id:"Nproject_id",type:"hidden",name:"project_id",valid:1,value:m},{case:101,id:"Ngrid",type:"hidden",name:"grid",valid:1,value:n},{case:101,id:"Npage",type:"hidden",name:"page",valid:1,value:s},{case:101,id:"Ntype",type:"hidden",name:"type",valid:1,value:"add_entity_task"},{case:101,id:"Nmain_dom",type:"hidden",name:"main_dom",valid:1,value:l},{case:101,id:"Nbar_dom",type:"hidden",name:"bar_dom",valid:1,value:c}],items:[],footer:[{obj:"entity_add_task_submit",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel},{obj:"save_dialog_setting",type:8,title:StrackLang.Save_Setting}]}),inits:function(){Strack.combobox_widget("#Mentity",{url:StrackPHP.getWidgetData,valueField:"id",textField:"name",multiple:!0,queryParams:{module:"entity",field_type:"built_in",fields:"entity_id",flg_module:"entity",project_id:m,entity_module_id:_,data_source:"entity"},onLoadSuccess:function(){$(this).combobox("setValues",g)}});var t={step_id:"Mstep",list_id:"stdg_etask_list",combox_id:"Nup_fields",edit_id:"st_dialog_item"};Strack.combobox_widget("#Mstep",{url:StrackPHP.getEntityStepList,valueField:"id",textField:"name",multiple:!0,queryParams:{project_id:m,module_code:i},onSelect:function(e){Strack.add_entity_step_task_group(t,e,"new")},onUnselect:function(e){Strack.remove_entity_step_task_group(t,e)}});var r={mode:"create",field_list_type:["edit"],module_id:d,project_id:m,page:s,schema_page:o,type:"add_entity_task_panel",not_fields:["entity_id","step_id","thumb"]};Strack.get_item_fields(r,function(a){var t=[];for(var i in a.field_list)for(var d in a.field_list[i])a.field_list[i][d].fields.forEach(function(e){e.field_group_name=a.field_list[i][d].title,e.project_id=r.project_id,e.module_id=r.module_id,e.frozen_module=e.frozen_module,e.flg_module=e.flg_module,e.fields=e.module+"-"+e.id,t.push(e)});$("#Nup_fields").combobox({data:t,width:350,valueField:"fields",textField:"lang",groupField:"field_group_name",multiple:!0,value:"",onSelect:function(e){if(0===$("#dgup_i_"+e.fields).length){var t=Strack.field_item_dom(e,r,1);if($("#st_dialog_item").append(t.item_dom),Strack.field_item_init(t.dom_id,r.project_id,e),"name"===e.id||"code"===e.id){var a=$("#stdg_etask_list .etask-l-active").find(".etask-l-item-name").html();$("#"+t.dom_id).val(a)}}},onUnselect:function(e){Strack.destroy_field_item(e.fields)},onLoadSuccess:function(){var t=$(this);a.user_setting.forEach(function(e){t.combobox("select",e)})},onChange:function(e,t){$(".stdg-etask-l-item").removeClass("form_ok")}})})},close:function(){Strack.G.entityStepTaskAddData={status:!1,data:{}}}}):layer.msg(StrackLang.Please_Select_One,{icon:2,time:1200,anim:6})},entity_add_task_submit:function(){if($.isEmptyObject(Strack.G.entityStepTaskAddData.data))layer.msg(StrackLang.Please_Select_Step,{icon:2,time:1200,anim:6});else{var e=$("#stdg_etask_list").find(".etask-l-active");if(0<e.length){var t=e.attr("id"),a=e.attr("data-stepcode"),i=Strack.check_item_operate_fields("#Nup_fields","#st_dialog_form");Strack.G.entityStepTaskAddData.data[a][t]=i.up_data,i.allow_up&&e.addClass("form_ok")}if(Strack.G.entityStepTaskAddData.status=!0,$(".stdg-etask-l-item").each(function(){$(this).hasClass("form_ok")||(Strack.G.entityStepTaskAddData.status=!1)}),Strack.G.entityStepTaskAddData.status){var d={entity_param:{},task_rows:Strack.G.entityStepTaskAddData.data};if($("#st_dialog_form_hide").find("input").each(function(){d.entity_param[$(this).attr("data-name")]=$(this).val()}),d.entity_ids=$("#Mentity").combobox("getRowValues","id"),d.step_ids=$("#Mstep").combobox("getRowValues","id"),0<d.entity_ids.length)$.ajax({type:"POST",url:StrackPHP.batchSaveEntityBase,data:JSON.stringify(d),contentType:"application/json",dataType:"json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.dialog_cancel()):layer.msg(e.message,{icon:7,time:1200,anim:6})}});else{var r=$("#Nmodule_name").val();layer.msg(r+" : "+StrackLang.Required_Field,{icon:2,time:1200,anim:6})}}else layer.msg(StrackLang.Please_Fill_Step_Task_Data,{icon:2,time:1200,anim:6})}},import_excel_data:function(e){var t=$("#import_excel_slider");t.hasClass("load-active")?Strack.reset_import_excel_step_data():t.addClass("load-active");var a=$(e).closest(".datagrid-toolbar"),i=Math.floor(1e5*Math.random()+1),d=Strack.G.pageHiddenParam.hasOwnProperty("item_id")?Strack.G.pageHiddenParam.item_id:0,o={page:a.attr("data-page"),schema_page:a.attr("data-schemapage"),module_id:a.attr("data-moduleid"),grid:a.attr("data-grid"),project_id:a.attr("data-projectid"),main_dom:a.attr("data-maindom"),bar_dom:a.attr("data-bardom"),batch_number:i,from_module_data:{item_id:d,module_id:Strack.G.pageHiddenParam.module_id,module_code:Strack.G.pageHiddenParam.module_code}};Strack.G.importExcelStep=$("#import_excel_step").step({mustStep:[],stepCallBack:function(i){var e={method:StrackLang.Please_Select_Import_Mode,import_paste:StrackLang.Please_Paste_Excel_Data,import_file:StrackLang.Please_Select_Excel_File,mapping:StrackLang.Must_Field_Completely_Mapping,result:""},d=!0,r="";if(["method","import","mapping","result"].forEach(function(e,t){if(!(t+1<i&&d))return!1;switch(r=e){case"method":var a=$(".import-method-active");0<a.length?Strack.G.importExcelData.method=a.attr("data-method"):d=!1;break;case"import":if(Strack.G.importExcelData.method)switch(Strack.G.importExcelData.method){case"paste":0===$("#import_method_paste").val().length&&(d=!1);break;case"file":0===$(".uploadifive-queue-item").length&&(d=!1)}else d=!1;break;case"mapping":$("#import_ex_must").find(".menu-icon").each(function(){if($(this).hasClass("icon-unchecked"))return d=!1})}return!!d&&void 0}),d)switch(parseInt(i)){case 1:Strack.G.importExcelStep.goStep(i),Strack.reset_import_excel_step_bnt(i);break;case 2:Strack.G.importExcelStep.goStep(i),$(".import-method-panel").hide(),Strack.init_excel_format_widget(o),Strack.reset_import_excel_step_bnt(i);break;case 3:switch(Strack.G.importExcelData.method){case"paste":Strack.format_excel_paste_data(o);break;case"file":Strack.format_excel_file_data()}break;case 4:Strack.import_excel_step_submit(o);break;default:Strack.format_excel_file_data(0)}else{var t="";switch(r){case"import":t=e[r+"_"+Strack.G.importExcelData.method];break;default:t=e[r]}layer.msg(t,{icon:2,time:1200,anim:6})}}}),t.sidebar("toggle")},close_import_excel_panel:function(){$("#import_excel_slider").sidebar("toggle")},reset_import_excel_step_data:function(){Strack.G.importExcelData={},$("#import_ex_list .step-list").hide(),$(".excel-in-submit").hide(),$("#import_excel_bnt_upload").hide(),$("#import_excel_bnt_prev").hide(),$("#import_excel_bnt_next").show(),$("#import_excel_bnt_submit").hide(),$(".import-excel-card").removeClass("import-method-active"),$(".import-method-panel").hide();var e=$("#method_paste_header");e.hasClass("switchbutton-f")&&(e.switchbutton("clear"),$("#import_method_paste").empty());var t=$("#method_file_header");t.hasClass("switchbutton-f")&&(t.switchbutton("clear"),$("#excel_upload_widget").uploadifive("clearQueue"))},reset_import_excel_step_bnt:function(e){var t=$("#import_excel_bnt_upload"),a=$("#import_excel_bnt_prev"),i=$("#import_excel_bnt_next"),d=$("#import_excel_bnt_submit");switch(e){case 1:t.hide(),a.hide(),i.show(),d.hide();break;case 2:"file"===Strack.G.importExcelData.method&&t.show(),a.show(),i.show(),d.hide();break;case 4:t.hide(),a.show(),i.hide(),d.show();break;default:t.hide(),a.show(),i.show(),d.hide()}},import_excel_step_prev:function(){Strack.G.importExcelStep.preStep()},import_excel_step_next:function(){Strack.G.importExcelStep.nextStep()},init_excel_format_widget:function(e){var t=$("#excel_format_paste"),a=$("#excel_format_file");switch($(".import-method-"+Strack.G.importExcelData.method).show(),Strack.G.importExcelData.method){case"paste":t.hasClass("load_active")||(t.addClass("load_active"),Strack.init_open_switch({dom:"#method_paste_header",value:0,onText:StrackLang.Switch_ON,offText:StrackLang.Switch_OFF,width:100}));break;case"file":a.hasClass("load_active")||(a.addClass("load_active"),Strack.init_open_switch({dom:"#method_file_header",value:0,onText:StrackLang.Switch_ON,offText:StrackLang.Switch_OFF,width:100}),Strack.init_excel_file_upload(e))}},format_excel_paste_data:function(e){var t=new CSV($("#import_method_paste").val(),{cellDelimiter:"\t"}),a=Strack.get_switch_val("#method_paste_header"),i=t.parse();$.ajax({type:"POST",url:StrackPHP.formatExcelPasteData,data:JSON.stringify({has_header:a,parsed:i,module_id:e.module_id,project_id:e.project_id,page:e.page,schema_page:e.schema_page}),contentType:"application/json",beforeSend:function(){$("#import_excel_step").append(Strack.loading_dom("white","","excel_data"))},success:function(e){200===parseInt(e.status)?(Strack.G.importExcelStep.goStep(3),Strack.reset_import_excel_step_bnt(3),Strack.init_format_datagrid(e.data)):layer.msg(e.message,{icon:7,time:1200,anim:6}),$("#st-load_excel_data").remove()}})},format_excel_file_data:function(){var e=Strack.get_switch_val("#method_file_header");$("#excel_upload_widget").uploadifive("settings","formData","has_header",e),$(".uploadifive-queue-item").hasClass("complete")?(Strack.G.importExcelStep.goStep(3),Strack.reset_import_excel_step_bnt(3)):$("#excel_upload_widget").uploadifive("upload")},init_excel_file_upload:function(e){$("#excel_upload_widget").uploadifive({auto:!1,removeCompleted:!1,formData:{timestamp:Strack.current_time(),batch_number:e.batch_number,module_id:e.module_id,project_id:e.project_id,page:e.page,schema_page:e.schema_page,has_header:0},multi:!1,queueSizeLimit:1,fileSizeLimit:"100MB",fileType:"text/csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",queueID:"import_method_queue",uploadScript:StrackPHP.formatExcelFileData,onUploadComplete:function(e,t){var a=JSON.parse(t);200===parseInt(a.status)?(Strack.G.importExcelStep.goStep(3),Strack.reset_import_excel_step_bnt(3),Strack.init_format_datagrid(a.data)):layer.msg(a.message,{icon:7,time:1200,anim:6})},onQueueComplete:function(e,t){}})},select_import_excel_method:function(e){$(".import-excel-card").removeClass("import-method-active"),$(e).addClass("import-method-active")},init_format_menu:function(e,t){var a="iconCls:'icon-unchecked'",i=$("#excel_fields_menu");if(i.hasClass("st-menu")){$("#import_ex_must").find(".menu-item").each(function(){i.menu("removeItem",this)}),$("#import_ex_other").find(".menu-item").each(function(){i.menu("removeItem",this)});var d="";e.forEach(function(e){d="fexn_"+e.fields,"yes"===e.require?i.menu("appendItem",{parent:$("#import_ex_must_wrap")[0],id:d,text:e.lang,iconCls:"icon-unchecked"}):i.menu("appendItem",{parent:$("#import_ex_other_wrap")[0],id:d,text:e.lang,iconCls:"icon-unchecked"}),$("#"+d).attr("data-bnt","mapping_field").attr("data-fields",e.fields).attr("data-mapping","").attr("data-fieldtype",e.field_type)})}else{var r="",o="";e.forEach(function(e){"yes"===e.require?r+='<div id="fexn_'+e.fields+'"  class="mapping-field" data-options="'+a+'" data-bnt="mapping_field" data-fields="'+e.fields+'" data-mapping="" data-fieldtype="'+e.field_type+'">'+e.lang+"</div>":o+='<div id="fexn_'+e.fields+'" class="mapping-field" data-options="'+a+'" data-bnt="mapping_field" data-fields="'+e.fields+'" data-mapping="" data-fieldtype="'+e.field_type+'">'+e.lang+"</div>"}),$("#import_ex_must").empty().append(r),$("#import_ex_other").empty().append(o),i.menu({onClick:function(e){var t=$("#excel_fields_val").val();Strack.toggle_map_excel_fields(this,e,t)},afterRender:function(){var e=this;$("#import_ex_must").find(".mapping-field").each(function(){Strack.auto_map_excel_fields(e,this,t)}),$("#import_ex_other").find(".mapping-field").each(function(){Strack.auto_map_excel_fields(e,this,t)})}})}return{}},auto_map_excel_fields:function(e,t,a){var i=$(t).find(".menu-text").html();if(0<=$.inArray(i,a)){var d=$(t)[0],r=$(e).menu("getItem",d);Strack.toggle_map_excel_fields(e,r,i)}},toggle_map_excel_fields:function(e,t,a){var i=$("#cell_ckt_"+a),d=i.parent(),r=i.attr("data-ckfield"),o=$("#fexn_"+r),n=$(t.target);switch(n.data("bnt")){case"cancel_mapping":o.data("mapping",""),o.find(".menu-icon").removeClass("icon-checked").addClass("icon-unchecked"),$(e).menu("enableItem",o[0]),i.attr("data-ckfield","").html(StrackLang.Non_Mapping_Field),d.removeClass("excel-tac").removeClass("mapping-active");break;case"mapping_field":if(!d.hasClass("mapping-active")){d.addClass("mapping-active");var s=$(t.target).data("fields"),l=$(t.target).find(".menu-text").html();$(t.target).attr("data-mapping",a),d.addClass("excel-tac"),i.attr("data-ckfield",s).html(l),n.find(".menu-icon").removeClass("icon-unchecked").addClass("icon-checked"),$(e).menu("disableItem",t.target)}}},build_import_ex_columns:function(e,t){var a=[],i="";return a.push({field:"ex_del_bnt",col_type:"bnt",title:StrackLang.Delete,align:"center",width:85,formatter:function(e,t,a){return'<a href="javascript:;" class="button" onclick="Strack.import_excel_grid_bnt(this)" data-rowid="'+t.id+'"><button class="ui basic red button">'+StrackLang.Delete+"</button></a>"}}),e.forEach(function(e){i="",0<=$.inArray(e,t)?a.push({field:e,col_type:"field",title:e,align:"center",width:130,formatter:function(e,t,a){return i=StrackPHP.ROOT+e,Strack.build_grid_thumb_dom(i)}}):a.push({field:e,col_type:"field",title:e,align:"center",width:130,editor:{type:"text"}})}),[a]},import_excel_grid_bnt:function(e){var t=$(e).attr("data-rowid");$("#import_excel_datagrid").datagrid("selectRecord",t);var a=$("#import_excel_datagrid").datagrid("getSelected"),i=$("#import_excel_datagrid").datagrid("getRowIndex",a);$("#import_excel_datagrid").datagrid("unselectRow",i),setTimeout(function(){$("#import_excel_datagrid").datagrid("deleteRow",i)},0)},init_format_datagrid:function(t){Strack.G.InputExCkfields={};var a={};t.header.forEach(function(e){a[e]={field_type:"excel",editor:"text",variable_id:0,primary:"",field_map:e,table:"Excel",module:"excel",module_type:"excel",field_value_map:e}});var e=$("#import_excel_datagrid");e.hasClass("datagrid-f")?e.datagrid("setOptions",{columnsFieldConfig:a,columns:Strack.build_import_ex_columns(t.header,t.images_column)}).datagrid("loadData",t.body):e.datagrid({data:t.body,fitColumns:!1,height:Strack.panel_height(".mapping-fields-wrap",0),rowheight:49,differhigh:!0,singleSelect:!0,HeaderField:!0,HeaderHeight:50,HeaderFieldData:{},idField:"id",cellUpdateMode:"manual",columnsFieldConfig:a,adaptive:{dom:".mapping-fields-wrap",min_width:1004,exth:115},frozenColumns:[[{field:"format_excel_id",checkbox:!0}]],columns:Strack.build_import_ex_columns(t.header,t.images_column),onLoadSuccess:function(e){Strack.init_format_menu(t.fields,t.header)}}).datagrid("enableCellEditing").datagrid("disableCellSelecting").datagrid("gotoCell",{index:0,field:"id"}).datagrid("columnMoving")},show_excel_check_fields:function(e,t){$("#excel_fields_val").val($(e).data("field")),$("#excel_fields_menu").menu("show",{left:t.clientX,top:t.clientY+15})},import_excel_step_submit:function(i){var e={};$("#import_ex_must").find(".menu-item").each(function(){$(this).data("mapping")&&(e[$(this).data("fields")]=$(this).data("mapping"))}),$("#import_ex_other").find(".menu-item").each(function(){$(this).data("mapping")&&(e[$(this).data("fields")]=$(this).data("mapping"))});var t=$("#import_excel_datagrid").datagrid("getData");$.ajax({type:"POST",url:StrackPHP.submitImportExcelData,dataType:"json",contentType:"application/json",data:JSON.stringify({param:i,field_mapping:e,grid_data:t.rows}),beforeSend:function(){$("#import_excel_step").append(Strack.loading_dom("white"))},success:function(e){if(Strack.G.importExcelStep.goStep(4),Strack.reset_import_excel_step_bnt(4),$(".excel-in-submit").hide(),200===parseInt(e.status)){var t=$("#excel_in_success");t.show(),t.find(".success-number").html(e.data.success_total),$("#"+i.grid).datagrid("reload")}else{var a=$("#excel_in_error");a.show(),a.find(".error-code").html(e.status),a.find(".error-line").html(e.data.line),a.find(".error-msg").html(e.data.message)}$("#st-load").remove()}})},close_import_excel:function(){$("#import_excel_slider").sidebar("toggle")},change_field_col:function(a){var i=$("#"+a);$(".iex_text").on("blur",function(){var e=$(this).attr("data-index"),t=i.datagrid("selectRow",e).datagrid("getSelected");t[$(this).closest("td").attr("field")]=$(this).val(),i.datagrid("updateRow",{index:e,row:t}),$(this).off("blur"),Strack.change_field_col(a)})},export_excel_file:function(e){var t=$(e).closest(".grid-toolbar").attr("data-grid");Strack.export_excel_dialog(t)},export_excel_dialog:function(e){Strack.open_dialog("dialog",{title:StrackLang.Export_Excel,width:480,height:180,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Egrid",type:"hidden",name:"grid",valid:1,value:e}],items:[{case:1,id:"Ename",type:"text",lang:StrackLang.Name,name:"excel_name",valid:1,value:""}],footer:[{obj:"export_excel",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]})})},export_excel:function(){var e=$("#Egrid").val(),t=$("#Ename").val(),a=$("#"+e).datagrid("options"),i=[],d=[];if(1<a.frozenColumns.length){a.frozenColumns[0].forEach(function(e){d.push(e)});var r=[];a.frozenColumns[1].forEach(function(e){e&&"id"!==e.field&&r.push(e)}),a.columns[0].forEach(function(e){d.push(e)}),a.columns[1].forEach(function(e){e&&"id"!==e.field&&r.push(e)}),i.push(d,r)}else a.frozenColumns[0].forEach(function(e){e&&"id"!==e.field&&d.push(e)}),a.columns[0].forEach(function(e){e&&"id"!==e.field&&d.push(e)}),i.push(d);$.ajax({type:"POST",url:StrackPHP.exportExcel,data:{filter_data:a.queryParams.filter_data,columns_data:JSON.stringify(i),excel_name:t,page:a.pageNumber,rows:a.pageSize},success:function(e){if(200===parseInt(e.status)){Strack.top_message({bg:"g",msg:e.message}),Strack.dialog_cancel();var t=StrackPHP.downloadExcel+"?id="+e.data.id;window.open(t)}else layer.msg(e.message,{icon:7,time:1200,anim:6})}})},manage_fields:function(e){var t=$(e).closest(".grid-toolbar"),a={lang:$(e).attr("data-lang"),page_name:t.attr("data-page"),grid:t.attr("data-grid"),module_id:t.attr("data-moduleid"),project_id:t.attr("data-projectid")};Strack.manage_fields_dialog(a)},manage_fields_dialog:function(i){Strack.open_dialog("dialog",{title:i.lang,width:680,height:464,content:Strack.dialog_dom({type:"datagrid",grid:{wrap_dom:"dialog_wrap",table_dom:"dialog_data",toolbar_show:!0,toolbar_id:"dialog_tb",toolbar_dom:[{obj:"Strack.add_custom_field",type:"button",icon:"icon-add",title:StrackLang.Add_Custom_Field}],top_notice:StrackLang.Manage_Custom_Fields_Notice,height:328},hidden:[{case:101,id:"Nlang",type:"hidden",name:"lang",valid:1,value:i.lang},{case:101,id:"Npage_name",type:"hidden",name:"page_name",valid:1,value:i.page_name},{case:101,id:"Nproject_id",type:"hidden",name:"project_id",valid:1,value:i.project_id},{case:101,id:"Ngrid",type:"hidden",name:"grid",valid:1,value:i.grid},{case:101,id:"Nmodule_id",type:"hidden",name:"module_id",valid:1,value:i.module_id}],footer:[{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){$("#dialog_data").datagrid({url:StrackPHP.getCustomFieldsList,fitColumns:!1,height:Strack.panel_height("#dialog_wrap",0),differhigh:!1,rowheight:49,DragSelect:!0,queryParams:i,columnsFieldConfig:{name:{field_type:"custom",field_map:"name",field_value_map:"name",primary:"id",module:"variable",table:"Variable"},code:{field_type:"custom",field_map:"code",field_value_map:"code",primary:"id",module:"variable",table:"Variable"}},columns:[[{field:"variable_delete",title:StrackLang.Delete,align:"center",findex:0,width:60,formatter:function(e,t,a){return"yes"!==t.lock?'<a href="javascript:;" onclick="Strack.del_custom_field(this)" data-id="'+t.id+'" data-projectid="'+i.project_id+'" data-moduleid="'+i.module_id+'"><i class="icon-remove p-cursor"></i></a>':""}},{field:"variable_edit",title:StrackLang.Edit,align:"center",findex:0,width:60,formatter:function(e,t,a){return'<a href="javascript:;" onclick="Strack.edit_custom_field(this)" data-id="'+t.id+'" data-projectid="'+i.project_id+'" data-moduleid="'+i.module_id+'"><i class="icon-edit p-cursor"></i></a>'}},{field:"id",title:StrackLang.ID,align:"center",findex:1,width:60},{field:"name",title:StrackLang.Name,align:"center",findex:2,width:160,editor:{type:"text"}},{field:"code",title:StrackLang.Code,align:"center",findex:3,width:160,editor:{type:"text"}},{field:"type",title:StrackLang.Field_Type,align:"center",findex:4,width:120}]],toolbar:"#dialog_tb",pagination:!0,pageSize:100,pageList:[100,200],pageNumber:1,pagePosition:"bottom",remoteSort:!1}).datagrid("enableCellEditing").datagrid("disableCellSelecting").datagrid("gotoCell",{index:0,field:"id"})},close:function(){Strack.G.IsNewfileds&&(Strack.G.IsNewfileds=!1,window.location.reload())}})},del_custom_field:function(e){var t=$(e),a={variable_id:t.data("id"),project_id:t.data("projectid"),module_id:t.data("moduleid")};Strack.G.IsNewfileds=!0,Strack.do_ajax_grid_delete("dialog_data",StrackLang.Del_Custom_Field_Notice,StrackPHP.deleteCustomField,!0,[a.variable_id],a)},edit_custom_field:function(e){var t=$(e),a={variable_id:t.data("id"),project_id:t.data("projectid"),module_id:t.data("moduleid"),lang:$("#Nlang").val(),page_name:$("#Npage_name").val(),grid:$("#Ngrid").val()},i=!1;Strack.G.IsNewfileds&&(Strack.G.IsNewfileds=!1,i=!0),Strack.dialog_cancel(),Strack.open_dialog("dialog",{title:StrackLang.Modify_Custom_Field,width:820,height:520,content:Strack.dialog_dom({type:"add_custom_field",hidden:[{case:101,id:"Nmode",type:"hidden",name:"mode",valid:1,value:"modify"},{case:101,id:"Nlang",type:"hidden",name:"lang",valid:1,value:a.lang},{case:101,id:"Npage_name",type:"hidden",name:"page_name",valid:1,value:a.page_name},{case:101,id:"Nproject_id",type:"hidden",name:"project_id",valid:1,value:a.project_id},{case:101,id:"Nvariable_id",type:"hidden",name:"variable_id",valid:1,value:a.variable_id},{case:101,id:"Ngrid",type:"hidden",name:"grid",valid:1,value:a.grid},{case:101,id:"Nmodule_id",type:"hidden",name:"module_id",valid:1,value:a.module_id}],footer:[{obj:"save_custom_field",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){$.ajax({type:"POST",url:StrackPHP.getCustomFieldsConfig,data:a,dataType:"json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close");var t={};switch(e.type){case"text":t={field_type:"text",lang:StrackLang.Input};break;case"combobox":t={field_type:"combobox",lang:StrackLang.Combobox};break;case"datebox":t={field_type:"datebox",lang:StrackLang.Datebox};break;case"datetimebox":t={field_type:"datetimebox",lang:StrackLang.Datetimebox};break;case"textarea":t={field_type:"textarea",lang:StrackLang.Text};break;case"checkbox":t={field_type:"checkbox",lang:StrackLang.Checkbox};break;case"belong_to":switch(e.relation_module_code){case"media":t={field_type:"media",lang:StrackLang.Media};break;case"status":t={field_type:"status",lang:StrackLang.Status}}break;case"horizontal_relationship":t={field_type:"horizontal_relationship",lang:StrackLang.Horizontal_Relationship}}$("#stdg_fd_list").empty().append(Strack.custom_field_type(t,a,!0)),Strack.select_field_type_active(t.lang,t.field_type,e)}})},close:function(){Strack.manage_fields_dialog(a),i&&(Strack.G.IsNewfileds=!0,i=!1)}})},select_field_type_active:function(e,t,a){switch($("#stdg_fd_title").html(e),Strack.fill_select_field_dom(t),$("#Fd_name").val(a.name),$("#Fd_code").val(a.code),t){case"text":$("#Fd_inputMask").combobox("setValue",a.input_mask),$("#Fd_inputMask_length").val(a.input_mask_length);break;case"combobox":for(var i in a.combo_list)$("#dg_comb_list").append(Strack.cf_comb_item_dom(a.combo_list[i]));Strack.rebuild_comb_index("#dg_comb_list",10);break;case"status":a.status_ids.forEach(function(e){var t="cf_"+Math.floor(1e4*Math.random()+1);$("#dg_status_comb_list").append(Strack.cf_status_comb_item_dom(t)),Strack.rebuild_comb_index("#dg_status_comb_list",1),Strack.combobox_widget("#"+t,{url:StrackPHP.getStatusList,valueField:"id",textField:"name",groupField:"correspond_name",width:250,height:26,value:e})});break;case"horizontal_relationship":$("#Fd_editor").combobox("setValue",a.editor),a.hasOwnProperty("relation_type")&&$("#Fd_relation_type").combobox("setValue",a.relation_type),$("#Fd_horizontal").combobox("disable").combobox("setValue",a.horizontal_config_id)}},add_custom_field:function(){var i={lang:$("#Nlang").val(),page_name:$("#Npage_name").val(),grid:$("#Ngrid").val(),module_id:$("#Nmodule_id").val(),project_id:$("#Nproject_id").val()},e=!1;Strack.G.IsNewfileds&&(Strack.G.IsNewfileds=!1,e=!0),Strack.dialog_cancel(),Strack.open_dialog("dialog",{title:StrackLang.Add_Custom_Field,width:820,height:520,content:Strack.dialog_dom({type:"add_custom_field",hidden:[{case:101,id:"Nmode",type:"hidden",name:"mode",valid:1,value:"add"},{case:101,id:"Nlang",type:"hidden",name:"lang",valid:1,value:i.lang},{case:101,id:"Npage_name",type:"hidden",name:"page_name",valid:1,value:i.page_name},{case:101,id:"Nproject_id",type:"hidden",name:"project_id",valid:1,value:i.project_id},{case:101,id:"Ngrid",type:"hidden",name:"grid",valid:1,value:i.grid},{case:101,id:"Nmodule_id",type:"hidden",name:"module_id",valid:1,value:i.module_id}],footer:[{obj:"save_custom_field",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){$.ajax({type:"POST",url:StrackPHP.whetherSupportHorizontalRelation,dataType:"json",data:{module_id:i.module_id},success:function(e){var t=[{field_type:"text",lang:StrackLang.Input},{field_type:"combobox",lang:StrackLang.Combobox},{field_type:"datebox",lang:StrackLang.Datebox},{field_type:"datetimebox",lang:StrackLang.Datetimebox},{field_type:"textarea",lang:StrackLang.Text},{field_type:"checkbox",lang:StrackLang.Checkbox},{field_type:"timespinner",lang:StrackLang.TimeSpinner}];"yes"===e.data.allow_belong_to&&(t.push({field_type:"status",lang:StrackLang.Status}),t.push({field_type:"media",lang:StrackLang.Media})),"yes"===e.data.allow_horizontal&&t.push({field_type:"horizontal_relationship",lang:StrackLang.Horizontal_Relationship});var a="";t.forEach(function(e){a+=Strack.custom_field_type(e,i)}),$("#stdg_fd_list").empty().append(a)}})},close:function(){Strack.manage_fields_dialog(i),e&&(Strack.G.IsNewfileds=!0,e=!1)}})},custom_field_type:function(e,t,a){var i="";return i+=a?'<a href="javascript:;" class="stdg-left-item stdg-item-ac">'+e.lang+"</a>":'<a href="javascript:;" onclick="Strack.select_field_type(this)" class="stdg-left-item" data-fieldtype="'+e.field_type+'" data-lang="'+e.lang+'" data-moduleid="'+t.module_id+'">'+e.lang+"</a>"},select_field_type:function(e){var t=$(e).data("lang"),a=$(e).data("fieldtype");$(e).data("moduleid");$(".stdg-left-item").removeClass("stdg-item-ac"),$(e).addClass("stdg-item-ac"),$("#stdg_fd_title").html(t),Strack.fill_select_field_dom(a)},fill_select_field_dom:function(e){var t=null,a="",i=$("#stdg_fd_main");switch(e){case"text":t=Strack.custom_f_text_conf(e);break;case"combobox":t=Strack.custom_f_comb_conf(e);break;case"textarea":case"checkbox":t=Strack.custom_f_textarea_conf(e);break;case"datebox":case"datetimebox":case"media":case"timespinner":t=Strack.custom_f_date_conf(e);break;case"status":t=Strack.custom_f_status_conf(e);break;case"expression":t=Strack.custom_f_expression_conf(e);break;case"horizontal_relationship":t=Strack.custom_f_horizontal_conf(e)}var d=$("#Nmodule_id").val(),r=$("#Nproject_id").val();switch(t.hide.forEach(function(e){a+=Strack.dialog_items(e)}),t.show.forEach(function(e){e.module_id=d,e.project_id=r,a+=Strack.dialog_base_item(e.lang,e)}),i.empty().append(a),e){case"datebox":case"datetimebox":case"text":case"combobox":case"textarea":case"checkbox":case"horizontal_relationship":Strack.combobox_widget("#Fd_inputMask",{url:StrackPHP.getInputMaskList,valueField:"id",textField:"name",width:378,height:26,value:"arbitrary",onChange:function(e,t){var a=$("#Fd_inputMask_length").closest(".st-dialog-items");0<=$.inArray(e,["arbitrary","integer_no_range","letter_no_range"])?a.show():a.hide()}}),Strack.combobox_widget("#Fd_horizontal",{url:StrackPHP.getHorizontalRelationList,valueField:"id",textField:"name",width:378,height:26,queryParams:{module_id:d}})}"horizontal_relationship"===e&&(Strack.combobox_widget("#Fd_editor",{data:[{id:"horizontal_relationship",name:StrackLang.GridDialog},{id:"tagbox",name:StrackLang.TagBox}],valueField:"id",textField:"name",value:"tagbox",width:378,height:26}),Strack.combobox_widget("#Fd_relation_type",{data:[{id:"has_one",name:StrackLang.Has_One},{id:"has_many",name:StrackLang.Has_Many}],valueField:"id",textField:"name",value:"has_many",width:378,height:26})),$(":input").inputmask()},custom_f_text_conf:function(e){return{hide:[{case:101,id:"Fd_type",type:"hidden",name:"field_type",valid:1,value:e}],show:[{case:1,id:"Fd_name",type:"text",lang:StrackLang.Field_Name,name:"name",valid:"1,128",value:"",mask:"*{1,128}"},{case:1,id:"Fd_code",type:"text",lang:StrackLang.Code,name:"code",valid:"1,128",value:"",mask:"alphaDash"},{case:2,id:"Fd_inputMask",type:"text",lang:StrackLang.Input_Mask,name:"input_mask",valid:"",value:""},{case:1,id:"Fd_inputMask_length",type:"text",lang:StrackLang.Input_Mask_Length,name:"input_mask_length",valid:"",value:"",mask:"9{1,999999999}"}]}},custom_f_comb_conf:function(e){return{hide:[{case:101,id:"Fd_type",type:"hidden",name:"field_type",valid:1,value:e}],show:[{case:1,id:"Fd_name",type:"text",lang:StrackLang.Field_Name,name:"name",valid:"1,128",value:"",mask:"*{1,128}"},{case:1,id:"Fd_code",type:"text",lang:StrackLang.Code,name:"code",valid:"1,128",value:"",mask:"alphaDash"},{case:103,id:"Fd_comblist",type:"text",lang:StrackLang.Combo_List,name:"comb_list",valid:1,value:""}]}},custom_f_textarea_conf:function(e){return{hide:[{case:101,id:"Fd_type",type:"hidden",name:"field_type",valid:1,value:e}],show:[{case:1,id:"Fd_name",type:"text",lang:StrackLang.Field_Name,name:"name",valid:"1,128",value:"",mask:"*{1,128}"},{case:1,id:"Fd_code",type:"text",lang:StrackLang.Code,name:"code",valid:"1,128",value:"",mask:"alphaDash"}]}},custom_f_date_conf:function(e){return{hide:[{case:101,id:"Fd_type",type:"hidden",name:"field_type",valid:1,value:e}],show:[{case:1,id:"Fd_name",type:"text",lang:StrackLang.Field_Name,name:"name",valid:"1,128",value:"",mask:"*{1,128}"},{case:1,id:"Fd_code",type:"text",lang:StrackLang.Code,name:"code",valid:"1,128",value:"",mask:"alphaDash"}]}},custom_f_status_conf:function(e){return{hide:[{case:101,id:"Fd_type",type:"hidden",name:"field_type",valid:1,value:e}],show:[{case:1,id:"Fd_name",type:"text",lang:StrackLang.Field_Name,name:"name",valid:"1,128",value:"",mask:"*{1,128}"},{case:1,id:"Fd_code",type:"text",lang:StrackLang.Code,name:"code",valid:"1,128",value:"",mask:"alphaDash"},{case:109,id:"Fd_comblist",type:"text",lang:StrackLang.Combo_List,name:"comb_list",valid:1,value:""}]}},custom_f_expression_conf:function(e){return{hide:[{case:101,id:"Fd_type",type:"hidden",name:"field_type",valid:1,value:e}],show:[{case:1,id:"Fd_name",type:"text",lang:StrackLang.Field_Name,name:"name",valid:"1,128",value:"",mask:"*{1,128}"},{case:1,id:"Fd_code",type:"text",lang:StrackLang.Code,name:"code",valid:"1,128",value:"",mask:"alphaDash"},{case:110,id:"Fd_expression",type:"text",lang:StrackLang.Expression,name:"expression",valid:"1",value:"",mask:""}]}},add_new_custom_field_express:function(e){var t=Math.floor(1e6*Math.random()+1),a=$(e).closest(".dg-express-list").find(".exp-list-wrap"),i=$(e).data("moduleid"),d=$(e).data("projectid");a.append(Strack.custom_field_express_dom(t,"exp-field"));var r={field_type:"built_in",data_source:"expression_fields",module_id:i,project_id:d};Strack.G.addCustomFieldExpressionData.param=r,Strack.combobox_widget("#cexp_"+t,{url:StrackPHP.getWidgetData,valueField:"id",textField:"name",groupField:"group_name",width:130,height:22,queryParams:r,onSelect:function(){Strack.generate_expression_data()}})},add_new_custom_operator_express:function(e){var t=Math.floor(1e6*Math.random()+1);$(e).closest(".dg-express-list").find(".exp-list-wrap").append(Strack.custom_field_express_dom(t,"exp-operator")),$("#cexp_"+t).combobox({data:[{id:"bracket_left",name:"("},{id:"bracket_right",name:")"},{id:"plus",name:"+"},{id:"minus",name:"-"},{id:"multiply",name:"*"},{id:"division",name:"/"}],height:22,width:70,valueField:"id",textField:"name",onSelect:function(){Strack.generate_expression_data()}})},generate_expression_data:function(){var e=$("#dg_express_setting"),t=e.find(".exp-list-wrap .express-item"),a=e.find(".dg-express-show"),i=1,d=0,r="",o={bracket_left:0,bracket_right:0,prev:"",prev_item:""},n={bracket_left:"(",bracket_right:")",plus:"+",minus:"-",multiply:"*",division:"/"},s=[],l={},c=[];t.each(function(){d=$(this).attr("id"),$(this).hasClass("exp-operator")?(r=Strack.get_combos_val("#"+d,"combobox","getValue"))?!$.isEmptyObject(o)&&"operator"===o.prev&&$.inArray(o.prev_item,["bracket_left","bracket_right"])<0?i=-2:(i=1,"bracket_left"!==r&&"bracket_right"!==r||o[r]++,o.prev="operator",o.prev_item=r,s.push(n[r]),c.push(n[r])):i=-1:($.isEmptyObject(Strack.G.addCustomFieldExpressionDataMap)&&$("#"+d).combobox("getData").forEach(function(e){Strack.G.addCustomFieldExpressionDataMap[e.id]=e}),(r=Strack.get_combos_val("#"+d,"combobox","getValue"))?$.isEmptyObject(o)||"field"!==o.prev&&("operator"!==o.prev||"bracket_right"!==o.prev_item)?(i=1,o.prev="field",o.prev_item=r,s.push(Strack.G.addCustomFieldExpressionDataMap[r].group_name+"."+Strack.G.addCustomFieldExpressionDataMap[r].name),c.push(r),l[r]=Strack.G.addCustomFieldExpressionDataMap[r]):i=-2:i=-1)}),o.bracket_left!==o.bracket_right&&(i=-2),"operator"===o.prev&&"bracket_right"!==o.prev_item&&(i=-2),Strack.G.addCustomFieldExpressionData.fill_status=i,Strack.G.addCustomFieldExpressionData.formula_fields=l,Strack.G.addCustomFieldExpressionData.formula=c.join(" "),a.empty().append(s.join(" "))},custom_field_express_dom:function(e,t){var a="";return a+='<div class="exp-input aign-left"><div class="exp-input-wg aign-left"><input id="cexp_'+e+'" class="'+t+' express-item"/></div><div class="exp-del-wg aign-left"><a href="javascript:;" class="exp-del-bnt" onclick="Strack.delete_custom_field_express_dom(this)"><i class="icon-uniE6D5"></i></a></div></div>'},delete_custom_field_express_dom:function(e){$(e).closest(".exp-input").remove(),Strack.generate_expression_data()},custom_f_horizontal_conf:function(e){return{hide:[{case:101,id:"Fd_type",type:"hidden",name:"field_type",valid:1,value:e}],show:[{case:1,id:"Fd_name",type:"text",lang:StrackLang.Field_Name,name:"name",valid:"1,128",value:"",mask:"*{1,128}"},{case:1,id:"Fd_code",type:"text",lang:StrackLang.Code,name:"code",valid:"1,128",value:"",mask:"alphaDash"},{case:2,id:"Fd_relation_type",type:"text",lang:StrackLang.Relation_Type,name:"relation_type",valid:"1",value:""},{case:2,id:"Fd_editor",type:"text",lang:StrackLang.Editor,name:"editor",valid:"1",value:""},{case:2,id:"Fd_horizontal",type:"text",lang:StrackLang.Relation_Module_List,name:"relation_module",valid:"1",value:""}]}},add_cf_comb_item:function(e){$("#dg_comb_list").append(Strack.cf_comb_item_dom("")),Strack.rebuild_comb_index("#dg_comb_list",10)},cf_comb_item_dom:function(e){var t="";return t+='<div class="dg-cblist-item"><div class="dgcb-id aign-left"><input type="text" disabled="disabled"></div><div class="dgcb-name aign-left"><input type="text" value="'+e+'"></div><a href="javascript:;" onclick="Strack.del_cf_comb_item(this)" class="dgcb-deitem aign-left"><i class="icon-uniEA34 icon-right"></i></a></div>'},del_cf_comb_item:function(e){$(e).parent().remove(),Strack.rebuild_comb_index("#dg_comb_list",10)},rebuild_comb_index:function(e,t){var a=0;$(e).find(".dg-cblist-item").each(function(){a+=t,$(this).find(".dgcb-id input").val(a)})},add_cf_status_comb_item:function(){var e="cf_"+Math.floor(1e4*Math.random()+1);$("#dg_status_comb_list").append(Strack.cf_status_comb_item_dom(e)),Strack.rebuild_comb_index("#dg_status_comb_list",1),Strack.combobox_widget("#"+e,{url:StrackPHP.getStatusList,valueField:"id",textField:"name",groupField:"correspond_name",width:250,height:26})},cf_status_comb_item_dom:function(e){var t="";return t+='<div class="dg-cblist-item"><div class="dgcb-id aign-left"><input type="text" disabled="disabled"></div><div class="dgcb-name aign-left"><input id="'+e+'" type="text"></div><a href="javascript:;" onclick="Strack.del_cf_status_comb_item(this)" class="dgcb-deitem aign-left" data-randomid="'+e+'"><i class="icon-uniEA34 icon-right"></i></a></div>'},del_cf_status_comb_item:function(e){var t=$(e).attr("data-randomid");$("#"+t).combobox("destroy"),$(e).parent().remove(),Strack.rebuild_comb_index("#dg_status_comb_list",1)},save_custom_field:function(){var e,t,a=$("#Fd_type").val(),d=[],r=!1,i={};if($(".st-dialog-input").children("i").remove(),$("#stdg_fd_main").find(".st-dialog-input").each(function(){var e=$(this).children("input"),t="",a="",i="";if(0===e.length&&(e=$(this).children("textarea")),!$.isEmptyObject(e[0])){if(t=e.attr("data-name"),i=e.data("valid"),a=e.hasClass("combobox-f")?Strack.get_combos_val("#"+e.attr("id"),"combobox","getValue"):$("#"+e.attr("id")).val(),!(0==i||0<a.length)){switch(t){case"name":layer.msg(StrackLang.Variable_Name_Null,{icon:2,time:1200,anim:6});break;case"code":layer.msg(StrackLang.Variable_Code_Null,{icon:2,time:1200,anim:6});break;case"editor":layer.msg(StrackLang.Variable_Editor_Null,{icon:2,time:1200,anim:6});break;case"relation_module":layer.msg(StrackLang.Variable_Relation_Module_Null,{icon:2,time:1200,anim:6})}return e.parent().append(Strack.dialog_error_icon("e")),r=!1}d.push({field:t,value:a}),e.parent().append(Strack.dialog_error_icon("t")),r=!0}}),r)switch(i.base_data=d,a){case"combobox":e=$("#dg_comb_list").find(".dgcb-name input"),t=[],0<e.length?(e.each(function(){var e=$(this).val();if(!e)return layer.msg(StrackLang.Variable_Combobox_Menu_Val_Null,{icon:2,time:1200,anim:6}),r=!1;t.push(e)}),i.field_type="combobox",i.comb_data=t):(r=!1,layer.msg(StrackLang.Variable_Combobox_Menu_Null,{icon:2,time:1200,anim:6}));break;case"status":e=$("#dg_status_comb_list").find("input.combobox-f"),t=[],0<e.length?(e.each(function(){var e=Strack.get_combos_val(this,"combobox","getValue");if(!e)return layer.msg(StrackLang.Variable_Combobox_Menu_Val_Null,{icon:2,time:1200,anim:6}),r=!1;t.push(e)}),i.field_type="belong_to",i.editor="combobox",i.comb_data=t,i.relation_module_code="status"):(r=!1,layer.msg(StrackLang.Variable_Combobox_Menu_Null,{icon:2,time:1200,anim:6}));break;case"media":i.field_type="belong_to",i.editor="upload",i.relation_module_code="media";break;case"expression":if(i.field_type="expression",$.isEmptyObject(Strack.G.addCustomFieldExpressionData)||1!==Strack.G.addCustomFieldExpressionData.fill_status)switch(r=!1,Strack.G.addCustomFieldExpressionData.fill_status){case-2:layer.msg(StrackLang.Variable_Expression_Formula_Syntax_Error,{icon:2,time:1200,anim:6});break;default:layer.msg(StrackLang.Variable_Expression_Formula_Null,{icon:2,time:1200,anim:6})}else i.expression=Strack.G.addCustomFieldExpressionData;break;default:i.field_type=a}if(r){var o={};if($("#st_dialog_form_hide").find("input").each(function(){o[$(this).attr("data-name")]=$(this).val()}),i.base_data.push({field:"action_scope",value:"current"}),"text"===i.field_type){var n={field:"mask",value:""},s={};switch(i.base_data.forEach(function(e){s[e.field]=e.value}),s.input_mask){case"arbitrary":n.value=0<parseInt(s.input_mask_length)?"*{1,"+s.input_mask_length+"}":"*{1,999999999999999999}";break;case"integer_no_range":n.value=0<parseInt(s.input_mask_length)?"9{1,"+s.input_mask_length+"}":"9{1,999999999999999999}";break;case"letter_no_range":n.value=0<parseInt(s.input_mask_length)?"a{1,"+s.input_mask_length+"}":"a{1,999999999999999999}";break;default:n.value=s.input_mask}i.base_data.push(n)}var l="";switch(o.mode){case"add":l=StrackPHP.addCustomFields;break;case"modify":l=StrackPHP.modifyCustomFields}$.ajax({type:"POST",url:l,data:JSON.stringify({param:o,field_data:i}),dataType:"json",contentType:"application/json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),200===parseInt(e.status)?(Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message})):layer.msg(e.message,{icon:7,time:1200,anim:6})}})}},frozen_col:function(e,t){var a=$(e).closest("td").attr("field"),i=$(e).find("i"),d=$(e).data("index"),r=$(e).closest(".datagrid-view").find(".datagrid-f").attr("id"),o=$("#"+r);t.stopPropagation(),i.hasClass("icon-uniF023")?o.datagrid("FrozenColumn",{field:a,index:d,isfrozen:"frozen"}).datagrid("reload"):o.datagrid("FrozenColumn",{field:a,index:d,isfrozen:"nofrozen"}).datagrid("reload"),o.datagrid("highlightViewSave")},build_comb_avatar:function(e){var t="";return t+='<div class="comb-avatar"><div class="comb-aimg aign-left">'+Strack.build_avatar(e.avatar,"e-avatar-small","d-avatar-small",Strack.JointLetter(e.first_name,e.last_name))+'</div><div class="comb-name text-ellipsis aign-left">'+e.uname+"</div></div>"},widget_status_dom:function(e,t,a){var i="";return i+='<i class="'+e+' icon-left" style="color:'+Strack.hex_to_rgb(a,1)+'" ></i>',i+=t},init_filter_event:function(e){e.find(".filter-task-panel input,.filter-task-panel textarea").off("change").on("change",function(){"checkbox"!=$(this).attr("type")&&Strack.filter_auto(this)})},filter_auto:function(e){$(e).closest(".datagrid-filter").find(".filter_auto_in").is(":checked")&&Strack.filter_apply($(e))},reset_filter_condition_value:function(e,t){var a=!1;return e.forEach(function(e){e.field===t.field&&(e.value=t.value,e.condition=t.condition,e.variable_id=t.variable_id,a=!0)}),a||e.push(t),e},filter_manual:function(e){Strack.filter_apply($(e))},filter_apply:function(e){var t=e.closest(".grid-filter-right").find(".filter-items");if(0<t.length){var a,i,d,r,o,n,s,l,c,_,m,u,g,p=[];t.each(function(){switch(a=$(this).attr("field"),i=$(this).attr("field_type"),d=$(this).attr("variable_id"),r=$(this).attr("editor"),o=$(this).attr("module"),n=$(this).attr("module_type"),s=$(this).attr("table"),l=$(this).find(".filter-input-wrap"),r){case"text":case"textarea":c=Strack.get_combos_val(l.find(".term-list")[0],"combobox","getValue"),(_=l.find(".input-text").val())&&c&&p.push({field:a,field_type:i,variable_id:d,value:_,condition:c,editor:r,module_code:o,module_type:n,table:s});break;case"tagbox":case"horizontal_relationship":case"relation":case"checkbox":case"combobox":var e=l.find(".in-combobox"),t=e.combobox("options");g=t.multiple?(_=Strack.get_combos_val(e[0],"combobox","getValues"),"IN"):(_=Strack.get_combos_val(e[0],"combobox","getValue"),"EQ"),_&&p.push({field:a,field_type:i,variable_id:d,value:_,condition:g,editor:r,module_code:o,module_type:n,table:s});break;case"datebox":case"datetimebox":m=l.find(".in-date-term").prop("checked"),u=l.find(".in-date-range").prop("checked"),m&&(c=Strack.get_combos_val(l.find(".term-list")[0],"combobox","getValue"),(_=l.find(".term-date").datebox("getValue"))&&c&&p.push({field:a,field_type:i,variable_id:d,value:_,condition:c,editor:r,module_code:o,module_type:n,table:s})),u&&(c=l.find(".start-date").datebox("getValue"),(_=l.find(".end-date").datebox("getValue"))&&c&&p.push({field:a,field_type:i,variable_id:d,value:c+","+_,condition:"BETWEEN",editor:r,module_code:o,module_type:n,table:s}))}});var f=e.closest(".datagrid-filter"),h=f.attr("data-maindom"),v=f.attr("data-bardom"),k=$("#"+h).find(".datagrid-f"),b=k.datagrid("options");if(b.isKanban){var S=$(".datagrid-view-kanban").boards().data("boards"),y=JSON.parse(b.queryParams.filter_data);y.filter.filter_advance=[],y.filter.filter_input=[],y.filter.filter_panel=p,b.queryParams.filter_data=JSON.stringify(y),S.resetQueryConfig(b.queryParams),S.reload()}else k.datagrid("setFilterParams",{filter_input:[],filter_panel:p,filter_advance:[]}).datagrid("reload");Strack.save_filter_cache(v,"filter_panel",p),Strack.show_nosaved_filter(v,"filter_panel",StrackLang.Panel_Filter)}else layer.msg(StrackLang.Please_Choice_Filter,{icon:2,time:1200,anim:6})},group_sort_change:function(e){var t=$(e).data("grid"),r=$(e).data("ptype"),o=$(e).data("pid"),n=$(e).data("sort");$("#"+t);$(e).hasClass("field-disable")&&($("#gasc_sort_"+r).addClass("field-disable"),$("#gdesc_sort_"+r).addClass("field-disable"),$(".gitem_"+r).each(function(){if($(this).find("i").hasClass("icon-checked")){$("#g"+n+"_sort_"+r).removeClass("field-disable");var e,t={},a=$(this).data("field"),i=$(this).data("grid"),d=$("#"+i);e=[{sortName:a,sortOrder:t[a]=n}],Strack.DataSortAc(d,$(this),r,t,e,"noadv",!0),Strack.save_storage("GroupSort_"+o+"_"+r,JSON.stringify(e)),Strack.delete_storage("AdvSort_"+o+"_"+r)}}))},thumb_media_widget:function(e,t,a){var i=Math.floor(1e6*Math.random()+1),d={id:i,css:"thumb-"+t.module_id+"-"+t.link_id,link_id:t.link_id,module_id:t.module_id,has_media:t.has_media,media_param:t.param};$(e).empty().append(Strack.thumb_media_widget_dom(i,d,a)),"yes"===t.has_media&&Strack.init_thumb_media(i),Strack.init_dropdown()},thumb_media_common_dom:function(e,t){var a=Math.floor(1e6*Math.random()+1),i=t.config.fields+"-"+t.param.module_id+"-"+t.param.primary,d="no",r={};if(e&&0<e.total)switch(d="yes",r=e.rows[0].param,t.from){case"common":Strack.G.infoMediaNeedInit.push(a);break;case"grid":Strack.G.gridMediaNeedInit.push(a)}var o={id:a,css:i,link_id:t.param.primary,module_id:t.param.module_id,has_media:d,media_param:r};return Strack.thumb_media_widget_dom(a,o,{modify_thumb:"no",clear_thumb:"no"})},build_grid_preview_thumb_dom:function(e){var t={total:0,rows:[]};return e.thumb&&(t.total=1,t.rows.push({param:e.param})),Strack.thumb_media_common_dom(t,{param:{primary:e.id,module_id:e.module_id},from:"grid",config:e.field_config})},thumb_media_widget_dom:function(e,t,a){var i="";return i+='<div class="item-thumb-warp '+t.css+'" thumb-type="thumb"><div id="light_box_main_'+e+'" class="task-thumb-show" data-id="'+e+'">'+Strack.thumb_media_preview_dom(t)+'</div><div id="light_box_video_'+e+'" class="light-video">'+Strack.thumb_media_preview_video_dom(t)+"</div>","yes"===a.modify_thumb&&"yes"===a.clear_thumb&&(i+='<div class="ui secondary vertical menu thumb-menu-bnt" data-linkid="'+t.link_id+'" data-moduleid="'+t.module_id+'"><div class="ui dropdown item"><i class="icon-uniF03A"></i><div class="menu">',"yes"===a.modify_thumb&&(i+='<a href="javascript:;" class="item" onclick="Strack.change_item_media(this)">'+StrackLang.Modify_Thumb+"</a>"),"yes"===a.clear_thumb&&(i+='<a href="javascript:;" class="item" onclick="Strack.clear_item_thumb(this)">'+StrackLang.Clear_Thumb+"</a>"),i+="</div></div></div>"),i+="</div>"},init_thumb_media:function(e){lightGallery(document.getElementById("light_box_main_"+e),{galleryId:e,appendSubHtmlTo:".lg-item",addClass:"lg-comments",mode:"lg-fade",enableDrag:!1,download:!1,enableSwipe:!1})},init_other_thumb_media:function(e){switch(e){case"common":Strack.G.infoMediaNeedInit.forEach(function(e){Strack.init_thumb_media(e)}),Strack.G.infoMediaNeedInit=[];break;case"grid":Strack.G.gridMediaNeedInit.forEach(function(e){Strack.init_thumb_media(e)}),Strack.G.gridMediaNeedInit=[]}},thumb_media_preview_dom:function(e){var t="",a=e.media_param;"yes"===e.has_media&&0<=$.inArray(a.type,["image","video"])?t+=Strack.light_box_item_dom(e.id,a).main_dom:t+='<div class="task-thumb-null"><i class="icon-left-p '+(e.media_param.icon?e.media_param.icon:"icon-uniE61A")+'"></i></div>';return t},thumb_media_preview_video_dom:function(e){var t="";"yes"===e.has_media&&"video"===e.media_param.type&&(t+='<video class="lg-video-object lg-html5" controls preload="none" loop="loop" ><source src="'+(e.media_param.base_url+e.media_param.md5_name+".mp4")+'" type="video/mp4">Your browser does not support HTML5 video.</video>');return t},show_note_img_att:function(e,t){var a,i,d="",r="";return"yes"===t.has_media&&t.param.forEach(function(e){i="item"+Math.floor(1e5*Math.random()+1),a=Strack.light_box_item_dom(i,e),d+=a.main_dom,r+=a.video_dom}),'<div id="light_box_main_'+e+'">'+d+"</div>"+r},light_box_item_dom:function(e,t){var a="",i="";switch(t.type){case"image":var d=[],r="",o="",n="",s=0;(Strack.is_string(t.size)?t.size.split(","):t.size).forEach(function(e){r=t.base_url+t.md5_name+"_"+e+"."+t.ext,"origin"===e?(s=t.width,n=r):s=e.split("x")[0],s<999999&&(o=r),d.push(r+" "+s)}),a='<a class="light-box" data-responsive="'+d.join(",")+'" data-src="'+n+'" ><img src="'+o+'" /><div class="light-poster"><i class="icon icon-uniE647"></i></div></a>';break;case"video":var l=t.base_url+t.md5_name+".jpg";a='<a class="light-box" data-poster="'+l+'"  data-html="#light_box_video_'+e+'" ><img class="img-responsive" src="'+l+'"><div class="light-poster"><i class="icon icon-uniE647"></i></div></a>',i+='<div id="light_box_video_'+e+'" class="light-video"><video class="lg-video-object lg-html5" controls preload="none" loop="loop" ><source src="'+(t.base_url+t.md5_name+".mp4")+'" type="video/mp4">Your browser does not support HTML5 video.</video></div>'}return{main_dom:a,video_dom:i}},build_thumb_dom:function(e,t){var a="";return a+=e?'<img class="proj_thumb_ck" src="'+e+'">':'<div class="panel-thumb-null proj_thumb_ck"><i class="'+t+'"></i></div>'},build_grid_thumb_dom:function(e){var t="",a="";return a+='<a href="#" class="athumb"  >'+(t+=e?'<img src="'+e+'">':'<i class="icon-left-p icon-uniE61A"></i>')+"</a>"},get_media_server:function(t,a){$.ajax({type:"POST",url:StrackPHP.getMediaUploadServer,dataType:"json",success:function(e){200===parseInt(e.status)?(Strack.G.Media_Server=e.data,t(e.data)):a?a(e):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},assembly_media_thumb_data:function(e,t){var a={size:"",thumb:""};switch(t.type){case"video":a.size=t.width+"x"+t.height,a.thumb=e.request_url+""+t.path+t.md5_name+".jpg";break;case"image":a.size=t.size;var i=t.size.split(","),d="origin";i.forEach(function(e){"origin"!==e&&-1!==e.indexOf("x")&&e.split("x")[0]<999999&&(d=e)}),a.thumb=e.request_url+""+t.path+t.md5_name+"_"+d+"."+t.ext}return a},save_media_data:function(e,t){e.media_data.base_url=e.media_server.request_url+e.media_data.path,$.ajax({type:"POST",url:StrackPHP.saveMediaData,dataType:"json",data:JSON.stringify(e),contentType:"application/json",success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.Websocket.List.hasOwnProperty("update")||(e.data.status=200,Strack.update.thumbnail(e.data))):layer.msg(e.message,{icon:7,time:1200,anim:6}),t(e)}})},upload_avatar_dialog:function(e){var t=$(e).attr("data-userid"),a=$(e).attr("data-moduleid"),i=$(e).attr("data-avatarid");Strack.get_media_server(function(e){Strack.open_dialog("dialog",{title:StrackLang.Modify_Avatar,width:580,height:700,top:null,content:Strack.dialog_dom({type:"avatar",header_extra:{user_data:{dom_id:i,user_id:t,module_id:a},lang:StrackLang.Modify_Avatar},hidden:[{case:101,id:"Nuser_id",type:"hidden",name:"user_id",valid:1,value:t},{case:101,id:"Nmodule_id",type:"hidden",name:"module_id",valid:1,value:a}],footer:[{obj:"upload_avatar",type:5,title:StrackLang.Upload},{id:"delete_img",type:3,title:StrackLang.Clear_Canvas},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){Strack.js("crop_avatar_js",StrackPHP.JS+"/jquery.Jcrop.min.js"),$(".user-avatar-wrap").hide(),Strack.upload_preview({UpBtn:"img_upload",Showpanel:!0,Canvas:"canvas_crop_img",Cancel:[".user-avatar",".user-avatar-wrap","#delete_img"],Jcrop:"canvas_crop_tool",Width:522,Height:302,MinLimit:90})},close:function(){Strack.G.Jcrop_Thumb=null,Strack.G.Jcrop_Thumb_Ext=""}})})},upload_avatar:function(){if(Strack.G.Jcrop_Thumb){var t=$("#Nuser_id").val(),a=$("#Nmodule_id").val(),e=Strack.G.Jcrop_Canvas.toDataURL("image/png"),i=Strack.G.Media_Server;$.ajax({type:"POST",url:i.upload_url,dataType:"json",data:{token:i.token,belong_system:StrackPHP.Belong_System,size:"90x90",ext:Strack.G.Jcrop_Thumb_Ext,crop:JSON.stringify({x:Strack.G.Jcrop_Thumb.x,y:Strack.G.Jcrop_Thumb.y,w:Strack.G.Jcrop_Thumb.w,h:Strack.G.Jcrop_Thumb.h}),base64Img:e},beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){200===parseInt(e.status)?Strack.save_media_data({link_id:t,module_id:a,media_server:i,media_data:e.data,mode:"single"},function(e){$.messager.progress("close"),Strack.dialog_cancel()}):($.messager.progress("close"),layer.msg(e.message,{icon:7,time:1200,anim:6}))}})}else layer.msg(StrackLang.Please_Select_Image_File,{icon:2,time:1200,anim:6})},change_item_media:function(e){var t=$(e).closest(".thumb-menu-bnt"),a=t.attr("data-linkid"),i=t.attr("data-moduleid");Strack.open_change_item_media({title:StrackLang.Modify_Thumb,link_id:a,module_id:i,mode:"single",from:"widget",field_type:"built_in",variable_id:0})},upload_onset_att:function(e){$(e).attr("data-from");var t=$(e).attr("data-moduleid"),a=$(e).attr("data-linkid");Strack.open_change_item_media({title:StrackLang.Upload_Onset_Reference,link_id:a,module_id:t,mode:"multiple",from:"onset",field_type:"built_in",variable_id:0})},load_onset_attachment:function(t,e){$.ajax({type:"POST",url:StrackPHP.getOnsetAttachment,contentType:"application/json",data:JSON.stringify(e),dataType:"json",beforeSend:function(){$(".onset-wrap-right").prepend(Strack.loading_dom("white","","onset_att"))},success:function(e){"yes"===e.has_media?Strack.generate_media_list_dom(t,e):$(t).html('<div class="datagrid-empty-no">'+StrackLang.Please_Upload_Onset_Reference+"</div>"),$("#st-load_onset_att").remove()}})},create_horizontal_relationship:function(e){var t=$(e).closest(".grid-toolbar"),a=$(e),i={project_id:t.data("projectid"),grid_id:t.data("grid"),variable_id:a.attr("variableid"),src_module_id:a.attr("srcmoduleid"),dst_module_id:a.attr("dstmoduleid"),src_link_id:a.attr("srclinkid"),horizontal_type:a.attr("horizontaltype"),link_data:[],from:"toolbar"};Strack.open_h_relationship_dialog(i)},open_h_relationship_dialog:function(a){Strack.open_dialog("dialog",{title:StrackLang.Horizontal_Relationship,width:1200,height:600,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mdst_module_id",type:"hidden",name:"temp_id",valid:1,value:a.dst_module_id},{case:101,id:"Mgrid_id",type:"hidden",name:"id_field",valid:1,value:a.grid_id},{case:101,id:"Msrc_link_id",type:"hidden",name:"category",valid:1,value:a.src_link_id},{case:101,id:"Msrc_module_id",type:"hidden",name:"category",valid:1,value:a.src_module_id},{case:101,id:"Mlink_ids",type:"hidden",name:"module_code",valid:1,value:a.link_data.join(",")}],items:[{case:12,id:"",type:"text",lang:"",name:"",valid:"",value:0}],footer:[{obj:"update_h_relate_set",type:5,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){var t=$("#h_relationship_src");t.datagrid({url:StrackPHP.getHRelationDestData,width:540,height:460,fitColumns:!0,DragSelect:!0,frozenColumns:[[{field:"id",checkbox:!0}]],columns:[[{field:"show_id",title:StrackLang.ID,align:"center",width:80,formatter:function(e,t,a){return t.id}},{field:"name",title:StrackLang.Name,align:"center",width:160},{field:"code",title:StrackLang.Code,align:"center",width:160}]],queryParams:{filter_data:JSON.stringify(a),selected_ids:JSON.stringify(a.link_data),search_val:"",mode:"all"},pagination:!0,pageNumber:1,pageSize:300,pageList:[300,500,1e3,2e3],pagePosition:"bottom",pageLayout:["list","prev","sep","manual","sep","next","refresh"]}),$("#h_relationship_search").searchbox({searcher:function(e){t.datagrid("reload",{filter_data:JSON.stringify(a),search_val:e,mode:"all"})},height:28,width:540,buttonRightVal:2,buttonRadius:!1,prompt:StrackLang.Search_More}),$("#h_relationship_dst").datagrid({url:StrackPHP.getHRelationDestData,width:540,height:488,fitColumns:!0,DragSelect:!0,frozenColumns:[[{field:"id",checkbox:!0}]],columns:[[{field:"show_id",title:StrackLang.ID,align:"center",width:80,formatter:function(e,t,a){return t.id}},{field:"name",title:StrackLang.Name,align:"center",width:160},{field:"code",title:StrackLang.Code,align:"center",width:160}]],queryParams:{filter_data:JSON.stringify(a),selected_ids:JSON.stringify(a.link_data),search_val:"",mode:"selected"},pagination:!0,pageNumber:1,pageSize:300,pageList:[300,500,1e3,2e3],pagePosition:"bottom",pageLayout:["list","prev","sep","manual","sep","next","refresh"]})},close:function(){$("#"+a.grid_id).datagrid("reload")}})},move_to_h_relation_panel:function(){var t=$("#h_relationship_src"),a=$("#h_relationship_dst"),e=t.datagrid("getSelections");if(e.length<1)layer.msg(StrackLang.Please_Select_One,{icon:2,time:1200,anim:6});else{var i=0,d=[],r=t.datagrid("options"),o=JSON.parse(r.queryParams.selected_ids);e.forEach(function(e){i=t.datagrid("getRowIndex",e),-1===$.inArray(e.id,o)&&Strack.G.horizontalRelationIds.add.push(e.id),d.push(e.id),t.datagrid("deleteRow",i),a.datagrid("appendRow",e)});var n=[];Strack.G.horizontalRelationIds.delete.forEach(function(e){-1===$.inArray(e,d)&&n.push(e)}),Strack.G.horizontalRelationIds.delete=n}},remove_h_relate_set:function(){var e=$("#h_relationship_src"),t=$("#h_relationship_dst"),a=t.datagrid("getSelections");if(a.length<1)layer.msg(StrackLang.Please_Select_One,{icon:2,time:1200,anim:6});else{var i=e.datagrid("options"),d=JSON.parse(i.queryParams.filter_data),r=JSON.parse(i.queryParams.selected_ids),o=0,n=[];a.forEach(function(e){0<=$.inArray(e.id,r)&&Strack.G.horizontalRelationIds.delete.push(e.id),n.push(e.id),o=t.datagrid("getRowIndex",e),t.datagrid("deleteRow",o)});var s=[];Strack.G.horizontalRelationIds.add.forEach(function(e){-1===$.inArray(e,n)&&s.push(e)}),Strack.G.horizontalRelationIds.add=s,d.link_data=[],t.datagrid("getRows").forEach(function(e){d.link_data.push(e.id)}),i.queryParams.filter_data=JSON.stringify(d),e.datagrid("reload",i.queryParams)}},update_h_relate_set:function(){var e=$("#h_relationship_dst").datagrid("options"),t=JSON.parse(e.queryParams.filter_data);Strack.G.horizontalRelationIds.add.length<1&&Strack.G.horizontalRelationIds.delete.length<1?layer.msg(StrackLang.Please_Select_One,{icon:2,time:1200,anim:6}):$.ajax({type:"POST",url:StrackPHP.modifyHRelationDestData,data:JSON.stringify({param:t,up_data:Strack.G.horizontalRelationIds}),dataType:"json",contentType:"application/json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),Strack.G.horizontalRelationIds={add:[],delete:[]},200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.dialog_cancel()):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},open_has_many_dialog:function(a){Strack.open_dialog("dialog",{title:StrackLang.Has_Many_Relation,width:1200,height:600,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mdst_module_id",type:"hidden",name:"temp_id",valid:1,value:a.dst_module_id},{case:101,id:"Mgrid_id",type:"hidden",name:"id_field",valid:1,value:a.grid_id},{case:101,id:"Msrc_link_id",type:"hidden",name:"category",valid:1,value:a.src_link_id},{case:101,id:"Msrc_module_id",type:"hidden",name:"category",valid:1,value:a.src_module_id},{case:101,id:"Mfield_module",type:"hidden",name:"category",valid:1,value:a.field_module},{case:101,id:"Mfield_table",type:"hidden",name:"category",valid:1,value:a.field_table},{case:101,id:"Mlink_ids",type:"hidden",name:"module_code",valid:1,value:a.link_data.join(",")}],items:[{case:12,id:"",type:"text",lang:"",name:"",valid:"",value:0}],footer:[{obj:"update_has_many_set",type:5,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){var t=$("#h_relationship_src");t.datagrid({url:StrackPHP.getHasManyRelationData,width:540,height:460,fitColumns:!0,ctrlSelect:!0,DragSelect:!0,frozenColumns:[[{field:"id",checkbox:!0}]],columns:[[{field:"show_id",title:StrackLang.ID,align:"center",width:80,formatter:function(e,t,a){return t.id}},{field:"name",title:StrackLang.Name,align:"center",width:160},{field:"code",title:StrackLang.Code,align:"center",width:160}]],queryParams:{filter_data:JSON.stringify(a),selected_ids:JSON.stringify(a.link_data),search_val:"",mode:"all"},pagination:!0,pageNumber:1,pageSize:300,pageList:[300,500,1e3,2e3],pagePosition:"bottom",pageLayout:["list","prev","sep","manual","sep","next","refresh"]}),$("#h_relationship_search").searchbox({searcher:function(e){t.datagrid("reload",{filter_data:JSON.stringify(a),selected_ids:JSON.stringify(a.link_data),search_val:e,mode:"all"})},height:28,width:540,buttonRightVal:2,buttonRadius:!1,prompt:StrackLang.Search_More}),$("#h_relationship_dst").datagrid({url:StrackPHP.getHasManyRelationData,width:540,height:488,fitColumns:!0,DragSelect:!0,frozenColumns:[[{field:"id",checkbox:!0}]],columns:[[{field:"show_id",title:StrackLang.ID,align:"center",width:80,formatter:function(e,t,a){return t.id}},{field:"name",title:StrackLang.Name,align:"center",width:160},{field:"code",title:StrackLang.Code,align:"center",width:160}]],queryParams:{filter_data:JSON.stringify(a),selected_ids:JSON.stringify(a.link_data),search_val:"",mode:"selected"},pagination:!0,pageNumber:1,pageSize:300,pageList:[300,500,1e3,2e3],pagePosition:"bottom",pageLayout:["list","prev","sep","manual","sep","next","refresh"]})},close:function(){$("#"+a.grid_id).datagrid("reload")}})},update_has_many_set:function(){var e=$("#h_relationship_dst").datagrid("options"),t=JSON.parse(e.queryParams.filter_data);Strack.G.horizontalRelationIds.add.length<1&&Strack.G.horizontalRelationIds.delete.length<1?layer.msg(StrackLang.Please_Select_One,{icon:2,time:1200,anim:6}):$.ajax({type:"POST",url:StrackPHP.modifyHasManyRelationData,data:JSON.stringify({param:t,up_data:Strack.G.horizontalRelationIds}),dataType:"json",contentType:"application/json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),Strack.G.horizontalRelationIds={add:[],delete:[]},200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.dialog_cancel()):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},generate_media_list_dom:function(e,t){var a="main_"+Math.floor(1e4*Math.random()+1);$(e).empty().append(Strack.show_note_img_att(a,t)),Strack.init_thumb_media(a)},open_change_item_media:function(r,o){var e=1,t=240,a=11,n=!1;"multiple"===r.mode&&(t=380,a=9,n=!(e=0)),Strack.get_media_server(function(d){Strack.open_dialog("dialog",{title:r.title,width:480,height:t,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mlink_id",type:"hidden",name:"link_id",valid:1,value:r.link_id},{case:101,id:"Mmode",type:"hidden",name:"mode",valid:1,value:r.mode},{case:101,id:"Mmodule_id",type:"hidden",name:"module_id",valid:1,value:r.module_id},{case:101,id:"Mfield_type",type:"hidden",name:"field_type",valid:1,value:r.field_type},{case:101,id:"Mvariable_id",type:"hidden",name:"variable_id",valid:1,value:r.variable_id}],items:[{case:a,id:"Mmedia_queue",type:"text",lang:StrackLang.Media_Attachment,name:"media_queue",valid:0,value:""}],footer:[{obj:"choice_media",type:6,title:""},{obj:"upload_item_thumb",type:5,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){$("#choice_media").uploadifive({auto:!1,formData:{timestamp:Strack.current_time(),belong_system:StrackPHP.Belong_System,token:d.token,size:"250x140"},multi:n,queueSizeLimit:e,queueID:"queue",uploadScript:d.upload_url,onUpload:function(e){0==e?layer.msg(StrackLang.Please_Select_File,{icon:2,time:1200,anim:6}):$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},onUploadComplete:function(e,t){var a=JSON.parse(t);if(200===parseInt(a.status)){var i={};"grid"===r.from&&(i={type:"grid",index:r.index,dom:r.td_dom.attr("id"),editor:"media"}),Strack.save_media_data({link_id:r.link_id,mode:r.mode,field_type:r.field_type,variable_id:r.variable_id,module_id:r.module_id,media_server:d,media_data:a.data,widget_param:i},function(e){n||($.messager.progress("close"),Strack.dialog_cancel(),"grid"!==r.from||Strack.Websocket.List.hasOwnProperty("update")||(e.data.status=200,Strack.update.widget(e.data,i)))}),o&&!n&&o(t)}else layer.msg(a.message,{icon:7,time:1200,anim:6})},onQueueComplete:function(){n&&($.messager.progress("close"),Strack.dialog_cancel())}})}})})},upload_item_thumb:function(){0<$(".uploadifive-queue-item").length?$("#choice_media").uploadifive("upload"):layer.msg(StrackLang.Please_Select_File,{icon:2,time:1200,anim:6})},clear_item_thumb:function(e){var t=$(e).closest(".thumb-menu-bnt"),a=t.attr("data-linkid"),i=t.attr("data-moduleid");Strack.submit_clear_item_thumb({link_id:a,module_id:i,mode:"single"})},submit_clear_item_thumb:function(e,t){$.ajax({type:"POST",url:StrackPHP.clearMediaThumbnail,dataType:"json",data:e,beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),200===parseInt(e.status)?(Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message}),t&&t()):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},grid_change_item_thumb:function(e){var t=$(e).data("grid"),a=$(e).data("moduleid"),i=$("#"+t).datagrid("getSelections");if(0<i.length){var d=[];i.forEach(function(e){d.push(e.id)}),Strack.open_change_item_media({title:StrackLang.Modify_Thumb,link_id:d.join(","),module_id:a,mode:"batch",from:"batch",field_type:"built_in",variable_id:0},function(){$("#"+t).datagrid("reload")})}else layer.msg(StrackLang.Please_Select_Grid_One,{icon:2,time:1200,anim:6})},grid_clear_item_thumb:function(e){var t=$(e).data("grid"),a=$(e).data("moduleid"),i=$("#"+t).datagrid("getSelections");if(0<i.length){var d=[];i.forEach(function(e){d.push(e.id)}),Strack.submit_clear_item_thumb({link_id:d.join(","),module_id:a,mode:"batch"},function(){$("#"+t).datagrid("reload")})}else layer.msg(StrackLang.Please_Select_Grid_One,{icon:2,time:1200,anim:6})},toggle_media_menu:function(e,t){var a=$(".st-menu-left"),i=$(".st-menu-right"),d=$(e).data("page"),r="";if(t)switch(r=t){case"show":a.css({width:"240px"}),i.css({left:"241px"}),a.removeClass("st-m-hide");break;case"hide":a.css({width:"60px"}),i.css({left:"61px"}),a.addClass("st-m-hide")}else a.hasClass("st-m-hide")?(r="show",a.css({width:"240px"}),i.css({left:"241px"}),a.removeClass("st-m-hide")):(r="hide",a.css({width:"60px"}),i.css({left:"61px"}),a.addClass("st-m-hide"));Strack.save_storage(d,r)},toggle_filter:function(e){var t=$(e).attr("data-maindom"),a=$(e).attr("data-bardom");Strack.do_toggle_filter(e,a,t,"")},apply_toggle_filter:function(e,t,a){var i=$("#"+t).find(".search-filter-button");Strack.do_toggle_filter(i[0],e,t,a)},do_toggle_filter:function(e,t,a,i){var d=$("#"+t),r=$("#"+a);0<$(e).find(".icon-uniF141").length&&"show"!==i?($(e).html('<i class="icon-uniF142"></i>'),d.removeClass("filter-full-active").addClass("filter-full-hide").css({width:0}),r.css("width","100%")):($(e).html('<i class="icon-uniF141"></i>'),d.removeClass("filter-full-hide").addClass("filter-full-active"),d.hasClass("filter-min")?(r.css("width","calc(100% - 200px)"),d.css({width:200})):(r.css("width","calc(100% - 380px)"),d.css({width:380})))},toggle_filter_field:function(e){var t=$(e).attr("data-bardom"),a=$(e).offset(),i=0;i=0<$(".globel-top-notice").length?a.top-6:a.top+30,$("#search_list_"+t).css({top:i,left:a.left}).show()},toggle_filter_main:function(e){var t=$(e).closest(".datagrid-filter"),a=t.attr("data-maindom"),i=t.attr("data-bardom"),d=$("#"+i),r=$("#"+a),o=d.find(".filter-label-list");0<$(e).find(".icon-uniE94E").length?($(e).html('<i class="icon-uniE957"></i>'),d.removeClass("filter-min").css({width:380}),o.addClass("filter-lable-hide"),r.css("width","calc(100% - 380px)")):($(e).html('<i class="icon-uniE94E"></i>'),d.addClass("filter-min").css({width:200}),o.removeClass("filter-lable-hide"),r.css("width","calc(100% - 200px)"))},show_filter_filter:function(e){$(e).closest(".grid-filter-right").find(".filter-task-list").toggle()},toggle_filter_item:function(e){var t=$(e),a=t.closest(".grid-filter-right"),i=t.attr("from"),d={field:t.attr("field"),project_id:t.attr("project_id"),module_id:t.attr("module_id"),field_type:t.attr("field_type"),variable_id:t.attr("variable_id"),module:t.attr("module_code"),editor:t.attr("editor"),lang:t.attr("lang"),table:t.attr("table"),belong:t.attr("belong"),value_show:t.attr("value_show"),flg_module:t.attr("flg_module"),data_source:t.attr("data_source"),frozen_module:t.attr("frozen_module")};switch(i){case"bar":if(t.hasClass("item-active")){var r=t.closest(".grid-filter-right");Strack.destroy_filter_item(r,d.field,d.module)}else{t.addClass("item-active").find("i").removeClass("icon-unchecked").addClass("icon-checked"),Strack.filter_item_base(a,d);var o=a.find(".no-filter-task");0<o.length&&o.remove()}break;case"search":var n=t.closest(".filter-task-list"),s=n.attr("data-maindom");if(t.hasClass("item-active")){t.removeClass("item-active").find("i").removeClass("icon-checked").addClass("icon-unchecked");var l=!0;n.find(".field-item").each(function(){$(this).find("i").hasClass("icon-checked")&&(l=!1)}),l&&$("#"+s).find(".search-filter-field").removeClass("search-bar-active")}else t.addClass("item-active").find("i").removeClass("icon-unchecked").addClass("icon-checked"),$("#"+s).find(".search-filter-field").addClass("search-bar-active")}},clear_searchbox:function(e,t){$("#"+e).find("#grid_search").searchbox("clear"),$("#search_list_"+t).find(".field-item").each(function(){$(this).find("i").hasClass("icon-checked")&&Strack.toggle_filter_item(this)})},delete_filter_item:function(e){var t=$(e),a=t.closest(".filter-items").attr("field"),i=t.closest(".filter-items").attr("module"),d=t.closest(".grid-filter-right");Strack.destroy_filter_item(d,a,i)},destroy_filter_item:function(e,t,a){$("#fitem_"+a+"_"+t).remove(),e.find(".filter-task-list .item-active").each(function(){$(this).attr("field")==t&&$(this).attr("module_code")==a&&$(this).removeClass("item-active").find("i").removeClass("icon-checked").addClass("icon-unchecked")}),0==e.find(".filter-items").length&&e.find(".filter-task-panel").html('<div class="no-filter-task">'+StrackLang.No_Filter_Item+"</div>")},filter_item_delete:function(e){var t=$(e).attr("filter_id"),a=$(e).closest(".datagrid-filter"),i=(a.attr("data-bardom"),a.attr("data-maindom"));if(t){var d=$("#"+i).find(".datagrid-table");$.ajax({type:"POST",url:StrackPHP.deleteFilter,dataType:"json",data:{id:t},beforeSend:function(){d.datagrid("loading")},success:function(e){Strack.top_message({bg:"g",msg:e.message}),d.datagrid("loaded").datagrid("reloadFilterTags")}})}},filter_item_stick:function(e){var t=$(e).attr("filter_id"),a="yes"==$(e).attr("stick")?"no":"yes",i=$(e).closest(".datagrid-filter"),d=(i.attr("data-bardom"),i.attr("data-maindom"));if(t){var r=$("#"+d).find(".datagrid-table");$.ajax({type:"POST",url:StrackPHP.stickFilter,dataType:"json",data:{filter_id:t,stick:a},beforeSend:function(){r.datagrid("loading")},success:function(e){Strack.top_message({bg:"g",msg:e.message}),r.datagrid("loaded").datagrid("reloadFilterTags")}})}},save_filter_condition:function(e){var t=$(e).closest(".datagrid-filter").find(".unsaved-filter-item");if(t.is(":hidden"))layer.msg(StrackLang.No_Filter_Need_Save,{icon:2,time:1200,anim:6});else{var a=t.find(".fbar-save-bnt");Strack.save_active_filter(a[0])}},save_active_filter:function(e){var t=$(e).closest(".datagrid-filter"),a=t.attr("data-bardom"),i=t.attr("data-maindom"),d=t.attr("data-page"),r=t.attr("data-projectid"),o=t.attr("data-moduletype"),n=t.attr("data-modulecode"),s=($("#"+a).find(".unsaved-filter-item").attr("data-from"),$("#"+i).find(".datagrid-table")),l=$(s).datagrid("options"),c=JSON.parse(l.queryParams.filter_data);c&&Strack.open_dialog("dialog",{title:StrackLang.Save_Filter,width:480,height:360,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mproject_id",type:"hidden",name:"project_id",valid:1,value:r},{case:101,id:"Mpage",type:"hidden",name:"page",valid:1,value:d},{case:101,id:"Mmodule_type",type:"hidden",name:"module_type",valid:1,value:o},{case:101,id:"Mmodule_code",type:"hidden",name:"module_code",valid:1,value:n},{case:101,id:"Mfilter",type:"hidden",name:"filter",valid:1,value:""},{case:101,id:"Mgrid",type:"hidden",name:"grid",valid:1,value:s.attr("id")}],items:[{case:1,id:"Mfilter_name",type:"text",lang:StrackLang.Name,name:"name",valid:"1,64",value:""},{case:2,id:"Mfilter_color",lang:StrackLang.Color,name:"color",valid:"1",value:""},{case:2,id:"Mfilter_stick",lang:StrackLang.Stick,name:"stick",valid:"1"},{case:2,id:"Mfilter_public",lang:StrackLang.Public,name:"public",valid:"1"}],footer:[{obj:"do_save_active_filter",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){$("#Mfilter").val(JSON.stringify(c)),Strack.combobox_widget("#Mfilter_color",{url:StrackPHP.getFilterColorList,valueField:"id",textField:"name",value:"grey",formatter:function(e){return'<div class="combo-icons-warp" style="overflow: hidden"><div class="ui '+e.id+' label filter-tag-label"></div><div class="combo-name">'+e.name+"</div></div>"}}),Strack.combobox_widget("#Mfilter_stick",{url:StrackPHP.getStickType,valueField:"id",textField:"name",value:"no"}),Strack.combobox_widget("#Mfilter_public",{url:StrackPHP.getPublicType,valueField:"id",textField:"name",value:"yes"})}})},do_save_active_filter:function(){var e=$("#Mgrid").val(),t=$("#"+e);Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",StrackPHP.saveFilter,{back:function(e){Strack.top_message({bg:"g",msg:e.message}),t.datagrid("reloadFilterTags",e.data),t.datagrid("highlightViewSave"),Strack.dialog_cancel()}})},delete_unsave_filter:function(e){if($(e).closest(".filter-tag-item").hasClass("filter-tag-ac"))Strack.reset_filter_default(e);else{var t=$(e).closest(".datagrid-filter").attr("data-bardom");$("#"+t).find(".unsaved-filter-item").hide()}},reset_filter_default:function(e){var t=$(e).closest(".datagrid-filter"),a=t.attr("data-bardom"),i=t.attr("data-maindom");Strack.do_reset_filter(i,a,!0)},do_reset_filter:function(e,t,a){if(a){var i=$("#"+e).find(".datagrid-table"),d=i.datagrid("options");if(d.isKanban){var r=$(".datagrid-view-kanban").boards().data("boards"),o=JSON.parse(d.queryParams.filter_data);o.filter.filter_advance=[],o.filter.filter_input=[],o.filter.filter_panel=[],d.queryParams.filter_data=JSON.stringify(o),r.resetQueryConfig(d.queryParams),r.reload()}else i.datagrid("setFilterParams",{filter_input:[],filter_panel:[],filter_advance:[]}).datagrid("reload");i.datagrid("highlightViewSave")}var n=$("#"+t),s=n.find(".unsaved-filter-item");s.hide(),n.find(".filter-tag-item").removeClass("filter-tag-ac");var l=s.attr("data-from");switch(Strack.clear_filter_cache(t),l){case"filter_input":Strack.clear_searchbox(e,t)}},get_filter_cache:function(e,t){var a=Strack.read_storage("grid_filter_"+e);if(a){var i=JSON.parse(a);return i.from==t?i.data:null}return null},save_filter_cache:function(e,t,a){Strack.save_storage("grid_filter_"+e,JSON.stringify({from:t,data:a}))},clear_filter_cache:function(e){Strack.delete_storage("grid_filter_"+e)},filter_item_base:function(e,t){var a="",i="fitem_"+t.module+"_"+t.field;return a+='<div id="'+i+'" class="filter-items" field="'+t.field+'" field_type="'+t.field_type+'" variable_id="'+t.variable_id+'" editor="'+t.editor+'" module="'+t.module+'" table="'+t.table+'" ><div class="filter-ilabel"><label class="aign-left"><strong>'+t.lang+'</strong><span class="text-faded"> ( '+t.belong+' ) </span></label><a href="javascript:;" class="pfilter-delete aign-right" onclick="Strack.delete_filter_item(this)"><i class="icon-uniE6DB"></i></a></div><div class=\'p-filter-inpt filter-input-wrap\'>'+Strack.filter_item_widget(t.editor,t)+"</div></div>",e.find(".filter-task-panel").append(a),Strack.init_filter_item("#"+i,t.editor,t),Strack.init_filter_event(e),a},init_filter_item:function(e,t,a){switch(t){case"tagbox":case"horizontal_relationship":case"relation":case"combobox":case"checkbox":var i=$(e).find(".in-combobox")[0],d=0<=$.inArray(t,["tagbox","combobox","horizontal_relationship"]);Strack.combobox_widget(i,{url:StrackPHP.getWidgetData,valueField:"id",textField:"name",width:279,height:28,multiple:d,queryParams:{type:t,fields:a.value_show,field_type:a.field_type,variable_id:a.variable_id,project_id:a.project_id,module_id:a.module_id,module:a.module,primary:0,flg_module:a.flg_module,frozen_module:a.frozen_module,data_source:a.data_source},formatter:function(e){switch(a.fields){case"assignee":case"created_by":return Strack.build_comb_avatar(e);default:return e.name}},onLoadSuccess:function(){},onChange:function(e,t){Strack.filter_auto(this)}});break;case"text":case"textarea":var r=$(e).find(".term-list")[0];Strack.combobox_widget(r,{data:Strack.filter_express(["EQ","NEQ","LIKE","NOTLIKE"]),valueField:"id",textField:"name",height:28,onChange:function(e,t){$(this).data("ptype"),$(this).data("filter");Strack.filter_auto(this)}});break;case"datebox":case"datetimebox":var o=$(e).find(".in-date-term"),n=$(e).find(".in-date-range"),s=$(e).find(".data-input-wrap");o.on("click",function(){n.attr("checked",!1),o.is(":checked")?(s.empty().append(Strack.filter_item_widget("date_term",a)),Strack.init_filter_item(s,"date_term",a)):s.empty()}),n.on("click",function(){o.attr("checked",!1),n.is(":checked")?(s.empty().append(Strack.filter_item_widget("date_range",a)),Strack.init_filter_item(s,"date_range",a)):s.empty()});break;case"date_term":var l=e.find(".term-list"),c=e.find(".term-date");Strack.combobox_widget(l[0],{data:Strack.filter_express(["EQ","NEQ","GT","EGT","LT","ELT"]),valueField:"id",textField:"name",height:28,onChange:function(e,t){$(this).data("ptype"),$(this).data("filter");Strack.filter_auto(this)}}),Strack.filter_date_box(c[0],"",28,"",!1,8);break;case"date_range":var _=e.find(".start-date"),m=e.find(".end-date");Strack.filter_date_box(_[0],"",28,"",!1,8),Strack.filter_date_box(m[0],"",28,"",!1,8)}},filter_express:function(e){var t=[];return e.forEach(function(e){t.push(Strack.express_item(e))}),t},express_item:function(e){switch(e){case"EQ":return{id:"EQ",name:StrackLang.Exp_EQ};case"NEQ":return{id:"NEQ",name:StrackLang.Exp_NEQ};case"GT":return{id:"GT",name:StrackLang.Exp_GT};case"EGT":return{id:"EGT",name:StrackLang.Exp_EGT};case"LT":return{id:"LT",name:StrackLang.Exp_LT};case"ELT":return{id:"ELT",name:StrackLang.Exp_ELT};case"LIKE":return{id:"LIKE",name:StrackLang.Exp_LIKE};case"NOTLIKE":return{id:"NOTLIKE",name:StrackLang.Exp_NOTLIKE};case"BETWEEN":return{id:"BETWEEN",name:StrackLang.Exp_BETWEEN};case"NOT BETWEEN":return{id:"NOT BETWEEN",name:StrackLang.Exp_NOT_BETWEEN};case"IN":return{id:"IN",name:StrackLang.Exp_IN};case"NOT IN":return{id:"NOT IN",name:StrackLang.Exp_NOT_IN}}},filter_item_widget:function(e,t){var a="";switch(e){case"combobox":case"tagbox":case"horizontal_relationship":case"relation":case"checkbox":a+='<input class="in-combobox" />';break;case"text":case"textarea":a+='<div  class="pf-widget-term aign-left"><input class="term-list" /></div><div  class="pf-widget-input aign-left"><input class="input-text" type="text" /></div>';break;case"datebox":case"datetimebox":a='<div class=\'pf-widget-date\'><div class="widget-date-item"><div class="aign-left"><input type="checkbox" class="in-date-term"></div><div class="widget-date-name aign-left">'+StrackLang.Date+'</div></div><div class="widget-date-item"><div class="aign-left"><input type="checkbox" class="in-date-range"></div><div class="widget-date-name aign-left">'+StrackLang.Date_Range+'</div></div><div class="p-filter-inpt data-input-wrap"></div></div>';break;case"date_term":a='<div class="pf-widget-term aign-left"><input class="term-list"></div><div class="pf-widget-input aign-left"><input class="term-date"></div>';break;case"date_range":a='<div class="pf-widget-even aign-left interval-right-10"><input class="start-date"></div><div class="pf-widget-even aign-left"><input class="end-date"></div>'}return a},stick_filter_bar:function(e){var t=$(e).closest(".datagrid-filter").attr("data-page"),a=$(e).find("span"),i="";i=$(e).hasClass("stick-on")?(a.html(StrackLang.Keep_Display),$(e).removeClass("stick-on"),"no"):(a.html(StrackLang.Cancel_Keep),$(e).addClass("stick-on"),"yes"),$.ajax({type:"POST",url:StrackPHP.saveUserFilterKeepConfig,data:{stick:i,page:t},dataType:"json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),Strack.top_message({bg:"g",msg:e.message})}})},get_logic_list:function(){return[{id:"and",name:"and"},{id:"or",name:"or"}]},open_advance_filter:function(e){var t=$(e).closest(".datagrid-filter"),a=t.attr("data-moduleid"),i=t.attr("data-maindom"),d=t.attr("data-bardom"),r=t.attr("data-projectid"),o=t.attr("data-page"),n=t.attr("data-schemapage");Strack.dialog_cancel(),Strack.open_dialog("dialog",{title:StrackLang.Advanced_Filter,width:620,height:440,content:Strack.dialog_dom({type:"adv_filter",hidden:[{case:101,id:"Fmodule_id",type:"hidden",name:"module_id",valid:1,value:a},{case:101,id:"Fpage",type:"hidden",name:"page",valid:1,value:o},{case:101,id:"Fschema_page",type:"hidden",name:"page",valid:1,value:n},{case:101,id:"Fmaindom",type:"hidden",name:"maindom",valid:1,value:i},{case:101,id:"Fbardom",type:"hidden",name:"maindom",valid:1,value:d},{case:101,id:"Fproject_id",type:"hidden",name:"project_id",valid:1,value:r}],footer:[{obj:"do_advance_filter",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){Strack.combobox_widget("#logic_comb",{data:Strack.get_logic_list(),valueField:"id",textField:"name",width:70,height:26,value:"and"}),Strack.init_advance_filter(d)}})},init_advance_filter:function(e){var a=Strack.get_filter_cache(e,"filter_advance"),i=["logic","multiple","number"];if(a)if(1<parseInt(a.number)){var d="";Strack.init_advance_group(a.number,"multiple"),$(".dgcb-query-group").each(function(e){for(var t in a[e])$.inArray(t,i)<0&&Strack.init_advance_item(this,a[e][t],"multiple");d=$(this).find(".advh_logic").attr("id"),$("#"+d).combobox("setValue",a[e].logic)}),$("#logic_comb").combobox("setValue",a.logic)}else Strack.init_advance_group(a.number,"single"),$(".dgcb-query-group").each(function(){for(var e in a)$.inArray(e,i)<0&&Strack.init_advance_item(this,a[e],"single")}),$("#logic_comb").combobox("setValue",a.logic)},init_advance_group:function(e){for(var t=0;t<e;t++)Strack.add_filter_group("")},init_advance_item:function(e,t,a){var i="group_"+Math.floor(1e3*Math.random()+1),d=$(e).closest(".dgcb-query-group"),r=$("#Fpage").val(),o=$("#Fschema_page").val(),n=$("#Fproject_id").val(),s=$("#Fmodule_id").val(),l=null;switch(t.editor){case"text":case"textarea":l=["EQ","NEQ","LIKE","NOTLIKE"];break;case"tagbox":case"horizontal_relationship":case"relation":case"combobox":case"checkbox":l=["EQ","IN","NOT IN"];break;case"datebox":case"datetimebox":l=["EQ","NEQ","GT","EGT","LT","ELT","BETWEEN"]}switch(d.find(".dgcb-query-cond").append(Strack.adv_filter_group_dom(i)),$("#condth_"+i).attr("data-field",t.field).attr("data-fieldtype",t.field_type).attr("data-variableid",t.variable_id).attr("data-editor",t.editor).attr("data-module",t.module_code).attr("data-moduletype",t.module_type).attr("data-frozenmodule",t.frozen_module).attr("data-multiple",a).attr("data-table",t.table),Strack.combobox_widget("#Fds_"+i,{url:StrackPHP.getAdvanceFilterFields,valueField:"id",textField:"lang",width:120,height:25,value:t.module_code+"."+t.field,groupField:"belong",queryParams:{module_id:s,page:r,schema_page:o,project_id:n},onSelect:function(e){var t=$(this).closest(".dgcb-cond-item"),a=t.find(".cond_lgoic").attr("id"),i=t.find(".cond-entity-in"),d=t.find(".cond_value").attr("id");t.attr("data-field",e.fields).attr("data-fieldtype",e.field_type).attr("data-variableid",e.variable_id).attr("data-editor",e.editor).attr("data-moduleid",e.module_id).attr("data-modulecode",e.module_code).attr("data-datasource",e.data_source).attr("data-module",e.module).attr("data-moduletype",e.module_type).attr("data-frozenmodule",e.frozen_module).attr("data-valueshow",e.value_show).attr("data-multiple","single").attr("data-table",e.table),Strack.init_adv_filter_cond(a,d,i,e)}}),$("#Fds_"+i).closest(".dgcb-cond-item").attr("data-field",t.fields).attr("data-fieldtype",t.field_type).attr("data-variableid",t.variable_id).attr("data-editor",t.editor).attr("data-moduleid",t.module_id).attr("data-modulecode",t.module_code).attr("data-datasource",t.data_source).attr("data-module",t.module).attr("data-moduletype",t.module_type).attr("data-valueshow",t.value_show).attr("data-frozenmodule",t.frozen_module).attr("data-multiple","single").attr("data-table",t.table),Strack.combobox_widget("#Fls_"+i,{data:Strack.filter_express(l),valueField:"id",textField:"name",width:120,height:25,value:t.condition,onSelect:function(e){var t="date_"+Math.floor(1e3*Math.random()+1),a=$(this).closest(".dgcb-cond-item"),i=a.attr("data-editor"),d=a.find(".cond-entity-in"),r=a.find(".cond_value").attr("id"),o="";switch(e.id){case"IN":case"NOT IN":$("#"+r).combobox("setOptions",{multiple:!0,value:""}).combobox("reload"),a.attr("data-multiple","multiple");break;case"BETWEEN":o='<input id="'+r+'" class="cond_value" style="width: 180px;display: none"><div class="cond-v-start aign-left"><input id="Fdis_'+t+'" class="condv_sdate cond_v_date" style="width: 90px;"></div><div class="cond-v-end aign-left"><input id="Fdie_'+t+'" class="condv_edate cond_v_date" style="width: 90px;"></div>',d.empty().append(o),Strack.filter_date_box("#Fdis_"+t,"",25,"",!1,8),Strack.filter_date_box("#Fdie_"+t,"",25,"",!1,8);break;default:switch(i){case"combobox":case"tagbox":case"checkbox":case"horizontal_relationship":case"relation":$("#"+r).combobox("setOptions",{multiple:!1,value:""}).combobox("reload"),a.attr("data-multiple","single");break;case"datebox":case"datetimebox":d.empty().append('<input id="'+r+'" class="cond_value" style="width: 180px">'),Strack.filter_date_box("#"+r,"",25,"",!1,8)}}}}),t.editor){case"text":case"textarea":$("#Fvs_"+i).val(t.value);break;case"tagbox":case"horizontal_relationship":case"relation":case"combobox":case"checkbox":var c="",_=!1;c="EQ"===t.condition?t.value:(_=!0,t.value.split(",")),Strack.combobox_widget("#Fvs_"+i,{url:StrackPHP.getWidgetData,valueField:"id",textField:"name",height:25,value:c,queryParams:{primary:0,project_id:n,module:t.module,module_type:t.module_type,field_type:t.field_type,variable_id:t.variable_id,fields:t.value_show,module_id:t.module_id,data_source:t.data_source,flg_module:t.flg_module,frozen_module:t.frozen_module},multiple:_});break;case"datebox":case"datetimebox":if("BETWEEN"===t.condition){var m,u="date_"+Math.floor(1e3*Math.random()+1),g=t.value.split(",");m='<input id="Fvs_'+i+'" class="cond_value" style="width: 180px;display: none"><div class="cond-v-start aign-left"><input id="Fdis_'+u+'" class="condv_sdate cond_v_date" style="width: 90px;"></div><div class="cond-v-end aign-left"><input id="Fdie_'+u+'" class="condv_edate cond_v_date" style="width: 90px;"></div>',$("#condth_"+i).find(".cond-entity-in").empty().append(m),Strack.filter_date_box("#Fdis_"+u,"",25,g[0],!1,8),Strack.filter_date_box("#Fdie_"+u,"",25,g[1],!1,8)}else Strack.filter_date_box("#Fvs_"+i,"",25,t.value,!1,8)}},do_advance_filter:function(){var e=$("#Fmaindom").val(),t=$("#Fbardom").val(),a=Strack.scan_advance_filter(),i=$("#"+e).find(".datagrid-table");if(!$.isEmptyObject(a.adv_filter)){var d=$(i).datagrid("options");if(d.isKanban){var r=$(".datagrid-view-kanban").boards().data("boards"),o=JSON.parse(d.queryParams.filter_data);o.filter.filter_advance=a.adv_filter,o.filter.filter_input=[],o.filter.filter_panel=[],d.queryParams.filter_data=JSON.stringify(o),r.resetQueryConfig(d.queryParams),r.reload()}else $(i).datagrid("setFilterParams",{filter_input:[],filter_panel:[],filter_advance:a.adv_filter}).datagrid("reload");Strack.save_filter_cache(t,"filter_advance",a.adv_filter),Strack.show_nosaved_filter(t,"filter_advance",StrackLang.Advanced_Filter),Strack.dialog_cancel()}},show_nosaved_filter:function(e,t,a){var i=$("#"+e),d=i.find(".unsaved-filter-item");i.find(".exist-filter-item .filter-tag-item").removeClass("filter-tag-ac"),d.find(".filter-tag-item").addClass("filter-tag-ac"),d.attr("data-from",t).find(".filter-tag-name").html(a),d.show()},scan_advance_filter:function(e){var t=$("#dg_adv_filter").find(".dgcb-query-group"),a=$(".dgcb-query-group").length,o={},i="",n=0,s=!0;switch(t.length){case 0:20!=e&&layer.msg(StrackLang.Advanced_Filter_Group_Null,{icon:2,time:1200,anim:6});break;case 1:(i=Strack.get_combos_val("#logic_comb","combobox","getValue"))?(t.each(function(){var e=$(this).find(".dgcb-cond-item"),t=null,a=0;e.each(function(){if(!(t=Strack.get_adv_fd_item(this)))return o={},layer.msg(StrackLang.Advanced_Filter_Full_Null,{icon:2,time:1200,anim:6}),s=!1;o[a]=t,a++})}),$.isEmptyObject(o)||(o.logic=i,o.number=a)):(layer.msg(StrackLang.Advanced_Filter_Logic_Null,{icon:2,time:1200,anim:6}),s=!1);break;default:(i=Strack.get_combos_val("#logic_comb","combobox","getValue"))?(t.each(function(){var e=$(this).find(".dgcb-cond-item"),t=null,a={},i=0,d=$(this).find(".advh_logic").attr("id"),r=Strack.get_combos_val("#"+d,"combobox","getValue");if(e.each(function(){if(!(t=Strack.get_adv_fd_item(this)))return!(a={});a[i]=t,i++}),$.isEmptyObject(a))return o={},layer.msg(StrackLang.Advanced_Filter_Full_Null,{icon:2,time:1200,anim:6}),s=!1;a.logic=r,o[n]=a,n++}),$.isEmptyObject(o)||(o.logic=i,o.number=a)):(layer.msg(StrackLang.Advanced_Filter_Logic_Null,{icon:2,time:1200,anim:6}),s=!1)}return{adv_filter:o,go_on:s,item_num:a}},get_adv_fd_item:function(e){var t=$(e).attr("data-editor"),a=$(e).attr("data-field"),i=$(e).attr("data-fieldtype"),d=$(e).attr("data-module"),r=$(e).attr("data-moduleid"),o=$(e).attr("data-modulecode"),n=$(e).attr("data-frozenmodule"),s=$(e).attr("data-moduletype"),l="built_in"==$(e).attr("data-fieldtype")?0:$(e).attr("data-variableid"),c=$(e).attr("data-valueshow"),_=$(e).attr("data-datasource"),m=$(e).attr("data-multiple"),u=$(e).attr("data-table"),g=$(e).find(".cond_field").attr("id"),p=$(e).find(".cond_lgoic").attr("id"),f=$(e).find(".cond_value").attr("id"),h="",v=Strack.get_combos_val("#"+g,"combobox","getValue"),k=Strack.get_combos_val("#"+p,"combobox","getValue");if(t){switch(t){case"tagbox":case"horizontal_relationship":case"relation":case"combobox":case"checkbox":switch(m){case"single":h=Strack.get_combos_val("#"+f,"combobox","getValue");break;case"multiple":h=Strack.get_combos_val("#"+f,"combobox","getValues").join(",")}break;case"text":h=$(e).find(".cond_value").val();break;case"datebox":case"datetimebox":switch(k){case"BETWEEN":var b,S,y=$(e).find(".condv_sdate").attr("id"),w=$(e).find(".condv_edate").attr("id"),x=[];b=$("#"+y).datebox("getValue"),S=$("#"+w).datebox("getValue"),h=b&&S?(x.push(b),x.push(S),x.join(",")):"";break;default:h=$("#"+f).datebox("getValue")}}return v&&k&&h?($(e).find(".cond-entity-en").empty().append(Strack.dialog_error_icon("t")),{field:a,field_type:i,variable_id:l,module:d,module_id:r,module_type:s,module_code:o,value_show:c,table:u,condition:k,data_source:_,frozen_module:n,value:h,editor:t,multiple:m}):($(e).find(".cond-entity-en").empty().append(Strack.dialog_error_icon("e")),!1)}return $(e).find(".cond-entity-en").empty().append(Strack.dialog_error_icon("e")),!1},add_filter_group:function(e){var t="group_"+Math.floor(1e3*Math.random()+1);$("#dg_adv_filter").append(Strack.filter_group_dom(t,"display-hide")),Strack.combobox_widget("#"+t,{data:Strack.get_logic_list(),valueField:"id",textField:"name",width:70,height:26,value:"and"}),Strack.toggle_filter_group()},filter_group_dom:function(e,t){var a="";return a+='<div class="dgcb-query-group"><div class="dgcb-query-hd"><div class="dgcb-item-log aign-left '+t+'"><div class="query-all-name aign-left">'+StrackLang.ConditionalLogic+'</div><div class="query-all-input aign-left"><input id="'+e+'" class="advh_logic" style="width: 53px;"></div></div><div class="dgcb-item-btn aign-left"><a href="javascript:;" onclick="Strack.add_adv_filter_item(this)" class="query-all-btn aign-left"><i class="icon-uniEA33"></i>'+StrackLang.AddFilterItem+'</a></div><div class="dgcb-item-btn aign-right"><a href="javascript:;" onclick="Strack.delete_filter_group(this)" class="query-all-btn aign-left"><i class="icon-uniE6DB"></i></a></div></div><div class="dgcb-query-cond"></div></div>'},adv_filter_group_dom:function(e){var t="";return t+='<div id="condth_'+e+'" class="dgcb-cond-item"><div class="cond-entity-fd aign-left"><input id="Fds_'+e+'" class="cond_field" style="width: 120px;"></div><div class="cond-entity-lg aign-left"><input id="Fls_'+e+'" class="cond_lgoic" style="width: 120px;"></div><div class="cond-entity-in aign-left"><input id="Fvs_'+e+'" class="cond_value" style="width: 180px;" ></div><a href="javascript:;" onclick="Strack.delete_filter_cond(this)" class="cond-entity-de aign-left"><i class="icon-uniEA34"></i></a><div class="cond-entity-en aign-left"></div></div>'},add_adv_filter_item:function(e){var t="group_"+Math.floor(1e3*Math.random()+1),a=$(e).closest(".dgcb-query-group"),i=$("#Fmodule_id").val(),d=($("#Fmodule_code").val(),$("#Fproject_id").val()),r=$("#Fpage").val(),o=$("#Fschema_page").val();a.find(".dgcb-query-cond").append(Strack.adv_filter_group_dom(t)),Strack.combobox_widget("#Fds_"+t,{url:StrackPHP.getAdvanceFilterFields,valueField:"id",textField:"lang",width:120,height:25,groupField:"belong",queryParams:{module_id:i,project_id:d,page:r,schema_page:o},onSelect:function(e){var t=$(this).closest(".dgcb-cond-item"),a=t.find(".cond_lgoic").attr("id"),i=t.find(".cond-entity-in"),d=t.find(".cond_value").attr("id");t.attr("data-field",e.fields).attr("data-fieldtype",e.field_type).attr("data-variableid",e.variable_id).attr("data-editor",e.editor).attr("data-moduleid",e.module_id).attr("data-modulecode",e.module_code).attr("data-datasource",e.data_source).attr("data-module",e.module_alias).attr("data-moduletype",e.module_type).attr("data-frozenmodule",e.frozen_module).attr("data-valueshow",e.value_show).attr("data-multiple","single").attr("data-table",e.table),Strack.init_adv_filter_cond(a,d,i,e)}}),Strack.combobox_widget("#Fls_"+t,{data:Strack.filter_express(["EQ","NEQ","GT","EGT","LT","ELT"]),valueField:"id",textField:"name",width:120,height:25,onSelect:function(e){var t="date_"+Math.floor(1e3*Math.random()+1),a=$(this).closest(".dgcb-cond-item"),i=a.attr("data-editor"),d=a.find(".cond-entity-in"),r=a.find(".cond_value").attr("id"),o="";switch(e.id){case"IN":case"NOT IN":$("#"+r).combobox("setOptions",{multiple:!0,value:""}).combobox("reload"),a.attr("data-multiple","multiple");break;case"BETWEEN":o='<input id="'+r+'" class="cond_value" style="width: 180px;display: none"><div class="cond-v-start aign-left"><input id="Fdis_'+t+'" class="condv_sdate cond_v_date" style="width: 90px;"></div><div class="cond-v-end aign-left"><input id="Fdie_'+t+'" class="condv_edate cond_v_date" style="width: 90px;"></div>',d.empty().append(o),Strack.filter_date_box("#Fdis_"+t,"",25,"",!1,8),Strack.filter_date_box("#Fdie_"+t,"",25,"",!1,8);break;default:switch(i){case"combobox":$("#"+r).combobox("setOptions",{multiple:!1,value:""}).combobox("reload"),a.attr("data-multiple","single");break;case"datebox":case"datetimebox":d.empty().append('<input id="'+r+'" class="cond_value" style="width: 180px">'),Strack.filter_date_box("#"+r,"",25,"",!1,8)}}}})},init_adv_filter_cond:function(e,t,a,i){var d=null,r=$("#Fproject_id").val();switch(a.empty().append('<input id="'+t+'" class="cond_value" style="width: 180px;" >'),i.editor){case"text":case"textarea":d=["EQ","NEQ","LIKE","NOTLIKE"];break;case"tagbox":case"horizontal_relationship":case"relation":case"combobox":case"checkbox":d=["EQ","IN","NOT IN"];var o={url:StrackPHP.getWidgetData,valueField:"id",textField:"name",height:25,queryParams:{primary:0,project_id:r,module_id:i.module_id,module:i.module,module_type:i.module_type,field_type:i.field_type,fields:i.value_show,data_source:i.data_source,variable_id:i.variable_id,flg_module:i.flg_module,frozen_module:i.frozen_module}};Strack.combobox_widget("#"+t,o);break;case"datebox":case"datetimebox":d=["EQ","NEQ","GT","EGT","LT","ELT","BETWEEN"],Strack.filter_date_box("#"+t,"",25,"",!1,8)}$("#"+e).combobox("loadData",Strack.filter_express(d)).combobox("setValue","EQ")},delete_filter_cond:function(e){$(e).closest(".dgcb-cond-item").remove()},delete_filter_group:function(e){$(e).closest(".dgcb-query-group").remove(),Strack.toggle_filter_group()},toggle_filter_group:function(){var e=$("#dg_adv_filter").find(".dgcb-query-group"),t=$(".dgcb-item-log");1<e.length?t.removeClass("display-hide"):t.addClass("display-hide")},toggle_ac_filter:function(e){var t=$(e).attr("filter_type"),a=$(e).attr("filter_id"),i=$(e).closest(".datagrid-filter"),d=i.attr("data-maindom"),r=i.attr("data-bardom"),o=$("#"+d).find(".datagrid-table");if(i.find(".filter-tag-item").removeClass("filter-tag-ac"),$(e).closest(".filter-tag-item").addClass("filter-tag-ac"),"exist"===t)$.ajax({type:"POST",url:StrackPHP.getFilterSingle,data:JSON.stringify({filter_id:a}),dataType:"json",contentType:"application/json",success:function(e){var t=o.datagrid("options"),a=JSON.parse(t.queryParams.filter_data);if(a.filter.filter_advance=e.filter.filter_advance,a.filter.filter_input=e.filter.filter_input,a.filter.filter_panel=e.filter.filter_panel,a.filter.request=e.filter.request,t.queryParams.filter_data=JSON.stringify(a),t.isKanban){var i=$(".datagrid-view-kanban").boards().data("boards");i.resetQueryConfig(t.queryParams),i.reload()}else o.datagrid("setOptions",{queryParams:t.queryParams}).datagrid("reload");o.datagrid("highlightViewSave")}});else{var n=$(e).closest(".unsaved-filter-item").attr("data-from"),s=o.datagrid("options"),l=JSON.parse(s.queryParams.filter_data);l[n]=Strack.get_filter_cache(r,n),s.queryParams.filter_data=JSON.stringify(l),o.datagrid("setOptions",{queryParams:s.queryParams}).datagrid("reload")}},click_view_mode_item:function(e){$(e).attr("from");if("kanban"===$(e).attr("view_mode")){var t=$(e).closest(".entity-datalist").find(".datagrid-table").datagrid("options");if(t.groupParam.grid_data.grid.view_mode="kanban",t.groupParam.group_param.hasOwnProperty("can_use_kanban")&&"no"===t.groupParam.group_param.can_use_kanban)Strack.check_whether_use_kanban_view(t.groupParam.grid_param.module_code,t.groupParam.grid_data).checkData.use_kanban_view||Strack.click_down_item($("#group_status_name")[0]);Strack.save_view(e),window.location.reload()}else Strack.save_view(e),window.location.reload()},toggle_kanban_view:function(e){var t=$(e),a=t.attr("belong"),i=(t.attr("from"),{field:t.attr("field"),field_type:t.attr("field_type"),module:t.attr("module"),module_code:t.attr("module_code"),module_type:t.attr("module_type"),table:t.attr("table"),value_show:t.attr("value_show"),editor:t.attr("editor"),lang:t.attr("lang"),sort:t.attr("field_sort"),edit:t.attr("field_edit"),belong:a,width:t.attr("field_width"),can_use_kanban:t.attr("can_use_kanban")}),d=$(e).closest(".entity-datalist").find(".datagrid-table");d.datagrid("highlightViewSave");var r=d.datagrid("options").columnsFieldConfig,o=Strack.generate_grid_group_data(i,r);d.datagrid("setOptions",{groupActive:!0,groupField:i.value_show,groupFormatter:function(e,t){return'<span class="">'+e+"( "+t.length+" )</span>"}}).datagrid("setFilterParams",{group:o}),Strack.save_view(e),window.location.reload()},calendar_click_filter:function(e,t){e.stopPropagation(),e.preventDefault();var a=$(t).data("type"),i=$(t).data("value");if(Strack.handle_calendar_check_icon(t,i,a),"task_type"===a){var d=$("#fc_filter_wrap_user_receive"),r=$("#fc_filter_wrap_user_sent");switch(i){case"my_receive":d.hide(),r.show(),Strack.handle_calendar_filter(t,"user_receive","",!1);break;case"my_sent":d.show(),r.hide(),Strack.handle_calendar_filter(t,"user_sent","",!1);break;case"my_create":d.show(),r.show();break;default:d.hide(),r.hide(),Strack.handle_calendar_filter(t,"user_receive","",!1),Strack.handle_calendar_filter(t,"user_sent","",!1)}}},handle_calendar_check_icon:function(e,t,a){if("all"===t)0<=$.inArray(a,["task_type","end_time"])?($(e).closest(".menu").find(".item").each(function(){$(this).find("i").removeClass("icon-checked").addClass("icon-unchecked")}),"end_time"===a?($("#fc_endtime_from,#fc_endtime_to").datebox("clear"),Strack.handle_calendar_filter(e,a,{type:"fixed",value:null},!0)):Strack.handle_calendar_filter(e,a,"",!0)):($(e).closest(".menu").find(".scrolling  .item").each(function(){$(this).find("i").removeClass("icon-checked").addClass("icon-unchecked")}),Strack.handle_calendar_filter(e,a,"",!0));else if("date_all"===t)$(e).closest(".menu").find(".item").each(function(){$(this).find("i").removeClass("icon-checked").addClass("icon-unchecked")});else{var i=$(e).find("i");if(0<=$.inArray(a,["task_type","end_time","department_members","view_type"]))$(e).closest(".menu").find(".item i.icon-checked").removeClass("icon-checked").addClass("icon-unchecked"),i.removeClass("icon-unchecked").addClass("icon-checked"),"end_time"===a?($("#fc_endtime_from,#fc_endtime_to").datebox("clear"),Strack.handle_calendar_filter(e,a,{type:"fixed",value:t},!0)):Strack.handle_calendar_filter(e,a,t,!0);else{i.hasClass("icon-unchecked")?i.removeClass("icon-unchecked").addClass("icon-checked"):i.removeClass("icon-checked").addClass("icon-unchecked");var d=[];$(e).closest(".scrolling").find(".item").each(function(){$(this).find("i").hasClass("icon-checked")&&d.push($(this).data("value"))}),Strack.handle_calendar_filter(e,a,d.join(","),!0)}}},handle_calendar_filter:function(e,t,a,i){var d=$(e).closest(".my-scheduler-index").attr("id");Strack.G.calendarEventsFilter[t]=a,i&&Strack.reload_fullCalendar_data(d)},click_down_item:function(e){var t=$(e),a=t.attr("belong"),i=t.attr("from"),d={field:t.attr("field"),field_type:t.attr("field_type"),module:t.attr("module"),module_code:t.attr("module_code"),module_type:t.attr("module_type"),table:t.attr("table"),value_show:t.attr("value_show"),editor:t.attr("editor"),lang:t.attr("lang"),sort:t.attr("field_sort"),edit:t.attr("field_edit"),belong:a,width:t.attr("field_width"),can_use_kanban:t.attr("can_use_kanban")},r=$(e).closest(".entity-datalist").find(".datagrid-table");r.datagrid("highlightViewSave");var o=r.datagrid("options").columnsFieldConfig,n=Strack.toggle_item_icon(e,i);switch(i){case"show":n?r.datagrid("addQueryFields",d).datagrid("reload"):r.datagrid("cutQueryFields",d).datagrid("reload");break;case"group":if(n){var s=Strack.generate_grid_group_data(d,o);r.datagrid("setOptions",{groupActive:!0,groupField:d.value_show,groupFormatter:function(e,t){return'<span class="">'+e+"( "+t.length+" )</span>"}}).datagrid("setFilterParams",{group:s}).datagrid("reload")}else r.datagrid("setOptions",{groupActive:!1}).datagrid("setFilterParams",{group:{}}).datagrid("reload");break;case"sort":var l={};l[d.value_show]={type:"asc",field:d.field,field_type:d.field_type,value_show:d.value_show,module_code:d.module_code},n?Strack.sort_grid_icon(r,l,"single"):Strack.sort_grid_icon(r,{},"single");break;case"view":var c=$(e).closest(".grid-toolbar"),_=$(e).attr("view_id"),m=c.attr("data-page"),u=c.attr("data-projectid");Strack.toggle_view(_,m,u)}},toggle_item_icon:function(e,t){var a=$(e).find("i"),i=!1;if(a.hasClass("icon-unchecked")){switch(t){case"group":$(e).closest(".grid_group").find(".group-field i").removeClass("icon-checked").addClass("icon-unchecked"),a.removeClass("icon-unchecked").addClass("icon-checked");break;case"sort":break;case"view":$(e).closest(".grid-toolbar").find(".view-g-item i").removeClass("icon-checked").addClass("icon-unchecked"),a.removeClass("icon-unchecked").addClass("icon-checked");break;case"view_mode":$(e).closest(".grid-toolbar").find(".view-mode-item i").removeClass("icon-checked").addClass("icon-unchecked"),a.removeClass("icon-unchecked").addClass("icon-checked");break;case"project_status":case"project_time":case"project_belong":var d=$(e).attr("options"),r=$(e).closest("."+t);"all"===d||"project_time"===t?r.find(".view-g-item i").removeClass("icon-checked").addClass("icon-unchecked"):$(r.find(".view-g-item i")[0]).removeClass("icon-checked").addClass("icon-unchecked"),a.removeClass("icon-unchecked").addClass("icon-checked");break;default:a.removeClass("icon-unchecked").addClass("icon-checked")}i=!0}else switch(t){case"view":break;default:a.removeClass("icon-checked").addClass("icon-unchecked")}return i},generate_grid_user:function(e){var t="";return e&&0<e.rows.length&&(t=e.rows[0].name),t},generate_grid_group_data:function(e,t){var a={};return a[e.value_show]={type:"asc",field:e.field,field_type:e.field_type,value_show:e.value_show,module_code:e.module_code,can_use_kanban:e.can_use_kanban},a},get_grid_group_field:function(e,t){t=t||!1;var a={},i={can_use_kanban:"no"};for(var d in e)if(a.field=d,a.order=e[d].type,t)for(var r in e[d])"can_use_kanban"===r&&(i.can_use_kanban=e[d][r]),i[r]=e[d][r];return t?i:a},check_whether_use_kanban_view:function(e,t){var a=Strack.get_grid_group_field(t.grid.group_name,!0),i={use_kanban_view:!1,use_pagination:!0,show_header:!0};return"kanban"===t.grid.view_mode&&!$.isEmptyObject(a)&&"status"===a.module_code||"kanban"===t.grid.view_mode&&"yes"===a.can_use_kanban?(i.use_kanban_view=!0,i.use_view=kanbanview,i.use_pagination=!1,i.show_header=!1):i.use_view=scrollview,{groupParam:a,checkData:i}},delete_group:function(e){$(e).attr("data-panel");$(e).closest(".grid_group").find(".group-field i").removeClass("icon-checked").addClass("icon-unchecked");var t=$(e).closest(".entity-datalist").find(".datagrid-table");t.datagrid("setOptions",{groupActive:!1}).datagrid("setFilterParams",{group:[]}).datagrid("reload"),t.datagrid("highlightViewSave")},sort_grid_item:function(e){var t,a=$(e).data("grid"),i=$(e).data("field"),d=$(e).attr("data-sort"),r=$("#"+a),o={};switch(d){case"asc":t="desc";break;case"desc":t="empty";break;default:t="asc"}if("empty"!==t){var n=r.datagrid("options").columnsFieldConfig;o[n[i].field_map]={type:t,field:n[i].fields,field_type:n[i].field_type,value_show:n[i].field_map,module_code:n[i].module_code}}r.datagrid("highlightViewSave"),Strack.sort_grid_icon(r,o,"single")},sort_grid_icon:function(e,t,a){Strack.init_sort_grid_icon(e,t,a);var i=e.closest(".entity-datalist").find(".grid_sort");Strack.init_sort_icon(i,t,a),e.datagrid("setOptions",{sortConfig:t}),e.datagrid("setFilterParams",{sort:t}).datagrid("reload"),"advance"===a&&Strack.dialog_cancel()},init_sort_grid_icon:function(e,t,a){var i;e.closest(".datagrid-view").find(".datagrid-sort").each(function(){i=$(this).closest("td").attr("field"),$(this).removeClass("datagrid-sort-desc datagrid-sort-asc").children("a").attr("data-sort",""),t.hasOwnProperty(i)&&("empty"!==t[i].type&&$(this).addClass("datagrid-sort-"+t[i].type).children("a").attr("data-sort",t[i].type),$(this).find("a").attr("data-sort",t[i].type))})},init_sort_icon:function(e,t,a){var i;Strack.show_sort_down_icon(e,t,a),e.find(".sort-field").each(function(){i=$(this).attr("value_show"),t.hasOwnProperty(i)&&"empty"!==t[i]?$(this).find("i").removeClass("icon-unchecked").addClass("icon-checked"):$(this).find("i").removeClass("icon-checked").addClass("icon-unchecked")})},init_show_sort_down_icon:function(e,t,a){var i=[];for(var d in t)i.push(d);i.length&&Strack.show_sort_down_icon(e,i,t,a)},show_sort_down_icon:function(e,t,a){var i,d="";for(var r in t){d=t[r].type;break}e.find(".sort-bnt").each(function(){switch(i=$(this).attr("data-sort")){case"asc":case"desc":i===d&&"single"===a?$(this).removeClass("field-disable"):$(this).addClass("field-disable");break;case"advance":"advance"===a?$(this).removeClass("field-disable"):$(this).addClass("field-disable")}})},dropdown_sort:function(e){var t=$(e).attr("data-sort"),a=$(e).closest(".grid_sort"),i="",d="",r="",o="",n={};a.find(".sort-field").each(function(){$(this).attr("module"),$(this).find("i").hasClass("icon-checked")&&(d=$(this).attr("field"),i=$(this).attr("value_show"),r=$(this).attr("field_type"),o=$(this).attr("module_code"))});var s=$(e).closest(".entity-datalist").find(".datagrid-table");0<i.length&&(n[i]={type:t,field:d,field_type:r,value_show:i,module_code:o},Strack.sort_grid_icon(s,n,"single"))},sort_cancel:function(e){var t=$(e).closest(".entity-datalist").find(".datagrid-table");t.datagrid("setOptions",{sortConfig:{}}),Strack.sort_grid_icon(t,{},"single"),t.datagrid("highlightViewSave")},advance_sort:function(e){var t=$(e).closest(".grid-toolbar"),a=t.attr("data-projectid"),i=t.attr("id"),d=t.attr("data-grid"),r=t.attr("data-page"),o=t.attr("data-schemapage"),n=t.attr("data-moduleid");Strack.open_dialog("dialog",{title:StrackLang.Sort_Adv,width:420,height:320,content:Strack.dialog_dom({type:"adv_sort",hidden:[{case:101,id:"Mpanel_id",type:"hidden",name:"panel_id",valid:1,value:i},{case:101,id:"Mgrid",type:"hidden",name:"grid",valid:1,value:d}],footer:[{obj:"do_advance_sort",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){Strack.combobox_widget("#sort_first,#sort_second,#sort_third",{url:StrackPHP.getSortFields,valueField:"id",textField:"lang",width:160,height:25,groupField:"belong",queryParams:{project_id:a,page:r,schema_page:o,module_id:n,field_list_type:["sort"]},onSelect:function(e){}}),Strack.combobox_widget("#sort_first_func,#sort_second_func,#sort_third_func",{url:StrackPHP.getSortList,valueField:"id",textField:"name",width:110,height:25})}})},do_advance_sort:function(){var e=$("#Mgrid").val(),t=($("#Mpanel_id").val(),$("#"+e)),a=Strack.get_combos_val("#sort_first","combobox","getValue"),i=Strack.get_combos_val("#sort_second","combobox","getValue"),d=Strack.get_combos_val("#sort_third","combobox","getValue"),r=Strack.get_combos_val("#sort_first_func","combobox","getValue"),o=Strack.get_combos_val("#sort_second_func","combobox","getValue"),n=Strack.get_combos_val("#sort_third_func","combobox","getValue"),s=$("#sort_first").combobox("getRowValue","id"),l=$("#sort_second").combobox("getRowValue","id"),c=$("#sort_third").combobox("getRowValue","id"),_=t.datagrid("options").columnsFieldConfig;$("#shang_first,#shang_second,#shang_third").find("i").remove();var m={};a&&r?($("#shang_first").append(Strack.dialog_error_icon("t")),m[_[s.value_show].field_map]={type:r,field:_[s.value_show].fields,field_type:_[s.value_show].field_type,value_show:_[s.value_show].field_map,module_code:_[s.value_show].module_code},i&&o&&($("#shang_second").append(Strack.dialog_error_icon("t")),m[_[l.value_show].field_map]={type:o,field:_[l.value_show].fields,field_type:_[l.value_show].field_type,value_show:_[l.value_show].field_map,module_code:_[l.value_show].module_code}),d&&n&&($("#shang_third").append(Strack.dialog_error_icon("t")),m[_[c.value_show].field_map]={type:n,field:_[c.value_show].fields,field_type:_[c.value_show].field_type,value_show:_[c.value_show].field_map,module_code:_[c.value_show].module_code}),Strack.sort_grid_icon(t,m,"advance")):(layer.msg(StrackLang.AdvSort_Null,{icon:2,time:1200,anim:6}),$("#shang_first").append(Strack.dialog_error_icon("e")))},save_view:function(e){var t=Strack.select_view_param(e);if("allow"===t.allow_edit){var a,i=$(e).attr("data-panel"),d="grid";switch(i){case"grid":a=$(e).closest(".grid-toolbar"),$(e).closest(".entity-datalist").find(".datagrid-table").datagrid("delHighlightViewSave"),d=$(e).attr("view_mode");break;case"list":a=$(e).closest(".list-toolbar"),Strack.del_highlight_view_save(e)}var r={view_type:0<t.view_id?"custom":"default",panel:i,type:d,page:a.attr("data-page"),project_id:a.attr("data-projectid"),maindom:a.attr("data-maindom"),bardom:a.attr("data-bardom")},o=Strack.get_view_data(r);Strack.submit_save_view(t.view_id,o,r)}else Strack.save_as_view(e)},submit_save_view:function(e,t,a){var i="default"===a.view_type?StrackPHP.saveDefaultView:StrackPHP.saveView,d=$(".exist-filter-item .filter-tag-ac").attr("filter_id");t.filter_bar_id=d||0,$.ajax({type:"POST",url:i,dataType:"json",data:{id:e,page:a.page,type:a.type,project_id:a.project_id,view_data:JSON.stringify(t)},beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message})}})},select_view_param:function(e){var t;switch($(e).attr("data-panel")){case"grid":t=$(e).closest(".grid-toolbar");break;case"list":t=$(e).closest(".list-toolbar")}var a=t.find(".view-g-item"),i={};return i.project_id=t.attr("data-projectid"),a.each(function(){$(this).find("i").hasClass("icon-checked")&&(i.view_id=parseInt($(this).attr("view_id")),i.allow_edit=$(this).attr("allow_edit"))}),i},save_as_view:function(e){var t,a=$(e).attr("data-panel"),i="grid";switch(a){case"grid":t=$(e).closest(".grid-toolbar"),i="grid"===$(".grid_view_mode").attr("view_mode")?"kanban":"grid";break;case"list":t=$(e).closest(".list-toolbar")}Strack.open_dialog("dialog",{title:StrackLang.Save_View,width:480,height:240,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mpanel",type:"hidden",name:"panel",valid:1,value:a},{case:101,id:"Mpage",type:"hidden",name:"page",valid:1,value:t.attr("data-page")},{case:101,id:"Mproject_id",type:"hidden",name:"project_id",valid:1,value:t.attr("data-projectid")},{case:101,id:"Mmaindom",type:"hidden",name:"maindom",valid:1,value:t.attr("data-maindom")},{case:101,id:"Mbardom",type:"hidden",name:"bardom",valid:1,value:t.attr("data-bardom")},{case:101,id:"MviewMode",type:"hidden",name:"type",valid:1,value:i}],items:[{case:1,id:"Mview_name",type:"text",lang:StrackLang.Name,name:"name",valid:"1,128",value:""},{case:2,id:"Mview_public",lang:StrackLang.Public,name:"public",valid:"1",value:""}],footer:[{obj:"submit_save_as_view",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){Strack.combobox_widget("#Mview_public",{url:StrackPHP.getPublicType,valueField:"id",textField:"name",value:"yes"})}})},submit_save_as_view:function(){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",StrackPHP.saveAsView,{back:function(e){Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message}),location.reload()}},{extra:function(e){return e.view_data=JSON.stringify(Strack.get_view_data({panel:e.panel,page:e.page,type:e.type,project_id:e.project_id,maindom:e.maindom,bardom:e.bardom})),e}})},modify_view:function(e){var t;switch($(e).attr("data-panel")){case"grid":t=$(e).closest(".grid-toolbar");break;case"list":t=$(e).closest(".list-toolbar")}var a=t.find(".view-g-active"),i={view_id:a.attr("view_id"),view_name:a.attr("view_name"),view_public:a.attr("view_public"),allow_edit:a.attr("allow_edit")};0<parseInt(i.view_id)&&"allow"==i.allow_edit?Strack.open_dialog("dialog",{title:StrackLang.Modify_View_Title,width:480,height:240,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mview_id",type:"hidden",name:"view_id",valid:1,value:i.view_id}],items:[{case:1,id:"Mview_name",type:"text",lang:StrackLang.Name,name:"name",valid:"1,128",value:i.view_name},{case:2,id:"Mview_public",lang:StrackLang.Public,name:"public",valid:"1",value:""}],footer:[{obj:"submit_modify_view",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){Strack.combobox_widget("#Mview_public",{url:StrackPHP.getPublicType,valueField:"id",textField:"name",value:i.view_public})}}):layer.msg(StrackLang.View_Deny_Modify,{icon:2,time:1200,anim:6})},submit_modify_view:function(){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",StrackPHP.modifyView,{back:function(e){Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message}),window.location.reload()}})},get_view_data:function(e){var t={};switch(e.panel){case"grid":var a=$("#"+e.maindom).find(".datagrid-table").datagrid("options"),i=JSON.parse(a.queryParams.filter_data),d=a.sortData;t.sort={sort_query:i.filter.sort,sort_data:d},t.group=i.filter.group;var r=[];if(1<a.frozenColumns.length){var o=[];a.frozenColumns[0].forEach(function(e){o.push({colspan:e.colspan,frozen_status:!0})}),a.columns[0].forEach(function(e){e.frozen_status=!1,"yes"===e.step&&(0<$("#stid_"+e.fname).find("i.icon-uniEA39").length?e.hidden_status="no":e.hidden_status="yes"),o.push(e)});var n=[];a.frozenColumns[1].forEach(function(e){e&&"id"!==e.field&&n.push({field:e.field,width:parseInt(e.width),frozen_status:!0})}),a.columns[1].forEach(function(e){if(e&&"id"!==e.field)if(e.step){var t={field:e.field,title:e.title,align:"center",width:parseInt(e.width),findex:e.findex,hidden:e.hidden,drag:e.drag,step:!0,step_index:e.step_index,belong:e.belong,frozen_status:!1};0<=$.inArray(e.step_index,["first","last"])&&(t.bdc=e.bdc,t.cbd=e.cbd,t.cellClass=e.cellClass,t.deltaWidth=e.deltaWidth),n.push(t)}else n.push({field:e.field,width:parseInt(e.width),frozen_status:!1})}),r.push(o,n)}else a.frozenColumns[0].forEach(function(e){e&&"id"!==e.field&&r.push({field:e.field,width:parseInt(e.width),frozen_status:!0})}),a.columns[0].forEach(function(e){e&&"id"!==e.field&&r.push({field:e.field,width:parseInt(e.width),frozen_status:!1})});t.fields=r;var s=$("#"+a.filterConfig.id).find(".exist-filter-item .filter-tag-ac").attr("filter_id");t.filter=0<s?{filter_id:s,sort:{sort_data:d,sort_query:i.filter.sort},group:i.filter.group,request:i.filter.request,filter_input:i.filter.filter_input,filter_panel:i.filter.filter_panel,filter_advance:i.filter.filter_advance}:{filter_id:0,sort:{sort_data:{},sort_query:{}},group:{},request:{},filter_input:{},filter_panel:{},filter_advance:{}}}return t},toggle_view:function(e,t,a){$.ajax({type:"POST",url:StrackPHP.toggleView,dataType:"json",data:{view_id:e,project_id:a,page:t},beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),window.location.reload()}})},delete_view:function(e){var t,a=Strack.select_view_param(e);switch($(e).attr("data-panel")){case"grid":t=$(e).closest(".grid-toolbar");break;case"list":t=$(e).closest(".list-toolbar")}var i=t.attr("data-page");"allow"===a.allow_edit?$.ajax({type:"POST",url:StrackPHP.deleteView,dataType:"json",data:{id:a.view_id,project_id:a.project_id,page:i},beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),window.location.reload()}}):layer.msg(StrackLang.View_Deny_Remove,{icon:2,time:1200,anim:6})},highlight_view_save:function(e){$(e).closest(".list-toolbar").find(".grid-view-bnt").addClass("dg-bnt-active")},del_highlight_view_save:function(e){$(e).closest(".list-toolbar").find(".grid-view-bnt").removeClass("dg-bnt-active")},dialog_error_icon:function(e){var t="";switch(e){case"e":t+='<i class="dialog-form-error form-tip icon-uniF00D"></i>';break;case"t":t+='<i class="dialog-form-ok form-tip icon-uniF00C"></i>'}return t},dropdown_reset:function(){var e,t,a,i,d;$(".stdown-filter").each(function(){e=$(this).data("dtype"),i=$(this).data("height"),0<$("#filter_proj_"+e).length&&(t=$(this).offset().top,a=$(this).offset().left,100<e&&$(window).height()<t+i+71?(d=t-i-41,$("#filter_proj_"+e).css({top:35+d,left:a-160})):$("#filter_proj_"+e).css({top:t+30,left:a-160}))})},loading_dom:function(e,t,a){var i="",d=t;switch(d=d||"",a=a?"_"+a:"",e){case"black":i='<div id="st-load'+a+'" class="ui active dimmer st-load"><div class="ui text loader">'+d+"</div></div>";break;case"white":i='<div id="st-load'+a+'" class="ui active inverted dimmer st-load"><div class="ui text loader">'+d+"</div></div>";break;case"null":i='<div id="st-load'+a+'" class="ui active inverted stnull dimmer st-load"><div class="ui text loader">'+d+"</div></div>"}return i},upper_first_str:function(e){return""==e||null==e||"string"!=typeof e?"":e.charAt(0).toUpperCase()},build_avatar:function(e,t,a){var i="thumb-34-"+e;return t?'<img class="'+i+'" src="'+t+'" thumb-type="avatar" />':'<span class="'+i+'" thumb-type="avatar">'+a+"</span>"},ajax_grid_delete:function(e,t,a,i,d,r){var o=d||"",n=$("#"+e).datagrid("getSelections"),s=[];n.forEach(function(e){s.push(e[t])}),n.length<1?layer.msg(StrackLang.Please_Select_One,{icon:2,time:1200,anim:6}):Strack.do_ajax_grid_delete(e,a,i,r,s,o)},ajax_treegrid_delete:function(e,t,a,i,d,r){var o=d||"",n=$("#"+e).treegrid("getSelections"),s=[];n.forEach(function(e){s.push(e[t])}),n.length<1?layer.msg(StrackLang.Please_Select_One,{icon:2,time:1200,anim:6}):Strack.do_ajax_grid_delete(e,a,i,r,s,o,"treegrid")},do_ajax_grid_delete:function(t,e,a,i,d,r,o){$.messager.confirm(StrackLang.Confirmation_Box,e,function(e){e&&$.ajax({type:"POST",url:a,data:JSON.stringify({primary_ids:d.join(","),param:r}),dataType:"json",contentType:"application/json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){if($.messager.progress("close"),200===parseInt(e.status))switch(i||Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message}),o){case"treegrid":$("#"+t).treegrid("reload");default:$("#"+t).datagrid("reload")}else layer.msg(e.message,{icon:7,time:1200,anim:6})}})})},ajax_base_delete:function(t,e,a,i){$.messager.confirm(StrackLang.Confirmation_Box,e,function(e){e&&$.ajax({type:"POST",url:a,data:{primary_ids:t},dataType:"json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),200===parseInt(e.status)?(Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message}),i(e)):layer.msg(e.message,{icon:7,time:1200,anim:6})}})})},ajax_dialog_form:function(e,t,a,i,d){var r=Strack.submit_dialog_form(e),o="";if(r.error_num<0)if(0<t.length)switch(r.error_num){case-1:case-2:o=r.error_name+""+r.error_num,layer.msg(t[o],{icon:2,time:1200,anim:6});break;default:o="illegal",layer.msg(StrackLang.Illegal_Operation,{icon:2,time:1200,anim:6})}else layer.msg(r.error_message,{icon:2,time:1200,anim:6});else{var n;if(n=d?d.extra(r):r,!a)return n;$.ajax({type:"POST",url:a,data:JSON.stringify(n),dataType:"json",contentType:"application/json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),i&&i.back(e)}})}},submit_dialog_form:function(e){$(".form-tip").remove();var _={},m="",u=["input","widget","json","textarea","tags","datalist"];return $(e).each(function(){if(m=$(this).attr("data-widget"),0<=$.inArray(m,u)){var e,t=$(this).attr("id"),a=$(this).data("valid"),i=$(this).data("name"),d=this.className,r=$(this).attr("type"),o=null;switch(m){case"input":case"text":case"textarea":o=$(this).val();break;case"json":o=Strack.get_json_editor_val(t);break;case"widget":var n=d.split(" ");switch(String(n[1])){case"combobox-f":o=0<(e=Strack.get_combos_val("#"+this.id,"combobox","getValues")).length?e.join(","):"";break;case"combotree-f":o=0<(e=Strack.get_combos_val("#"+this.id,"combotree","getValues")).length?e.join(","):"";break;case"datebox-f":o=(o=$("#"+this.id).datebox("getValue"))||"";break;case"switchbutton-f":o=Strack.get_switch_val("#"+this.id);break;default:o=$(this).val()}break;case"tags":var s=[];$("#st_dialog_form").find(".tag-items").each(function(){s.push($(this).data("id"))}),o=s.join(",")}if(a){var l=$(this).closest(".st-dialog-input").prev().html(),c=Strack.valid_form(a,o,l);if(!c.status)return Strack.get_valid_icon(this.id,-1,r),_.error_message=c.message,_.error_num=parseInt(c.error_num),_.error_name=i,!1;Strack.get_valid_icon(this.id,1,r),_[i]=o}else _[i]=o}}),_},get_valid_icon:function(e,t,a){if("hidden"!==a){var i=$("#"+e);switch(t){case 1:i.parent().append(Strack.dialog_error_icon("t"));break;case-1:i.parent().append(Strack.dialog_error_icon("e"));break;default:i.parent().append(Strack.dialog_error_icon("t"))}}},rule_grid_header_checkbox:function(e){var t,a,i=$(e).data("pos"),d=$(e).data("field"),r=$(e).find(".tree-checkbox"),o=$(".datagrid-row td[field = "+d+"]"),n=$("#rule_header_checkbox_"+d),s=0,l=0,c=0,_=0,m={};switch(i){case"header":r.hasClass("tree-checkbox1")||r.hasClass("tree-checkbox2")?(r.removeClass("tree-checkbox1").removeClass("tree-checkbox2").addClass("tree-checkbox0"),o.each(function(){$(this).find(".tree-checkbox").removeClass("tree-checkbox1").removeClass("tree-checkbox2").addClass("tree-checkbox0")})):(r.removeClass("tree-checkbox0").removeClass("tree-checkbox2").addClass("tree-checkbox1"),o.each(function(){$(this).find(".tree-checkbox").removeClass("tree-checkbox0").removeClass("tree-checkbox2").addClass("tree-checkbox1")}));break;case"parent":var u=$(e).data("code");r.hasClass("tree-checkbox1")||r.hasClass("tree-checkbox2")?(r.removeClass("tree-checkbox1").removeClass("tree-checkbox2").addClass("tree-checkbox0"),o.each(function(){a=$(this).find(".dg-rule-checkbox"),(p=a.data("parent"))===u?($(this).find(".tree-checkbox").removeClass("tree-checkbox1").removeClass("tree-checkbox2").addClass("tree-checkbox0"),c++,s++,0<$(this).find(".tree-checkbox1").length&&(_++,l++)):p&&(s++,0<$(this).find(".tree-checkbox1").length&&l++),a.data("code")===u&&(t=a)})):(r.removeClass("tree-checkbox0").removeClass("tree-checkbox2").addClass("tree-checkbox1"),o.each(function(){a=$(this).find(".dg-rule-checkbox"),(p=a.data("parent"))===u?($(this).find(".tree-checkbox").removeClass("tree-checkbox0").removeClass("tree-checkbox2").addClass("tree-checkbox1"),c++,s++,0<$(this).find(".tree-checkbox1").length&&(_++,l++)):p&&(s++,0<$(this).find(".tree-checkbox1").length&&l++),a.data("code")===u&&(t=a)})),(m={top_item_number:s,top_checked_number:l,top_checkbox:n,parent_items:[]}).parent_items[d]={parent_item_number:c,parent_checked_number:_,parent_checkbox:t},Strack.reset_rule_grid_data(m);break;case"single":var g,p=$(e).data("parent");r.hasClass("tree-checkbox1")||r.hasClass("tree-checkbox2")?r.removeClass("tree-checkbox1").removeClass("tree-checkbox2").addClass("tree-checkbox0"):r.removeClass("tree-checkbox0").removeClass("tree-checkbox2").addClass("tree-checkbox1"),o.each(function(){(a=$(this).find(".dg-rule-checkbox")).data("code")===p&&(t=a),(g=a.data("parent"))===p?(c++,s++,0<$(this).find(".tree-checkbox1").length&&(_++,l++)):g&&(s++,0<$(this).find(".tree-checkbox1").length&&l++)}),(m={top_item_number:s,top_checked_number:l,top_checkbox:n,parent_items:[]}).parent_items[d]={parent_item_number:c,parent_checked_number:_,parent_checkbox:t},Strack.reset_rule_grid_data(m)}},init_rule_grid_data:function(e){var t,a,i,d,r={view:{top_item_number:0,top_checked_number:0,top_checkbox:null,parent_items:{}},create:{top_item_number:0,top_checked_number:0,top_checkbox:null,parent_items:{}},clear:{top_item_number:0,top_checked_number:0,top_checkbox:null,parent_items:{}},modify:{top_item_number:0,top_checked_number:0,top_checkbox:null,parent_items:{}},delete:{top_item_number:0,top_checked_number:0,top_checkbox:null,parent_items:{}}};for(var o in $("#rule_tab_field_function").find(".dg-rule-checkbox").each(function(){switch(t=$(this).attr("data-pos"),a=$(this).attr("data-field"),t){case"header":r[a].top_checkbox=$(this);break;case"parent":i=$(this).attr("data-code"),r[a].parent_items[i]={parent_item_number:0,parent_checked_number:0,parent_checkbox:$(this)};break;case"single":d=$(this).attr("data-parent"),i=$(this).attr("data-code"),r[a].top_item_number++,r[a].parent_items[d].parent_item_number++,$(this).find(".tree-checkbox").hasClass("tree-checkbox1")&&(r[a].top_checked_number++,r[a].parent_items[d].parent_checked_number++)}}),r)Strack.reset_rule_grid_data(r[o])},reset_rule_grid_data:function(e){var t,a=e.top_checkbox.find(".tree-checkbox");for(var i in 0<e.top_checked_number?e.top_checked_number===e.top_item_number?a.removeClass("tree-checkbox0").removeClass("tree-checkbox2").addClass("tree-checkbox1"):a.removeClass("tree-checkbox0").removeClass("tree-checkbox1").addClass("tree-checkbox2"):a.removeClass("tree-checkbox1").removeClass("tree-checkbox2").addClass("tree-checkbox0"),e.parent_items){var d=(t=e.parent_items[i]).parent_checkbox.find(".tree-checkbox");0<t.parent_checked_number?t.parent_checked_number===t.parent_item_number?d.removeClass("tree-checkbox0").removeClass("tree-checkbox2").addClass("tree-checkbox1"):d.removeClass("tree-checkbox0").removeClass("tree-checkbox1").addClass("tree-checkbox2"):d.removeClass("tree-checkbox1").removeClass("tree-checkbox2").addClass("tree-checkbox0")}},color_pick_widget:function(e,t,a,i,d){$(e).addClass("color-pick"),$(e).val(i),d&&$(e).attr("style","width:"+d+"px;border-color:#"+i),$(e).colpick({layout:t,submit:0,color:i,colorScheme:a,onChange:function(e,t,a,i,d){$(i).css("border-color","#"+t),d||$(i).val(t)}}).keyup(function(){$(this).colpickSetColor(this.value)})},build_dialog:function(e){$("body").append('<div id="'+e+'"></div>')},open_dialog:function(e,t){Strack.build_dialog(e),$("#"+e).dialog({title:t.title,width:t.width,height:t.height,top:t.top,closed:!1,cache:!1,modal:!0,content:t.content,onMove:function(e,t){Strack.dropdown_reset()},onOpen:function(){t.inits&&t.inits.call(this)},onClose:function(){$(this).dialog("destroy"),t.close&&t.close.call(this)}})},init_json_editor:function(e,t,a){var i=t||{},d=document.getElementById(e);Strack.G.jsonEditor[e]=new JSONEditor(d,i),a&&Strack.G.jsonEditor[e].set(a)},destroy_json_editor:function(e){Strack.G.jsonEditor[e]&&(Strack.G.jsonEditor[e].destroy(),delete Strack.G.jsonEditor[e])},get_json_editor_val:function(e){return Strack.G.jsonEditor[e]?Strack.G.jsonEditor[e].get():{}},get_combos_val:function(e,t,a){var i,d="";return t?(i=$(e)[t]("panel"),d=$(e)[t](a),i.children("div").hasClass("combobox-item-selected")||"combotree"===t?d||"":d=""):d},combobox_widget:function(e,t){var a=t||{};$(e).combobox(a)},combotree_widget:function(e,t){var a=t||{};$(e).combotree(a)},set_switch_val:function(e){return 1===parseInt(e)},init_open_switch:function(a,i){var e=a.height?a.height:26,t={checked:Strack.set_switch_val(a.value),width:a.width,height:e,onText:a.onText,offText:a.offText,onChange:function(e){var t;t=e?1:0,$(a.dom).next().children("input").val(t),i&&i(t)}};a.disabled&&(t.disabled=a.disabled),$(a.dom).switchbutton(t),$(a.dom).next().prepend('<input type="hidden" name="switchbutton" value="'+a.value+'" >')},open_date_box:function(e,t,a,i){$(e).datebox({width:t,height:a,value:i,editable:!1})},open_datetime_box:function(e,t,a,i){$(e).datetimebox({width:t,height:a,value:i,editable:!1})},filter_date_box:function(e,t,a,i,d){$(e).datebox({width:t,height:a,value:i,editable:!1,onSelect:function(e){$(this).data("ptype"),$(this).data("filter");Strack.filter_auto(this)}})},get_switch_val:function(e){var t;return"undefined"!==(t=e?$(e).next().children("input").val():$(".switchbutton input[name=switchbutton]").val())?parseInt(t):0},panel_height:function(e,t){return $(e).height()-t},auto_resize_datagrid:function(e,t,a,i,d){d?$(t).on("mresize",function(){Strack.do_resize_datagrid(e,t,a,i)}):$(window).resize(function(){Strack.do_resize_datagrid(e,t,a,i)})},do_resize_datagrid:function(e,t,a,i){var d;$(t).is(":hidden")?(d=$(t).show().offset(),Strack.resize_datagrid_active(e,d,a,i),$(t).removeAttr("style")):(d=$(t).offset(),Strack.resize_datagrid_active(e,d,a,i),Strack.dropdown_reset())},resize_datagrid_active:function(e,t,a,i){var d=$(e).closest(".entity-datalist").next(".datagrid-filter").width();d=0<d?d:0;var r=$(".grid-right-wrap"),o=0;r.is(":hidden")||(o=0<(o=r.width())?o+1:0);var n=$.data(e,"datagrid"),s=n.options,l=n.dc,c=n.panel,_=window.innerWidth-t.left-2-d-o,m=window.innerHeight-t.top-2-i,u=l.view,g=l.view1,p=l.view2,f=g.children("div.datagrid-header"),h=p.children("div.datagrid-header"),v=f.find("table"),k=h.find("table");c.css({width:_,height:m}),u.width(_);var b=f.children("div.datagrid-header-inner").show();g.width(b.find("table").width()),s.showHeader||b.hide(),p.width(_-g._outerWidth()),g.children()._outerWidth(g.width()),p.children()._outerWidth(p.width());var S=f.add(h).add(v).add(k);S.css("height","");var y=0;y=s.HeaderHeight?s.HeaderHeight:Math.max(v.height(),k.height()),S._outerHeight(y);var w=l.body2.children("table.datagrid-btable-frozen")._outerHeight(),x=w+h._outerHeight()+p.children(".datagrid-footer")._outerHeight();c.children(":not(.datagrid-view,.datagrid-mask,.datagrid-mask-msg)").each(function(){x+=$(this)._outerHeight()});c.outerHeight(),c.height();g.add(p).children("div.datagrid-body").css({marginTop:w,height:isNaN(parseInt(m))?"":m-x}),u.height(p.height()),p.find(".datagrid-body").css("overflow","auto")},fit_columns:function(e,t){return $(e).width()>t},get_datagrid_select_data:function(e,t){var a=$(e).datagrid("getSelections"),i=[];a.forEach(function(e){i.push(e.id)}),a.length<1?layer.msg(StrackLang.Please_Select_One,{icon:2,time:1200,anim:6}):t(i)},save_dialog_setting:function(){var t=$("#Ntype").val(),e=$("#Npage").val(),a=[];$(".dg-report-de").each(function(){a.push($(this).attr("data-field"))}),$.ajax({type:"POST",url:StrackPHP.saveDialogSetting,dataType:"json",contentType:"application/json",data:JSON.stringify({fields:a,keep_status:Strack.G.dialogKeepBntStatus,type:t,page:e}),beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){Strack.G.DialogAddSetting[t]=e,$.messager.progress("close"),Strack.top_message({bg:"g",msg:StrackLang.Dialog_Setting_Save_SC})}})},main_fields_config:function(e){var t=$(e).data("type"),a=$(e).data("pos"),i=$(e).closest(".menu"),d=i.attr("data-page"),r=i.attr("data-projectid"),o=i.attr("data-moduleid"),n=i.attr("data-modulecode"),s=i.attr("data-templateid");switch(t){case"important":Strack.set_info_main_show_mode({category:"fields_show_mode",module_code:n,template_id:0,config:{mode:"important"},pos:a}),Strack.update_info_main_show_mode_dom(e,"important");break;case"all":Strack.set_info_main_show_mode({category:"fields_show_mode",module_code:n,template_id:0,config:{mode:"all"},pos:a}),Strack.update_info_main_show_mode_dom(e,"all");break;case"setting":Strack.template_set_dialog({datalist_url:StrackPHP.getDetailsModuleColumns,config_url:StrackPHP.getTemplateUserConfig,title:StrackLang.Template_Details_Main_Field,temp_id:s,module_code:n,module_id:o,project_id:r,category:"main_field",type:"main_field",page:d,id_field:"field_group_id",text_field:"lang",text_field_lang:StrackLang.Column,group:"belong_table",limit:0,submit_bnt:"update_details_top_fields_set",pos:a})}},update_info_main_show_mode_dom:function(e,t){$(e).closest(".st-dropdown").find(".info-down-title").text($(e).text())},set_info_main_show_mode_dom:function(e,t){var a="";a="important"===t?StrackLang.Important_Info:StrackLang.All_Info,$("#"+e).find(".info-down-title").text(a),$("#"+e).find(".menu .item").each(function(){$(this).hasClass(t)?$(this).addClass("active"):$(this).removeClass("active")})},set_info_main_show_mode:function(t){$.ajax({type:"POST",url:StrackPHP.modifyUserTemplateConfig,data:JSON.stringify(t),dataType:"json",contentType:"application/json",beforeSend:function(){$("#dialog").prepend(Strack.loading_dom("white","","config"))},success:function(e){$("#st-load_config").remove(),Strack.top_message({bg:"g",msg:e.message}),$.isEmptyObject(Strack.G.topfieldsRequestParam)&&$.isEmptyObject(Strack.G.sliderTopfieldsRequestParam)||("slider"===t.pos?0<=$.inArray(t.category,["main_field","fields_show_mode"])?Strack.load_info_panel(Strack.G.sliderMainfieldsRequestParam):Strack.load_info_panel(Strack.G.sliderTopfieldsRequestParam):0<=$.inArray(t.category,["main_field","fields_show_mode"])?Strack.load_info_panel(Strack.G.mainfieldsRequestParam):Strack.load_info_panel(Strack.G.topfieldsRequestParam)),Strack.dialog_cancel()}})},top_fields_config:function(e){var t=$(e).attr("data-page"),a=$(e).attr("data-pos"),i=$(e).attr("data-projectid"),d=$(e).attr("data-moduleid"),r=$(e).attr("data-modulecode"),o=$(e).attr("data-templateid");Strack.template_set_dialog({datalist_url:StrackPHP.getDetailsModuleColumns,config_url:StrackPHP.getTemplateUserConfig,title:StrackLang.Template_Details_Top_Field,temp_id:o,module_code:r,module_id:d,project_id:i,category:"top_field",type:"top_field",page:t,id_field:"field_group_id",text_field:"lang",text_field_lang:StrackLang.Column,group:"belong_table",limit:3,submit_bnt:"update_details_top_fields_set",pos:a})},template_set_dialog:function(d){var e=d.item_id?d.item_id:0;Strack.open_dialog("dialog",{title:d.title,width:800,height:520,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mtemp_id",type:"hidden",name:"temp_id",valid:1,value:d.temp_id},{case:101,id:"Mid_field",type:"hidden",name:"id_field",valid:1,value:d.id_field},{case:101,id:"Mmodule_code",type:"hidden",name:"module_code",valid:1,value:d.module_code},{case:101,id:"Mcategory",type:"hidden",name:"category",valid:1,value:d.category},{case:101,id:"Mtype",type:"hidden",name:"type",valid:1,value:d.type},{case:101,id:"Mpage",type:"hidden",name:"page",valid:1,value:d.page},{case:101,id:"Mpos",type:"hidden",name:"pos",valid:1,value:d.pos}],items:[{case:5,id:"",type:"text",lang:"",name:"",valid:"",value:0}],footer:[{obj:d.submit_bnt,type:5,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){var i;$("#template-field").datalist({url:d.datalist_url,width:320,height:380,idField:d.id_field,valueField:d.id_field,textField:d.text_field,groupField:d.group,checkbox:!0,singleSelect:!1,queryParams:{item_id:e,module_code:d.module_code,category:d.category,module_id:d.module_id,project_id:d.project_id,template_id:d.temp_id},onLoadSuccess:function(e){var a=$(this);$.ajax({type:"POST",url:d.config_url,dataType:"json",data:{template_id:d.temp_id,module_code:d.module_code,category:d.category},beforeSend:function(){$("#dialog").prepend(Strack.loading_dom("white","","config"))},success:function(e){var t=[{field:d.id_field,checkbox:!0},{field:d.text_field,title:d.text_field_lang,align:"center",width:160}];d.group&&t.push({field:d.group,title:StrackLang.Group,align:"center",width:160}),$("#template-columns").datagrid({data:[],width:380,height:380,rownumbers:!0,fitColumns:!0,columns:[t],dragSelection:!0,onLoadSuccess:function(){(i=$(this)).datagrid("enableDnd")}}),e.forEach(function(e){a.datalist("selectRecord",e[d.id_field])}),$("#st-load_config").remove()}})},onSelect:function(e,t){var a=$("#template-columns");a.datagrid("appendRow",t),i.datagrid("enableDnd"),0<d.limit&&(a.datagrid("getRows").length>d.limit&&$(this).datagrid("unselectRow",e))},onUnselect:function(e,t){var a=$("#template-columns"),i=a.datagrid("getRowIndex",t);a.datagrid("deleteRow",i)}})}})},get_home_template_config:function(){var e=$("#Mtemp_id").val(),t=$("#Mmodule_code").val(),a=$("#Mcategory").val(),i=$("#Mpos").val(),d=$("#Mid_field").val(),r=$("#template-columns").datagrid("getRows"),o=[];return r.forEach(function(e){switch(a){case"top_field":case"main_field":case"tab":case"step":case"step_fields":o.push(e);break;default:var t={};t[d]=e[d],o.push(t)}}),{template_id:e,module_code:t,category:a,config:o,pos:i}},update_details_top_fields_set:function(){var t=Strack.get_home_template_config();$.ajax({type:"POST",url:StrackPHP.modifyUserTemplateConfig,data:JSON.stringify(t),dataType:"json",contentType:"application/json",beforeSend:function(){$("#dialog").prepend(Strack.loading_dom("white","","config"))},success:function(e){$("#st-load_config").remove(),Strack.top_message({bg:"g",msg:e.message}),$.isEmptyObject(Strack.G.topfieldsRequestParam)&&$.isEmptyObject(Strack.G.sliderTopfieldsRequestParam)||("slider"===t.pos?"main_field"===t.category?Strack.load_info_panel(Strack.G.sliderMainfieldsRequestParam):Strack.load_info_panel(Strack.G.sliderTopfieldsRequestParam):"main_field"===t.category?Strack.load_info_panel(Strack.G.mainfieldsRequestParam):Strack.load_info_panel(Strack.G.topfieldsRequestParam)),Strack.dialog_cancel()}})},update_details_tab_set:function(){var t=Strack.get_home_template_config();$.ajax({type:"POST",url:StrackPHP.modifyTemplateConfig,data:JSON.stringify(t),dataType:"json",contentType:"application/json",beforeSend:function(){$("#dialog").prepend(Strack.loading_dom("white","","config"))},success:function(e){$("#st-load_config").remove(),Strack.top_message({bg:"g",msg:e.message}),"slider"===t.pos?Strack.refresh_details_tab(t.config):obj.refresh_details_tab(t.config),Strack.dialog_cancel()}})},refresh_details_tab:function(e){var t=$("#grid_slider_tab .tab_item.active").attr("data-tabid"),a={};e.forEach(function(e){a=a||e,e.tab_id===t&&(a=e)}),Strack.generate_tab_list("grid_slider_tab",Strack.G.gridSliderParam,e),Strack.show_datagrid_slider_tab(a)},upload_image:function(e,t,d,r){var a=["gif","jpeg","jpg","bmp","png"],i=[StrackLang.Image_Format_Limit,StrackLang.Browser_Support];document.getElementById(e).onchange=function(){if(this.value){if(!RegExp(".("+a.join("|")+")$","i").test(this.value.toLowerCase()))return Strack.top_message({bg:"r",msg:i[0]}),this.value="",!1;if(-1<navigator.userAgent.indexOf("MSIE"))return Strack.top_message({bg:"r",msg:i[1]}),this.value="",!1;if($("#"+t).val(this.value),this.files[0]){var e=new FileReader;e.addEventListener("load",function(e){var t=e.target.result,i=new Image;i.addEventListener("load",function(){var e=0<parseInt(r)?r:280,t=i.width*(e/i.height);$("#"+d).empty().append('<canvas id="img_cas" width="'+t+'" height="'+e+'"></canvas>');var a=document.getElementById("img_cas");a.getContext("2d").drawImage(i,0,0,t,e),Strack.G.Jcrop_Canvas=a},!1),i.src=t},!1),e.readAsDataURL(this.files[0])}}}},top_message:function(e){var t;switch(String(e.bg)){case"r":t="error";break;case"g":t="success";break;case"w":t="warn";break;default:t="success"}layer.msg(e.msg,{offset:"10px",skin:"a-bounceinT layui-layer-bmsg layui-layer-"+t,time:3e3})},upload_preview:function(e){var b=this,S=null,y=null,w="",x="";b.IsNull=function(e){return"function"!=typeof e&&(null==e||null==e||""==e||0==e.length)},b.DefautlSetting={UpBtn:"",Canvas:"",Cancel:[""],Jcrop:"",Showpanel:!1,Width:100,Height:100,MinLimit:50,ImgType:["gif","jpeg","jpg","bmp","png"],ErrMsg:[StrackLang.Image_Format_Limit,StrackLang.Browser_Support],callback:function(){}},b.Setting={UpBtn:b.IsNull(e.UpBtn)?b.DefautlSetting.UpBtn:e.UpBtn,Canvas:b.IsNull(e.Canvas)?b.DefautlSetting.Canvas:e.Canvas,Cancel:b.IsNull(e.Cancel)?b.DefautlSetting.Cancel:e.Cancel,Jcrop:b.IsNull(e.Jcrop)?b.DefautlSetting.Jcrop:e.Jcrop,Showpanel:b.IsNull(e.Showpanel)?b.DefautlSetting.Showpanel:e.Showpanel,Width:b.IsNull(e.Width)?b.DefautlSetting.Width:e.Width,Height:b.IsNull(e.Height)?b.DefautlSetting.Height:e.Height,MinLimit:b.IsNull(e.MinLimit)?b.DefautlSetting.MinLimit:e.MinLimit,ImgType:b.IsNull(e.ImgType)?b.DefautlSetting.ImgType:e.ImgType,ErrMsg:b.IsNull(e.ErrMsg)?b.DefautlSetting.ErrMsg:e.ErrMsg,callback:b.IsNull(e.callback)?b.DefautlSetting.callback:e.callback},b.drawImg=function(e,k){if(e){var t=new FileReader;t.addEventListener("load",function(e){var t=e.target.result,v=new Image;v.addEventListener("load",function(){var d,e,t,a,i,r,o,n,s=v.width,l=v.height,c=b.Setting.Width,_=b.Setting.Height,m=b.Setting.MinLimit,u=s/l;t=(c-(d=c/m<=u?m*u:u<=m/_?m<s?s:m:c<=s?c:l<=_?_*u:s))/2,a=-((e=d/u)-_)/2,i=-((n=_<e?_:e)-_)/2,r=(c-(o=c<d?c:d))/2,$(".crop-avatar-img").html('<canvas id="'+k+'" height="'+n+'px" width="'+o+'px" style="position: absolute;top:'+i+"px;left:"+r+'px">'),y=document.getElementById(k);var g=(Strack.G.Jcrop_Canvas=y).getContext("2d");g.globalCompositeOperation="copy",""!=b.Setting.Jcrop&&(null!=S&&""!=S&&$(".jcrop-holder").remove(),$("#"+k).parent().after('<div id="'+b.Setting.Jcrop+'"></div>'),$("#"+b.Setting.Jcrop).css({width:o+"px",height:n+"px",top:i+"px",left:r+"px"}),$("#"+b.Setting.Jcrop).Jcrop({minSize:[m,m],onChange:function(e){var t=(Strack.G.Jcrop_Thumb=e).x,a=e.y,i=m/e.w;$(".avatar-view-sm1>img").css({"margin-top":"-"+a*i+"px","margin-left":"-"+t*i+"px",width:d*i+"px"}),$(".avatar-view-sm2>img").css({"margin-top":"-"+2*a/3*i+"px","margin-left":"-"+2*t/3*i+"px",width:2*d/3*i+"px"}),$(".avatar-view-sm3>img").css({"margin-top":"-"+a/3*i+"px","margin-left":"-"+t/3*i+"px",width:d/3*i+"px"})},aspectRatio:1},function(){this.getBounds(),(S=this).animateTo([0,0,m,m])}));var p=0,f=0;if(o<d&&(p=t),n<e&&(f=a),w=d,x=e,g.drawImage(v,p,f,d,e),""!=b.Setting.Jcrop){var h=y.toDataURL("image/png");$(".avatar-view-sm1").html('<img  src="'+h+'" />'),$(".avatar-view-sm2").html('<img  src="'+h+'" />'),$(".avatar-view-sm3").html('<img  src="'+h+'" />'),$(".avatar-view-sm2>img").css({width:2*d/3+"px"}),$(".avatar-view-sm3>img").css({width:d/3+"px"})}},!1),v.src=t},!1),t.readAsDataURL(e)}},b.Cancel=function(){y&&(y.getContext("2d").clearRect(0,0,w,x),null!=S&&""!=S&&($(".jcrop-holder").remove(),$(".avatar-view-sm1,.avatar-view-sm2,.avatar-view-sm3").empty(),Strack.G.Jcrop_Thumb=""),y=null,Strack.G.Jcrop_Canvas=y)},b.Bind=function(){if(document.getElementById(b.Setting.UpBtn).onchange=function(){if(this.value){var e=this.value.toLowerCase();if(!RegExp(".("+b.Setting.ImgType.join("|")+")$","i").test(e))return Strack.top_message({bg:"r",msg:b.Setting.ErrMsg[0]}),this.value="",!1;if(-1<navigator.userAgent.indexOf("MSIE"))return Strack.top_message({bg:"r",msg:b.Setting.ErrMsg[1]}),this.value="",!1;var t=e.split(".");Strack.G.Jcrop_Thumb_Ext=t[t.length-1],b.drawImg(this.files[0],b.Setting.Canvas),b.Setting.callback()}},b.Setting.Cancel){for(var e="",t=$(".crop-avatar-wrap"),a=0;a<b.Setting.Cancel.length;a++)e+=b.Setting.Cancel[a]+",";e=e.substring(0,e.length-1),b.Setting.Showpanel?(t.show(),$(e).click(function(){b.Cancel()})):$(e).click(function(){t.slideToggle(function(){b.Cancel()})})}},b.Bind()},global_loading:function(){return'<div class="global-loading-wrap"><div class="global-masked"><i class="icon-strack_logo"></i></div></div>'},cancel_global_loading:function(){setTimeout(function(){$(".global-masked").hide(),$(".global-loading-wrap").addClass("a-fadeout"),setTimeout(function(){$(".global-loading-wrap").remove()},1e3)},500)},init_dropdown:function(e){$(e||".ui.menu , .ui.dropdown").dropdown({on:"hover",onHide:function(e){return!Strack.G.isClickDropdown.status||Strack.G.isClickDropdown.target.html()!==$(this).html()||(Strack.G.isClickDropdown.target=$(this),Strack.G.isClickDropdown.status=!1)}})},close_notice_message:function(){$(".globel-top-notice").remove(),$("body").removeClass("has-top-notice-body")},click_admin_menu:function(e){Strack.save_storage("admin_menu_top",$(".admin-page-left").scrollTop())},on_before_unload_notice:function(){return"The current page is not saved! Is it overloaded?"},build_top_menu:function(){$.ajax({type:"POST",url:StrackPHP.getTopMenuData,dataType:"json",data:{menu_name:Strack.G.MenuName,module_id:Strack.G.ModuleId,module_type:Strack.G.ModuleType,project_id:Strack.G.ProjectId},success:function(e){Strack.TopMenuData=e.menu_data,Strack.generate_top_menu(e.menu_data),0<=$.inArray(Strack.G.MenuName,["project_inside","project_detail"])&&($(".nav-breadcrumb-name").attr("title",e.project_data.current_project.name),$(".nav-breadcrumb-text").html(e.project_data.current_project.name),Strack.top_menu_project_item_dom(e.project_data),$(".nav-project-head").show()),Strack.top_menu_on_resize()}})},generate_top_menu:function(e){var t=$("#nav_main_bar").width(),a=$("#nav_main_list"),i=$("#nav_hide_list"),d=$(".nav-main-bar-hide");d.hide().removeClass("nav_main_active"),a.empty(),i.empty();var r,o=46,n="",s=!0,l=!1;e.forEach(function(e){t<o?(l=!0,s&&($("#"+n).remove(),"yes"===r.active&&d.addClass("nav_main_active"),i.append(Strack.top_menu_hide_dom(r)),s=!1),i.append(Strack.top_menu_hide_dom(e))):a.append(Strack.top_menu_main_dom(e)),n="top_m_"+(r=e).code,o+=$("#top_m_"+e.code).width()+2}),l?d.show():$(".nav-main-bar-show").css("margin-left",(t-o)/2)},refresh_top_menu:function(e){Strack.TopMenuData=e,Strack.generate_top_menu(e)},top_menu_on_resize:function(){$(".header-main").on("mresize",function(){Strack.generate_top_menu(Strack.TopMenuData)})},top_menu_project_item_dom:function(t){var a="",i=Strack.remove_html_ext(StrackPHP.Project_Url)+"/"+t.project_last_url;t.active_project_list.forEach(function(e){a+='<a href="'+i+e.project_id+'.html" class="item" data-value="'+t.current_project.name+'"><span class="project-menu-name text-ellipsis">'+e.name+"</span></a>"}),$("#to_menu_project_list").empty().append(a)},top_menu_main_dom:function(e){var t="",a="yes"===e.active?"nav_main_active":"";return t+='<li id="top_m_'+e.code+'" class="nav-main-items '+a+'">',"#"!==e.url?t+='<a href="'+e.url+'">'+e.name+"</a>":t+='<a href="'+e.url+'" >'+e.name+"</a>",t+="</li>"},top_menu_hide_dom:function(e){var t="",a="yes"===e.active?"active":"";return"yes"===e.active&&$(".nav-main-bar-hide").addClass("nav_main_active"),t+='<a href="'+e.url+'" class="item '+a+'" data-text="'+e.name+'">'+e.name+"</a>"},body_click_event:function(){$(document).mouseup(function(e){var t=$(".widget_input");(!t.is(e.target)&&0===t.has(e.target).length&&0===$(e.target).closest(".combo-p").length||!$(e.target).hasClass("widget-show")&&0===$(e.target).closest(".widget-show").length&&0===$(e.target).closest(".combo-p").length)&&Strack.widget_update(),0<$(e.target).closest(".st-down-menu").length||0<$(e.target).closest(".dropdown").length||0<$(e.target).closest(".combo-p").length?(Strack.G.isClickDropdown.status=!0,Strack.G.isClickDropdown.target=$(e.target).closest(".dropdown")):(Strack.G.isClickDropdown.status=!1,Strack.G.isClickDropdown.target=$(e.target).closest(".dropdown"),$(".ui.menu , .ui.dropdown").dropdown("hide"));var a=$("#project_top_name");a.is(e.target)||0!==a.has(e.target).length||a.is(":visible")&&obj.modify_project_name(a);var i=$(".filter-task-list");i.is(e.target)||0!==i.has(e.target).length||i.slideUp(100);var d=$(".layui-layer-content");!d.is(e.target)&&0===d.has(e.target).length&&0<$(".layui-layer-tips").length&&layer.tips("close");var r=$(".datagrid-btable");if(!r.is(e.target)&&0===r.has(e.target).length&&0==$(e.target).closest(".combo-p").length){var o=$(".datagrid-editable");if(0<o.length){var n=parseInt(o.closest(".datagrid-row").attr("datagrid-row-index"));o.closest(".datagrid-view").find(".datagrid-f").datagrid("endEdit",n)}}var s=$(".task-repeat-editor");if(!s.is(e.target)&&0==$(e.target).closest(".task-repeat-editor").length&&0==$(e.target).closest(".combo-p").length){s.hide();var l=s.data("id");$("#"+l).removeClass("loaded")}$(e.target).hasClass("st-grid-mask")&&!Strack.G.onSideHandleResize&&Strack.close_datagrid_slider("")})},G:{userId:0,Default_Mail:"@strack.com",Jcrop_Thumb:"",Jcrop_Thumb_Ext:"",Note_Uploadifive_Imgs:[],Note_Delete_Img_Ids:[],Note_Has_Img_Length:0,Jcrop_Canvas:"",Media_Server:{},cnotedom:"",topMenuActive:!1,Geditor:{},GeditorParam:{},MDeditor:null,Gfilter_data:{},Group_data:{},Gfilter_list:{},GanttFilter:{},MediaFilter:{},WebplayerPage:!1,GacPlaylist:[],Gmindex:0,GridPage:{},KankanItem:{},FilterAutoCheck:!1,FilterProjFirst:0,FilterStepsFirst:0,FilterData:{},FilterProj:"",FilterEntity:"",FilterTopJob:{},FilterTopMsg:{},InputExCkfields:{},CustomEditIndex:[],MenuName:"",ProjectId:0,ModuleId:0,ModuleType:0,AccMenu:"",TlStart:0,TllogTerval:{},SumFilters:null,IsNewfileds:!1,Gplaylistid:0,GridStepsHidelist:[],FrameRates:{film:24,NTSC:29.97,NTSC_Film:23.98,NTSC_HD:59.94,PAL:25,PAL_HD:50,web:30,high:60},Timesheet:"now",TimesheetOld:"",FilterWidget:[],CurrentView:{},ViewsetData:{},DialogAddSetting:{},ImgViewzoom:1,ImgZoomSpeed:.1,ImgZoomX:0,ImgZoomY:0,Project_Menu:[],comboxItemType:0,comboxItemDom:"",comboxStepDom:"",groupview:null,gridFieldCache:{},leftScrolling:0,TopMenuData:[],jsonEditor:{},entityStepTaskAddData:{status:!1,data:{}},importExcelStep:null,importExcelData:{},mediaScreenshotStatus:!1,gridFirstColMap:{},gridSliderActiveTab:{},gridSliderParam:{},gridSliderGridParam:{},mediaViewPlayIndex:0,closeNoteObj:null,horizontalRelationIds:{add:[],delete:[]},UnReadMessageData:null,topfieldsRequestParam:{},sliderTopfieldsRequestParam:{},mainfieldsRequestParam:{},sliderMainfieldsRequestParam:{},sideTimelogParam:{},dataGridStepColunmsConfig:{},onSideHandleResize:!1,isClickDropdown:{status:!1,target:""},infoMediaNeedInit:[],gridMediaNeedInit:[],batchUploadMediaType:"",pageHiddenParam:{},calendarEventsFilter:{department_members:"",project:"",task_type:"",end_time:{type:"fixed",value:null},user_receive:"",user_sent:""},calendarLoadMode:"",calendarLockDateList:[],calendarTaskRemainderLime:{},dialogDomList:{},dialogItemMustFields:[],dialogItemFieldsConfig:{},dialogKeepBntStatus:{continue_next:"no",keep_data:"no"},tempStartTimelogids:{ids:[],status:{}},myScheduleSideParam:{},myScheduleDeleteTaskData:{},repeatTaskConfigData:{},addCustomFieldExpressionDataMap:{},addCustomFieldExpressionData:{fill_status:0,param:{},formula_fields:{},formula:""}}};Strack.Websocket={List:{},heartbeatList:{},init:function(t,a){if(window.WebSocket)if(Strack.Websocket.List[t])a.afterInit&&a.afterInit({status:"exist"});else{var e="";e=0<$(".st-bg-black").length?"black":"white",$(".pushable").prepend(Strack.loading_dom(e,StrackLang.Starting_Action,"run_action"));var i=new WebSocket(a.url);i.onopen=function(e){Strack.Websocket.List[t]=i,Strack.Websocket.heartbeat(t),a.afterInit&&($("#st-load_run_action").remove(),a.afterInit({status:"new",data:e}))},i.onclose=function(e){a.onClose&&a.onClose(e.data)},i.onmessage=function(e){a.onMessage&&a.onMessage(e.data)},i.onerror=function(e){Strack.Websocket.close(t),a.afterInit&&($("#st-load_run_action").remove(),a.afterInit({status:"error",data:e,message:"Connection error."}))}}else a.afterInit&&a.afterInit({status:"error",message:"No support for webSocket."})},bind:function(e,t){Strack.Websocket.List[e].send(JSON.stringify({method:"bind",data:t}))},heartbeat:function(e){Strack.Websocket.List[e]&&(Strack.Websocket.heartbeatList[e]=window.setInterval(function(){Strack.Websocket.List[e].send(JSON.stringify({method:"heartbeat"}))},3e4))},send:function(e,t){Strack.Websocket.List[e].send(JSON.stringify(t))},close:function(e){var t={},a={};if(Strack.Websocket.List[e]){for(var i in Strack.Websocket.List[e].send("close"),Strack.Websocket.List[e].close(),Strack.Websocket.List)e!==i&&(t[i]=Strack.Websocket.List[i]);for(var d in Strack.Websocket.List=t,clearInterval(Strack.heartbeatList.List[e]),Strack.heartbeatList.List)e!==d&&(a[d]=Strack.heartbeatList.List[d]);Strack.heartbeatList.List=a}}},Strack.Notify={obj:null,init:function(){Strack.Notify.obj=new Notify({effect:"flash",interval:1e3,notification:{title:"Notification",icon:StrackPHP.IMG+"/strack_notice.ico",body:"You have a new message!",openurl:""}})},show:function(e,t,a){Strack.Notify.obj.notify({title:e,body:t,openurl:a})}},Strack.update={init:function(){$.ajax({type:"POST",url:StrackPHP.getLogServerConfig,dataType:"json",success:function(e){"yes"===e.active&&e.websocket_url&&Strack.Websocket.init("update",{url:e.websocket_url+"?sign="+e.token,afterInit:function(e){"error"===e.status&&console.log("ws error:"+e.message)},onMessage:function(e){var t=JSON.parse(e);switch(t.type){case"connect":Strack.Websocket.bind("update",Strack.get_page_uuid());break;case"message":Strack.update.message(t)}}})}})},refresh:function(){},message:function(n){var e="",t="";if(n.belong_system===StrackPHP.Belong_System){if(0<=$.inArray(Strack.G.userId,n.member)){switch(Strack.G.UnReadMessageData.created=n.created,Strack.G.UnReadMessageData.massage_number=Strack.G.UnReadMessageData.massage_number+1,Strack.top_tool_number("#top_msg_number",Strack.G.UnReadMessageData.massage_number),n.message.operate){case"update":e+=StrackLang.Modify+"-"+n.module_data.name,t+=n.message.title.created_by+" "+StrackLang.Modify+" "+n.message.title.module_name+" "+n.message.title.item_name;break;case"add":e+=StrackLang.Create+"-"+n.module_data.name,t+=n.message.title.created_by+" "+StrackLang.Create+" "+n.message.title.module_name+" "+n.message.title.item_name;break;case"delete":e+=StrackLang.Delete+"-"+n.module_data.name,t+=n.message.title.created_by+" "+StrackLang.Delete+" "+n.message.title.module_name+" "+n.message.title.item_name;break;case"apply":e+=StrackLang.Application_For_Settlement+"-"+n.module_data.name,t+=n.message.title.created_by+" "+StrackLang.Application_For_Settlement+" "+n.message.title.module_name+" "+n.message.title.item_name;break;case"reject":e+=StrackLang.Reject_For_Settlement+"-"+n.module_data.name,t+=n.message.title.created_by+" "+StrackLang.Reject_For_Settlement+" "+n.message.title.module_name+" "+n.message.title.item_name;break;case"confirm":e+=StrackLang.Confirmation_For_Settlement+"-"+n.module_data.name,t+=n.message.title.created_by+" "+StrackLang.Confirmation_For_Settlement+" "+n.message.title.module_name+" "+n.message.title.item_name;break;case"reminder":e+=StrackLang.Reminder+"-"+n.module_data.name,t+=n.message.title.created_by+" "+StrackLang.Reminder+" "+n.message.title.module_name+" "+n.message.title.item_name}var a="";n.message.title.url?a=n.message.title.url:n.message.position&&n.message.position.url&&(a=n.message.position.url),Strack.Notify.show(e,t,a)}switch(n.status=200,console.log(n),n.from_type){case"thumb":Strack.update.thumbnail(n);break;case"note":Strack.update.note(n);break;case"widget_common":Strack.update.widget(n,n.param.widget_param);break;case"widget_grid":switch(n.message.operate){case"add":"my_scheduler"!==n.param.page&&"plan"!==n.module_data.code||0<=$.inArray(Strack.G.userId,n.member)&&Strack.reload_fullCalendar_data("scheduler_my_index");break;case"update":"plan"===n.module_data.code&&0<=$.inArray(Strack.G.userId,n.member)&&Strack.reload_fullCalendar_data("scheduler_my_index")}break;case"timelog_bnt_schedule":case"timelog_bnt_slider":case"timelog_bnt_kanban":$.each($(".time_log_bnt_"+n.data.link_id),function(e,t){var a=$(t).attr("data-id"),i=$(t).attr("data-linkid"),d=$(t).attr("data-timelogid"),r=$(t).attr("data-moduleid"),o=$(t).attr("data-from");Strack.item_timelog_bnt_refresh(t,"update",{id:a,link_id:i,timelog_id:d,module_id:r,from:o,data:n.data})});break;case"base_confirmation":var i="";switch(n.data.operation){case"apply":i=".settlement_bnt_af_"+n.data.link_id;break;case"reject":i=".settlement_bnt_jj_"+n.data.link_id;break;case"confirm":i=".settlement_bnt_cf_"+n.data.link_id}$.each($(i),function(e,t){Strack.refrash_confirmation_bnt_show(t,n.data.operation),Strack.reset_my_schedule(t)})}}},widget:function(e,t){var a,i="",d=e.param,r=e.data;if("media"!==t.editor){var o=(a=$("."+t.dom)).find(".widget-edit"),n=a.find(".info-content-show");if(o.attr("data-value",d.val),r.value_show&&r.value_show.hasOwnProperty("rows")){var s=[];if(0<r.value_show.total&&r.hasOwnProperty("custom_config")&&"belong_to"===r.custom_config.field_type)switch(r.custom_config.relation_module_code){case"status":i=Strack.hex_to_rgb(r.value_show.rows[0].color,.3),a.css("background-color",i),n.html(Strack.widget_status_dom(r.value_show.rows[0].icon,r.value_show.rows[0].name,r.value_show.rows[0].color));break;default:r.value_show.rows.forEach(function(e){s.push(e.name)}),n.html(s.join(","))}else r.value_show.rows.forEach(function(e){s.push(e.name)}),n.html(s.join(","))}else{var l=r.value_show;"timespinner"===d.editor&&(l=Strack.format_timespinner_val(r.value_show)),n.html(l)}Strack.update.excessive_color(e.status,a,i)}var c=$("td[id="+t.dom+"]");if(0<c.length&&c.hasClass("is-grid-td"))switch(Strack.update.excessive_color(e.status,c,i),t.editor){case"media":var _=e.data;if("yes"===_.has_media){var m="origin";_.param.size.forEach(function(e){"origin"!==e&&e.split("x")[0]<99999&&(m=e)});var u=_.param.base_url+"/"+_.param.md5_name+"_"+m+"."+_.param.ext;t.dom.find(".athumb").empty().append('<img src="'+u+'">')}break;default:setTimeout(function(){var e=c.attr("data-grid"),t=c.attr("field"),a=$("#"+e),i=c.closest(".datagrid-row").attr("datagrid-row-index"),d=a.datagrid("getRow",i);d[t]=r.value_show,a.datagrid("updateRow",{index:i,row:d})},600)}},note:function(e){var t=$("."+e.param.list_class+"_"+e.data.link_id);switch(e.operate){case"add":"yes"===e.data.stick?t.find(".note-stick").prepend(Strack.notes_single_item_dom(e.data,"add")):t.find(".note-no-stick").prepend(Strack.notes_single_item_dom(e.data,"add")),Strack.init_note_att_event(".comment_note_"+e.data.id);break;case"update":var a=$(".comment_note_"+e.data.id),i=Strack.notes_single_item_dom(e.data,"modify");a.attr("stick")!==e.data.stick?(a.remove(),"yes"===e.data.stick?t.find(".note-stick").prepend(Strack.notes_single_item_dom(e.data,"add")):t.find(".note-no-stick").prepend(Strack.notes_single_item_dom(e.data,"add"))):a.empty().append(i),Strack.init_note_att_event(".comment_note_"+e.data.id);break;case"delete":$(".comment_note_"+e.data.id).remove()}Strack.update.fix_note_stick_class(t)},fix_note_stick_class:function(e){var t=e.find(".note-stick");0<t.find(".comment").length?t.addClass("note-stick-bottom"):t.removeClass("note-stick-bottom")},thumbnail:function(t){var e=[];e="direct"===t.param.relation_type?$(".thumb-"+t.param.module_id+"-"+t.param.link_id):$("."+t.param.relation_custom_fields+"-"+t.param.module_id+"-"+t.param.link_id);var a=null;e.each(function(){switch($(this).attr("thumb-type")){case"avatar":a=$(this).parent().html(Strack.build_avatar(t.param.link_id,t.param.thumb,""));break;case"thumb":a=$(this).parent();var e=t.data;e.link_id=t.param.link_id,e.module_id=t.module_data.id,e.param.icon=t.module_data.icon,a.hasClass(".datagrid-cell"),Strack.thumb_media_widget(a[0],e,{modify_thumb:t.param.rule_thumb_modify,clear_thumb:t.param.rule_thumb_clear})}})},excessive_color:function(e,t,a){var i=200===parseInt(e)?"#00FF54":"#FF4739",d=a||"transparent";t.css({"background-color":i,transition:"background-color 100ms ease-in","-moz-transition":"background-color 100ms ease-in","-webkit-transition":"background-color 100ms ease-in","-o-transition":"background-color 100ms ease-in"}),setTimeout(function(){t.css({"background-color":d,transition:"background-color 300ms ease-in","-moz-transition":"background-color 300ms ease-in","-webkit-transition":"background-color 300ms ease-in","-o-transition":"background-color 300ms ease-in"})},300)}},Strack.notice={license:function(e){var t=parseInt(Strack.read_storage("last_notice_date"));if(parseInt(e.expiry_days)<30&&t!==parseInt(e.last_notice_date)){Strack.save_storage("last_notice_date",e.last_notice_date);var a=Strack.notice.dom({bg_color:"notice-color-red",count_down:"10 S",content:StrackLang.License_Warn_Notice_1+" "+e.expiry_date+" "+StrackLang.License_Warn_Notice_2+" "+StrackLang.License_Warn_Notice_3,content_css:"",close:!0});$("body").addClass("has-top-notice-body").before(a),Strack.notice.auto_close(10)}},demo_project:function(t){if(!$.isEmptyObject(t)){var e=1;0<$(".globel-top-notice").length&&(e=10010),setTimeout(function(){0<$(".globel-top-notice").length&&Strack.close_notice_message();var e=Strack.notice.dom({bg_color:"notice-color-green",count_down:"",content:StrackLang.Project_Demo+"  "+t.name,content_css:"text-align-center",close:!1});$("body").addClass("has-top-notice-body").before(e)},e)}},dom:function(e){var t="";return t+='<header class="globel-top-notice '+e.bg_color+'"><div class="notice-count aign-left">'+e.count_down+'</div><div class="notice-content aign-left '+e.content_css+'">'+e.content+"</div>",e.close&&(t+='<a href="javascript:;" class="notice-close aign-right" onclick="Strack.close_notice_message(this)"><i class="icon-uniE6DB"></i></a>'),t+="</header>"},auto_close:function(e){var t=setInterval(function(){e--,$(".notice-count").html(e+" S")},100*e);setTimeout(function(){0<$(".globel-top-notice").length&&Strack.close_notice_message(),clearTimeout(t)},1e3*e)}},$(function(){if(Strack.init_dropdown(),Strack.body_click_event(),Strack.Notify.init(),Strack.build_top_menu(),Strack.top_header(),Strack.G.MenuName){var e=$("#admin_"+Strack.G.MenuName);if(e.length){var t=Strack.read_storage("admin_menu_top"),a=$(".admin-page-left");e.addClass("admin-menu-active");var i=0,d=document.documentElement.clientHeight;if(0<t)i=t;else a.scrollTop(0),i=e.offset().top-d+82;0<i&&a.scrollTop(i)}}Strack.G.AccMenu&&$("#account-"+Strack.G.AccMenu).addClass("account-menu-active"),Strack.update.init()});