$(function(){obj={auth_role_add:function(){Strack.open_dialog("dialog",{title:StrackLang.Add_Auth_Role,width:480,height:240,content:Strack.dialog_dom({type:"normal",items:[{case:1,id:"Nname",lang:StrackLang.Name,name:"name",valid:"1,128",value:""},{case:1,id:"Ncode",lang:StrackLang.Code,name:"code",valid:"1,128",value:""}],footer:[{obj:"role_add_submit",type:1,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),close:function(){}})},role_add_submit:function(){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",RolePHP.addAuthRole,{back:function(e){200===parseInt(e.status)?(Strack.dialog_cancel(),obj.auth_role_filter(),Strack.top_message({bg:"g",msg:e.message})):layer.msg(e.message,{icon:7,time:1200,anim:6})}},{extra:function(e){return e.type="custom",e}})},auth_role_modify:function(e){var a=$(e).data("roleid"),t=$(e).data("name"),i=$(e).data("code");Strack.open_dialog("dialog",{title:StrackLang.Modify_Auth_Role,width:480,height:240,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mauth_role_id",type:"hidden",name:"id",valid:1,value:a}],items:[{case:1,id:"Mauth_role_name",type:"text",lang:StrackLang.Name,name:"name",valid:1,value:t},{case:1,id:"Mauth_role_code",type:"text",lang:StrackLang.Code,name:"code",valid:1,value:i}],footer:[{obj:"modify_auth_role",type:1,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),close:function(){}})},modify_auth_role:function(){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",RolePHP.modifyAuthRole,{back:function(e){200===parseInt(e.status)?(Strack.dialog_cancel(),obj.auth_role_filter(),Strack.top_message({bg:"g",msg:e.message})):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},auth_role_delete:function(e){var a=$(e).data("roleid");Strack.ajax_base_delete(a,StrackLang.Delete_AuthRole_Notice,RolePHP.deleteAuthRole,function(e){obj.auth_role_filter()})},auth_role_filter:function(){var e=$("#search_val").val(),a="";0<e.length&&(a=JSON.stringify({name:["LIKE","%"+e+"%"]})),obj.reset_right_panel(),t(a)},select_auth_role:function(e){var a=$(e).data("roleid"),t=$(e).data("name"),i=$(e).data("code");$(".temp-setlist-no").hide(),$(".temp-setlists").show(),$("#hide_role_id").val(a),$("#hide_role_name").val(t),$("#hide_role_code").val(i),$(".role-items").removeClass("templates-active"),$(e).closest(".role-items").addClass("templates-active"),obj.reset_right_rule_panel(),o("project")},select_role_tab:function(e){var a=$("#hide_role_id").val(),t=$(e).data("tab");obj.reset_right_rule_panel(),o(t)},select_module:function(e){var a=$("#hide_role_id").val(),t=$(e).data("tab"),i=$(e).data("type"),o=$(e).data("id"),r=$(e).data("classtype"),d=s[o];d.role_id=a,d.mode=t,d.class_type=r,$(".nation-items").removeClass("admin-bid-ac"),$(e).addClass("admin-bid-ac");var n,l,c=$("#content_right_"+i);c.find(".temp-content-right-no").hide(),c.find(".temp-content-right-wrap").show(),$("#rule_tab_"+i+"_function").show(),n=t,l=d,$("#hide_role_rule_id").val(l.id),$("#hide_role_rule_code").val(l.code),$("#hide_role_template_id").val(l.template_id),$("#hide_role_module_id").val(l.module_id),function(n,l){$.ajax({url:RolePHP.getAuthModuleRules,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify(n),beforeSend:function(){$("#content_right_func").append(Strack.loading_dom("white","","module_item"))},success:function(e){$("#st-load_module_item").remove();var a,t,i=[];switch(l){case"project":case"front":case"admin":case"api":case"client":e.view&&(i.push("view"),$("#rule_page_function_list").tree({data:e.view,checkbox:!0}));break;case"field":var o=$("#rule_auth_field_list");if(e.column){i.push("column");var r=$("#rule_tab_project_field");if(r.addClass("active"),o.hasClass("datagrid-f"))o.treegrid("loadData",_(e.column));else{var d=_(e.column);o.treegrid({data:d,idField:"id",treeField:"lang",dataGridType:"treegrid",headerAddCheckbox:!0,rowheight:36,height:Strack.panel_height(".role-rule-wrap",0),adaptive:{dom:".role-rule-wrap",min_width:1004,exth:0},columns:[[{field:"lang",title:StrackLang.Authority,width:220},{field:"view",title:StrackLang.Check,width:120,align:"center",formatter:function(e,a,t){return u("view",a,e)}},{field:"create",title:StrackLang.Create,width:120,align:"center",formatter:function(e,a,t){return u("create",a,e)}},{field:"clear",title:StrackLang.Clear,width:120,align:"center",formatter:function(e,a,t){return u("clear",a,e)}},{field:"modify",title:StrackLang.Modify,width:120,align:"center",formatter:function(e,a,t){return u("modify",a,e)}},{field:"delete",title:StrackLang.Delete,width:120,align:"center",formatter:function(e,a,t){return u("delete",a,e)}}]],onAfterRender:function(e){Strack.init_rule_grid_data(e)}})}r.removeClass("active")}break;case"data_range":i.push("data_range"),$("#data_range_rules_list").empty().append((a=n.id,t="",e.forEach(function(e){t+='<div class="rr-data-r-item">',"yes"===e.checked?t+='<input type="radio" name="'+a+'" checked="checked" data-page="'+a+'" data-authpage="'+e.page+'" data-authid ="'+e.id+'" data-authcode ="'+e.code+'">':t+='<input type="radio" name="'+a+'"  data-page="'+a+'" data-authpage="'+e.page+'" data-authid ="'+e.id+'" data-authcode ="'+e.code+'">',t+=StrackLang[e.lang],t+="</div>"}),t))}$("#hide_role_rule_tab").val(i.join(","))}})}(l,n)},toggle_rule_tab:function(e){},auth_module_tab_save:function(){var e={};$("#hide_role_param input").each(function(){e[$(this).attr("name")]=$(this).val()}),function(r){var e=r.role_rule_tab.split(","),a={};if(0<=$.inArray("view",e)){var t=$("#rule_page_function_list"),i=t.tree("getRoots"),o=t.tree("getChecked",["checked"]),d=t.tree("getChecked",["indeterminate"]),n=[];o.forEach(function(e){n.push(e.code+"_"+e.id)});var l=[];d.forEach(function(e){l.push(e.code+"_"+e.id)});var c={};i.forEach(function(e){c=function a(e,t,i,o,r){var d="deny";0<=$.inArray(e.code+"_"+e.id,i)&&(d="allow");0<=$.inArray(e.code+"_"+e.id,o)&&(d="indeterminate");t[e.id]={role_id:r,auth_id:e.id,page:e.page,type:"page",param:e.param,permission:d};e.children&&e.children.forEach(function(e){a(e,t,i,o,r)});return t}(e,c,n,l,r.role_id)}),a.view=c}if(0<=$.inArray("column",e)){var s={},_={},u="",h="",p=!1,g="",m="";$("#rule_tab_field_function .dg-rule-checkbox").each(function(){"single"===(g=$(this).data("pos"))?(u=$(this).data("parent")+"_"+$(this).data("code"),h=$(this).data("field"),p=!!$(this).find(".tree-checkbox").hasClass("tree-checkbox1"),s[u]||(s[u]={}),s[u][h]=p):"parent"===g&&(m=$(this).data("code"),p=!$(this).find(".tree-checkbox").hasClass("tree-checkbox0"),_[m]&&!p||(_[m]=p))});var f=[],v={},k={},b=["view","create","modify","delete","clear"];$("#rule_auth_field_list").treegrid("getRoots").forEach(function(a){a.children.forEach(function(e){v=s[a.code+"_"+e.code],k=[],b.forEach(function(e){v[e]&&k.push(e)}),f.push({role_id:r.role_id,auth_id:e.id,page:a.code,param:"",type:"field",permission:k.join(","),module_id:e.module_id,project_id:e.project_id})})}),a.column=f}if(0<=$.inArray("data_range",e)){var y=[];$("#data_range_rules_list input").each(function(){if($(this).prop("checked")){var e=$(this).data("authid"),a=$(this).data("authcode"),t=$(this).data("page"),i=$(this).data("authpage"),o={role_id:r.role_id,auth_id:e,page:"",param:"",type:"data_range",permission:a,module_id:0,project_id:0};switch(i){case"task_related_user":o.page=i,o.param=t,r.auth_param=t;break;default:o.page=t,r.auth_param=""}y.push(o)}}),a.data_range=y}$.ajax({url:RolePHP.saveAuthAccess,type:"POST",dataType:"json",data:JSON.stringify({param:r,config:a}),contentType:"application/json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),200===parseInt(e.status)?Strack.top_message({bg:"g",msg:e.message}):layer.msg(e.message,{icon:7,time:1200,anim:6})}})}(e)},reset_right_rule_panel:function(){$(".temp-content-right-no").show(),$(".temp-content-right-wrap").hide()},reset_right_panel:function(){$(".temp-setlist-no").show(),$(".temp-setlists").hide()}};var s={};function t(e){$.ajax({url:RolePHP.getAuthRoleList,type:"POST",dataType:"json",data:{filter:e},beforeSend:function(){$("#auth_role_list").empty().append(Strack.loading_dom("null"))},success:function(e){var i="",a=$("#auth_role_list"),t=$("#role_id").val();e.rows.forEach(function(e){var a,t;i+=(t="",t+='<li id="role_id_'+(a=e).auth_role_id+'" class="role-items" ><div class="role-name text-ellipsis aign-left"><a href="javascript:;" onclick="obj.select_auth_role(this);" data-roleid="'+a.auth_role_id+'" data-name="'+a.name+'" data-code="'+a.code+'">'+a.name+'</a></div><div class="role-bnt aign-right"><a href="javascript:;" class="aign-left" onclick="obj.auth_role_modify(this);" data-roleid="'+a.auth_role_id+'" data-name="'+a.name+'" data-code="'+a.code+'"><i class="icon-uniE684"></i></a><a href="javascript:;" class="aign-left" onclick="obj.auth_role_delete(this);" data-roleid="'+a.auth_role_id+'"><i class="icon-uniE6DB"></i></a></div></li>')}),i?($("#pactive_notice").remove(),a.append(i)):0===$("#pactive_notice").length&&a.before('<div id="pactive_notice" class="datagrid-empty-no">'+StrackLang.Datagird_No_Data+"</div>"),0<t&&$("#role_id_"+t).addClass("templates-active"),$("#st-load").remove()}})}function n(e,a,t,i,o){var r="";return s[e.id]=e,"project"===a&&(s[e.id].template_id=t.template_id),r+='<a href="javascript:;" class="nation-items" onclick="obj.select_module(this)" data-id="'+e.id+'" data-type="'+i+'" data-tab="'+a+'" data-classtype="'+o+'"><div class="nation-items-wrap min"><div class="aign-left"><span>'+e.lang+"</span></div></div></a>"}function _(e){var a=[],t={},i="";for(var o in e)t={id:o,lang:StrackLang[e[o].lang],code:o,is_parent:"yes",state:"open",children:[]},e[o].list.forEach(function(e){i="custom"===e.type?e.lang:StrackLang[e.lang],t.children.push({id:e.id,code:e.name,lang:i,is_parent:"no",parent_code:o,module_id:e.module_id,project_id:e.project_id,view:e.permission.view,create:e.permission.create,modify:e.permission.modify,clear:e.permission.clear,delete:e.permission.delete})}),a.push(t);return a}function u(e,a,t){if("yes"===a.is_parent)return'<a href="javascript:;" onclick="Strack.rule_grid_header_checkbox(this)" class="dg-rule-checkbox" style="margin-right: 5px" data-pos="parent" data-field="'+e+'" data-code="'+a.code+'"><div class="tree-checkbox tree-checkbox0"></div></a>';var i="allow"===t?"tree-checkbox1":"tree-checkbox0";return'<a href="javascript:;" onclick="Strack.rule_grid_header_checkbox(this)" class="dg-rule-checkbox" style="margin-right: 5px" data-pos="single" data-field="'+e+'" data-parent="'+a.parent_code+'" data-code="'+a.code+'"><div class="tree-checkbox '+i+'"></div></a>'}function o(e){$("#hide_role_tab").val(e),$(".group-item").each(function(){$(this).data("tab")===e?$(this).addClass("active"):$(this).removeClass("active")}),$(".admin-group-content").removeClass("active");var a,o,t,i=$("#page_auth_panel"),r=$("#field_auth_panel"),d=$("#data_range_panel");switch(e){case"project":case"front":case"admin":case"api":case"client":i.addClass("active"),t=e,$.ajax({url:RolePHP.getAuthPageModuleData,type:"POST",data:{tab:t},dataType:"json",beforeSend:function(){$("#field_module").append(Strack.loading_dom("white","","module"))},success:function(a){var t="";for(var i in a)t+='<li class="module-items-title">'+a[i].lang+"</li>",a[i].list.forEach(function(e){t+=n(e,"admin",a[i],"page",i)});$("#page_module_list").empty().append(t),$("#st-load_module").remove()}});break;case"field":r.addClass("active"),o=e,$.ajax({url:RolePHP.getAuthFieldModuleData,type:"POST",beforeSend:function(){$("#project_module").append(Strack.loading_dom("white","","module"))},success:function(a){var t="";for(var i in a)t+='<li class="module-items-title">'+a[i].lang+"</li>",a[i].list&&a[i].list.forEach(function(e){t+=n(e,o,a[i],"field",i)});$("#field_module_list").empty().append(t),$("#st-load_module").remove()}});break;case"data_range":d.addClass("active"),a=e,$.ajax({url:RolePHP.getAuthPageModuleData,type:"POST",data:{tab:a},dataType:"json",beforeSend:function(){$("#data_range_module_list").append(Strack.loading_dom("white","","data_range"))},success:function(a){var t="";for(var i in a)t+='<li class="module-items-title">'+a[i].lang+"</li>",a[i].list.forEach(function(e){t+=n(e,"data_range",a[i],"data_range",i)});$("#data_range_module_list").empty().append(t),$("#st-load_data_range").remove()}})}}t(""),Strack.listen_keyboard_event(function(e,a){"enter"===a.code&&$("#tab_project").hasClass("active")&&$("#search_val").is(":focus")&&(e.preventDefault(),obj.auth_role_filter(Strack.get_obj_by_id("search_auth_role")))})});